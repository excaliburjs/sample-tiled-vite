(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const h of o)if(h.type==="childList")for(const u of h.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function i(o){const h={};return o.integrity&&(h.integrity=o.integrity),o.referrerPolicy&&(h.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?h.credentials="include":o.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function r(o){if(o.ep)return;o.ep=!0;const h=i(o);fetch(o.href,h)}})();/*!
 * excalibur - 0.30.1 - 2024-12-12
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2024 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var R_={851:(c,t,i)=>{i.d(t,{A:()=>A});var r=i(1),o=i.n(r),h=i(935),u=i.n(h),_=u()(o());_.push([c.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const A=_},296:(c,t,i)=>{i.d(t,{A:()=>A});var r=i(1),o=i.n(r),h=i(935),u=i.n(h),_=u()(o());_.push([c.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const A=_},935:c=>{c.exports=function(t){var i=[];return i.toString=function(){return this.map(function(o){var h="",u=typeof o[5]<"u";return o[4]&&(h+="@supports (".concat(o[4],") {")),o[2]&&(h+="@media ".concat(o[2]," {")),u&&(h+="@layer".concat(o[5].length>0?" ".concat(o[5]):""," {")),h+=t(o),u&&(h+="}"),o[2]&&(h+="}"),o[4]&&(h+="}"),h}).join("")},i.i=function(o,h,u,_,A){typeof o=="string"&&(o=[[null,o,void 0]]);var y={};if(u)for(var w=0;w<this.length;w++){var f=this[w][0];f!=null&&(y[f]=!0)}for(var T=0;T<o.length;T++){var C=[].concat(o[T]);u&&y[C[0]]||(typeof A<"u"&&(typeof C[5]>"u"||(C[1]="@layer".concat(C[5].length>0?" ".concat(C[5]):""," {").concat(C[1],"}")),C[5]=A),h&&(C[2]&&(C[1]="@media ".concat(C[2]," {").concat(C[1],"}")),C[2]=h),_&&(C[4]?(C[1]="@supports (".concat(C[4],") {").concat(C[1],"}"),C[4]=_):C[4]="".concat(_)),i.push(C))}},i}},1:c=>{c.exports=function(t){var i=t[1],r=t[3];if(!r)return i;if(typeof btoa=="function"){var o=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),h="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(o),u="/*# ".concat(h," */");return[i].concat([u]).join(`
`)}return[i].join(`
`)}}},pu={};function _i(c){var t=pu[c];if(t!==void 0)return t.exports;var i=pu[c]={id:c,exports:{}};return R_[c](i,i.exports,_i),i.exports}_i.n=c=>{var t=c&&c.__esModule?()=>c.default:()=>c;return _i.d(t,{a:t}),t};_i.d=(c,t)=>{for(var i in t)_i.o(t,i)&&!_i.o(c,i)&&Object.defineProperty(c,i,{enumerable:!0,get:t[i]})};_i.o=(c,t)=>Object.prototype.hasOwnProperty.call(c,t);_i.r=c=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(c,"__esModule",{value:!0})};var U={};_i.d(U,{eKr:()=>lc,yVm:()=>Ho,a7j:()=>Ju,U_w:()=>Tc,JF2:()=>hc,htg:()=>Qn,HXL:()=>xc,mcg:()=>ic,Agj:()=>Ni,J3_:()=>Op,Wgv:()=>cc,u6S:()=>Ap,x7M:()=>ti,X55:()=>vs,m3M:()=>yo,aE5:()=>gp,YJU:()=>As,eZi:()=>El,GNv:()=>Co,Y56:()=>Do,_0v:()=>Wa,vhs:()=>Ma,vrQ:()=>Oo,Z8b:()=>wg,Yfw:()=>fe,IcQ:()=>Zt,kgJ:()=>Sl,GTT:()=>tf,ypY:()=>Po,i7d:()=>Qg,fQ3:()=>qp,HlI:()=>Za,jlt:()=>Ja,VQc:()=>Si,zD7:()=>Ic,AUF:()=>zs,JoF:()=>Dr,MlA:()=>ei,PZh:()=>sn,qA:()=>bo,CrD:()=>nr,dQK:()=>Ls,D3r:()=>xs,Qpo:()=>Ga,D9n:()=>Na,b6v:()=>xo,mvh:()=>ih,Bpo:()=>ie,Q1f:()=>kt,IKv:()=>Jg,fcV:()=>hn,Glf:()=>$g,uAl:()=>ls,ElT:()=>fi,Z8r:()=>Ql,QSL:()=>Hg,sPV:()=>Ua,nAn:()=>Un,zCU:()=>za,QrV:()=>yi,fF9:()=>EA,Jqv:()=>Ig,d_u:()=>Eg,xI8:()=>sc,yar:()=>gi,SP7:()=>Kg,oRy:()=>th,f5X:()=>vc,V1c:()=>Ll,Mlx:()=>ef,ZiM:()=>Pl,ZCo:()=>Eo,J5p:()=>sf,mL_:()=>ji,Guw:()=>xg,N5j:()=>ju,pgY:()=>bg,OP3:()=>Qa,rl5:()=>af,eod:()=>tA,q5Z:()=>ui,YUC:()=>fc,saR:()=>Ha,hvr:()=>Dl,Qol:()=>vg,Wf4:()=>mg,JCs:()=>Ee,gJV:()=>ts,fWD:()=>Fg,Va_:()=>Br,N$8:()=>Vi,_jQ:()=>eA,rxj:()=>oc,rhv:()=>nc,wCu:()=>Di,HAp:()=>yp,Zy1:()=>zg,bkB:()=>Ue,wfL:()=>La,sVA:()=>Ml,$Gs:()=>uc,CJ0:()=>Oa,NWh:()=>ir,tWi:()=>ac,xAj:()=>rc,zWh:()=>yg,i_4:()=>CA,iIx:()=>vi,Hxo:()=>Cg,c9e:()=>bl,KQV:()=>dn,weH:()=>xe,jXp:()=>xA,zzY:()=>ka,yRQ:()=>Ra,MtE:()=>rf,rPj:()=>Fo,KLc:()=>ns,Fir:()=>le,V5f:()=>Ol,Xj7:()=>Hl,Wud:()=>Sa,FVg:()=>Kl,g5Y:()=>Jl,YQB:()=>Zl,KPb:()=>$l,nHK:()=>rh,Jrb:()=>cf,TX_:()=>wA,Olt:()=>gf,r3n:()=>Gn,Fvk:()=>nA,gpR:()=>qa,vYh:()=>Oe,hnk:()=>He,D2R:()=>zn,n1o:()=>mc,h9O:()=>Wg,X5j:()=>ks,p3P:()=>wc,RLG:()=>ec,fBU:()=>Xu,Adb:()=>ii,bEs:()=>Qs,wCy:()=>me,CbD:()=>Le,x_C:()=>Xn,pGf:()=>Ec,ibQ:()=>Vg,shR:()=>So,Yjk:()=>bc,_u1:()=>oA,OBI:()=>df,klh:()=>vo,s3S:()=>Yg,D$R:()=>Ro,xth:()=>Ya,JU7:()=>iA,h9x:()=>kg,N1A:()=>Sc,e_k:()=>Xe,aHM:()=>fn,tlv:()=>Dp,Vi9:()=>Rg,ieR:()=>Dg,$bb:()=>ri,VyI:()=>$t,imn:()=>Gu,uqu:()=>Ki,QnL:()=>ul,vnc:()=>gc,wk_:()=>Cl,GH0:()=>we,_1r:()=>eh,l0X:()=>yl,bT:()=>ng,HHX:()=>xl,jtW:()=>ag,tjk:()=>Cr,rWe:()=>en,j9l:()=>qu,l0$:()=>Dc,sGJ:()=>tr,NVp:()=>Zu,cPK:()=>zi,XoL:()=>Cc,RmF:()=>Ui,DXI:()=>Ka,tCD:()=>aA,J3D:()=>Xa,vCJ:()=>sA,e6k:()=>Hu,f9l:()=>Cs,v9m:()=>oh,yRJ:()=>qg,EU6:()=>Tl,m3O:()=>Js,Ryz:()=>Tr,OxP:()=>wo,LEs:()=>nh,Ec:()=>cn,Pi5:()=>sh,gmH:()=>Ks,tS:()=>Pc,XxX:()=>wi,bCz:()=>ja,nYS:()=>gn,yiT:()=>jl,NHl:()=>Yn,mO8:()=>Xl,PXI:()=>Gl,bn5:()=>ql,Ywr:()=>Pr,cMd:()=>un,Bs6:()=>Vl,G0k:()=>jn,pyn:()=>Yl,QeM:()=>Nl,aPX:()=>Zp,ITP:()=>Wl,BY0:()=>Sr,MFw:()=>Uo,sBn:()=>Lo,S3L:()=>Mn,XKQ:()=>Bo,ESI:()=>Ug,uxz:()=>Mg,o8N:()=>Hn,u_r:()=>Vn,RlV:()=>rn,gVA:()=>Il,M_G:()=>No,BpG:()=>dc,GRB:()=>vp,kM6:()=>Ku,dO8:()=>tg,jgM:()=>Al,FWq:()=>ko,s3j:()=>N_,hlw:()=>dg,L0q:()=>cg,B7e:()=>lg,PGN:()=>hg,H_X:()=>Ge,S_d:()=>Ag,_Tq:()=>pg,U7E:()=>fg,IOH:()=>gg,Z58:()=>rs,yh2:()=>$p,ff$:()=>ml,cWi:()=>Du,NBt:()=>pc,oNz:()=>Bp,QlU:()=>Zg,Xey:()=>Ir,jft:()=>PA,_r8:()=>Ke,bTC:()=>$u,Mtr:()=>Yi,ypk:()=>Pi,mnM:()=>Te,q7S:()=>IA,bAZ:()=>Io,ABN:()=>Vu,VK6:()=>Pp,Hj2:()=>yc,Df8:()=>Bl,oOx:()=>Nn,kxk:()=>ys,DT1:()=>Va,FLG:()=>nn,qN_:()=>Bc,Z37:()=>$a,FtL:()=>Pg,Z6X:()=>uf,iQT:()=>os,ziO:()=>Gg,OEF:()=>Gs,uuE:()=>es,tiv:()=>To,T$Y:()=>nf,EYj:()=>zo,nOB:()=>Fa,Tap:()=>Ne,FAs:()=>Sg,B_P:()=>Tg,aA5:()=>Wp,J3s:()=>Rc,Y0Q:()=>Qo,M4G:()=>an,l$l:()=>of,dLy:()=>rr,WZP:()=>qt,eB6:()=>ah,nFK:()=>wl,l9z:()=>Lg,YOF:()=>Vp,yhB:()=>ni,J0N:()=>kl,Miz:()=>rt,Bj4:()=>fl,Rcs:()=>Us,vJ4:()=>or,TqC:()=>Yu,nM0:()=>tc,X1u:()=>on,SpZ:()=>Wu,DX8:()=>Ln,Yx$:()=>Xg,HK4:()=>Og,yt5:()=>Su,vAR:()=>rA,SE$:()=>er,qE8:()=>ce,Pz7:()=>ff,sX_:()=>ln,JuI:()=>F_,pxT:()=>sr,Nl$:()=>Ul,zDr:()=>pA,OwT:()=>dA,P$G:()=>_A,mHV:()=>gA,kEA:()=>AA,Fx_:()=>vA,WFC:()=>mA,vKu:()=>lA,aDq:()=>hA,jIg:()=>fA,UH3:()=>uA,AJO:()=>cA,U4:()=>ig,xAc:()=>sg,_3Y:()=>Gp,K6X:()=>mp,C1Y:()=>Ou,Aw1:()=>vl,tm8:()=>rg,LBV:()=>og,A8$:()=>wp,F5e:()=>Np,ran:()=>Up,c8L:()=>_g,o6M:()=>ug,hsx:()=>Fs,l9E:()=>Bg,aSf:()=>Ng,CcK:()=>eg,nU8:()=>_c,td6:()=>Go,Zex:()=>_f,bkJ:()=>be,mXP:()=>TA,vt$:()=>qn,hCA:()=>bs,pjR:()=>ae,U43:()=>Ms,pSZ:()=>Q_,y17:()=>k_,Ew7:()=>Ns,hG1:()=>zp,jVr:()=>BA,_SZ:()=>Be,xWn:()=>Pu,ehJ:()=>M_,t6s:()=>ft,Eyn:()=>Rl});var Rl={};_i.r(Rl);_i.d(Rl,{getAttributeComponentSize:()=>Uu,getAttributePointerType:()=>Nu,getGLTypeFromSource:()=>zu,getGlTypeSizeBytes:()=>gl,getMaxShaderComplexity:()=>zl,isAttributeInSource:()=>Lu});var Fl={};_i.r(Fl);_i.d(Fl,{circle:()=>pp,line:()=>_l,point:()=>fp,roundRect:()=>pl,vector:()=>_p});var Ml={};_i.r(Ml);_i.d(Ml,{ActionCompleteEvent:()=>lc,ActionStartEvent:()=>hc,ActivateEvent:()=>ic,AddEvent:()=>cc,CollisionEndEvent:()=>bo,CollisionPostSolveEvent:()=>Ga,CollisionPreSolveEvent:()=>Na,CollisionStartEvent:()=>xo,ContactEndEvent:()=>Ua,ContactStartEvent:()=>za,DeactivateEvent:()=>sc,EnterTriggerEvent:()=>oc,EnterViewPortEvent:()=>nc,EventTypes:()=>La,ExitTriggerEvent:()=>ac,ExitViewPortEvent:()=>rc,GameEvent:()=>le,GameStartEvent:()=>Ol,GameStopEvent:()=>Hl,GamepadAxisEvent:()=>Kl,GamepadButtonEvent:()=>Jl,GamepadConnectEvent:()=>Zl,GamepadDisconnectEvent:()=>$l,HiddenEvent:()=>ec,InitializeEvent:()=>Xn,KillEvent:()=>Ya,PostCollisionEvent:()=>gn,PostDebugDrawEvent:()=>jl,PostDrawEvent:()=>Yn,PostFrameEvent:()=>Xl,PostKillEvent:()=>Gl,PostTransformDrawEvent:()=>ql,PostUpdateEvent:()=>Pr,PreCollisionEvent:()=>un,PreDebugDrawEvent:()=>Vl,PreDrawEvent:()=>jn,PreFrameEvent:()=>Yl,PreKillEvent:()=>Nl,PreTransformDrawEvent:()=>Wl,PreUpdateEvent:()=>Sr,RemoveEvent:()=>dc,VisibleEvent:()=>tc});var kl={};_i.r(kl);_i.d(kl,{ConsoleAppender:()=>Ql,DrawUtil:()=>Fl,EasingFunctions:()=>Ee,LogLevel:()=>ri,Logger:()=>$t,Observable:()=>zi,ScreenAppender:()=>Du,addItemToArray:()=>L_,contains:()=>Ru,delay:()=>Pa,fail:()=>Fu,getPosition:()=>mo,isObject:()=>Ta,mergeDeep:()=>Da,omit:()=>Mu,removeItemFromArray:()=>Wn});function Tu(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(c){window.setInterval(c,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const t=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(i){return new Promise((r,o)=>{t.call(this,i,r,o)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(c){const t=Date.now();return setTimeout(function(){c({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(c){clearTimeout(c)})}class vi{static useCanvasGraphicsContext(){vi.enable("use-canvas-context")}static useLegacyImageRenderer(){vi.enable("use-legacy-image-renderer")}static freeze(){vi._FROZEN=!0}static _reset(){vi._FROZEN=!1,vi._FLAGS={}}static enable(t){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");vi._FLAGS[t]=!0}static disable(t){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");vi._FLAGS[t]=!1}static isEnabled(t){return!!vi._FLAGS[t]}static show(){return Object.keys(vi._FLAGS)}}vi._FROZEN=!1;vi._FLAGS={};function ln(c,t){return{type:c,value:t}}class ns{constructor(){this._isCompleted=!1,this.promise=new Promise((t,i)=>{this._resolver=t,this._rejecter=i})}get isCompleted(){return this._isCompleted}resolve(t){this._isCompleted||(this._isCompleted=!0,this._resolver(t))}reject(t){this._isCompleted||(this._isCompleted=!0,this._rejecter(t))}}class Ue{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(t,i){var r;return this._empty=!1,this._listeners[t]=(r=this._listeners[t])!==null&&r!==void 0?r:[],this._listeners[t].push(i),{close:()=>this.off(t,i)}}once(t,i){var r;return this._empty=!1,this._listenersOnce[t]=(r=this._listenersOnce[t])!==null&&r!==void 0?r:[],this._listenersOnce[t].push(i),{close:()=>this.off(t,i)}}off(t,i){var r,o;if(i){const h=(r=this._listeners[t])===null||r===void 0?void 0:r.filter(_=>_!==i);this._listeners[t]=h;const u=(o=this._listenersOnce[t])===null||o===void 0?void 0:o.filter(_=>_!==i);this._listenersOnce[t]=u}else delete this._listeners[t]}emit(t,i){if(this._empty||this._paused)return;const r=this._listeners[t];if(r)for(let h=0;h<r.length;h++)r[h](i);const o=this._listenersOnce[t];if(this._listenersOnce[t]=[],o)for(let h=0;h<o.length;h++)o[h](i);for(let h=0;h<this._pipes.length;h++)this._pipes[h].emit(t,i)}pipe(t){if(this===t)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(t),{close:()=>{const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}}}unpipe(t){const i=this._pipes.indexOf(t);i>-1&&this._pipes.splice(i,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var cn;(function(c){c.Canvas="Canvas",c.Document="Document"})(cn||(cn={}));var Ge;(function(c){c.ShortestPath="shortest-path",c.LongestPath="longest-path",c.Clockwise="clockwise",c.CounterClockwise="counter-clockwise"})(Ge||(Ge={}));const al=4294967295;class Hn{constructor(t){this.seed=t,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(t||Date.now())>>>0;for(let i=1;i<this._n;i++){const r=this._mt[i-1]^this._mt[i-1]>>>this._w-2;this._mt[i]=(this._f*((r&4294901760)>>>16)<<16)+this._f*(r&65535)+i>>>0}this._index=this._n}_twist(){const t=[0,this._a];let i=0,r=0;for(;r<this._n-this._m;r++)i=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+this._m]^i>>>1^t[i&1]&al;for(;r<this._n-1;r++)i=this._mt[r]&this._upperMask|this._mt[r+1]&this._lowerMask,this._mt[r]=this._mt[r+(this._m-this._n)]^i>>>1^t[i&1]&al;i=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^i>>>1^t[i&1]&al,this._index=0}nextInt(){this._index>=this._n&&this._twist();let t=this._mt[this._index++];return t^=t>>>this._u,t^=t<<this._s&this._b,t^=t<<this._t&this._c,t^=t>>>this._l,t>>>0}next(){return this.nextInt()*(1/4294967296)}floating(t,i){return(i-t)*this.next()+t}integer(t,i){return Math.floor((i-t+1)*this.next()+t)}bool(t=.5){return this.next()<=t}pickOne(t){return t[this.integer(0,t.length-1)]}pickSet(t,i,r=!1){return r?this._pickSetWithDuplicates(t,i):this._pickSetWithoutDuplicates(t,i)}_pickSetWithoutDuplicates(t,i){if(i>t.length||i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(i===t.length)return t;const r=new Array(i);let o=0;const h=t.slice(0);for(;o<i;){const u=this.integer(0,h.length-1);r[o++]=h[u],h.splice(u,1)}return r}_pickSetWithDuplicates(t,i){if(i<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const r=new Array(i);for(let o=0;o<i;o++)r[o]=this.pickOne(t);return r}shuffle(t){const i=t.slice(0);let r;for(let o=0;o<i.length-2;o++){const h=this.integer(o,i.length-1);r=i[o],i[o]=i[h],i[h]=r}return i}range(t,i,r){const o=new Array(t);for(let h=0;h<t;h++)o[h]=this.integer(i,r);return o}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const ni=Math.PI*2;function F_(c){return c>=0?c-Math.floor(c):c-Math.ceil(c)}function Be(c){return c===0?0:c<0?-1:1}function ce(c,t,i){return Math.min(Math.max(t,c),i)}function Su(c,t,i){return Math.abs(c-t)<i}function er(c){let t=c;if(c>=ni)for(;t>=ni;)t-=ni;if(c<0)for(;t<0;)t+=ni;return t}function Pu(c){return 180/Math.PI*c}function M_(c){return c/180*Math.PI}const k_=(c,t)=>Array.from(new Array(t-c+1),(i,r)=>r+c);function Ms(c,t,i=new Hn){return i?i.floating(c,t):c+Math.random()*(t-c)}function Q_(c,t,i=new Hn){return i?i.integer(c,t):Math.round(Ms(c,t))}class rt{static get Zero(){return new rt(0,0)}static get One(){return new rt(1,1)}static get Half(){return new rt(.5,.5)}static get Up(){return new rt(0,-1)}static get Down(){return new rt(0,1)}static get Left(){return new rt(-1,0)}static get Right(){return new rt(1,0)}static fromAngle(t){return new rt(Math.cos(t),Math.sin(t))}static isValid(t){return!(t==null||isNaN(t.x)||isNaN(t.y)||t.x===1/0||t.y===1/0||t.x===-1/0||t.y===-1/0)}static distance(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))}static min(t,i){return new rt(Math.min(t.x,i.x),Math.min(t.y,i.y))}static max(t,i){return new rt(Math.max(t.x,i.x),Math.max(t.y,i.y))}constructor(t,i){this._x=0,this._y=0,this._x=t,this._y=i}get x(){return this._x}set x(t){this._x=t}get y(){return this._y}set y(t){this._y=t}setTo(t,i){this.x=t,this.y=i}equals(t,i=rt.EQUALS_EPSILON){return Math.abs(this.x-t.x)<=i&&Math.abs(this.y-t.y)<=i}distance(t){if(!t)return Math.sqrt(this.x*this.x+this.y*this.y);const i=this.x-t.x,r=this.y-t.y;return Math.sqrt(i*i+r*r)}squareDistance(t){t||(t=rt.Zero);const i=this.x-t.x,r=this.y-t.y;return i*i+r*r}clampMagnitude(t){const i=this.magnitude,r=ce(i,0,t);return this.magnitude=r,this}get size(){return this.distance()}set size(t){const i=this.normalize().scale(t);this.setTo(i.x,i.y)}get magnitude(){return this.distance()}set magnitude(t){this.normalize().scale(t,this)}normalize(){const t=this.distance();return t===0?rt.Zero:new rt(this.x/t,this.y/t)}average(t){return this.add(t).scale(.5)}scale(t,i){const r=i||new rt(0,0);return t instanceof rt?(r.x=this.x*t.x,r.y=this.y*t.y):(r.x=this.x*t,r.y=this.y*t),r}add(t,i){return i?(i.x=this.x+t.x,i.y=this.y+t.y,i):new rt(this.x+t.x,this.y+t.y)}sub(t,i){const r=i||new rt(0,0),o=this.x-t.x,h=this.y-t.y;return r.x=o,r.y=h,r}addEqual(t){return this.setTo(this.x+t.x,this.y+t.y),this}subEqual(t){return this.setTo(this.x-t.x,this.y-t.y),this}scaleEqual(t){return this.setTo(this.x*t,this.y*t),this}dot(t){return this.x*t.x+this.y*t.y}cross(t){if(t instanceof rt)return this.x*t.y-this.y*t.x;if(typeof t=="number")return new rt(t*this.y,-t*this.x)}static cross(t,i){return new rt(-t*i.y,t*i.x)}perpendicular(){return new rt(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return er(Math.atan2(this.y,this.x))}angleBetween(t,i){const r=this.toAngle(),o=er(t);let h=0,u=0;switch(o>r?h=o-r:h=(ni-r+o)%ni,u=(h-ni)%ni,i){case Ge.ShortestPath:return Math.abs(h)<Math.abs(u)?h:u;case Ge.LongestPath:return Math.abs(h)>Math.abs(u)?h:u;case Ge.Clockwise:return h;case Ge.CounterClockwise:return u}}rotate(t,i,r){const o=r||new rt(0,0);i||(i=new rt(0,0));const h=Math.sin(t),u=Math.cos(t),_=u*(this.x-i.x)-h*(this.y-i.y)+i.x,A=h*(this.x-i.x)+u*(this.y-i.y)+i.y;return o.x=_,o.y=A,o}clone(t){const i=t??new rt(0,0);return i.x=this.x,i.y=this.y,i}toString(t){return t?`(${this.x.toFixed(t)}, ${this.y.toFixed(t)})`:`(${this.x}, ${this.y})`}}rt.EQUALS_EPSILON=.001;function ft(c,t){return new rt(c,t)}class kt{constructor(t,i,r,o){this.r=t,this.g=i,this.b=r,this.a=o??1}static fromRGB(t,i,r,o){return new kt(t,i,r,o)}static fromRGBString(t){const i=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let r=null;if(r=t.match(i)){const o=parseInt(r[1],10),h=parseInt(r[2],10),u=parseInt(r[3],10);let _=1;return r[4]&&(_=parseFloat(r[4])),new kt(o,h,u,_)}else throw new Error("Invalid rgb/a string: "+t)}static fromHex(t){const i=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let r=null;if(r=t.match(i)){const o=parseInt(r[1],16),h=parseInt(r[2],16),u=parseInt(r[3],16);let _=1;return r[4]&&(_=parseInt(r[4],16)/255),new kt(o,h,u,_)}else throw new Error("Invalid hex string: "+t)}static fromHSL(t,i,r,o=1){return new ms(t,i,r,o).toRGBA()}lighten(t=.1){const i=ms.fromRGBA(this.r,this.g,this.b,this.a);return i.l+=(1-i.l)*t,i.toRGBA()}darken(t=.1){const i=ms.fromRGBA(this.r,this.g,this.b,this.a);return i.l-=i.l*t,i.toRGBA()}saturate(t=.1){const i=ms.fromRGBA(this.r,this.g,this.b,this.a);return i.s+=i.s*t,i.toRGBA()}desaturate(t=.1){const i=ms.fromRGBA(this.r,this.g,this.b,this.a);return i.s-=i.s*t,i.toRGBA()}multiply(t){const i=t.r/255*this.r/255*255,r=t.g/255*this.g/255*255,o=t.b/255*this.b/255*255,h=t.a*this.a;return new kt(i,r,o,h)}screen(t){const i=t.invert(),r=t.invert();return i.multiply(r).invert()}invert(){return new kt(255-this.r,255-this.g,255-this.b,1-this.a)}average(t){const i=(t.r+this.r)/2,r=(t.g+this.g)/2,o=(t.b+this.b)/2,h=(t.a+this.a)/2;return new kt(i,r,o,h)}equal(t){return this.toString()===t.toString()}toString(t="rgb"){switch(t){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(t){const i=Math.max(Math.round(t),0).toString(16);return i.length===1?"0"+i:i}toHex(){let t="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(t+=this._componentToHex(this.a*255)),t}toRGBA(){const t=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+t+", "+String(this.a)+")":"rgb("+t+")"}toHSLA(){return ms.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(t){const i=t||new kt(this.r,this.g,this.b,this.a);return i.r=this.r,i.g=this.g,i.b=this.b,i.a=this.a,i}static get Black(){return kt.fromHex("#000000")}static get White(){return kt.fromHex("#FFFFFF")}static get Gray(){return kt.fromHex("#808080")}static get LightGray(){return kt.fromHex("#D3D3D3")}static get DarkGray(){return kt.fromHex("#A9A9A9")}static get Yellow(){return kt.fromHex("#FFFF00")}static get Orange(){return kt.fromHex("#FFA500")}static get Red(){return kt.fromHex("#FF0000")}static get Vermilion(){return kt.fromHex("#FF5B31")}static get Rose(){return kt.fromHex("#FF007F")}static get Pink(){return kt.fromHex("#FFC0CB")}static get Magenta(){return kt.fromHex("#FF00FF")}static get Violet(){return kt.fromHex("#7F00FF")}static get Purple(){return kt.fromHex("#800080")}static get Blue(){return kt.fromHex("#0000FF")}static get Azure(){return kt.fromHex("#007FFF")}static get Cyan(){return kt.fromHex("#00FFFF")}static get Viridian(){return kt.fromHex("#59978F")}static get Teal(){return kt.fromHex("#008080")}static get Green(){return kt.fromHex("#00FF00")}static get Chartreuse(){return kt.fromHex("#7FFF00")}static get Transparent(){return kt.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return kt.fromHex("#176BAA")}static get Brown(){return kt.fromHex("#964B00")}}class ms{constructor(t,i,r,o){this.h=t,this.s=i,this.l=r,this.a=o}static hue2rgb(t,i,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?t+(i-t)*6*r:r<1/2?i:r<2/3?t+(i-t)*(2/3-r)*6:t}static fromRGBA(t,i,r,o){t/=255,i/=255,r/=255;const h=Math.max(t,i,r),u=Math.min(t,i,r);let _,A;const y=(h+u)/2;if(h===u)_=A=0;else{const w=h-u;switch(A=y>.5?w/(2-h-u):w/(h+u),h){case t:_=(i-r)/w+(i<r?6:0);break;case i:_=(r-t)/w+2;break;case r:_=(t-i)/w+4;break}_/=6}return new ms(_,A,y,o)}toRGBA(){let t,i,r;if(this.s===0)t=i=r=this.l;else{const o=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,h=2*this.l-o;t=ms.hue2rgb(h,o,this.h+1/3),i=ms.hue2rgb(h,o,this.h),r=ms.hue2rgb(h,o,this.h-1/3)}return new kt(t*255,i*255,r*255,this.a)}toString(){const t=this.h.toFixed(0),i=this.s.toFixed(0),r=this.l.toFixed(0),o=this.a.toFixed(0);return`hsla(${t}, ${i}, ${r}, ${o})`}}var ri;(function(c){c[c.Debug=0]="Debug",c[c.Info=1]="Info",c[c.Warn=2]="Warn",c[c.Error=3]="Error",c[c.Fatal=4]="Fatal"})(ri||(ri={}));class $t{constructor(){if(this._appenders=[],this.defaultLevel=ri.Info,this._logOnceSet=new Set,$t._INSTANCE)throw new Error("Logger is a singleton");return $t._INSTANCE=this,$t._INSTANCE.addAppender(new Ql),$t._INSTANCE}static getInstance(){return $t._INSTANCE==null&&($t._INSTANCE=new $t),$t._INSTANCE}addAppender(t){this._appenders.push(t)}clearAppenders(){this._appenders.length=0}_log(t,i){t==null&&(t=this.defaultLevel);const r=this._appenders.length;for(let o=0;o<r;o++)t>=this.defaultLevel&&this._appenders[o].log(t,i)}_logOnce(t,i){const r=t+i.join("+");this._logOnceSet.has(r)||(this._logOnceSet.add(r),this._log(t,i))}debug(...t){this._log(ri.Debug,t)}debugOnce(...t){this._logOnce(ri.Debug,t)}info(...t){this._log(ri.Info,t)}infoOnce(...t){this._logOnce(ri.Info,t)}warn(...t){this._log(ri.Warn,t)}warnOnce(...t){this._logOnce(ri.Warn,t)}error(...t){this._log(ri.Error,t)}errorOnce(...t){this._logOnce(ri.Error,t)}fatal(...t){this._log(ri.Fatal,t)}fatalOnce(...t){this._logOnce(ri.Fatal,t)}}$t._INSTANCE=null;class Ql{log(t,i){if(!console&&!console.log&&console.warn&&console.error)return;const r=[];r.unshift.apply(r,i),r.unshift("["+ri[t]+"] : "),t<ri.Warn?console.log.apply?console.log.apply(console,r):console.log(r.join(" ")):t<ri.Error?console.warn.apply?console.warn.apply(console,r):console.warn(r.join(" ")):console.error.apply?console.error.apply(console,r):console.error(r.join(" "))}}class Du{constructor(t){var i,r;this._messages=[],this._pos=10,this._color=kt.Black,this._options=t,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(r=(i=t.zIndex)===null||i===void 0?void 0:i.toString())!==null&&r!==void 0?r:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),t.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var t,i,r,o;const h=this._options;this.canvas.width=(t=h.width)!==null&&t!==void 0?t:h.engine.screen.resolution.width,this.canvas.height=(i=h.height)!==null&&i!==void 0?i:h.engine.screen.resolution.height,this.canvas.style.position="absolute";const u=h.engine.screen.screenToPageCoordinates(ft(0,0));this.canvas.style.left=u.x+"px",this.canvas.style.top=u.y+"px",this._pos=(r=h.xPos)!==null&&r!==void 0?r:this._pos,this._color=(o=h.color)!==null&&o!==void 0?o:this._color}log(t,i){const r=i.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+ri[t]+"] : "+r);let o=10;this._messages=this._messages.slice(0,1e3);for(let h=0;h<this._messages.length;h++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[h],this._pos,o),o+=10}}var Te;(function(c){c.None="None",c.Top="Top",c.Bottom="Bottom",c.Left="Left",c.Right="Right"})(Te||(Te={}));(function(c){function t(r){return r===c.Top?c.Bottom:r===c.Bottom?c.Top:r===c.Left?c.Right:r===c.Right?c.Left:c.None}c.getOpposite=t;function i(r){return Math.abs(r.x)>=Math.abs(r.y)?r.x<=0?c.Left:c.Right:r.y<=0?c.Top:c.Bottom}c.fromDirection=i})(Te||(Te={}));class Zt{constructor(t=0,i=0,r=0,o=0){this._points=[],typeof t=="object"?(this.left=t.left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):typeof t=="number"&&(this.left=t,this.top=i,this.right=r,this.bottom=o)}clone(t){const i=t||new Zt(0,0,0,0);return i.left=this.left,i.right=this.right,i.top=this.top,i.bottom=this.bottom,i}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(t){return t&&t?Math.abs(t.x)>Math.abs(t.y)?t.x<0?Te.Right:Te.Left:t.y<0?Te.Bottom:Te.Top:Te.None}static fromPoints(t){let i=1/0,r=1/0,o=-1/0,h=-1/0;for(let u=0;u<t.length;u++)t[u].x<i&&(i=t[u].x),t[u].x>o&&(o=t[u].x),t[u].y<r&&(r=t[u].y),t[u].y>h&&(h=t[u].y);return new Zt(i,r,o,h)}static fromDimension(t,i,r=rt.Half,o=rt.Zero){return new Zt(-t*r.x+o.x,-i*r.y+o.y,t-t*r.x+o.x,i-i*r.y+o.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new rt((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new rt(this.left,this.top)}get bottomRight(){return new rt(this.right,this.bottom)}get topRight(){return new rt(this.right,this.top)}get bottomLeft(){return new rt(this.left,this.bottom)}translate(t){return new Zt(this.left+t.x,this.top+t.y,this.right+t.x,this.bottom+t.y)}rotate(t,i=rt.Zero){const r=this.getPoints().map(o=>o.rotate(t,i));return Zt.fromPoints(r)}scale(t,i=rt.Zero){const r=this.translate(i);return new Zt(r.left*t.x,r.top*t.y,r.right*t.x,r.bottom*t.y)}transform(t){const i=t.data[0]*this.left,r=t.data[1]*this.left,o=t.data[0]*this.right,h=t.data[1]*this.right,u=t.data[2]*this.top,_=t.data[3]*this.top,A=t.data[2]*this.bottom,y=t.data[3]*this.bottom,w=t.getPosition(),f=Math.min(i,o)+Math.min(u,A)+w.x,T=Math.min(r,h)+Math.min(_,y)+w.y,C=Math.max(i,o)+Math.max(u,A)+w.x,S=Math.max(r,h)+Math.max(_,y)+w.y;return new Zt({left:f,top:T,right:C,bottom:S})}getPerimeter(){const t=this.width,i=this.height;return 2*(t+i)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new rt(this.left,this.top)),this._points.push(new rt(this.right,this.top)),this._points.push(new rt(this.right,this.bottom)),this._points.push(new rt(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(t,i=1/0){let r=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,u=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,_=(this.left-t.pos.x)*h,A=(this.right-t.pos.x)*h;r=Math.min(_,A),o=Math.max(_,A);const y=(this.top-t.pos.y)*u,w=(this.bottom-t.pos.y)*u;return r=Math.max(r,Math.min(y,w)),o=Math.min(o,Math.max(y,w)),o>=Math.max(0,r)&&r<i}rayCastTime(t,i=1/0){let r=-1/0,o=1/0;const h=t.dir.x===0?Number.MAX_VALUE:1/t.dir.x,u=t.dir.y===0?Number.MAX_VALUE:1/t.dir.y,_=(this.left-t.pos.x)*h,A=(this.right-t.pos.x)*h;r=Math.min(_,A),o=Math.max(_,A);const y=(this.top-t.pos.y)*u,w=(this.bottom-t.pos.y)*u;return r=Math.max(r,Math.min(y,w)),o=Math.min(o,Math.max(y,w)),o>=Math.max(0,r)&&r<i?r:-1}contains(t){return t instanceof rt?this.left<=t.x&&this.top<=t.y&&t.y<=this.bottom&&t.x<=this.right:t instanceof Zt?this.left<=t.left&&this.top<=t.top&&t.bottom<=this.bottom&&t.right<=this.right:!1}combine(t,i){const r=i||new Zt(0,0,0,0),o=Math.min(this.left,t.left),h=Math.min(this.top,t.top),u=Math.max(this.right,t.right),_=Math.max(this.bottom,t.bottom);return r.left=o,r.top=h,r.right=u,r.bottom=_,r}get dimensions(){return new rt(this.width,this.height)}overlaps(t,i){const r=i||0;if(t.hasZeroDimensions())return this.contains(t);if(this.hasZeroDimensions())return t.contains(this);const o=this.combine(t);return o.width+r<t.width+this.width&&o.height+r<t.height+this.height}intersect(t){const i=this.combine(t);if(i.width<t.width+this.width&&i.height<t.height+this.height&&!i.dimensions.equals(t.dimensions)&&!i.dimensions.equals(this.dimensions)){let r=0;this.right>=t.left&&this.right<=t.right?r=t.left-this.right:r=t.right-this.left;let o=0;return this.top<=t.bottom&&this.top>=t.top?o=t.bottom-this.top:o=t.top-this.bottom,Math.abs(r)<Math.abs(o)?new rt(r,0):new rt(0,o)}else if(i.dimensions.equals(t.dimensions)||i.dimensions.equals(this.dimensions)){let r=0;this.width-t.width>=0?this.right-t.right<=t.left-this.left?r=t.left-this.right:r=t.right-this.left:t.right-this.right<=this.left-t.left?r=this.left-t.right:r=this.right-t.left;let o=0;return this.height-t.height>=0?this.bottom-t.bottom<=t.top-this.top?o=t.top-this.bottom:o=t.bottom-this.top:t.bottom-this.bottom<=this.top-t.top?o=this.top-t.bottom:o=this.bottom-t.top,Math.abs(r)<Math.abs(o)?new rt(r,0):new rt(0,o)}else return null}intersectWithSide(t){const i=this.intersect(t);return Zt.getSideFromIntersection(i)}draw(t,i=kt.Yellow){t.debug.drawRect(this.left,this.top,this.width,this.height,{color:i})}}function mo(c){if(c&&c.getBoundingClientRect){const t=c.getBoundingClientRect();return ft(t.x+window.scrollX,t.y+window.scrollY)}return rt.Zero}function L_(c,t){return t.indexOf(c)===-1?(t.push(c),!0):!1}function Wn(c,t){let i=-1;return(i=t.indexOf(c))>-1?(t.splice(i,1),!0):!1}function Ru(c,t){for(let i=0;i<c.length;i++)if(c[i]===t)return!0;return!1}function Fu(c){throw new Error(c)}function Pa(c,t){var i;const r=new ns;return((i=t==null?void 0:t.schedule.bind(t))!==null&&i!==void 0?i:setTimeout)(()=>{r.resolve()},c),r.promise}function Mu(c,t){const i={};for(const r in c)t.includes(r)||(i[r]=c[r]);return i}function Ta(c){return c&&typeof c=="object"&&!Array.isArray(c)}function Da(c,...t){if(!t.length)return c;const i=t.shift();if(Ta(c)&&Ta(i))for(const r in i)Ta(i[r])?(c[r]||Object.assign(c,{[r]:{}}),Da(c[r],i[r])):Object.assign(c,{[r]:i[r]});return Da(c,...t)}var ul;(function(c){c[c.X=12]="X",c[c.Y=13]="Y"})(ul||(ul={}));class Ki{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(t,i,r,o,h,u){const _=new Ki;return _.data[0]=2/(i-t),_.data[1]=0,_.data[2]=0,_.data[3]=0,_.data[4]=0,_.data[5]=2/(o-r),_.data[6]=0,_.data[7]=0,_.data[8]=0,_.data[9]=0,_.data[10]=-2/(u-h),_.data[11]=0,_.data[12]=-(i+t)/(i-t),_.data[13]=-(o+r)/(o-r),_.data[14]=-(u+h)/(u-h),_.data[15]=1,_}clone(t){const i=t||new Ki;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i.data[6]=this.data[6],i.data[7]=this.data[7],i.data[8]=this.data[8],i.data[9]=this.data[9],i.data[10]=this.data[10],i.data[11]=this.data[11],i.data[12]=this.data[12],i.data[13]=this.data[13],i.data[14]=this.data[14],i.data[15]=this.data[15],i}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(t){const i=new Ki;return i.data=t,i}static identity(){const t=new Ki;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=0,t.data[4]=0,t.data[5]=1,t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=0,t.data[13]=0,t.data[14]=0,t.data[15]=1,t}static translation(t,i){const r=Ki.identity();return r.data[12]=t,r.data[13]=i,r}static scale(t,i){const r=Ki.identity();return r.data[0]=t,r.data[5]=i,r.data[10]=1,r.data[15]=1,r}static rotation(t){const i=Ki.identity();return i.data[0]=Math.cos(t),i.data[4]=-Math.sin(t),i.data[1]=Math.sin(t),i.data[5]=Math.cos(t),i}multiply(t,i){if(t instanceof rt){const r=i||new rt(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[4]+this.data[12],u=o.x*this.data[1]+o.y*this.data[5]+this.data[13];return r.x=h,r.y=u,r}else{const r=i||new Ki,o=t,h=this.data[0],u=this.data[1],_=this.data[2],A=this.data[3],y=this.data[4],w=this.data[5],f=this.data[6],T=this.data[7],C=this.data[8],S=this.data[9],E=this.data[10],W=this.data[11],D=this.data[12],H=this.data[13],k=this.data[14],N=this.data[15],Q=o.data[0],L=o.data[1],O=o.data[2],Y=o.data[3],ot=o.data[4],nt=o.data[5],et=o.data[6],ut=o.data[7],Z=o.data[8],I=o.data[9],R=o.data[10],q=o.data[11],tt=o.data[12],X=o.data[13],j=o.data[14],F=o.data[15];r.data[0]=h*Q+y*L+C*O+D*Y,r.data[1]=u*Q+w*L+S*O+H*Y,r.data[2]=_*Q+f*L+E*O+k*Y,r.data[3]=A*Q+T*L+W*O+N*Y,r.data[4]=h*ot+y*nt+C*et+D*ut,r.data[5]=u*ot+w*nt+S*et+H*ut,r.data[6]=_*ot+f*nt+E*et+k*ut,r.data[7]=A*ot+T*nt+W*et+N*ut,r.data[8]=h*Z+y*I+C*R+D*q,r.data[9]=u*Z+w*I+S*R+H*q,r.data[10]=_*Z+f*I+E*R+k*q,r.data[11]=A*Z+T*I+W*R+N*q,r.data[12]=h*tt+y*X+C*j+D*F,r.data[13]=u*tt+w*X+S*j+H*F,r.data[14]=_*tt+f*X+E*j+k*F,r.data[15]=A*tt+T*X+W*j+N*F;const St=this.getScale();return r._scaleSignX=Be(St.x)*Be(r._scaleSignX),r._scaleSignY=Be(St.y)*Be(r._scaleSignY),r}}translate(t,i){const r=this.data[0],o=this.data[1],h=this.data[2],u=this.data[3],_=this.data[4],A=this.data[5],y=this.data[6],w=this.data[7],f=this.data[8],T=this.data[9],C=this.data[10],S=this.data[11],E=this.data[12],W=this.data[13],D=this.data[14],H=this.data[15],k=0,N=1;return this.data[12]=r*t+_*i+f*k+E*N,this.data[13]=o*t+A*i+T*k+W*N,this.data[14]=h*t+y*i+C*k+D*N,this.data[15]=u*t+w*i+S*k+H*N,this}setPosition(t,i){this.data[12]=t,this.data[13]=i}getPosition(){return ft(this.data[12],this.data[13])}rotate(t){const i=this.data[0],r=this.data[1],o=this.data[2],h=this.data[3],u=this.data[4],_=this.data[5],A=this.data[6],y=this.data[7],w=Math.sin(t),f=Math.cos(t);return this.data[0]=f*i+w*u,this.data[1]=f*r+w*_,this.data[2]=f*o+w*A,this.data[3]=f*h+w*y,this.data[4]=f*u-w*i,this.data[5]=f*_-w*r,this.data[6]=f*A-w*o,this.data[7]=f*y-w*h,this}scale(t,i){const r=this.data[0],o=this.data[1],h=this.data[2],u=this.data[3],_=this.data[4],A=this.data[5],y=this.data[6],w=this.data[7];return this.data[0]=r*t,this.data[1]=o*t,this.data[2]=h*t,this.data[3]=u*t,this.data[4]=_*i,this.data[5]=A*i,this.data[6]=y*i,this.data[7]=w*i,this}setRotation(t){const i=this.getScale(),r=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=r*i.y,this.data[4]=-r*i.x,this.data[5]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return er(t)}getScaleX(){const t=ft(this.data[0],this.data[4]).magnitude;return this._scaleSignX*t}getScaleY(){const t=ft(this.data[1],this.data[5]).magnitude;return this._scaleSignY*t}getScale(){return ft(this.getScaleX(),this.getScaleY())}setScaleX(t){if(this._scaleX===t)return;this._scaleSignX=Be(t);const i=ft(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[4]=i.y*t,this._scaleX=t}setScaleY(t){if(this._scaleY===t)return;this._scaleSignY=Be(t);const i=ft(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[5]=i.y*t,this._scaleY=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(t){const r=1/this.getBasisDeterminant(),o=this.data[0],h=this.data[4],u=this.data[1],_=this.data[5],A=t||Ki.identity();A.data[0]=_*r,A.data[1]=-u*r,A.data[4]=-h*r,A.data[5]=o*r;const y=this.data[12],w=this.data[13];return A.data[12]=-(y*A.data[0]+w*A.data[4]),A.data[13]=-(y*A.data[1]+w*A.data[5]),A}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class ti{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const t=new ti;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}static translation(t,i){const r=ti.identity();return r.data[4]=t,r.data[5]=i,r}static scale(t,i){const r=ti.identity();return r.data[0]=t,r.data[3]=i,r._scale[0]=t,r._scale[1]=i,r}static rotation(t){const i=ti.identity();return i.data[0]=Math.cos(t),i.data[1]=Math.sin(t),i.data[2]=-Math.sin(t),i.data[3]=Math.cos(t),i}setPosition(t,i){this.data[4]=t,this.data[5]=i}getPosition(){return ft(this.data[4],this.data[5])}rotate(t){const i=this.data[0],r=this.data[1],o=this.data[2],h=this.data[3],u=Math.sin(t),_=Math.cos(t);return this.data[0]=_*i+u*o,this.data[1]=_*r+u*h,this.data[2]=_*o-u*i,this.data[3]=_*h-u*r,this}translate(t,i){const r=this.data[0],o=this.data[1],h=this.data[2],u=this.data[3],_=this.data[4],A=this.data[5];return this.data[4]=r*t+h*i+_,this.data[5]=o*t+u*i+A,this}scale(t,i){const r=this.data[0],o=this.data[1],h=this.data[2],u=this.data[3];return this.data[0]=r*t,this.data[1]=o*t,this.data[2]=h*i,this.data[3]=u*i,this._scale[0]=t,this._scale[1]=i,this._scaleSignX=Be(t),this._scaleSignY=Be(i),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(t){const i=this.determinant();let r=i;i!==0&&(r=1/i);const o=this.data[0],h=this.data[2],u=this.data[1],_=this.data[3],A=t||ti.identity();A.data[0]=_*r,A.data[1]=-u*r,A.data[2]=-h*r,A.data[3]=o*r;const y=this.data[4],w=this.data[5];return A.data[4]=-(y*A.data[0]+w*A.data[2]),A.data[5]=-(y*A.data[1]+w*A.data[3]),A}multiply(t,i){if(t instanceof rt){const r=i||new rt(0,0),o=t,h=o.x*this.data[0]+o.y*this.data[2]+this.data[4],u=o.x*this.data[1]+o.y*this.data[3]+this.data[5];return r.x=h,r.y=u,r}else{const r=i||new ti,o=t,h=this.data[0],u=this.data[1],_=this.data[2],A=this.data[3],y=this.data[4],w=this.data[5],f=o.data[0],T=o.data[1],C=o.data[2],S=o.data[3],E=o.data[4],W=o.data[5];r.data[0]=h*f+_*T,r.data[1]=u*f+A*T,r.data[2]=h*C+_*S,r.data[3]=u*C+A*S,r.data[4]=h*E+_*W+y,r.data[5]=u*E+A*W+w;const D=this._scaleSignX,H=this._scaleSignY;return r._scaleSignX=D*Be(r._scaleSignX),r._scaleSignY=H*Be(r._scaleSignY),r}}multiplyQuadInPlace(t){const i=t[0]*this.data[0]+t[1]*this.data[2]+this.data[4],r=t[0]*this.data[1]+t[1]*this.data[3]+this.data[5];t[0]=i,t[1]=r;const o=t[2]*this.data[0]+t[3]*this.data[2]+this.data[4],h=t[2]*this.data[1]+t[3]*this.data[3]+this.data[5];t[2]=o,t[3]=h;const u=t[4]*this.data[0]+t[5]*this.data[2]+this.data[4],_=t[4]*this.data[1]+t[5]*this.data[3]+this.data[5];t[4]=u,t[5]=_;const A=t[6]*this.data[0]+t[7]*this.data[2]+this.data[4],y=t[6]*this.data[1]+t[7]*this.data[3]+this.data[5];t[6]=A,t[7]=y}to4x4(){const t=new Ki;return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=0,t.data[3]=0,t.data[4]=this.data[2],t.data[5]=this.data[3],t.data[6]=0,t.data[7]=0,t.data[8]=0,t.data[9]=0,t.data[10]=1,t.data[11]=0,t.data[12]=this.data[4],t.data[13]=this.data[5],t.data[14]=0,t.data[15]=1,t}setRotation(t){const i=this.getScale(),r=Math.sin(t),o=Math.cos(t);this.data[0]=o*i.x,this.data[1]=r*i.y,this.data[2]=-r*i.x,this.data[3]=o*i.y}getRotation(){const t=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return er(t)}getScaleX(){const t=this.data[0]*this.data[0]+this.data[2]*this.data[2];return t===1?this._scaleSignX:this._scaleSignX*Math.sqrt(t)}getScaleY(){const t=this.data[1]*this.data[1]+this.data[3]*this.data[3];return t===1?this._scaleSignY:this._scaleSignY*Math.sqrt(t)}getScale(){return ft(this.getScaleX(),this.getScaleY())}setScaleX(t){if(t===this._scale[0])return;this._scaleSignX=Be(t);const i=ft(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=i.x*t,this.data[2]=i.y*t,this._scale[0]=t}setScaleY(t){if(t===this._scale[1])return;this._scaleSignY=Be(t);const i=ft(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=i.x*t,this.data[3]=i.y*t,this._scale[1]=t}setScale(t){this.setScaleX(t.x),this.setScaleY(t.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const t=this;return t.data[0]=1,t.data[1]=0,t.data[2]=0,t.data[3]=1,t.data[4]=0,t.data[5]=0,t}clone(t){const i=t||new ti;return i.data[0]=this.data[0],i.data[1]=this.data[1],i.data[2]=this.data[2],i.data[3]=this.data[3],i.data[4]=this.data[4],i.data[5]=this.data[5],i._scaleSignX=this._scaleSignX,i._scaleSignY=this._scaleSignY,i}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class Mo{constructor(t,i,r=1){this.builder=t,this.cleaner=i,this._pool=[],this._size=0,this.grow(r)}grow(t){if(t>0){this._size+=t;for(let i=0;i<t;i++)this._pool.push(this.builder())}}rent(t=!1){return this._pool.length===0&&this.grow(this._size),t?this.cleaner(this._pool.pop()):this._pool.pop()}return(t){this._pool.push(t)}}class z_{constructor(){this._pool=new Mo(()=>ti.identity(),t=>t.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(t,i){return this._currentTransform.translate(t,i)}rotate(t){return this._currentTransform.rotate(t)}scale(t,i){return this._currentTransform.scale(t,i)}reset(){this._currentTransform.reset()}set current(t){this._currentTransform=t}get current(){return this._currentTransform}}class U_{constructor(){this.opacity=1,this.z=0,this.tint=kt.White,this.material=null}}class ku{constructor(){this._pool=new Mo(()=>new U_,t=>(t.opacity=1,t.z=0,t.tint=kt.White,t.material=null,t),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(t){var i;return t.opacity=this.current.opacity,t.z=this.current.z,t.tint=(i=this.current.tint)===null||i===void 0?void 0:i.clone(),t.material=this.current.material,t}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const N_={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class ko{constructor(t,i,r=!1){this.path=t,this.responseType=i,this.bustCache=r,this.data=null,this.logger=$t.getInstance(),this.events=new Ue}isLoaded(){return this.data!==null}_cacheBust(t){return/\?\w*=\w*/.test(t)?t+="&__="+Date.now():t+="?__="+Date.now(),t}load(){return new Promise((t,i)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),t(this.data);return}const r=new XMLHttpRequest;r.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),r.responseType=this.responseType,r.addEventListener("loadstart",o=>this.events.emit("loadstart",o)),r.addEventListener("progress",o=>this.events.emit("progress",o)),r.addEventListener("error",o=>this.events.emit("error",o)),r.addEventListener("load",o=>this.events.emit("load",o)),r.addEventListener("load",()=>{if(r.status!==0&&r.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",r.status),this.events.emit("error",r.response),i(new Error(r.statusText));return}if(r.response instanceof Blob&&r.response.type==="text/html"){const o=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",r.response),i(new Error(o));return}this.data=r.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),t(this.data)}),r.send()})}}function ws(c,t){return c&&(c.__isProxy===void 0?new Proxy(c,{set:(i,r,o)=>(i[r]!==o&&(i[r]=o,typeof r=="string"&&r[0]!=="_"&&t(i)),!0),get:(i,r)=>r!=="__isProxy"?i[r]:!0}):c)}const Qu=(c=[],t,i)=>({get:(r,o)=>o==="__isProxy"?!0:typeof r[o]=="object"&&r[o]!=null?new Proxy(r[o],Qu([...c,o],t,i)):r[o],set:(r,o,h)=>(typeof o=="string"&&o[0]!=="_"&&t(i),r[o]=h,!0)});function G_(c,t){return c&&(c.__isProxy===void 0?new Proxy(c,Qu([],t,c)):c)}class Oe{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(t){this._flipHorizontal=t,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(t){this._flipVertical=t,this._transformStale=!0}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._transformStale=!0}get scale(){return this._scale}set scale(t){this._scale=ws(t,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(t){t&&(this._origin=ws(t,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(t){var i,r,o,h,u,_,A;this.id=Oe._ID++,this.transform=ti.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=rt.One,this._width=0,this._height=0,t&&(this.origin=(i=t.origin)!==null&&i!==void 0?i:this.origin,this.flipHorizontal=(r=t.flipHorizontal)!==null&&r!==void 0?r:this.flipHorizontal,this.flipVertical=(o=t.flipVertical)!==null&&o!==void 0?o:this.flipVertical,this.rotation=(h=t.rotation)!==null&&h!==void 0?h:this.rotation,this.opacity=(u=t.opacity)!==null&&u!==void 0?u:this.opacity,this.scale=(_=t.scale)!==null&&_!==void 0?_:this.scale,this.tint=(A=t.tint)!==null&&A!==void 0?A:this.tint,t.width&&(this._width=t.width),t.height&&(this._height=t.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(t){this._width=t,this._transformStale=!0}set height(t){this._height=t,this._transformStale=!0}get localBounds(){return Zt.fromDimension(this.width,this.height,rt.Zero)}draw(t,i,r){this._preDraw(t,i,r),this._drawImage(t,0,0),this._postDraw(t)}_preDraw(t,i,r){t.save(),t.translate(i,r),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),t.multiply(this.transform),t.opacity=t.opacity*this.opacity,this.tint&&(t.tint=this.tint)}_rotate(t){var i;const r=this.scale.x>0?1:-1,o=this.scale.y>0?1:-1,h=(i=this.origin)!==null&&i!==void 0?i:ft(this.width/2,this.height/2);t.translate(h.x,h.y),t.rotate(this.rotation),t.scale(r,o),t.translate(-h.x,-h.y)}_flip(t){this.flipHorizontal&&(t.translate(this.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,this.height/this.scale.y),t.scale(1,-1))}_postDraw(t){this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore()}}Oe._ID=0;class ys extends Oe{static from(t,i){return new ys({image:t,...i})}constructor(t){var i,r;super(t),this._logger=$t.getInstance(),this._dirty=!0,this.image=t.image;const{width:o,height:h}=t;this.sourceView=(i=t.sourceView)!==null&&i!==void 0?i:{x:0,y:0,width:o??0,height:h??0},this.destSize=(r=t.destSize)!==null&&r!==void 0?r:{width:o??0,height:h??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(t){t/=Math.abs(this.scale.x),this.destSize.width=t,super.width=Math.ceil(this.destSize.width)}set height(t){t/=Math.abs(this.scale.y),this.destSize.height=t,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var t,i,r,o,h,u;const{width:_,height:A}=this.image;this.sourceView.width=((t=this.sourceView)===null||t===void 0?void 0:t.width)||_,this.sourceView.height=((i=this.sourceView)===null||i===void 0?void 0:i.height)||A,this.destSize.width=((r=this.destSize)===null||r===void 0?void 0:r.width)||((o=this.sourceView)===null||o===void 0?void 0:o.width)||_,this.destSize.height=((h=this.destSize)===null||h===void 0?void 0:h.height)||((u=this.sourceView)===null||u===void 0?void 0:u.height)||A,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(t,i,r){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(t,i,r)}_drawImage(t,i,r){this.image.isLoaded()?t.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,i,r,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new ys({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var ii;(function(c){c.Pixel="Pixel",c.Blended="Blended"})(ii||(ii={}));function qn(c){switch(c){case ii.Pixel:return ii.Pixel;case ii.Blended:return ii.Blended;default:return}}var Le;(function(c){c.Clamp="Clamp",c.Repeat="Repeat",c.Mirror="Mirror"})(Le||(Le={}));function bs(c){switch(c){case Le.Clamp:return Le.Clamp;case Le.Repeat:return Le.Repeat;case Le.Mirror:return Le.Mirror;default:return Le.Clamp}}class Ne{constructor(t,i){var r;this._garbageCollector=i,this._textureMap=new Map,this._collect=o=>{var h;if(this._gl){const u=(h=o.dataset.originalSrc)!==null&&h!==void 0?h:o.constructor.name;return Ne._LOGGER.debug(`WebGL Texture for ${u} collected`),this.delete(o),!0}return!1},this._gl=t,Ne._MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),this._garbageCollector&&(Ne._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(r=this._garbageCollector.garbageCollector)===null||r===void 0||r.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[t]of this._textureMap)this.delete(t);this._textureMap.clear(),this._gl=null}get(t){return this._textureMap.get(t)}has(t){return this._textureMap.has(t)}load(t,i,r=!1){var o,h;const u=this._gl;if(!u)return null;const{filtering:_,wrapping:A}={...i};let y=null;if(this.has(t)&&(y=this.get(t)),y)return r&&(u.bindTexture(u.TEXTURE_2D,y),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,t)),(o=this._garbageCollector)===null||o===void 0||o.garbageCollector.touch(t),y;y=u.createTexture(),Ne.checkImageSizeSupportedAndLog(t),u.bindTexture(u.TEXTURE_2D,y),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let w;A&&(typeof A=="string"?w={x:A,y:A}:w={x:A.x,y:A.y});const{x:f,y:T}=w??Ne.wrapping;switch(f){case Le.Clamp:u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE);break;case Le.Repeat:u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.REPEAT);break;case Le.Mirror:u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.MIRRORED_REPEAT);break;default:u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE)}switch(T){case Le.Clamp:u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE);break;case Le.Repeat:u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.REPEAT);break;case Le.Mirror:u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.MIRRORED_REPEAT);break;default:u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE)}const C=_??Ne.filtering;return u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,C===ii.Pixel?u.NEAREST:u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,C===ii.Pixel?u.NEAREST:u.LINEAR),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,t),this._textureMap.set(t,y),(h=this._garbageCollector)===null||h===void 0||h.garbageCollector.addCollectableResource("texture",t),y}delete(t){const i=this._gl;if(i&&this.has(t)){const r=this.get(t);r&&(this._textureMap.delete(t),i.deleteTexture(r))}}static checkImageSizeSupportedAndLog(t){var i;const r=(i=t.dataset.originalSrc)!==null&&i!==void 0?i:"internal canvas bitmap";return t.width>Ne._MAX_TEXTURE_SIZE||t.height>Ne._MAX_TEXTURE_SIZE?(Ne._LOGGER.error(`The image [${r}] provided to Excalibur is too large for the device's maximum texture size of (${Ne._MAX_TEXTURE_SIZE}x${Ne._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((t.width>4096||t.height>4096)&&Ne._LOGGER.warn(`The image [${r}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}Ne._LOGGER=$t.getInstance();Ne.filtering=ii.Blended;Ne.wrapping={x:Le.Clamp,y:Le.Clamp};Ne._MAX_TEXTURE_SIZE=4096;const me={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class Qs{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(t,i,r){this._logger=$t.getInstance(),this.data=new Image,this._readyFuture=new ns,this.ready=this._readyFuture.promise,this.path=t;let o=!1,h;typeof i=="boolean"?o=i:{filtering:r,wrapping:h,bustCache:o}={...i},this._resource=new ko(t,"blob",o),this.filtering=r??this.filtering,typeof h=="string"?this.wrapping={x:h,y:h}:this.wrapping=h??this.wrapping,t.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${t} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(t,i){const r=new Qs("");if(r._src="image-element",r.data=t,r.data.setAttribute("data-original-src","image-element"),i!=null&&i.filtering?r.data.setAttribute(me.Filtering,i==null?void 0:i.filtering):r.data.setAttribute(me.Filtering,ii.Blended),i!=null&&i.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},r.data.setAttribute(me.WrappingX,o.x),r.data.setAttribute(me.WrappingY,o.y)}else r.data.setAttribute(me.WrappingX,Le.Clamp),r.data.setAttribute(me.WrappingY,Le.Clamp);return Ne.checkImageSizeSupportedAndLog(t),r._readyFuture.resolve(t),r}static fromHtmlCanvasElement(t,i){const r=new Qs("");if(r._src="canvas-element-blob",r.data.setAttribute("data-original-src","canvas-element-blob"),i!=null&&i.filtering?r.data.setAttribute(me.Filtering,i==null?void 0:i.filtering):r.data.setAttribute(me.Filtering,ii.Blended),i!=null&&i.wrapping){let o;typeof i.wrapping=="string"?o={x:i.wrapping,y:i.wrapping}:o={x:i.wrapping.x,y:i.wrapping.y},r.data.setAttribute(me.WrappingX,o.x),r.data.setAttribute(me.WrappingY,o.y)}else r.data.setAttribute(me.WrappingX,Le.Clamp),r.data.setAttribute(me.WrappingY,Le.Clamp);return Ne.checkImageSizeSupportedAndLog(t),t.toBlob(o=>{const h=URL.createObjectURL(o);r.image.onload=()=>{URL.revokeObjectURL(h),r.data=r.image,r._readyFuture.resolve(r.image)},r.image.src=h}),r}static fromSvgString(t,i){const r=new Blob([t],{type:"image/svg+xml"}),o=URL.createObjectURL(r);return new Qs(o,i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){var t,i,r,o;if(this.isLoaded())return this.data;try{let h;if(this.path.includes("data:image/"))h=this.path;else{const A=await this._resource.load();h=URL.createObjectURL(A)}const u=new Image,_=new ns;u.onload=()=>_.resolve(),u.src=h,u.setAttribute("data-original-src",this.path),await _.promise,this.data=u,Ne.checkImageSizeSupportedAndLog(this.data)}catch(h){throw`Error loading ImageSource from path '${this.path}' with error [${h.message}]`}return this.data.setAttribute(me.Filtering,this.filtering),this.data.setAttribute(me.WrappingX,(i=(t=this.wrapping)===null||t===void 0?void 0:t.x)!==null&&i!==void 0?i:Le.Clamp),this.data.setAttribute(me.WrappingY,(o=(r=this.wrapping)===null||r===void 0?void 0:r.y)!==null&&o!==void 0?o:Le.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(t){return ys.from(this,t)}unload(){this.data=new Image}}class Va extends Oe{constructor(t){super(t),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=$t.getInstance();const{alphabet:i,spriteSheet:r,caseInsensitive:o,spacing:h,shadow:u,lineHeight:_}=t;this.alphabet=i,this.spriteSheet=r,this.caseInsensitive=o??this.caseInsensitive,this.spacing=h??this.spacing,this.shadow=u??this.shadow,this.lineHeight=_??this.lineHeight}_getCharacterSprites(t){const i=[],r=this.caseInsensitive?t.toLocaleLowerCase():t,o=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let h=0;h<r.length;h++){const u=r[h];let _=o.indexOf(u);_===-1&&(_=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${u}' in configured alphabet '${o}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const A=this.spriteSheet.sprites[_];A?i.push(A):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${u}' at index '${_}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return i}measureText(t,i){const r=this._getLinesFromText(t,i),o=r.reduce((A,y)=>A.length>y.length?A:y),h=this._getCharacterSprites(o);let u=0,_=0;for(const A of h)u+=A.width+this.spacing,_=Math.max(_,A.height);return Zt.fromDimension(u*this.scale.x,_*r.length*this.scale.y,rt.Zero)}_drawImage(t,i,r,o){var h;let u=0,_=0,A=0;const y=this._getLinesFromText(this._text,o);for(const w of y){for(const f of this._getCharacterSprites(w))f.draw(t,i+u,r+_),u+=f.width+this.spacing,A=Math.max(A,f.height);u=0,_+=(h=this.lineHeight)!==null&&h!==void 0?h:A}}render(t,i,r,o,h,u){this._text=i;const _=this.measureText(i,u);this.width=_.width,this.height=_.height,this.shadow&&(t.save(),t.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(t,o,h),this._drawImage(t,0,0,u),this._postDraw(t),t.restore()),this._preDraw(t,o,h),this._drawImage(t,0,0,u),this._postDraw(t)}clone(){return new Va({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(t,i){var r;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let u=o[h],_="";if(this.measureText(u).width>i){for(;this.measureText(u).width>i;)_=u[u.length-1]+_,u=u.slice(0,-1);o[h]=u,o[h+1]=_}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class Qo extends ys{constructor(t){super({image:t.image,sourceView:t.sourceView,destSize:{width:t.width,height:t.height},flipHorizontal:t.flipHorizontal,flipVertical:t.flipVertical,rotation:t.rotation,scale:t.scale,opacity:t.opacity,tint:t.tint,origin:t.origin}),this._ready=new ns,this.ready=this._ready.promise,this._options=t,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(t,i){return new Qo({sourceView:{...t.sourceView},width:t.width,height:t.height,...i,image:t.image})}_applyTiling(){const{width:t,height:i,filtering:r,wrapping:o}={...this._options},h=document.createElement("canvas");h.width=this.sourceView.width,h.height=this.sourceView.height,h.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const _=Qs.fromHtmlCanvasElement(h,{wrapping:o??Le.Repeat,filtering:r});t&&(this.destSize.width=t,this.sourceView.width=t),i&&(this.destSize.height=i,this.sourceView.height=i),this.sourceView.x=0,this.sourceView.y=0,this.image=_,this.image.ready.then(()=>this._ready.resolve())}}class nn{constructor(t){this.sprites=[];const{sprites:i,rows:r,columns:o}=t;this.sprites=i,this.rows=r??1,this.columns=o??this.sprites.length}getSprite(t,i,r){var o,h,u,_,A,y,w,f,T;if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const C=t+i*this.columns,S=this.sprites[C];if(S){if(r){const E=S.clone();return E.flipHorizontal=(o=r.flipHorizontal)!==null&&o!==void 0?o:E.flipHorizontal,E.flipVertical=(h=r.flipVertical)!==null&&h!==void 0?h:E.flipVertical,E.width=(u=r.width)!==null&&u!==void 0?u:E.width,E.height=(_=r.height)!==null&&_!==void 0?_:E.height,E.rotation=(A=r.rotation)!==null&&A!==void 0?A:E.rotation,E.scale=(y=r.scale)!==null&&y!==void 0?y:E.scale,E.opacity=(w=r.opacity)!==null&&w!==void 0?w:E.opacity,E.tint=(f=r.tint)!==null&&f!==void 0?f:E.tint,E.origin=(T=r.origin)!==null&&T!==void 0?T:E.origin,E}return S}throw Error(`Invalid sprite coordinates (${t}, ${i})`)}getTiledSprite(t,i,r){if(t>=this.columns||t<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), x: ${t} should be between 0 and ${this.columns-1} columns`);if(i>=this.rows||i<0)throw Error(`No sprite exists in the SpriteSheet at (${t}, ${i}), y: ${i} should be between 0 and ${this.rows-1} rows`);const o=t+i*this.columns,h=this.sprites[o];if(h)return Qo.fromSprite(h,r);throw Error(`Invalid sprite coordinates (${t}, ${i})`)}static fromImageSourceWithSourceViews(t){const i=t.sourceViews.map(r=>new ys({image:t.image,sourceView:r}));return new nn({sprites:i})}static fromImageSource(t){var i;const r=[];t.spacing=(i=t.spacing)!==null&&i!==void 0?i:{};const{image:o,grid:{rows:h,columns:u,spriteWidth:_,spriteHeight:A},spacing:{originOffset:y,margin:w}}=t,f={x:0,y:0,...y},T={x:0,y:0,...w};for(let C=0;C<u;C++)for(let S=0;S<h;S++)r[C+S*u]=new ys({image:o,sourceView:{x:C*_+T.x*C+f.x,y:S*A+T.y*S+f.y,width:_,height:A},destSize:{height:A,width:_}});return new nn({sprites:r,rows:h,columns:u})}clone(){return new nn({sprites:this.sprites.map(t=>t.clone()),rows:this.rows,columns:this.columns})}}const O_="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class Ll{constructor(){this.fontSheet=O_,this.size=16,this.load()}load(){return this._imageSource=new Qs(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=nn.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new Va({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(t,i,r){this._imageSource.isLoaded()&&this._spriteFont.render(t,i,null,r.x,r.y)}}class H_{constructor(t,i){this._gl=t,this._texture=i}use(){const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture)}disable(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,null)}}class Ca{constructor(t){var i,r;this.antialias=!1,this.samples=1,this._gl=t.gl,this.width=t.width,this.height=t.height,this.transparency=t.transparency,this.antialias=(i=t.antialias)!==null&&i!==void 0?i:this.antialias,this.samples=(r=t.samples)!==null&&r!==void 0?r:this._gl.getParameter(this._gl.MAX_SAMPLES);const o=this._gl;o.drawingBufferFormat?this.bufferFormat=o.drawingBufferFormat:this.transparency?this.bufferFormat=o.RGBA8:this.bufferFormat=o.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(t,i){const r=this._gl;this.width=t,this.height=i,r.bindTexture(r.TEXTURE_2D,this._frameTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,this.width,this.height,0,r.RGBA,r.UNSIGNED_BYTE,null),this._renderBuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Math.min(this.samples,r.getParameter(r.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const t=this._gl;this._renderBuffer=t.createRenderbuffer(),this._renderFrameBuffer=t.createFramebuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this._renderBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,Math.min(this.samples,t.getParameter(t.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const t=this._gl;this._frameTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._frameTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const i=t.COLOR_ATTACHMENT0;this._frameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,i,t.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new H_(this._gl,this._frameTexture)}blitToScreen(){const t=this._gl;this._renderBuffer?(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)):(t.bindFramebuffer(t.READ_FRAMEBUFFER,this.frameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const t=this._gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer),t.clearBufferfv(t.COLOR,0,[0,0,1,1]),t.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,t.COLOR_BUFFER_BIT,t.LINEAR)}}copyToTexture(t){const i=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),i.bindTexture(i.TEXTURE_2D,t),i.copyTexImage2D(i.TEXTURE_2D,0,i.RGBA,0,0,this.width,this.height,0)}use(){const t=this._gl;this.antialias?t.bindFramebuffer(t.FRAMEBUFFER,this._renderFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),t.viewport(0,0,this.width,this.height)}disable(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null)}}const W_=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,q_=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function gl(c,t){switch(t){case c.INT:case c.UNSIGNED_INT:case c.FLOAT:return 4;case c.SHORT:return 2;case c.UNSIGNED_SHORT:return 2;case c.BYTE:return 1;case c.UNSIGNED_BYTE:return 1;default:return 1}}function Lu(c,t){const i=`(?<type>[a-z0-9]+)\\s+${t};`,o=new RegExp(i,"g").exec(c);return(o==null?void 0:o.length)>0}function zu(c,t,i){var r;const o=`(?<type>[a-z0-9]+)\\s+${i};`,u=new RegExp(o,"g").exec(t);switch((r=u==null?void 0:u.groups)===null||r===void 0?void 0:r.type){case"float":case"vec2":case"vec3":case"vec4":return c.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return c.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return c.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return c.BOOL;case"short":return c.SHORT;case"ushort":return c.UNSIGNED_SHORT;case"ubyte":return c.UNSIGNED_BYTE;case"byte":return c.BYTE;default:return c.FLOAT}}function Uu(c,t){switch(t){case c.LOW_FLOAT:case c.HIGH_FLOAT:case c.FLOAT:return 1;case c.FLOAT_VEC2:return 2;case c.FLOAT_VEC3:return 3;case c.FLOAT_VEC4:return 4;case c.BYTE:return 1;case c.UNSIGNED_BYTE:return 1;case c.UNSIGNED_SHORT:case c.SHORT:return 1;default:return 1}}function Nu(c,t){switch(t){case c.LOW_FLOAT:case c.HIGH_FLOAT:case c.FLOAT:case c.FLOAT_VEC2:case c.FLOAT_VEC3:case c.FLOAT_VEC4:return c.FLOAT;case c.BYTE:return c.BYTE;case c.UNSIGNED_BYTE:return c.UNSIGNED_BYTE;case c.SHORT:return c.SHORT;case c.UNSIGNED_SHORT:return c.UNSIGNED_SHORT;default:return c.FLOAT}}function zl(c,t){const i=o=>{const h=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let u="";for(let _=0;_<o;_++)_===0?u+=`if (index <= ${_}.5) {
`:u+=`   else if (index <= ${_}.5) {
`,u+=`      fragColor = vec4(1.0);
`,u+=`   }
`;return h.replace("%%complexity%%",u)};let r=!1;do{const o=i(t),h=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(h,o),c.compileShader(h),r=c.getShaderParameter(h,c.COMPILE_STATUS),r||(t=t/2|0)}while(!r);return t}class Yi{get compiled(){return this._compiled}constructor(t){this._logger=$t.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:i,vertexSource:r,fragmentSource:o,onPreLink:h,onPostCompile:u}=t;this._gl=i,this.vertexSource=r,this.fragmentSource=o,this._onPreLink=h,this._onPostCompile=u}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),Yi._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return Yi._ACTIVE_SHADER_INSTANCE===this}compile(){const t=this._gl,i=this._compileShader(t,this.vertexSource,t.VERTEX_SHADER),r=this._compileShader(t,this.fragmentSource,t.FRAGMENT_SHADER);this.program=this._createProgram(t,i,r);const o=this.getAttributes();for(const u of o)this.attributes[u.name]=u;const h=this.getUniforms();for(const u of h)this.uniforms[u.name]=u;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS),r=[];for(let o=0;o<i;o++){const h=t.getActiveUniform(this.program,o),u=t.getUniformLocation(this.program,h.name);r.push({name:h.name,glType:h.type,location:u})}return r}getAttributes(){const t=this._gl,i=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES),r=[];for(let o=0;o<i;o++){const h=t.getActiveAttrib(this.program,o),u=t.getAttribLocation(this.program,h.name);r.push({name:h.name,glType:Nu(t,h.type),size:Uu(t,h.type),location:u,normalized:!1})}return r}setTexture(t,i){const r=this._gl;r.activeTexture(r.TEXTURE0+t),r.bindTexture(r.TEXTURE_2D,i)}setUniformInt(t,i){this.setUniform("uniform1i",t,~~i)}trySetUniformInt(t,i){return this.trySetUniform("uniform1i",t,~~i)}setUniformIntArray(t,i){this.setUniform("uniform1iv",t,i)}trySetUniformIntArray(t,i){return this.trySetUniform("uniform1iv",t,i)}setUniformBoolean(t,i){this.setUniform("uniform1i",t,i?1:0)}trySetUniformBoolean(t,i){return this.trySetUniform("uniform1i",t,i?1:0)}setUniformFloat(t,i){this.setUniform("uniform1f",t,i)}trySetUniformFloat(t,i){return this.trySetUniform("uniform1f",t,i)}setUniformFloatArray(t,i){this.setUniform("uniform1fv",t,i)}trySetUniformFloatArray(t,i){return this.trySetUniform("uniform1fv",t,i)}setUniformFloatVector(t,i){this.setUniform("uniform2f",t,i.x,i.y)}trySetUniformFloatVector(t,i){return this.trySetUniform("uniform2f",t,i.x,i.y)}setUniformFloatColor(t,i){this.setUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}trySetUniformFloatColor(t,i){return this.trySetUniform("uniform4f",t,i.r/255,i.g/255,i.b/255,i.a)}setUniformMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,i.data)}setUniformAffineMatrix(t,i){this.setUniform("uniformMatrix4fv",t,!1,[i.data[0],i.data[1],0,0,i.data[2],i.data[3],0,0,0,0,1,0,i.data[4],i.data[5],0,1])}trySetUniformMatrix(t,i){return this.trySetUniform("uniformMatrix4fv",t,!1,i.data)}setUniform(t,i,...r){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${t}:${i}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const h=this._gl.getUniformLocation(this.program,i);if(h){const u=[h,...r];this._gl[t].apply(this._gl,u)}else throw Error(`Uniform ${t}:${i} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(t,i,...r){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${t}:${i}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const h=this._gl.getUniformLocation(this.program,i);if(h){const u=[h,...r];this._gl[t].apply(this._gl,u)}else return!1;return!0}_createProgram(t,i,r){const o=t.createProgram();if(o===null)throw Error("Could not create graphics shader program");if(t.attachShader(o,i),t.attachShader(o,r),this._onPreLink&&this._onPreLink(o),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw Error(`Could not link the program: [${t.getProgramInfoLog(o)}]`);return o}_compileShader(t,i,r){const o=t.VERTEX_SHADER===r?"vertex":"fragment",h=t.createShader(r);if(h===null)throw Error(`Could not build shader: [${i}]`);if(t.shaderSource(h,i),t.compileShader(h),!t.getShaderParameter(h,t.COMPILE_STATUS)){const _=t.getShaderInfoLog(h);throw Error(`Could not compile ${o} shader:

${_}${this._processSourceForError(i,_)}`)}return h}_processSourceForError(t,i){if(!t)return i;const r=t.split(`
`),o=i.search(/\d:\d/),h=i.indexOf(" ",o),[u,_]=i.slice(o,h).split(":").map(A=>Number(A));for(let A=0;A<r.length;A++)r[A]=`${A+1}: ${r[A]}${_===A+1?" <----- ERROR!":""}`;return`

Source:
`+r.join(`
`)}}Yi._ACTIVE_SHADER_INSTANCE=null;class Us{constructor(t){this.type="dynamic";const{gl:i,size:r,type:o,data:h}=t;if(this._gl=i,this.buffer=this._gl.createBuffer(),!h&&!r)throw Error("Must either provide data or a size to the VertexBuffer");h?this.bufferData=h:this.bufferData=new Float32Array(r),this.type=o??this.type,i.bindBuffer(i.ARRAY_BUFFER,this.buffer),i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)}unbind(){const t=this._gl;t.bindBuffer(t.ARRAY_BUFFER,null)}upload(t){const i=this._gl;i.bindBuffer(i.ARRAY_BUFFER,this.buffer),t?i.bufferSubData(i.ARRAY_BUFFER,0,this.bufferData,0,t):i.bufferData(i.ARRAY_BUFFER,this.bufferData,this.type==="static"?i.STATIC_DRAW:i.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class or{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(t){this._logger=$t.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:i,shader:r,vertexBuffer:o,attributes:h,suppressWarnings:u}=t;this._gl=i,this._vertexBuffer=o,this._attributes=h,this._shader=r,this._suppressWarnings=u,r&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(t){t&&this._shader!==t&&(this._shader=t,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const t=this._shader.attributes;for(const h of this._attributes){const u=t[h[0]];if(!u){if(!Lu(this._shader.vertexSource,h[0]))throw Error(`The attribute named: ${h[0]} size ${h[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${h[0]} size ${h[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${h[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${h[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const _=zu(this._gl,this._shader.vertexSource,h[0]);this._layout.push({name:h[0],glType:_,size:h[1],location:-1,normalized:!1})}if(u){if(u.size!==h[1])throw Error(`VertexLayout size definition for attribute: [${h[0]}, ${h[1]}], doesn't match shader source size ${u.size}:
 ${this._shader.vertexSource}`);this._layout.push(u)}}let i=0;for(const h of this._layout){const u=gl(this._gl,h.glType);this._vertexTotalSizeBytes+=u*h.size,i+=h.size}this._vertexBuffer.bufferData.length%i!==0&&this._logger.warn(`The vertex component size (${i})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const r=this._gl;this._vao=r.createVertexArray(),r.bindVertexArray(this._vao),this._vertexBuffer.bind();let o=0;for(const h of this._layout)h.location!==-1&&(h.glType===r.INT?r.vertexAttribIPointer(h.location,h.size,h.glType,this.totalVertexSizeBytes,o):r.vertexAttribPointer(h.location,h.size,h.glType,h.normalized,this.totalVertexSizeBytes,o),r.enableVertexAttribArray(h.location)),o+=gl(r,h.glType)*h.size;r.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(t=!1,i){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const r=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),t&&this._vertexBuffer.upload(i),r.bindVertexArray(this._vao)}}class ze{static clear(){ze.DrawCallCount=0,ze.DrawnImagesCount=0}}ze.DrawCallCount=0;ze.DrawnImagesCount=0;class V_{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=ft(0,0),this._endScratch=ft(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new Yi({gl:t,vertexSource:W_,fragmentSource:q_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new Us({gl:t,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new or({gl:t,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,r){this._isFull()&&this.flush(),this._lineCount++;const o=this._context.getTransform(),h=o.multiply(t,this._startScratch),u=o.multiply(i,this._endScratch),_=this._vertexBuffer.bufferData;_[this._vertexIndex++]=h.x,_[this._vertexIndex++]=h.y,_[this._vertexIndex++]=r.r/255,_[this._vertexIndex++]=r.g/255,_[this._vertexIndex++]=r.b/255,_[this._vertexIndex++]=r.a,_[this._vertexIndex++]=u.x,_[this._vertexIndex++]=u.y,_[this._vertexIndex++]=r.r/255,_[this._vertexIndex++]=r.g/255,_[this._vertexIndex++]=r.b/255,_[this._vertexIndex++]=r.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.LINES,0,this._lineCount*2),ze.DrawnImagesCount+=this._lineCount,ze.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const j_=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Y_=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class X_{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new Yi({gl:t,vertexSource:j_,fragmentSource:Y_}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new Us({gl:t,size:7*this._maxPoints,type:"dynamic"}),this._layout=new or({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(t,i,r){this._isFull()&&this.flush(),this._pointCount++;const o=this._context.getTransform(),h=this._context.opacity,u=this._context.snapToPixel,_=o.multiply(t);u&&(_.x=~~(_.x+ae),_.y=~~(_.y+ae));const A=this._buffer.bufferData;A[this._vertexIndex++]=_.x,A[this._vertexIndex++]=_.y,A[this._vertexIndex++]=i.r/255,A[this._vertexIndex++]=i.g/255,A[this._vertexIndex++]=i.b/255,A[this._vertexIndex++]=i.a*h,A[this._vertexIndex++]=r*Math.max(o.getScaleX(),o.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),t.drawArrays(t.POINTS,0,this._pointCount),ze.DrawnImagesCount+=this._pointCount,ze.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const Z_=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,$_=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class J_{constructor(t){this._gl=t,this._shader=new Yi({gl:t,vertexSource:Z_,fragmentSource:$_}),this._shader.compile(),this._buffer=new Us({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new or({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(t){const i=this._gl;t.getShader().use(),t.getLayout().use(),i.drawArrays(i.TRIANGLES,0,6)}renderToScreen(){const t=this._gl;this._shader.use(),this._layout.use(),t.drawArrays(t.TRIANGLES,0,6)}}class Lo{constructor(t,i,r){this._logger=$t.getInstance(),this._gl=t,this.buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer);const o=i*6;if(!r)this.bufferData=new Uint32Array(o);else{const _=Math.floor(16383.5);this.bufferGlType=t.UNSIGNED_SHORT,this.bufferData=new Uint16Array(o),i>_&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${_}) requested quads(${i})`)}let h=0;for(let u=0;u<o;u+=6)this.bufferData[u+0]=h+0,this.bufferData[u+1]=h+1,this.bufferData[u+2]=h+2,this.bufferData[u+3]=h+2,this.bufferData[u+4]=h+1,this.bufferData[u+5]=h+3,h+=4;t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.bufferData,t.STATIC_DRAW)}bind(){const t=this._gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const K_=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,tp=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class ep{constructor(t){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=kt.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const r=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=zl(t,r);this._maxTextures=Math.min(r,o);const h=this._transformFragmentSource(K_,this._maxTextures);this._shader=new Yi({gl:t,fragmentSource:h,vertexSource:tp}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((u,_)=>_)),this._buffer=new Us({gl:t,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new or({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new Lo(t,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let r=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_textureIndex <= ${h}.5) {
`:o+=`   else if (v_textureIndex <= ${h}.5) {
`,o+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return r=r.replace("%%texture_picker%%",o),r}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(me.Filtering),r=i?qn(i):void 0,o=bs(t.getAttribute(me.WrappingX)),h=bs(t.getAttribute(me.WrappingY)),u=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:r,wrapping:{x:o,y:h}},u);t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&(this._textures.push(_),this._textureToIndex.set(_,this._textureIndex++),this._images.add(t))}_bindTextures(t){for(let i=0;i<this._maxTextures;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this._textures[i]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const r=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(r))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,r,o,h,u,_,A,y){var w,f,T,C;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const S=this._getImageWidth(t),E=this._getImageHeight(t);let W=S||o||0,D=E||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(w=o??S)!==null&&w!==void 0?w:0,this._view[3]=(f=h??E)!==null&&f!==void 0?f:0,this._dest[0]=i??1,this._dest[1]=r??1,u!==void 0&&_!==void 0&&A!==void 0&&y!==void 0&&(this._view[0]=i??1,this._view[1]=r??1,this._view[2]=(T=o??S)!==null&&T!==void 0?T:0,this._view[3]=(C=h??E)!==null&&C!==void 0?C:0,this._dest[0]=u,this._dest[1]=_,W=A,D=y),i=this._view[0],r=this._view[1];const H=this._view[2],k=this._view[3],N=this._context.getTransform(),Q=this._context.opacity,L=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+W,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+D,this._quad[6]=this._dest[0]+W,this._quad[7]=this._dest[1]+D,N.multiplyQuadInPlace(this._quad),L&&(this._quad[0]=~~(this._quad[0]+Be(this._quad[0])*ae),this._quad[1]=~~(this._quad[1]+Be(this._quad[1])*ae),this._quad[2]=~~(this._quad[2]+Be(this._quad[2])*ae),this._quad[3]=~~(this._quad[3]+Be(this._quad[3])*ae),this._quad[4]=~~(this._quad[4]+Be(this._quad[4])*ae),this._quad[5]=~~(this._quad[5]+Be(this._quad[5])*ae),this._quad[6]=~~(this._quad[6]+Be(this._quad[6])*ae),this._quad[7]=~~(this._quad[7]+Be(this._quad[7])*ae));const O=this._context.tint||this._defaultTint,Y=this._getTextureIdForImage(t),ot=S||W,nt=E||D,et=(i+this.uvPadding)/ot,ut=(r+this.uvPadding)/nt,Z=(i+H-this.uvPadding)/ot,I=(r+k-this.uvPadding)/nt,R=S,q=E,tt=this._layout.vertexBuffer.bufferData;tt[this._vertexIndex++]=this._quad[0],tt[this._vertexIndex++]=this._quad[1],tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=R,tt[this._vertexIndex++]=q,tt[this._vertexIndex++]=et,tt[this._vertexIndex++]=ut,tt[this._vertexIndex++]=Y,tt[this._vertexIndex++]=O.r/255,tt[this._vertexIndex++]=O.g/255,tt[this._vertexIndex++]=O.b/255,tt[this._vertexIndex++]=O.a,tt[this._vertexIndex++]=this._quad[4],tt[this._vertexIndex++]=this._quad[5],tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=R,tt[this._vertexIndex++]=q,tt[this._vertexIndex++]=et,tt[this._vertexIndex++]=I,tt[this._vertexIndex++]=Y,tt[this._vertexIndex++]=O.r/255,tt[this._vertexIndex++]=O.g/255,tt[this._vertexIndex++]=O.b/255,tt[this._vertexIndex++]=O.a,tt[this._vertexIndex++]=this._quad[2],tt[this._vertexIndex++]=this._quad[3],tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=R,tt[this._vertexIndex++]=q,tt[this._vertexIndex++]=Z,tt[this._vertexIndex++]=ut,tt[this._vertexIndex++]=Y,tt[this._vertexIndex++]=O.r/255,tt[this._vertexIndex++]=O.g/255,tt[this._vertexIndex++]=O.b/255,tt[this._vertexIndex++]=O.a,tt[this._vertexIndex++]=this._quad[6],tt[this._vertexIndex++]=this._quad[7],tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=R,tt[this._vertexIndex++]=q,tt[this._vertexIndex++]=Z,tt[this._vertexIndex++]=I,tt[this._vertexIndex++]=Y,tt[this._vertexIndex++]=O.r/255,tt[this._vertexIndex++]=O.g/255,tt[this._vertexIndex++]=O.b/255,tt[this._vertexIndex++]=O.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),this._quads.bind(),t.drawElements(t.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),ze.DrawnImagesCount+=this._imageCount,ze.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const ip=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,sp=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class rp{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=kt.Transparent,this._scratch1=ft(0,0),this._scratch2=ft(0,0),this._scratch3=ft(0,0),this._scratch4=ft(0,0)}initialize(t,i){this._gl=t,this._context=i,this._shader=new Yi({gl:t,fragmentSource:ip,vertexSource:sp}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new Us({gl:t,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new or({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Lo(t,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...t){t[0]instanceof rt&&t[1]instanceof rt?this.drawLine.apply(this,t):this.drawRectangle.apply(this,t)}drawLine(t,i,r,o=1){this._isFull()&&this.flush(),this._rectangleCount++;const h=this._context.getTransform(),u=this._context.opacity,_=this._context.snapToPixel,A=i.sub(t),y=A.magnitude,w=A.normalize().perpendicular(),f=o/2,T=h.multiply(w.scale(f,this._scratch1).add(t,this._scratch1),this._scratch1),C=h.multiply(w.scale(-f,this._scratch2).add(t,this._scratch2),this._scratch2),S=h.multiply(w.scale(f,this._scratch3).add(i,this._scratch3),this._scratch3),E=h.multiply(w.scale(-f,this._scratch4).add(i,this._scratch4),this._scratch4);_&&(T.x=~~(T.x+ae),T.y=~~(T.y+ae),S.x=~~(S.x+ae),S.y=~~(S.y+ae),C.x=~~(C.x+ae),C.y=~~(C.y+ae),E.x=~~(E.x+ae),E.y=~~(E.y+ae));const W=0,D=0,H=1,k=1,N=this._transparent,Q=0,L=1,O=this._layout.vertexBuffer.bufferData;O[this._vertexIndex++]=T.x,O[this._vertexIndex++]=T.y,O[this._vertexIndex++]=W,O[this._vertexIndex++]=D,O[this._vertexIndex++]=y,O[this._vertexIndex++]=o,O[this._vertexIndex++]=u,O[this._vertexIndex++]=r.r/255,O[this._vertexIndex++]=r.g/255,O[this._vertexIndex++]=r.b/255,O[this._vertexIndex++]=r.a,O[this._vertexIndex++]=N.r/255,O[this._vertexIndex++]=N.g/255,O[this._vertexIndex++]=N.b/255,O[this._vertexIndex++]=N.a,O[this._vertexIndex++]=Q/L,O[this._vertexIndex++]=C.x,O[this._vertexIndex++]=C.y,O[this._vertexIndex++]=W,O[this._vertexIndex++]=k,O[this._vertexIndex++]=y,O[this._vertexIndex++]=o,O[this._vertexIndex++]=u,O[this._vertexIndex++]=r.r/255,O[this._vertexIndex++]=r.g/255,O[this._vertexIndex++]=r.b/255,O[this._vertexIndex++]=r.a,O[this._vertexIndex++]=N.r/255,O[this._vertexIndex++]=N.g/255,O[this._vertexIndex++]=N.b/255,O[this._vertexIndex++]=N.a,O[this._vertexIndex++]=Q/L,O[this._vertexIndex++]=S.x,O[this._vertexIndex++]=S.y,O[this._vertexIndex++]=H,O[this._vertexIndex++]=D,O[this._vertexIndex++]=y,O[this._vertexIndex++]=o,O[this._vertexIndex++]=u,O[this._vertexIndex++]=r.r/255,O[this._vertexIndex++]=r.g/255,O[this._vertexIndex++]=r.b/255,O[this._vertexIndex++]=r.a,O[this._vertexIndex++]=N.r/255,O[this._vertexIndex++]=N.g/255,O[this._vertexIndex++]=N.b/255,O[this._vertexIndex++]=N.a,O[this._vertexIndex++]=Q/L,O[this._vertexIndex++]=E.x,O[this._vertexIndex++]=E.y,O[this._vertexIndex++]=H,O[this._vertexIndex++]=k,O[this._vertexIndex++]=y,O[this._vertexIndex++]=o,O[this._vertexIndex++]=u,O[this._vertexIndex++]=r.r/255,O[this._vertexIndex++]=r.g/255,O[this._vertexIndex++]=r.b/255,O[this._vertexIndex++]=r.a,O[this._vertexIndex++]=N.r/255,O[this._vertexIndex++]=N.g/255,O[this._vertexIndex++]=N.b/255,O[this._vertexIndex++]=N.a,O[this._vertexIndex++]=Q/L}drawRectangle(t,i,r,o,h=kt.Transparent,u=0){this._isFull()&&this.flush(),this._rectangleCount++;const _=this._context.getTransform(),A=this._context.opacity,y=this._context.snapToPixel,w=_.multiply(t.add(ft(0,0))),f=_.multiply(t.add(ft(i,0))),T=_.multiply(t.add(ft(i,r))),C=_.multiply(t.add(ft(0,r)));y&&(w.x=~~(w.x+ae),w.y=~~(w.y+ae),f.x=~~(f.x+ae),f.y=~~(f.y+ae),C.x=~~(C.x+ae),C.y=~~(C.y+ae),T.x=~~(T.x+ae),T.y=~~(T.y+ae));const S=0,E=0,W=1,D=1,H=this._layout.vertexBuffer.bufferData;H[this._vertexIndex++]=w.x,H[this._vertexIndex++]=w.y,H[this._vertexIndex++]=S,H[this._vertexIndex++]=E,H[this._vertexIndex++]=i,H[this._vertexIndex++]=r,H[this._vertexIndex++]=A,H[this._vertexIndex++]=o.r/255,H[this._vertexIndex++]=o.g/255,H[this._vertexIndex++]=o.b/255,H[this._vertexIndex++]=o.a,H[this._vertexIndex++]=h.r/255,H[this._vertexIndex++]=h.g/255,H[this._vertexIndex++]=h.b/255,H[this._vertexIndex++]=h.a,H[this._vertexIndex++]=u,H[this._vertexIndex++]=C.x,H[this._vertexIndex++]=C.y,H[this._vertexIndex++]=S,H[this._vertexIndex++]=D,H[this._vertexIndex++]=i,H[this._vertexIndex++]=r,H[this._vertexIndex++]=A,H[this._vertexIndex++]=o.r/255,H[this._vertexIndex++]=o.g/255,H[this._vertexIndex++]=o.b/255,H[this._vertexIndex++]=o.a,H[this._vertexIndex++]=h.r/255,H[this._vertexIndex++]=h.g/255,H[this._vertexIndex++]=h.b/255,H[this._vertexIndex++]=h.a,H[this._vertexIndex++]=u,H[this._vertexIndex++]=f.x,H[this._vertexIndex++]=f.y,H[this._vertexIndex++]=W,H[this._vertexIndex++]=E,H[this._vertexIndex++]=i,H[this._vertexIndex++]=r,H[this._vertexIndex++]=A,H[this._vertexIndex++]=o.r/255,H[this._vertexIndex++]=o.g/255,H[this._vertexIndex++]=o.b/255,H[this._vertexIndex++]=o.a,H[this._vertexIndex++]=h.r/255,H[this._vertexIndex++]=h.g/255,H[this._vertexIndex++]=h.b/255,H[this._vertexIndex++]=h.a,H[this._vertexIndex++]=u,H[this._vertexIndex++]=T.x,H[this._vertexIndex++]=T.y,H[this._vertexIndex++]=W,H[this._vertexIndex++]=D,H[this._vertexIndex++]=i,H[this._vertexIndex++]=r,H[this._vertexIndex++]=A,H[this._vertexIndex++]=o.r/255,H[this._vertexIndex++]=o.g/255,H[this._vertexIndex++]=o.b/255,H[this._vertexIndex++]=o.a,H[this._vertexIndex++]=h.r/255,H[this._vertexIndex++]=h.g/255,H[this._vertexIndex++]=h.b/255,H[this._vertexIndex++]=h.a,H[this._vertexIndex++]=u}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),ze.DrawnImagesCount+=this._rectangleCount,ze.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const np=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,op=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class ap{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new Yi({gl:t,fragmentSource:np,vertexSource:op}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._buffer=new Us({gl:t,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new or({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new Lo(t,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(t,i,r,o=kt.Transparent,h=0){this._isFull()&&this.flush(),this._circleCount++;const u=this._context.getTransform(),_=this._context.opacity,A=this._context.snapToPixel,y=u.multiply(t.add(ft(-i,-i))),w=u.multiply(t.add(ft(i,-i))),f=u.multiply(t.add(ft(i,i))),T=u.multiply(t.add(ft(-i,i)));A&&(y.x=~~(y.x+ae),y.y=~~(y.y+ae),w.x=~~(w.x+ae),w.y=~~(w.y+ae),T.x=~~(T.x+ae),T.y=~~(T.y+ae),f.x=~~(f.x+ae),f.y=~~(f.y+ae));const C=0,S=0,E=1,W=1,D=this._layout.vertexBuffer.bufferData;D[this._vertexIndex++]=y.x,D[this._vertexIndex++]=y.y,D[this._vertexIndex++]=C,D[this._vertexIndex++]=S,D[this._vertexIndex++]=_,D[this._vertexIndex++]=r.r/255,D[this._vertexIndex++]=r.g/255,D[this._vertexIndex++]=r.b/255,D[this._vertexIndex++]=r.a,D[this._vertexIndex++]=o.r/255,D[this._vertexIndex++]=o.g/255,D[this._vertexIndex++]=o.b/255,D[this._vertexIndex++]=o.a,D[this._vertexIndex++]=h/i,D[this._vertexIndex++]=T.x,D[this._vertexIndex++]=T.y,D[this._vertexIndex++]=C,D[this._vertexIndex++]=W,D[this._vertexIndex++]=_,D[this._vertexIndex++]=r.r/255,D[this._vertexIndex++]=r.g/255,D[this._vertexIndex++]=r.b/255,D[this._vertexIndex++]=r.a,D[this._vertexIndex++]=o.r/255,D[this._vertexIndex++]=o.g/255,D[this._vertexIndex++]=o.b/255,D[this._vertexIndex++]=o.a,D[this._vertexIndex++]=h/i,D[this._vertexIndex++]=w.x,D[this._vertexIndex++]=w.y,D[this._vertexIndex++]=E,D[this._vertexIndex++]=S,D[this._vertexIndex++]=_,D[this._vertexIndex++]=r.r/255,D[this._vertexIndex++]=r.g/255,D[this._vertexIndex++]=r.b/255,D[this._vertexIndex++]=r.a,D[this._vertexIndex++]=o.r/255,D[this._vertexIndex++]=o.g/255,D[this._vertexIndex++]=o.b/255,D[this._vertexIndex++]=o.a,D[this._vertexIndex++]=h/i,D[this._vertexIndex++]=f.x,D[this._vertexIndex++]=f.y,D[this._vertexIndex++]=E,D[this._vertexIndex++]=W,D[this._vertexIndex++]=_,D[this._vertexIndex++]=r.r/255,D[this._vertexIndex++]=r.g/255,D[this._vertexIndex++]=r.b/255,D[this._vertexIndex++]=r.a,D[this._vertexIndex++]=o.r/255,D[this._vertexIndex++]=o.g/255,D[this._vertexIndex++]=o.b/255,D[this._vertexIndex++]=o.a,D[this._vertexIndex++]=h/i}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const t=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),t.drawElements(t.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),ze.DrawnImagesCount+=this._circleCount,ze.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class ja{constructor(t,i,r=100){this.builder=t,this.recycler=i,this.maxObjects=r,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=$t.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let t=0;t<this.maxObjects;t++)this.objects[t]=this.builder()}using(t){const i=t(this);return i?this.done(...i):this.done()}borrow(t){const i=this.get();t(i),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...t){this.index=0;for(const i of t){const r=this.objects.indexOf(i);this.objects[r]=this.builder(),this.totalAllocations++}return t}}class hp{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=ti.identity(),this.state={z:0,opacity:1,tint:kt.White,material:null},this.args=new Array(10)}}const lp=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Gu{constructor(t){this._logger=$t.getInstance(),this._color=kt.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:i,name:r,vertexSource:o,fragmentSource:h,graphicsContext:u,images:_}=t;if(this._name=r??"anonymous material",this._vertexSource=o??lp,this._fragmentSource=h,this._color=i??this._color,!u)throw Error(`Material ${r} must be provided an excalibur webgl graphics context`);if(u instanceof ir?(this._graphicsContext=u,this._initialize(u)):this._logger.warn(`Material ${r} was created in 2D Canvas mode, currently only WebGL is supported`),_)for(const A in _)this.addImageSource(A,_[A])}_initialize(t){if(this._initialized)return;const i=t.__gl;this._maxTextureSlots=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=t.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(t){this._color=t}get name(){var t;return(t=this._name)!==null&&t!==void 0?t:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(t){this._shader&&(this._shader.use(),t(this._shader))}getShader(){return this._shader}addImageSource(t,i){this._images.size<this._maxTextureSlots?this._images.set(t,i):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(t){const i=this._images.get(t);this._graphicsContext.textureLoader.delete(i.image),this._images.delete(t)}_loadImageSource(t){const i=t.image,r=i.getAttribute(me.Filtering),o=r?qn(r):void 0,h=bs(i.getAttribute(me.WrappingX)),u=bs(i.getAttribute(me.WrappingY)),_=i.getAttribute("forceUpload")==="true",A=this._graphicsContext.textureLoader.load(i,{filtering:o,wrapping:{x:h,y:u}},_);return i.removeAttribute("forceUpload"),this._textures.has(t)||this._textures.set(t,A),A}uploadAndBind(t,i=2){let r=i;for(const[o,h]of this._images.entries()){if(!h.isLoaded()){this._logger.warnOnce(`Image named ${o} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const u=this._loadImageSource(h);t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,u),this._shader.trySetUniformInt(o,r),r++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class Au{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(t,i){this._gl=t,this._context=i,this._buffer=new Us({gl:t,size:6*4,type:"dynamic"}),this._layout=new or({gl:t,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new Lo(t,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(t,i,r,o,h,u,_,A,y){var w,f,T,C;const S=this._gl,E=this._context.material;if(!E)return;const W=this._context.getTransform(),D=this._context.opacity,H=E.getShader(),k=this._layout.vertexBuffer.bufferData;let N=0,Q=(t==null?void 0:t.width)||o||0,L=(t==null?void 0:t.height)||h||0,O=[0,0,(w=o??(t==null?void 0:t.width))!==null&&w!==void 0?w:0,(f=h??(t==null?void 0:t.height))!==null&&f!==void 0?f:0],Y=[i??1,r??1];u!==void 0&&_!==void 0&&A!==void 0&&y!==void 0&&(O=[i??1,r??1,(T=o??(t==null?void 0:t.width))!==null&&T!==void 0?T:0,(C=h??(t==null?void 0:t.height))!==null&&C!==void 0?C:0],Y=[u,_],Q=A,L=y),i=O[0],r=O[1];const ot=O[2],nt=O[3],et=ft(Y[0],Y[1]),ut=ft(Y[0]+Q,Y[1]),Z=ft(Y[0],Y[1]+L),I=ft(Y[0]+Q,Y[1]+L),R=t.width||Q,q=t.height||L,tt=i/R,X=r/q,j=(i+ot-.01)/R,F=(r+nt-.01)/q,St=W.getPosition(),Dt=St.add(I),ht=St.x/this._context.width,Mt=St.y/this._context.height,Ct=Dt.x/this._context.width,Yt=Dt.y/this._context.height;k[N++]=et.x,k[N++]=et.y,k[N++]=tt,k[N++]=X,k[N++]=ht,k[N++]=Mt,k[N++]=Z.x,k[N++]=Z.y,k[N++]=tt,k[N++]=F,k[N++]=ht,k[N++]=Yt,k[N++]=ut.x,k[N++]=ut.y,k[N++]=j,k[N++]=X,k[N++]=Ct,k[N++]=Mt,k[N++]=I.x,k[N++]=I.y,k[N++]=j,k[N++]=F,k[N++]=Ct,k[N++]=Yt;const xt=this._addImageAsTexture(t);E.use(),this._layout.shader=H,this._layout.use(!0),H.trySetUniformFloat("u_time_ms",performance.now()),H.trySetUniformFloat("u_opacity",D),H.trySetUniformFloatVector("u_resolution",ft(this._context.width,this._context.height)),H.trySetUniformFloatVector("u_graphic_resolution",ft(R,q)),H.trySetUniformFloatVector("u_size",ft(ot,nt)),H.trySetUniformMatrix("u_matrix",this._context.ortho),H.trySetUniformMatrix("u_transform",W.to4x4()),S.activeTexture(S.TEXTURE0+0),S.bindTexture(S.TEXTURE_2D,xt),H.trySetUniformInt("u_graphic",0),S.activeTexture(S.TEXTURE0+1),S.bindTexture(S.TEXTURE_2D,this._context.materialScreenTexture),H.trySetUniformInt("u_screen_texture",1),E.uploadAndBind(S),this._quads.bind(),S.drawElements(S.TRIANGLES,6,this._quads.bufferGlType,0),ze.DrawnImagesCount++,ze.DrawCallCount++}_addImageAsTexture(t){const i=t.getAttribute(me.Filtering),r=i?qn(i):void 0,o=bs(t.getAttribute(me.WrappingX)),h=bs(t.getAttribute(me.WrappingY)),u=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:r,wrapping:{x:o,y:h}},u);return t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&this._textures.push(_),_}hasPendingDraws(){return!1}flush(){}}const cp=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,dp=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var yi;(function(c){c.World="world",c.Screen="screen"})(yi||(yi={}));class fl extends rt{constructor(t){super(0,0),this._getX=t.getX,this._getY=t.getY,this._setX=t.setX,this._setY=t.setY}get x(){return this._x=this._getX()}set x(t){this._setX(t),this._x=t}get y(){return this._y=this._getY()}set y(t){this._setY(t),this._y=t}}class Er extends rt{constructor(t,i){super(t.x,t.y),this.original=t,this.change=i}get x(){return this._x=this.original.x}set x(t){t!==this._x&&(this.change(t,this._y),this._x=this.original.x=t)}get y(){return this._y=this.original.y}set y(t){t!==this._y&&(this.change(this._x,t),this._y=this.original.y=t)}setTo(t,i){this.x=t,this.y=i}}class rr{constructor(){this._parent=null,this._children=[],this._pos=new Er(ft(0,0),()=>{this.flagDirty()}),this._globalPos=new fl({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:t=>{if(this.parent){const{x:i}=this.parent.inverse.multiply(ft(t,this.pos.y));this.pos.x=i}else this.pos.x=t;t!==this.matrix.data[4]&&this.flagDirty()},setY:t=>{if(this.parent){const{y:i}=this.parent.inverse.multiply(ft(this.pos.x,t));this.pos.y=i}else this.pos.y=t;t!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new Er(ft(1,1),()=>{this.flagDirty()}),this._globalScale=new fl({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:t=>{if(this.parent){const i=this.parent.globalScale.x;this.scale.x=t/i}else this.scale.x=t},setY:t=>{if(this.parent){const i=this.parent.globalScale.y;this.scale.y=t/i}else this.scale.y=t}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=ti.identity(),this._inverse=ti.identity(),this._scratch=ti.identity()}get parent(){return this._parent}set parent(t){if(this._parent){const i=this._parent._children.indexOf(this);i>-1&&this._parent._children.splice(i,1)}this._parent=t,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(t){this._pos.x=t.x,this._pos.y=t.y}get pos(){return this._pos}set globalPos(t){let i=t.clone();this.parent&&(i=this.parent.inverse.multiply(t)),i.equals(this._pos)||(this._pos=i,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(t){const i=er(t);i!==this._rotation&&this.flagDirty(),this._rotation=i}get rotation(){return this._rotation}set globalRotation(t){let i=0;this.parent&&(i=this.parent.globalRotation);const r=er(t+i);r!==this._rotation&&this.flagDirty(),this._rotation=r}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(t){this._scale.x=t.x,this._scale.y=t.y}get scale(){return this._scale}set globalScale(t){let i=ft(1,1);this.parent&&(i=this.parent.globalScale),this.scale=t.scale(ft(1/i.x,1/i.y))}get globalScale(){return this._globalScale}set z(t){this._z=t,this.flagDirty()}get z(){return this._z}set globalZ(t){this.parent?this.z=t-this.parent.globalZ:this.z=t}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let t=0;t<this._children.length;t++)this._children[t].flagDirty()}apply(t){return this.matrix.multiply(t)}applyInverse(t){return this.inverse.multiply(t)}setTransform(t,i,r){this._pos.x=t.x,this._pos.y=t.y,this._rotation=er(i),this._scale.x=r.x,this._scale.y=r.y,this.flagDirty()}isMirrored(){const t=Be(this.scale.x)>>>31,i=Be(this.scale.y)>>>31;return!!(t^i)}clone(t){const i=t??new rr;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.flagDirty(),i}cloneWithParent(t){const i=t??new rr;return this._pos.clone(i._pos),i._z=this._z,i._rotation=this._rotation,this._scale.clone(i._scale),i.parent=this.parent,i.flagDirty(),i}toString(){return this.matrix.toString()}}function Ou(c){return!!c&&!!c.prototype&&!!c.prototype.constructor}function up(c){return!!(c!=null&&c.clone)}class ls{constructor(){this.owner=void 0}clone(){const t=new this.constructor;for(const i in this)if(this.hasOwnProperty(i)){const r=this[i];up(r)&&i!=="owner"&&i!=="clone"?t[i]=r.clone():t[i]=r}return t}}class zi{constructor(){this.observers=[],this.subscriptions=[]}register(t){this.observers.push(t)}subscribe(t){this.subscriptions.push(t)}unregister(t){const i=this.observers.indexOf(t);i!==-1&&this.observers.splice(i,1)}unsubscribe(t){const i=this.subscriptions.indexOf(t);i!==-1&&this.subscriptions.splice(i,1)}notifyAll(t){const i=this.observers.length;for(let o=0;o<i;o++)this.observers[o].notify(t);const r=this.subscriptions.length;for(let o=0;o<r;o++)this.subscriptions[o](t)}clear(){this.observers.length=0,this.subscriptions.length=0}}class qt extends ls{constructor(){super(...arguments),this._logger=$t.getInstance(),this._parentComponent=null,this._transform=new rr,this._addChildTransform=t=>{const i=t.get(qt);i&&(i._transform.parent=this._transform,i._parentComponent=this)},this.zIndexChanged$=new zi,this._coordPlane=yi.World}get(){return this._transform}onAdd(t){for(const i of t.children)this._addChildTransform(i);t.childrenAdded$.subscribe(i=>this._addChildTransform(i)),t.childrenRemoved$.subscribe(i=>{const r=i.get(qt);r&&(r._transform.parent=null,r._parentComponent=null)})}onRemove(t){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(t){const i=this._transform.z;this._transform.z=t,i!==t&&this.zIndexChanged$.notifyAll(t)}get globalZ(){return this._transform.globalZ}set globalZ(t){this._transform.globalZ=t}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(t){var i;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(i=this.owner)===null||i===void 0?void 0:i.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=t}get pos(){return this._transform.pos}set pos(t){this._transform.pos=t}get globalPos(){return this._transform.globalPos}set globalPos(t){this._transform.globalPos=t}get rotation(){return this._transform.rotation}set rotation(t){this._transform.rotation=t}get globalRotation(){return this._transform.globalRotation}set globalRotation(t){this._transform.globalRotation=t}get scale(){return this._transform.scale}set scale(t){this._transform.scale=t}get globalScale(){return this._transform.globalScale}set globalScale(t){this._transform.globalScale=t}applyInverse(t){return this._transform.applyInverse(t)}apply(t){return this._transform.apply(t)}clone(){const t=new qt;return t._transform=this._transform.clone(),t}}var yo;(function(c){c.Forward="forward",c.Backward="backward"})(yo||(yo={}));var As;(function(c){c.End="end",c.Loop="loop",c.PingPong="pingpong",c.Freeze="freeze"})(As||(As={}));const gp={Frame:"frame",Loop:"loop",End:"end"};class vs extends Oe{constructor(t){var i,r,o;super(t),this.events=new Ue,this.frames=[],this.strategy=As.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=t.frames,this.speed=(i=t.speed)!==null&&i!==void 0?i:this.speed,this.strategy=(r=t.strategy)!==null&&r!==void 0?r:this.strategy,this.frameDuration=t.totalDuration?t.totalDuration/this.frames.length:(o=t.frameDuration)!==null&&o!==void 0?o:this.frameDuration,t.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new vs({frames:this.frames.map(t=>({...t})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.width*this.scale.x):0}get height(){const t=this.currentFrame;return t&&t.graphic?Math.abs(t.graphic.height*this.scale.y):0}static fromSpriteSheet(t,i,r,o=As.Loop){const h=t.sprites.length-1,u=i.filter(_=>_<0||_>h);return u.length&&vs._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${u.join(",")} no frame will be shown`),new vs({frames:t.sprites.filter((_,A)=>i.indexOf(A)>-1).map(_=>({graphic:_,duration:r})),strategy:o})}static fromSpriteSheetCoordinates(t){var i;const{spriteSheet:r,frameCoordinates:o,durationPerFrame:h,durationPerFrameMs:u,speed:_,strategy:A,reverse:y}=t,w=(i=h??u)!==null&&i!==void 0?i:100,f=[];for(const T of o){const{x:C,y:S,duration:E,options:W}=T,D=r.getSprite(C,S,W);D?f.push({graphic:D,duration:E??w}):vs._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${C}, ${S}), please check your SpriteSheet to confirm that sprite exists`)}return new vs({frames:f,strategy:A,speed:_,reverse:y})}get speed(){return this._speed}set speed(t){this._speed=ce(Math.abs(t),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?yo.Backward:yo.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const t=this.frames[this._currentFrame];t&&(this._timeLeftInFrame=(t==null?void 0:t.duration)||this.frameDuration)}get canFinish(){switch(this.strategy){case As.End:case As.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(t,i){this._currentFrame=t,this._timeLeftInFrame=i??this.frameDuration;const r=this.frames[this._currentFrame];r&&!this._done&&(this._timeLeftInFrame=i??((r==null?void 0:r.duration)||this.frameDuration),this.events.emit("frame",{...r,frameIndex:this.currentFrameIndex}))}_nextFrame(){const t=this._currentFrame;if(this._done)return t;let i=-1;switch(this.strategy){case As.Loop:{i=(t+1)%this.frames.length,i===0&&this.events.emit("loop",this);break}case As.End:{i=t+1,i>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case As.Freeze:{i=ce(t+1,0,this.frames.length-1),i>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case As.PingPong:{t+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),t+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),i=t+this._pingPongDirection%this.frames.length;break}}return i}tick(t,i=0){this._idempotencyToken!==i&&(this._idempotencyToken=i,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=t*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(t,i,r){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(t,i,r)}}vs._LOGGER=$t.getInstance();class zn extends Oe{constructor(t){var i;super(t),this._logger=$t.getInstance(),this.useAnchor=!0,this.members=[],this.members=t.members,this.useAnchor=(i=t.useAnchor)!==null&&i!==void 0?i:this.useAnchor,this._updateDimensions()}clone(){return new zn({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const t=this.localBounds;return this.width=t.width,this.height=t.height,t}get localBounds(){const t=new Zt;for(const i of this.members)if(i instanceof Oe)i.localBounds.combine(t,t);else{const{graphic:r,offset:o,useBounds:h}=i;r?(h===void 0?!0:h)&&r.localBounds.translate(o).combine(t,t):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(i)}.`)}return t}_isAnimationOrGroup(t){return t instanceof vs||t instanceof zn}tick(t,i){for(const r of this.members){let o;r instanceof Oe?o=r:o=r.graphic,this._isAnimationOrGroup(o)&&o.tick(t,i)}}reset(){for(const t of this.members){let i;t instanceof Oe?i=t:i=t.graphic,this._isAnimationOrGroup(i)&&i.reset()}}_preDraw(t,i,r){this._updateDimensions(),super._preDraw(t,this.useAnchor?i:0,this.useAnchor?r:0)}_drawImage(t,i,r){const o=rt.Zero;for(const h of this.members){let u;h instanceof Oe?u=h:(u=h.graphic,h.offset.clone(o)),u&&(t.save(),t.translate(i,r),u.draw(t,o.x,o.y),this.showDebug&&t.debug.drawRect(0,0,this.width,this.height),t.restore())}}}class Vn extends Oe{constructor(t){var i,r,o,h,u,_,A,y,w,f;super(Mu({...t},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=ws(kt.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,t&&(this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this.color=(r=t.color)!==null&&r!==void 0?r:kt.Black,this.strokeColor=t==null?void 0:t.strokeColor,this.smoothing=(o=t.smoothing)!==null&&o!==void 0?o:this.smoothing,this.lineWidth=(h=t.lineWidth)!==null&&h!==void 0?h:this.lineWidth,this.lineDash=(u=t.lineDash)!==null&&u!==void 0?u:this.lineDash,this.lineCap=(_=t.lineCap)!==null&&_!==void 0?_:this.lineCap,this.padding=(A=t.padding)!==null&&A!==void 0?A:this.padding,this.filtering=(y=t.filtering)!==null&&y!==void 0?y:this.filtering),this._bitmap=document.createElement("canvas");const T=(w=t==null?void 0:t.width)!==null&&w!==void 0?w:this._bitmap.width,C=(f=t==null?void 0:t.height)!==null&&f!==void 0?f:this._bitmap.height;this.width=T,this.height=C;const S=this._bitmap.getContext("2d");if(S)this._ctx=S;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(t){t/=Math.abs(this.scale.x),this._bitmap.width=t,this._originalWidth=t,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(t){t/=Math.abs(this.scale.y),this._bitmap.height=t,this._originalHeight=t,this.flagDirty()}_getTotalWidth(){var t;return(((t=this._originalWidth)!==null&&t!==void 0?t:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var t;return(((t=this._originalHeight)!==null&&t!==void 0?t:this._bitmap.height)+this.padding*2)*1}get localBounds(){return Zt.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,rt.Zero)}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this.flagDirty()}get color(){return this._color}set color(t){this.flagDirty(),this._color=ws(t,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(t){this.flagDirty(),t&&(this._strokeColor=ws(t,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(t){this._lineDash=t,this.flagDirty()}get padding(){return this._padding}set padding(t){this._padding=t,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(t){var i,r,o,h;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),t.scale(this.quality,this.quality),t.translate(this.padding,this.padding),t.imageSmoothingEnabled=this.smoothing,t.lineWidth=this.lineWidth,t.setLineDash((i=this.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.lineCap=this.lineCap,t.strokeStyle=(o=(r=this.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&o!==void 0?o:"",t.fillStyle=(h=this.color)===null||h===void 0?void 0:h.toString()}_drawImage(t,i,r){this._dirty&&this.rasterize(),t.scale(1/this.quality,1/this.quality),t.drawImage(this._bitmap,i,r)}}var Ra;(function(c){c.Em="em",c.Rem="rem",c.Px="px",c.Pt="pt",c.Percent="%"})(Ra||(Ra={}));var Fa;(function(c){c.Left="left",c.Right="right",c.Center="center",c.Start="start",c.End="end"})(Fa||(Fa={}));var Ma;(function(c){c.Top="top",c.Hanging="hanging",c.Middle="middle",c.Alphabetic="alphabetic",c.Ideographic="ideographic",c.Bottom="bottom"})(Ma||(Ma={}));var ka;(function(c){c.Normal="normal",c.Italic="italic",c.Oblique="oblique"})(ka||(ka={}));var Qa;(function(c){c.LeftToRight="ltr",c.RightToLeft="rtl"})(Qa||(Qa={}));function _l(c,t=kt.Red,i,r,o,h,u=1,_="butt"){c.save(),c.beginPath(),c.lineWidth=u,c.lineCap=_,c.strokeStyle=t.toString(),c.moveTo(i,r),c.lineTo(o,h),c.closePath(),c.stroke(),c.restore()}function fp(c,t=kt.Red,i){c.beginPath(),c.strokeStyle=t.toString(),c.arc(i.x,i.y,5,0,Math.PI*2),c.closePath(),c.stroke()}function _p(c,t,i,r,o=1){const h=t?t.toString():"blue",u=r.scale(o);c.beginPath(),c.strokeStyle=h,c.moveTo(i.x,i.y),c.lineTo(i.x+u.x,i.y+u.y),c.closePath(),c.stroke()}function pl(c,t,i,r,o,h=5,u=kt.White,_=null){let A;if(typeof h=="number")A={tl:h,tr:h,br:h,bl:h};else{const y={tl:0,tr:0,br:0,bl:0};for(const w in y)if(y.hasOwnProperty(w)){const f=w;A[f]=h[f]||y[f]}}c.beginPath(),c.moveTo(t+A.tl,i),c.lineTo(t+r-A.tr,i),c.quadraticCurveTo(t+r,i,t+r,i+A.tr),c.lineTo(t+r,i+o-A.br),c.quadraticCurveTo(t+r,i+o,t+r-A.br,i+o),c.lineTo(t+A.bl,i+o),c.quadraticCurveTo(t,i+o,t,i+o-A.bl),c.lineTo(t,i+A.tl),c.quadraticCurveTo(t,i,t+A.tl,i),c.closePath(),_&&(c.fillStyle=_.toString(),c.fill()),u&&(c.strokeStyle=u.toString(),c.stroke())}function pp(c,t,i,r,o=kt.White,h=null){c.beginPath(),c.arc(t,i,r,0,Math.PI*2),c.closePath(),h&&(c.fillStyle=h.toString(),c.fill()),o&&(c.strokeStyle=o.toString(),c.stroke())}class kn{constructor(t,i,r,o){this.font=t,this.text=i,this.color=r,this.maxWidth=o,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const h=this.canvas.getContext("2d");if(!h)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=h,this.dimensions=this.measureText(i),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(t,i){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let r=null;i!=null?r=this._getLinesFromText(t,i):r=t.split(`
`);const o=r.reduce((T,C)=>T.length>C.length?T:C);this._applyFont(this.ctx);const h=this.ctx.measureText(o);let u=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);const _=u*r.length;u=_;const A=_-Math.abs(h.actualBoundingBoxAscent),y=0,w=0;return new Zt({left:y-Math.abs(h.actualBoundingBoxLeft)-this.font.padding,top:w-Math.abs(h.actualBoundingBoxAscent)-this.font.padding,bottom:w+A+this.font.padding,right:y+Math.abs(h.actualBoundingBoxRight)+this.font.padding})}_setDimension(t,i){let r=1;this.font.lineHeight&&(r=this.font.lineHeight/this.font.size),i.canvas.width=(t.width+this.font.padding*2)*2*this.font.quality,i.canvas.height=(t.height+this.font.padding*2)*2*this.font.quality*r}static getHashCode(t,i,r){var o;return i+"__hashcode__"+t.fontString+t.showDebug+t.textAlign+t.baseAlign+t.direction+t.lineHeight+JSON.stringify(t.shadow)+(t.padding.toString()+t.smoothing.toString()+t.lineWidth.toString()+t.lineDash.toString()+((o=t.strokeColor)===null||o===void 0?void 0:o.toString())+(r?r.toString():t.color.toString()))}getHashCode(t=!0){return kn.getHashCode(this.font,this.text,t?this.color:void 0)}_applyRasterProperties(t){var i,r,o;t.translate(this.font.padding,this.font.padding),t.imageSmoothingEnabled=this.font.smoothing,t.lineWidth=this.font.lineWidth,t.setLineDash((i=this.font.lineDash)!==null&&i!==void 0?i:t.getLineDash()),t.strokeStyle=(o=(r=this.font.strokeColor)===null||r===void 0?void 0:r.toString())!==null&&o!==void 0?o:"",t.fillStyle=this.color.toString()}_applyFont(t){t.resetTransform(),t.translate(this.font.padding+t.canvas.width/2,this.font.padding+t.canvas.height/2),t.scale(this.font.quality,this.font.quality),t.textAlign=this.font.textAlign,t.textBaseline=this.font.baseAlign,t.font=this.font.fontString,t.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(t.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(t.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(t.shadowOffsetX=this.font.shadow.offset.x,t.shadowOffsetY=this.font.shadow.offset.y))}_drawText(t,i,r){this._applyRasterProperties(t),this._applyFont(t);for(let o=0;o<i.length;o++){const h=i[o];this.color&&t.fillText(h,0,o*r),this.font.strokeColor&&t.strokeText(h,0,o*r)}this.font.showDebug&&(_l(t,kt.Green,-t.canvas.width/2,0,t.canvas.width/2,0,2),_l(t,kt.Red,0,-t.canvas.height/2,0,t.canvas.height/2,2))}_splitTextBitmap(t){const i=[];let r=0,o=0;const h=Math.min(4096,t.canvas.width),u=Math.min(4096,t.canvas.height);for(;r<t.canvas.width;){for(;o<t.canvas.height;){const _=document.createElement("canvas");_.width=h,_.height=u;const A=_.getContext("2d");if(!A)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");A.drawImage(t.canvas,r,o,h,u,0,0,h,u),i.push({x:r,y:o,canvas:_}),o+=u}r+=h,o=0}return i}flagDirty(){this._dirty=!0}render(t,i,r,o){var h;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=t;const u=this.getHashCode();if(this._lastHashCode!==u&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,o),this._setDimension(this.dimensions,this.ctx);const _=this._getLinesFromText(this.text,o),A=(h=this.font.lineHeight)!==null&&h!==void 0?h:this.dimensions.height/_.length;if(this._drawText(this.ctx,_,A),t instanceof ir)for(const y of this._textFragments)t.textureLoader.delete(y.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),t instanceof ir)for(const y of this._textFragments)t.textureLoader.load(y.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=u,this._dirty=!1}for(const _ of this._textFragments)t.drawImage(_.canvas,0,0,_.canvas.width,_.canvas.height,_.x/this.font.quality+i-this.ctx.canvas.width/this.font.quality/2,_.y/this.font.quality+r-this.ctx.canvas.height/this.font.quality/2,_.canvas.width/this.font.quality,_.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof ir)for(const t of this._textFragments)this._ex.textureLoader.delete(t.canvas);this._textFragments.length=0}_getLinesFromText(t,i){var r;if(this._cachedText===t&&this._cachedRenderWidth===i&&(!((r=this._cachedLines)===null||r===void 0)&&r.length))return this._cachedLines;const o=t.split(`
`);if(i==null)return o;for(let h=0;h<o.length;h++){let u=o[h],_="";if(this.measureText(u).width>i){for(;this.measureText(u).width>i;)_=u[u.length-1]+_,u=u.slice(0,-1);o[h]=u,o[h+1]=_}}return this._cachedText=t,this._cachedLines=o,this._cachedRenderWidth=i,o}}class xe{static measureText(t,i,r){const o=kn.getHashCode(i,t);if(xe._MEASURE_CACHE.has(o))return xe._MEASURE_CACHE.get(o);xe._LOGGER.debug("Font text measurement cache miss");const h=i.measureTextWithoutCache(t,r);return xe._MEASURE_CACHE.set(o,h),h}static getTextInstance(t,i,r){const o=kn.getHashCode(i,t,r);let h=xe._TEXT_CACHE.get(o);return h||(h=new kn(i,t,r),xe._TEXT_CACHE.set(o,h),xe._LOGGER.debug("Font text instance cache miss")),xe._TEXT_USAGE.set(h,performance.now()),h}static checkAndClearCache(){const t=[],i=new Set;for(const[o,h]of xe._TEXT_USAGE.entries())if(h+xe.FONT_TIMEOUT<performance.now())xe._LOGGER.debug(`Text cache entry timed out ${o.text}`),t.push(o),o.dispose();else{const u=o.getHashCode(!1);i.add(u)}t.forEach(o=>{xe._TEXT_USAGE.delete(o)}),this._TEXT_CACHE.clear();for(const[o]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(o.getHashCode(),o);const r=new Map;for(const o of i)xe._MEASURE_CACHE.has(o)&&r.set(o,xe._MEASURE_CACHE.get(o));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=r}static get cacheSize(){return xe._TEXT_USAGE.size}static clearCache(){for(const[t]of xe._TEXT_USAGE.entries())t.dispose();xe._TEXT_USAGE.clear(),xe._TEXT_CACHE.clear(),xe._MEASURE_CACHE.clear()}}xe.FONT_TIMEOUT=500;xe._LOGGER=$t.getInstance();xe._TEXT_USAGE=new Map;xe._TEXT_CACHE=new Map;xe._MEASURE_CACHE=new Map;class dn extends Oe{constructor(t={}){var i,r,o,h,u,_,A,y,w,f,T,C,S,E,W,D,H,k,N,Q;super(t),this.filtering=ii.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=kt.Black,this.family="sans-serif",this.style=ka.Normal,this.bold=!1,this.unit=Ra.Px,this.textAlign=Fa.Left,this.baseAlign=Ma.Top,this.direction=Qa.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new Zt,this._textMeasurement=new kn(this,"",kt.Black),this.smoothing=(i=t==null?void 0:t.smoothing)!==null&&i!==void 0?i:this.smoothing,this.padding=(r=t==null?void 0:t.padding)!==null&&r!==void 0?r:this.padding,this.color=(o=t==null?void 0:t.color)!==null&&o!==void 0?o:this.color,this.strokeColor=(h=t==null?void 0:t.strokeColor)!==null&&h!==void 0?h:this.strokeColor,this.lineDash=(u=t==null?void 0:t.lineDash)!==null&&u!==void 0?u:this.lineDash,this.lineWidth=(_=t==null?void 0:t.lineWidth)!==null&&_!==void 0?_:this.lineWidth,this.filtering=(A=t==null?void 0:t.filtering)!==null&&A!==void 0?A:this.filtering,this.family=(y=t==null?void 0:t.family)!==null&&y!==void 0?y:this.family,this.style=(w=t==null?void 0:t.style)!==null&&w!==void 0?w:this.style,this.bold=(f=t==null?void 0:t.bold)!==null&&f!==void 0?f:this.bold,this.size=(T=t==null?void 0:t.size)!==null&&T!==void 0?T:this.size,this.unit=(C=t==null?void 0:t.unit)!==null&&C!==void 0?C:this.unit,this.textAlign=(S=t==null?void 0:t.textAlign)!==null&&S!==void 0?S:this.textAlign,this.baseAlign=(E=t==null?void 0:t.baseAlign)!==null&&E!==void 0?E:this.baseAlign,this.direction=(W=t==null?void 0:t.direction)!==null&&W!==void 0?W:this.direction,this.lineHeight=(D=t==null?void 0:t.lineHeight)!==null&&D!==void 0?D:this.lineHeight,this.quality=(H=t==null?void 0:t.quality)!==null&&H!==void 0?H:this.quality,t!=null&&t.shadow&&(this.shadow={},this.shadow.blur=(k=t.shadow.blur)!==null&&k!==void 0?k:this.shadow.blur,this.shadow.offset=(N=t.shadow.offset)!==null&&N!==void 0?N:this.shadow.offset,this.shadow.color=(Q=t.shadow.color)!==null&&Q!==void 0?Q:this.shadow.color)}clone(){return new dn({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(t,i,r){}_rotate(t){var i;const r=(i=this.origin)!==null&&i!==void 0?i:this._textBounds.center;t.translate(r.x,r.y),t.rotate(this.rotation),t.translate(-r.x,-r.y)}_flip(t){this.flipHorizontal&&(t.translate(this._textBounds.width/this.scale.x,0),t.scale(-1,1)),this.flipVertical&&(t.translate(0,-this._textBounds.height/2/this.scale.y),t.scale(1,-1))}measureTextWithoutCache(t,i){return this._textMeasurement.measureText(t,i)}measureText(t,i){return xe.measureText(t,this,i)}_postDraw(t){t.restore()}render(t,i,r,o,h,u){const _=xe.getTextInstance(i,this,r);this._textBounds=_.dimensions,this._preDraw(t,o,h),_.render(t,o,h,u),this._postDraw(t)}}class zo extends Oe{constructor(t){var i,r;super(t),this._text="",this._textWidth=0,this._textHeight=0,this.font=(i=t.font)!==null&&i!==void 0?i:new dn,this.color=(r=t.color)!==null&&r!==void 0?r:this.color,this.text=t.text,this.maxWidth=t.maxWidth}clone(){var t,i;return new zo({text:this.text.slice(),color:(i=(t=this.color)===null||t===void 0?void 0:t.clone())!==null&&i!==void 0?i:kt.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(t){this._text=t,this._calculateDimension()}get font(){return this._font}set font(t){this._font=t}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:t,height:i}=this.font.measureText(this._text,this.maxWidth);this._textWidth=t,this._textHeight=i}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(t){}_flip(t){}_preDraw(t,i,r){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(t,i,r)}_drawImage(t,i,r){var o;let h=kt.Black;this.font instanceof dn&&(h=(o=this.color)!==null&&o!==void 0?o:this.font.color);const{width:u,height:_}=this.font.measureText(this._text,this.maxWidth);this._textWidth=u,this._textHeight=_,this.font.render(t,this._text,h,i,r,this.maxWidth),this.font.showDebug&&(t.debug.drawRect(i-u,r-_,u*2,_*2),this.maxWidth!=null&&t.debug.drawRect(i,r,this.maxWidth,this.height,{color:kt.Yellow}))}}function Ul(c){return!!c.tick}class He extends ls{get visible(){return this.isVisible}set visible(t){this.isVisible=t}get offset(){return this._offset}set offset(t){this._offset=new Er(t,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(t){this._anchor=new Er(t,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(t){if(t){this._color=t.clone();const i=this.graphics.current;(i instanceof Vn||i instanceof zo)&&(i.color=this._color)}}constructor(t){super(),this._logger=$t.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new Er(rt.Zero,()=>this.recalculateBounds()),this._anchor=new Er(rt.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,t={visible:this.isVisible,graphics:{},...t};const{current:i,anchor:r,color:o,opacity:h,visible:u,graphics:_,offset:A,copyGraphics:y,onPreDraw:w,onPostDraw:f,onPreTransformDraw:T,onPostTransformDraw:C}=t;for(const[S,E]of Object.entries(_))E instanceof Oe?this._graphics[S]=E:(this._graphics[S]=E.graphic,this._options[S]=E.options);this.offset=A??this.offset,this.opacity=h??this.opacity,this.anchor=r??this.anchor,this.color=o??this.color,this.copyGraphics=y??this.copyGraphics,this.onPreDraw=w??this.onPreDraw,this.onPostDraw=f??this.onPostDraw,this.onPreDraw=T??this.onPreTransformDraw,this.onPostTransformDraw=C??this.onPostTransformDraw,this.isVisible=!!u,this._current=i??this._current,i&&this._graphics[i]&&this.use(i)}getGraphic(t){return this._graphics[t]}getOptions(t){return this._options[t]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(t,i,r){let o="default",h=null,u;if(typeof t=="string"&&i instanceof Oe&&(o=t,h=i,u=r),t instanceof Oe&&!(i instanceof Oe)&&(h=t,u=i),!h)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[o]=this.copyGraphics?h.clone():h,this._options[o]=this.copyGraphics?{...u}:u,o==="default"&&this.use("default"),h}remove(t){delete this._graphics[t],delete this._options[t],this._current===t&&(this._current="default",this.recalculateBounds())}use(t,i){var r;if(t instanceof Oe){let o=t;this.copyGraphics&&(o=t.clone()),this._current="default",this._graphics[this._current]=o,this._options[this._current]=i}else this._current=t,this._options[this._current]=i,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(r=this.owner)===null||r===void 0?void 0:r.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(t){this._localBounds=t}recalculateBounds(){let t=new Zt;const i=this._graphics[this._current],r=this._options[this._current];if(!i){this._localBounds=t;return}let o=this.anchor,h=this.offset;r!=null&&r.anchor&&(o=r.anchor),r!=null&&r.offset&&(h=r.offset);const u=i.localBounds,_=-u.width*o.x+h.x,A=-u.height*o.y+h.y;i instanceof zn&&!i.useAnchor?t=i==null?void 0:i.localBounds.combine(t):t=i==null?void 0:i.localBounds.translate(ft(_,A)).combine(t),this._localBounds=t}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let t=this.localBounds;if(this.owner){const i=this.owner.get(qt);i&&(t=t.transform(i.get().matrix))}return t}update(t,i=0){const r=this.current;r&&Ul(r)&&r.tick(t,i)}clone(){const t=new He;return t._graphics={...this._graphics},t._options={...this._options},t.offset=this.offset.clone(),this.color&&(t.color=this.color.clone()),t.opacity=this.opacity,t.anchor=this.anchor.clone(),t.copyGraphics=this.copyGraphics,t.onPreDraw=this.onPreDraw,t.onPostDraw=this.onPostDraw,t.isVisible=this.isVisible,t}}var La;(function(c){c.Kill="kill",c.PreKill="prekill",c.PostKill="postkill",c.PreDraw="predraw",c.PostDraw="postdraw",c.PreDebugDraw="predebugdraw",c.PostDebugDraw="postdebugdraw",c.PreUpdate="preupdate",c.PostUpdate="postupdate",c.PreFrame="preframe",c.PostFrame="postframe",c.PreCollision="precollision",c.CollisionStart="collisionstart",c.CollisionEnd="collisionend",c.PostCollision="postcollision",c.Initialize="initialize",c.Activate="activate",c.Deactivate="deactivate",c.ExitViewport="exitviewport",c.EnterViewport="enterviewport",c.ExitTrigger="exit",c.EnterTrigger="enter",c.Connect="connect",c.Disconnect="disconnect",c.Button="button",c.Axis="axis",c.Visible="visible",c.Hidden="hidden",c.Start="start",c.Stop="stop",c.PointerUp="pointerup",c.PointerDown="pointerdown",c.PointerMove="pointermove",c.PointerEnter="pointerenter",c.PointerLeave="pointerleave",c.PointerCancel="pointercancel",c.PointerWheel="pointerwheel",c.Up="up",c.Down="down",c.Move="move",c.Enter="enter",c.Leave="leave",c.Cancel="cancel",c.Wheel="wheel",c.Press="press",c.Release="release",c.Hold="hold",c.PointerDragStart="pointerdragstart",c.PointerDragEnd="pointerdragend",c.PointerDragEnter="pointerdragenter",c.PointerDragLeave="pointerdragleave",c.PointerDragMove="pointerdragmove",c.ActionStart="actionstart",c.ActionComplete="actioncomplete",c.Add="add",c.Remove="remove"})(La||(La={}));class le{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(t){this._bubbles=t}stopPropagation(){this.bubbles=!1}}class Ya extends le{constructor(t){super(),this.self=t,this.target=t}}class Nl extends le{constructor(t){super(),this.self=t,this.target=t}}class Gl extends le{constructor(t){super(),this.self=t,this.target=t}}class Ol extends le{constructor(t){super(),this.self=t,this.target=t}}class Hl extends le{constructor(t){super(),this.self=t,this.target=t}}class jn extends le{constructor(t,i,r){super(),this.ctx=t,this.elapsed=i,this.self=r,this.target=r}}class Yn extends le{constructor(t,i,r){super(),this.ctx=t,this.elapsed=i,this.self=r,this.target=r}}class Wl extends le{constructor(t,i,r){super(),this.ctx=t,this.elapsed=i,this.self=r,this.target=r}}class ql extends le{constructor(t,i,r){super(),this.ctx=t,this.elapsed=i,this.self=r,this.target=r}}class Vl extends le{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class jl extends le{constructor(t,i){super(),this.ctx=t,this.self=i,this.target=i}}class Sr extends le{constructor(t,i,r){super(),this.engine=t,this.elapsed=i,this.self=r,this.target=r}}class Pr extends le{constructor(t,i,r){super(),this.engine=t,this.elapsed=i,this.self=r,this.target=r}}class Yl extends le{constructor(t,i){super(),this.engine=t,this.prevStats=i,this.target=t}}class Xl extends le{constructor(t,i){super(),this.engine=t,this.stats=i,this.target=t}}class Zl extends le{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class $l extends le{constructor(t,i){super(),this.index=t,this.gamepad=i,this.target=i}}class Jl extends le{constructor(t,i,r){super(),this.button=t,this.value=i,this.self=r,this.target=r}}class Kl extends le{constructor(t,i,r){super(),this.axis=t,this.value=i,this.self=r,this.target=r}}class tc extends le{constructor(t){super(),this.self=t,this.target=t}}class ec extends le{constructor(t){super(),this.self=t,this.target=t}}class un extends le{constructor(t,i,r,o,h){super(),this.self=t,this.other=i,this.side=r,this.intersection=o,this.contact=h,this.target=t}}class gn extends le{constructor(t,i,r,o,h){super(),this.self=t,this.other=i,this.side=r,this.intersection=o,this.contact=h,this.target=t}}class za{constructor(t,i,r,o){this.self=t,this.other=i,this.side=r,this.contact=o}}class Ua{constructor(t,i,r,o){this.self=t,this.other=i,this.side=r,this.lastContact=o}}class Na{constructor(t,i,r,o,h){this.self=t,this.other=i,this.side=r,this.intersection=o,this.contact=h}}class Ga{constructor(t,i,r,o,h){this.self=t,this.other=i,this.side=r,this.intersection=o,this.contact=h}}class xo extends le{constructor(t,i,r,o){super(),this.self=t,this.other=i,this.side=r,this.contact=o,this.target=t}}class bo extends le{constructor(t,i,r,o){super(),this.self=t,this.other=i,this.side=r,this.lastContact=o,this.target=t}}class Xn extends le{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class ic extends le{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class sc extends le{constructor(t,i){super(),this.context=t,this.self=i,this.target=i}}class rc extends le{constructor(t){super(),this.self=t,this.target=t}}class nc extends le{constructor(t){super(),this.self=t,this.target=t}}class oc extends le{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class ac extends le{constructor(t,i){super(),this.self=t,this.entity=i,this.target=t}}class hc extends le{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class lc extends le{constructor(t,i){super(),this.action=t,this.self=i,this.target=i}}class cc extends le{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class dc extends le{constructor(t,i){super(),this.engine=t,this.self=i,this.target=i}}class Ap{constructor(t){this.data=t,this.type="Component Added"}}function mp(c){return!!c&&c.type==="Component Added"}class vp{constructor(t){this.data=t,this.type="Component Removed"}}function wp(c){return!!c&&c.type==="Component Removed"}const yp={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Di{constructor(t,i){this.id=Di._ID++,this.name=`Entity#${this.id}`,this.events=new Ue,this._tags=new Set,this.componentAdded$=new zi,this.componentRemoved$=new zi,this.tagAdded$=new zi,this.tagRemoved$=new zi,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new zi,this.childrenRemoved$=new zi,this._children=[],this._isInitialized=!1,this._isAdded=!1;let r,o;if(Array.isArray(t))r=t,o=i;else if(t&&typeof t=="object"){const{components:h,name:u,silenceWarnings:_}=t;r=h??[],o=u}if(o&&(this.name=o),r)for(const h of r)this.addComponent(h)}get active(){return this.isActive}set active(t){this.isActive=t}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Ya(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(t){return this._tags.has(t)}addTag(t){return this._tags.add(t),this.tagAdded$.notifyAll(t),this}removeTag(t){return this._tags.delete(t),this.tagRemoved$.notifyAll(t),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(t){for(let i=0;i<t.length;i++)if(!this.components.has(t[i]))return!1;return!0}hasAllTags(t){for(let i=0;i<t.length;i++)if(!this.tags.has(t[i]))return!1;return!0}get(t){return this.components.get(t)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(t){if(t.parent===null){if(this.getAncestors().includes(t))throw new Error("Cycle detected, cannot add entity");this._children.push(t),t._parent=this,this.childrenAdded$.notifyAll(t)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(t){return t.parent===this&&(Wn(t,this._children),t._parent=null,this.childrenRemoved$.notifyAll(t)),this}removeAllChildren(){for(let t=this.children.length-1;t>=0;t--)this.removeChild(this.children[t]);return this}getAncestors(){const t=[this];let i=this.parent;for(;i;)t.push(i),i=i.parent;return t.reverse()}getDescendants(){let t=[this],i=[this];for(;i.length>0;){const r=i.pop();r&&(i=i.concat(r.children),t=t.concat(r.children))}return t}clone(){const t=new Di;for(const i of this.types){const r=this.get(i);r&&t.addComponent(r.clone())}for(const i of this.children)t.addChild(i.clone());return t}addTemplate(t,i=!1){for(const r of t.getComponents())this.addComponent(r.clone(),i);for(const r of t.children)this.addChild(r.clone().addTemplate(r));return this}_getClassHierarchyRoot(t){var i,r;let o=t,h=(i=Object.getPrototypeOf(o.prototype))===null||i===void 0?void 0:i.constructor;for(;h&&h!==Object&&h!==ls;)o=h,h=(r=Object.getPrototypeOf(o.prototype))===null||r===void 0?void 0:r.constructor;return o}addComponent(t,i=!1){if(this.has(t.constructor))if(i)this.removeComponent(t.constructor,!0);else return this;if(t.dependencies&&t.dependencies.length)for(const o of t.dependencies)this.addComponent(new o);t.owner=this;const r=this._getClassHierarchyRoot(t.constructor);return this.components.set(r,t),this.components.set(t.constructor,t),this.componentValues.push(t),t.onAdd&&t.onAdd(this),this.componentAdded$.notifyAll(t),this}removeComponent(t,i=!1){let r;if(Ou(t)?r=t:r=t.constructor,i){const o=this.components.get(r);if(o){this.componentRemoved$.notifyAll(o),o.owner=void 0,o.onRemove&&o.onRemove(this);const u=this.componentValues.indexOf(o);u>-1&&this.componentValues.splice(u,1)}const h=this._getClassHierarchyRoot(r);this.components.delete(h),this.components.delete(r)}else this._componentsToRemove.push(r);return this}clearComponents(){const t=this.types;for(const i of t)this.removeComponent(i)}processComponentRemoval(){for(const t of this._componentsToRemove)this.removeComponent(t,!0);this._componentsToRemove.length=0}has(t){return this.components.has(t)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(t){this.isInitialized||(this.onInitialize(t),this.events.emit("initialize",new Xn(t,this)),this._isInitialized=!0)}_add(t){!this.isAdded&&this.isActive&&(this.onAdd(t),this.events.emit("add",new cc(t,this)),this._isAdded=!0)}_remove(t){this.isAdded&&!this.isActive&&(this.onRemove(t),this.events.emit("remove",new dc(t,this)),this._isAdded=!1)}_preupdate(t,i){this.events.emit("preupdate",new Sr(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new Pr(t,i,this)),this.onPostUpdate(t,i)}onInitialize(t){}onAdd(t){}onRemove(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i);for(const r of this.children)r.update(t,i);this._postupdate(t,i),this._remove(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}Di._ID=0;class we extends ls{constructor(){super(...arguments),this.vel=rt.Zero,this.acc=rt.Zero,this.scaleFactor=rt.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class Li{static integrate(t,i,r,o){const h=o/1e3;i.vel.addEqual(r.scale(h,Li._ACC)),t.pos.add(i.vel.scale(h,Li._VEL),Li._POS).addEqual(r.scale(.5*h*h,Li._VEL_ACC)),i.angularVelocity+=i.torque*(1/i.inertia)*h;const u=t.rotation+i.angularVelocity*h;t.scale.add(i.scaleFactor.scale(h,this._SCALE_FACTOR),Li._SCALE),t.get().setTransform(Li._POS,u,Li._SCALE)}}Li._POS=new rt(0,0);Li._SCALE=new rt(1,1);Li._ACC=new rt(0,0);Li._VEL=new rt(0,0);Li._VEL_ACC=new rt(0,0);Li._SCALE_FACTOR=new rt(0,0);class Xa extends Di{constructor(t){super({silenceWarnings:!0}),this.beginColor=kt.White,this.endColor=kt.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=kt.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=Cs.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new qt),this.addComponent(this.motion=new we),this.addComponent(this.graphics=new He),this.configure(t)}registerEmitter(t){if(this._emitter=t,this.particleTransform===Cs.Global){const i=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(i),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(t){var i,r,o,h,u,_,A,y,w,f,T,C,S,E;this.particleTransform=(i=t.transform)!==null&&i!==void 0?i:this.particleTransform,this.life=(r=t.life)!==null&&r!==void 0?r:this.life,this.fade=(o=t.fade)!==null&&o!==void 0?o:this.fade,this.size=(h=t.size)!==null&&h!==void 0?h:this.size,this.endColor=(u=t.endColor)!==null&&u!==void 0?u:this.endColor.clone(),this.beginColor=(_=t.beginColor)!==null&&_!==void 0?_:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=t.graphic,this.graphics.opacity=(A=t.opacity)!==null&&A!==void 0?A:this.graphics.opacity,this.transform.pos=(y=t.pos)!==null&&y!==void 0?y:this.transform.pos,this.transform.rotation=(w=t.rotation)!==null&&w!==void 0?w:0,this.transform.scale=ft(1,1),this.motion.vel=(f=t.vel)!==null&&f!==void 0?f:this.motion.vel,this.motion.angularVelocity=(T=t.angularVelocity)!==null&&T!==void 0?T:0,this.motion.acc=(C=t.acc)!==null&&C!==void 0?C:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(S=t.startSize)!==null&&S!==void 0?S:0,this.endSize=(E=t.endSize)!==null&&E!==void 0?E:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=Zt.fromDimension(this.size,this.size,rt.Half),this.graphics.onPostDraw=W=>{W.save(),W.debug.drawPoint(ft(0,0),{color:this._currentColor,size:this.size}),W.restore()})}kill(){var t;!((t=this._emitter)===null||t===void 0)&&t.isActive?this._emitter.removeParticle(this):super.kill()}update(t,i){this.life=this.life-i,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=ce(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=ce(this.sizeRate*i+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=ce(this._currentColor.r+this._rRate*i,0,255),this._currentColor.g=ce(this._currentColor.g+this._gRate*i,0,255),this._currentColor.b=ce(this._currentColor.b+this._bRate*i,0,255),this._currentColor.a=this.graphics.opacity;let r=this.motion.acc;this.focus&&(r=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(i/1e3)),Li.integrate(this.transform,this.motion,r,i)}}Xa.DefaultConfig={beginColor:kt.White,endColor:kt.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var Cs;(function(c){c.Global="global",c.Local="local"})(Cs||(Cs={}));class Hu{constructor(){this.type="ex.particle",this.priority=0}initialize(t,i){this._gl=t,this._context=i,this._shader=new Yi({gl:t,vertexSource:cp,fragmentSource:dp,onPreLink:r=>{t.transformFeedbackVaryings(r,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],t.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(t){const i=t.getAttribute(me.Filtering),r=i?qn(i):void 0,o=bs(t.getAttribute(me.WrappingX)),h=bs(t.getAttribute(me.WrappingY)),u=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:r,wrapping:{x:o,y:h}},u);return t.removeAttribute("forceUpload"),_}draw(t,i){var r,o,h,u,_,A,y,w,f;const T=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const C=t.particle.transform===Cs.Local?this._context.getTransform():this._context.getTransform().multiply(t.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",C),this._shader.setUniformBoolean("fade",!!t.particle.fade),this._shader.setUniformBoolean("useTexture",!!t.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(r=t.particle.life)!==null&&r!==void 0?r:2e3),this._shader.setUniformFloat("deltaMs",i),this._shader.setUniformFloatVector("gravity",(o=t.particle.acc)!==null&&o!==void 0?o:ft(0,0)),this._shader.setUniformFloatColor("beginColor",(h=t.particle.beginColor)!==null&&h!==void 0?h:kt.Transparent),this._shader.setUniformFloatColor("endColor",(u=t.particle.endColor)!==null&&u!==void 0?u:kt.Transparent);let S=(_=t.particle.startSize)!==null&&_!==void 0?_:0,E=(A=t.particle.endSize)!==null&&A!==void 0?A:0;const W=(y=t.particle.size)!==null&&y!==void 0?y:0;if(W>0&&(S=W,E=W),this._shader.setUniformFloat("startSize",S??10),this._shader.setUniformFloat("endSize",E??10),this._shader.setUniformFloat("startOpacity",(w=t.particle.opacity)!==null&&w!==void 0?w:1),t.particle.focus&&(this._shader.setUniformFloatVector("focus",t.particle.focus),this._shader.setUniformFloat("focusAccel",(f=t.particle.focusAccel)!==null&&f!==void 0?f:0)),t.particle.graphic){const D=t.particle.graphic,H=this._getTexture(D.image.image);T.activeTexture(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,H),this._shader.setUniformInt("graphic",0)}t.draw(T)}hasPendingDraws(){return!1}flush(){}dispose(){}}const xp=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;\r
  uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, uv.x);\r
  uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, uv.y);\r
\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,bp=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_siz)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class Cp{constructor(t){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=kt.White,this.pixelArtSampler=t.pixelArtSampler,this.uvPadding=t.uvPadding}initialize(t,i){this._gl=t,this._context=i;const r=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),o=zl(t,r);this._maxTextures=Math.min(r,o);const h=this._transformFragmentSource(xp,this._maxTextures);this._shader=new Yi({gl:t,fragmentSource:h,vertexSource:bp}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",i.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((f,T)=>T)),this._vao=t.createVertexArray(),t.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._meshBuffer),t.bufferData(t.ARRAY_BUFFER,this._quadMesh,t.STATIC_DRAW),t.vertexAttribPointer(0,2,t.FLOAT,!1,16,0),t.enableVertexAttribArray(0),t.vertexAttribPointer(1,2,t.FLOAT,!1,16,8),t.enableVertexAttribArray(1),t.bindBuffer(t.ARRAY_BUFFER,null);const u=this._components;this._transformData=new Us({gl:t,size:u*this._maxImages,type:"dynamic"}),this._transformData.bind();let _=0,A=2;const y=4,w=u*4;t.vertexAttribPointer(A++,2,t.FLOAT,!1,w,_),t.enableVertexAttribArray(2),_+=2*y,t.vertexAttribPointer(A++,2,t.FLOAT,!1,w,_),t.enableVertexAttribArray(3),_+=2*y,t.vertexAttribPointer(A++,2,t.FLOAT,!1,w,_),t.enableVertexAttribArray(4),_+=2*y,t.vertexAttribPointer(A++,2,t.FLOAT,!1,w,_),t.enableVertexAttribArray(5),_+=2*y,t.vertexAttribPointer(A++,1,t.FLOAT,!1,w,_),t.enableVertexAttribArray(6),_+=1*y,t.vertexAttribPointer(A++,2,t.FLOAT,!1,w,_),t.enableVertexAttribArray(7),_+=2*y,t.vertexAttribPointer(A++,2,t.FLOAT,!1,w,_),t.enableVertexAttribArray(8),_+=2*y,t.vertexAttribPointer(A++,1,t.FLOAT,!1,w,_),t.enableVertexAttribArray(9),_+=1*y,t.vertexAttribPointer(A++,2,t.FLOAT,!1,w,_),t.enableVertexAttribArray(10),_+=2*y,t.vertexAttribPointer(A++,2,t.FLOAT,!1,w,_),t.enableVertexAttribArray(11),_+=2*y,t.vertexAttribPointer(A++,4,t.FLOAT,!1,w,_),t.enableVertexAttribArray(12),_+=4*y,t.vertexAttribDivisor(2,1),t.vertexAttribDivisor(3,1),t.vertexAttribDivisor(4,1),t.vertexAttribDivisor(5,1),t.vertexAttribDivisor(6,1),t.vertexAttribDivisor(7,1),t.vertexAttribDivisor(8,1),t.vertexAttribDivisor(9,1),t.vertexAttribDivisor(10,1),t.vertexAttribDivisor(11,1),t.vertexAttribDivisor(12,1),t.bindVertexArray(null)}_bindData(t){const i=this._components;this._transformData.bind(),this._transformData.upload(i*this._imageCount),t.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(t,i){let r=t.replace("%%count%%",i.toString()),o="";for(let h=0;h<i;h++)h===0?o+=`if (v_texture_index <= ${h}.5) {
`:o+=`   else if (v_texture_index <= ${h}.5) {
`,o+=`      color = texture(u_textures[${h}], uv);
`,o+=`   }
`;return r=r.replace("%%texture_picker%%",o),r}_addImageAsTexture(t){if(this._images.has(t))return;const i=t.getAttribute(me.Filtering),r=i?qn(i):void 0,o=bs(t.getAttribute(me.WrappingX)),h=bs(t.getAttribute(me.WrappingY)),u=t.getAttribute("forceUpload")==="true",_=this._context.textureLoader.load(t,{filtering:r,wrapping:{x:o,y:h}},u);t.removeAttribute("forceUpload"),this._textures.indexOf(_)===-1&&(this._textures.push(_),this._textureToIndex.set(_,this._textureIndex++),this._images.add(t))}_bindTextures(t){const i=Math.min(this._textureIndex,this._maxTextures);for(let r=0;r<i;r++)t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,this._textures[r]||this._textures[0])}_getTextureIdForImage(t){var i;if(t){const r=this._context.textureLoader.get(t);return(i=this._textureToIndex.get(r))!==null&&i!==void 0?i:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}draw(t,i,r,o,h,u,_,A,y){var w,f,T,C;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(t);const S=this._getImageWidth(t),E=this._getImageHeight(t);let W=S||o||0,D=E||h||0;this._view[0]=0,this._view[1]=0,this._view[2]=(w=o??S)!==null&&w!==void 0?w:0,this._view[3]=(f=h??E)!==null&&f!==void 0?f:0,this._dest[0]=i??1,this._dest[1]=r??1,u!==void 0&&_!==void 0&&A!==void 0&&y!==void 0&&(this._view[0]=i??1,this._view[1]=r??1,this._view[2]=(T=o??S)!==null&&T!==void 0?T:0,this._view[3]=(C=h??E)!==null&&C!==void 0?C:0,this._dest[0]=u,this._dest[1]=_,W=A,D=y),i=this._view[0],r=this._view[1];const H=this._view[2],k=this._view[3],N=this._context.getTransform(),Q=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+ae),this._dest[1]=~~(this._dest[1]+ae));const O=this._context.tint||this._defaultTint,Y=this._getTextureIdForImage(t),ot=S||W,nt=E||D,et=(i+this.uvPadding)/ot,ut=(r+this.uvPadding)/nt,Z=(i+H-this.uvPadding)/ot,I=(r+k-this.uvPadding)/nt,R=S,q=E,tt=this._transformData.bufferData;tt[this._vertexIndex++]=this._dest[0],tt[this._vertexIndex++]=this._dest[1],tt[this._vertexIndex++]=N.data[0],tt[this._vertexIndex++]=N.data[1],tt[this._vertexIndex++]=N.data[2],tt[this._vertexIndex++]=N.data[3],tt[this._vertexIndex++]=N.data[4],tt[this._vertexIndex++]=N.data[5],tt[this._vertexIndex++]=Q,tt[this._vertexIndex++]=W,tt[this._vertexIndex++]=D,tt[this._vertexIndex++]=R,tt[this._vertexIndex++]=q,tt[this._vertexIndex++]=Y,tt[this._vertexIndex++]=et,tt[this._vertexIndex++]=ut,tt[this._vertexIndex++]=Z,tt[this._vertexIndex++]=I,tt[this._vertexIndex++]=O.r/255,tt[this._vertexIndex++]=O.g/255,tt[this._vertexIndex++]=O.b/255,tt[this._vertexIndex++]=O.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const t=this._gl;this._shader.use(),this._bindData(t),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(t),t.drawArraysInstanced(t.TRIANGLES,0,6,this._imageCount),ze.DrawnImagesCount+=this._imageCount,ze.DrawCallCount++,t.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const ae=1e-4;class Ep{constructor(t){this._webglCtx=t,this._debugText=new Ll}drawRect(t,i,r,o,h={color:kt.Black}){this.drawLine(ft(t,i),ft(t+r,i),{...h}),this.drawLine(ft(t+r,i),ft(t+r,i+o),{...h}),this.drawLine(ft(t+r,i+o),ft(t,i+o),{...h}),this.drawLine(ft(t,i+o),ft(t,i),{...h})}drawLine(t,i,r){var o;this._webglCtx.draw("ex.line",t,i,(o=r==null?void 0:r.color)!==null&&o!==void 0?o:kt.Black)}drawPoint(t,i={color:kt.Black,size:5}){this._webglCtx.draw("ex.point",t,i.color,i.size)}drawText(t,i){this._debugText.write(this._webglCtx,t,i)}}class ir{get z(){return this._state.current.z}set z(t){this._state.current.z=t}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(t){let i=!0;return(t.width>4096||t.height>4096)&&(i=!1),i}constructor(t){this._logger=$t.getInstance(),this._renderers=new Map,this.imageRenderer=vi.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new ja(()=>new hp,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new z_,this._state=new ku,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=kt.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new Ep(this),this._totalPostProcessorTime=0;const{canvasElement:i,context:r,enableTransparency:o,antialiasing:h,uvPadding:u,multiSampleAntialiasing:_,pixelArtSampler:A,powerPreference:y,snapToPixel:w,backgroundColor:f,useDrawSorting:T,garbageCollector:C,handleContextLost:S,handleContextRestored:E}=t;if(this.__gl=r??i.getContext("webgl2",{antialias:h??this.smoothing,premultipliedAlpha:!1,alpha:o??this.transparency,depth:!1,powerPreference:y??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");S&&this.__gl.canvas.addEventListener("webglcontextlost",S,!1),E&&this.__gl.canvas.addEventListener("webglcontextrestored",E,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new Ne(this.__gl,C),this.snapToPixel=w??this.snapToPixel,this.smoothing=h??this.smoothing,this.transparency=o??this.transparency,this.pixelArtSampler=A??this.pixelArtSampler,this.uvPadding=u??this.uvPadding,this.multiSampleAntialiasing=typeof _=="boolean"?_:this.multiSampleAntialiasing,this.samples=typeof _=="object"?_.samples:void 0,this.backgroundColor=f??this.backgroundColor,this.useDrawSorting=T??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const t of this._renderers.values())t.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const t=this.__gl;if(this._ortho=Ki.ortho(0,t.canvas.width,t.canvas.height,0,400,-400),t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.depthMask(!1),this.register(new ep({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new Au),this.register(new rp),this.register(new ap),this.register(new X_),this.register(new V_),this.register(new Hu),this.register(new Cp({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=t.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");t.bindTexture(t.TEXTURE_2D,this.materialScreenTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),this._screenRenderer=new J_(t),this._renderTarget=new Ca({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),this._postProcessTargets=[new Ca({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height}),new Ca({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height})],this._msaaTarget=new Ca({gl:t,transparency:this.transparency,width:t.canvas.width,height:t.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(t){this._renderers.set(t.type,t),t.initialize(this.__gl,this)}get(t){return this._renderers.get(t)}_isCurrentRenderer(t){return!this._currentRenderer||this._currentRenderer===t}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(t,...i){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${t}, the webgl context is lost`);return}const r=this._renderers.get(t);if(r)if(this.useDrawSorting){const o=this._drawCallPool.get();o.z=this._state.current.z,o.priority=r.priority,o.renderer=t,this.getTransform().clone(o.transform),o.state.z=this._state.current.z,o.state.opacity=this._state.current.opacity,o.state.tint=this._state.current.tint,o.state.material=this._state.current.material,o.args[0]=i[0],o.args[1]=i[1],o.args[2]=i[2],o.args[3]=i[3],o.args[4]=i[4],o.args[5]=i[5],o.args[6]=i[6],o.args[7]=i[7],o.args[8]=i[8],o.args[9]=i[9],this._drawCalls[this._drawCallIndex++]=o}else this._currentRenderer||(this._currentRenderer=r),this._isCurrentRenderer(r)||this._currentRenderer.flush(),r.draw(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9]),this._currentRenderer=r;else throw Error(`No renderer with name ${t} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(t){const i=this.__gl;this._ortho=this._ortho=Ki.ortho(0,t.width,t.height,0,400,-400),this._renderTarget.setResolution(i.canvas.width,i.canvas.height),this._msaaTarget.setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[0].setResolution(i.canvas.width,i.canvas.height),this._postProcessTargets[1].setResolution(i.canvas.width,i.canvas.height)}_getImageWidth(t){let i=this._imageToWidth.get(t);return i===void 0&&(i=t.width,this._imageToWidth.set(t,i)),i}_getImageHeight(t){let i=this._imageToHeight.get(t);return i===void 0&&(i=t.height,this._imageToHeight.set(t,i)),i}drawImage(t,i,r,o,h,u,_,A,y){if(!(o===0||h===0)){{if(A===0||y===0)return;if(this._getImageWidth(t)===0||this._getImageHeight(t)===0)return}if(!t){$t.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",t,i,r,o,h,u,_,A,y):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,t,i,r,o,h,u,_,A,y):this.draw(this.imageRenderer,t,i,r,o,h,u,_,A,y)}}drawLine(t,i,r,o=1){this.draw("ex.rectangle",t,i,r,o)}drawRectangle(t,i,r,o,h,u){this.draw("ex.rectangle",t,i,r,o,h,u)}drawCircle(t,i,r,o,h){this.draw("ex.circle",t,i,r,o,h)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(t,i){this._transform.translate(this.snapToPixel?~~(t+ae):t,this.snapToPixel?~~(i+ae):i)}rotate(t){this._transform.rotate(t)}scale(t,i){this._transform.scale(t,i)}transform(t){this._transform.current=t}getTransform(){return this._transform.current}multiply(t){this._transform.current.multiply(t,this._transform.current)}addPostProcessor(t){this._postprocessors.push(t),t.initialize(this.__gl)}removePostProcessor(t){const i=this._postprocessors.indexOf(t);i!==-1&&this._postprocessors.splice(i,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(t){for(const i of this._postprocessors){const r=i.getShader();r.use();const o=r.getUniforms();this._totalPostProcessorTime+=t,o.find(h=>h.name==="u_time_ms")&&r.setUniformFloat("u_time_ms",this._totalPostProcessorTime),o.find(h=>h.name==="u_elapsed_ms")&&r.setUniformFloat("u_elapsed_ms",t),o.find(h=>h.name==="u_resolution")&&r.setUniformFloatVector("u_resolution",ft(this.width,this.height)),i.onUpdate&&i.onUpdate(t)}}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return new Gu({...t,graphicsContext:this})}createShader(t){const i=this.__gl,{vertexSource:r,fragmentSource:o}=t,h=new Yi({gl:i,vertexSource:r,fragmentSource:o});return h.compile(),h}clear(){const t=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),t.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),t.clear(t.COLOR_BUFFER_BIT)}flush(){var t;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let i=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(i.use(),this.useDrawSorting){for(let u=this._drawCallIndex;u<this._drawCalls.length;u++)this._drawCalls[u]=null;const r=new Map;for(const[u]of this._renderers){let _=0;for(_=0;_<this._drawCallIndex&&this._drawCalls[_].renderer!==u;_++);r.set(u,_)}this._drawCalls.sort((u,_)=>{if(u===null||_===null)return 0;const A=u.z-_.z,y=r.get(u.renderer)-r.get(_.renderer),w=u.priority-_.priority;return A===0?w===0?y:w:A});const o=this._transform.current,h=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let u=this._drawCalls[0].renderer,_=this._renderers.get(u);for(let A=0;A<this._drawCallIndex;A++)this._transform.current=this._drawCalls[A].transform,this._state.current=this._drawCalls[A].state,this._drawCalls[A].renderer!==u&&(_.flush(),u=this._drawCalls[A].renderer,_=this._renderers.get(u)),_ instanceof Au&&(!((t=this.material)===null||t===void 0)&&t.isUsingScreenTexture)&&(i.copyToTexture(this.materialScreenTexture),i.use()),_.draw(...this._drawCalls[A].args);_.hasPendingDraws()&&_.flush()}this._transform.current=o,this._state.current=h,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const r of this._renderers.values())r.hasPendingDraws()&&r.flush();i.disable(),this._postprocessors.length>0&&i.toRenderSource().use();for(let r=0;r<this._postprocessors.length;r++)i=this._postProcessTargets[r%2],this._postProcessTargets[r%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[r]),this._postProcessTargets[r%2].toRenderSource().use();i.blitToScreen()}}const Ye=1e-4;class Ip{constructor(t){this._ex=t,this._debugText=new Ll}drawRect(t,i,r,o){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(t+Ye):t,this._ex.snapToPixel?~~(i+Ye):i,this._ex.snapToPixel?~~(r+Ye):r,this._ex.snapToPixel?~~(o+Ye):o),this._ex.__ctx.restore()}drawLine(t,i,r={color:kt.Black}){var o,h;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(h=(o=r.color)===null||o===void 0?void 0:o.toString())!==null&&h!==void 0?h:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(t.x+Ye):t.x,this._ex.snapToPixel?~~(t.y+Ye):t.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(i.x+Ye):i.x,this._ex.snapToPixel?~~(i.y+Ye):i.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(t,i={color:kt.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=i.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(t.x+Ye):t.x,this._ex.snapToPixel?~~(t.y+Ye):t.y,i.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(t,i){this._debugText.write(this._ex,t,i)}}class Oa{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(t){this._state.current.opacity=t}get tint(){return this._state.current.tint}set tint(t){this._state.current.tint=t}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(t){this.__ctx.imageSmoothingEnabled=t}constructor(t){this.useDrawSorting=!1,this.z=0,this.backgroundColor=kt.ExcaliburBlue,this._state=new ku,this.snapToPixel=!1,this.debug=new Ip(this);const{canvasElement:i,context:r,enableTransparency:o,snapToPixel:h,antialiasing:u,backgroundColor:_}=t;if(this.__ctx=r??i.getContext("2d",{alpha:o??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=_??this.backgroundColor,this.snapToPixel=h??this.snapToPixel,this.smoothing=u??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(t){}drawImage(t,i,r,o,h,u,_,A,y){if(o===0||h===0)return;if(A===0||y===0)return;if(t.width===0||t.height===0)return;this.__ctx.globalAlpha=this.opacity;const w=[t,i,r,o,h,u,_,A,y].filter(f=>f!==void 0).map(f=>typeof f=="number"&&this.snapToPixel?~~f:f);this.__ctx.drawImage.apply(this.__ctx,w),ze.DrawCallCount++,ze.DrawnImagesCount=1}drawLine(t,i,r,o=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=r.toString(),this.__ctx.moveTo(this.snapToPixel?~~(t.x+Ye):t.x,this.snapToPixel?~~(t.y+Ye):t.y),this.__ctx.lineTo(this.snapToPixel?~~(i.x+Ye):i.x,this.snapToPixel?~~(i.y+Ye):i.y),this.__ctx.lineWidth=o,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(t,i,r,o){this.__ctx.save(),this.__ctx.fillStyle=o.toString(),this.__ctx.fillRect(this.snapToPixel?~~(t.x+Ye):t.x,this.snapToPixel?~~(t.y+Ye):t.y,this.snapToPixel?~~(i+Ye):i,this.snapToPixel?~~(r+Ye):r),this.__ctx.restore()}drawCircle(t,i,r,o,h){this.__ctx.save(),this.__ctx.beginPath(),o&&(this.__ctx.strokeStyle=o.toString()),h&&(this.__ctx.lineWidth=h),this.__ctx.fillStyle=r.toString(),this.__ctx.arc(this.snapToPixel?~~(t.x+Ye):t.x,this.snapToPixel?~~(t.y+Ye):t.y,i,0,Math.PI*2),this.__ctx.fill(),o&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(t,i){this.__ctx.translate(this.snapToPixel?~~(t+Ye):t,this.snapToPixel?~~(i+Ye):i)}rotate(t){this.__ctx.rotate(t)}scale(t,i){this.__ctx.scale(t,i)}getTransform(){throw new Error("Not implemented")}multiply(t){this.__ctx.setTransform(this.__ctx.getTransform().multiply(t.toDOMMatrix()))}addPostProcessor(t){}removePostProcessor(t){}clearPostProcessors(){}updatePostProcessors(t){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(t){this._state.current.material=t}get material(){return this._state.current.material}createMaterial(t){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),ze.clear()}flush(){}dispose(){this.__ctx=void 0}}var ui;(function(c){c.Fixed="Fixed",c.FitContainerAndFill="FitContainerAndFill",c.FitScreenAndFill="FitScreenAndFill",c.FitContainerAndZoom="FitContainerAndZoom",c.FitScreenAndZoom="FitScreenAndZoom",c.FitScreen="FitScreen",c.FillScreen="FillScreen",c.FitContainer="FitContainer",c.FillContainer="FillContainer"})(ui||(ui={}));class Al{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const Bp={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class ml{constructor(t){var i,r,o,h;this.events=new Ue,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=$t.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullScreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const u=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(u),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new Zt,this._unsafeArea=new Zt,this.viewport=t.viewport,this.resolution=(i=t.resolution)!==null&&i!==void 0?i:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(r=t.displayMode)!==null&&r!==void 0?r:ui.Fixed,this._canvas=t.canvas,this.graphicsContext=t.context,this._antialiasing=(o=t.antialiasing)!==null&&o!==void 0?o:this._antialiasing,this._canvasImageRendering=(h=t.canvasImageRendering)!==null&&h!==void 0?h:this._canvasImageRendering,this._browser=t.browser,this._pixelRatioOverride=t.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const t=this.worldToPageCoordinates(rt.Zero);return this.worldToPageCoordinates(ft(1,0)).sub(t).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(t){this._pixelRatioOverride=t}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case ui.FillContainer:case ui.FitContainer:case ui.FitContainerAndFill:case ui.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(t){this._resolution=t}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(t){this._viewport=t}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(t){this._camera=t}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof ir&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let o=Math.max(1,this.pixelRatio-.5),h=!1;for(;o>1&&!h;){o=Math.max(1,o-.5);const u=this._resolution.width*o,_=this._resolution.height*o;h=this.graphicsContext.checkIfResolutionSupported({width:u,height:_})}this.pixelRatioOverride=o,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const t=this.viewport.widthUnit==="percent"?"%":"px",i=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+t,this._canvas.style.height=this.viewport.height+i,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof Oa&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(t){this._antialiasing=t,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(t){return this.enterFullscreen(t)}enterFullscreen(t){if(t){const i=document.getElementById(t);if(i)return i.getAttribute("ex-fullscreen-listener")||(i.setAttribute("ex-fullscreen-listener","true"),i.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),i.requestFullscreen()}return this._canvas.requestFullscreen()}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(t){return{width:t.widthUnit==="percent"?this.canvas.offsetWidth:t.width,height:t.heightUnit==="percent"?this.canvas.offsetHeight:t.height}}pageToScreenCoordinates(t){let i=t.x,r=t.y;this._isFullscreen||(i-=mo(this._canvas).x,r-=mo(this._canvas).y);const o=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,u=(window.innerHeight-h)/2;r=(r-u)/h*o.height,i=i/window.innerWidth*o.width}else{const h=window.innerHeight*this.aspectRatio,u=(window.innerWidth-h)/2;i=(i-u)/h*o.width,r=r/window.innerHeight*o.height}return i=i/o.width*this.resolution.width,r=r/o.height*this.resolution.height,i=i-this.contentArea.left,r=r-this.contentArea.top,new rt(i,r)}screenToPageCoordinates(t){let i=t.x,r=t.y;const o=this._viewportToPixels(this.viewport);if(i=i/this.resolution.width*o.width,r=r/this.resolution.height*o.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const h=window.innerWidth/this.aspectRatio,u=(window.innerHeight-h)/2;r=r/o.height*h+u,i=i/o.width*window.innerWidth}else{const h=window.innerHeight*this.aspectRatio,u=(window.innerWidth-h)/2;i=i/o.width*h+u,r=r/o.height*window.innerHeight}return this._isFullscreen||(i+=mo(this._canvas).x,r+=mo(this._canvas).y),new rt(i,r)}screenToWorldCoordinates(t){return t=t.add(ft(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(t):t.sub(ft(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(t){return this._camera?this._camera.transform.multiply(t):t.add(ft(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(t){const i=this.pageToScreenCoordinates(t);return this.screenToWorldCoordinates(i)}worldToPageCoordinates(t){const i=this.worldToScreenCoordinates(t);return this.screenToPageCoordinates(i)}getWorldBounds(){return Zt.fromDimension(this.resolution.width,this.resolution.height,rt.Half).scale(ft(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return Zt.fromDimension(this.resolution.width,this.resolution.height,rt.Zero,rt.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return ft(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=this.aspectRatio;let i=0,r=0;window.innerWidth/t<window.innerHeight?(i=window.innerWidth,r=window.innerWidth/t):(i=window.innerHeight*t,r=window.innerHeight),this.viewport={width:i,height:r},this._contentArea=Zt.fromDimension(this.resolution.width,this.resolution.height,rt.Zero),this._unsafeArea=Zt.fromDimension(this.resolution.width,this.resolution.height,rt.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndFill(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(t,i,r){if(this.viewport=r??{width:t,height:i},t/i<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:t*this._contentResolution.width/t,height:t*this._contentResolution.width/t*i/t};const o=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new Zt({top:o,left:0,right:this._contentResolution.width,bottom:this.resolution.height-o}),this._unsafeArea=new Zt({top:-o,left:0,right:this._contentResolution.width,bottom:this.resolution.height+o})}else{this.resolution={width:i*this._contentResolution.height/i*t/i,height:i*this._contentResolution.height/i};const o=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new Zt({top:0,left:o,right:this.resolution.width-o,bottom:this._contentResolution.height}),this._unsafeArea=new Zt({top:0,left:-o,right:this.resolution.width+o,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const t=window.innerWidth,i=window.innerHeight;this._computeFitAndZoom(t,i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const t=this.canvas.parentElement;t.style.overflow="hidden";const{offsetWidth:i,offsetHeight:r}=this.canvas;this._computeFitAndZoom(i,r),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(t,i){const r=this.aspectRatio;let o=0,h=0;t/r<i?(o=t,h=t/r):(o=i*r,h=i);const u=t/o,_=i/h,A=Math.max(u,_),y=o*A,w=h*A;y>t?this.canvas.style.left=-(y-t)/2+"px":this.canvas.style.left="",w>i?this.canvas.style.top=-(w-i)/2+"px":this.canvas.style.top="",this.viewport={width:y,height:w};const f=Zt.fromDimension(this.viewport.width,this.viewport.height,rt.Zero);if(this.viewport.width>t){const T=(this.viewport.width-t)/this.viewport.width*this.resolution.width;f.top=0,f.left=T/2,f.right=this.resolution.width-T/2,f.bottom=this.resolution.height}if(this.viewport.height>i){const T=(this.viewport.height-i)/this.viewport.height*this.resolution.height;f.top=T/2,f.left=0,f.bottom=this.resolution.height-T/2,f.right=this.resolution.width}this._contentArea=f}_computeFitContainer(){const t=this.aspectRatio;let i=0,r=0,o="pixel",h="pixel";const u=this.canvas.parentElement;u.clientWidth/t<u.clientHeight?(this.canvas.style.width="100%",i=100,o="percent",r=this.canvas.offsetWidth/t):(this.canvas.style.height="100%",r=100,h="percent",i=this.canvas.offsetHeight*t),this.viewport={width:i,widthUnit:o,height:r,heightUnit:h},this._contentArea=Zt.fromDimension(this.resolution.width,this.resolution.height,rt.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(t){this.displayMode===ui.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===ui.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:t.innerWidth,height:t.innerHeight},this.viewport=this.resolution),this._contentArea=Zt.fromDimension(this.resolution.width,this.resolution.height,rt.Zero),this.displayMode===ui.FitScreen&&this._computeFit(),this.displayMode===ui.FitContainer&&this._computeFitContainer(),this.displayMode===ui.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===ui.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===ui.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===ui.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class Co{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function Tp(c){return!!c.playbackState}class on{static unlock(){return new Promise((i,r)=>{if(on._UNLOCKED||!Co.create())return i(!0);const o=setTimeout(()=>{$t.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),i(!1)},200),h=Co.create();h.resume().then(()=>{const u=h.createBuffer(1,1,22050),_=h.createBufferSource();let A=!1;_.buffer=u,_.connect(h.destination),_.onended=()=>A=!0,_.start(0),setTimeout(()=>{Tp(_)?(_.playbackState===_.PLAYING_STATE||_.playbackState===_.FINISHED_STATE)&&(on._UNLOCKED=!0):(h.currentTime>0||A)&&(on._UNLOCKED=!0)},0),clearTimeout(o),i(!0)},()=>{r()})})}static isUnlocked(){return this._UNLOCKED}}on._UNLOCKED=!1;class Za extends Vn{get ctx(){return this._ctx}constructor(t={}){super(t),this._options=t}clone(){return new Za({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){var i,r;!((i=this._options)===null||i===void 0)&&i.draw&&((r=this._options)===null||r===void 0||r.draw(t)),this._options.cache||this.flagDirty()}}class uc{}uc.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class $a{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(t){this._currentState=t}static create(t,i){const r=new $a;r.data=i;for(const o in t.states)r.states.set(o,{name:o,...t.states[o]});for(const o of r.states.values())for(const h of o.transitions)if(h!=="*"&&!r.states.has(h))throw Error(`Invalid state machine, state [${o.name}] has a transition to another state that doesn't exist [${h}]`);return r.currentState=r.startState=r.states.get(t.start),r}in(t){return this.currentState.name===t}go(t,i){var r,o;if(this.currentState.transitions.includes(t)||this.currentState.transitions.includes("*")){const h=this.states.get(t);return this.currentState.onExit&&((r=this.currentState)===null||r===void 0?void 0:r.onExit({to:h.name,data:this.data}))===!1||h!=null&&h.onEnter&&(h==null?void 0:h.onEnter({from:this.currentState.name,eventData:i,data:this.data}))===!1?!1:(this.currentState=h,!((o=this.currentState)===null||o===void 0)&&o.onState&&this.currentState.onState(),!0)}return!1}update(t){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,t)}save(t){localStorage.setItem(t,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(t){const i=JSON.parse(localStorage.getItem(t));this.currentState=this.states.get(i.currentState),this.data=i.data}}class Wu{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(t){this._loop=t,this._instance&&(this._instance.loop=t,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(t){t=ce(t,0,1),this._volume=t,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(t,this._audioContext.currentTime,.1):this._volumeNode.gain.value=t}get volume(){return this._volume}get duration(){var t;return(t=this._duration)!==null&&t!==void 0?t:this.getTotalPlaybackDuration()}set duration(t){this._duration=t}constructor(t){this._src=t,this._audioContext=Co.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new ns,this._stateMachine=$a.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:i})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,i.pausedAt*this._playbackRate):this._instance.start(0,i.pausedAt*this._playbackRate,this.duration),i.startedAt=this._audioContext.currentTime-i.pausedAt,i.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:i})=>{i==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:i,data:r})=>{r.pausedAt=(i??0)/this._playbackRate,r.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:i})=>{i.pausedAt=0,i.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:i})=>{i.pausedAt=this._audioContext.currentTime-i.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(t=()=>{}){return this._playStarted=t,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(t){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",t)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:t,startedAt:i}=this._stateMachine.data;return t?t*this._playbackRate:i?(this._audioContext.currentTime-i)*this._playbackRate:0}set playbackRate(t){this._instance.playbackRate.value=this._playbackRate=t}get playbackRate(){return this._instance.playbackRate.value}}class gc extends le{set bubbles(t){}get bubbles(){return!1}get _path(){return null}set _path(t){}constructor(t,i="MediaEvent"){super(),this.target=t,this._name=i}stopPropagation(){}action(){}propagate(){}layPath(t){}}class en extends gc{constructor(t,i){super(t,"NativeSoundEvent"),this.track=i}}class qu extends gc{constructor(t,i){super(t,"NativeSoundProcessedEvent"),this._processedData=i,this.data=this._processedData}}function Sp(c){try{const t=new Audio,i=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,r=c.match(i)[1];return!!t.canPlayType("audio/"+r)}catch(t){return $t.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",t),!1}}const Pp={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Vu{set loop(t){this._loop=t;for(const i of this._tracks)i.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(t){this._volume=t;for(const i of this._tracks)i.volume=this._volume;this.events.emit("volumechange",new en(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(t){this._duration=t}get instances(){return this._tracks}get path(){return this._resource.path}set path(t){this._resource.path=t}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}constructor(...t){this.events=new Ue,this.logger=$t.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=Co.create(),this._resource=new ko("",uc.type.arraybuffer);for(const i of t)if(Sp(i)){this.path=i;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",t.join(", ")),this.logger.warn("Attempting to use",t[0]),this.path=t[0])}isLoaded(){return!!this.data}async load(){var t,i;if(this.data)return this.data;const r=await this._resource.load(),o=await this.decodeAudio(r.slice(0));return this._duration=(i=(t=this._duration)!==null&&t!==void 0?t:o==null?void 0:o.duration)!==null&&i!==void 0?i:void 0,this.events.emit("processed",new qu(this,o)),this.data=o}async decodeAudio(t){try{return await this._audioContext.decodeAudioData(t.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(t){t&&(this._engine=t,this._engine.on("hidden",()=>{t.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{t.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(t=>t.isPlaying())}isPaused(){return this._tracks.some(t=>t.isPaused())}isStopped(){return this._tracks.some(t=>t.isStopped())}play(t){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=t||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const t of this._tracks)t.pause();this.events.emit("pause",new en(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const t of this._tracks)t.stop();this.events.emit("stop",new en(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._tracks.forEach(i=>{i.playbackRate=this._playbackRate})}seek(t,i=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[i].seek(t)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(t=0){return this._tracks.length?this._tracks[t].getPlaybackPosition():0}getTrackId(t){return this._tracks.indexOf(t)}async _resumePlayback(){if(this.isPaused()){const t=[];for(const i of this._tracks)t.push(i.play().then(()=>(this._tracks.splice(this.getTrackId(i),1),!0)));this.events.emit("resume",new en(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(t)}return!0}async _startPlayback(){const t=this._getTrackInstance(this.data),i=await t.play(()=>{this.events.emit("playbackstart",new en(this,t)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new en(this,t));const r=this.getTrackId(t);return r!==-1&&this._tracks.splice(r,1),i}_getTrackInstance(t){var i;const r=new Wu(t);return r.loop=this.loop,r.volume=this.volume,r.duration=(i=this.duration)!==null&&i!==void 0?i:0,r.playbackRate=this._playbackRate,this._tracks.push(r),r}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Dp={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function vl(c){var t,i;return!!(c!=null&&c.prototype)&&!!(!((i=(t=c==null?void 0:c.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class Eo{get resources(){return this._resources}constructor(t){var i;this.events=new Ue,this.canvas=new Za({filtering:ii.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new ns,t&&(!((i=t.loadables)===null||i===void 0)&&i.length)&&this.addResources(t.loadables)}onInitialize(t){this.engine=t,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await Pa(500,this.engine.clock)}addResource(t){this._resources.push(t)}addResources(t){let i=0;const r=t.length;for(i;i<r;i++)this.addResource(t[i])}markResourceComplete(){this._numLoaded++}get progress(){const t=this._resources.length;return t>0?ce(this._numLoaded,0,t)/t:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(t,i){this._totalTimeMs+=i}onDraw(t){const i=this._totalTimeMs/1e3;t.fillStyle=kt.Black.toRGBA(),t.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),t.save(),t.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const r=i*10;t.strokeStyle="white",t.lineWidth=10,t.lineCap="round",t.arc(0,0,40,r,r+Math.PI*3/2),t.stroke(),t.fillStyle="white",t.font="16px sans-serif";const o=(this.progress*100).toFixed(0)+"%",h=t.measureText(o),u=Math.abs(h.actualBoundingBoxLeft)+Math.abs(h.actualBoundingBoxRight),_=Math.abs(h.actualBoundingBoxAscent)+Math.abs(h.actualBoundingBoxDescent);t.fillText(o,-u/2,_/2),t.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async t=>{this.events.emit("loadresourcestart",t),await t.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",t)})}));for(const t of this._resources)t instanceof Vu&&t.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await on.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}const Rp="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Fp=_i(851);class fn extends Eo{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const t=document.getElementById("excalibur-play-root");return t&&(this._playButtonRootElement=t),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(t){const i=Array.isArray(t)?{loadables:t}:t;super(i),this._logger=$t.getInstance(),this._originalOptions={loadables:[]},this.events=new Ue,this._playButtonShown=!1,this.logo=Rp,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=kt.White,this.backgroundColor="#176BAA",this._imageLoaded=new ns,this.suppressPlayButton=!1,this._playButtonStyles=Fp.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let r=document.getElementById("excalibur-play");return r||(r=document.createElement("button")),r.id="excalibur-play",r.textContent=this.playButtonText,r.style.display="none",r},this._originalOptions={...fn._DEFAULT_LOADER_OPTIONS,...i}}onInitialize(t){this.engine=t,this.screen=t.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var t,i;if(this.suppressPlayButton)this.hidePlayButton(),await Pa(500,(t=this.engine)===null||t===void 0?void 0:t.clock);else{const r=()=>{try{this._positionPlayButton()}catch{}};return!((i=this.engine)===null||i===void 0)&&i.browser&&this.engine.browser.window.on("resize",r),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",h=>{h.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(h=>{const u=_=>{var A;if(_.stopPropagation(),this.hidePlayButton(),!((A=this.engine)===null||A===void 0)&&A.browser&&this.engine.browser.window.off("resize",r),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.goFullScreen(this._originalOptions.fullscreenContainer)}catch(y){this._logger.error("could not go fullscreen",y)}h()};this._playButton.addEventListener("click",u),this._playButton.addEventListener("touchend",u),this._playButton.addEventListener("pointerup",u)})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var t;await Pa(200,(t=this.engine)===null||t===void 0?void 0:t.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const t=this._image;await this._imageLoaded.promise,await(t==null?void 0:t.decode())}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:t,y:i,width:r,height:o}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const h=this._playButton.clientWidth,u=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${t+r/2-h/2}px`,this._playButtonRootElement.style.top=`${i+o/2-u/2+100}px`)}}}onDraw(t){const i=this.engine.canvasHeight/this.engine.pixelRatio,r=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),t.fillStyle=this.backgroundColor,t.fillRect(0,0,r,i);let o=i/2;const h=Math.min(this.logoWidth,r*.75);let u=r/2-h/2;this.logoPosition&&(u=this.logoPosition.x,o=this.logoPosition.y);const _=Math.floor(h*(this.logoHeight/this.logoWidth)),A=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,u,o,h,_):t.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,u,o-_-20,h,_),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=A;return}let y=u,w=o;this.loadingBarPosition&&(y=this.loadingBarPosition.x,w=this.loadingBarPosition.y),t.lineWidth=2,pl(t,y,w,h,20,10,this.loadingBarColor);const f=h*this.progress,T=5,C=f-T*2,S=20-T*2;pl(t,y+T,w+T,C>10?C:10,S,5,null,this.loadingBarColor),this.engine.screen.antialiasing=A}}fn._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const mu={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class ju{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("2d"))},arrayBufferSupport:function(){const t=new XMLHttpRequest;t.open("GET","/");try{t.responseType="arraybuffer"}catch{return!1}return t.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const t=document.createElement("a").style;return t.cssText="background-color:rgba(150,255,150,.5)",(""+t.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const t=document.createElement("canvas");return!!(t.getContext&&t.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let t=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const i=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],r=this.getBrowserFeatures();for(const o of Object.keys(mu))r[o]?(t+="(%c✓%c)",i.push("font-weight: bold; color: green"),i.push("font-weight: normal; color: inherit")):(t+="(%c✗%c)",i.push("font-weight: bold; color: red"),i.push("font-weight: normal; color: inherit")),t+=" "+mu[o]+`
`;i.unshift(t),console.log.apply(console,i)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let t=!1;for(const i in this._criticalTests)this._criticalTests[i].call(this)||(this.failedTests.push(i),$t.getInstance().error("Critical browser feature missing, Excalibur requires:",i),t=!0);if(t)return!1;for(const i in this._warningTest)this._warningTest[i]()||$t.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",i);return!0}}var ie;(function(c){c.PreventCollision="PreventCollision",c.Passive="Passive",c.Active="Active",c.Fixed="Fixed"})(ie||(ie={}));class Ls{static create(t,i){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(t)){const o=this._GROUPS.get(t);if(o.mask===i)return o;throw new Error(`Collision group ${t} already exists with a different mask!`)}const r=new nr(t,this._CURRENT_BIT,i!==void 0?i:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(t,r),r}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(t){return this._GROUPS.get(t)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}Ls._STARTING_BIT=1;Ls._MAX_GROUPS=32;Ls._CURRENT_GROUP=1;Ls._CURRENT_BIT=Ls._STARTING_BIT;Ls._GROUPS=new Map;class nr{constructor(t,i,r){this._name=t,this._category=i,this._mask=r}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(t){const i=this.category&t.mask,r=this.mask&t.category;return i!==0&&r!==0}invert(){const t=Ls.create("~("+this.name+")",~this.mask|0);return t._category=~this.category,t}static combine(t){const i=t.map(h=>h.name).join("+"),o=~t.reduce((h,u)=>u.category|h,0);return Ls.create(i,o)}static collidesWith(t){const i=`collidesWith(${t.map(o=>o.name).join("+")})`,r=t.reduce((o,h)=>h.category|o,0);return Ls.create(i,r)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}nr.All=new nr("Collide with all groups",-1,-1);class Ui{constructor(t,i){this.colliderA=t,this.colliderB=i,this.id=null,this.id=Ui.calculatePairHash(t.id,i.id)}static canCollide(t,i){var r,o;if(t.id===i.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.localBounds.hasZeroDimensions()||i.localBounds.hasZeroDimensions())return!1;const h=(r=t==null?void 0:t.owner)===null||r===void 0?void 0:r.get(fe),u=(o=i==null?void 0:i.owner)===null||o===void 0?void 0:o.get(fe);return!(!h||!u||!h.group.canCollide(u.group)||h.collisionType===ie.Fixed&&u.collisionType===ie.Fixed||u.collisionType===ie.PreventCollision||h.collisionType===ie.PreventCollision||!h.isActive||!u.isActive)}get canCollide(){const t=this.colliderA,i=this.colliderB;return Ui.canCollide(t,i)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(t){return t===this.colliderA||t===this.colliderB}static calculatePairHash(t,i){return t.value<i.value?`#${t.value}+${i.value}`:`#${i.value}+${t.value}`}}class Uo{constructor(t,i){this.min=t,this.max=i}overlaps(t){return this.max>t.min&&t.max>this.min}getOverlap(t){return this.overlaps(t)?this.max>t.max?t.max-this.min:this.max-t.min:0}}class wl{constructor(t){this.parent=t,this.parent=t||null,this.data=null,this.bounds=new Zt,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class fc{constructor(t,i=new Zt(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=t,this.worldBounds=i,this.root=null,this.nodes={}}_insert(t){if(this.root===null){this.root=t,this.root.parent=null;return}const i=t.bounds;let r=this.root;for(;!r.isLeaf();){const _=r.left,A=r.right,y=r.bounds.getPerimeter(),f=r.bounds.combine(i).getPerimeter(),T=2*f,C=2*(f-y);let S=0;const E=i.combine(_.bounds);let W,D;_.isLeaf()?S=E.getPerimeter()+C:(D=_.bounds.getPerimeter(),W=E.getPerimeter(),S=W-D+C);let H=0;const k=i.combine(A.bounds);if(A.isLeaf()?H=k.getPerimeter()+C:(D=A.bounds.getPerimeter(),W=k.getPerimeter(),H=W-D+C),T<S&&T<H)break;S<H?r=_:r=A}const o=r.parent,h=new wl(o);h.bounds=i.combine(r.bounds),h.height=r.height+1,o!==null?(o.left===r?o.left=h:o.right=h,h.left=r,h.right=t,r.parent=h,t.parent=h):(h.left=r,h.right=t,r.parent=h,t.parent=h,this.root=h);let u=t.parent;for(;u;){if(u=this._balance(u),!u.left)throw new Error("Parent of current leaf cannot have a null left child"+u);if(!u.right)throw new Error("Parent of current leaf cannot have a null right child"+u);u.height=1+Math.max(u.left.height,u.right.height),u.bounds=u.left.bounds.combine(u.right.bounds),u=u.parent}}_remove(t){if(t===this.root){this.root=null;return}const i=t.parent,r=i.parent;let o;if(i.left===t?o=i.right:o=i.left,r){r.left===i?r.left=o:r.right=o,o.parent=r;let h=r;for(;h;)h=this._balance(h),h.bounds=h.left.bounds.combine(h.right.bounds),h.height=1+Math.max(h.left.height,h.right.height),h=h.parent}else this.root=o,o.parent=null}trackCollider(t){const i=new wl;i.data=t,i.bounds=t.bounds,i.bounds.left-=2,i.bounds.top-=2,i.bounds.right+=2,i.bounds.bottom+=2,this.nodes[t.id.value]=i,this._insert(i)}updateCollider(t){var i;const r=this.nodes[t.id.value];if(!r)return!1;const o=t.bounds;if(!this.worldBounds.contains(o))return $t.getInstance().warn("Collider with id "+t.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(t),!1;if(r.bounds.contains(o))return!1;if(this._remove(r),o.left-=this._config.boundsPadding,o.top-=this._config.boundsPadding,o.right+=this._config.boundsPadding,o.bottom+=this._config.boundsPadding,t.owner){const h=(i=t.owner)===null||i===void 0?void 0:i.get(fe);if(h){const u=h.vel.x*32/1e3*this._config.velocityMultiplier,_=h.vel.y*32/1e3*this._config.velocityMultiplier;u<0?o.left+=u:o.right+=u,_<0?o.top+=_:o.bottom+=_}}return r.bounds=o,this._insert(r),!0}untrackCollider(t){const i=this.nodes[t.id.value];i&&(this._remove(i),this.nodes[t.id.value]=null,delete this.nodes[t.id.value])}_balance(t){if(t===null)throw new Error("Cannot balance at null node");if(t.isLeaf()||t.height<2)return t;const i=t.left,r=t.right,o=t,h=i,u=r,_=i.left,A=i.right,y=r.left,w=r.right,f=u.height-h.height;if(f>1)return u.left=o,u.parent=o.parent,o.parent=u,u.parent?u.parent.left===o?u.parent.left=u:u.parent.right=u:this.root=u,y.height>w.height?(u.right=y,o.right=w,w.parent=o,o.bounds=h.bounds.combine(w.bounds),u.bounds=o.bounds.combine(y.bounds),o.height=1+Math.max(h.height,w.height),u.height=1+Math.max(o.height,y.height)):(u.right=w,o.right=y,y.parent=o,o.bounds=h.bounds.combine(y.bounds),u.bounds=o.bounds.combine(w.bounds),o.height=1+Math.max(h.height,y.height),u.height=1+Math.max(o.height,w.height)),u;if(f<-1){if(h.left=o,h.parent=o.parent,o.parent=h,h.parent)if(h.parent.left===o)h.parent.left=h;else{if(h.parent.right!==o)throw"Error rotating Dynamic Tree";h.parent.right=h}else this.root=h;return _.height>A.height?(h.right=_,o.left=A,A.parent=o,o.bounds=u.bounds.combine(A.bounds),h.bounds=o.bounds.combine(_.bounds),o.height=1+Math.max(u.height,A.height),h.height=1+Math.max(o.height,_.height)):(h.right=A,o.left=_,_.parent=o,o.bounds=u.bounds.combine(_.bounds),h.bounds=o.bounds.combine(A.bounds),o.height=1+Math.max(u.height,_.height),h.height=1+Math.max(o.height,A.height)),h}return t}getHeight(){return this.root===null?0:this.root.height}query(t,i){const r=t.bounds,o=h=>{if(h&&h.bounds.overlaps(r))if(h.isLeaf()&&h.data!==t){if(i.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}rayCastQuery(t,i=1/0,r){const o=h=>{if(h&&h.bounds.rayCast(t,i))if(h.isLeaf()){if(r.call(t,h.data))return!0}else return o(h.left)||o(h.right);return!1};o(this.root)}getNodes(){const t=i=>i?[i].concat(t(i.left),t(i.right)):[];return t(this.root)}debug(t){const i=r=>{r&&(r.isLeaf()?r.bounds.draw(t,kt.Green):r.bounds.draw(t,kt.White),r.left&&i(r.left),r.right&&i(r.right))};i(this.root)}}class rn{constructor(t,i){this.pos=t,this.dir=i.normalize()}intersect(t){const i=t.begin.sub(this.pos);if(this.dir.cross(t.getSlope())===0&&i.cross(this.dir)!==0)return-1;const r=this.dir.cross(t.getSlope());if(r===0)return-1;const o=i.cross(t.getSlope())/r;if(o>=0){const h=i.cross(this.dir)/r/t.getLength();if(h>=0&&h<=1)return o}return-1}intersectPoint(t){const i=this.intersect(t);return i<0?null:this.getPoint(i)}getPoint(t){return this.pos.add(this.dir.scale(t))}}class Ha{constructor(t){this._config=t,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new fc(t.dynamicTree)}getColliders(){return this._colliders}query(t){const i=[];return t instanceof Zt?this._dynamicCollisionTree.query({id:ln("collider",-1),owner:null,bounds:t},r=>(i.push(r),!1)):this._dynamicCollisionTree.query({id:ln("collider",-1),owner:null,bounds:new Zt(t.x,t.y,t.x,t.y)},r=>(i.push(r),!1)),i}rayCast(t,i){var r,o,h;const u=[],_=(r=i==null?void 0:i.maxDistance)!==null&&r!==void 0?r:1/0,A=i==null?void 0:i.collisionGroup,y=A?A.category:(o=i==null?void 0:i.collisionMask)!==null&&o!==void 0?o:nr.All.category,w=(h=i==null?void 0:i.searchAllColliders)!==null&&h!==void 0?h:!1;return this._dynamicCollisionTree.rayCastQuery(t,_,f=>{const C=f.owner.get(fe);if(i!=null&&i.ignoreCollisionGroupAll&&C.group===nr.All)return!1;const S=(y&C.group.category)!==0;if(C!=null&&C.group&&!S)return!1;const E=f.rayCast(t,_);if(E){if(i!=null&&i.filter){if(i.filter(E)&&(u.push(E),!w))return!0}else if(u.push(E),!w)return!0}return!1}),u}track(t){if(!t){$t.getInstance().warn("Cannot track null collider");return}if(t instanceof fi){const i=t.getColliders();for(const r of i)r.owner=t.owner,this._colliders.push(r),this._dynamicCollisionTree.trackCollider(r)}else this._colliders.push(t),this._dynamicCollisionTree.trackCollider(t)}untrack(t){if(!t){$t.getInstance().warn("Cannot untrack a null collider");return}if(t instanceof fi){const i=t.getColliders();for(const r of i){const o=this._colliders.indexOf(r);o!==-1&&this._colliders.splice(o,1),this._dynamicCollisionTree.untrackCollider(r)}}else{const i=this._colliders.indexOf(t);i!==-1&&this._colliders.splice(i,1),this._dynamicCollisionTree.untrackCollider(t)}}_pairExists(t,i){const r=Ui.calculatePairHash(t.id,i.id);return this._pairs.has(r)}broadphase(t,i,r){const o=i/1e3,h=t.filter(_=>{var A,y;const w=(A=_.owner)===null||A===void 0?void 0:A.get(fe);return((y=_.owner)===null||y===void 0?void 0:y.isActive)&&w.collisionType!==ie.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let u;for(let _=0,A=h.length;_<A;_++)u=h[_],this._dynamicCollisionTree.query(u,y=>{if(!this._pairExists(u,y)&&Ui.canCollide(u,y)){const w=new Ui(u,y);this._pairs.add(w.id),this._collisionPairCache.push(w)}return!1});if(r&&(r.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const _ of h){const A=_.owner.get(fe);if(A.collisionType!==ie.Active)continue;const y=A.vel.magnitude*o+A.acc.magnitude*.5*o*o,w=Math.min(_.bounds.height,_.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||y>w/2){r&&r.physics.fastBodies++;const f=A.globalPos.sub(A.oldPos),T=_.center,C=_.getFurthestPoint(A.vel),S=C.sub(f),E=new rn(S,A.vel);E.pos=E.pos.add(E.dir.scale(-2*this._config.continuous.surfaceEpsilon));let W,D=new rt(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(E,y+this._config.continuous.surfaceEpsilon*2,H=>{if(!this._pairExists(_,H)&&Ui.canCollide(_,H)){const k=H.rayCast(E,y+this._config.continuous.surfaceEpsilon*10);if(k){const N=k.point.sub(S);N.magnitude<D.magnitude&&(D=N,W=H)}}return!1}),W&&rt.isValid(D)){const H=new Ui(_,W);this._pairs.has(H.id)||(this._pairs.add(H.id),this._collisionPairCache.push(H));const k=T.sub(C);A.globalPos=S.add(k).add(D).add(E.dir.scale(10*this._config.continuous.surfaceEpsilon)),_.update(A.transform.get()),r&&r.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(t,i){let r=[];for(let o=0;o<t.length;o++){const h=t[o].collide();if(r=r.concat(h),i&&h.length>0)for(const u of h)i.physics.contacts.set(u.id,u)}return i&&(i.physics.collisions+=r.length),r}update(t){let i=0;const r=t.length;for(let o=0;o<r;o++)this._dynamicCollisionTree.updateCollider(t[o])&&i++;return i}debug(t){this._dynamicCollisionTree.debug(t)}}class Dr{constructor(){this.id=ln("collider",Dr._ID++),this.composite=null,this.events=new Ue,this.offset=rt.Zero}touching(t){return!!this.collide(t)}}Dr._ID=0;var Io;(function(c){c.Arcade="arcade",c.Realistic="realistic"})(Io||(Io={}));var Un;(function(c){c.None="none",c.VerticalFirst="vertical-first",c.HorizontalFirst="horizontal-first"})(Un||(Un={}));const Yu={vertical:1,horizontal:2},Xu={horizontal:1,vertical:2},Zu={horizontal:0,vertical:0};var Nn;(function(c){c.DynamicTree="dynamic-tree",c.SparseHashGrid="sparse-hash-grid"})(Nn||(Nn={}));const sr=()=>({enabled:!0,gravity:ft(0,0).clone(),solver:Io.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:Nn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:Un.None},realistic:{positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class fi extends Dr{set compositeStrategy(t){this._compositeStrategy=t}get compositeStrategy(){return this._compositeStrategy}constructor(t){super(),this._collisionProcessor=new Ha({...sr()}),this._dynamicAABBTree=new fc({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const i of t)this.addCollider(i)}clearColliders(){this._colliders=[]}addCollider(t){let i;t instanceof fi?(i=t.getColliders(),i.forEach(r=>r.offset.addEqual(t.offset))):i=[t];for(const r of i)r.events.pipe(this.events),r.composite=this,this._colliders.push(r),this._collisionProcessor.track(r),this._dynamicAABBTree.trackCollider(r)}removeCollider(t){t.events.pipe(this.events),t.composite=null,Wn(t,this._colliders),this._collisionProcessor.untrack(t),this._dynamicAABBTree.untrackCollider(t)}getColliders(){return this._colliders}get worldPos(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:rt.Zero).add(this.offset)}get center(){var t,i;return((i=(t=this._transform)===null||t===void 0?void 0:t.pos)!==null&&i!==void 0?i:rt.Zero).add(this.offset)}get bounds(){var t,i;const r=this.getColliders();return r.reduce((h,u)=>h.combine(u.bounds),(i=(t=r[0])===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new Zt().translate(this.worldPos)).translate(this.offset)}get localBounds(){var t,i;const r=this.getColliders();return r.reduce((h,u)=>h.combine(u.localBounds),(i=(t=r[0])===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new Zt)}get axes(){const t=this.getColliders();let i=[];for(const r of t)i=i.concat(r.axes);return i}getFurthestPoint(t){const i=this.getColliders(),r=[];for(const u of i)r.push(u.getFurthestPoint(t));let o=r[0],h=-Number.MAX_VALUE;for(const u of r){const _=u.dot(t);_>h&&(o=u,h=_)}return o}getInertia(t){const i=this.getColliders();let r=0;for(const o of i)r+=o.getInertia(t);return r}collide(t){let i=[t];t instanceof fi&&(i=t.getColliders());const r=[];for(const h of i)this._dynamicAABBTree.query(h,u=>(r.push(new Ui(h,u)),!1));let o=[];for(const h of r)o=o.concat(h.collide());return o}getClosestLineBetween(t){const i=this.getColliders(),r=[];if(t instanceof fi){const o=t.getColliders();for(const h of i)for(const u of o){const _=h.getClosestLineBetween(u);_&&r.push(_)}}else for(const o of i){const h=t.getClosestLineBetween(o);h&&r.push(h)}if(r.length){let o=r[0].getLength(),h=r[0];for(const u of r){const _=u.getLength();_<o&&(o=_,h=u)}return h}return null}contains(t){const i=this.getColliders();for(const r of i)if(r.contains(t))return!0;return!1}rayCast(t,i){const r=this.getColliders(),o=[];for(const h of r){const u=h.rayCast(t,i);u&&o.push(u)}if(o.length){let h=o[0],u=h.point.dot(t.dir);for(const _ of o){const A=t.dir.dot(_.point);A<u&&(h=_,u=A)}return h}return null}project(t){const i=this.getColliders(),r=[];for(const o of i){const h=o.project(t);h&&r.push(h)}if(r.length){const o=new Uo(r[0].min,r[0].max);for(const h of r)o.min=Math.min(h.min,o.min),o.max=Math.max(h.max,o.max);return o}return null}update(t){if(t){const i=this.getColliders();for(const r of i)r.owner=this.owner,r.update(t)}}debug(t,i,r){const o=this.getColliders();t.save(),t.translate(this.offset.x,this.offset.y);for(const h of o)h.debug(t,i,r);t.restore()}clone(){const t=new fi(this._colliders.map(i=>i.clone()));return t.offset=this.offset.clone(),t}}class Xe{constructor(t,i){this.begin=t,this.end=i}clone(t){const i=t||new Xe(this.begin.clone(),this.end.clone());return i.begin=this.begin.clone(i.begin),i.end=this.end.clone(i.end),i}transform(t,i){const r=i||new Xe(rt.Zero,rt.Zero);return r.begin=t.multiply(this.begin,r.begin),r.end=t.multiply(this.end,r.end),r}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const t=this.begin,i=this.end,r=t.distance(i);return this._slope=i.sub(t).scale(1/r)}getEdge(){const t=this.begin;return this.end.sub(t)}getLength(){const t=this.begin,i=this.end;return t.distance(i)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new Xe(this.end,this.begin)}below(t){return(this.end.x-this.begin.x)*(t.y-this.begin.y)-(this.end.y-this.begin.y)*(t.x-this.begin.x)>=0}clip(t,i,r=!0){let o=t;r&&(o=o.normalize());const h=o.dot(this.begin)-i,u=o.dot(this.end)-i,_=[];if(h<=0&&_.push(this.begin),u<=0&&_.push(this.end),h*u<0){const A=h/(h-u);_.push(this.begin.add(this.end.sub(this.begin).scale(A)))}return _.length!==2?null:new Xe(_[0],_[1])}distanceToPoint(t,i=!1){const r=t.x,o=t.y,h=this.getLength(),u=this.end.y-this.begin.y,_=this.end.x-this.begin.x,A=(u*r-_*o+this.end.x*this.begin.y-this.end.y*this.begin.x)/h;return i?A:Math.abs(A)}findVectorToPoint(t){const i=this.begin.sub(t),r=this.getSlope();return i.sub(r.scale(i.dot(r)))}findPoint(t=null,i=null){const r=this.slope,o=this.intercept;if(t!==null)return new rt(t,r*t+o);if(i!==null)return new rt((i-o)/r,i);throw new Error("You must provide an X or a Y value")}hasPoint(){let t,i=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")t=new rt(arguments[0],arguments[1]),i=arguments[2]||0;else if(arguments[0]instanceof rt)t=arguments[0],i=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const r=t.x-this.begin.x,o=t.y-this.begin.y,h=this.end.x-this.begin.x,u=this.end.y-this.begin.y,_=r*u-o*h;return Math.abs(_)>i?!1:Math.abs(h)>=Math.abs(u)?h>0?this.begin.x<=t.x&&t.x<=this.end.x:this.end.x<=t.x&&t.x<=this.begin.x:u>0?this.begin.y<=t.y&&t.y<=this.end.y:this.end.y<=t.y&&t.y<=this.begin.y}}function hl(c,t){const r=c.dir(),o=t.dir(),h=r.dot(r),u=o.dot(o);if(h<1e-9&&u<1e-9)return new Xe(c.begin,t.begin);if(h<1e-9){const W=ce(o.dot(c.begin.sub(t.begin))/u,0,1),D=t.begin.add(o.scale(W));return new Xe(c.begin,D)}if(u<1e-9){const W=ce(r.dot(t.begin.sub(c.begin))/h,0,1),D=c.begin.add(r.scale(W));return new Xe(D,t.begin)}const _=c.begin.sub(t.begin),A=h,y=u,w=o.dot(_),f=A*y-Math.pow(r.dot(o),2);let T=0,C=0;Math.abs(f)>1e-9?T=ce((r.dot(o)*w-y*r.dot(_))/f,0,1):T=ce(r.dot(_)/A,0,1),Math.abs(y)>1e-9?C=ce((r.dot(o)*T+w)/y,0,1):C=0;const S=c.begin.add(r.scale(T)),E=t.begin.add(o.scale(C));return new Xe(S,E)}const zs={PolygonPolygonClosestLine(c,t){const i=c.getSides(),r=t.getSides();let o=Number.MAX_VALUE,h=null;for(let u=0;u<i.length;u++)for(let _=0;_<r.length;_++){const A=hl(i[u],r[_]),y=A.getLength();y<o&&(o=y,h=A)}return h},PolygonEdgeClosestLine(c,t){const r=t.worldPos.sub(c.worldPos),o=new rn(c.worldPos,r),h=c.rayCast(o).point.add(o.dir.scale(.1)),u=c.getClosestFace(h),_=t.asLine();return hl(u.face,_)},PolygonCircleClosestLine(c,t){const i=t.worldPos,r=i.sub(c.worldPos),o=new rn(c.worldPos,r.normalize()),h=c.rayCast(o).point.add(o.dir.scale(.1)),u=c.getClosestFace(h),_=u.face.begin,A=u.face.getEdge();let y=(A.x*(i.x-_.x)+A.y*(i.y-_.y))/(A.x*A.x+A.y*A.y);y>1?y=1:y<0&&(y=0);const w=Math.sqrt(Math.pow(_.x+A.x*y-i.x,2)+Math.pow(_.y+A.y*y-i.y,2))-t.radius,f=(_.x+A.x*y-i.x)*t.radius/(t.radius+w),T=(_.y+A.y*y-i.y)*t.radius/(t.radius+w);return new Xe(A.scale(y).add(_),new rt(i.x+f,i.y+T))},CircleCircleClosestLine(c,t){const r=t.worldPos.sub(c.worldPos),h=c.worldPos.sub(t.worldPos),u=new rn(c.worldPos,r),_=new rn(t.worldPos,h),A=c.rayCast(u),y=t.rayCast(_);return new Xe(A.point,y.point)},CircleEdgeClosestLine(c,t){const i=c.worldPos,r=t.asLine(),o=r.begin,h=r.getEdge(),u=o,_=h;let A=(_.x*(i.x-u.x)+_.y*(i.y-u.y))/(_.x*_.x+_.y*_.y);A>1?A=1:A<0&&(A=0);const y=Math.sqrt(Math.pow(u.x+_.x*A-i.x,2)+Math.pow(u.y+_.y*A-i.y,2))-c.radius,w=(u.x+_.x*A-i.x)*c.radius/(c.radius+y),f=(u.y+_.y*A-i.y)*c.radius/(c.radius+y);return new Xe(_.scale(A).add(u),new rt(i.x+w,i.y+f))},EdgeEdgeClosestLine(c,t){const i=c.asLine(),r=t.asLine();return hl(i,r)}};class Si extends Dr{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var t;if(this._radius)return this._radius;const i=this._transform,r=(t=i==null?void 0:i.globalScale)!==null&&t!==void 0?t:rt.One;return this._radius=this._naturalRadius*Math.min(r.x,r.y)}set radius(t){var i;const r=this._transform,o=(i=r==null?void 0:r.globalScale)!==null&&i!==void 0?i:rt.One;this._naturalRadius=t/Math.min(o.x,o.y),this._localBoundsDirty=!0,this._radius=t}constructor(t){super(),this.offset=rt.Zero,this._globalMatrix=ti.identity(),this._localBoundsDirty=!0,this.offset=t.offset||rt.Zero,this.radius=t.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new Si({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(t){var i,r;return((r=(i=this._transform)===null||i===void 0?void 0:i.pos)!==null&&r!==void 0?r:this.offset).distance(t)<=this.radius}rayCast(t,i=1/0){var r,o;const h=this.center,u=t.dir,_=t.pos,A=h.sub(_),y=u.scale(A.dot(u)),f=A.sub(y).magnitude;if(f>this.radius)return null;{let T=0;if(Su(f,this.radius,1e-4)){if(T=-u.dot(_.sub(h)),T>0&&T<i){const C=t.getPoint(T);return{point:C,normal:C.sub(h).normalize(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(fe),distance:T}}return null}else{const C=Math.sqrt(Math.pow(u.dot(_.sub(h)),2)-Math.pow(_.sub(h).distance(),2)+Math.pow(this.radius,2)),S=-u.dot(_.sub(h))+C,E=-u.dot(_.sub(h))-C,W=[];S>=0&&W.push(S),E>=0&&W.push(E);const D=Math.min(...W);if(D<=i){const H=t.getPoint(D);return{point:H,normal:H.sub(h).normalize(),collider:this,body:(o=this.owner)===null||o===void 0?void 0:o.get(fe),distance:D}}return null}}}getClosestLineBetween(t){if(t instanceof Si)return zs.CircleCircleClosestLine(this,t);if(t instanceof wi)return zs.PolygonCircleClosestLine(t,this).flip();if(t instanceof ts)return zs.CircleEdgeClosestLine(this,t).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Si)return xs.CollideCircleCircle(this,t);if(t instanceof wi)return xs.CollideCirclePolygon(this,t);if(t instanceof ts)return xs.CollideCircleEdge(this,t);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){return this.center.add(t.normalize().scale(this.radius))}getFurthestLocalPoint(t){return t.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new Zt(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(t){return t*this.radius*this.radius/2}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(t){const i=[],o=this.center.dot(t);return i.push(o),i.push(o+this.radius),i.push(o-this.radius),new Uo(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i,r){var o,h,u,_;const{lineWidth:A}={lineWidth:1,...r},y=this._transform,w=(o=y==null?void 0:y.globalScale)!==null&&o!==void 0?o:rt.One,f=(h=y==null?void 0:y.globalRotation)!==null&&h!==void 0?h:0,T=(u=y==null?void 0:y.globalPos)!==null&&u!==void 0?u:rt.Zero;t.save(),t.translate(T.x,T.y),t.rotate(f),t.scale(w.x,w.y),t.drawCircle((_=this.offset)!==null&&_!==void 0?_:rt.Zero,this._naturalRadius,kt.Transparent,i,A),t.restore()}}class sn{constructor(t,i,r,o,h,u,_,A){var y,w,f,T,C,S;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=t,this.colliderB=i,this.mtv=r,this.normal=o,this.tangent=h,this.points=u,this.localPoints=_,this.info=A,this.id=Ui.calculatePairHash(t.id,i.id),t.composite||i.composite){const E=((y=t.composite)===null||y===void 0?void 0:y.compositeStrategy)==="separate"?t.id:(f=(w=t.composite)===null||w===void 0?void 0:w.id)!==null&&f!==void 0?f:t.id,W=((T=i.composite)===null||T===void 0?void 0:T.compositeStrategy)==="separate"?i.id:(S=(C=i.composite)===null||C===void 0?void 0:C.id)!==null&&S!==void 0?S:i.id;this.id+="|"+Ui.calculatePairHash(E,W)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(fe)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(fe))}matchAwake(){const t=this.bodyA,i=this.bodyB;t&&i&&t.isSleeping!==i.isSleeping&&(t.isSleeping&&t.collisionType!==ie.Fixed&&i.sleepMotion>=t.wakeThreshold&&(t.isSleeping=!1),i.isSleeping&&i.collisionType!==ie.Fixed&&t.sleepMotion>=i.wakeThreshold&&(i.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(t){if(t!==this.colliderA&&t!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(t===this.colliderA)return this;const i=this.colliderA,r=this.colliderB;return this.colliderB=i,this.colliderA=r,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class $u{constructor(){this.axis=ft(0,0),this.localAxis=ft(0,0),this.side=new Xe(ft(0,0),ft(0,0)),this.localSide=new Xe(ft(0,0),ft(0,0)),this.point=ft(0,0),this.localPoint=ft(0,0)}}class Ke{static findPolygonPolygonSeparation(t,i){if(i.transform.matrix.determinant()===0)return Ke.findPolygonPolygonSeparationDegenerate(t,i);let r=-Number.MAX_VALUE,o=-1,h;const u=i.transform.inverse.multiply(t.transform.matrix,Ke._SCRATCH_MATRIX),_=u.getRotation(),A=t.normals,y=t.points,w=i.points;for(let C=0;C<y.length;C++){const S=A[C].rotate(_,Ke._ZERO,Ke._SCRATCH_NORMAL),E=u.multiply(y[C],Ke._SCRATCH_POINT);let W=Number.MAX_VALUE,D;for(let H=0;H<w.length;H++){const k=S.dot(w[H].sub(E,Ke._SCRATCH_SUB_POINT));k<W&&(W=k,D=w[H])}W>r&&(r=W,o=C,h=D)}const f=(o+1)%y.length,T=Ke.SeparationPool.get();return T.collider=t,T.separation=r,r>0||(A[o].clone(T.localAxis),A[o].rotate(t.transform.rotation,Ke._ZERO,T.axis),t.transform.matrix.multiply(y[o],T.side.begin),t.transform.matrix.multiply(y[f],T.side.end),i.transform.matrix.multiply(h,T.point),T.sideId=o,h.clone(T.localPoint),y[o].clone(T.localSide.begin),y[f].clone(T.localSide.end)),T}static findCirclePolygonSeparation(t,i){const r=i.axes,h=i.center.sub(t.worldPos),u=i.getFurthestPoint(h.negate());r.push(u.sub(t.worldPos).normalize());let _=Number.MAX_VALUE,A=null,y=-1;for(let w=0;w<r.length;w++){const f=i.project(r[w]),T=t.project(r[w]),C=f.getOverlap(T);if(C<=0)return null;C<_&&(_=C,A=r[w],y=w)}return y<0?null:A.normalize().scale(_)}static findPolygonPolygonSeparationDegenerate(t,i){let r=-Number.MAX_VALUE,o=null,h=null,u=-1,_=null;const A=t.getSides(),y=t.getLocalSides();for(let w=0;w<A.length;w++){const f=A[w],T=f.normal(),C=i.getFurthestPoint(T.negate()),S=f.distanceToPoint(C,!0);S>r&&(r=S,o=f,h=T,u=w,_=C)}return{collider:t,separation:h?r:99,axis:h,side:o,localSide:y[u],sideId:u,point:_,localPoint:h?i.getFurthestLocalPoint(h.negate()):null}}}Ke.SeparationPool=new ja(()=>new $u,c=>c,500);Ke._ZERO=ft(0,0);Ke._SCRATCH_POINT=ft(0,0);Ke._SCRATCH_SUB_POINT=ft(0,0);Ke._SCRATCH_NORMAL=ft(0,0);Ke._SCRATCH_MATRIX=ti.identity();Ke.SeparationPool.disableWarnings=!0;const Mp=rt.Zero,kp=rt.Zero,Qp=ti.identity(),xs={CollideCircleCircle(c,t){const i=c.worldPos,r=t.worldPos,o=c.radius+t.radius,h=i.distance(r);if(h>o)return[];const u=o-h,_=r.sub(i).normalize(),A=_.perpendicular(),y=_.scale(u),w=c.getFurthestPoint(_),f=c.getFurthestLocalPoint(_),T={collider:c,separation:u,axis:_,point:w};return[new sn(c,t,y,_,A,[w],[f],T)]},CollideCirclePolygon(c,t){var i,r;let o=Ke.findCirclePolygonSeparation(c,t);if(!o)return[];o=o.dot(t.center.sub(c.center))<0?o.negate():o;const u=c.getFurthestPoint(o),A=((r=(i=c.owner)===null||i===void 0?void 0:i.get(qt))!==null&&r!==void 0?r:new qt).applyInverse(u),y=o.normalize(),w={collider:c,separation:-o.magnitude,axis:y,point:u,localPoint:A,side:t.findSide(y.negate()),localSide:t.findLocalSide(y.negate())};return[new sn(c,t,o,y,y.perpendicular(),[u],[A],w)]},CollideCircleEdge(c,t){const i=c.center,r=t.asLine(),o=r.end.sub(r.begin),h=o.dot(r.end.sub(i)),u=o.dot(i.sub(r.begin)),_=t.asLine(),A=t.asLocalLine();if(u<=0){const D=r.begin.sub(i),H=D.dot(D);if(H>c.radius*c.radius)return[];const k=D.normalize(),N=c.radius-Math.sqrt(H),Q={collider:c,separation:N,axis:k,point:_.begin,side:_,localSide:A};return[new sn(c,t,k.scale(N),k,k.perpendicular(),[_.begin],[A.begin],Q)]}if(h<=0){const D=r.end.sub(i),H=D.dot(D);if(H>c.radius*c.radius)return[];const k=D.normalize(),N=c.radius-Math.sqrt(H),Q={collider:c,separation:N,axis:k,point:_.end,side:_,localSide:A};return[new sn(c,t,k.scale(N),k,k.perpendicular(),[_.end],[A.end],Q)]}const y=o.dot(o),w=r.begin.scale(h).add(r.end.scale(u)).scale(1/y),f=i.sub(w),T=f.dot(f);if(T>c.radius*c.radius)return[];let C=o.perpendicular();C.dot(i.sub(r.begin))<0&&(C.x=-C.x,C.y=-C.y),C=C.normalize();const S=c.radius-Math.sqrt(T),E=C.scale(S),W={collider:c,separation:S,axis:C,point:w,side:_,localSide:A};return[new sn(c,t,E,C.negate(),C.negate().perpendicular(),[w],[w.sub(t.worldPos)],W)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(c,t){var i;const r=c.center,h=t.center.sub(r).normalize(),u=new wi({points:[t.begin,t.end,t.end.add(h.scale(100)),t.begin.add(h.scale(100))],offset:t.offset});u.owner=t.owner,((i=t.owner)===null||i===void 0?void 0:i.get(qt))&&u.update(t.owner.get(qt).get());const A=this.CollidePolygonPolygon(c,u);return A.length&&(A[0].colliderB=t,A[0].id=Ui.calculatePairHash(c.id,t.id)),A},CollidePolygonPolygon(c,t){const i=Ke.findPolygonPolygonSeparation(c,t);if(i.separation>0)return[];const r=Ke.findPolygonPolygonSeparation(t,c);if(r.separation>0)return[];const o=i.separation>r.separation?i:r,h=o.collider===c?t:c,u=o.collider===c?c:t,_=h.transform.inverse.multiply(u.transform.matrix,Qp),A=_.getRotation(),y=u.normals[o.sideId].rotate(A,Mp,kp);let w=Number.MAX_VALUE,f=0;for(let D=0;D<h.normals.length;D++){const H=y.dot(h.normals[D]);H<w&&(w=H,f=D)}const T=o.localSide.transform(_),C=o.localAxis.perpendicular().negate().rotate(A),E=new Xe(h.points[f],h.points[(f+1)%h.points.length]).clip(C.negate(),-C.dot(T.begin),!1);let W=null;if(E&&(W=E.clip(C,C.dot(T.end),!1)),W){const D=[],H=[],k=W.getPoints();for(let L=0;L<k.length;L++){const O=k[L];T.below(O)&&(D.push(O),H.push(h.transform.apply(O)))}let N=o.axis,Q=N.perpendicular();return t.center.sub(c.center).dot(N)<0&&(N=N.negate(),Q=N.perpendicular()),[new sn(c,t,N.scale(-o.separation),N,Q,H,D,o)]}return[]},FindContactSeparation(c,t){var i,r,o,h;const u=c.colliderA,_=(r=(i=c.bodyA)===null||i===void 0?void 0:i.transform)!==null&&r!==void 0?r:new qt,A=c.colliderB,y=(h=(o=c.bodyB)===null||o===void 0?void 0:o.transform)!==null&&h!==void 0?h:new qt;if(u instanceof Si&&A instanceof Si){const w=u.radius+A.radius,f=_.pos.distance(y.pos);return-(w-f)}if(u instanceof wi&&A instanceof wi&&c.info.localSide){let w,f;return c.info.collider===u?(w=new Xe(_.apply(c.info.localSide.begin),_.apply(c.info.localSide.end)),f=y.apply(t)):(w=new Xe(y.apply(c.info.localSide.begin),y.apply(c.info.localSide.end)),f=_.apply(t)),w.distanceToPoint(f,!0)}if(u instanceof wi&&A instanceof Si||A instanceof wi&&u instanceof Si){const w=_.apply(t);if(c.info.side)return c.info.side.distanceToPoint(w,!0)}if(u instanceof ts&&A instanceof wi||A instanceof ts&&u instanceof wi){let w;if(c.info.collider===u?w=y.apply(t):w=_.apply(t),c.info.side)return c.info.side.distanceToPoint(w,!0)}if(u instanceof Si&&A instanceof ts||A instanceof Si&&u instanceof ts){const w=y.apply(t);let f;u instanceof Si&&(f=u.getFurthestPoint(c.normal));const T=w.distance(f);if(c.info.side)return T>0?-T:0}return 0}};class ts extends Dr{constructor(t){var i;super(),this._globalMatrix=ti.identity(),this.begin=t.begin||rt.Zero,this.end=t.end||rt.Zero,this.offset=(i=t.offset)!==null&&i!==void 0?i:rt.Zero}clone(){return new ts({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var t;const i=this._transform;return(t=i==null?void 0:i.globalPos.add(this.offset))!==null&&t!==void 0?t:this.offset}get center(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.average(i)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const t=this._getTransformedBegin(),i=this._getTransformedEnd(),r=t.distance(i);return i.sub(t).scale(1/r)}getLength(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return t.distance(i)}contains(){return!1}rayCast(t,i=1/0){var r;const o=this._getTransformedBegin().sub(t.pos);if(t.dir.cross(this.getSlope())===0&&o.cross(t.dir)!==0)return null;const h=t.dir.cross(this.getSlope());if(h===0)return null;const u=o.cross(this.getSlope())/h;if(u>=0&&u<=i){const _=o.cross(t.dir)/h/this.getLength();if(_>=0&&_<=1)return{distance:u,normal:this.asLine().normal(),collider:this,body:(r=this.owner)===null||r===void 0?void 0:r.get(fe),point:t.getPoint(u)}}return null}getClosestLineBetween(t){if(t instanceof Si)return zs.CircleEdgeClosestLine(t,this);if(t instanceof wi)return zs.PolygonEdgeClosestLine(t,this).flip();if(t instanceof ts)return zs.EdgeEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Si)return xs.CollideCircleEdge(t,this);if(t instanceof wi)return xs.CollidePolygonEdge(t,this);if(t instanceof ts)return xs.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this._getTransformedBegin(),r=this._getTransformedEnd();return t.dot(i)>0?i:r}_boundsFromBeginEnd(t,i,r=10){return new Zt(Math.min(t.x,i.x)-r,Math.min(t.y,i.y)-r,Math.max(t.x,i.x)+r,Math.max(t.y,i.y)+r)}get bounds(){const t=this._getTransformedBegin(),i=this._getTransformedEnd();return this._boundsFromBeginEnd(t,i)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new Xe(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new Xe(this.begin,this.end)}get axes(){const i=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),r=[];return r.push(i),r.push(i.negate()),r.push(i.normal()),r.push(i.normal().negate()),r}getInertia(t){const i=this.end.sub(this.begin).distance()/2;return t*i*i}update(t){var i;this._transform=t,((i=t.matrix)!==null&&i!==void 0?i:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(t){const i=[],r=[this._getTransformedBegin(),this._getTransformedEnd()],o=r.length;for(let h=0;h<o;h++)i.push(r[h].dot(t));return new Uo(Math.min.apply(Math,i),Math.max.apply(Math,i))}debug(t,i){const r=this._getTransformedBegin(),o=this._getTransformedEnd();t.drawLine(r,o,i,2),t.drawCircle(r,2,i),t.drawCircle(o,2,i)}}class gi{static registerGraphicsContext(t){gi._ctx=t}static draw(t){this._drawCalls.push(t)}static drawPoint(t,i){gi.draw(r=>{r.debug.drawPoint(t,i)})}static drawLine(t,i,r){gi.draw(o=>{o.debug.drawLine(t,i,r)})}static drawLines(t,i){t.length>1&&gi.draw(r=>{for(let o=0;o<t.length-1;o++)r.debug.drawLine(t[o],t[o+1],i)})}static drawText(t,i){gi.draw(r=>{r.debug.drawText(t,i)})}static drawPolygon(t,i){t.length>1&&gi.draw(r=>{const o=t[0],h=[...t,o];for(let u=0;u<h.length-1;u++)r.debug.drawLine(h[u],h[u+1],i)})}static drawCircle(t,i,r){const{color:o,strokeColor:h,width:u}={color:kt.Black,strokeColor:void 0,width:void 0,...r};gi.draw(_=>{_.drawCircle(t,i,o,h,u)})}static drawBounds(t,i){gi.draw(r=>{r.debug.drawRect(t.left,t.top,t.width,t.height,i)})}static drawRay(t,i){const{distance:r,color:o}={color:kt.Blue,distance:10,...i};gi.draw(h=>{const u=t.pos,_=t.pos.add(t.dir.scale(r));h.debug.drawLine(u,_,{color:o})})}static flush(t){t.save(),t.z=gi.z;for(const i of gi._drawCalls)i(t);t.restore(),gi.clear()}static clear(){gi._drawCalls.length=0}}gi._drawCalls=[];gi.z=1/0;class wi extends Dr{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(t){if(t.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=t,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const t=[];for(let i=0;i<this._points.length;i++)t.push(this._points[(i+1)%this._points.length].sub(this._points[i]).normal());this._normals=t}get points(){return this._points}get transform(){return this._transform}constructor(t){var i;super(),this._logger=$t.getInstance(),this._transform=new rr,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(i=t.offset)!==null&&i!==void 0?i:rt.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=t.points,this.isConvex()||t.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(t){this._isCounterClockwiseWinding(t)||t.reverse()}_isCounterClockwiseWinding(t){let i=0;for(let r=0;r<t.length;r++)i+=(t[(r+1)%t.length].x-t[r].x)*(t[(r+1)%t.length].y+t[r].y);return i<0}isConvex(){if(this.points.length<3)return!1;let t=this.points[this.points.length-2],i=this.points[this.points.length-1],r=Math.atan2(i.y-t.y,i.x-t.x),o=0,h=0,u=0;for(const[_,A]of this.points.entries()){if(t=i,o=r,i=A,r=Math.atan2(i.y-t.y,i.x-t.x),t.equals(i))return!1;let y=r-o;if(y<=-Math.PI?y+=Math.PI*2:y>Math.PI&&(y-=Math.PI*2),_===0){if(y===0)return!1;h=y>0?1:-1}else if(h*y<=0)return!1;u+=y}return Math.abs(Math.round(u/(Math.PI*2)))===1}tessellate(){const t=[];for(let i=1;i<this.points.length-2;i++)t.push([this.points[0],this.points[i+1],this.points[i+2]]);return t.push([this.points[0],this.points[1],this.points[2]]),new fi(t.map(i=>Pi.Polygon(i)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const t=[],i=[...this.points].reverse();let r=i.length;function o(f){return f===0?r-1:f-1}function h(f){return f===r-1?0:f+1}function u(f){const T=o(f),C=h(f),S=i[T],E=i[f],W=i[C],D=S.sub(E),H=W.sub(E);return!(D.cross(H)<0)}const _=i.map((f,T)=>u(T));function A(f,T,C,S){const E=C.sub(T),W=S.sub(C),D=T.sub(S),H=f.sub(T),k=f.sub(C),N=f.sub(S),Q=E.cross(H),L=W.cross(k),O=D.cross(N);return!(Q>0||L>0||O>0)}function y(){for(let f=0;f<r;f++)if(_[f]){const T=o(f),C=h(f),S=i[T],E=i[f],W=i[C];let D=!0;for(let H=0;H<r;H++){if(H===f||H===T||H===C)continue;const k=i[H];if(A(k,S,E,W)){D=!1;break}}if(D)return f}for(let f=0;f<r;f++)if(_[f])return f;return 0}function w(f){const T=o(f),C=h(f),S=i[T],E=i[f],W=i[C];t.push([S,E,W]),i.splice(f,1),_.splice(f,1),r--}for(;r>3;){const f=y();w(f);for(let T=0;T<r;T++)_[T]=u(T)}return t.push([i[0],i[1],i[2]]),new fi(t.map(f=>Pi.Polygon(f,rt.Zero,!0)))}clone(){return new wi({offset:this.offset.clone(),points:this.points.map(t=>t.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const t=this.points,i=t.length;this._transformedPoints.length=0;for(let r=0;r<i;r++)this._transformedPoints[r]=this._transform.apply(t[r].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const t=[],i=this.getTransformedPoints(),r=i.length;for(let o=0;o<r;o++)t.push(new Xe(i[o],i[(o+1)%r]));this._sides=t,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const t=[],i=this.points,r=i.length;for(let o=0;o<r;o++)t.push(new Xe(i[o],i[(o+1)%r]));this._localSides=t,this._localSidesDirty=!1}return this._localSides}findSide(t){const i=this.getSides();let r=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const u=i[h],A=u.normal().dot(t);A>o&&(r=u,o=A)}return r}findLocalSide(t){const i=this.getLocalSides();let r=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const u=i[h],A=u.normal().dot(t);A>o&&(r=u,o=A)}return r}get axes(){const t=[],i=this.getSides();for(let r=0;r<i.length;r++)t.push(i[r].normal());return t}update(t){t&&(t.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(i=>ft(i.x*Be(this._transform.scale.x),i.y*Be(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(t){const i=this._transform.applyInverse(t),r=new rn(i,new rt(1,0));let o=0;const h=this.getLocalSides();for(let u=0;u<h.length;u++){const _=h[u];r.intersect(_)>=0&&o++}return o%2!==0}getClosestLineBetween(t){if(t instanceof Si)return zs.PolygonCircleClosestLine(this,t);if(t instanceof wi)return zs.PolygonPolygonClosestLine(this,t);if(t instanceof ts)return zs.PolygonEdgeClosestLine(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}collide(t){if(t instanceof Si)return xs.CollideCirclePolygon(t,this);if(t instanceof wi)return xs.CollidePolygonPolygon(this,t);if(t instanceof ts)return xs.CollidePolygonEdge(this,t);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof t}`)}getFurthestPoint(t){const i=this.getTransformedPoints();let r=null,o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const u=t.dot(i[h]);u>o&&(o=u,r=i[h])}return r}getFurthestLocalPoint(t){const i=this.points;let r=i[0],o=-Number.MAX_VALUE;for(let h=0;h<i.length;h++){const u=t.dot(i[h]);u>o&&(o=u,r=i[h])}return r}getClosestFace(t){const i=this.getSides();let r=Number.POSITIVE_INFINITY,o=-1,h=-1;for(let u=0;u<i.length;u++){const _=i[u].distanceToPoint(t);_<r&&(r=_,o=u,h=_)}return o!==-1?{distance:i[o].normal().scale(h),face:i[o]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=Zt.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(t){if(this._cachedMass===t&&this._cachedInertia)return this._cachedInertia;let i=0,r=0;const o=this.points;for(let h=0;h<o.length;h++){const u=(h+1)%o.length,_=o[u].cross(o[h]);i+=_*(o[h].dot(o[h])+o[h].dot(o[u])+o[u].dot(o[u])),r+=_}return this._cachedMass=t,this._cachedInertia=t/6*(i/r)}rayCast(t,i=1/0){var r;const o=this.getSides(),h=o.length;let u=Number.MAX_VALUE,_,A=-1;for(let y=0;y<h;y++){const w=t.intersect(o[y]);w>=0&&w<u&&w<=i&&(u=w,_=o[y],A=y)}return A>=0?{collider:this,distance:u,body:(r=this.owner)===null||r===void 0?void 0:r.get(fe),point:t.getPoint(u),normal:_.normal()}:null}project(t){const i=this.getTransformedPoints(),r=i.length;let o=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let u=0;u<r;u++){const _=i[u].dot(t);o=Math.min(o,_),h=Math.max(h,_)}return new Uo(o,h)}debug(t,i,r){const o=this.getTransformedPoints();gi.drawPolygon(o,{color:i})}}class Pi{static Box(t,i,r=rt.Half,o=rt.Zero){return new wi({points:new Zt(-t*r.x,-i*r.y,t-t*r.x,i-i*r.y).getPoints(),offset:o})}static Polygon(t,i=rt.Zero,r=!1){return new wi({points:t,offset:i,suppressConvexWarning:r})}static Circle(t,i=rt.Zero){return new Si({radius:t,offset:i})}static Edge(t,i){return new ts({begin:t,end:i})}static Capsule(t,i,r=rt.Zero){const o=$t.getInstance();return t===i&&o.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),i>=t?new fi([Pi.Circle(t/2,ft(0,-i/2+t/2).add(r)),Pi.Box(t,i-t,rt.Half,r),Pi.Circle(t/2,ft(0,i/2-t/2).add(r))]):new fi([Pi.Circle(i/2,ft(-t/2+i/2,0).add(r)),Pi.Box(t-i,i,rt.Half,r),Pi.Circle(i/2,ft(t/2-i/2,0).add(r))])}}class ei extends ls{constructor(t){super(),this.events=new Ue,this.$colliderAdded=new zi,this.$colliderRemoved=new zi,this._collidersToRemove=[],this.set(t)}get(){return this._collider}set(t){return this.clear(),t&&(this._collider=t,this._collider.owner=this.owner,t.events.pipe(this.events),this.$colliderAdded.notifyAll(t),this.update()),t}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const t of this._collidersToRemove)t.events.unpipe(this.events),this.$colliderRemoved.notifyAll(t),t.owner=null}clone(){return new ei(this._collider.clone())}get bounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.bounds)!==null&&i!==void 0?i:new Zt}get localBounds(){var t,i;return(i=(t=this._collider)===null||t===void 0?void 0:t.localBounds)!==null&&i!==void 0?i:new Zt}update(){var t;const i=(t=this.owner)===null||t===void 0?void 0:t.get(qt);this._collider&&(this._collider.owner=this.owner,i&&this._collider.update(i.get()))}collide(t){let i=this._collider,r=t._collider;if(!i||!r)return[];let o=!1;if(r instanceof fi&&(i=r,r=this._collider,o=!0),this._collider){const h=i.collide(r);return h?(o&&h.forEach(u=>{u.mtv=u.mtv.negate(),u.normal=u.normal.negate(),u.tangent=u.normal.perpendicular(),u.colliderA=this._collider,u.colliderB=t._collider}),h):[]}return[]}onAdd(t){this._collider&&this.update(),this.events.on("precollision",i=>{const r=i;t.events.emit("precollision",new un(r.self,r.other,r.side,r.intersection,r.contact)),t instanceof Ni&&t.onPreCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("postcollision",i=>{const r=i;t.events.emit("postcollision",new gn(r.self,r.other,r.side,r.intersection,r.contact)),t instanceof Ni&&t.onPostCollisionResolve(r.self,r.other,r.side,r.contact)}),this.events.on("collisionstart",i=>{const r=i;t.events.emit("collisionstart",new xo(r.self,r.other,r.side,r.contact)),t instanceof Ni&&t.onCollisionStart(r.self,r.other,r.side,r.contact)}),this.events.on("collisionend",i=>{const r=i;t.events.emit("collisionend",new bo(r.self,r.other,r.side,r.lastContact)),t instanceof Ni&&t.onCollisionEnd(r.self,r.other,r.side,r.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(t,i,r=rt.Half,o=rt.Zero){const h=Pi.Box(t,i,r,o);return this.set(h)}usePolygonCollider(t,i=rt.Zero){const r=Pi.Polygon(t,i);return this.set(r)}useCircleCollider(t,i=rt.Zero){const r=Pi.Circle(t,i);return this.set(r)}useEdgeCollider(t,i){const r=Pi.Edge(t,i);return this.set(r)}useCompositeCollider(t){return this.set(new fi(t))}}var ji;(function(c){c.Rotation="rotation",c.X="x",c.Y="y"})(ji||(ji={}));class fe extends ls{constructor(t){var i,r,o;super(),this.dependencies=[qt,we],this.id=ln("body",fe._ID++),this.events=new Ue,this.oldTransform=new rr,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=ie.PreventCollision,this.group=nr.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=rt.Zero,this.oldVel=new rt(0,0),this.oldAcc=rt.Zero,this._impulseScratch=ft(0,0),this._distanceFromCenterScratch=ft(0,0),t?(this.collisionType=(i=t.type)!==null&&i!==void 0?i:this.collisionType,this.group=(r=t.group)!==null&&r!==void 0?r:this.group,this.useGravity=(o=t.useGravity)!==null&&o!==void 0?o:this.useGravity,this._bodyConfig={...sr().bodies,...t.config}):this._bodyConfig={...sr().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=fe._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(t){this._bodyConfig={...sr().bodies,...t},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(t){fe._DEFAULT_CONFIG=t}get mass(){return this._mass}set mass(t){this._mass=t,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===ie.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(t){this.isSleeping=t}set isSleeping(t){this._sleeping=t,t?(this.vel=rt.Zero,this.acc=rt.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const t=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),i=this._bodyConfig.sleepBias;this.sleepMotion=i*this.sleepMotion+(1-i)*t,this.sleepMotion=ce(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const t=this.owner.get(ei);if(t){t.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),t.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const i=t.get();if(i)return this._cachedInertia=i.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===ie.Fixed?0:1/this.inertia}get active(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get isActive(){var t;return!!(!((t=this.owner)===null||t===void 0)&&t.isActive)}get center(){return this.globalPos}onAdd(t){var i,r;this.transform=(i=this.owner)===null||i===void 0?void 0:i.get(qt),this.motion=(r=this.owner)===null||r===void 0?void 0:r.get(we)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get globalPos(){return this.transform.globalPos}set globalPos(t){this.transform.globalPos=t}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t}get torque(){return this.motion.torque}set torque(t){this.motion.torque=t}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(t){this.transform.globalRotation=t}get scale(){return this.transform.globalScale}set scale(t){this.transform.globalScale=t}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(t){this.motion.scaleFactor=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}applyImpulse(t,i){if(this.collisionType!==ie.Active)return;const r=i.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(ji.X)>-1&&(r.x=0),this.limitDegreeOfFreedom.indexOf(ji.Y)>-1&&(r.y=0),this.vel.addEqual(r),!this.limitDegreeOfFreedom.includes(ji.Rotation)){const o=t.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*o.cross(i)}}applyLinearImpulse(t){if(this.collisionType!==ie.Active)return;const i=t.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(ji.X)&&(i.x=0),this.limitDegreeOfFreedom.includes(ji.Y)&&(i.y=0),this.vel=this.vel.add(i)}applyAngularImpulse(t,i){if(this.collisionType===ie.Active&&!this.limitDegreeOfFreedom.includes(ji.Rotation)){const r=t.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*r.cross(i)}}captureOldTransform(){this.__oldTransformCaptured=!0;const t=this.transform.get();t.clone(this.oldTransform),this.oldTransform.parent=t.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}fe._ID=0;fe._DEFAULT_CONFIG={...sr().bodies};class No extends Vn{constructor(t){super(t),this.width=t.width,this.height=t.height,this.rasterize()}clone(){return new No({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.color&&t.fillRect(0,0,this.width,this.height),this.strokeColor&&t.strokeRect(0,0,this.width,this.height)}}class Ja extends Vn{get radius(){return this._radius}set radius(t){this._radius=t,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(t){var i,r,o;super(t),this._radius=0;const h=(i=t.lineWidth)!==null&&i!==void 0?i:t.strokeColor?1:0;this.padding=(r=t.padding)!==null&&r!==void 0?r:2+h/2,this.radius=t.radius,this.filtering=(o=t.filtering)!==null&&o!==void 0?o:ii.Blended,this.rasterize()}clone(){return new Ja({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){this.radius>0&&(t.beginPath(),t.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&t.fill(),this.strokeColor&&t.stroke())}}class Tr extends ls{constructor(t){var i,r;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(i=t==null?void 0:t.useColliderShape)!==null&&i!==void 0?i:this.useColliderShape,this.useGraphicsBounds=(r=t==null?void 0:t.useGraphicsBounds)!==null&&r!==void 0?r:this.useGraphicsBounds,this.localBounds=t==null?void 0:t.localBounds}}class Ee{static CreateReversibleEasingFunction(t){return(i,r,o,h)=>o<r?r-(t(i,o,r,h)-o):t(i,r,o,h)}static CreateVectorEasingFunction(t){return(i,r,o,h)=>new rt(t(i,r.x,o.x,h),t(i,r.y,o.y,h))}}Ee.Linear=Ee.CreateReversibleEasingFunction((c,t,i,r)=>(i=i-t,i*c/r+t));Ee.EaseInQuad=Ee.CreateReversibleEasingFunction((c,t,i,r)=>(i=i-t,c/=r,i*c*c+t));Ee.EaseOutQuad=Ee.CreateReversibleEasingFunction((c,t,i,r)=>(i=i-t,c/=r,-i*c*(c-2)+t));Ee.EaseInOutQuad=Ee.CreateReversibleEasingFunction((c,t,i,r)=>(i=i-t,c/=r/2,c<1?i/2*c*c+t:(c--,-i/2*(c*(c-2)-1)+t)));Ee.EaseInCubic=Ee.CreateReversibleEasingFunction((c,t,i,r)=>(i=i-t,c/=r,i*c*c*c+t));Ee.EaseOutCubic=Ee.CreateReversibleEasingFunction((c,t,i,r)=>(i=i-t,c/=r,c--,i*(c*c*c+1)+t));Ee.EaseInOutCubic=Ee.CreateReversibleEasingFunction((c,t,i,r)=>(i=i-t,c/=r/2,c<1?i/2*c*c*c+t:(c-=2,i/2*(c*c*c+2)+t)));class Ju{constructor(t){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=t}add(t){this._actions.push(t)}remove(t){const i=this._actions.indexOf(t);this._actions.splice(i,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const t=this._actions.length;for(let i=0;i<t;i++)this._actions[i].reset();this._completedActions=[]}update(t){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new hc(this._currentAction,this._entity))),this._currentAction.update(t),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new lc(this._currentAction,this._entity));const i=this._actions.shift();i&&this._completedActions.push(i)}}}let Lp=0;function be(){return Lp++}class Ku{constructor(t,i,r){this.id=be(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new Ho(t),this._actionQueue=this._repeatContext.getQueue(),this._repeat=r,this._originalRepeat=r,this._repeatBuilder(this._repeatContext),this._repeat--}update(t){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(t)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class tg{constructor(t,i){this.id=be(),this._stopped=!1,this._repeatBuilder=i,this._repeatContext=new Ho(t),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(t){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(t))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function eg(c,t,i){return(1-i)*c+t*i}function _c(c,t,i,r){const o=(c-t+ni)%ni>=Math.PI,h=Math.abs(t-c),u=ni-h;let _=0,A=0;h>u?(_=u,A=h):(_=h,A=u);let y=0,w=1;switch(i){case Ge.ShortestPath:y=_,w=o?1:-1;break;case Ge.LongestPath:y=A,w=o?-1:1;break;case Ge.Clockwise:w=1,y=o?_:A;break;case Ge.CounterClockwise:w=-1,y=o?A:_;break}return c+w*(y*r)}function Go(c,t,i){return c.scale(1-i).add(t.scale(i))}function ig(c,t,i){return(i-c)/(t-c)}function sg(c,t,i){const r=i.sub(c),o=t.sub(c),h=r.x/o.x,u=r.y/o.y;return Math.min(h,u)}function Ns(c,t,i,r,o){const h=ig(c,t,o);return eg(i,r,h)}function zp(c,t,i,r,o){const h=sg(c,t,o);return Go(i,r,h)}function rg(c){return c.offset instanceof rt&&typeof c.duration=="number"}class ng{constructor(t,i){var r;if(this.entity=t,this.id=be(),this._started=!1,this._stopped=!1,this._easing=Ee.Linear,this._offset=i.offset,this._easing=(r=i.easing)!==null&&r!==void 0?r:this._easing,this._tx=t.get(qt),this._motion=t.get(we),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=t;const i=ce(Ns(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),u=(o-r.x)/(t/1e3),_=(h-r.y)/(t/1e3);this._motion.vel.x=u,this._motion.vel.y=_,this.isComplete(this.entity)&&(this._tx.pos=ft(this._end.x,this._end.y),this._motion.vel=ft(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=ft(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class yl{constructor(t,i,r,o){if(this.id=be(),this._started=!1,this._stopped=!1,this._entity=t,this._tx=t.get(qt),this._motion=t.get(we),this._speed=o,this._offset=new rt(i,r),o<=0)throw $t.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+o),new Error("Speed must be greater than 0 pixels per second")}update(t){this._started||(this._started=!0,this._start=new rt(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=ft(this._end.x,this._end.y),this._motion.vel=ft(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(t){const i=t.get(qt);return this._stopped||i.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=ft(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function og(c){return c.pos instanceof rt&&typeof c.duration=="number"}class ag{constructor(t,i){var r;if(this.entity=t,this.id=be(),this._started=!1,this._stopped=!1,this._easing=Ee.Linear,this._end=i.pos,this._easing=(r=i.easing)!==null&&r!==void 0?r:this._easing,this._tx=t.get(qt),this._motion=t.get(we),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=t;const i=ce(Ns(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=this._tx.pos,o=this._easing(i,this._start.x,this._end.x,1),h=this._easing(i,this._start.y,this._end.y,1),u=(o-r.x)/(t/1e3),_=(h-r.y)/(t/1e3);this._motion.vel.x=u,this._motion.vel.y=_,this.isComplete(this.entity)&&(this._tx.pos=ft(this._end.x,this._end.y),this._motion.vel=ft(0,0))}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.vel=ft(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class xl{constructor(t,i,r,o){this.entity=t,this.id=be(),this._started=!1,this._stopped=!1,this._tx=t.get(qt),this._motion=t.get(we),this._end=new rt(i,r),this._speed=o}update(t){this._started||(this._started=!0,this._start=new rt(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const i=this._dir.scale(this._speed);this._motion.vel=ft(i.x,i.y),this.isComplete(this.entity)&&(this._tx.pos=ft(this._end.x,this._end.y),this._motion.vel=ft(0,0))}isComplete(t){const i=t.get(qt);return this._stopped||new rt(i.pos.x,i.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=ft(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Up(c){return typeof c.angle=="number"&&typeof c.duration=="number"}class hg{constructor(t,i){var r;if(this.entity=t,this.id=be(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=i.angle,this._tx=t.get(qt),this._motion=t.get(we),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(r=i.rotationType)!==null&&r!==void 0?r:Ge.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=t;const i=ce(Ns(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=_c(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(r-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(t){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class lg{constructor(t,i,r,o){this.id=be(),this._started=!1,this._stopped=!1,this._tx=t.get(qt),this._motion=t.get(we),this._end=i,this._speed=r,this._rotationType=o||Ge.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const i=Math.abs(this._end-this._start),r=ni-i;switch(i>r?(this._shortDistance=r,this._longDistance=i):(this._shortDistance=i,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+ni)%ni>=Math.PI,this._rotationType){case Ge.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case Ge.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case Ge.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case Ge.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Np(c){return typeof c.angleRadiansOffset=="number"&&typeof c.duration=="number"}class cg{constructor(t,i){var r;if(this.entity=t,this.id=be(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=i.angleRadiansOffset,this._tx=t.get(qt),this._motion=t.get(we),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._rotationType=(r=i.rotationType)!==null&&r!==void 0?r:Ge.ShortestPath,this._currentMs=this._durationMs}update(t){this._started||(this._startAngle=this._tx.rotation,this._endAngle=er(this._startAngle+this._offset),this._started=!0),this._currentMs-=t;const i=ce(Ns(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=_c(this._startAngle,this._endAngle,this._rotationType,i),o=this._tx.rotation,h=(r-o)/(t/1e3);this._motion.angularVelocity=h,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class dg{constructor(t,i,r,o){this.id=be(),this._started=!1,this._stopped=!1,this._tx=t.get(qt),this._motion=t.get(we),this._speed=r,this._offset=i,this._rotationType=o||Ge.ShortestPath}update(t){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const i=Math.abs(this._end-this._start),r=ni-i;switch(i>r?(this._shortDistance=r,this._longDistance=i):(this._shortDistance=i,this._longDistance=r),this._shortestPathIsPositive=(this._start-this._end+ni)%ni>=Math.PI,this._rotationType){case Ge.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case Ge.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case Ge.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case Ge.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(t/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const t=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||t>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function ug(c){return typeof c.scale=="object"&&typeof c.duration=="number"}class gg{constructor(t,i){if(this.entity=t,this.id=be(),this._started=!1,this._stopped=!1,this._endScale=ft(1,1),this._startScale=ft(1,1),this._endScale=i.scale,this._tx=t.get(qt),this._motion=t.get(we),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=t;const i=ce(Ns(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Go(this._startScale,this._endScale,i),o=this._tx.scale,h=r.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=rt.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class fg{constructor(t,i,r,o,h){this.id=be(),this._started=!1,this._stopped=!1,this._tx=t.get(qt),this._motion=t.get(we),this._endX=i,this._endY=r,this._speedX=o,this._speedY=h}update(t){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*i}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const i=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*i}this.isComplete()&&(this._tx.scale=ft(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function _g(c){return typeof c.scaleOffset=="object"&&typeof c.duration=="number"}class pg{constructor(t,i){if(this.entity=t,this.id=be(),this._started=!1,this._stopped=!1,this._endScale=ft(1,1),this._scaleOffset=ft(0,0),this._startScale=ft(1,1),this._scaleOffset=i.scaleOffset,this._tx=t.get(qt),this._motion=t.get(we),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=i.duration,this._currentMs=this._durationMs}update(t){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=t;const i=ce(Ns(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),r=Go(this._startScale,this._endScale,i),o=this._tx.scale,h=r.sub(o).scale(1/(t/1e3));this._motion.scaleFactor=h,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=rt.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Ag{constructor(t,i,r,o){this.id=be(),this._started=!1,this._stopped=!1,this._tx=t.get(qt),this._motion=t.get(we),this._offset=new rt(i,r),this._speedX=this._speedY=o}update(t){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class vu{constructor(t){this.id=be(),this._hasBeenCalled=!1,this._method=t}update(t){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class mg{constructor(t,i,r,o,h){this.easingFcn=h,this.id=be(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new rt(0,0),this._lerpEnd=new rt(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(qt),this._motion=t.get(we),this._lerpDuration=o,this._lerpEnd=new rt(i,r)}_initialize(){this._lerpStart=new rt(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=ft((i-this._tx.pos.x)/(t/1e3),(r-this._tx.pos.y)/(t/1e3))):(this._tx.pos=ft(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=rt.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=ft(0,0),this._stopped=!0}}class vg{constructor(t,i,r,o,h){this.easingFcn=h,this.id=be(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new rt(0,0),this._lerpEnd=new rt(0,0),this._initialized=!1,this._stopped=!1,this._tx=t.get(qt),this._motion=t.get(we),this._lerpDuration=o,this._offset=new rt(i,r)}_initialize(){this._lerpStart=new rt(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(t){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=t;let i=this._tx.pos.x,r=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?i=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):i=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?r=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):r=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=ft((i-this._tx.pos.x)/(t/1e3),(r-this._tx.pos.y)/(t/1e3))):(this._tx.pos=ft(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=rt.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=ft(0,0),this._stopped=!0}}class wg{constructor(t,i,r,o=1){this.id=be(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=t.get(He),this._timeVisible=i,this._timeNotVisible=r,this._duration=(i+r)*o}update(t){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=t,this._totalTime+=t,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class yg{constructor(t,i,r){this.id=be(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=t.get(He),this._endOpacity=i,this._remainingTime=this._originalTime=r}update(t){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*t)/this._remainingTime),this._remainingTime-=t,this.isComplete()&&(this._graphics.opacity=this._endOpacity),$t.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class xg{constructor(t){this.id=be(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=t}update(t){this._started||(this._started=!0),this._elapsedTime+=t}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class bg{constructor(t){this.id=be(),this._stopped=!1,this._entity=t}update(t){this._entity.get(Qn).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class bl{constructor(t,i,r){this.id=be(),this._started=!1,this._stopped=!1,this._tx=t.get(qt),this._motion=t.get(we),this._followTx=i.get(qt),this._followMotion=i.get(we),this._current=new rt(this._tx.pos.x,this._tx.pos.y),this._end=new rt(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=r!==void 0?r:this._current.distance(this._end),this._speed=0}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(i!==0&&(this._speed=i),this._current=ft(this._tx.pos.x,this._tx.pos.y),this._end=ft(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const r=this._dir.scale(this._speed);this._motion.vel=ft(r.x,r.y)}else this._motion.vel=ft(0,0);this.isComplete()&&(this._tx.pos=ft(this._end.x,this._end.y),this._motion.vel=ft(0,0))}stop(){this._motion.vel=ft(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class Cl{constructor(t,i,r){this.id=be(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=t.get(qt),this._motion=t.get(we),this._meetTx=i.get(qt),this._meetMotion=i.get(we),this._current=new rt(this._tx.pos.x,this._tx.pos.y),this._end=new rt(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=r||0,r!==void 0&&(this._speedWasSpecified=!0)}update(t){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const i=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));i!==0&&!this._speedWasSpecified&&(this._speed=i),this._current=ft(this._tx.pos.x,this._tx.pos.y),this._end=ft(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const r=this._dir.scale(this._speed);this._motion.vel=ft(r.x,r.y),this.isComplete()&&(this._tx.pos=ft(this._end.x,this._end.y),this._motion.vel=ft(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=ft(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class Cg{constructor(t,i,r=1e3){var o;this.id=be(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=t.get(He),this._duration=r,this._entity=t,this._material=(o=t.scene)===null||o===void 0?void 0:o.engine.graphicsContext.createMaterial({name:"flash-material",color:i,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=r}update(t){var i;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=t,this._graphics&&((i=this._material)===null||i===void 0||i.update(r=>{r.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class Oo{constructor(t){var i;if(this._distLookup=[],this.quality=4,t.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...t.controlPoints],this.quality=(i=t.quality)!==null&&i!==void 0?i:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(t){this._controlPoints=[...t],this._calculateLookup()}setControlPoint(t,i){this._controlPoints[t]=i,this._calculateLookup()}_calculateLookup(){let t=0;this._distLookup.length=0;let i=this.controlPoints[0];const r=this.controlPoints.length*this.quality;for(let o=0;o<r;o++){const h=o/(r-1),u=this.getPoint(h),_=i.distance(u);t+=_,this._distLookup.push(t),i=u}this._arcLength=t}_getTimeGivenDistance(t){const i=this._distLookup.length,r=this.arcLength;if(t>=0&&t<r){for(let o=0;o<i-1;o++)if(this._distLookup[o]<=t&&t<this._distLookup[o+1])return Ns(this._distLookup[o],this._distLookup[o+1],o/(i-1),(o+1)/(i-1),t)}return t/r}getPoint(t){const i=[...this.controlPoints];for(let r=1;r<i.length;r++)for(let o=0;o<i.length-r;o++)i[o]=Go(i[o],i[o+1],t);return i[0]}getTangent(t){const i=t*t,r=this.controlPoints[0],o=this.controlPoints[1],h=this.controlPoints[2],u=this.controlPoints[3];return r.scale(-3*i+6*t-3).add(o.scale(9*i-12*t+3).add(h.scale(-9*i+6*t).add(u.scale(3*i)))).normalize()}getUniformTangent(t){const i=t*this.arcLength,r=this._getTimeGivenDistance(i);return this.getTangent(r)}getNormal(t){return this.getTangent(t).normal()}getUniformNormal(t){return this.getUniformTangent(t).normal()}getUniformPoint(t){const i=t*this.arcLength,r=this._getTimeGivenDistance(i);return this.getPoint(r)}clone(){return new Oo({controlPoints:[...this.controlPoints],quality:this.quality})}}class Eg{constructor(t,i){var r;if(this.id=be(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(qt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new Oo({controlPoints:[ft(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(r=i.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=t;const i=ce(Ns(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class Ig{constructor(t,i){var r;if(this.id=be(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=t,this._tx=this._entity.get(qt),!this._tx)throw new Error(`Entity ${t.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new Oo({controlPoints:[ft(0,0),...i.controlPoints],quality:i.quality}),this._durationMs=i.duration,this._mode=(r=i.mode)!==null&&r!==void 0?r:this._mode,this._currentMs=this._durationMs}update(t){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=t;const i=ce(Ns(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(i):this._tx.pos=this._curve.getUniformPoint(i),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(t){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class Ho{constructor(t){this._entity=t,this._queue=new Ju(t)}getQueue(){return this._queue}update(t){this._queue.update(t)}clearActions(){this._queue.clearActions()}runAction(t){return t.reset(),this._queue.add(t),this}curveBy(t){return this._queue.add(new Ig(this._entity,t)),this}curveTo(t){return this._queue.add(new Eg(this._entity,t)),this}easeTo(...t){var i,r;let o=0,h=0,u=0,_=Ee.Linear;return t[0]instanceof rt?(o=t[0].x,h=t[0].y,u=t[1],_=(i=t[2])!==null&&i!==void 0?i:_):(o=t[0],h=t[1],u=t[2],_=(r=t[3])!==null&&r!==void 0?r:_),this._queue.add(new mg(this._entity,o,h,u,_)),this}easeBy(...t){var i,r;let o=0,h=0,u=0,_=Ee.Linear;return t[0]instanceof rt?(o=t[0].x,h=t[0].y,u=t[1],_=(i=t[2])!==null&&i!==void 0?i:_):(o=t[0],h=t[1],u=t[2],_=(r=t[3])!==null&&r!==void 0?r:_),this._queue.add(new vg(this._entity,o,h,u,_)),this}moveTo(t,i,r){let o=0,h=0,u=0;return t instanceof rt?(o=t.x,h=t.y,u=+(i??0),this._queue.add(new xl(this._entity,o,h,u))):typeof t=="number"&&typeof i=="number"&&typeof r=="number"?(o=t,h=i,u=r,this._queue.add(new xl(this._entity,o,h,u))):og(t)&&this._queue.add(new ag(this._entity,t)),this}moveBy(t,i,r){let o=0,h=0,u=0;return t instanceof rt&&typeof i=="number"?(o=t.x,h=t.y,u=i,this._queue.add(new yl(this._entity,o,h,u))):typeof t=="number"&&typeof i=="number"&&typeof r=="number"?(o=t,h=i,u=r,this._queue.add(new yl(this._entity,o,h,u))):rg(t)&&this._queue.add(new ng(this._entity,t)),this}rotateTo(t,i,r){return typeof t=="number"&&typeof i=="number"?this._queue.add(new lg(this._entity,t,i,r)):typeof t=="object"&&this._queue.add(new hg(this._entity,t)),this}rotateBy(t,i,r){return typeof t=="object"?this._queue.add(new cg(this._entity,t)):this._queue.add(new dg(this._entity,t,i,r)),this}scaleTo(t,i,r,o){let h=1,u=1,_=0,A=0;return ug(t)?(this._queue.add(new gg(this._entity,t)),this):(t instanceof rt&&i instanceof rt&&(h=t.x,u=t.y,_=i.x,A=i.y),typeof t=="number"&&typeof i=="number"&&(h=t,u=i,_=r,A=o),this._queue.add(new fg(this._entity,h,u,_,A)),this)}scaleBy(t,i,r){if(_g(t))return this._queue.add(new pg(this._entity,t)),this;let o=1,h=1;return t instanceof rt&&(o=t.x,h=t.y,r=i),typeof t=="number"&&typeof i=="number"&&(o=t,h=i),this._queue.add(new Ag(this._entity,o,h,r)),this}blink(t,i,r=1){return this._queue.add(new wg(this._entity,t,i,r)),this}fade(t,i){return this._queue.add(new yg(this._entity,t,i)),this}flash(t,i=1e3){return this._queue.add(new Cg(this._entity,t,i)),this}delay(t){return this._queue.add(new xg(t)),this}die(){return this._queue.add(new bg(this._entity)),this}callMethod(t){return this._queue.add(new vu(t)),this}repeat(t,i){return i?(this._queue.add(new Ku(this._entity,t,i)),this):(this.repeatForever(t),this)}repeatForever(t){return this._queue.add(new tg(this._entity,t)),this}follow(t,i){return i===void 0?this._queue.add(new bl(this._entity,t)):this._queue.add(new bl(this._entity,t,i)),this}meet(t,i){return i===void 0?this._queue.add(new Cl(this._entity,t)):this._queue.add(new Cl(this._entity,t,i)),this}toPromise(){return new Promise(i=>{this._queue.add(new vu(()=>{i()}))})}}class Qn extends ls{constructor(){super(...arguments),this.dependencies=[qt,we],this._ctx=null}onAdd(t){this._ctx=new Ho(t)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(t){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(t)}update(t){var i;return(i=this._ctx)===null||i===void 0?void 0:i.update(t)}clearActions(){var t;(t=this._ctx)===null||t===void 0||t.clearActions()}curveBy(t){return this._getCtx().curveBy.apply(this._ctx,[t])}curveTo(t){return this._getCtx().curveTo.apply(this._ctx,[t])}easeTo(...t){return this._getCtx().easeTo.apply(this._ctx,t)}easeBy(...t){return this._getCtx().easeBy.apply(this._ctx,t)}moveTo(t,i,r){return this._getCtx().moveTo.apply(this._ctx,[t,i,r])}moveBy(t,i,r){return this._getCtx().moveBy.apply(this._ctx,[t,i,r])}rotateTo(t,i,r){return this._getCtx().rotateTo.apply(this._ctx,[t,i,r])}rotateBy(t,i,r){return this._getCtx().rotateBy.apply(this._ctx,[t,i,r])}scaleTo(t,i,r,o){return this._getCtx().scaleTo.apply(this._ctx,[t,i,r,o])}scaleBy(t,i,r){return this._getCtx().scaleBy.apply(this._ctx,[t,i,r])}blink(t,i,r){return this._getCtx().blink(t,i,r)}fade(t,i){return this._getCtx().fade(t,i)}flash(t,i=1e3){return this._getCtx().flash(t,i)}delay(t){return this._getCtx().delay(t)}die(){return this._getCtx().die()}callMethod(t){return this._getCtx().callMethod(t)}repeat(t,i){return this._getCtx().repeat(t,i)}repeatForever(t){return this._getCtx().repeatForever(t)}follow(t,i){return this._getCtx().follow(t,i)}meet(t,i){return this._getCtx().meet(t,i)}toPromise(){return this._getCtx().toPromise()}}function Gp(c){return c instanceof Ni}const Op={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class Ni extends Di{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(t){this.body.oldPos.setTo(t.x,t.y)}get vel(){return this.motion.vel}set vel(t){this.motion.vel=t.clone()}get oldVel(){return this.body.oldVel}set oldVel(t){this.body.oldVel.setTo(t.x,t.y)}get acc(){return this.motion.acc}set acc(t){this.motion.acc=t.clone()}set oldAcc(t){this.body.oldAcc.setTo(t.x,t.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(t){this.motion.angularVelocity=t}get scale(){return this.get(qt).scale}set scale(t){this.get(qt).scale=t}get anchor(){return this._anchor}set anchor(t){this._anchor=ws(t,i=>this._handleAnchorChange(i)),this._handleAnchorChange(t)}_handleAnchorChange(t){this.graphics&&(this.graphics.anchor=t)}get offset(){return this._offset}set offset(t){this._offset=ws(t,i=>this._handleOffsetChange(i)),this._handleOffsetChange(t)}_handleOffsetChange(t){this.graphics&&(this.graphics.offset=t)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(t){t&&(t&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!t&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=t)}get color(){return this.graphics.color}set color(t){this.graphics.color=t}constructor(t){super(),this.events=new Ue,this._anchor=ws(rt.Half,ot=>this._handleAnchorChange(ot)),this._offset=ws(rt.Zero,ot=>this._handleOffsetChange(ot)),this.logger=$t.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=ot=>{this._dragging&&(this.pos=ot.worldPos)},this._pointerDragLeaveHandler=ot=>{this._dragging&&(this.pos=ot.worldPos)};const{name:i,x:r,y:o,pos:h,coordPlane:u,scale:_,width:A,height:y,radius:w,collider:f,vel:T,acc:C,rotation:S,angularVelocity:E,z:W,color:D,visible:H,opacity:k,anchor:N,offset:Q,collisionType:L,collisionGroup:O,silenceWarnings:Y}={...t};this.name=i??this.name,this.anchor=N??Ni.defaults.anchor.clone(),this.offset=Q??rt.Zero,this.transform=new qt,this.addComponent(this.transform),this.pos=h??ft(r??0,o??0),this.rotation=S??0,this.scale=_??ft(1,1),this.z=W??0,this.transform.coordPlane=u??yi.World,this._silenceWarnings=Y??!1,this.pointer=new Tr,this.addComponent(this.pointer),this.graphics=new He({anchor:this.anchor,offset:this.offset,opacity:k}),this.addComponent(this.graphics),this.motion=new we,this.addComponent(this.motion),this.vel=T??rt.Zero,this.acc=C??rt.Zero,this.angularVelocity=E??0,this.actions=new Qn,this.addComponent(this.actions),this.body=new fe,this.addComponent(this.body),this.body.collisionType=L??ie.Passive,O&&(this.body.group=O),D&&(this.color=D),f?(this.collider=new ei(f),this.addComponent(this.collider)):w?(this.collider=new ei(Pi.Circle(w)),this.addComponent(this.collider),D&&this.graphics.add(new Ja({color:D,radius:w}))):A>0&&y>0?(this.collider=new ei(Pi.Box(A,y,this.anchor)),this.addComponent(this.collider),D&&A&&y&&this.graphics.add(new No({color:D,width:A,height:y}))):(this.collider=new ei,this.addComponent(this.collider)),this.graphics.isVisible=H??!0}clone(){const t=new Ni({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});t.clearComponents(),t.processComponentRemoval(),t.addComponent(t.transform=this.transform.clone(),!0),t.addComponent(t.pointer=this.pointer.clone(),!0),t.addComponent(t.graphics=this.graphics.clone(),!0),t.addComponent(t.motion=this.motion.clone(),!0),t.addComponent(t.actions=this.actions.clone(),!0),t.addComponent(t.body=this.body.clone(),!0),t.addComponent(t.collider=this.collider.clone(),!0);const i=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],r=this.getComponents();for(const o of r)i.includes(o)||t.addComponent(o.clone(),!0);return t}onInitialize(t){}_initialize(t){super._initialize(t);for(const i of this.children)i._initialize(t)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_prekill(t){this.events.emit("prekill",new Nl(this)),this.onPreKill(t)}onPreKill(t){}_postkill(t){this.events.emit("postkill",new Gl(this)),this.onPostKill(t)}onPostKill(t){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Ya(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(qt).z}set z(t){this.get(qt).z=t}get center(){const t=this.getGlobalPos();return new rt(t.x+this.width/2-this.anchor.x*this.width,t.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new rt(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(qt).globalRotation}get globalRotation(){return this.get(qt).globalRotation}getGlobalPos(){return this.get(qt).globalPos}get globalPos(){return this.get(qt).globalPos}getGlobalScale(){return this.get(qt).globalScale}get globalScale(){return this.get(qt).globalScale}get globalZ(){return this.get(qt).globalZ}contains(t,i,r=!1){const o=ft(t,i),h=this.get(ei);h.update();const u=h.get();if(!u)return!1;const _=u.contains(o);return r?_||this.children.some(A=>A.contains(t,i,!0)):_}within(t,i){const r=this.get(ei),o=t.get(ei),h=r.get(),u=o.get();return h&&u?h.getClosestLineBetween(u).getLength()<=i:!1}update(t,i){this._initialize(t),this._add(t),this._preupdate(t,i),this._postupdate(t,i),this._remove(t)}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreCollisionResolve(t,i,r,o){}onPostCollisionResolve(t,i,r,o){}onCollisionStart(t,i,r,o){}onCollisionEnd(t,i,r,o){}_preupdate(t,i){this.events.emit("preupdate",new Sr(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.events.emit("postupdate",new Pr(t,i,this)),this.onPostUpdate(t,i)}}Ni.defaults={anchor:rt.Half};function Bg(c){return c instanceof pc}class pc extends Ni{constructor(t){var i,r;super({...t}),this.get(qt).coordPlane=yi.Screen,this.anchor=(i=t==null?void 0:t.anchor)!==null&&i!==void 0?i:ft(0,0),this.body.collisionType=(r=t==null?void 0:t.collisionType)!==null&&r!==void 0?r:ie.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!(t!=null&&t.collider)&&(t==null?void 0:t.width)>0&&(t==null?void 0:t.height)>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(t){this._engine=t,super._initialize(t)}contains(t,i,r=!0){if(r)return super.contains(t,i);const o=this._engine.worldToScreenCoordinates(new rt(t,i));return super.contains(o.x,o.y)}}class an{get complete(){return this._complete}constructor(t){var i;this._logger=$t.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const r=(i=t.action)!==null&&i!==void 0?i:t.fcn,o=t.interval,h=t.repeats,u=t.numberOfRepeats,_=t.randomRange,A=t.random;if(u&&u>=0&&(this.maxNumberOfRepeats=u,!h))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=an._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=o,_){if(_[0]>_[1])throw new Error("min value must be lower than max value for range");this.random=A??new Hn,this.randomRange=_,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=h||this.repeats,r&&this.on(r)}on(t){this._callbacks.push(t)}off(t){const i=this._callbacks.indexOf(t);this._callbacks.splice(i,1)}update(t){this._running&&(this._totalTimeAlive+=t,this._elapsedTime+=t,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(i=>{i.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(t,i){if(t&&t>=0&&(this._baseInterval=this.interval=t),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=i,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}an._MAX_ID=0;class Ka extends ls{constructor(t){super(),this.parallaxFactor=ft(1,1),this.parallaxFactor=t??this.parallaxFactor}}class th extends ls{constructor(t,i=!0){super(),this.draw=t,this.useTransform=i}}function wu(c){return c&&c._dispatchPointerEvents&&c._processPointerToObject}class Hp{get events(){return this.object.events}init(t,i,r){this.object=t,this.contains=i,this.active=r}}class Ac{constructor(){this._proxyPool=new Mo(()=>new Hp,t=>t,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(t,i,r){const o=this._proxyPool.rent(!1);o.init(t,i,r),this._proxies.push(o),this._objectToProxy.set(t,o)}_getProxy(t){const i=this._objectToProxy.get(t);if(i)return i;throw new Error("No PointerTargetProxy for object")}removeObject(t){const i=this._objectToProxy.get(t);if(i){const r=this._proxies.indexOf(i);r>-1&&this._proxies.splice(r,1),this._proxyPool.return(i)}}_objectCurrentlyUnderPointer(t,i){return!!(this._currentFrameObjectToPointers.has(t)&&this._currentFrameObjectToPointers.get(t).includes(i))}_objectWasUnderPointer(t,i){return!!(this._lastFrameObjectToPointers.has(t)&&this._lastFrameObjectToPointers.get(t).includes(i))}_entered(t,i){return this._objectCurrentlyUnderPointer(t,i)&&!this._lastFrameObjectToPointers.has(t)}_left(t,i){return!this._currentFrameObjectToPointers.has(t)&&this._objectWasUnderPointer(t,i)}addPointerToObject(t,i){const r=this._objectToProxy.get(t);r&&this._addPointerToProxy(r,i)}_addPointerToProxy(t,i){if(!this._currentFrameObjectToPointers.has(t)){this._currentFrameObjectToPointers.set(t,[i]);return}const r=this._currentFrameObjectToPointers.get(t);this._currentFrameObjectToPointers.set(t,r.concat(i))}dispatchEvents(t,i){const r=new Set(this._lastFrameObjectToPointers.keys()),o=new Set(this._currentFrameObjectToPointers.keys());let h,u,_;for(let A=0;A<i.length;A++){const y=i[A],w=this._getProxy(y);if(wu(y)&&y._dispatchPointerEvents(t),r.has(w)||o.has(w)){_=this._processDownAndEmit(t,w),u=this._processUpAndEmit(t,w),h=this._processMoveAndEmit(t,w);const f=[...h.values(),..._.values(),...u.values()];this._processEnterLeaveAndEmit(t,w,f),this._processCancelAndEmit(t,w),this._processWheelAndEmit(t,w)}}}processPointerToObject(t,i){for(let r=0;r<i.length;r++){const o=i[r],h=this._getProxy(o);wu(o)&&o._processPointerToObject(t);for(const[u,_]of t.currentFramePointerCoords.entries())h.contains(_)&&this._addPointerToProxy(h,u)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(t,i){const r=new Map;for(const o of t.currentFrameDown)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerdown",o),t.isDragStart(o.pointerId)&&i.events.emit("pointerdragstart",o)),r.set(o.pointerId,o);return r}_processUpAndEmit(t,i){const r=new Map;for(const o of t.currentFrameUp)o.active&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointerup",o),t.isDragEnd(o.pointerId)&&i.events.emit("pointerdragend",o)),r.set(o.pointerId,o);return r}_processMoveAndEmit(t,i){const r=new Map;for(const o of t.currentFrameMove)o.active&&i.active()&&this._objectCurrentlyUnderPointer(i,o.pointerId)&&(i.events.emit("pointermove",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragmove",o)),r.set(o.pointerId,o);return r}_processEnterLeaveAndEmit(t,i,r){for(const o of r){if(o.active&&i.active()&&this._entered(i,o.pointerId)){i.events.emit("pointerenter",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragenter",o);break}if(o.active&&i.active()&&(this._left(i,o.pointerId)||this._objectCurrentlyUnderPointer(i,o.pointerId)&&o.type==="up")){i.events.emit("pointerleave",o),t.isDragging(o.pointerId)&&i.events.emit("pointerdragleave",o);break}}}_processCancelAndEmit(t,i){for(const r of t.currentFrameCancel)r.active&&i.active()&&this._objectCurrentlyUnderPointer(i,r.pointerId)&&i.events.emit("pointercancel",r)}_processWheelAndEmit(t,i){for(const r of t.currentFrameWheel)r.active&&i.active()&&this._objectCurrentlyUnderPointer(i,0)&&i.events.emit("pointerwheel",r)}}const Wp={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class Tg extends Di{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let t=0;t<this.tiles.length;t++)this.tiles[t]&&this.tiles[t].flagDirty()}get x(){var t;return(t=this.transform.pos.x)!==null&&t!==void 0?t:0}set x(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.get(qt).pos=ft(t,this.y))}get y(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.pos.y)!==null&&i!==void 0?i:0}set y(t){var i;!((i=this.transform)===null||i===void 0)&&i.pos&&(this.transform.pos=ft(this.x,t))}get z(){var t;return(t=this.transform.z)!==null&&t!==void 0?t:0}set z(t){this.transform&&(this.transform.z=t)}get rotation(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.rotation)!==null&&i!==void 0?i:0}set rotation(t){this.transform&&(this.transform.rotation=t)}get scale(){var t,i;return(i=(t=this.transform)===null||t===void 0?void 0:t.scale)!==null&&i!==void 0?i:rt.One}set scale(t){var i;!((i=this.transform)===null||i===void 0)&&i.scale&&(this.transform.scale=t)}get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get vel(){return this._motion.vel}set vel(t){this._motion.vel=t}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,r,o;super([],t.name),this.events=new Ue,this._token=0,this.logger=$t.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(i=t.meshingLookBehind)!==null&&i!==void 0?i:this.meshingLookBehind,this.addComponent(new qt),this.addComponent(new we),this.addComponent(new fe({type:ie.Fixed})),this.addComponent(new He({onPostDraw:(u,_)=>this.draw(u,_)})),this.addComponent(new th((u,_)=>this.debug(u,_),!1)),this.addComponent(new ei),this.addComponent(new Tr),this.pointer=this.get(Tr),this._graphics=this.get(He),this.transform=this.get(qt),this._motion=this.get(we),this.collider=this.get(ei),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(r=t.pos)!==null&&r!==void 0?r:rt.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(o=t.renderFromTopOfGraphic)!==null&&o!==void 0?o:this.renderFromTopOfGraphic,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight,this.rows=t.rows,this.columns=t.columns,this._pointerEventDispatcher=new Ac,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let h=[];for(let u=0;u<this.columns;u++){for(let _=0;_<this.rows;_++){const A=new Sg({x:u,y:_,map:this});A.map=this,this.tiles[u+_*this.columns]=A,this._pointerEventDispatcher.addObject(A,y=>A.bounds.contains(y.worldPos),()=>!0),h.push(A),this._rows[_]||(this._rows[_]=[]),this._rows[_].push(A)}this._cols[u]=h,h=[]}this._graphics.localBounds=new Zt({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(t){super._initialize(t),this._engine=t}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:rt.Zero;{const r=t.offset;return this._originalOffsets.set(t,r),r}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const t=[];this._composite=this.collider.useCompositeCollider([]);let i=null;const r=(h,u)=>h&&u?h.top===u.top&&h.bottom===u.bottom&&h.right===u.left:!1,o=(h,u,_=this.meshingLookBehind)=>{if(!h)return!1;for(let A=u.length-1;A>=0;A--){if(_--<0)return!1;const y=u[A];if(r(y,h))return u[A]=y.combine(h),!0}return!1};for(let h=0;h<this.columns;h++){for(let u=0;u<this.rows;u++){const _=this.tiles[h+u*this.columns];if(_.solid)if(_.getColliders().length>0){for(const A of _.getColliders()){const y=this._getOrSetColliderOriginalOffset(A);A.offset=ft(_.x*this.tileWidth*this.scale.x,_.y*this.tileHeight*this.scale.y).add(y),A.owner=this,this._composite.addCollider(A)}i&&!o(i,t)&&t.push(i),i=null}else i?i=i.combine(_.defaultGeometry):i=_.defaultGeometry;else i&&!o(i,t)&&t.push(i),i=null}i&&!o(i,t)&&t.push(i),i=null}for(const h of t){const u=Pi.Box(h.width,h.height,rt.Zero,ft(h.left-this.pos.x,h.top-this.pos.y));u.owner=this,this._composite.addCollider(u)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(t){var i;return(i=this.tiles[t])!==null&&i!==void 0?i:null}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const{x:i,y:r}=this._getTileCoordinates(t),o=this.getTile(i,r);return i>=0&&r>=0&&i<this.columns&&r<this.rows&&o?o:null}_getTileCoordinates(t){t=this.transform.applyInverse(t);const i=Math.floor(t.x/this.tileWidth),r=Math.floor(t.y/this.tileHeight);return{x:i,y:r}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let t=this._engine.screen.getWorldBounds();const i=this.get(Ka);if(i&&this.isInitialized){let C=this.pos;const S=rt.One.sub(i.parallaxFactor),E=this._engine.currentScene.camera.pos.scale(S);C=C.sub(E),t=t.translate(C)}const r=this.transform.coordPlane===yi.Screen?this._engine.screen.getScreenBounds():t,o=this._getTileCoordinates(r.topLeft),h=this._getTileCoordinates(r.topRight),u=this._getTileCoordinates(r.bottomRight),_=this._getTileCoordinates(r.bottomLeft),A=Math.min(ce(o.x,0,this.columns-1),ce(h.x,0,this.columns-1)),y=Math.min(ce(o.y,0,this.rows-1),ce(h.y,0,this.rows-1)),w=Math.max(ce(u.x,0,this.columns-1),ce(_.x,0,this.columns-1)),f=Math.max(ce(u.y,0,this.rows-1),ce(_.y,0,this.rows-1)),T=[];for(let C=A;C<=w;C++)for(let S=y;S<=f;S++)T.push(this.getTile(C,S));return T}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(t,i){this._initialize(t),this.onPreUpdate(t,i),this.emit("preupdate",new Sr(t,i,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(t,i),this.emit("postupdate",new Pr(t,i,this))}draw(t,i){if(!this.isInitialized)return;this.emit("predraw",new jn(t,i,this));let r,o,h;const u=this.getOnScreenTiles();for(let _=0;_<u.length;_++){const A=u[_],y=A.getGraphicsOffsets();for(r=A.getGraphics(),o=0,h=r.length;o<h;o++){const w=r[o],f=y[o];if(w){Ul(w)&&(w==null||w.tick(i,this._token));const T=this.renderFromTopOfGraphic?0:w.height-this.tileHeight;w.draw(t,A.x*this.tileWidth+f.x,A.y*this.tileHeight-T+f.y)}}}this.emit("postdraw",new Yn(t,i,this))}debug(t,i){const{showAll:r,showGrid:o,gridColor:h,gridWidth:u,showSolidBounds:_,solidBoundsColor:A,showColliderGeometry:y}=i.tilemap,{geometryColor:w,geometryLineWidth:f,geometryPointSize:T}=i.collider,C=this.tileWidth*this.columns*this.scale.x,S=this.tileHeight*this.rows*this.scale.y,E=this.pos;if(o||r){for(let W=0;W<this.rows+1;W++){const D=ft(0,W*this.tileHeight*this.scale.y);t.drawLine(E.add(D),E.add(ft(C,D.y)),h,u)}for(let W=0;W<this.columns+1;W++){const D=ft(W*this.tileWidth*this.scale.x,0);t.drawLine(E.add(D),E.add(ft(D.x,S)),h,u)}}if(r||_||y){const W=this._composite.getColliders();t.save(),t.translate(this.pos.x,this.pos.y),t.scale(this.scale.x,this.scale.y);for(const D of W){const H=D.localBounds,k=D.worldPos.sub(this.pos);_&&t.drawRectangle(k,H.width,H.height,A)}if(t.restore(),y)for(const D of W)D.debug(t,w,{lineWidth:f,pointSize:T})}if(r||_){if(t.save(),t.z=999,_)for(let W=0;W<this.tiles.length;W++)this.tiles[W].bounds.draw(t);t.restore()}}}class Sg{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(t){var i;(i=this.map)===null||i===void 0||i.flagCollidersDirty(),this._solid=t}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(t,i){this._graphics.push(t),i!=null&&i.offset?this._offsets.push(i.offset):this._offsets.push(rt.Zero)}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&(this._graphics.splice(i,1),this._offsets.splice(i,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(t){var i,r;this._posDirty=!1,this.events=new Ue,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=t.x,this.y=t.y,this.map=t.map,this._width=t.map.tileWidth*this.map.scale.x,this._height=t.map.tileHeight*this.map.scale.y,this.solid=(i=t.solid)!==null&&i!==void 0?i:this.solid,this._graphics=(r=t.graphics)!==null&&r!==void 0?r:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const t=this.map.pos.add(ft(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new Zt(t.x,t.y,t.x+this.map.tileWidth,t.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(ft(this.x*this._width,this.y*this._height)),this._bounds=new Zt(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new rt(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){i?this.events.off(t,i):this.events.off(t)}}class Pg{constructor(t){this.camera=t}lockToActor(t){this.camera.addStrategy(new Dg(t))}lockToActorAxis(t,i){this.camera.addStrategy(new Rg(t,i))}elasticToActor(t,i,r){this.camera.addStrategy(new Fg(t,i,r))}radiusAroundActor(t,i){this.camera.addStrategy(new Mg(t,i))}limitCameraBounds(t){this.camera.addStrategy(new kg(t))}}var Wa;(function(c){c[c.X=0]="X",c[c.Y=1]="Y"})(Wa||(Wa={}));class Dg{constructor(t){this.target=t,this.action=(i,r,o,h)=>i.center}}class Rg{constructor(t,i){this.target=t,this.axis=i,this.action=(r,o,h,u)=>{const _=r.center,A=o.getFocus();return this.axis===Wa.X?new rt(_.x,A.y):new rt(A.x,_.y)}}}class Fg{constructor(t,i,r){this.target=t,this.cameraElasticity=i,this.cameraFriction=r,this.action=(o,h,u,_)=>{const A=o.center;let y=h.getFocus(),w=h.vel.clone();const f=A.sub(y).scale(this.cameraElasticity);w=w.add(f);const T=w.scale(-1).scale(this.cameraFriction);return w=w.add(T),y=y.add(w),y}}}class Mg{constructor(t,i){this.target=t,this.radius=i,this.action=(r,o,h,u)=>{const _=r.center,A=o.getFocus(),y=_.sub(A),w=y.magnitude;if(w>=this.radius){const f=w-this.radius;return A.add(y.normalize().scale(f))}return A}}}class kg{constructor(t){this.target=t,this.boundSizeChecked=!1,this.action=(i,r,o,h)=>{const u=r.getFocus();this.boundSizeChecked||((i.bottom-i.top<o.drawHeight||i.right-i.left<o.drawWidth)&&$t.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let _=u.x,A=u.y;return u.x<i.left+o.halfDrawWidth?_=i.left+o.halfDrawWidth:u.x>i.right-o.halfDrawWidth&&(_=i.right-o.halfDrawWidth),u.y<i.top+o.halfDrawHeight?A=i.top+o.halfDrawHeight:u.y>i.bottom-o.halfDrawHeight&&(A=i.bottom-o.halfDrawHeight),ft(_,A)}}}const qp={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class Qg{constructor(){this.events=new Ue,this.transform=ti.identity(),this.inverse=ti.identity(),this._cameraStrategies=[],this.strategy=new Pg(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new Er(rt.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=rt.Zero,this.acc=rt.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Ee.EaseInOutCubic,this._easing=Ee.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=ft(0,0)}get zoom(){return this._z}set zoom(t){this._z=t,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(t){this._angularVelocity=t}get pos(){return this._pos}set pos(t){this._posChanged=!0,this._pos=new Er(t,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(t){!this._follow&&!this._cameraMoving&&(this.pos=ft(t,this.pos.y))}get y(){return this.pos.y}set y(t){!this._follow&&!this._cameraMoving&&(this.pos=ft(this.pos.x,t))}get dx(){return this.vel.x}set dx(t){this.vel=ft(t,this.vel.y)}get dy(){return this.vel.y}set dy(t){this.vel=ft(this.vel.x,t)}get ax(){return this.acc.x}set ax(t){this.acc=ft(t,this.acc.y)}get ay(){return this.acc.y}set ay(t){this.acc=ft(this.acc.x,t)}getFocus(){return this.pos}move(t,i,r=Ee.EaseInOutCubic){if(typeof r!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(t):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(t),this._lerpPromise=new Promise(o=>{this._lerpResolve=o}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=i,this._lerpEnd=t,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=r,this._lerpPromise)}shake(t,i,r){this._isShaking=!0,this._shakeMagnitudeX=t,this._shakeMagnitudeY=i,this._shakeDuration=r}zoomOverTime(t,i=0,r=Ee.EaseInOutCubic){if(this._zoomPromise=new Promise(o=>{this._zoomResolve=o}),i)this._isZooming=!0,this._zoomEasing=r,this._currentZoomTime=0,this._zoomDuration=i,this._zoomStart=this.zoom,this._zoomEnd=t;else return this._isZooming=!1,this.zoom=t,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new Zt(0,0,0,0)}addStrategy(t){this._cameraStrategies.push(t)}removeStrategy(t){Wn(t,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(t,i){this.events.emit("preupdate",new Sr(t,i,this)),this.onPreUpdate(t,i)}onPreUpdate(t,i){}_postupdate(t,i){this.events.emit("postupdate",new Pr(t,i,this)),this.onPostUpdate(t,i)}onPostUpdate(t,i){}get isInitialized(){return this._isInitialized}_initialize(t){if(!this.isInitialized){this._engine=t,this._screen=t.screen;const i=this._screen.contentArea;let r=ft(i.width/2,i.height/2);if(!this._engine.loadingComplete){const o=this._screen.peekResolution();o&&(r=ft(o.width/2,o.height/2))}this._halfWidth=r.x,this._halfHeight=r.y,this._posChanged||(this.pos=r),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(t,t.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(t),this.events.emit("initialize",new Xn(t,this)),this._isInitialized=!0}}onInitialize(t){}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}runStrategies(t,i){for(const r of this._cameraStrategies)this.pos=r.action.call(r,r.target,this,t,i)}updateViewport(){this._viewport=new Zt(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(t,i){if(this._initialize(t),this._preupdate(t,i),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(i/1e3)),this.zoom+=this.dz*i/1e3,this.vel=this.vel.add(this.acc.scale(i/1e3)),this.dz+=this.az*i/1e3,this.rotation+=this.angularVelocity*i/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const r=this._zoomEasing,o=r(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=o,this._currentZoomTime+=i}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const o=Ee.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=o,this._currentLerpTime+=i}else{this.pos=this._lerpEnd;const r=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(r)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=i,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(t,i),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(t,i),this._posChanged=!1}draw(t){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const i=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,r=this.pos.scale(i).add(this._oldPos.scale(1-i));r.clone(this.drawPos),this.updateTransform(r)}if(t.snapToPixel){const i=this.drawPos.clone(this._snapPos);i.x=~~(i.x+ae*Be(i.x)),i.y=~~(i.y+ae*Be(i.y)),i.clone(this.drawPos),this.updateTransform(i)}t.multiply(this.transform)}updateTransform(t){const i=this._screen.resolution.width/this.zoom,r=this._screen.resolution.height/this.zoom,o=ft(-t.x+i/2+this._xShake,-t.y+r/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(i/2,r/2),this.transform.rotate(this.rotation),this.transform.translate(-i/2,-r/2),this.transform.translate(o.x,o.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Vp={ExitTrigger:"exit",EnterTrigger:"enter"};class Lg extends Ni{constructor(t){var i,r,o,h;super({...t}),this.events=new Ue,this.filter=(i=t.filter)!==null&&i!==void 0?i:()=>!0,this.repeat=(r=t.repeat)!==null&&r!==void 0?r:-1,this.action=(o=t.action)!==null&&o!==void 0?o:()=>{},this.target=t.target,this.graphics.isVisible=(h=t.visible)!==null&&h!==void 0?h:!1,this.body.collisionType=ie.Passive,this.events.on("collisionstart",({other:u})=>{this._matchesTarget(u.owner)&&(this.events.emit("enter",new oc(this,u.owner)),this._dispatchAction(u.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:u})=>{this._matchesTarget(u.owner)&&this.events.emit("exit",new ac(this,u.owner))})}_matchesTarget(t){return this.filter(t)&&(this.target===void 0||this.target===t)}_dispatchAction(t){this.repeat!==0&&(this.action.call(this,t),this.repeat--)}}const Gs={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var es;(function(c){c.Update="update",c.Draw="draw"})(es||(es={}));class os{}os.priority=Gs.Average;class zg{constructor(t){this._world=t,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>i=>{this.addEntity(i)},this._createChildRemovedHandler=()=>i=>{this.removeEntity(i,!1)},this._entitiesToRemove=[]}updateEntities(t,i){for(let r=0;r<this.entities.length;r++){const o=this.entities[r];o.update(t.engine,i),o.isActive||this.removeEntity(o)}}findEntitiesForRemoval(){for(let t=0;t<this.entities.length;t++){const i=this.entities[t];i.isActive||this.removeEntity(i)}}addEntity(t){if(t.isActive=!0,t.scene=this._world.scene,t&&!this._entityIndex[t.id]){this._entityIndex[t.id]=t,this.entities.push(t),this._world.queryManager.addEntity(t),t.children.forEach(o=>{o.scene=t.scene,this.addEntity(o)});const i=this._createChildAddedHandler();this._childAddedHandlerMap.set(t,i);const r=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(t,r),t.childrenAdded$.subscribe(i),t.childrenRemoved$.subscribe(r)}}removeEntity(t,i=!0){var r,o;let h=0;t instanceof Di?h=t.id:h=t;const u=this._entityIndex[h];if(u&&u.isActive&&(u.isActive=!1),u&&i){this._entitiesToRemove.push(u);return}if(delete this._entityIndex[h],u){u.scene=null,Wn(u,this.entities),this._world.queryManager.removeEntity(u),u.children.forEach(y=>{y.scene=null,this.removeEntity(y,i)});const _=this._childAddedHandlerMap.get(u);_&&u.childrenAdded$.unsubscribe(_);const A=this._childRemovedHandlerMap.get(u);A&&u.childrenRemoved$.unsubscribe(A),!((o=(r=this._world)===null||r===void 0?void 0:r.scene)===null||o===void 0)&&o.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let t=0;t<this._entitiesToRemove.length;t++){const i=this._entitiesToRemove[t];i.isActive||this.removeEntity(i,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let t=0;t<this.entities.length;t++)this.entities[t].processComponentRemoval()}getById(t){return this._entityIndex[t]}getByName(t){return this.entities.filter(i=>i.name===t)}clear(){for(let t=this.entities.length-1;t>=0;t--)this.removeEntity(this.entities[t])}}class Bo{constructor(t){if(this.requiredComponents=t,this.components=new Set,this.entities=[],this.entityAdded$=new zi,this.entityRemoved$=new zi,t.length===0)throw new Error("Cannot create query without components");for(const i of t)this.components.add(i);this.id=Bo.createId(t)}static createId(t){return t.slice().map(i=>i.name).sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAll(Array.from(this.components))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class To{constructor(t){if(this.requiredTags=t,this.tags=new Set,this.entities=[],this.entityAdded$=new zi,this.entityRemoved$=new zi,t.length===0)throw new Error("Cannot create tag query without tags");for(const i of t)this.tags.add(i);this.id=To.createId(t)}static createId(t){return t.slice().sort().join("-")}checkAndAdd(t){return!this.entities.includes(t)&&t.hasAllTags(Array.from(this.tags))?(this.entities.push(t),this.entityAdded$.notifyAll(t),!0):!1}removeEntity(t){const i=this.entities.indexOf(t);i>-1&&(this.entities.splice(i,1),this.entityRemoved$.notifyAll(t))}getEntities(t){return t&&this.entities.sort(t),this.entities}}class Ug{constructor(t){this._world=t,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=i=>r=>{this.addComponent(i,r)},this._createRemoveComponentHandler=i=>r=>{this.removeComponent(i,r)},this._createAddTagHandler=i=>r=>{this.addTag(i,r)},this._createRemoveTagHandler=i=>r=>{this.removeTag(i,r)}}createQuery(t){const i=Bo.createId(t);if(this._queries.has(i))return this._queries.get(i);const r=new Bo(t);this._queries.set(r.id,r);for(const o of t){const h=this._componentToQueriesIndex.get(o);h?h.push(r):this._componentToQueriesIndex.set(o,[r])}for(const o of this._world.entities)this.addEntity(o);return r}createTagQuery(t){const i=To.createId(t);if(this._tagQueries.has(i))return this._tagQueries.get(i);const r=new To(t);this._tagQueries.set(r.id,r);for(const o of t){const h=this._tagToQueriesIndex.get(o);h?h.push(r):this._tagToQueriesIndex.set(o,[r])}for(const o of this._world.entities)this.addEntity(o);return r}addEntity(t){const i=this._addComponentHandlers.get(t),r=this._removeComponentHandlers.get(t),o=i??this._createAddComponentHandler(t),h=r??this._createRemoveComponentHandler(t);this._addComponentHandlers.set(t,o),this._removeComponentHandlers.set(t,h);const u=this._addTagHandlers.get(t),_=this._removeTagHandlers.get(t),A=u??this._createAddTagHandler(t),y=_??this._createRemoveTagHandler(t);this._addTagHandlers.set(t,A),this._removeTagHandlers.set(t,y);for(const w of this._queries.values())w.checkAndAdd(t);for(const w of this._tagQueries.values())w.checkAndAdd(t);t.componentAdded$.subscribe(o),t.componentRemoved$.subscribe(h),t.tagAdded$.subscribe(A),t.tagRemoved$.subscribe(y)}removeEntity(t){const i=this._addComponentHandlers.get(t),r=this._removeComponentHandlers.get(t);for(const u of this._queries.values())u.removeEntity(t);i&&t.componentAdded$.unsubscribe(i),r&&t.componentRemoved$.unsubscribe(r);const o=this._addTagHandlers.get(t),h=this._removeTagHandlers.get(t);for(const u of this._tagQueries.values())u.removeEntity(t);o&&t.tagAdded$.unsubscribe(o),h&&t.tagRemoved$.unsubscribe(h)}addComponent(t,i){var r;const o=(r=this._componentToQueriesIndex.get(i.constructor))!==null&&r!==void 0?r:[];for(const h of o)h.checkAndAdd(t)}removeComponent(t,i){var r;const o=(r=this._componentToQueriesIndex.get(i.constructor))!==null&&r!==void 0?r:[];for(const h of o)h.removeEntity(t)}addTag(t,i){var r;const o=(r=this._tagToQueriesIndex.get(i))!==null&&r!==void 0?r:[];for(const h of o)h.checkAndAdd(t)}removeTag(t,i){var r;const o=(r=this._tagToQueriesIndex.get(i))!==null&&r!==void 0?r:[];for(const h of o)h.removeEntity(t)}}function Ng(c){var t,i;return!!(c!=null&&c.prototype)&&!!(!((i=(t=c==null?void 0:c.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class Gg{constructor(t){this._world=t,this.systems=[],this.initialized=!1}get(t){return this.systems.find(i=>i instanceof t)}addSystem(t){let i;t instanceof os?i=t:i=new t(this._world),this.systems.push(i),this.systems.sort((r,o)=>r.constructor.priority-o.constructor.priority),this.initialized&&i.initialize&&i.initialize(this._world,this._world.scene)}removeSystem(t){Wn(t,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const t of this.systems)t.initialize&&t.initialize(this._world,this._world.scene)}}updateSystems(t,i,r){const o=this.systems.filter(h=>h.systemType===t);for(const h of o)h.preupdate&&h.preupdate(i,r);for(const h of o)h.update(r);for(const h of o)h.postupdate&&h.postupdate(i,r)}clear(){for(let t=this.systems.length-1;t>=0;t--)this.removeSystem(this.systems[t])}}class Og{constructor(t){this.scene=t,this.queryManager=new Ug(this),this.entityManager=new zg(this),this.systemManager=new Gg(this)}query(t){return this.queryManager.createQuery(t)}queryTags(t){return this.queryManager.createTagQuery(t)}update(t,i){t===es.Update&&this.entityManager.updateEntities(this.scene,i),this.systemManager.updateSystems(t,this.scene,i),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(t){t instanceof Di&&this.entityManager.addEntity(t),(t instanceof os||Ng(t))&&this.systemManager.addSystem(t)}get(t){return this.systemManager.get(t)}remove(t,i=!0){t instanceof Di&&this.entityManager.removeEntity(t,i),t instanceof os&&this.systemManager.removeSystem(t)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class eh extends os{constructor(t,i){super(),this.world=t,this.physics=i,this.systemType=es.Update,this._physicsConfigDirty=!1,i.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([qt,we])}update(t){let i,r;const o=this.query.entities,h=this.physics.config.substep;for(let u=0;u<o.length;u++){i=o[u].get(qt),r=o[u].get(we);const _=o[u].get(fe);if(this._physicsConfigDirty&&_&&_.updatePhysicsConfig(this.physics.config.bodies),_!=null&&_.isSleeping)continue;const A=r.acc.clone();(_==null?void 0:_.collisionType)===ie.Active&&(_!=null&&_.useGravity)&&A.addEqual(this.physics.config.gravity),o[u].parent||this.captureOldTransformWithChildren(o[u]),Li.integrate(i,r,A,t/h)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(t){var i;(i=t.get(fe))===null||i===void 0||i.captureOldTransform();for(let r=0;r<t.children.length;r++)this.captureOldTransformWithChildren(t.children[r])}}eh.priority=Gs.Higher;class El{constructor(t){this.config=t,this.directionMap=new Map,this.distanceMap=new Map}solve(t){this.preSolve(t),t=t.filter(r=>!r.isCanceled());let i;switch(this.config.contactSolveBias){case Un.HorizontalFirst:{i=Xu;break}case Un.VerticalFirst:{i=Yu;break}default:i=Zu}t.sort((r,o)=>{const h=this.directionMap.get(r.id),u=this.directionMap.get(o.id),_=this.distanceMap.get(r.id),A=this.distanceMap.get(o.id);return i[h]-i[u]||_-A});for(const r of t)this.solvePosition(r),this.solveVelocity(r);return this.postSolve(t),t}preSolve(t){for(let r=0;r<t.length;r++){const o=t[r];if(Math.abs(o.mtv.x)<1e-4&&Math.abs(o.mtv.y)<1e-4){o.cancel();continue}const h=Te.fromDirection(o.mtv),u=o.mtv.negate(),_=Math.abs(o.info.separation);this.distanceMap.set(o.id,_),this.directionMap.set(o.id,h===Te.Left||h===Te.Right?"horizontal":"vertical"),o.colliderA.events.emit("precollision",new un(o.colliderA,o.colliderB,h,u,o)),o.colliderB.events.emit("precollision",new un(o.colliderB,o.colliderA,Te.getOpposite(h),u.negate(),o))}}postSolve(t){var i,r;for(let o=0;o<t.length;o++){const h=t[o];if(h.isCanceled())continue;const u=h.colliderA,_=h.colliderB,A=(i=u.owner)===null||i===void 0?void 0:i.get(fe),y=(r=_.owner)===null||r===void 0?void 0:r.get(fe);if(A&&y&&(A.collisionType===ie.Passive||y.collisionType===ie.Passive))continue;const w=Te.fromDirection(h.mtv),f=h.mtv.negate();h.colliderA.events.emit("postcollision",new gn(h.colliderA,h.colliderB,w,f,h)),h.colliderB.events.emit("postcollision",new gn(h.colliderB,h.colliderA,Te.getOpposite(w),f.negate(),h))}}solvePosition(t){var i,r;if(!t.colliderA.bounds.overlaps(t.colliderB.bounds,1e-4)){t.cancel();return}if(Math.abs(t.mtv.x)<1e-4&&Math.abs(t.mtv.y)<1e-4){t.cancel();return}let h=t.mtv;const u=t.colliderA,_=t.colliderB,A=(i=u.owner)===null||i===void 0?void 0:i.get(fe),y=(r=_.owner)===null||r===void 0?void 0:r.get(fe);if(A&&y){if(A.collisionType===ie.Passive||y.collisionType===ie.Passive)return;A.collisionType===ie.Active&&y.collisionType===ie.Active&&(h=h.scale(.5)),A.collisionType===ie.Active&&(A.globalPos.x-=h.x,A.globalPos.y-=h.y,u.update(A.transform.get())),y.collisionType===ie.Active&&(y.globalPos.x+=h.x,y.globalPos.y+=h.y,_.update(y.transform.get()))}}solveVelocity(t){var i,r;if(t.isCanceled())return;const o=t.colliderA,h=t.colliderB,u=(i=o.owner)===null||i===void 0?void 0:i.get(fe),_=(r=h.owner)===null||r===void 0?void 0:r.get(fe);if(u&&_){if(u.collisionType===ie.Passive||_.collisionType===ie.Passive)return;const A=t.normal,y=A.negate();if(u.collisionType===ie.Active&&u.vel.normalize().dot(y)<0){const w=A.scale(A.dot(u.vel.negate()));u.vel=u.vel.add(w)}if(_.collisionType===ie.Active&&_.vel.normalize().dot(A)<0){const w=y.scale(y.dot(_.vel.negate()));_.vel=_.vel.add(w)}}}}class Hg{constructor(t,i,r){this.point=t,this.local=i,this.contact=r,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new rt(0,0),this.bToContact=new rt(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const t=this.contact.bodyA,i=this.contact.bodyB;if(t&&i){const r=this.contact.normal,o=this.contact.tangent;this.aToContact=this.point.sub(t.globalPos),this.bToContact=this.point.sub(i.globalPos);const h=this.aToContact.cross(r),u=this.bToContact.cross(r);this.normalMass=t.inverseMass+i.inverseMass+t.inverseInertia*h*h+i.inverseInertia*u*u;const _=this.aToContact.cross(o),A=this.bToContact.cross(o);this.tangentMass=t.inverseMass+i.inverseMass+t.inverseInertia*_*_+i.inverseInertia*A*A}return this}getRelativeVelocity(){const t=this.contact.bodyA,i=this.contact.bodyB;if(t&&i){const r=t.vel.add(rt.cross(t.angularVelocity,this.aToContact));return i.vel.add(rt.cross(i.angularVelocity,this.bToContact)).sub(r)}return rt.Zero}}class Il{constructor(t){this.config=t,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(t){var i;return(i=this.idToContactConstraint.get(t))!==null&&i!==void 0?i:[]}solve(t){return this.preSolve(t),t=t.filter(i=>!i.isCanceled()),this.solveVelocity(t),this.solvePosition(t),this.postSolve(t),t}preSolve(t){var i,r,o;for(let _=0;_<t.length;_++){const A=t[_];if(Math.abs(A.mtv.x)<1e-4&&Math.abs(A.mtv.y)<1e-4){A.cancel();continue}const y=Te.fromDirection(A.mtv);A.colliderA.events.emit("precollision",new un(A.colliderA,A.colliderB,y,A.mtv,A)),A.colliderA.events.emit("beforecollisionresolve",new Na(A.colliderA,A.colliderB,y,A.mtv,A)),A.colliderB.events.emit("precollision",new un(A.colliderB,A.colliderA,Te.getOpposite(y),A.mtv.negate(),A)),A.colliderB.events.emit("beforecollisionresolve",new Na(A.colliderB,A.colliderA,Te.getOpposite(y),A.mtv.negate(),A)),A.matchAwake()}const u=Array.from(this.idToContactConstraint.keys());for(let _=0;_<t.length;_++){const A=t[_],y=u.indexOf(A.id);y>-1&&u.splice(y,1);const w=(i=this.idToContactConstraint.get(A.id))!==null&&i!==void 0?i:[];let f=0;const T=A.bodyA,C=A.bodyB;if(T&&C)for(let S=0;S<A.points.length;S++){const E=A.points[S],W=A.normal,D=A.tangent,H=E.sub(T.globalPos),k=E.sub(C.globalPos),N=H.cross(W),Q=k.cross(W),L=T.inverseMass+C.inverseMass+T.inverseInertia*N*N+C.inverseInertia*Q*Q,O=H.cross(D),Y=k.cross(D),ot=T.inverseMass+C.inverseMass+T.inverseInertia*O*O+C.inverseInertia*Y*Y;w[f]&&((o=(r=w[f])===null||r===void 0?void 0:r.point)===null||o===void 0?void 0:o.squareDistance(E))<4?(w[f].point=E,w[f].local=A.localPoints[f]):w[f]=new Hg(E,A.localPoints[f],A),w[f].aToContact=H,w[f].bToContact=k,w[f].normalMass=1/L,w[f].tangentMass=1/ot;const nt=T.bounciness>C.bounciness?T.bounciness:C.bounciness,et=A.normal.dot(w[f].getRelativeVelocity());w[f].originalVelocityAndRestitution=0,et<-.1&&(w[f].originalVelocityAndRestitution=-nt*et),f++}this.idToContactConstraint.set(A.id,w)}for(const _ of u)this.idToContactConstraint.delete(_);if(this.config.warmStart)this.warmStart(t);else for(let _=0;_<t.length;_++){const A=t[_],y=this.getContactConstraints(A.id);for(const w of y)w.normalImpulse=0,w.tangentImpulse=0}}postSolve(t){for(let i=0;i<t.length;i++){const r=t[i],o=r.bodyA,h=r.bodyB;if(o&&h){if(o.collisionType===ie.Passive||h.collisionType===ie.Passive)continue;o.updateMotion(),h.updateMotion()}const u=Te.fromDirection(r.mtv);r.colliderA.events.emit("postcollision",new gn(r.colliderA,r.colliderB,u,r.mtv,r)),r.colliderA.events.emit("aftercollisionresolve",new Ga(r.colliderA,r.colliderB,u,r.mtv,r)),r.colliderB.events.emit("postcollision",new gn(r.colliderB,r.colliderA,Te.getOpposite(u),r.mtv.negate(),r)),r.colliderB.events.emit("aftercollisionresolve",new Ga(r.colliderB,r.colliderA,Te.getOpposite(u),r.mtv.negate(),r))}this.lastFrameContacts.clear();for(let i=0;i<t.length;i++){const r=t[i];this.lastFrameContacts.set(r.id,r)}}warmStart(t){var i;for(let r=0;r<t.length;r++){const o=t[r],h=o.bodyA,u=o.bodyB;if(h&&u){const _=(i=this.idToContactConstraint.get(o.id))!==null&&i!==void 0?i:[];for(const A of _)if(this.config.warmStart){const y=o.normal.scale(A.normalImpulse),w=o.tangent.scale(A.tangentImpulse),f=y.add(w);h.applyImpulse(A.point,f.negate()),u.applyImpulse(A.point,f)}else A.normalImpulse=0,A.tangentImpulse=0}}}solvePosition(t){var i;for(let r=0;r<this.config.positionIterations;r++)for(let o=0;o<t.length;o++){const h=t[o],u=h.bodyA,_=h.bodyB;if(u&&_){if(u.collisionType===ie.Passive||_.collisionType===ie.Passive)continue;const A=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const y of A){const w=h.normal,f=xs.FindContactSeparation(h,y.local),T=this.config.steeringFactor,C=-5,S=this.config.slop,E=ce(T*(f+S),C,0),W=w.scale(-E*y.normalMass);if(u.collisionType===ie.Active){const D=W.negate().scale(u.inverseMass);u.limitDegreeOfFreedom.includes(ji.X)&&(D.x=0),u.limitDegreeOfFreedom.includes(ji.Y)&&(D.y=0),u.globalPos=u.globalPos.add(D),u.limitDegreeOfFreedom.includes(ji.Rotation)||(u.rotation-=y.aToContact.cross(W)*u.inverseInertia)}if(_.collisionType===ie.Active){const D=W.scale(_.inverseMass);_.limitDegreeOfFreedom.includes(ji.X)&&(D.x=0),_.limitDegreeOfFreedom.includes(ji.Y)&&(D.y=0),_.globalPos=_.globalPos.add(D),_.limitDegreeOfFreedom.includes(ji.Rotation)||(_.rotation+=y.bToContact.cross(W)*_.inverseInertia)}}}}}solveVelocity(t){var i;for(let r=0;r<this.config.velocityIterations;r++)for(let o=0;o<t.length;o++){const h=t[o],u=h.bodyA,_=h.bodyB;if(u&&_){if(u.collisionType===ie.Passive||_.collisionType===ie.Passive)continue;const A=Math.min(u.friction,_.friction),y=(i=this.idToContactConstraint.get(h.id))!==null&&i!==void 0?i:[];for(const w of y){let C=-w.getRelativeVelocity().dot(h.tangent)*w.tangentMass;const S=A*w.normalImpulse,E=ce(w.tangentImpulse+C,-S,S);C=E-w.tangentImpulse,w.tangentImpulse=E;const W=h.tangent.scale(C);u.applyImpulse(w.point,W.negate()),_.applyImpulse(w.point,W)}for(const w of y){const T=w.getRelativeVelocity().dot(h.normal);let C=-w.normalMass*(T-w.originalVelocityAndRestitution);const S=Math.max(w.normalImpulse+C,0);C=S-w.normalImpulse,w.normalImpulse=S;const E=h.normal.scale(C);u.applyImpulse(w.point,E.negate()),_.applyImpulse(w.point,E)}}}}}class ih extends os{get _processor(){return this._physics.collisionProcessor}constructor(t,i){super(),this._physics=i,this.systemType=es.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new El(i.config.arcade),this._realisticSolver=new Il(i.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=r=>this._processor.track(r),this._untrackCollider=r=>this._processor.untrack(r),this.query=t.query([qt,we,ei]),this.query.entityAdded$.subscribe(r=>{const o=r.get(ei);o.$colliderAdded.subscribe(this._trackCollider),o.$colliderRemoved.subscribe(this._untrackCollider);const h=o.get();h&&this._processor.track(h)}),this.query.entityRemoved$.subscribe(r=>{const o=r.get(ei),h=o.get();o&&h&&this._processor.untrack(h)}),this._motionSystem=t.get(eh)}initialize(t,i){this._engine=i.engine}update(t){var i,r,o,h;if(!this._physics.config.enabled)return;let u=[];for(let f=0;f<this.query.entities.length;f++){const C=this.query.entities[f].get(ei),S=C==null?void 0:C.get();if(C&&(!((i=C.owner)===null||i===void 0)&&i.isActive)&&S)if(C.update(),S instanceof fi){const E=S.getColliders();S.compositeStrategy||(S.compositeStrategy=this._physics.config.colliders.compositeStrategy),u=u.concat(E)}else u.push(S)}this._processor.update(u,t);let _=this._processor.broadphase(u,t);this._currentFrameContacts.clear();let A=[];const y=this.getSolver(),w=this._physics.config.substep;for(let f=0;f<w;f++)if(f>0&&this._motionSystem.update(t),A.length&&(_=A.map(T=>new Ui(T.colliderA,T.colliderB))),_.length){A=this._processor.narrowphase(_,(h=(o=(r=this._engine)===null||r===void 0?void 0:r.debug)===null||o===void 0?void 0:o.stats)===null||h===void 0?void 0:h.currFrame),A=y.solve(A);for(const T of A){if(T.isCanceled())continue;const C=T.id.indexOf("|");if(C>0){const S=T.id.substring(C+1);this._currentFrameContacts.set(S,T)}else this._currentFrameContacts.set(T.id,T)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const f of this.query.entities){const T=f.get(ei);T&&T.processColliderRemoval()}}postupdate(){Ke.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new El(this._physics.config.arcade),this._realisticSolver=new Il(this._physics.config.realistic)),this._physics.config.solver===Io.Realistic?this._realisticSolver:this._arcadeSolver}debug(t){this._processor.debug(t,0)}runContactStartEnd(){for(const[t,i]of this._currentFrameContacts)if(!this._lastFrameContacts.has(t)){const r=i.colliderA,o=i.colliderB,h=Te.fromDirection(i.mtv),u=Te.getOpposite(h);r.events.emit("collisionstart",new xo(r,o,h,i)),r.events.emit("contactstart",new za(r,o,h,i)),o.events.emit("collisionstart",new xo(o,r,u,i)),o.events.emit("contactstart",new za(o,r,u,i))}for(const[t,i]of this._lastFrameContacts)if(!this._currentFrameContacts.has(t)){const r=i.colliderA,o=i.colliderB,h=Te.fromDirection(i.mtv),u=Te.getOpposite(h);r.events.emit("collisionend",new bo(r,o,h,i)),r.events.emit("contactend",new Ua(r,o,h,i)),o.events.emit("collisionend",new bo(o,r,u,i)),o.events.emit("contactend",new Ua(o,r,u,i))}}}ih.priority=Gs.Higher;function jp(c,t,i,r){if(c.parent!==t.parent){const w=c.clone(),f=c.globalPos.clone(),T=c.globalScale.clone(),C=c.globalRotation;w.parent=t.parent,w.globalPos=f,w.globalScale=T,w.globalRotation=C,c=w}let o=t.pos,h=t.scale,u=t.rotation;o=t.pos.scale(i).add(c.pos.scale(1-i)),h=t.scale.scale(i).add(c.scale.scale(1-i));const _=(1-i)*Math.cos(c.rotation)+i*Math.cos(t.rotation),A=(1-i)*Math.sin(c.rotation)+i*Math.sin(t.rotation);u=Math.atan2(A,_);const y=r??new rr;return y.setTransform(o,u,h),y}class mc extends os{get sortedTransforms(){return this._sortedTransforms}constructor(t){super(),this.world=t,this.systemType=es.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new rr,this.query=this.world.query([qt,He]),this.query.entityAdded$.subscribe(i=>{const r=i.get(qt);this._sortedTransforms.push(r),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{const r=i.get(qt);r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const o=this._sortedTransforms.indexOf(r);o>-1&&this._sortedTransforms.splice(o,1)})}initialize(t,i){this._camera=i.camera,this._engine=i.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>t.globalZ-i.globalZ),this._zHasChanged=!1)}update(t){this._token++;let i;xe.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let r=0;r<this._sortedTransforms.length;r++){const o=this._sortedTransforms[r],h=o.owner;if(h.hasTag("ex.offscreen")||(i=h.get(He),!i.isVisible))continue;i.onPreTransformDraw&&i.onPreTransformDraw(this._graphicsContext,t),h.events.emit("pretransformdraw",new Wl(this._graphicsContext,t,h)),o.coordPlane===yi.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),o.coordPlane===yi.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),i.update(t,this._token);const u=h.get(Ka);if(u){const _=rt.One.sub(u.parallaxFactor),A=this._camera.drawPos.scale(_);this._graphicsContext.translate(A.x,A.y)}this._applyTransform(h),i.material&&(this._graphicsContext.material=i.material),i.onPreDraw&&i.onPreDraw(this._graphicsContext,t),h.events.emit("predraw",new jn(this._graphicsContext,t,h)),this._applyOpacity(h),this._drawGraphicsComponent(i,o),i.onPostDraw&&i.onPostDraw(this._graphicsContext,t),h.events.emit("postdraw",new Yn(this._graphicsContext,t,h)),this._graphicsContext.restore(),o.coordPlane===yi.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),i.onPostTransformDraw&&i.onPostTransformDraw(this._graphicsContext,t),h.events.emit("posttransformdraw",new ql(this._graphicsContext,t,h))}this._graphicsContext.restore()}_drawGraphicsComponent(t,i){var r,o;if(t.isVisible){const h=t.flipHorizontal,u=t.flipVertical,_=t.current,A=(r=t.currentOptions)!==null&&r!==void 0?r:{};if(_){let y=t.anchor,w=t.offset,f=1,T=1;A!=null&&A.anchor&&(y=A.anchor),A!=null&&A.offset&&(w=A.offset);const C=i.globalScale;f*=_.scale.x*C.x,T*=_.scale.y*C.y;const S=-_.width*y.x+w.x*f,E=-_.height*y.y+w.y*T,W=_.flipHorizontal,D=_.flipVertical;if((h||u)&&(_.flipHorizontal=h?!W:W,_.flipVertical=u?!D:D),_==null||_.draw(this._graphicsContext,S,E),(h||u)&&(_.flipHorizontal=W,_.flipVertical=D),!((o=this._engine)===null||o===void 0)&&o.isDebug&&this._engine.debug.graphics.showBounds){const H=ft(S,E);if(_ instanceof zn)for(const k of _.members){let N,Q=rt.Zero;k instanceof Oe?N=k:(N=k.graphic,Q=k.offset),_.useAnchor?N==null||N.localBounds.translate(H.add(Q)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):N==null||N.localBounds.translate(Q).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else _==null||_.localBounds.translate(H).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(t){const i=t.getAncestors();for(let r=0;r<i.length;r++){const o=i[r],h=o==null?void 0:o.get(qt),u=o==null?void 0:o.get(fe);if(h){let _=h.get();if(u&&this._engine.fixedUpdateTimestep&&u.__oldTransformCaptured&&u.enableFixedUpdateInterpolate){const A=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;_=jp(u.oldTransform,h.get(),A,this._targetInterpolationTransform)}this._graphicsContext.z=h.globalZ,this._graphicsContext.translate(_.pos.x,_.pos.y),this._graphicsContext.scale(_.scale.x,_.scale.y),this._graphicsContext.rotate(_.rotation)}}}_applyOpacity(t){var i;const r=t.getAncestors();for(let o=0;o<r.length;o++){const h=r[o],u=h==null?void 0:h.get(He);this._graphicsContext.opacity*=(i=u==null?void 0:u.opacity)!==null&&i!==void 0?i:1}}}mc.priority=Gs.Average;class vc extends os{constructor(t){super(),this.world=t,this.systemType=es.Draw,this.query=this.world.query([qt])}initialize(t,i){this._graphicsContext=i.engine.graphicsContext,this._camera=i.camera,this._engine=i.engine,this._collisionSystem=t.systemManager.get(ih)}update(){var t;if(!this._engine.isDebug)return;const i=this._engine.debug.filter;let r,o;const h=this._engine.debug.entity;let u;const _=this._engine.debug.transform;let A;const y=this._engine.debug.motion;let w;const f=this._engine.debug.collider,T=this._engine.debug.physics;let C;const S=this._engine.debug.graphics;let E,W;const D=this._engine.debug.body,H=this._engine.debug.camera;for(let k=0;k<this.query.entities.length;k++){const N=this.query.entities[k];if(N.hasTag("offscreen")||N instanceof Xa||i.useFilter&&(!(i.ids.length===0||i.ids.includes(N.id))||!(i.nameQuery===""||N.name.includes(i.nameQuery))))continue;let Q=rt.Zero;const L=ft(0,16);if(r=N.id,o=N.name,u=N.get(qt),this._pushCameraTransform(u),this._graphicsContext.save(),u.coordPlane===yi.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=_.debugZIndex,this._applyTransform(N),u&&((_.showAll||_.showPosition)&&this._graphicsContext.debug.drawPoint(rt.Zero,{size:4,color:_.positionColor}),(_.showAll||_.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${u.pos.toString(2)}`,Q),Q=Q.add(L)),(_.showAll||_.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${u.z.toFixed(1)})`,Q),Q=Q.add(L)),(h.showAll||h.showId)&&(this._graphicsContext.debug.drawText(`id(${r}) ${N.parent?"child of id("+((t=N.parent)===null||t===void 0?void 0:t.id)+")":""}`,Q),Q=Q.add(L)),(h.showAll||h.showName)&&(this._graphicsContext.debug.drawText(`name(${o})`,Q),Q=Q.add(L)),(_.showAll||_.showRotation)&&(this._graphicsContext.drawLine(rt.Zero,rt.fromAngle(u.rotation).scale(50).add(rt.Zero),_.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${Pu(u.rotation).toFixed(2)})`,Q),Q=Q.add(L)),(_.showAll||_.showScale)&&this._graphicsContext.drawLine(rt.Zero,u.scale.add(rt.Zero),_.scaleColor,2)),C=N.get(He),C&&(S.showAll||S.showBounds)&&C.localBounds.draw(this._graphicsContext,S.boundsColor),E=N.get(th),E&&(E.useTransform||this._graphicsContext.restore(),E.draw(this._graphicsContext,this._engine.debug),E.useTransform||(this._graphicsContext.save(),this._applyTransform(N))),W=N.get(fe),W&&((D.showAll||D.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${W.group.name})`,Q),Q=Q.add(L)),(D.showAll||D.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${W.collisionType})`,Q),Q=Q.add(L)),(D.showAll||D.showMass)&&(this._graphicsContext.debug.drawText(`mass(${W.mass})`,Q),Q=Q.add(L)),(D.showAll||D.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${W.sleepMotion})`,Q),Q=Q.add(L)),(D.showAll||D.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${W.canSleep?W.isSleeping:"cant sleep"})`,Q),Q=Q.add(L))),this._graphicsContext.restore(),this._graphicsContext.save(),u.coordPlane===yi.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=_.debugZIndex,A=N.get(we),A&&((y.showAll||y.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${A.vel.toString(2)}`,Q.add(u.globalPos)),this._graphicsContext.drawLine(u.globalPos,u.globalPos.add(A.vel),y.velocityColor,2),Q=Q.add(L)),(y.showAll||y.showAcceleration)&&this._graphicsContext.drawLine(u.globalPos,u.globalPos.add(A.acc),y.accelerationColor,2)),w=N.get(ei),w){const O=w.get();if((f.showAll||f.showGeometry)&&O&&O.debug(this._graphicsContext,f.geometryColor,{lineWidth:f.geometryLineWidth,pointSize:f.geometryPointSize}),f.showAll||f.showBounds){if(O instanceof fi){const Y=O.getColliders();for(const ot of Y){const nt=ot.bounds,et=ft(nt.left,nt.top);this._graphicsContext.debug.drawRect(et.x,et.y,nt.width,nt.height,{color:f.boundsColor}),(f.showAll||f.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${ot.owner.id})`,et)}w.bounds.draw(this._graphicsContext,f.boundsColor)}else if(O){const Y=w.bounds,ot=ft(Y.left,Y.top);this._graphicsContext.debug.drawRect(ot.x,ot.y,Y.width,Y.height,{color:f.boundsColor}),(f.showAll||f.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${w.owner.id})`,ot)}}}this._graphicsContext.restore(),this._popCameraTransform(u)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(T.showAll||T.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),T.showAll||T.showCollisionContacts||T.showCollisionNormals)for(const[k,N]of this._engine.debug.stats.currFrame.physics.contacts){if(T.showAll||T.showCollisionContacts)for(const Q of N.points)this._graphicsContext.debug.drawPoint(Q,{size:T.contactSize,color:T.collisionContactColor});if(T.showAll||T.showCollisionNormals)for(const Q of N.points)this._graphicsContext.debug.drawLine(Q,N.normal.scale(30).add(Q),{color:T.collisionNormalColor})}this._graphicsContext.restore(),H&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(H.showAll||H.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,H.focusColor),(H.showAll||H.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(t,i){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),gi.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(t){const i=t.getAncestors();for(const r of i){const o=r==null?void 0:r.get(qt);o&&(this._graphicsContext.translate(o.pos.x,o.pos.y),this._graphicsContext.scale(o.scale.x,o.scale.y),this._graphicsContext.rotate(o.rotation))}}_pushCameraTransform(t){t.coordPlane===yi.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(t){t.coordPlane===yi.World&&this._graphicsContext.restore()}}vc.priority=Gs.Lowest;class wc{constructor(t,i){this.object=t,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=i,this.bounds=t.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const t=this.object.bounds,i=Math.floor(t.left/this.gridSize),r=Math.floor(t.right/this.gridSize),o=Math.floor(t.bottom/this.gridSize),h=Math.floor(t.top/this.gridSize);return this.leftX!==i||this.rightX!==r||this.bottomY!==o||this.topY!==h}clear(){for(const t of this.cells){const i=t.proxies.indexOf(this);i>-1&&t.proxies.splice(i,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class ks{constructor(){this.proxies=[]}configure(t,i){this.x=t,this.y=i,this.key=ks.calculateHashKey(t,i)}static calculateHashKey(t,i){return`${t}+${i}`}}class yc{constructor(t){this.bounds=new Zt,this._hashGridCellPool=new Mo(()=>new ks,i=>(i.configure(0,0),i.proxies.length=0,i),1e3),this.gridSize=t.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,t.proxyFactory?this._buildProxy=i=>t.proxyFactory(i,this.gridSize):this._buildProxy=i=>new wc(i,this.gridSize)}query(t){const i=new Set;if(t instanceof Zt){const r=t,o=Math.floor(r.left/this.gridSize),h=Math.floor(r.right/this.gridSize),u=Math.floor(r.bottom/this.gridSize),_=Math.floor(r.top/this.gridSize);for(let A=o;A<=h;A++)for(let y=_;y<=u;y++){const w=ks.calculateHashKey(A,y),f=this.sparseHashGrid.get(w);if(f)for(let T=0;T<f.proxies.length;T++)f.proxies[T].updateBounds(),f.proxies[T].bounds.intersect(r)&&i.add(f.proxies[T].object)}}else{const r=t,o=ks.calculateHashKey(Math.floor(r.x/this.gridSize),Math.floor(r.y/this.gridSize)),h=this.sparseHashGrid.get(o);if(h)for(let u=0;u<h.proxies.length;u++)h.proxies[u].updateBounds(),h.proxies[u].bounds.contains(r)&&i.add(h.proxies[u].object)}return Array.from(i)}get(t,i){const r=ks.calculateHashKey(t,i);return this.sparseHashGrid.get(r)}_insert(t,i,r){const o=ks.calculateHashKey(t,i);let h=this.sparseHashGrid.get(o);h||(h=this._hashGridCellPool.rent(),h.configure(t,i),this.sparseHashGrid.set(h.key,h)),h.proxies.push(r),r.cells.push(h),this.bounds.combine(r.bounds,this.bounds)}_remove(t,i,r){const o=ks.calculateHashKey(t,i),h=this.sparseHashGrid.get(o);if(h){const u=h.proxies.indexOf(r);u>-1&&h.proxies.splice(u,1);const _=r.cells.indexOf(h);_>-1&&r.cells.splice(_,1),h.proxies.length===0&&(this._hashGridCellPool.return(h),this.sparseHashGrid.delete(o))}}track(t){const i=this._buildProxy(t);this.objectToProxy.set(t,i);for(let r=i.leftX;r<=i.rightX;r++)for(let o=i.topY;o<=i.bottomY;o++)this._insert(r,o,i)}untrack(t){const i=this.objectToProxy.get(t);i&&(i.clear(),this.objectToProxy.delete(t))}update(t){let i=0;for(const r of t){const o=this.objectToProxy.get(r);if(o&&o.hasChanged()){for(let h=o.leftX;h<=o.rightX;h++)for(let u=o.topY;u<=o.bottomY;u++)this._remove(h,u,o);o.update();for(let h=o.leftX;h<=o.rightX;h++)for(let u=o.topY;u<=o.bottomY;u++)this._insert(h,u,o);i++}}return i}debug(t,i){const r=kt.Transparent,o=kt.White;for(const h of this.sparseHashGrid.values())t.drawRectangle(ft(h.x*this.gridSize,h.y*this.gridSize),this.gridSize,this.gridSize,r,o,2)}}class sh extends os{constructor(t){super(),this.world=t,this.systemType=es.Update,this._graphicsHashGrid=new yc({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new Ac,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([qt,Tr]),this.query.entityAdded$.subscribe(i=>{const r=i.get(qt),o=i.get(Tr);this._pointerEventDispatcher.addObject(i,u=>o&&o.localBounds?o.localBounds.transform(r.get().matrix).contains(r.coordPlane===yi.World?u.worldPos:u.screenPos):!1,()=>i.isActive),this._entityToPointer.set(i,o);const h=i.get(He);h&&(this._graphics.push(h),this._graphicsHashGrid.track(h)),this._sortedTransforms.push(r),this._sortedEntities.push(r.owner),r.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(i=>{this._pointerEventDispatcher.removeObject(i);const r=i.get(qt);this._entityToPointer.delete(i);const o=i.get(He);if(o){const u=this._graphics.indexOf(o);u>-1&&this._graphics.splice(u,1),this._graphicsHashGrid.untrack(o)}r.zIndexChanged$.unsubscribe(this._zIndexUpdate);const h=this._sortedTransforms.indexOf(r);h>-1&&(this._sortedTransforms.splice(h,1),this._sortedEntities.splice(h,1))})}initialize(t,i){this._engine=i.engine,this._scene=i}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((t,i)=>i.z-t.z),this._sortedEntities=this._sortedTransforms.map(t=>t.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[t,i]of this._engineReceiver.currentFramePointerCoords.entries()){const r=this._scene.physics.query(i.worldPos);for(let h=0;h<r.length;h++){const u=r[h],_=this._entityToPointer.get(u.owner);_&&(_.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(u.owner,t)}const o=this._graphicsHashGrid.query(i.worldPos);for(let h=0;h<o.length;h++){const u=o[h],_=this._entityToPointer.get(u.owner);_&&(_.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(u.owner,t)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(t=>t.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(t=>t.clear())}}sh.priority=Gs.Higher;class xc extends os{constructor(t){super(),this.world=t,this.systemType=es.Update,this._actions=[],this.query=this.world.query([Qn]),this.query.entityAdded$.subscribe(i=>this._actions.push(i.get(Qn))),this.query.entityRemoved$.subscribe(i=>{const r=i.get(Qn),o=this._actions.indexOf(r);o>-1&&this._actions.splice(o,1)})}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}}xc.priority=Gs.Higher;class So extends ls{constructor(t){super(),this.elevation=0,this.columns=t.columns,this.rows=t.rows,this.tileWidth=t.tileWidth,this.tileHeight=t.tileHeight}}class bc extends os{constructor(t){super(),this.world=t,this.systemType=es.Update,this.query=this.world.query([qt,So])}update(){let t,i;for(let r=0;r<this.query.entities.length;r++){const o=this.query.entities[r];t=o.get(qt),i=o.get(So);const u=Math.max(i.columns*i.tileWidth,i.rows*i.tileHeight)*i.elevation+t.pos.y;t.z=u}}}bc.priority=Gs.Lower;class Cc extends os{constructor(t){super(),this.world=t,this.systemType=es.Draw,this.query=this.world.query([qt,He])}initialize(t,i){this._camera=i.camera,this._screen=i.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let t,i,r;for(let o=0;o<this.query.entities.length;o++){const h=this.query.entities[o];i=h.get(He),t=h.get(qt),r=h.get(Ka);let u;if(r){const A=rt.One.sub(r.parallaxFactor);u=this._camera.pos.scale(A)}const _=this._isOffscreen(t,i,u);_&&!h.hasTag("ex.offscreen")&&(h.events.emit("exitviewport",new rc(h)),h.addTag("ex.offscreen")),!_&&h.hasTag("ex.offscreen")&&(h.events.emit("enterviewport",new nc(h)),h.removeTag("ex.offscreen"))}}_isOffscreen(t,i,r){if(i.forceOnScreen)return!1;if(t.coordPlane===yi.World){let o=i.localBounds;r&&(o=o.translate(r));const h=o.transform(t.get().matrix);return!this._worldBounds.overlaps(h)}else return!1}}Cc.priority=Gs.Higher;class Wg extends wc{constructor(t,i){var r,o;super(t,i),this.collider=t,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=i;const h=t.bounds;this.hasZeroBounds=h.hasZeroDimensions(),this.leftX=Math.floor(h.left/this.gridSize),this.rightX=Math.floor(h.right/this.gridSize),this.bottomY=Math.floor(h.bottom/this.gridSize),this.topY=Math.floor(h.top/this.gridSize),this.owner=t.owner,this.body=(r=this.owner)===null||r===void 0?void 0:r.get(fe),this.collisionType=(o=this.body.collisionType)!==null&&o!==void 0?o:ie.PreventCollision}update(){var t,i;super.update(),this.body=(t=this.owner)===null||t===void 0?void 0:t.get(fe),this.collisionType=(i=this.body.collisionType)!==null&&i!==void 0?i:ie.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class Bl{constructor(t){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new ja(()=>new Ui({id:ln("collider",0)},{id:ln("collider",0)}),i=>(i.colliderA=null,i.colliderB=null,i),200),this.gridSize=t.size,this.hashGrid=new yc({size:this.gridSize,proxyFactory:(i,r)=>new Wg(i,r)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(t){return this.hashGrid.query(t)}rayCast(t,i){var r,o,h;const u=[],_=(r=i==null?void 0:i.maxDistance)!==null&&r!==void 0?r:1/0,A=i==null?void 0:i.collisionGroup,y=A?A.category:(o=i==null?void 0:i.collisionMask)!==null&&o!==void 0?o:nr.All.category,w=(h=i==null?void 0:i.searchAllColliders)!==null&&h!==void 0?h:!1,f=t.dir.normalize(),T=f.y/f.x,C=f.x/f.y,S=Math.sqrt(1+T*T)*this.gridSize,E=Math.sqrt(1+C*C)*this.gridSize,W=t.pos.x/this.gridSize,D=t.pos.y/this.gridSize,H=ft(1,1);let k=~~W,N=~~D,Q=0,L=0;f.x<0?(H.x=-1,Q=(W-k)*S):(H.x=1,Q=(k+1-W)*S),f.y<0?(H.y=-1,L=(D-N)*E):(H.y=1,L=(N+1-D)*E);const O=new Set;let Y=!1,ot=9999;for(;!Y&&ot>0&&(ot--,!!this.hashGrid.bounds.contains(ft(k*this.gridSize,N*this.gridSize)));){const nt=ks.calculateHashKey(k,N),et=this.hashGrid.sparseHashGrid.get(nt);if(et){const ut=[];for(let Z=0;Z<et.proxies.length;Z++){const I=et.proxies[Z];if(!O.has(I.collider.id.value)){if(O.add(I.collider.id.value),i!=null&&i.ignoreCollisionGroupAll&&I.body.group===nr.All)continue;const R=(y&I.body.group.category)!==0;if(I.body.group&&!R)continue;const q=I.collider.rayCast(t,_);q&&ut.push(q)}}ut.sort((Z,I)=>Z.distance-I.distance);for(let Z=0;Z<ut.length;Z++){const I=ut[Z];if(i!=null&&i.filter){if(i.filter(I)&&(u.push(I),!w)){Y=!0;break}}else if(u.push(I),!w){Y=!0;break}}}Q<L?(k+=H.x,Q+=S):(N+=H.y,L+=E)}return u.sort((nt,et)=>nt.distance-et.distance),!w&&u.length?[u[0]]:u}track(t){let i=[t];if(t instanceof fi){const r=t.getColliders();for(const o of r)o.owner=t.owner;i=r}for(const r of i)this.hashGrid.track(r)}untrack(t){let i=[t];t instanceof fi&&(i=t.getColliders());for(const r of i)this.hashGrid.untrack(r)}_canCollide(t,i){return!(t.collider.id===i.collider.id||t.owner&&i.owner&&t.owner.id===i.owner.id||t.hasZeroBounds||i.hasZeroBounds||!t.body.group.canCollide(i.body.group)||t.collisionType===ie.Fixed&&i.collisionType===ie.Fixed||t.collisionType===ie.PreventCollision||i.collisionType===ie.PreventCollision||!t.owner.isActive||!i.owner.isActive)}broadphase(t,i){const r=[];this._pairs.clear(),this._nonPairs.clear();let o=0;for(const h of this.hashGrid.objectToProxy.values())if(h.id=o++,!(!h.owner.isActive||h.collisionType===ie.PreventCollision))for(let u=0;u<h.cells.length;u++){const _=h.cells[u];for(let A=0;A<_.proxies.length;A++){const y=_.proxies[A];if(y.id===h.id)continue;const w=Ui.calculatePairHash(h.collider.id,y.collider.id);if(!this._nonPairs.has(w))if(!this._pairs.has(w)&&this._canCollide(h,y)&&h.object.bounds.overlaps(y.object.bounds)){const f=this._pairPool.get();f.colliderA=h.collider,f.colliderB=y.collider,f.id=w,this._pairs.add(w),r.push(f)}else this._nonPairs.add(w)}}return r}narrowphase(t,i){const r=[];for(let o=0;o<t.length;o++){const h=t[o].collide();for(let u=0;u<h.length;u++){const _=h[u];r.push(_),i&&i.physics.contacts.set(_.id,_)}}return this._pairPool.done(),i&&(i.physics.collisions+=r.length),r}update(t,i){return this.hashGrid.update(t)}debug(t,i){this.hashGrid.debug(t,i)}}class qg{get config(){return G_(this._config,t=>{this.$configUpdate.notifyAll(t)})}set config(t){this._config=t,this.$configUpdate.notifyAll(t)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const t=this._collisionProcessor.getColliders();this._config.spatialPartition===Nn.SparseHashGrid?this._collisionProcessor=new Bl(this._config.sparseHashGrid):this._collisionProcessor=new Ha(this._config);for(const i of t)this._collisionProcessor.track(i)}return this._collisionProcessor}constructor(t){this.$configUpdate=new zi,this._configDirty=!1,this.config=t,this.$configUpdate.subscribe(i=>{this._configDirty=!0,fe.updateDefaultPhysicsConfig(i.bodies)}),this._config.spatialPartition===Nn.SparseHashGrid?this._collisionProcessor=new Bl(this._config.sparseHashGrid):this._collisionProcessor=new Ha(this._config)}rayCast(t,i){return this.collisionProcessor.rayCast(t,i)}query(t){return this._collisionProcessor.query(t)}}class rh{constructor(){this.events=new Ue,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(t){this._enabled=t}setMinimumGamepadConfiguration(t){this._enableAndUpdate(),this._minimumConfiguration=t}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(t){if(!this._minimumConfiguration)return!0;if(!t)return!1;const i=t.axes.filter(o=>typeof o!==void 0).length,r=t.buttons.filter(o=>typeof o!==void 0).length;return i>=this._minimumConfiguration.axis&&r>=this._minimumConfiguration.buttons&&t.connected}emit(t,i){this.events.emit(t,i)}on(t,i){return this._enableAndUpdate(),this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this._enableAndUpdate(),this.events.off(t,i)}update(){if(!this.enabled||!this.supported||!this._enabled)return;this.init();const t=this._navigator.getGamepads();for(let i=0;i<t.length;i++){if(t[i])!this.at(i).connected&&this._isGamepadValid(t[i])&&this.events.emit("connect",new Zl(i,this.at(i))),this.at(i).connected=!0;else{const A=this.at(i);A.connected&&this.events.emit("disconnect",new $l(i,A)),A.connected=!1;continue}if(this.at(i).update(),t[i].timestamp&&t[i].timestamp===this._gamePadTimeStamps[i])continue;this._gamePadTimeStamps[i]=t[i].timestamp,this.at(i).navigatorGamepad=t[i];let r,o,h,u,_;for(r in Po)o=Po[r],typeof o=="number"&&t[i].buttons[o]&&(_=t[i].buttons[o].value,_!==this._oldPads[i].getButton(o)&&(t[i].buttons[o].pressed?(this.at(i).updateButton(o,_),this.at(i).events.emit("button",new Jl(o,_,this.at(i)))):this.at(i).updateButton(o,0)));for(h in Do)u=Do[h],typeof u=="number"&&(_=t[i].axes[u],_!==this._oldPads[i].getAxes(u)&&(this.at(i).updateAxes(u,_),this.at(i).events.emit("axis",new Kl(u,_,this.at(i)))));this._oldPads[i]=this._clonePad(t[i])}}at(t){if(this._enableAndUpdate(),t>=this._pads.length)for(let i=this._pads.length-1,r=t;i<r;i++)this._pads.push(new Sa),this._oldPads.push(new Sa);return this._pads[t]}getValidGamepads(){this._enableAndUpdate();const t=[];for(let i=0;i<this._pads.length;i++)this._isGamepadValid(this.at(i).navigatorGamepad)&&this.at(i).connected&&t.push(this.at(i));return t}count(){return this._pads.filter(t=>t.connected).length}_clonePads(t){const i=[];for(let r=0,o=t.length;r<o;r++)i.push(this._clonePad(t[r]));return i}_clonePad(t){let i,r;const o=new Sa;if(!t)return o;for(i=0,r=t.buttons.length;i<r;i++)t.buttons[i]&&o.updateButton(i,t.buttons[i].value);for(i=0,r=t.axes.length;i<r;i++)o.updateAxes(i,t.axes[i]);return o}}rh.MinAxisMoveThreshold=.05;class Sa{constructor(){this.events=new Ue,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let t=0;t<this._buttons.length;t++)this._buttons[t]=0;for(let t=0;t<this._axes.length;t++)this._axes[t]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(t,i=1){return this._buttons[t]>=i}isButtonHeld(t,i=1){return this._buttons[t]>=i}wasButtonPressed(t,i=1){return this._buttonsDown[t]>=i}wasButtonReleased(t){return!!this._buttonsUp[t]}getButton(t){return this._buttons[t]}getAxes(t){const i=this._axes[t];return Math.abs(i)<rh.MinAxisMoveThreshold?0:i}updateButton(t,i){i===0&&this._buttons[t]?this._buttonsUp[t]=1:this._buttonsDown[t]=i,this._buttons[t]=i}updateAxes(t,i){this._axes[t]=i}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}}var Po;(function(c){c[c.Face1=0]="Face1",c[c.Face2=1]="Face2",c[c.Face3=2]="Face3",c[c.Face4=3]="Face4",c[c.LeftBumper=4]="LeftBumper",c[c.RightBumper=5]="RightBumper",c[c.LeftTrigger=6]="LeftTrigger",c[c.RightTrigger=7]="RightTrigger",c[c.Select=8]="Select",c[c.Start=9]="Start",c[c.LeftStick=10]="LeftStick",c[c.RightStick=11]="RightStick",c[c.DpadUp=12]="DpadUp",c[c.DpadDown=13]="DpadDown",c[c.DpadLeft=14]="DpadLeft",c[c.DpadRight=15]="DpadRight"})(Po||(Po={}));var Do;(function(c){c[c.LeftStickX=0]="LeftStickX",c[c.LeftStickY=1]="LeftStickY",c[c.RightStickX=2]="RightStickX",c[c.RightStickY=3]="RightStickY"})(Do||(Do={}));class Vg{constructor(t){this.inputs=t,this._handlers=new Map}execute(){for(const[t,i]of this._handlers.entries()){const r=t(this.inputs);r&&i(r)}}on(t,i){this._handlers.set(t,i)}}function jg(){try{const c=()=>{};window.top.addEventListener("blur",c),window.top.removeEventListener("blur",c)}catch{return!0}return!1}var Ro;(function(c){c.Backquote="Backquote",c.Backslash="Backslash",c.BracketLeft="BracketLeft",c.BracketRight="BracketRight",c.Comma="Comma",c.Key0="Digit0",c.Key1="Digit1",c.Key2="Digit2",c.Key3="Digit3",c.Key4="Digit4",c.Key5="Digit5",c.Key6="Digit6",c.Key7="Digit7",c.Key8="Digit8",c.Key9="Digit9",c.Digit0="Digit0",c.Digit1="Digit1",c.Digit2="Digit2",c.Digit3="Digit3",c.Digit4="Digit4",c.Digit5="Digit5",c.Digit6="Digit6",c.Digit7="Digit7",c.Digit8="Digit8",c.Digit9="Digit9",c.Equal="Equal",c.IntlBackslash="IntlBackslash",c.IntlRo="IntlRo",c.IntlYen="IntlYen",c.A="KeyA",c.B="KeyB",c.C="KeyC",c.D="KeyD",c.E="KeyE",c.F="KeyF",c.G="KeyG",c.H="KeyH",c.I="KeyI",c.J="KeyJ",c.K="KeyK",c.L="KeyL",c.M="KeyM",c.N="KeyN",c.O="KeyO",c.P="KeyP",c.Q="KeyQ",c.R="KeyR",c.S="KeyS",c.T="KeyT",c.U="KeyU",c.V="KeyV",c.W="KeyW",c.X="KeyX",c.Y="KeyY",c.Z="KeyZ",c.KeyA="KeyA",c.KeyB="KeyB",c.KeyC="KeyC",c.KeyD="KeyD",c.KeyE="KeyE",c.KeyF="KeyF",c.KeyG="KeyG",c.KeyH="KeyH",c.KeyI="KeyI",c.KeyJ="KeyJ",c.KeyK="KeyK",c.KeyL="KeyL",c.KeyM="KeyM",c.KeyN="KeyN",c.KeyO="KeyO",c.KeyP="KeyP",c.KeyQ="KeyQ",c.KeyR="KeyR",c.KeyS="KeyS",c.KeyT="KeyT",c.KeyU="KeyU",c.KeyV="KeyV",c.KeyW="KeyW",c.KeyX="KeyX",c.KeyY="KeyY",c.KeyZ="KeyZ",c.Minus="Minus",c.Period="Period",c.Quote="Quote",c.Semicolon="Semicolon",c.Slash="Slash",c.AltLeft="AltLeft",c.AltRight="AltRight",c.Alt="Alt",c.AltGraph="AltGraph",c.Backspace="Backspace",c.CapsLock="CapsLock",c.ContextMenu="ContextMenu",c.ControlLeft="ControlLeft",c.ControlRight="ControlRight",c.Enter="Enter",c.MetaLeft="MetaLeft",c.MetaRight="MetaRight",c.ShiftLeft="ShiftLeft",c.ShiftRight="ShiftRight",c.Space="Space",c.Tab="Tab",c.Convert="Convert",c.KanaMode="KanaMode",c.NonConvert="NonConvert",c.Delete="Delete",c.End="End",c.Help="Help",c.Home="Home",c.Insert="Insert",c.PageDown="PageDown",c.PageUp="PageUp",c.Up="ArrowUp",c.Down="ArrowDown",c.Left="ArrowLeft",c.Right="ArrowRight",c.ArrowUp="ArrowUp",c.ArrowDown="ArrowDown",c.ArrowLeft="ArrowLeft",c.ArrowRight="ArrowRight",c.NumLock="NumLock",c.Numpad0="Numpad0",c.Numpad1="Numpad1",c.Numpad2="Numpad2",c.Numpad3="Numpad3",c.Numpad4="Numpad4",c.Numpad5="Numpad5",c.Numpad6="Numpad6",c.Numpad7="Numpad7",c.Numpad8="Numpad8",c.Numpad9="Numpad9",c.Num0="Numpad0",c.Num1="Numpad1",c.Num2="Numpad2",c.Num3="Numpad3",c.Num4="Numpad4",c.Num5="Numpad5",c.Num6="Numpad6",c.Num7="Numpad7",c.Num8="Numpad8",c.Num9="Numpad9",c.NumAdd="NumpadAdd",c.NumpadAdd="NumpadAdd",c.NumDecimal="NumpadDecimal",c.NumpadDecimal="NumpadDecimal",c.NumDivide="NumpadDivide",c.NumpadDivide="NumpadDivide",c.NumEnter="NumpadEnter",c.NumpadEnter="NumpadEnter",c.NumMultiply="NumpadMultiply",c.NumpadMultiply="NumpadMultiply",c.NumSubtract="NumpadSubtract",c.NumpadSubtract="NumpadSubtract",c.Esc="Escape",c.Escape="Escape",c.F1="F1",c.F2="F2",c.F3="F3",c.F4="F4",c.F5="F5",c.F6="F6",c.F7="F7",c.F8="F8",c.F9="F9",c.F10="F10",c.F11="F11",c.F12="F12",c.F13="F13",c.F14="F14",c.F15="F15",c.F16="F16",c.F17="F17",c.F18="F18",c.F19="F19",c.F20="F20",c.PrintScreen="PrintScreen",c.ScrollLock="ScrollLock",c.Pause="Pause",c.Unidentified="Unidentified"})(Ro||(Ro={}));class vo extends le{constructor(t,i,r){super(),this.key=t,this.value=i,this.originalEvent=r}}class Yg{constructor(){this.events=new Ue,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=t=>{for(const i of this._keys){const r=new vo(i,t.key,t);this.events.emit("up",r),this.events.emit("release",r)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=t=>{if(!this._enabled)return;!t.metaKey&&(this._keys.includes(Ro.MetaLeft)||this._keys.includes(Ro.MetaRight))&&this._releaseAllKeys(t);const i=t.code;if(this._keys.indexOf(i)===-1){this._keys.push(i),this._keysDown.push(i);const r=new vo(i,t.key,t);this.events.emit("down",r),this.events.emit("press",r)}},this._handleKeyUp=t=>{if(!this._enabled)return;const i=t.code,r=this._keys.indexOf(i);this._keys.splice(r,1),this._keysUp.push(i);const o=new vo(i,t.key,t);this.events.emit("up",o),this.events.emit("release",o),t.key==="Meta"&&this._releaseAllKeys(t)}}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}init(t){let{global:i}=t;const{grabWindowFocus:r}=t;i||(jg()?(i=window,r&&window.focus(),$t.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):i=window.top),i.addEventListener("blur",()=>{this._keys.length=0}),i.addEventListener("keyup",this._handleKeyUp),i.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(t){this._enabled=t}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let t=0;t<this._keys.length;t++)this.events.emit("hold",new vo(this._keys[t]))}getKeys(){return this._keys}wasPressed(t){return this._enabled?this._keysDown.indexOf(t)>-1:!1}isHeld(t){return this._enabled?this._keys.indexOf(t)>-1:!1}wasReleased(t){return this._enabled?this._keysUp.indexOf(t)>-1:!1}triggerEvent(t,i,r){t==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:i,key:r??null})),t==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:i,key:r??null}))}}class Gn{static fromPagePosition(t,i,r){let o,h,u,_;arguments.length===3?(o=t,h=i,u=new rt(o,h),_=r):(u=t,o=u.x,h=u.y,_=i);const A=_.screen.pageToScreenCoordinates(u),y=_.screen.screenToWorldCoordinates(A);return new Gn(y,u,A)}constructor(t,i,r){this.worldPos=t,this.pagePos=i,this.screenPos=r}}class wo{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(t,i,r,o,h,u){this.type=t,this.pointerId=i,this.button=r,this.pointerType=o,this.coordinates=h,this.nativeEvent=u,this.active=!0}}class Xg{cancel(){this.active=!1}constructor(t,i,r,o,h,u,_,A,y,w,f,T){this.x=t,this.y=i,this.pageX=r,this.pageY=o,this.screenX=h,this.screenY=u,this.index=_,this.deltaX=A,this.deltaY=y,this.deltaZ=w,this.deltaMode=f,this.ev=T,this.active=!0}}class Tl{constructor(){this.events=new Ue,this.lastPagePos=rt.Zero,this.lastScreenPos=rt.Zero,this.lastWorldPos=rt.Zero,this._onPointerMove=t=>{this.lastPagePos=new rt(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new rt(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new rt(t.worldPos.x,t.worldPos.y)},this._onPointerDown=t=>{this.lastPagePos=new rt(t.pagePos.x,t.pagePos.y),this.lastScreenPos=new rt(t.screenPos.x,t.screenPos.y),this.lastWorldPos=new rt(t.worldPos.x,t.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}_updateWorldPosition(t){const i=Gn.fromPagePosition(this.lastPagePos,t);this.lastScreenPos=i.screenPos,this.lastWorldPos=i.worldPos}}var Ln;(function(c){c.Pixel="Pixel",c.Line="Line",c.Page="Page"})(Ln||(Ln={}));var Cr;(function(c){c[c.NoButton=-1]="NoButton",c[c.Left=0]="Left",c[c.Middle=1]="Middle",c[c.Right=2]="Right",c[c.Unknown=3]="Unknown"})(Cr||(Cr={}));var Js;(function(c){c.Left="Left",c.Middle="Middle",c.Right="Right",c.Unknown="Unknown",c.NoButton="NoButton"})(Js||(Js={}));var Ks;(function(c){c.Touch="Touch",c.Mouse="Mouse",c.Pen="Pen",c.Unknown="Unknown"})(Ks||(Ks={}));function Yp(c){return globalThis.TouchEvent&&c instanceof globalThis.TouchEvent}function Xp(c){return globalThis.PointerEvent&&c instanceof globalThis.PointerEvent}class nh{constructor(t,i){this.target=t,this.engine=i,this.events=new Ue,this.primary=new Tl,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(t){this._enabled=t}recreate(t,i){const r=new nh(t,i);return r.primary=this.primary,r._pointers=this._pointers,r}at(t){if(t>=this._pointers.length)for(let i=this._pointers.length-1,r=t;i<r;i++)this._pointers.push(new Tl);return this._pointers[t]}count(){return this._pointers.length}isDown(t){var i;return this._enabled&&(i=this.currentFramePointerDown.get(t))!==null&&i!==void 0?i:!1}wasDown(t){var i;return this._enabled&&(i=this.lastFramePointerDown.get(t))!==null&&i!==void 0?i:!1}isDragging(t){return this._enabled?this.isDown(t):!1}isDragStart(t){return this._enabled?this.isDown(t)&&!this.wasDown(t):!1}isDragEnd(t){return this._enabled?!this.isDown(t)&&this.wasDown(t):!1}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const t of this.currentFrameDown){if(!t.active)continue;this.emit("down",t),this.at(t.pointerId).emit("down",t),this.primary.emit("pointerdown",t)}for(const t of this.currentFrameUp){if(!t.active)continue;this.emit("up",t),this.at(t.pointerId).emit("up",t)}for(const t of this.currentFrameMove){if(!t.active)continue;this.emit("move",t),this.at(t.pointerId).emit("move",t)}for(const t of this.currentFrameCancel){if(!t.active)continue;this.emit("cancel",t),this.at(t.pointerId).emit("cancel",t)}for(const t of this.currentFrameWheel)t.active&&(this.emit("pointerwheel",t),this.emit("wheel",t),this.primary.emit("pointerwheel",t),this.primary.emit("wheel",t));if(this.engine.currentScene.camera.hasChanged())for(const t of this._pointers)t._updateWorldPosition(this.engine)}clear(){for(const t of this.currentFrameUp){this.currentFramePointerCoords.delete(t.pointerId);const i=this._activeNativePointerIdsToNormalized.entries();for(const[r,o]of i)o===t.pointerId&&this._activeNativePointerIdsToNormalized.delete(r)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(t){var i;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const r={passive:!(this.engine.pageScrollPreventionMode===Ir.All||this.engine.pageScrollPreventionMode===Ir.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,r):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,r):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,r),((i=t==null?void 0:t.grabWindowFocus)!==null&&i!==void 0?i:!0)&&jg()){const h=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",h):(this.target.addEventListener("touchstart",h),this.target.addEventListener("mousedown",h))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(t){this._activeNativePointerIdsToNormalized.set(t,-1);const r=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((o,h)=>o-h).findIndex(o=>o===t);return this._activeNativePointerIdsToNormalized.set(t,r),r}_handle(t){if(!this._enabled)return;t.preventDefault();const i=new Map;let r,o;if(Yp(t)){r=Js.Unknown,o=Ks.Touch;for(let h=0;h<t.changedTouches.length;h++){const u=t.changedTouches[h],_=Gn.fromPagePosition(u.pageX,u.pageY,this.engine),A=h+1,y=this._normalizePointerId(A);this.currentFramePointerCoords.set(y,_),i.set(y,_)}}else{r=this._nativeButtonToPointerButton(t.button),o=Ks.Mouse;const h=Gn.fromPagePosition(t.pageX,t.pageY,this.engine);let u=1;Xp(t)&&(u=t.pointerId,o=this._stringToPointerType(t.pointerType));const _=this._normalizePointerId(u);this.currentFramePointerCoords.set(_,h),i.set(_,h)}for(const[h,u]of i.entries())switch(t.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new wo("down",h,r,o,u,t)),this.currentFramePointerDown.set(h,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new wo("up",h,r,o,u,t)),this.currentFramePointerDown.set(h,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new wo("move",h,r,o,u,t));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new wo("cancel",h,r,o,u,t));break}}_handleWheel(t){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===Ir.All||this.engine.pageScrollPreventionMode===Ir.Canvas&&t.target===this.engine.canvas)&&t.preventDefault();const i=this.engine.screen.pageToScreenCoordinates(ft(t.pageX,t.pageY)),r=this.engine.screen.screenToWorldCoordinates(i),o=-1/40,h=t.deltaX||t.wheelDeltaX*o||0,u=t.deltaY||t.wheelDeltaY*o||t.wheelDelta*o||t.detail||0,_=t.deltaZ||0;let A=Ln.Pixel;t.deltaMode&&(t.deltaMode===1?A=Ln.Line:t.deltaMode===2&&(A=Ln.Page));const y=new Xg(r.x,r.y,t.pageX,t.pageY,i.x,i.y,0,h,u,_,A,t);this.currentFrameWheel.push(y)}triggerEvent(t,i){const r=this.engine.screen.worldToPageCoordinates(i);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+t,{pointerId:0,clientX:r.x,clientY:r.y})):this._handle(new window.MouseEvent("mouse"+t,{clientX:r.x,clientY:r.y}));const o=this.engine.currentScene.world.get(sh);o.preupdate(this.engine.currentScene,1),o.update(1)}_nativeButtonToPointerButton(t){switch(t){case Cr.NoButton:return Js.NoButton;case Cr.Left:return Js.Left;case Cr.Middle:return Js.Middle;case Cr.Right:return Js.Right;case Cr.Unknown:return Js.Unknown;default:return Fu(t)}}_stringToPointerType(t){switch(t){case"touch":return Ks.Touch;case"mouse":return Ks.Mouse;case"pen":return Ks.Pen;default:return Ks.Unknown}}}class Ec{constructor(t){this._enabled=!0;const{pointerTarget:i,grabWindowFocus:r,engine:o}=t;this.keyboard=new Yg,this.pointers=new nh(i,o),this.gamepads=new rh,this.keyboard.init({grabWindowFocus:r}),this.pointers.init({grabWindowFocus:r}),this.gamepads.init(),this.inputMapper=new Vg({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(t){this._enabled=t,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Zp{}const $p={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function Fs(c){var t,i;return!!(c!=null&&c.prototype)&&!!(!((i=(t=c==null?void 0:c.prototype)===null||t===void 0?void 0:t.constructor)===null||i===void 0)&&i.name)}class rs{get actors(){return this.world.entityManager.entities.filter(t=>t instanceof Ni)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(t=>t instanceof Lg)}get tileMaps(){return this.world.entityManager.entities.filter(t=>t instanceof Tg)}get timers(){return this._timers}constructor(){this._logger=$t.getInstance(),this.events=new Ue,this.camera=new Qg,this.world=new Og(this),this.physics=new qg(sr()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(xc),this.world.add(new eh(this.world,this.physics)),this.world.add(new ih(this.world,this.physics)),this.world.add(sh),this.world.add(bc),this.world.add(Cc),this.world.add(mc),this.world.add(vc)}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}onPreLoad(t){}onTransition(t){}onInitialize(t){}onActivate(t){}onDeactivate(t){}onPreUpdate(t,i){}onPostUpdate(t,i){}onPreDraw(t,i){}onPostDraw(t,i){}_initializeChildren(){for(const t of this.entities)t._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(t){var i;if(!this.isInitialized){try{this.engine=t,this.physics.config=this.engine.physics,this.input=new Ec({pointerTarget:t.pointerScope===cn.Canvas?t.canvas:document,grabWindowFocus:t.grabWindowFocus,engine:t}),this.camera._initialize(t),this.world.systemManager.initialize(),await this.onInitialize(t),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,t),this.events.emit("initialize",new Xn(t,this))}catch(r){throw this._logger.error(`Error during scene initialization for scene ${(i=t.director)===null||i===void 0?void 0:i.getSceneName(this)}!`),r}this._isInitialized=!0}}async _activate(t){var i,r;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(t)}catch(o){throw this._logger.error(`Error during scene activation for scene ${(r=(i=this.engine)===null||i===void 0?void 0:i.director)===null||r===void 0?void 0:r.getSceneName(this)}!`),o}}async _deactivate(t){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(t)}_preupdate(t,i){this.emit("preupdate",new Sr(t,i,this)),this.onPreUpdate(t,i)}_postupdate(t,i){this.emit("postupdate",new Pr(t,i,this)),this.onPostUpdate(t,i)}_predraw(t,i){this.emit("predraw",new jn(t,i,this)),this.onPreDraw(t,i)}_postdraw(t,i){this.emit("postdraw",new Yn(t,i,this)),this.onPostDraw(t,i)}update(t,i){var r;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(r=t.director)===null||r===void 0?void 0:r.getSceneName(this)}!`);return}this._preupdate(t,i);let o,h;for(o=0,h=this._cancelQueue.length;o<h;o++)this.removeTimer(this._cancelQueue[o]);this._cancelQueue.length=0;for(const u of this._timers)u.update(i);this.world.update(es.Update,i),this.camera&&this.camera.update(t,i),this._collectActorStats(t),this._postupdate(t,i),this.input.update()}draw(t,i){var r;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(t,i),this.world.update(es.Draw,i),!((r=this.engine)===null||r===void 0)&&r.isDebug&&this.debugDraw(t),this._postdraw(t,i)}debugDraw(t){this.emit("predebugdraw",new Vl(t,this)),this.emit("postdebugdraw",new jl(t,this))}contains(t){return this.actors.indexOf(t)>-1}add(t){if(this.emit("entityadded",{target:t}),this.world.add(t),t.scene=this,t instanceof an){Ru(this._timers,t)||this.addTimer(t);return}}transfer(t){let i;t instanceof Di&&t.scene&&t.scene!==this&&(i=t.scene,t.scene.world.remove(t,!1)),t instanceof an&&t.scene&&(i=t.scene,t.scene.removeTimer(t)),i==null||i.emit("entityremoved",{target:t}),this.add(t)}remove(t){t instanceof Di&&(this.emit("entityremoved",{target:t}),t.isActive&&t.kill(),this.world.remove(t)),t instanceof an&&this.removeTimer(t)}clear(t=!0){for(let i=this.entities.length-1;i>=0;i--)this.world.remove(this.entities[i],t);for(let i=this.timers.length-1;i>=0;i--)this.removeTimer(this.timers[i])}addTimer(t){return this._timers.push(t),t.scene=this,t}removeTimer(t){const i=this._timers.indexOf(t);return i!==-1&&this._timers.splice(i,1),t}cancelTimer(t){return this._cancelQueue.push(t),t}isTimerActive(t){return this._timers.indexOf(t)>-1&&!t.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(t){const i=this.actors;for(let r=0;r<i.length;r++){const o=i[r];o instanceof pc&&t.stats.currFrame.actors.ui++,t.stats.currFrame.actors.alive++;for(let h=0;h<o.children.length;h++){const u=o.children[h];Bg(u)?t.stats.currFrame.actors.ui++:t.stats.currFrame.actors.alive++}}}}var hn;(function(c){c.Protanope="Protanope",c.Deuteranope="Deuteranope",c.Tritanope="Tritanope"})(hn||(hn={}));const Jp=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class Zg{constructor(t,i){this._shader=new Yi({gl:t,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:i}),this._shader.compile(),this._buffer=new Us({gl:t,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new or({gl:t,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class $g{constructor(t,i=!1){this._colorBlindnessMode=t,this._simulate=!1,this._simulate=i}initialize(t){this._shader=new Zg(t,Jp),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(t){if(this._colorBlindnessMode=t,this._shader){const i=this._shader.getShader();i.use(),this._colorBlindnessMode===hn.Protanope?i.setUniformInt("u_type",0):this._colorBlindnessMode===hn.Deuteranope?i.setUniformInt("u_type",1):this._colorBlindnessMode===hn.Tritanope&&i.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(t){if(this._simulate=t,this._shader){const i=this._shader.getShader();i.use(),i.setUniformBoolean("u_simulate",t)}}get simulate(){return this._simulate}}class Jg{constructor(t){this._engine=t,this._colorBlindPostProcessor=new $g(hn.Protanope)}correct(t){this._engine.graphicsContext instanceof ir&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(t){this._engine.graphicsContext instanceof ir&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=t,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class Kg{constructor(t){this.stats={currFrame:new Fo,prevFrame:new Fo},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:kt.Yellow,showZIndex:!1,showScale:!1,scaleColor:kt.Green,showRotation:!1,rotationColor:kt.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:kt.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:kt.Blue,showOwner:!1,showGeometry:!0,geometryColor:kt.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:kt.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:kt.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:kt.Yellow,showAcceleration:!1,accelerationColor:kt.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:kt.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:kt.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:kt.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:kt.Yellow,positionSize:1,showGrid:!1,gridColor:kt.Red,gridWidth:1,showColliderGeometry:!0},this._engine=t,this.colorBlindMode=new Jg(this._engine)}useTestClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const r=t.toTestClock();return i&&r.start(),this._engine.clock=r,r}useStandardClock(){const t=this._engine.clock,i=t.isRunning();t.stop();const r=t.toStandardClock();return i&&r.start(),this._engine.clock=r,r}}class Fo{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new oh,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(t){t?(this.id=t.id,this.elapsedMs=t.elapsedMs,this.fps=t.fps,this.actors.alive=t.actors.alive,this.actors.killed=t.actors.killed,this.actors.ui=t.actors.ui,this.duration.update=t.duration.update,this.duration.draw=t.duration.draw,this._physicsStats.reset(t.physics),this.graphics.drawCalls=t.graphics.drawCalls,this.graphics.drawnImages=t.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const t=new Fo;return t.reset(this),t}get id(){return this._id}set id(t){this._id=t}get elapsedMs(){return this._elapsedMs}set elapsedMs(t){this._elapsedMs=t}get fps(){return this._fps}set fps(t){this._fps=t}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class oh{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(t){t?(this.pairs=t.pairs,this.collisions=t.collisions,this.contacts=t.contacts,this.fastBodies=t.fastBodies,this.fastBodyCollisions=t.fastBodyCollisions,this.broadphase=t.broadphase,this.narrowphase=t.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const t=new oh;return t.reset(this),t}get pairs(){return this._pairs}set pairs(t){this._pairs=t}get collisions(){return this._collisions}set collisions(t){this._collisions=t}get contacts(){return this._contacts}set contacts(t){this._contacts=t}get fastBodies(){return this._fastBodies}set fastBodies(t){this._fastBodies=t}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(t){this._fastBodyCollisions=t}get broadphase(){return this._broadphase}set broadphase(t){this._broadphase=t}get narrowphase(){return this._narrowphase}set narrowphase(t){this._narrowphase=t}}class Sl{on(t,i){this._nativeHandlers[t]&&this.off(t,this._nativeHandlers[t]),this._nativeHandlers[t]=this._decorate(i),this.nativeComponent.addEventListener(t,this._nativeHandlers[t])}off(t,i){i||(i=this._nativeHandlers[t]),this.nativeComponent.removeEventListener(t,i),this._nativeHandlers[t]=null}_decorate(t){return i=>{this._paused||t(i)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const t in this._nativeHandlers)this.off(t)}constructor(t){this.nativeComponent=t,this._paused=!1,this._nativeHandlers={}}}class tf{constructor(t,i){this._windowGlobal=t,this._documentGlobal=i,this._windowComponent=new Sl(this._windowGlobal),this._documentComponent=new Sl(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const ef={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:ii.Blended,canvasImageRendering:"auto"},sf={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:ii.Blended,canvasImageRendering:"auto"};class rf{constructor(t){var i;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=t.initialFps,this._samplePeriod=(i=t.samplePeriod)!==null&&i!==void 0?i:this._samplePeriod,this._currentFrameTime=1e3/t.initialFps,this._nowFn=t.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const t=this._nowFn();this._currentFrameTime=t-this._beginFrameTime,t>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(t-this._previousSampleTime),this._previousSampleTime=t,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class Ic{constructor(t){var i,r,o;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=t,this.tick=t.tick,this._lastTime=(i=this.now())!==null&&i!==void 0?i:0,this._maxFps=(r=t.maxFps)!==null&&r!==void 0?r:this._maxFps,this._onFatalException=(o=t.onFatalException)!==null&&o!==void 0?o:this._onFatalException,this.fpsSampler=new rf({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new nf({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new Bc({...this._options})}setFatalExceptionHandler(t){this._onFatalException=t}schedule(t,i=0,r="preframe"){const o=this._totalElapsed+i;this._scheduledCbs.push([t,o,r])}__runScheduledCbs(t="preframe"){for(let i=this._scheduledCbs.length-1;i>-1;i--)t===this._scheduledCbs[i][2]&&this._scheduledCbs[i][1]<=this._totalElapsed&&(this._scheduledCbs[i][0](this._elapsed),this._scheduledCbs.splice(i,1))}update(t){try{this.fpsSampler.start();const i=this.now();let r=i-this._lastTime||1;const o=1e3/this._maxFps;if(r>=o){let h=0;o!==0&&(h=r%o,r=r-h),r>200&&(r=1),this._elapsed=t||r,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(t||r),this.__runScheduledCbs("postframe"),o!==0?this._lastTime=i-h:this._lastTime=i,this.fpsSampler.end()}}catch(i){this._onFatalException(i),this.stop()}}}class Bc extends Ic{constructor(t){super(t),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const t=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(t),this.update()}catch(i){throw window.cancelAnimationFrame(this._requestId),i}};t()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class nf extends Ic{constructor(t){super({...t}),this._logger=$t.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=t.defaultUpdateMs}now(){var t;return(t=this._currentTime)!==null&&t!==void 0?t:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(t){const i=t??this._updateMs;this._running?(this.update(i),this._currentTime+=i):this._logger.warn("The clock is not running, no step will be performed")}run(t,i){for(let r=0;r<t;r++)this.step(i??this._updateMs)}}var Kp=_i(296);class of{constructor(){this._toasterCss=Kp.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(t){const i=document.createElement("span");return i.innerText=t,i}toast(t,i,r){this._initialize();const o=document.createElement("div");o.className="ex-toast-message";const h=t.split("[LINK]").map(w=>this._createFragment(w));if(i){const w=document.createElement("a");w.href=i,r?w.innerText=r:w.innerText=i,h.splice(1,0,w)}const u=document.createElement("div");h.forEach(w=>{u.appendChild(w)}),o.appendChild(u);const _=document.createElement("button");_.innerText="x",_.addEventListener("click",()=>{this._container.removeChild(o)}),o.appendChild(_);const A=w=>{if(w.key==="Escape")try{this._container.removeChild(o)}catch{}document.removeEventListener("keydown",A)};document.addEventListener("keydown",A);const y=this._container.firstChild;this._container.insertBefore(o,y)}}const tA={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class af{get isTransitioning(){return this._isTransitioning}constructor(t,i){this._engine=t,this.events=new Ue,this._logger=$t.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new rs,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const r in i){const o=i[r];this.add(r,o),r==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const t=this._deferredGoto;this._deferredGoto=void 0;const i=this._deferredTransition;this._deferredTransition=void 0;const r=this.getSceneInstance(t);r&&i&&i._addToTargetScene(this._engine,r),await this.swapScene(t),r&&i&&await this.playTransition(i,r)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(t,i){const r=i==null?void 0:i.loader;r instanceof Eo?this.mainLoader=r:vl(r)?this.mainLoader=new r:this.mainLoader=new fn;let o;if(i!=null&&i.inTransition){const{inTransition:h}=i;o=h}if(this.startScene=t,o){const h=this.getSceneInstance(this.startScene);h&&(o._addToTargetScene(this._engine,h),this.swapScene(this.startScene).then(()=>this.playTransition(o,h)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(t){return this._sceneToLoader.get(t)}_getInTransition(t){var i;const r=this.scenes[t];if(!(r instanceof rs||Fs(r)))return(i=r==null?void 0:r.transitions)===null||i===void 0?void 0:i.in}_getOutTransition(t){var i;const r=this.scenes[t];if(!(r instanceof rs||Fs(r)))return(i=r==null?void 0:r.transitions)===null||i===void 0?void 0:i.out}getDeferredScene(){const t=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&t?t:null}getSceneDefinition(t){const i=this.scenes[t];if(i instanceof rs||Fs(i))return i;if(i)return i.scene}getSceneName(t){for(const[i,r]of Object.entries(this.scenes))if(r instanceof rs){if(t===r)return i}else if(!Fs(r)&&t===r.scene)return i;for(const[i,r]of Object.entries(this.scenes))if(Fs(r)){if(t.constructor===r)return i}else if(!(r instanceof rs)&&t.constructor===r.scene)return i;return null}assertAdded(t){return this}assertRemoved(t){return this}add(t,i){if(!(i instanceof rs)&&!Fs(i)){const{loader:r,transitions:o}=i,{in:h,out:u}=o??{};this._sceneToTransition.set(t,{in:h,out:u}),vl(r)?this._sceneToLoader.set(t,new r):r&&this._sceneToLoader.set(t,r)}return this.scenes[t]&&this._logger.warn("Scene",t,"already exists overwriting"),this.scenes[t]=i,this.assertAdded(t)}remove(t){if(t instanceof rs||Fs(t)){const i=t;for(const r in this.scenes)if(this.scenes.hasOwnProperty(r)){const o=this.scenes[r];let h;if(o instanceof rs||Fs(o)?h=o:h=o.scene,h===i){if(r===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${r}`);this._sceneToInstance.delete(r),this._sceneToTransition.delete(r),this._sceneToLoader.delete(r),delete this.scenes[r]}}}if(typeof t=="string"){if(t===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${t}`);this._sceneToInstance.delete(t),this._sceneToTransition.delete(t),this._sceneToLoader.delete(t),delete this.scenes[t]}}async goToScene(t,i){var r,o,h,u,_,A;const y=this.getSceneInstance(t);if(!y){this._logger.warn(`Scene ${t} does not exist! Check the name, are you sure you added it?`);return}const w=this.currentScene,f=this.currentSceneName,T=(o=(r=this._engine.input)===null||r===void 0?void 0:r.enabled)!==null&&o!==void 0?o:!0;this._isTransitioning=!0;const C=(h=this.getSceneInstance(f))===null||h===void 0?void 0:h.onTransition("out"),S=y==null?void 0:y.onTransition("in");i={sourceOut:(u=this._getOutTransition(this.currentSceneName))!==null&&u!==void 0?u:C,destinationIn:(_=this._getInTransition(t))!==null&&_!==void 0?_:S,...i};const{sourceOut:E,destinationIn:W,sceneActivationData:D}=i,H=E??this._getOutTransition(this.currentSceneName),k=W??this._getInTransition(t),N=(H==null?void 0:H.hideLoader)||(k==null?void 0:k.hideLoader);N&&this.maybeLoadScene(t,N),this._emitEvent("navigationstart",f,t),H&&await this.playTransition(H,w),await this.maybeLoadScene(t,N),k&&await k.onPreviousSceneDeactivate(this.currentScene),k&&k._addToTargetScene(this._engine,y),await this.swapScene(t,D),this._emitEvent("navigation",f,t),k&&await this.playTransition(k,y),this._emitEvent("navigationend",f,t),(A=this._engine.input)===null||A===void 0||A.toggleEnabled(T),this._isTransitioning=!1}getSceneInstance(t){const i=this.getSceneDefinition(t);if(!i)return;if(this._sceneToInstance.has(t))return this._sceneToInstance.get(t);if(i instanceof rs)return this._sceneToInstance.set(t,i),i;const r=new i;return this._sceneToInstance.set(t,r),r}async maybeLoadScene(t,i=!1){var r;const o=(r=this._getLoader(t))!==null&&r!==void 0?r:new Eo,h=this.getSceneDefinition(t),u=this.getSceneInstance(t);h&&u&&!this._loadedScenes.has(u)&&(u.onPreLoad(o),u.events.emit("preload",{loader:o}),i?this._engine.load(o,i):await this._engine.load(o),this._loadedScenes.add(u))}async playTransition(t,i){var r,o,h,u,_,A,y;if(!this.isInitialized){this._deferredTransition=t;return}if(t){this.currentTransition=t;const w=(o=(r=i.input)===null||r===void 0?void 0:r.enabled)!==null&&o!==void 0?o:!0;(h=i.input)===null||h===void 0||h.toggleEnabled(!t.blockInput),(u=this._engine.input)===null||u===void 0||u.toggleEnabled(!t.blockInput),this.currentTransition._addToTargetScene(this._engine,i),await this.currentTransition._play(),(_=i.input)===null||_===void 0||_.toggleEnabled(w)}(A=this.currentTransition)===null||A===void 0||A.kill(),(y=this.currentTransition)===null||y===void 0||y.reset(),this.currentTransition=void 0}async swapScene(t,i){const r=this._engine;if(!this.isInitialized){this._deferredGoto=t;return}const o=this.getSceneInstance(t);if(o){const h=this.currentScene,u=o;if(this._logger.debug("Going to scene:",t),this.currentScene.isInitialized){const y={engine:r,previousScene:h,nextScene:u};await this.currentScene._deactivate(y),this.currentScene.events.emit("deactivate",new sc(y,this.currentScene)),this.currentScene.input.clear()}const _=this._sceneToLoader.get(t);await(_==null?void 0:_.areResourcesLoaded()),this.currentScene=u,this.currentSceneName=t,r.screen.setCurrentCamera(u.camera),await this.currentScene._initialize(r);const A={engine:r,previousScene:h,nextScene:u,data:i};await this.currentScene._activate(A),this.currentScene.events.emit("activate",new ic(A,this.currentScene))}else this._logger.error("Scene",t,"does not exist!")}_emitEvent(t,i,r){const o=this.getSceneDefinition(i),h=this.getSceneDefinition(r);this.events.emit(t,{sourceScene:o,sourceName:i,destinationScene:h,destinationName:r})}}function hf(){const c={scope:(t,i)=>{const r=c.value;c.value=t;try{return i()}catch(o){throw o}finally{c.value=r}},value:void 0};return c}function lf(c){return c.value}const Pl={textureCollectInterval:6e4};class cf{constructor(t){this.options=t,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=i=>{if(this._running){for(const[r,[o,h]]of this._collectors.entries()){const u=this.options.getTimestamp();for(const[_,[A,y]]of this._collectionMap.entries()){if(r!==A||y+h>=u)continue;o(_)&&this._collectionMap.delete(_)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(t,i,r){this._collectors.set(t,[r,i])}addCollectableResource(t,i){this._collectionMap.set(i,[t,this.options.getTimestamp()])}touch(t){const i=this._collectionMap.get(t);i&&this._collectionMap.set(t,[i[0],this.options.getTimestamp()])}forceCollectAll(){for(const[t,[i]]of this._collectors.entries())for(const[r]of this._collectionMap.entries())i(r)&&this._collectionMap.delete(r)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}Tu();const eA={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var Ir;(function(c){c[c.None=0]="None",c[c.Canvas=1]="Canvas",c[c.All=2]="All"})(Ir||(Ir={}));class Vi{static useEngine(){const t=lf(Vi.Context);if(!t)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return t}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(t){this.graphicsContext.snapToPixel=t}emit(t,i){this.events.emit(t,i)}on(t,i){return this.events.on(t,i)}once(t,i){return this.events.once(t,i)}off(t,i){this.events.off(t,i)}constructor(t){var i,r,o,h,u,_,A,y,w;this.scope=N=>Vi.Context.scope(this,N),this.version=Dl,this.events=new Ue,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=N=>{$t.getInstance().fatal(N,N.stack)},this._toaster=new of,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=N=>{var Q;N.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",N);const L=document.createElement("div");L.id="ex-webgl-graphics-context-lost",L.style.position="absolute",L.style.zIndex="99",L.style.left="50%",L.style.top="50%",L.style.display="flex",L.style.flexDirection="column",L.style.transform="translate(-50%, -50%)",L.style.backgroundColor="white",L.style.padding="10px",L.style.borderStyle="solid 1px";const O=document.createElement("div");if(O.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,L.appendChild(O),!((Q=this.canvas)===null||Q===void 0)&&Q.parentElement){this.canvas.parentElement.appendChild(L);const Y=O.querySelector("#ex-webgl-graphics-reload");Y==null||Y.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new ns,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],t={...Vi._DEFAULT_ENGINE_OPTIONS,...t},this._originalOptions=t,vi.freeze(),this.browser=new tf(window,document);const f=new ju;if(!t.suppressMinimumBrowserFeatureDetection&&!(this._compatible=f.test())){const N=document.createElement("div");if(N.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(N),f.failedTests.forEach(function(Q){const L=document.createElement("div");L.innerText="Browser feature missing "+Q,document.body.appendChild(L)}),t.canvasElementId){const Q=document.getElementById(t.canvasElementId);Q&&Q.parentElement.removeChild(Q)}return}else this._compatible=!0;if(console.log&&!t.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${Dl})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),t.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=$t.getInstance(),this._logger.defaultLevel===ri.Debug&&f.logBrowserFeatures(),this._logger.debug("Building engine..."),t.garbageCollection===!0?this.garbageCollectorConfig={...Pl}:t.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...Pl,...t.garbageCollection},this._garbageCollector=new cf({getTimestamp:Date.now}),this.canvasElementId=t.canvasElementId,t.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+t.canvasElementId),document.getElementById(t.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(t.canvasElementId)}else t.canvasElement?(this._logger.debug("Using Canvas element specified:",t.canvasElement),this.canvas=t.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!t.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",N=>{N.preventDefault()});let T=(i=t.displayMode)!==null&&i!==void 0?i:ui.Fixed;t.width&&t.height||t.viewport?(t.displayMode===void 0&&(T=ui.Fixed),this._logger.debug("Engine viewport is size "+t.width+" x "+t.height)):t.displayMode||(this._logger.debug("Engine viewport is fit"),T=ui.FitScreen),this.grabWindowFocus=t.grabWindowFocus,this.pointerScope=t.pointerScope,this._originalDisplayMode=T;let C,S,E,W,D,H;typeof t.antialiasing=="object"?{pixelArtSampler:C,nativeContextAntialiasing:E,multiSampleAntialiasing:H,filtering:D,canvasImageRendering:W}={...t.pixelArt?sf:ef,...t.antialiasing}:(C=!!t.pixelArt,E=!1,H=t.antialiasing,W=t.antialiasing?"auto":"pixelated",D=t.antialiasing?ii.Blended:ii.Pixel),E&&H&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),t.pixelArt&&(S=.25),(!t.antialiasing||D===ii.Pixel)&&(S=0),S=(o=(r=t.uvPadding)!==null&&r!==void 0?r:S)!==null&&o!==void 0?o:.01;let k=vi.isEnabled("use-canvas-context");if(!k)try{this.graphicsContext=new ir({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:C,antialiasing:E,multiSampleAntialiasing:H,uvPadding:S,powerPreference:t.powerPreference,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(h=t.handleContextLost)!==null&&h!==void 0?h:this._handleWebGLContextLost,handleContextRestored:t.handleContextRestored})}catch(N){this._logger.warn(`Excalibur could not load webgl for some reason (${N.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),k=!0}k&&(this.graphicsContext=new Oa({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:E,backgroundColor:t.backgroundColor,snapToPixel:t.snapToPixel,useDrawSorting:t.useDrawSorting})),this.screen=new ml({canvas:this.canvas,context:this.graphicsContext,antialiasing:E,canvasImageRendering:W,browser:this.browser,viewport:(u=t.viewport)!==null&&u!==void 0?u:t.width&&t.height?{width:t.width,height:t.height}:Al.SVGA,resolution:t.resolution,displayMode:T,pixelRatio:t.suppressHiDPIScaling?1:(_=t.pixelRatio)!==null&&_!==void 0?_:null}),Ne.filtering=D,t.backgroundColor&&(this.backgroundColor=t.backgroundColor.clone()),this.maxFps=(A=t.maxFps)!==null&&A!==void 0?A:this.maxFps,this.fixedUpdateTimestep=(y=t.fixedUpdateTimestep)!==null&&y!==void 0?y:this.fixedUpdateTimestep,this.fixedUpdateFps=(w=t.fixedUpdateFps)!==null&&w!==void 0?w:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new Bc({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:N=>this.onFatalException(N)}),this.enableCanvasTransparency=t.enableCanvasTransparency,typeof t.physics=="boolean"?this.physics={...sr(),enabled:t.physics}:(this.physics={...sr()},Da(this.physics,t.physics)),this.debug=new Kg(this),this.director=new af(this,t.scenes),this._initialize(t),window.___EXCALIBUR_DEVTOOL=this,Vi.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:t}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:i,showPlayerMessage:r}=this._originalOptions.configurePerformanceCanvas2DFallback;if(i===void 0&&(i=Vi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),r===void 0&&(r=Vi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!vi.isEnabled("use-canvas-context")&&t&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===i.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let o=0;for(let u=0;u<this._fpsSamples.length;u++)o+=this._fpsSamples[u];const h=o/this._fpsSamples.length;this._fpsSamples.length===i.numberOfFrames&&h<=i.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),r&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var t,i,r;const o=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(o,this.canvas),this.canvas=o;const h={...this._originalOptions,antialiasing:this.screen.antialiasing},u=this._originalDisplayMode;this.graphicsContext=new Oa({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:h.antialiasing,backgroundColor:h.backgroundColor,snapToPixel:h.snapToPixel,useDrawSorting:h.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new ml({canvas:this.canvas,context:this.graphicsContext,antialiasing:(t=h.antialiasing)!==null&&t!==void 0?t:!0,browser:this.browser,viewport:(i=h.viewport)!==null&&i!==void 0?i:h.width&&h.height?{width:h.width,height:h.height}:Al.SVGA,resolution:h.resolution,displayMode:u,pixelRatio:h.suppressHiDPIScaling?1:(r=h.pixelRatio)!==null&&r!==void 0?r:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const _=h&&h.pointerScope===cn.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(_,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,Vi.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(t){if(t<0){$t.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=t}addTimer(t){return this.currentScene.addTimer(t)}removeTimer(t){return this.currentScene.removeTimer(t)}addScene(t,i){return this.director.add(t,i),this}removeScene(t){this.director.remove(t)}add(t){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const i=this.director.getDeferredScene();i instanceof rs?i.add(t):this.currentScene.add(t)}remove(t){t instanceof Di&&this.currentScene.remove(t),(t instanceof rs||Fs(t))&&this.removeScene(t),typeof t=="string"&&this.removeScene(t)}async goToScene(t,i){await this.scope(async()=>{await this.director.goToScene(t,i)})}screenToWorldCoordinates(t){return this.screen.screenToWorldCoordinates(t)}worldToScreenCoordinates(t){return this.screen.worldToScreenCoordinates(t)}_initialize(t){var i,r;this.pageScrollPreventionMode=t.scrollPreventionMode;const o=t&&t.pointerScope===cn.Document?document:this.canvas,h=(r=(i=this._originalOptions)===null||i===void 0?void 0:i.grabWindowFocus)!==null&&r!==void 0?r:!0;this.input=new Ec({pointerTarget:o,grabWindowFocus:h,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new ec(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new tc(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!t.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(t){this._inputEnabled=t,this.input.toggleEnabled(this._inputEnabled)}onInitialize(t){}get isInitialized(){return this._isInitialized}async _overrideInitialize(t){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(t),this.events.emit("initialize",new Xn(t,this)),this._isInitialized=!0)}_update(t){var i;if(this._isLoading){(i=this._loader)===null||i===void 0||i.onUpdate(this,t),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(t),this.currentScene.update(this,t),this.graphicsContext.updatePostProcessors(t),this.clock.__runScheduledCbs("postupdate"),this._postupdate(t),this.input.update()}_preupdate(t){this.emit("preupdate",new Sr(this,t,this)),this.onPreUpdate(this,t)}onPreUpdate(t,i){}_postupdate(t){this.emit("postupdate",new Pr(this,t,this)),this.onPostUpdate(this,t)}onPostUpdate(t,i){}_draw(t){var i,r;if(this.graphicsContext.backgroundColor=(i=this.currentScene.backgroundColor)!==null&&i!==void 0?i:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,t),this._isLoading){this._hideLoader||((r=this._loader)===null||r===void 0||r.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,t),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,t),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(t,i){this.emit("predraw",new jn(t,i,this)),this.onPreDraw(t,i)}onPreDraw(t,i){}_postdraw(t,i){this.emit("postdraw",new Yn(t,i,this)),this.onPostDraw(t,i)}onPostDraw(t,i){}showDebug(t){this._isDebug=t}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(t,i){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let r;return t instanceof Eo?r=t:typeof t=="string"&&(this.director.configureStart(t,i),r=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(r??new fn),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new Ol(this)),this._isReadyFuture.promise})}_mainloop(t){this.scope(()=>{this.emit("preframe",new Yl(this,this.stats.prevFrame));const i=t*this.timescale;this.currentFrameElapsedMs=i;const r=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=r,this.stats.currFrame.elapsedMs=i,this.stats.currFrame.fps=this.clock.fpsSampler.fps,ze.clear();const o=this.clock.now(),h=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=i;this._lagMs>=h;)this._update(h),this._lagMs-=h;else this._update(i);const u=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(i);const _=this.clock.now();this.stats.currFrame.duration.update=u-o,this.stats.currFrame.duration.draw=_-u,this.stats.currFrame.graphics.drawnImages=ze.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=ze.DrawCallCount,this.emit("postframe",new Xl(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new Hl(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(t=!1){return new Promise(r=>{this._screenShotRequests.push({preserveHiDPIResolution:t,resolve:r})})}_checkForScreenShots(){for(const t of this._screenShotRequests){const i=t.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,r=t.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,o=document.createElement("canvas");o.width=i,o.height=r;const h=o.getContext("2d");h.imageSmoothingEnabled=this.screen.antialiasing,h.drawImage(this.canvas,0,0,i,r);const u=new Image,_=o.toDataURL("image/png");u.onload=()=>{t.resolve(u)},u.src=_}this._screenShotRequests.length=0}async load(t,i=!1){await this.scope(async()=>{try{if(t.isLoaded())return;this._loader=t,this._isLoading=!0,this._hideLoader=i,t instanceof fn&&(t.suppressPlayButton=t.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await t.load()}catch(r){this._logger.error("Error loading resources, things may not behave properly",r),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}Vi.Context=hf();Vi.InstanceCount=0;Vi._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:cn.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:Ir.Canvas,backgroundColor:kt.fromHex("#2185d0")};class iA extends Ni{set maxWidth(t){this._text.maxWidth=t}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(t){this._font=t,this._text.font=t}get text(){return this._text.text}set text(t){this._text.text=t}get color(){return this._text.color}set color(t){this._text&&(this._text.color=t)}get opacity(){return this.graphics.opacity}set opacity(t){this.graphics.opacity=t}get spriteFont(){return this._spriteFont}set spriteFont(t){t&&(this._spriteFont=t,this._text.font=this._spriteFont)}constructor(t){super(t),this._font=new dn,this._text=new zo({text:"",font:this._font});const{text:i,pos:r,x:o,y:h,spriteFont:u,font:_,color:A,maxWidth:y}={text:"",...t};this.pos=r??(o&&h?ft(o,h):this.pos),this.text=i??this.text,this.font=_??this.font,this.maxWidth=y??this.maxWidth,this.spriteFont=u??this.spriteFont,this._text.color=A??this.color;const w=this.get(He);w.anchor=rt.Zero,w.use(this._text)}_initialize(t){super._initialize(t)}getTextWidth(){return this._text.width}}var Br;(function(c){c.Circle="circle",c.Rectangle="rectangle"})(Br||(Br={}));class sA extends Ni{constructor(t){var i,r;super({width:(i=t.width)!==null&&i!==void 0?i:0,height:(r=t.height)!==null&&r!==void 0?r:0}),this._particlesToEmit=0,this._particlePool=new Mo(()=>new Xa({}),S=>S,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=Br.Rectangle,this.radius=0,this.particle={life:2e3,transform:Cs.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:o,x:h,y:u,z:_,pos:A,isEmitting:y,emitRate:w,emitterType:f,radius:T,random:C}={...t};this.particle={...this.particle,...o},this.pos=A??ft(h??0,u??0),this.z=_??0,this.isEmitting=y??this.isEmitting,this.emitRate=w??this.emitRate,this.emitterType=f??this.emitterType,this.radius=T??this.radius,this.body.collisionType=ie.PreventCollision,this.random=C??new Hn}removeParticle(t){this.deadParticles.push(t)}emitParticles(t){var i;if(!(t<=0)){t=t|0;for(let r=0;r<t;r++){const o=this._createParticle();!((i=this===null||this===void 0?void 0:this.scene)===null||i===void 0)&&i.world&&(this.particle.transform===Cs.Global?this.scene.world.add(o):this.addChild(o)),this._activeParticles.push(o)}}}clearParticles(){for(let t=0;t<this._activeParticles.length;t++)this.removeParticle(this._activeParticles[t])}_createParticle(){let t=0,i=0;const r=Ms(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),o=Ms(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),h=this.particle.startSize||Ms(this.particle.minSize||5,this.particle.maxSize||5,this.random),u=o*Math.cos(r),_=o*Math.sin(r);if(this.emitterType===Br.Rectangle)t=Ms(0,this.width,this.random),i=Ms(0,this.height,this.random);else if(this.emitterType===Br.Circle){const y=Ms(0,this.radius,this.random);t=y*Math.cos(r),i=y*Math.sin(r)}const A=this._particlePool.rent();return A.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:ft(t,i),vel:ft(u,_),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:h,graphic:this.particle.graphic,fade:this.particle.fade}),A.registerEmitter(this),this.particle.randomRotation&&(A.transform.rotation=Ms(0,Math.PI*2,this.random)),this.particle.focus&&(A.focus=this.particle.focus.add(ft(this.pos.x,this.pos.y)),A.focusAccel=this.particle.focusAccel),A}update(t,i){var r;super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let o=0;o<this.deadParticles.length;o++){!((r=this===null||this===void 0?void 0:this.scene)===null||r===void 0)&&r.world&&(this.scene.world.remove(this.deadParticles[o],!1),this._particlePool.return(this.deadParticles[o]));const h=this._activeParticles.indexOf(this.deadParticles[o]);h>-1&&this._activeParticles.splice(h,1)}this.deadParticles.length=0}}function rA(c,t){}class qa{constructor(t,i,r){var o;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=t,this.particle=r,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=i,this._particleLife=(o=this.particle.life)!==null&&o!==void 0?o:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(t,i){if(this._initialized)return;const r=this.emitter.maxParticles,o=this._numInputFloats,h=this._particleData,u=4,_=t.createBuffer(),A=t.createVertexArray();t.bindVertexArray(A),t.bindBuffer(t.ARRAY_BUFFER,_),t.bufferData(t.ARRAY_BUFFER,r*o*u,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,h);let y=0;t.vertexAttribPointer(0,2,t.FLOAT,!1,o*u,0),y+=u*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*u,y),y+=u*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*u,y),y+=u*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*u,y),y+=u*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*u,y),y+=u*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(A),this._buffers.push(_),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null);const w=t.createBuffer(),f=t.createVertexArray();t.bindVertexArray(f),t.bindBuffer(t.ARRAY_BUFFER,w),t.bufferData(t.ARRAY_BUFFER,r*o*u,t.DYNAMIC_DRAW),y=0,t.vertexAttribPointer(0,2,t.FLOAT,!1,o*u,0),y+=u*2,t.vertexAttribPointer(1,2,t.FLOAT,!1,o*u,y),y+=u*2,t.vertexAttribPointer(2,1,t.FLOAT,!1,o*u,y),y+=u*1,t.vertexAttribPointer(3,1,t.FLOAT,!1,o*u,y),y+=u*1,t.vertexAttribPointer(4,1,t.FLOAT,!1,o*u,y),y+=u*1,t.enableVertexAttribArray(0),t.enableVertexAttribArray(1),t.enableVertexAttribArray(2),t.enableVertexAttribArray(3),t.enableVertexAttribArray(4),this._vaos.push(f),this._buffers.push(w),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(t){const i=this._particleIndex,r=this.maxParticles*this._numInputFloats,o=t*this._numInputFloats+i;for(let h=i;h<o;h+=this._numInputFloats){const u=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||ni),_=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),A=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),y=_*Math.cos(u),w=A*Math.sin(u);let f=0,T=0;if(this.emitter.emitterType===Br.Rectangle)f=this._random.floating(-.5,.5)*this.emitter.width,T=this._random.floating(-.5,.5)*this.emitter.height;else{const E=this._random.floating(0,this.emitter.radius);f=E*Math.cos(u),T=E*Math.sin(u)}const C=this.emitter.transform.apply(ft(f,T)),S=[this.particle.transform===Cs.Local?f:C.x,this.particle.transform===Cs.Local?T:C.y,y,w,this.particle.randomRotation?Ms(0,ni,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(S,h%this._particleData.length)}o>=r?(this._wrappedParticles+=(o-r)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=t),this._particleIndex=o%r,this._emitted.push([this._particleLife,i])}_uploadEmitted(t){this._particleIndex!==this._uploadIndex&&(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(t.bufferSubData(t.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),t.bindBuffer(t.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(t){var i;if(this._particleLife=(i=this.particle.life)!==null&&i!==void 0?i:this._particleLife,this._wrappedLife>0?this._wrappedLife-=t:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let r=this._emitted.length-1;r>=0;r--){const o=this._emitted[r];o[0]-=t,o[0]<=0&&this._emitted.splice(r,1)}this._emitted.sort((r,o)=>r[0]-o[0])}}draw(t){if(this._initialized){if(this._clearRequested?(t.bindBuffer(t.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),t.bufferSubData(t.ARRAY_BUFFER,0,this._particleData),t.bindBuffer(t.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(t),t.bindVertexArray(this._currentVao),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const i=this._emitted[0][1]/this._numInputFloats;t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-i)*this._numInputFloats*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,i,this.maxParticles-i),t.endTransformFeedback(),t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,i),t.endTransformFeedback()}else t.bindBufferRange(t.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),t.beginTransformFeedback(t.POINTS),t.drawArrays(t.POINTS,0,this.maxParticles),t.endTransformFeedback();t.bindVertexArray(null),t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}qa.GPU_MAX_PARTICLES=1e5;class nA extends Ni{get pos(){return this.transform.pos}set pos(t){this.transform.pos=t}get z(){return this.transform.z}set z(t){this.transform.z=t}constructor(t){super({name:"GpuParticleEmitter",width:t.width,height:t.height}),this.particle={life:2e3,transform:Cs.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new He,this.isEmitting=!1,this.emitRate=1,this.emitterType=Br.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:i,maxParticles:r,x:o,y:h,z:u,pos:_,isEmitting:A,emitRate:y,emitterType:w,radius:f,random:T}={...t};this.maxParticles=ce(r??this.maxParticles,0,qa.GPU_MAX_PARTICLES),this.pos=_??ft(o??0,h??0),this.z=u??0,this.isEmitting=A??this.isEmitting,this.emitRate=y??this.emitRate,this.emitterType=w??this.emitterType,this.radius=f??this.radius,this.particle={...this.particle,...i},this.random=T??new Hn,this.renderer=new qa(this,this.random,this.particle)}_initialize(t){super._initialize(t);const i=t.graphicsContext;this.renderer.initialize(i.__gl,i)}update(t,i){super.update(t,i),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(i/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(i)}emitParticles(t){t<=0||this.renderer.emitParticles(t|0)}clearParticles(){this.renderer.clearParticles()}draw(t,i){t.draw("ex.particle",this.renderer,i)}}class df extends Di{getGraphics(){return this._graphics}addGraphic(t,i){this._graphics.push(t),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,i!=null&&i.offset&&(this._gfx.offset=i.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let t=this._tileBounds.clone();for(const i of this._graphics){const r=ft(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:i.height-this.map.tileHeight));t=t.combine(i.localBounds.translate(r))}return t}removeGraphic(t){const i=this._graphics.indexOf(t);i>-1&&this._graphics.splice(i,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(t){this._colliders.push(t),this.map.flagCollidersDirty()}removeCollider(t){const i=this._colliders.indexOf(t);i>-1&&this._colliders.splice(i,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(ft(this.x,this.y))}get center(){return this.pos.add(ft(0,this.map.tileHeight/2))}constructor(t,i,r,o){super([new qt,new He({offset:r??rt.Zero,onPostDraw:(T,C)=>this.draw(T,C)}),new So(o)]),this.solid=!1,this.events=new Ue,this._tileBounds=new Zt,this._graphics=[],this._colliders=[],this.data=new Map,this.x=t,this.y=i,this.map=o,this._transform=this.get(qt),this._isometricEntityComponent=this.get(So);const h=this.map.tileWidth/2,u=this.map.tileHeight/2,_=(this.x-this.y)*h,A=(this.x+this.y)*u;this._transform.pos=ft(_,A),this._isometricEntityComponent.elevation=o.elevation,this._gfx=this.get(He),this._gfx.isVisible=!1;const y=this.map.tileWidth,w=this.map.tileHeight,f=ft(0,this.map.renderFromTopOfGraphic?w:0);this._gfx.localBounds=this._tileBounds=new Zt({left:-y/2,top:-w,right:y/2,bottom:w}).translate(f)}draw(t,i){const r=this.map.tileWidth/2;t.save(),t.translate(-r,0);for(const o of this._graphics)o.draw(t,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:o.height-this.map.tileHeight));t.restore()}}class oA extends Di{get visible(){return this.isVisible}set visible(t){this.isVisible=t}constructor(t){super([new qt,new fe({type:ie.Fixed}),new ei,new Tr,new th((w,f)=>this.debug(w,f),!1)],t.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=ft(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:i,tileWidth:r,tileHeight:o,columns:h,rows:u,renderFromTopOfGraphic:_,graphicsOffset:A,elevation:y}=t;this.transform=this.get(qt),i&&(this.transform.pos=i),this.collider=this.get(ei),this.collider&&this.collider.set(this._composite=new fi([])),this.pointer=this.get(Tr),this.renderFromTopOfGraphic=_??this.renderFromTopOfGraphic,this.graphicsOffset=A??this.graphicsOffset,this.elevation=y??this.elevation,this.tileWidth=r,this.tileHeight=o,this.columns=h,this.rows=u,this._pointerEventDispatcher=new Ac,this.tiles=new Array(h*u);for(let w=0;w<u;w++)for(let f=0;f<h;f++){const T=new df(f,w,this.graphicsOffset,this);this.tiles[f+w*h]=T,this.addChild(T),this._pointerEventDispatcher.addObject(T,C=>this.getTileByPoint(C.worldPos)===T,()=>!0)}this.pointer.localBounds=Zt.fromDimension(r*h*this.transform.scale.x,o*u*this.transform.scale.y,ft(.5,0))}_processPointerToObject(t){this._pointerEventDispatcher.processPointerToObject(t,this.tiles)}_dispatchPointerEvents(t){this._pointerEventDispatcher.dispatchEvents(t,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(t){var i;if(this._originalOffsets.has(t))return(i=this._originalOffsets.get(t))!==null&&i!==void 0?i:rt.Zero;{const r=t.offset;return this._originalOffsets.set(t,r),r}}updateColliders(){this._composite.clearColliders();const t=this.get(qt).pos;for(const i of this.tiles)if(i.solid)for(const r of i.getColliders()){const o=this._getOrSetColliderOriginalOffset(r);r.offset=this.tileToWorld(ft(i.x,i.y)).sub(t).add(o).sub(ft(this.tileWidth/2,this.tileHeight)),r.owner=this,this._composite.addCollider(r)}this.collider.update()}worldToTile(t){t=t.sub(this.transform.globalPos);const i=this.tileWidth/2,r=this.tileHeight/2;return ft(~~((t.x/i+t.y/r)/2),~~((t.y/r-t.x/i)/2))}tileToWorld(t){const i=this.tileWidth/2,r=this.tileHeight/2,o=(t.x-t.y)*i,h=(t.x+t.y)*r;return ft(o,h).add(this.transform.pos)}getTile(t,i){return t<0||i<0||t>=this.columns||i>=this.rows?null:this.tiles[t+i*this.columns]}getTileByPoint(t){const i=this.worldToTile(t);return this.getTile(i.x,i.y)}_getMaxZIndex(){let t=Number.NEGATIVE_INFINITY;for(const i of this.tiles){const r=i.get(qt).z;r>t&&(t=r)}return t}debug(t,i){const{showAll:r,showPosition:o,positionColor:h,positionSize:u,showGrid:_,gridColor:A,gridWidth:y,showColliderGeometry:w}=i.isometric,{geometryColor:f,geometryLineWidth:T,geometryPointSize:C}=i.collider;if(t.save(),t.z=this._getMaxZIndex()+.5,r||_){for(let S=0;S<this.rows+1;S++){const E=this.tileToWorld(ft(0,S)),W=this.tileToWorld(ft(this.columns,S));t.drawLine(E,W,A,y)}for(let S=0;S<this.columns+1;S++){const E=this.tileToWorld(ft(S,0)),W=this.tileToWorld(ft(S,this.rows));t.drawLine(E,W,A,y)}}if(r||o)for(const S of this.tiles)t.drawCircle(this.tileToWorld(ft(S.x,S.y)),u,h);if(r||w){for(const S of this.tiles)if(S.solid)for(const E of S.getColliders())E.debug(t,f,{lineWidth:T,pointSize:C})}t.restore()}}class Tc{constructor(t,i){this.id=be(),this._stopped=!1,this._sequenceBuilder=i,this._sequenceContext=new Ho(t),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(t){this._actionQueue.update(t)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(t){return new Tc(t,this._sequenceBuilder)}}class aA{constructor(t){this.id=be(),this._actions=t}update(t){for(let i=0;i<this._actions.length;i++)this._actions[i].update(t)}isComplete(t){return this._actions.every(i=>i.isComplete(t))}reset(){this._actions.forEach(t=>t.reset())}stop(){this._actions.forEach(t=>t.stop())}}class Mn{constructor(t,i){this.bounds=t,this.options=i,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...i},this.halfWidth=t.width/2,this.halfHeight=t.height/2}_split(){this._isDivided=!0;const t={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Mn(new Zt({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),t),this.topRight=new Mn(new Zt({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),t),this.bottomLeft=new Mn(new Zt({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),t),this.bottomRight=new Mn(new Zt({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),t)}_insertIntoSubNodes(t){var i,r,o,h;!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.insert(t),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(t.bounds)&&this.topRight.insert(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.insert(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.insert(t)}insert(t){if(this._isDivided){this._insertIntoSubNodes(t);return}if(this.items.push(t),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const i of this.items)this._insertIntoSubNodes(i);this.items.length=0}}remove(t){var i,r,o,h;if(this.bounds.overlaps(t.bounds)){if(!this._isDivided){const u=this.items.indexOf(t);u>-1&&this.items.splice(u,1);return}!((i=this.topLeft)===null||i===void 0)&&i.bounds.overlaps(t.bounds)&&this.topLeft.remove(t),!((r=this.topRight)===null||r===void 0)&&r.bounds.overlaps(t.bounds)&&this.topRight.remove(t),!((o=this.bottomLeft)===null||o===void 0)&&o.bounds.overlaps(t.bounds)&&this.bottomLeft.remove(t),!((h=this.bottomRight)===null||h===void 0)&&h.bounds.overlaps(t.bounds)&&this.bottomRight.remove(t)}}query(t){let i=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(t)&&(i=i.concat(this.topLeft.query(t))),this.topRight.bounds.overlaps(t)&&(i=i.concat(this.topRight.query(t))),this.bottomLeft.bounds.overlaps(t)&&(i=i.concat(this.bottomLeft.query(t))),this.bottomRight.bounds.overlaps(t)&&(i=i.concat(this.bottomRight.query(t)))),i=i.filter((r,o)=>i.indexOf(r)>=o),i}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let t=this.items;return this._isDivided&&(t=t.concat(this.topLeft.getAllItems()),t=t.concat(this.topRight.getAllItems()),t=t.concat(this.bottomLeft.getAllItems()),t=t.concat(this.bottomRight.getAllItems())),t=t.filter((i,r)=>t.indexOf(i)>=r),t}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(t){this.bounds.draw(t,kt.Yellow),this._isDivided&&(this.topLeft.bounds.draw(t,kt.Yellow),this.topRight.bounds.draw(t,kt.Yellow),this.bottomLeft.bounds.draw(t,kt.Yellow),this.bottomRight.bounds.draw(t,kt.Yellow))}}function hA(c){return!!c._initialize}function lA(c){return!!c.onAdd}function cA(c){return!!c.onRemove}function dA(c){return!!c.onInitialize}function uA(c){return!!c._preupdate}function gA(c){return!!c.onPreUpdate}function fA(c){return!!c.onPostUpdate}function _A(c){return!!c.onPostUpdate}function pA(c){return!!c.onAdd}function AA(c){return!!c.onRemove}function mA(c){return!!c.onPreDraw}function vA(c){return!!c.onPostDraw}class wA{constructor(t,i=!1){this.path=t,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new ko(t,"arraybuffer",i)}get bustCache(){return this._resource.bustCache}set bustCache(t){this._resource.bustCache=t}async load(){const t=await this._resource.load();this._stream=new uf(t),this._gif=new gf(this._stream);const i=this._gif.images.map(r=>new Qs(r.src,!1));return await Promise.all(i.map(r=>r.load())),this.data=this._images=i,this._sprites=this._images.map(r=>r.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(t=0){var i;return(i=this._sprites[t])!==null&&i!==void 0?i:null}toSpriteSheet(){const t=this._sprites;return t.length?new nn({sprites:t}):null}toAnimation(t){var i;const r=(i=this._gif)===null||i===void 0?void 0:i.images;if(r!=null&&r.length){const o=r.map((h,u)=>{var _;return{graphic:this._sprites[u],duration:((_=this._gif)===null||_===void 0?void 0:_.frames[u].delayMs)||void 0}});return this._animation=new vs({frames:o,frameDuration:t}),this._animation}return null}get readCheckBytes(){var t,i;return(i=(t=this._gif)===null||t===void 0?void 0:t.checkBytes)!==null&&i!==void 0?i:[]}}const Ea=c=>c.reduce(function(t,i){return t*2+i},0),ll=c=>{const t=[];for(let i=7;i>=0;i--)t.push(!!(c&1<<i));return t};class uf{constructor(t){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=i=>{const r=[];for(let o=0;o<i;o++)r.push(this.readByte());return r},this.read=i=>{let r="";for(let o=0;o<i;o++)r+=String.fromCharCode(this.readByte());return r},this.readUnsigned=()=>{const i=this.readBytes(2);return(i[1]<<8)+i[0]},this.data=new Uint8Array(t),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const yA=function(c,t){let i=0;const r=function(T){let C=0;for(let S=0;S<T;S++)t.charCodeAt(i>>3)&1<<(i&7)&&(C|=1<<S),i++;return C},o=[],h=1<<c,u=h+1;let _=c+1,A=[];const y=function(){A=[],_=c+1;for(let T=0;T<h;T++)A[T]=[T];A[h]=[],A[u]=null};let w=0,f=0;for(;;){if(f=w,w=r(_),w===h){y();continue}if(w===u)break;if(w<A.length)f!==h&&A.push(A[f].concat(A[w][0]));else{if(w!==A.length)throw new Error("Invalid LZW code.");A.push(A[f].concat(A[f][0]))}o.push.apply(o,A[w]),A.length===1<<_&&_<12&&_++}return o};class gf{constructor(t){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=i=>{const r=[];for(let o=0;o<i;o++){const h=this._st.readBytes(3);r.push(h)}return r},this.readSubBlocks=()=>{let i,r;r="";do i=this._st.readByte(),r+=this._st.read(i);while(i!==0);return r},this.parseHeader=()=>{const i={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(i.sig=this._st.read(3),i.ver=this._st.read(3),i.sig!=="GIF")throw new Error("Not a GIF file.");i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned(),this._currentFrameCanvas.width=i.width,this._currentFrameCanvas.height=i.height;const r=ll(this._st.readByte());i.gctFlag=r.shift(),i.colorResolution=Ea(r.splice(0,3)),i.sortedFlag=r.shift(),i.globalColorTableSize=Ea(r.splice(0,3)),i.backgroundColorIndex=this._st.readByte(),i.pixelAspectRatio=this._st.readByte(),i.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<i.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(i)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=i=>{const r=A=>{this.checkBytes.push(this._st.readByte());const y=ll(this._st.readByte());return A.reserved=y.splice(0,3),A.disposalMethod=Ea(y.splice(0,3)),A.userInputFlag=y.shift(),A.transparentColorFlag=y.shift(),A.delayTime=this._st.readUnsigned(),A.transparentColorIndex=this._st.readByte(),A.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(A)&&this.checkBytes.push(this._handler.gce),A},o=A=>{A.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(A)&&this.checkBytes.push(this._handler.com)},h=A=>{this.checkBytes.push(this._st.readByte()),A.ptHeader=this._st.readBytes(12),A.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(A)&&this.checkBytes.push(this._handler.pte)},u=A=>{const y=f=>{this.checkBytes.push(this._st.readByte()),f.unknown=this._st.readByte(),f.iterations=this._st.readUnsigned(),f.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(f)&&this.checkBytes.push(this._handler.app)},w=f=>{f.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[f.identifier]&&this._handler.app[f.identifier](f)&&this.checkBytes.push(this._handler.app[f.identifier])};switch(this.checkBytes.push(this._st.readByte()),A.identifier=this._st.read(8),A.authCode=this._st.read(3),A.identifier){case"NETSCAPE":y(A);break;default:w(A);break}},_=A=>{A.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(A)&&this.checkBytes.push(this._handler.unknown)};switch(i.label=this._st.readByte(),i.label){case 249:i.extType="gce",this._gce=r(i);break;case 254:i.extType="com",o(i);break;case 1:i.extType="pte",h(i);break;case 255:i.extType="app",u(i);break;default:i.extType="unknown",_(i);break}},this.parseImg=i=>{var r;const o=(_,A)=>{const y=new Array(_.length),w=_.length/A,f=(E,W)=>{const D=_.slice(W*A,(W+1)*A);y.splice.apply(y,[E*A,A].concat(D))},T=[0,4,2,1],C=[8,8,4,2];let S=0;for(let E=0;E<4;E++)for(let W=T[E];W<w;W+=C[E])f(W,S),S++;return y};i.leftPos=this._st.readUnsigned(),i.topPos=this._st.readUnsigned(),i.width=this._st.readUnsigned(),i.height=this._st.readUnsigned();const h=ll(this._st.readByte());i.lctFlag=h.shift(),i.interlaced=h.shift(),i.sorted=h.shift(),i.reserved=h.splice(0,2),i.lctSize=Ea(h.splice(0,3)),i.lctFlag&&(i.lctBytes=this.parseColorTableBytes(1<<i.lctSize+1)),i.lzwMinCodeSize=this._st.readByte();const u=this.readSubBlocks();i.pixels=yA(i.lzwMinCodeSize,u),i.interlaced&&(i.pixels=o(i.pixels,i.width)),!((r=this._gce)===null||r===void 0)&&r.delayTime&&(i.delayMs=this._gce.delayTime*10),this.frames.push(i),this.arrayToImage(i,i.lctFlag?i.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(i)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const i={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(i.sentinel)){case"!":i.type="ext",this.parseExt(i);break;case",":i.type="img",this.parseImg(i);break;case";":i.type="eof",this._handler.eof&&this._handler.eof(i)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+i.sentinel.toString(16))}i.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(i,r)=>{var o,h,u,_;const A=document.createElement("canvas");A.width=i.width,A.height=i.height;const y=A.getContext("2d"),w=y.getImageData(0,0,A.width,A.height);let f=-1;!((o=this._gce)===null||o===void 0)&&o.transparentColorFlag&&(f=this._gce.transparentColorIndex);for(let C=0;C<i.pixels.length;C++){const S=i.pixels[C],E=r[S];S===f?w.data.set([0,0,0,0],C*4):w.data.set([...E,255],C*4)}if(y.putImageData(w,0,0),((h=this._gce)===null||h===void 0?void 0:h.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((u=this._gce)===null||u===void 0?void 0:u.disposalMethod)===2&&(!((_=this._hdr)===null||_===void 0)&&_.gctFlag)){const C=r[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${C[0]}, ${C[1]}, ${C[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(A,i.leftPos,i.topPos,i.width,i.height);const T=new Image;T.src=this._currentFrameCanvas.toDataURL(),this.images.push(T)},this._st=t,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class xA{constructor(t,i,{bustCache:r,...o}={}){this.path=t,this.family=i,this._isLoaded=!1,this._resource=new ko(t,"blob",r),this._options=o}async load(){if(this.isLoaded())return this.data;try{const t=await this._resource.load(),i=URL.createObjectURL(t);this.data||(this.data=new FontFace(this.family,`url(${i})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(t){throw`Error loading FontSource from path '${this.path}' with error [${t.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(t){return new dn({family:this.family,...this._options,...t})}}const yu=hf(),bA=/^\s*(?:function)?\*/;function xu(c){return typeof c!="function"?!1:bA.test(Function.prototype.toString.call(c))?!0:Object.getPrototypeOf?Object.getPrototypeOf(c)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function ff(...c){var t;const i=$t.getInstance();let r,o,h,u;xu(c[0])&&(o=globalThis,r=c[0],h=c[1]),xu(c[1])&&(o=c[0],r=c[1],h=c[2]),c[1]instanceof Vi&&(o=c[0],u=c[1],r=c[2],h=c[3]),c[0]instanceof Vi&&(o=globalThis,u=c[0],r=c[1],h=c[2]);const _=lf(yu),A=h==null?void 0:h.timing,y=_?!1:(t=h==null?void 0:h.autostart)!==null&&t!==void 0?t:!0;let w;try{w=u??Vi.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let f=!1,T=!1,C=!1;const S=r.bind(o),E=S();let W;const D=new Promise((k,N)=>{W=Q=>{try{if(C){T=!0,k();return}const{done:L,value:O}=yu.scope(!0,()=>E.next(Q));if(L||C){T=!0,k();return}O instanceof Promise?O.then(()=>{w.clock.schedule(W,0,A)}):O===void 0||O===void 0?w.clock.schedule(W,0,A):w.clock.schedule(W,O||0,A)}catch(L){N(L);return}},y&&(f=!0,W(w.clock.elapsed()))}),H={isRunning:()=>f&&!C&&!T,isComplete:()=>T,cancel:()=>{C=!0},start:()=>(f?i.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(S)):(f=!0,W(w.clock.elapsed())),H),generator:E,done:D,then:D.then.bind(D),[Symbol.iterator]:()=>E};return H}class ah extends Di{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(t){var i,r,o,h;super(),this._logger=$t.getInstance(),this.transform=new qt,this.graphics=new He,this._completeFuture=new ns,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=t.duration,this.easing=(i=t.easing)!==null&&i!==void 0?i:Ee.Linear,this.direction=(r=t.direction)!==null&&r!==void 0?r:"out",this.hideLoader=(o=t.hideLoader)!==null&&o!==void 0?o:!1,this.blockInput=(h=t.blockInput)!==null&&h!==void 0?h:!1,this.transform.coordPlane=yi.Screen,this.transform.pos=rt.Zero,this.transform.z=1/0,this.graphics.anchor=rt.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(t,i){this.complete||(this._currentDistance+=ce(i/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=ce(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=ce(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(t){}onStart(t){}onUpdate(t){}onEnd(t){}onReset(){}reset(){this.started=!1,this._completeFuture=new ns,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(t,i){const r=i;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),r.world.entityManager.getById(this.id))return this._co;this._engine=t,r.add(this);const o=this;return this._co=ff(t,function*(){for(;!o.complete;){const h=yield;o.updateTransition(o._engine,h),o._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class CA extends ah{constructor(t){var i,r;super({...t,duration:(i=t.duration)!==null&&i!==void 0?i:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(r=t.color)!==null&&r!==void 0?r:kt.Black}onInitialize(t){this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=new No({width:t.screen.resolution.width,height:t.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=t}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class EA extends ah{constructor(t){super({direction:"in",...t}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(t){this.image=await t.engine.screenshot(!0),await this.image.decode()}onInitialize(t){this.engine=t,this.transform.pos=t.screen.unsafeArea.topLeft,this.screenCover=Qs.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=ft(1/t.screen.pixelRatio,1/t.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(t){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(t){this.graphics.opacity=t}onUpdate(t){this.graphics.opacity=t}}class IA extends ah{constructor(t){var i;super({direction:"in",...t}),this._easing=Ee.Linear,this.name=`Slide#${this.id}`,this.slideDirection=t.slideDirection,this.transform.coordPlane=yi.World,this.graphics.forceOnScreen=!0,this._easing=(i=t.easingFunction)!==null&&i!==void 0?i:this._easing,this._vectorEasing=Ee.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(t){this._image=await t.engine.screenshot(!0),await this._image.decode(),this._screenCover=Qs.fromHtmlImageElement(this._image).toSprite()}onInitialize(t){switch(this._engine=t,this.slideDirection){case"up":{this._directionOffset=ft(0,-t.screen.resolution.height);break}case"down":{this._directionOffset=ft(0,t.screen.resolution.height);break}case"left":{this._directionOffset=ft(-t.screen.resolution.width,0);break}case"right":{this._directionOffset=ft(t.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=ft(1/t.screen.pixelRatio,1/t.screen.pixelRatio)}onUpdate(t){this._camera.pos=this._vectorEasing(t,this._destinationCameraPosition,this._startCameraPosition,1)}}class Sc extends Oe{constructor(t){super(),this.color=kt.Black,this.thickness=1;const{start:i,end:r,color:o,thickness:h}=t;this.start=i,this.end=r,this.color=o??this.color,this.thickness=h??this.thickness,this._localBounds=this._calculateBounds();const{width:u,height:_}=this._localBounds;this.width=u,this.height=_}get localBounds(){return this._localBounds}_calculateBounds(){const t=this.end.sub(this.start).normal(),i=this.thickness/2,r=[this.start.add(t.scale(i)),this.end.add(t.scale(i)),this.end.add(t.scale(-i)),this.start.add(t.scale(-i))];return Zt.fromPoints(r)}_drawImage(t,i,r){t.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new Sc({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class Pc extends Vn{get points(){return this._points}set points(t){this._points=t;const i=this.minPoint;this.width=this._points.reduce((r,o)=>Math.max(o.x,r),0)-i.x,this.height=this._points.reduce((r,o)=>Math.max(o.y,r),0)-i.y,this.flagDirty()}get minPoint(){const t=this._points.reduce((r,o)=>Math.min(o.x,r),1/0),i=this._points.reduce((r,o)=>Math.min(o.y,r),1/0);return ft(t,i)}constructor(t){super(t),this._points=[],this.points=t.points,this.filtering=ii.Blended,this.rasterize()}clone(){return new Pc({points:this.points.map(t=>t.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(t){if(this.points&&this.points.length){t.beginPath();const i=this.minPoint.negate(),r=this.points[0].add(i);t.moveTo(r.x,r.y),this.points.forEach(o=>{t.lineTo(o.x+i.x,o.y+i.y)}),t.lineTo(r.x,r.y),t.closePath(),this.color&&t.fill(),this.strokeColor&&t.stroke()}}}var tr;(function(c){c.Stretch="stretch",c.Tile="tile",c.TileFit="tile-fit"})(tr||(tr={}));class Dc extends Oe{constructor(t){super(t),this._logger=$t.getInstance(),this._config=t,this._imgSource=t.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(t,i=!1){this._config.width=t,i&&this._initialize()}setTargetHeight(t,i=!1){this._config.height=t,i&&this._initialize()}setMargins(t,i,r,o,h=!1){this._config.sourceConfig.leftMargin=t,this._config.sourceConfig.topMargin=i,this._config.sourceConfig.rightMargin=r,this._config.sourceConfig.bottomMargin=o,h&&this._initialize()}setStretch(t,i,r=!1){t==="horizontal"?this._config.destinationConfig.horizontalStretch=i:t==="vertical"?this._config.destinationConfig.verticalStretch=i:(this._config.destinationConfig.horizontalStretch=i,this._config.destinationConfig.verticalStretch=i),r&&this._initialize()}getConfig(){return this._config}_drawTile(t,i,r,o,h,u,_){const A=u||0,y=_||0;let w,f,T,C;const S=this._getNumberOfTiles(i.width,r.x,o),E=this._getNumberOfTiles(i.height,r.y,h);for(let W=0;W<S;W++)for(let D=0;D<E;D++){let{tempSize:H,tempPosition:k}=this._calculateParams(W,S,i.width,r.x,this._config.destinationConfig.horizontalStretch);w=H,f=k,{tempSize:H,tempPosition:k}=this._calculateParams(D,E,i.height,r.y,this._config.destinationConfig.verticalStretch),T=H,C=k,t.drawImage(i,0,0,i.width,i.height,A+f,y+C,w,T)}}_drawImage(t,i,r){this._imgSource.isLoaded()?(this._drawTile(t,this._canvasA,new rt(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(t,this._canvasB,new rt(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(t,this._canvasC,new rt(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(t,this._canvasD,new rt(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(t,this._canvasE,new rt(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasF,new rt(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(t,this._canvasG,new rt(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasH,new rt(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(t,this._canvasI,new rt(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const t=this._canvasA.getContext("2d");t==null||t.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const i=this._canvasB.getContext("2d");i==null||i.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const r=this._canvasC.getContext("2d");r==null||r.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const o=this._canvasD.getContext("2d");o==null||o.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const h=this._canvasE.getContext("2d");h==null||h.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const u=this._canvasF.getContext("2d");u==null||u.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const _=this._canvasG.getContext("2d");_==null||_.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const A=this._canvasH.getContext("2d");A==null||A.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const y=this._canvasI.getContext("2d");y==null||y.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new Dc(this._config)}_getNumberOfTiles(t,i,r){switch(r){case tr.Stretch:return 1;case tr.Tile:return Math.ceil(i/t);case tr.TileFit:return Math.ceil(i/t)}}_calculateParams(t,i,r,o,h){switch(h){case tr.Stretch:return{tempPosition:0,tempSize:o};case tr.Tile:return t===i-1?{tempPosition:t*r,tempSize:r-(i*r-o)}:{tempPosition:t*r,tempSize:r};case tr.TileFit:const u=o/i;return{tempPosition:t*u,tempSize:u}}}}class Rc extends vs{constructor(t){super({...t,frames:t.animation.frames.slice(),strategy:t.animation.strategy,frameDuration:t.animation.frameDuration,speed:t.animation.speed,reverse:t.animation.isReversed}),this._ready=new ns,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...t.sourceView},this._tiledWidth=t.width,this._tiledHeight=t.height;const i=[];for(let r=0;r<this.frames.length;r++){const o=this.frames[r].graphic;if(o&&o instanceof ys){const h=new Qo({image:o.image,width:t.width,height:t.height,sourceView:{...o.sourceView},wrapping:t.wrapping,filtering:t.filtering});this.frames[r].graphic=h,h.ready.then(()=>{h.sourceView={...h.sourceView,...this._sourceView}}),i.push(h.ready)}}Promise.all(i).then(()=>this._ready.resolve())}static fromAnimation(t,i){return new Rc({width:t.width,height:t.height,...i,animation:t})}_updateSourceView(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof ys&&(i.sourceView={...i.sourceView,...this._sourceView})}}get sourceView(){return ws(this._sourceView,()=>this._updateSourceView())}set sourceView(t){this._sourceView=ws(t,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let t=0;t<this.frames.length;t++){const i=this.frames[t].graphic;i&&i instanceof ys&&(i.sourceView.height=this._tiledHeight||i.height,i.destSize.height=this._tiledHeight||i.height,i.sourceView.width=this._tiledWidth||i.width,i.destSize.width=this._tiledWidth||i.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(t){this._tiledWidth=t,this._updateWidthHeight()}set height(t){this._tiledHeight=t,this._updateWidthHeight()}}const _f=5,On={},BA=()=>{for(const c in On)On[c]=0},Ia=(c,t)=>{const i=vi.isEnabled("suppress-obsolete-message");On[c]<_f&&!i&&($t.getInstance().warn(c),console.trace&&t.showStackTrace&&console.trace()),On[c]++};function TA(c){return c={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...c},function(t,i,r){if(r&&!(typeof r.value=="function"||typeof r.get=="function"||typeof r.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const h=`${`${t.name||""}${t.name&&i?".":""}${i||""}`} is marked obsolete: ${c.message}`+(c.alternateMethod?` Use ${c.alternateMethod} instead`:"");On[h]||(On[h]=0);const u=r?{...r}:t;if(!r){class _ extends u{constructor(...y){Ia(h,c),super(...y)}}return _}return r&&r.value?(u.value=function(){return Ia(h,c),r.value.apply(this,arguments)},u):(r&&r.get&&(u.get=function(){return Ia(h,c),r.get.apply(this,arguments)}),r&&r.set&&(u.set=function(){return Ia(h,c),r.set.apply(this,arguments)}),u)}}class SA{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const t=new ns;return this._queue.push(t),t.promise}dequeue(t){this._queue.shift().resolve(t)}}class PA{constructor(t){this._count=t,this._waitQueue=new SA}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(t=1){if(t!==0){for(;t!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),t--;this._count+=t}}}const Dl="0.30.1";Tu();U.eKr;U.yVm;U.a7j;U.U_w;U.JF2;U.htg;U.HXL;U.mcg;var DA=U.Agj;U.J3_;U.Wgv;U.u6S;U.x7M;var br=U.X55;U.m3M;U.aE5;U.YJU;U.eZi;U.GNv;U.Y56;U._0v;U.vhs;U.vrQ;U.Z8b;U.Yfw;U.IcQ;U.kgJ;U.GTT;U.ypY;U.i7d;U.fQ3;U.HlI;U.jlt;U.VQc;U.zD7;U.AUF;U.JoF;U.MlA;U.PZh;U.qA;U.CrD;U.dQK;U.D3r;U.Qpo;U.D9n;U.b6v;U.mvh;var RA=U.Bpo;U.Q1f;U.IKv;U.fcV;U.Glf;U.uAl;U.ElT;U.Z8r;U.QSL;U.sPV;U.nAn;U.zCU;U.QrV;U.fF9;U.Jqv;U.d_u;U.xI8;U.yar;U.SP7;U.oRy;U.f5X;U.V1c;U.Mlx;U.ZiM;U.ZCo;U.J5p;U.mL_;U.Guw;U.N5j;U.pgY;U.OP3;U.rl5;U.eod;U.q5Z;U.YUC;U.saR;U.hvr;U.Qol;U.Wf4;U.JCs;U.gJV;U.fWD;U.Va_;var FA=U.N$8;U._jQ;U.rxj;U.rhv;U.wCu;U.HAp;U.Zy1;U.bkB;U.wfL;U.sVA;U.$Gs;U.CJ0;U.NWh;U.tWi;U.xAj;U.zWh;U.i_4;U.iIx;U.Hxo;U.c9e;U.KQV;U.weH;U.jXp;U.zzY;U.yRQ;U.MtE;U.rPj;U.KLc;U.Fir;U.V5f;U.Xj7;U.Wud;U.FVg;U.g5Y;U.YQB;U.KPb;U.nHK;U.Jrb;U.TX_;U.Olt;U.r3n;U.Fvk;U.gpR;U.vYh;U.hnk;U.D2R;U.n1o;U.h9O;U.X5j;U.p3P;U.RLG;U.fBU;var MA=U.Adb,kA=U.bEs;U.wCy;U.CbD;U.x_C;U.pGf;U.ibQ;U.shR;U.Yjk;U._u1;U.OBI;U.klh;U.s3S;U.D$R;U.xth;U.JU7;U.h9x;U.N1A;U.e_k;var QA=U.aHM;U.tlv;U.Vi9;U.ieR;U.$bb;U.VyI;U.imn;U.uqu;U.QnL;U.vnc;U.wk_;U.GH0;U._1r;U.l0X;U.bT;U.HHX;U.jtW;U.tjk;U.rWe;U.j9l;U.l0$;U.sGJ;U.NVp;U.cPK;U.XoL;U.RmF;U.DXI;U.tCD;U.J3D;U.vCJ;U.e6k;U.f9l;U.v9m;U.yRJ;U.EU6;U.m3O;U.Ryz;U.OxP;U.LEs;U.Ec;U.Pi5;U.gmH;U.tS;U.XxX;U.bCz;U.nYS;U.yiT;U.NHl;U.mO8;U.PXI;U.bn5;U.Ywr;U.cMd;U.Bs6;U.G0k;U.pyn;U.QeM;U.aPX;U.ITP;U.BY0;U.MFw;U.sBn;U.S3L;U.XKQ;U.ESI;U.uxz;U.o8N;U.u_r;U.RlV;U.gVA;U.M_G;U.BpG;U.GRB;U.kM6;U.dO8;U.jgM;var LA=U.FWq;U.s3j;U.hlw;U.L0q;U.B7e;U.PGN;U.H_X;U.S_d;U._Tq;U.U7E;U.IOH;U.Z58;U.yh2;U.ff$;U.cWi;U.NBt;U.oNz;U.QlU;U.Xey;U.jft;U._r8;U.bTC;U.Mtr;U.ypk;U.mnM;U.q7S;U.bAZ;U.ABN;U.VK6;U.Hj2;U.Df8;U.oOx;U.kxk;U.DT1;var zA=U.FLG;U.qN_;U.Z37;U.FtL;U.Z6X;U.iQT;U.ziO;U.OEF;U.uuE;U.tiv;U.T$Y;U.EYj;U.nOB;U.Tap;U.FAs;U.B_P;U.aA5;U.J3s;U.Y0Q;U.M4G;U.l$l;U.dLy;U.WZP;U.eB6;U.nFK;U.l9z;U.YOF;U.yhB;U.J0N;var UA=U.Miz;U.Bj4;U.Rcs;U.vJ4;U.TqC;U.nM0;U.X1u;U.SpZ;U.DX8;U.Yx$;U.HK4;U.yt5;U.vAR;U.SE$;U.qE8;U.Pz7;U.sX_;U.JuI;U.pxT;U.Nl$;U.zDr;U.OwT;U.P$G;U.mHV;U.kEA;U.Fx_;U.WFC;U.vKu;U.aDq;U.jIg;U.UH3;U.AJO;U.U4;U.xAc;U._3Y;U.K6X;U.C1Y;U.Aw1;U.tm8;U.LBV;U.A8$;U.F5e;U.ran;U.c8L;U.o6M;U.hsx;U.l9E;U.aSf;U.CcK;U.nU8;U.td6;U.Zex;U.bkJ;U.mXP;U.vt$;U.hCA;U.pjR;U.U43;U.pSZ;U.y17;U.Ew7;U.hG1;U.jVr;U._SZ;U.xWn;U.ehJ;var Ba=U.t6s;U.Eyn;function NA(c){if(c.__esModule)return c;var t=c.default;if(typeof t=="function"){var i=function r(){return this instanceof r?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};i.prototype=t.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(c).forEach(function(r){var o=Object.getOwnPropertyDescriptor(c,r);Object.defineProperty(i,r,o.get?o:{enumerable:!0,get:function(){return c[r]}})}),i}var cl={exports:{}};const GA={},OA=Object.freeze(Object.defineProperty({__proto__:null,default:GA},Symbol.toStringTag,{value:"Module"})),HA=NA(OA);var dl={exports:{}};/*!
 * excalibur - 0.30.1 - 2024-12-12
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2024 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var bu;function WA(){return bu||(bu=1,function(c,t){(function(r,o){c.exports=o()})(self,()=>(()=>{var i={851:(d,e,s)=>{s.d(e,{A:()=>v});var n=s(1),a=s.n(n),l=s(935),g=s.n(l),p=g()(a());p.push([d.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const v=p},296:(d,e,s)=>{s.d(e,{A:()=>v});var n=s(1),a=s.n(n),l=s(935),g=s.n(l),p=g()(a());p.push([d.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const v=p},935:d=>{d.exports=function(e){var s=[];return s.toString=function(){return this.map(function(a){var l="",g=typeof a[5]<"u";return a[4]&&(l+="@supports (".concat(a[4],") {")),a[2]&&(l+="@media ".concat(a[2]," {")),g&&(l+="@layer".concat(a[5].length>0?" ".concat(a[5]):""," {")),l+=e(a),g&&(l+="}"),a[2]&&(l+="}"),a[4]&&(l+="}"),l}).join("")},s.i=function(a,l,g,p,v){typeof a=="string"&&(a=[[null,a,void 0]]);var B={};if(g)for(var P=0;P<this.length;P++){var z=this[P][0];z!=null&&(B[z]=!0)}for(var $=0;$<a.length;$++){var J=[].concat(a[$]);g&&B[J[0]]||(typeof v<"u"&&(typeof J[5]>"u"||(J[1]="@layer".concat(J[5].length>0?" ".concat(J[5]):""," {").concat(J[1],"}")),J[5]=v),l&&(J[2]&&(J[1]="@media ".concat(J[2]," {").concat(J[1],"}")),J[2]=l),p&&(J[4]?(J[1]="@supports (".concat(J[4],") {").concat(J[1],"}"),J[4]=p):J[4]="".concat(p)),s.push(J))}},s}},1:d=>{d.exports=function(e){var s=e[1],n=e[3];if(!n)return s;if(typeof btoa=="function"){var a=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),g="/*# ".concat(l," */");return[s].concat([g]).join(`
`)}return[s].join(`
`)}}},r={};function o(d){var e=r[d];if(e!==void 0)return e.exports;var s=r[d]={id:d,exports:{}};return i[d](s,s.exports,o),s.exports}o.n=d=>{var e=d&&d.__esModule?()=>d.default:()=>d;return o.d(e,{a:e}),e},o.d=(d,e)=>{for(var s in e)o.o(e,s)&&!o.o(d,s)&&Object.defineProperty(d,s,{enumerable:!0,get:e[s]})},o.o=(d,e)=>Object.prototype.hasOwnProperty.call(d,e),o.r=d=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})};var h={};o.r(h),o.d(h,{ActionCompleteEvent:()=>wh,ActionContext:()=>ao,ActionQueue:()=>Wc,ActionSequence:()=>tl,ActionStartEvent:()=>vh,ActionsComponent:()=>Tn,ActionsSystem:()=>Wh,ActivateEvent:()=>gh,Actor:()=>Qi,ActorEvents:()=>Of,AddEvent:()=>yh,AddedComponent:()=>Af,AffineMatrix:()=>st,Animation:()=>Zi,AnimationDirection:()=>pr,AnimationEvents:()=>Zo,AnimationStrategy:()=>Xi,ArcadeSolver:()=>zh,AudioContextFactory:()=>to,Axes:()=>go,Axis:()=>ua,BaseAlign:()=>Lr,BezierCurve:()=>oo,Blink:()=>gd,BodyComponent:()=>ge,BoundingBox:()=>ht,BrowserComponent:()=>Zh,BrowserEvents:()=>Yd,Buttons:()=>uo,Camera:()=>Pd,CameraEvents:()=>qf,Canvas:()=>oa,Circle:()=>la,CircleCollider:()=>Ei,Clock:()=>$h,ClosestLineJumpTable:()=>Ts,Collider:()=>mr,ColliderComponent:()=>Je,CollisionContact:()=>Xr,CollisionEndEvent:()=>Kn,CollisionGroup:()=>js,CollisionGroupManager:()=>Bs,CollisionJumpTable:()=>ps,CollisionPostSolveEvent:()=>sa,CollisionPreSolveEvent:()=>ia,CollisionStartEvent:()=>Jn,CollisionSystem:()=>fa,CollisionType:()=>ee,Color:()=>q,ColorBlindFlags:()=>Vd,ColorBlindnessMode:()=>$r,ColorBlindnessPostProcessor:()=>qd,Component:()=>Hi,CompositeCollider:()=>ci,ConsoleAppender:()=>F,ContactConstraintPoint:()=>Ld,ContactEndEvent:()=>ea,ContactSolveBias:()=>In,ContactStartEvent:()=>ta,CoordPlane:()=>We,CrossFade:()=>E_,CurveBy:()=>vd,CurveTo:()=>md,DeactivateEvent:()=>fh,Debug:()=>di,DebugConfig:()=>jd,DebugGraphicsComponent:()=>da,DebugSystem:()=>Gh,DebugText:()=>ai,DefaultAntialiasOptions:()=>Xd,DefaultGarbageCollectionOptions:()=>Kh,DefaultLoader:()=>eo,DefaultPixelArtOptions:()=>Zd,DegreeOfFreedom:()=>Wi,Delay:()=>_d,Detector:()=>Uc,Die:()=>pd,Direction:()=>Ur,Director:()=>tu,DirectorEvents:()=>t_,DisplayMode:()=>li,DynamicTree:()=>Sh,DynamicTreeCollisionProcessor:()=>ha,EX_VERSION:()=>ol,EaseBy:()=>ud,EaseTo:()=>dd,EasingFunctions:()=>Ce,EdgeCollider:()=>$i,ElasticToActorStrategy:()=>Bd,EmitterType:()=>xr,Engine:()=>qi,EngineEvents:()=>e_,EnterTriggerEvent:()=>Ah,EnterViewPortEvent:()=>ph,Entity:()=>Ci,EntityEvents:()=>yf,EntityManager:()=>Rd,EventEmitter:()=>S,EventTypes:()=>Nr,Events:()=>A,ExResponse:()=>Eh,ExcaliburGraphicsContext2DCanvas:()=>na,ExcaliburGraphicsContextWebGL:()=>Vs,ExitTriggerEvent:()=>mh,ExitViewPortEvent:()=>_h,Fade:()=>fd,FadeInOut:()=>C_,Flags:()=>f,Flash:()=>Ad,Follow:()=>Mh,Font:()=>Is,FontCache:()=>Ae,FontSource:()=>x_,FontStyle:()=>zr,FontUnit:()=>kr,FpsSampler:()=>$d,FrameStats:()=>Ao,Future:()=>C,GameEvent:()=>ne,GameStartEvent:()=>G,GameStopEvent:()=>m,Gamepad:()=>Aa,GamepadAxisEvent:()=>ch,GamepadButtonEvent:()=>lh,GamepadConnectEvent:()=>Or,GamepadDisconnectEvent:()=>hh,Gamepads:()=>pa,GarbageCollector:()=>su,Gif:()=>w_,GifParser:()=>ou,GlobalCoordinates:()=>Sn,GpuParticleEmitter:()=>n_,GpuParticleRenderer:()=>wa,Graphic:()=>vt,GraphicsComponent:()=>De,GraphicsGroup:()=>Ws,GraphicsSystem:()=>Nh,HashColliderProxy:()=>zd,HashGridCell:()=>Ds,HashGridProxy:()=>Oh,HiddenEvent:()=>uh,HorizontalFirst:()=>Gc,ImageFiltering:()=>Gt,ImageSource:()=>Se,ImageSourceAttributeConstants:()=>Xt,ImageWrapping:()=>Jt,InitializeEvent:()=>En,InputHost:()=>Xh,InputMapper:()=>Nd,IsometricEntityComponent:()=>co,IsometricEntitySystem:()=>qh,IsometricMap:()=>o_,IsometricTile:()=>ru,KeyEvent:()=>_o,Keyboard:()=>Od,Keys:()=>fo,KillEvent:()=>Gr,Label:()=>i_,LimitCameraBoundsStrategy:()=>Sd,Line:()=>il,LineSegment:()=>Ve,Loader:()=>jr,LoaderEvents:()=>Df,LockCameraToActorAxisStrategy:()=>Id,LockCameraToActorStrategy:()=>Ed,LogLevel:()=>X,Logger:()=>j,Material:()=>An,Matrix:()=>x,MatrixLocations:()=>it,MediaEvent:()=>Ih,Meet:()=>kh,MotionComponent:()=>ve,MotionSystem:()=>ga,MoveBy:()=>Rh,MoveByWithOptions:()=>$c,MoveTo:()=>Fh,MoveToWithOptions:()=>Kc,NativePointerButton:()=>wr,NativeSoundEvent:()=>Vr,NativeSoundProcessedEvent:()=>Qc,NineSlice:()=>rl,NineSliceStretch:()=>$s,None:()=>Oc,Observable:()=>hi,OffscreenSystem:()=>Vh,Pair:()=>ki,ParallaxComponent:()=>ca,ParallelActions:()=>a_,Particle:()=>ra,ParticleEmitter:()=>s_,ParticleRenderer:()=>Mc,ParticleTransform:()=>_s,PhysicsStats:()=>va,PhysicsWorld:()=>Ud,PointerAbstraction:()=>Yh,PointerButton:()=>Xs,PointerComponent:()=>vr,PointerEvent:()=>po,PointerEventReceiver:()=>ma,PointerScope:()=>E,PointerSystem:()=>_a,PointerType:()=>Zs,Polygon:()=>sl,PolygonCollider:()=>Ai,Pool:()=>Mr,PostCollisionEvent:()=>Wr,PostDebugDrawEvent:()=>Tt,PostDrawEvent:()=>M,PostFrameEvent:()=>hs,PostKillEvent:()=>Cn,PostTransformDrawEvent:()=>Rt,PostUpdateEvent:()=>Vt,PreCollisionEvent:()=>Hr,PreDebugDrawEvent:()=>dt,PreDrawEvent:()=>b,PreFrameEvent:()=>Re,PreKillEvent:()=>bn,PreLoadEvent:()=>Zf,PreTransformDrawEvent:()=>K,PreUpdateEvent:()=>zt,Projection:()=>io,QuadIndexBuffer:()=>bi,QuadTree:()=>Dn,Query:()=>ho,QueryManager:()=>Fd,RadiusAroundActorStrategy:()=>Td,Random:()=>H,Raster:()=>qs,Ray:()=>Yr,RealisticSolver:()=>Uh,Rectangle:()=>ro,RemoveEvent:()=>xh,RemovedComponent:()=>vf,Repeat:()=>qc,RepeatForever:()=>Vc,Resolution:()=>bh,Resource:()=>pt,ResourceEvents:()=>Et,RotateBy:()=>sd,RotateByWithOptions:()=>id,RotateTo:()=>ed,RotateToWithOptions:()=>td,RotationType:()=>W,ScaleBy:()=>ld,ScaleByWithOptions:()=>hd,ScaleTo:()=>od,ScaleToWithOptions:()=>nd,Scene:()=>ss,SceneEvents:()=>$f,Screen:()=>Ch,ScreenAppender:()=>St,ScreenElement:()=>Qh,ScreenEvents:()=>Bf,ScreenShader:()=>Wd,ScrollPreventionMode:()=>yr,Semaphore:()=>P_,SeparatingAxis:()=>$e,SeparationInfo:()=>Hc,Shader:()=>Ze,Shape:()=>Ii,Side:()=>Dt,Slide:()=>I_,SolverStrategy:()=>so,Sound:()=>Lc,SoundEvents:()=>Pf,SparseHashGrid:()=>Hh,SparseHashGridCollisionProcessor:()=>jh,SpatialPartitionStrategy:()=>Bn,Sprite:()=>Ut,SpriteFont:()=>Me,SpriteSheet:()=>si,StandardClock:()=>Jh,StateMachine:()=>aa,StrategyContainer:()=>Cd,Stream:()=>nu,System:()=>is,SystemManager:()=>kd,SystemPriority:()=>Ps,SystemType:()=>Ji,TagQuery:()=>lo,TestClock:()=>Jd,Text:()=>Ar,TextAlign:()=>Qr,TextureLoader:()=>se,Tile:()=>bd,TileMap:()=>xd,TileMapEvents:()=>Wf,TiledAnimation:()=>nl,TiledSprite:()=>oi,Timer:()=>Zr,Toaster:()=>Kd,Transform:()=>as,TransformComponent:()=>Ot,Transition:()=>xa,TreeNode:()=>Th,Trigger:()=>Dd,TriggerEvents:()=>Vf,TwoPI:()=>k,Util:()=>y,Vector:()=>I,VectorView:()=>vn,VertexBuffer:()=>Fi,VertexLayout:()=>pi,VerticalFirst:()=>Nc,VisibleEvent:()=>dh,WebAudio:()=>qr,WebAudioInstance:()=>kc,WheelDeltaMode:()=>Pn,WheelEvent:()=>Hd,World:()=>Qd,approximatelyEqual:()=>O,assert:()=>r_,canonicalizeAngle:()=>Y,clamp:()=>L,coroutine:()=>lu,createId:()=>T,frac:()=>N,getDefaultPhysicsConfig:()=>Ys,hasGraphicsTick:()=>xn,hasOnAdd:()=>p_,hasOnInitialize:()=>d_,hasOnPostUpdate:()=>__,hasOnPreUpdate:()=>g_,hasOnRemove:()=>A_,hasPostDraw:()=>v_,hasPreDraw:()=>m_,has_add:()=>l_,has_initialize:()=>h_,has_postupdate:()=>f_,has_preupdate:()=>u_,has_remove:()=>c_,inverseLerp:()=>Yc,inverseLerpVector:()=>Xc,isActor:()=>Gf,isAddedComponent:()=>mf,isComponentCtor:()=>$n,isLoaderConstructor:()=>Bh,isMoveByOptions:()=>Zc,isMoveToOptions:()=>Jc,isRemovedComponent:()=>wf,isRotateByOptions:()=>Nf,isRotateToOptions:()=>Uf,isScaleByOptions:()=>ad,isScaleToOptions:()=>rd,isSceneConstructor:()=>Rs,isScreenElement:()=>wd,isSystemConstructor:()=>Md,lerp:()=>jc,lerpAngle:()=>Dh,lerpVector:()=>no,maxMessages:()=>cu,nextActionId:()=>ye,obsolete:()=>T_,parseImageFiltering:()=>Nt,parseImageWrapping:()=>he,pixelSnapEpsilon:()=>oe,randomInRange:()=>ut,randomIntInRange:()=>Z,range:()=>et,remap:()=>Ss,remapVector:()=>zf,resetObsoleteCounter:()=>B_,sign:()=>Q,toDegrees:()=>ot,toRadians:()=>nt,vec:()=>R,webgl:()=>u});var u={};o.r(u),o.d(u,{getAttributeComponentSize:()=>_n,getAttributePointerType:()=>Os,getGLTypeFromSource:()=>hr,getGlTypeSizeBytes:()=>Es,getMaxShaderComplexity:()=>Gi,isAttributeInSource:()=>cs});var _={};o.r(_),o.d(_,{circle:()=>Ko,line:()=>wn,point:()=>$o,roundRect:()=>yn,vector:()=>Jo});var A={};o.r(A),o.d(A,{ActionCompleteEvent:()=>wh,ActionStartEvent:()=>vh,ActivateEvent:()=>gh,AddEvent:()=>yh,CollisionEndEvent:()=>Kn,CollisionPostSolveEvent:()=>sa,CollisionPreSolveEvent:()=>ia,CollisionStartEvent:()=>Jn,ContactEndEvent:()=>ea,ContactStartEvent:()=>ta,DeactivateEvent:()=>fh,EnterTriggerEvent:()=>Ah,EnterViewPortEvent:()=>ph,EventTypes:()=>Nr,ExitTriggerEvent:()=>mh,ExitViewPortEvent:()=>_h,GameEvent:()=>ne,GameStartEvent:()=>G,GameStopEvent:()=>m,GamepadAxisEvent:()=>ch,GamepadButtonEvent:()=>lh,GamepadConnectEvent:()=>Or,GamepadDisconnectEvent:()=>hh,HiddenEvent:()=>uh,InitializeEvent:()=>En,KillEvent:()=>Gr,PostCollisionEvent:()=>Wr,PostDebugDrawEvent:()=>Tt,PostDrawEvent:()=>M,PostFrameEvent:()=>hs,PostKillEvent:()=>Cn,PostTransformDrawEvent:()=>Rt,PostUpdateEvent:()=>Vt,PreCollisionEvent:()=>Hr,PreDebugDrawEvent:()=>dt,PreDrawEvent:()=>b,PreFrameEvent:()=>Re,PreKillEvent:()=>bn,PreTransformDrawEvent:()=>K,PreUpdateEvent:()=>zt,RemoveEvent:()=>xh,VisibleEvent:()=>dh});var y={};o.r(y),o.d(y,{ConsoleAppender:()=>F,DrawUtil:()=>_,EasingFunctions:()=>Ce,LogLevel:()=>X,Logger:()=>j,Observable:()=>hi,ScreenAppender:()=>St,addItemToArray:()=>Ct,contains:()=>xt,delay:()=>de,fail:()=>yt,getPosition:()=>Mt,isObject:()=>Ht,mergeDeep:()=>Ie,omit:()=>Kt,removeItemFromArray:()=>Yt});function w(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(d){window.setInterval(d,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const e=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(s){return new Promise((n,a)=>{e.call(this,s,n,a)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(d){const e=Date.now();return setTimeout(function(){d({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(d){clearTimeout(d)})}class f{static useCanvasGraphicsContext(){f.enable("use-canvas-context")}static useLegacyImageRenderer(){f.enable("use-legacy-image-renderer")}static freeze(){f._FROZEN=!0}static _reset(){f._FROZEN=!1,f._FLAGS={}}static enable(e){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");f._FLAGS[e]=!0}static disable(e){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");f._FLAGS[e]=!1}static isEnabled(e){return!!f._FLAGS[e]}static show(){return Object.keys(f._FLAGS)}}f._FROZEN=!1,f._FLAGS={};function T(d,e){return{type:d,value:e}}class C{constructor(){this._isCompleted=!1,this.promise=new Promise((e,s)=>{this._resolver=e,this._rejecter=s})}get isCompleted(){return this._isCompleted}resolve(e){this._isCompleted||(this._isCompleted=!0,this._resolver(e))}reject(e){this._isCompleted||(this._isCompleted=!0,this._rejecter(e))}}class S{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(e,s){var n;return this._empty=!1,this._listeners[e]=(n=this._listeners[e])!==null&&n!==void 0?n:[],this._listeners[e].push(s),{close:()=>this.off(e,s)}}once(e,s){var n;return this._empty=!1,this._listenersOnce[e]=(n=this._listenersOnce[e])!==null&&n!==void 0?n:[],this._listenersOnce[e].push(s),{close:()=>this.off(e,s)}}off(e,s){var n,a;if(s){const l=(n=this._listeners[e])===null||n===void 0?void 0:n.filter(p=>p!==s);this._listeners[e]=l;const g=(a=this._listenersOnce[e])===null||a===void 0?void 0:a.filter(p=>p!==s);this._listenersOnce[e]=g}else delete this._listeners[e]}emit(e,s){if(this._empty||this._paused)return;const n=this._listeners[e];if(n)for(let l=0;l<n.length;l++)n[l](s);const a=this._listenersOnce[e];if(this._listenersOnce[e]=[],a)for(let l=0;l<a.length;l++)a[l](s);for(let l=0;l<this._pipes.length;l++)this._pipes[l].emit(e,s)}pipe(e){if(this===e)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(e),{close:()=>{const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}}}unpipe(e){const s=this._pipes.indexOf(e);s>-1&&this._pipes.splice(s,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var E;(function(d){d.Canvas="Canvas",d.Document="Document"})(E||(E={}));var W;(function(d){d.ShortestPath="shortest-path",d.LongestPath="longest-path",d.Clockwise="clockwise",d.CounterClockwise="counter-clockwise"})(W||(W={}));const D=4294967295;class H{constructor(e){this.seed=e,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(e||Date.now())>>>0;for(let s=1;s<this._n;s++){const n=this._mt[s-1]^this._mt[s-1]>>>this._w-2;this._mt[s]=(this._f*((n&4294901760)>>>16)<<16)+this._f*(n&65535)+s>>>0}this._index=this._n}_twist(){const e=[0,this._a];let s=0,n=0;for(;n<this._n-this._m;n++)s=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+this._m]^s>>>1^e[s&1]&D;for(;n<this._n-1;n++)s=this._mt[n]&this._upperMask|this._mt[n+1]&this._lowerMask,this._mt[n]=this._mt[n+(this._m-this._n)]^s>>>1^e[s&1]&D;s=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^s>>>1^e[s&1]&D,this._index=0}nextInt(){this._index>=this._n&&this._twist();let e=this._mt[this._index++];return e^=e>>>this._u,e^=e<<this._s&this._b,e^=e<<this._t&this._c,e^=e>>>this._l,e>>>0}next(){return this.nextInt()*(1/4294967296)}floating(e,s){return(s-e)*this.next()+e}integer(e,s){return Math.floor((s-e+1)*this.next()+e)}bool(e=.5){return this.next()<=e}pickOne(e){return e[this.integer(0,e.length-1)]}pickSet(e,s,n=!1){return n?this._pickSetWithDuplicates(e,s):this._pickSetWithoutDuplicates(e,s)}_pickSetWithoutDuplicates(e,s){if(s>e.length||s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(s===e.length)return e;const n=new Array(s);let a=0;const l=e.slice(0);for(;a<s;){const g=this.integer(0,l.length-1);n[a++]=l[g],l.splice(g,1)}return n}_pickSetWithDuplicates(e,s){if(s<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const n=new Array(s);for(let a=0;a<s;a++)n[a]=this.pickOne(e);return n}shuffle(e){const s=e.slice(0);let n;for(let a=0;a<s.length-2;a++){const l=this.integer(a,s.length-1);n=s[a],s[a]=s[l],s[l]=n}return s}range(e,s,n){const a=new Array(e);for(let l=0;l<e;l++)a[l]=this.integer(s,n);return a}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const k=Math.PI*2;function N(d){return d>=0?d-Math.floor(d):d-Math.ceil(d)}function Q(d){return d===0?0:d<0?-1:1}function L(d,e,s){return Math.min(Math.max(e,d),s)}function O(d,e,s){return Math.abs(d-e)<s}function Y(d){let e=d;if(d>=k)for(;e>=k;)e-=k;if(d<0)for(;e<0;)e+=k;return e}function ot(d){return 180/Math.PI*d}function nt(d){return d/180*Math.PI}const et=(d,e)=>Array.from(new Array(e-d+1),(s,n)=>n+d);function ut(d,e,s=new H){return s?s.floating(d,e):d+Math.random()*(e-d)}function Z(d,e,s=new H){return s?s.integer(d,e):Math.round(ut(d,e))}class I{static get Zero(){return new I(0,0)}static get One(){return new I(1,1)}static get Half(){return new I(.5,.5)}static get Up(){return new I(0,-1)}static get Down(){return new I(0,1)}static get Left(){return new I(-1,0)}static get Right(){return new I(1,0)}static fromAngle(e){return new I(Math.cos(e),Math.sin(e))}static isValid(e){return!(e==null||isNaN(e.x)||isNaN(e.y)||e.x===1/0||e.y===1/0||e.x===-1/0||e.y===-1/0)}static distance(e,s){return Math.sqrt(Math.pow(e.x-s.x,2)+Math.pow(e.y-s.y,2))}static min(e,s){return new I(Math.min(e.x,s.x),Math.min(e.y,s.y))}static max(e,s){return new I(Math.max(e.x,s.x),Math.max(e.y,s.y))}constructor(e,s){this._x=0,this._y=0,this._x=e,this._y=s}get x(){return this._x}set x(e){this._x=e}get y(){return this._y}set y(e){this._y=e}setTo(e,s){this.x=e,this.y=s}equals(e,s=I.EQUALS_EPSILON){return Math.abs(this.x-e.x)<=s&&Math.abs(this.y-e.y)<=s}distance(e){if(!e)return Math.sqrt(this.x*this.x+this.y*this.y);const s=this.x-e.x,n=this.y-e.y;return Math.sqrt(s*s+n*n)}squareDistance(e){e||(e=I.Zero);const s=this.x-e.x,n=this.y-e.y;return s*s+n*n}clampMagnitude(e){const s=this.magnitude,n=L(s,0,e);return this.magnitude=n,this}get size(){return this.distance()}set size(e){const s=this.normalize().scale(e);this.setTo(s.x,s.y)}get magnitude(){return this.distance()}set magnitude(e){this.normalize().scale(e,this)}normalize(){const e=this.distance();return e===0?I.Zero:new I(this.x/e,this.y/e)}average(e){return this.add(e).scale(.5)}scale(e,s){const n=s||new I(0,0);return e instanceof I?(n.x=this.x*e.x,n.y=this.y*e.y):(n.x=this.x*e,n.y=this.y*e),n}add(e,s){return s?(s.x=this.x+e.x,s.y=this.y+e.y,s):new I(this.x+e.x,this.y+e.y)}sub(e,s){const n=s||new I(0,0),a=this.x-e.x,l=this.y-e.y;return n.x=a,n.y=l,n}addEqual(e){return this.setTo(this.x+e.x,this.y+e.y),this}subEqual(e){return this.setTo(this.x-e.x,this.y-e.y),this}scaleEqual(e){return this.setTo(this.x*e,this.y*e),this}dot(e){return this.x*e.x+this.y*e.y}cross(e){if(e instanceof I)return this.x*e.y-this.y*e.x;if(typeof e=="number")return new I(e*this.y,-e*this.x)}static cross(e,s){return new I(-e*s.y,e*s.x)}perpendicular(){return new I(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return Y(Math.atan2(this.y,this.x))}angleBetween(e,s){const n=this.toAngle(),a=Y(e);let l=0,g=0;switch(a>n?l=a-n:l=(k-n+a)%k,g=(l-k)%k,s){case W.ShortestPath:return Math.abs(l)<Math.abs(g)?l:g;case W.LongestPath:return Math.abs(l)>Math.abs(g)?l:g;case W.Clockwise:return l;case W.CounterClockwise:return g}}rotate(e,s,n){const a=n||new I(0,0);s||(s=new I(0,0));const l=Math.sin(e),g=Math.cos(e),p=g*(this.x-s.x)-l*(this.y-s.y)+s.x,v=l*(this.x-s.x)+g*(this.y-s.y)+s.y;return a.x=p,a.y=v,a}clone(e){const s=e??new I(0,0);return s.x=this.x,s.y=this.y,s}toString(e){return e?`(${this.x.toFixed(e)}, ${this.y.toFixed(e)})`:`(${this.x}, ${this.y})`}}I.EQUALS_EPSILON=.001;function R(d,e){return new I(d,e)}class q{constructor(e,s,n,a){this.r=e,this.g=s,this.b=n,this.a=a??1}static fromRGB(e,s,n,a){return new q(e,s,n,a)}static fromRGBString(e){const s=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let n=null;if(n=e.match(s)){const a=parseInt(n[1],10),l=parseInt(n[2],10),g=parseInt(n[3],10);let p=1;return n[4]&&(p=parseFloat(n[4])),new q(a,l,g,p)}else throw new Error("Invalid rgb/a string: "+e)}static fromHex(e){const s=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let n=null;if(n=e.match(s)){const a=parseInt(n[1],16),l=parseInt(n[2],16),g=parseInt(n[3],16);let p=1;return n[4]&&(p=parseInt(n[4],16)/255),new q(a,l,g,p)}else throw new Error("Invalid hex string: "+e)}static fromHSL(e,s,n,a=1){return new tt(e,s,n,a).toRGBA()}lighten(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.l+=(1-s.l)*e,s.toRGBA()}darken(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.l-=s.l*e,s.toRGBA()}saturate(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.s+=s.s*e,s.toRGBA()}desaturate(e=.1){const s=tt.fromRGBA(this.r,this.g,this.b,this.a);return s.s-=s.s*e,s.toRGBA()}multiply(e){const s=e.r/255*this.r/255*255,n=e.g/255*this.g/255*255,a=e.b/255*this.b/255*255,l=e.a*this.a;return new q(s,n,a,l)}screen(e){const s=e.invert(),n=e.invert();return s.multiply(n).invert()}invert(){return new q(255-this.r,255-this.g,255-this.b,1-this.a)}average(e){const s=(e.r+this.r)/2,n=(e.g+this.g)/2,a=(e.b+this.b)/2,l=(e.a+this.a)/2;return new q(s,n,a,l)}equal(e){return this.toString()===e.toString()}toString(e="rgb"){switch(e){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(e){const s=Math.max(Math.round(e),0).toString(16);return s.length===1?"0"+s:s}toHex(){let e="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(e+=this._componentToHex(this.a*255)),e}toRGBA(){const e=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+e+", "+String(this.a)+")":"rgb("+e+")"}toHSLA(){return tt.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(e){const s=e||new q(this.r,this.g,this.b,this.a);return s.r=this.r,s.g=this.g,s.b=this.b,s.a=this.a,s}static get Black(){return q.fromHex("#000000")}static get White(){return q.fromHex("#FFFFFF")}static get Gray(){return q.fromHex("#808080")}static get LightGray(){return q.fromHex("#D3D3D3")}static get DarkGray(){return q.fromHex("#A9A9A9")}static get Yellow(){return q.fromHex("#FFFF00")}static get Orange(){return q.fromHex("#FFA500")}static get Red(){return q.fromHex("#FF0000")}static get Vermilion(){return q.fromHex("#FF5B31")}static get Rose(){return q.fromHex("#FF007F")}static get Pink(){return q.fromHex("#FFC0CB")}static get Magenta(){return q.fromHex("#FF00FF")}static get Violet(){return q.fromHex("#7F00FF")}static get Purple(){return q.fromHex("#800080")}static get Blue(){return q.fromHex("#0000FF")}static get Azure(){return q.fromHex("#007FFF")}static get Cyan(){return q.fromHex("#00FFFF")}static get Viridian(){return q.fromHex("#59978F")}static get Teal(){return q.fromHex("#008080")}static get Green(){return q.fromHex("#00FF00")}static get Chartreuse(){return q.fromHex("#7FFF00")}static get Transparent(){return q.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return q.fromHex("#176BAA")}static get Brown(){return q.fromHex("#964B00")}}class tt{constructor(e,s,n,a){this.h=e,this.s=s,this.l=n,this.a=a}static hue2rgb(e,s,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(s-e)*6*n:n<1/2?s:n<2/3?e+(s-e)*(2/3-n)*6:e}static fromRGBA(e,s,n,a){e/=255,s/=255,n/=255;const l=Math.max(e,s,n),g=Math.min(e,s,n);let p,v;const B=(l+g)/2;if(l===g)p=v=0;else{const P=l-g;switch(v=B>.5?P/(2-l-g):P/(l+g),l){case e:p=(s-n)/P+(s<n?6:0);break;case s:p=(n-e)/P+2;break;case n:p=(e-s)/P+4;break}p/=6}return new tt(p,v,B,a)}toRGBA(){let e,s,n;if(this.s===0)e=s=n=this.l;else{const a=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,l=2*this.l-a;e=tt.hue2rgb(l,a,this.h+1/3),s=tt.hue2rgb(l,a,this.h),n=tt.hue2rgb(l,a,this.h-1/3)}return new q(e*255,s*255,n*255,this.a)}toString(){const e=this.h.toFixed(0),s=this.s.toFixed(0),n=this.l.toFixed(0),a=this.a.toFixed(0);return`hsla(${e}, ${s}, ${n}, ${a})`}}var X;(function(d){d[d.Debug=0]="Debug",d[d.Info=1]="Info",d[d.Warn=2]="Warn",d[d.Error=3]="Error",d[d.Fatal=4]="Fatal"})(X||(X={}));class j{constructor(){if(this._appenders=[],this.defaultLevel=X.Info,this._logOnceSet=new Set,j._INSTANCE)throw new Error("Logger is a singleton");return j._INSTANCE=this,j._INSTANCE.addAppender(new F),j._INSTANCE}static getInstance(){return j._INSTANCE==null&&(j._INSTANCE=new j),j._INSTANCE}addAppender(e){this._appenders.push(e)}clearAppenders(){this._appenders.length=0}_log(e,s){e==null&&(e=this.defaultLevel);const n=this._appenders.length;for(let a=0;a<n;a++)e>=this.defaultLevel&&this._appenders[a].log(e,s)}_logOnce(e,s){const n=e+s.join("+");this._logOnceSet.has(n)||(this._logOnceSet.add(n),this._log(e,s))}debug(...e){this._log(X.Debug,e)}debugOnce(...e){this._logOnce(X.Debug,e)}info(...e){this._log(X.Info,e)}infoOnce(...e){this._logOnce(X.Info,e)}warn(...e){this._log(X.Warn,e)}warnOnce(...e){this._logOnce(X.Warn,e)}error(...e){this._log(X.Error,e)}errorOnce(...e){this._logOnce(X.Error,e)}fatal(...e){this._log(X.Fatal,e)}fatalOnce(...e){this._logOnce(X.Fatal,e)}}j._INSTANCE=null;class F{log(e,s){if(!console&&!console.log&&console.warn&&console.error)return;const n=[];n.unshift.apply(n,s),n.unshift("["+X[e]+"] : "),e<X.Warn?console.log.apply?console.log.apply(console,n):console.log(n.join(" ")):e<X.Error?console.warn.apply?console.warn.apply(console,n):console.warn(n.join(" ")):console.error.apply?console.error.apply(console,n):console.error(n.join(" "))}}class St{constructor(e){var s,n;this._messages=[],this._pos=10,this._color=q.Black,this._options=e,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(n=(s=e.zIndex)===null||s===void 0?void 0:s.toString())!==null&&n!==void 0?n:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),e.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var e,s,n,a;const l=this._options;this.canvas.width=(e=l.width)!==null&&e!==void 0?e:l.engine.screen.resolution.width,this.canvas.height=(s=l.height)!==null&&s!==void 0?s:l.engine.screen.resolution.height,this.canvas.style.position="absolute";const g=l.engine.screen.screenToPageCoordinates(R(0,0));this.canvas.style.left=g.x+"px",this.canvas.style.top=g.y+"px",this._pos=(n=l.xPos)!==null&&n!==void 0?n:this._pos,this._color=(a=l.color)!==null&&a!==void 0?a:this._color}log(e,s){const n=s.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+X[e]+"] : "+n);let a=10;this._messages=this._messages.slice(0,1e3);for(let l=0;l<this._messages.length;l++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[l],this._pos,a),a+=10}}var Dt;(function(d){d.None="None",d.Top="Top",d.Bottom="Bottom",d.Left="Left",d.Right="Right"})(Dt||(Dt={})),function(d){function e(n){return n===d.Top?d.Bottom:n===d.Bottom?d.Top:n===d.Left?d.Right:n===d.Right?d.Left:d.None}d.getOpposite=e;function s(n){return Math.abs(n.x)>=Math.abs(n.y)?n.x<=0?d.Left:d.Right:n.y<=0?d.Top:d.Bottom}d.fromDirection=s}(Dt||(Dt={}));class ht{constructor(e=0,s=0,n=0,a=0){this._points=[],typeof e=="object"?(this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom):typeof e=="number"&&(this.left=e,this.top=s,this.right=n,this.bottom=a)}clone(e){const s=e||new ht(0,0,0,0);return s.left=this.left,s.right=this.right,s.top=this.top,s.bottom=this.bottom,s}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(e){return e&&e?Math.abs(e.x)>Math.abs(e.y)?e.x<0?Dt.Right:Dt.Left:e.y<0?Dt.Bottom:Dt.Top:Dt.None}static fromPoints(e){let s=1/0,n=1/0,a=-1/0,l=-1/0;for(let g=0;g<e.length;g++)e[g].x<s&&(s=e[g].x),e[g].x>a&&(a=e[g].x),e[g].y<n&&(n=e[g].y),e[g].y>l&&(l=e[g].y);return new ht(s,n,a,l)}static fromDimension(e,s,n=I.Half,a=I.Zero){return new ht(-e*n.x+a.x,-s*n.y+a.y,e-e*n.x+a.x,s-s*n.y+a.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new I((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new I(this.left,this.top)}get bottomRight(){return new I(this.right,this.bottom)}get topRight(){return new I(this.right,this.top)}get bottomLeft(){return new I(this.left,this.bottom)}translate(e){return new ht(this.left+e.x,this.top+e.y,this.right+e.x,this.bottom+e.y)}rotate(e,s=I.Zero){const n=this.getPoints().map(a=>a.rotate(e,s));return ht.fromPoints(n)}scale(e,s=I.Zero){const n=this.translate(s);return new ht(n.left*e.x,n.top*e.y,n.right*e.x,n.bottom*e.y)}transform(e){const s=e.data[0]*this.left,n=e.data[1]*this.left,a=e.data[0]*this.right,l=e.data[1]*this.right,g=e.data[2]*this.top,p=e.data[3]*this.top,v=e.data[2]*this.bottom,B=e.data[3]*this.bottom,P=e.getPosition(),z=Math.min(s,a)+Math.min(g,v)+P.x,$=Math.min(n,l)+Math.min(p,B)+P.y,J=Math.max(s,a)+Math.max(g,v)+P.x,at=Math.max(n,l)+Math.max(p,B)+P.y;return new ht({left:z,top:$,right:J,bottom:at})}getPerimeter(){const e=this.width,s=this.height;return 2*(e+s)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new I(this.left,this.top)),this._points.push(new I(this.right,this.top)),this._points.push(new I(this.right,this.bottom)),this._points.push(new I(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(e,s=1/0){let n=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,g=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,p=(this.left-e.pos.x)*l,v=(this.right-e.pos.x)*l;n=Math.min(p,v),a=Math.max(p,v);const B=(this.top-e.pos.y)*g,P=(this.bottom-e.pos.y)*g;return n=Math.max(n,Math.min(B,P)),a=Math.min(a,Math.max(B,P)),a>=Math.max(0,n)&&n<s}rayCastTime(e,s=1/0){let n=-1/0,a=1/0;const l=e.dir.x===0?Number.MAX_VALUE:1/e.dir.x,g=e.dir.y===0?Number.MAX_VALUE:1/e.dir.y,p=(this.left-e.pos.x)*l,v=(this.right-e.pos.x)*l;n=Math.min(p,v),a=Math.max(p,v);const B=(this.top-e.pos.y)*g,P=(this.bottom-e.pos.y)*g;return n=Math.max(n,Math.min(B,P)),a=Math.min(a,Math.max(B,P)),a>=Math.max(0,n)&&n<s?n:-1}contains(e){return e instanceof I?this.left<=e.x&&this.top<=e.y&&e.y<=this.bottom&&e.x<=this.right:e instanceof ht?this.left<=e.left&&this.top<=e.top&&e.bottom<=this.bottom&&e.right<=this.right:!1}combine(e,s){const n=s||new ht(0,0,0,0),a=Math.min(this.left,e.left),l=Math.min(this.top,e.top),g=Math.max(this.right,e.right),p=Math.max(this.bottom,e.bottom);return n.left=a,n.top=l,n.right=g,n.bottom=p,n}get dimensions(){return new I(this.width,this.height)}overlaps(e,s){const n=s||0;if(e.hasZeroDimensions())return this.contains(e);if(this.hasZeroDimensions())return e.contains(this);const a=this.combine(e);return a.width+n<e.width+this.width&&a.height+n<e.height+this.height}intersect(e){const s=this.combine(e);if(s.width<e.width+this.width&&s.height<e.height+this.height&&!s.dimensions.equals(e.dimensions)&&!s.dimensions.equals(this.dimensions)){let n=0;this.right>=e.left&&this.right<=e.right?n=e.left-this.right:n=e.right-this.left;let a=0;return this.top<=e.bottom&&this.top>=e.top?a=e.bottom-this.top:a=e.top-this.bottom,Math.abs(n)<Math.abs(a)?new I(n,0):new I(0,a)}else if(s.dimensions.equals(e.dimensions)||s.dimensions.equals(this.dimensions)){let n=0;this.width-e.width>=0?this.right-e.right<=e.left-this.left?n=e.left-this.right:n=e.right-this.left:e.right-this.right<=this.left-e.left?n=this.left-e.right:n=this.right-e.left;let a=0;return this.height-e.height>=0?this.bottom-e.bottom<=e.top-this.top?a=e.top-this.bottom:a=e.bottom-this.top:e.bottom-this.bottom<=this.top-e.top?a=this.top-e.bottom:a=this.bottom-e.top,Math.abs(n)<Math.abs(a)?new I(n,0):new I(0,a)}else return null}intersectWithSide(e){const s=this.intersect(e);return ht.getSideFromIntersection(s)}draw(e,s=q.Yellow){e.debug.drawRect(this.left,this.top,this.width,this.height,{color:s})}}function Mt(d){if(d&&d.getBoundingClientRect){const e=d.getBoundingClientRect();return R(e.x+window.scrollX,e.y+window.scrollY)}return I.Zero}function Ct(d,e){return e.indexOf(d)===-1?(e.push(d),!0):!1}function Yt(d,e){let s=-1;return(s=e.indexOf(d))>-1?(e.splice(s,1),!0):!1}function xt(d,e){for(let s=0;s<d.length;s++)if(d[s]===e)return!0;return!1}function yt(d){throw new Error(d)}function de(d,e){var s;const n=new C;return((s=e==null?void 0:e.schedule.bind(e))!==null&&s!==void 0?s:setTimeout)(()=>{n.resolve()},d),n.promise}function Kt(d,e){const s={};for(const n in d)e.includes(n)||(s[n]=d[n]);return s}function Ht(d){return d&&typeof d=="object"&&!Array.isArray(d)}function Ie(d,...e){if(!e.length)return d;const s=e.shift();if(Ht(d)&&Ht(s))for(const n in s)Ht(s[n])?(d[n]||Object.assign(d,{[n]:{}}),Ie(d[n],s[n])):Object.assign(d,{[n]:s[n]});return Ie(d,...e)}var it;(function(d){d[d.X=12]="X",d[d.Y=13]="Y"})(it||(it={}));class x{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(e,s,n,a,l,g){const p=new x;return p.data[0]=2/(s-e),p.data[1]=0,p.data[2]=0,p.data[3]=0,p.data[4]=0,p.data[5]=2/(a-n),p.data[6]=0,p.data[7]=0,p.data[8]=0,p.data[9]=0,p.data[10]=-2/(g-l),p.data[11]=0,p.data[12]=-(s+e)/(s-e),p.data[13]=-(a+n)/(a-n),p.data[14]=-(g+l)/(g-l),p.data[15]=1,p}clone(e){const s=e||new x;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s.data[6]=this.data[6],s.data[7]=this.data[7],s.data[8]=this.data[8],s.data[9]=this.data[9],s.data[10]=this.data[10],s.data[11]=this.data[11],s.data[12]=this.data[12],s.data[13]=this.data[13],s.data[14]=this.data[14],s.data[15]=this.data[15],s}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(e){const s=new x;return s.data=e,s}static identity(){const e=new x;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=0,e.data[4]=0,e.data[5]=1,e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=0,e.data[13]=0,e.data[14]=0,e.data[15]=1,e}static translation(e,s){const n=x.identity();return n.data[12]=e,n.data[13]=s,n}static scale(e,s){const n=x.identity();return n.data[0]=e,n.data[5]=s,n.data[10]=1,n.data[15]=1,n}static rotation(e){const s=x.identity();return s.data[0]=Math.cos(e),s.data[4]=-Math.sin(e),s.data[1]=Math.sin(e),s.data[5]=Math.cos(e),s}multiply(e,s){if(e instanceof I){const n=s||new I(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[4]+this.data[12],g=a.x*this.data[1]+a.y*this.data[5]+this.data[13];return n.x=l,n.y=g,n}else{const n=s||new x,a=e,l=this.data[0],g=this.data[1],p=this.data[2],v=this.data[3],B=this.data[4],P=this.data[5],z=this.data[6],$=this.data[7],J=this.data[8],at=this.data[9],ct=this.data[10],At=this.data[11],lt=this.data[12],gt=this.data[13],Pt=this.data[14],wt=this.data[15],Qt=a.data[0],jt=a.data[1],It=a.data[2],re=a.data[3],_e=a.data[4],ke=a.data[5],Qe=a.data[6],Bi=a.data[7],je=a.data[8],Fe=a.data[9],Ti=a.data[10],mi=a.data[11],Wt=a.data[12],Jr=a.data[13],Kr=a.data[14],tn=a.data[15];n.data[0]=l*Qt+B*jt+J*It+lt*re,n.data[1]=g*Qt+P*jt+at*It+gt*re,n.data[2]=p*Qt+z*jt+ct*It+Pt*re,n.data[3]=v*Qt+$*jt+At*It+wt*re,n.data[4]=l*_e+B*ke+J*Qe+lt*Bi,n.data[5]=g*_e+P*ke+at*Qe+gt*Bi,n.data[6]=p*_e+z*ke+ct*Qe+Pt*Bi,n.data[7]=v*_e+$*ke+At*Qe+wt*Bi,n.data[8]=l*je+B*Fe+J*Ti+lt*mi,n.data[9]=g*je+P*Fe+at*Ti+gt*mi,n.data[10]=p*je+z*Fe+ct*Ti+Pt*mi,n.data[11]=v*je+$*Fe+At*Ti+wt*mi,n.data[12]=l*Wt+B*Jr+J*Kr+lt*tn,n.data[13]=g*Wt+P*Jr+at*Kr+gt*tn,n.data[14]=p*Wt+z*Jr+ct*Kr+Pt*tn,n.data[15]=v*Wt+$*Jr+At*Kr+wt*tn;const Fn=this.getScale();return n._scaleSignX=Q(Fn.x)*Q(n._scaleSignX),n._scaleSignY=Q(Fn.y)*Q(n._scaleSignY),n}}translate(e,s){const n=this.data[0],a=this.data[1],l=this.data[2],g=this.data[3],p=this.data[4],v=this.data[5],B=this.data[6],P=this.data[7],z=this.data[8],$=this.data[9],J=this.data[10],at=this.data[11],ct=this.data[12],At=this.data[13],lt=this.data[14],gt=this.data[15],Pt=0,wt=1;return this.data[12]=n*e+p*s+z*Pt+ct*wt,this.data[13]=a*e+v*s+$*Pt+At*wt,this.data[14]=l*e+B*s+J*Pt+lt*wt,this.data[15]=g*e+P*s+at*Pt+gt*wt,this}setPosition(e,s){this.data[12]=e,this.data[13]=s}getPosition(){return R(this.data[12],this.data[13])}rotate(e){const s=this.data[0],n=this.data[1],a=this.data[2],l=this.data[3],g=this.data[4],p=this.data[5],v=this.data[6],B=this.data[7],P=Math.sin(e),z=Math.cos(e);return this.data[0]=z*s+P*g,this.data[1]=z*n+P*p,this.data[2]=z*a+P*v,this.data[3]=z*l+P*B,this.data[4]=z*g-P*s,this.data[5]=z*p-P*n,this.data[6]=z*v-P*a,this.data[7]=z*B-P*l,this}scale(e,s){const n=this.data[0],a=this.data[1],l=this.data[2],g=this.data[3],p=this.data[4],v=this.data[5],B=this.data[6],P=this.data[7];return this.data[0]=n*e,this.data[1]=a*e,this.data[2]=l*e,this.data[3]=g*e,this.data[4]=p*s,this.data[5]=v*s,this.data[6]=B*s,this.data[7]=P*s,this}setRotation(e){const s=this.getScale(),n=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=n*s.y,this.data[4]=-n*s.x,this.data[5]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return Y(e)}getScaleX(){const e=R(this.data[0],this.data[4]).magnitude;return this._scaleSignX*e}getScaleY(){const e=R(this.data[1],this.data[5]).magnitude;return this._scaleSignY*e}getScale(){return R(this.getScaleX(),this.getScaleY())}setScaleX(e){if(this._scaleX===e)return;this._scaleSignX=Q(e);const s=R(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[4]=s.y*e,this._scaleX=e}setScaleY(e){if(this._scaleY===e)return;this._scaleSignY=Q(e);const s=R(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[5]=s.y*e,this._scaleY=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(e){const n=1/this.getBasisDeterminant(),a=this.data[0],l=this.data[4],g=this.data[1],p=this.data[5],v=e||x.identity();v.data[0]=p*n,v.data[1]=-g*n,v.data[4]=-l*n,v.data[5]=a*n;const B=this.data[12],P=this.data[13];return v.data[12]=-(B*v.data[0]+P*v.data[4]),v.data[13]=-(B*v.data[1]+P*v.data[5]),v}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class st{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const e=new st;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}static translation(e,s){const n=st.identity();return n.data[4]=e,n.data[5]=s,n}static scale(e,s){const n=st.identity();return n.data[0]=e,n.data[3]=s,n._scale[0]=e,n._scale[1]=s,n}static rotation(e){const s=st.identity();return s.data[0]=Math.cos(e),s.data[1]=Math.sin(e),s.data[2]=-Math.sin(e),s.data[3]=Math.cos(e),s}setPosition(e,s){this.data[4]=e,this.data[5]=s}getPosition(){return R(this.data[4],this.data[5])}rotate(e){const s=this.data[0],n=this.data[1],a=this.data[2],l=this.data[3],g=Math.sin(e),p=Math.cos(e);return this.data[0]=p*s+g*a,this.data[1]=p*n+g*l,this.data[2]=p*a-g*s,this.data[3]=p*l-g*n,this}translate(e,s){const n=this.data[0],a=this.data[1],l=this.data[2],g=this.data[3],p=this.data[4],v=this.data[5];return this.data[4]=n*e+l*s+p,this.data[5]=a*e+g*s+v,this}scale(e,s){const n=this.data[0],a=this.data[1],l=this.data[2],g=this.data[3];return this.data[0]=n*e,this.data[1]=a*e,this.data[2]=l*s,this.data[3]=g*s,this._scale[0]=e,this._scale[1]=s,this._scaleSignX=Q(e),this._scaleSignY=Q(s),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(e){const s=this.determinant();let n=s;s!==0&&(n=1/s);const a=this.data[0],l=this.data[2],g=this.data[1],p=this.data[3],v=e||st.identity();v.data[0]=p*n,v.data[1]=-g*n,v.data[2]=-l*n,v.data[3]=a*n;const B=this.data[4],P=this.data[5];return v.data[4]=-(B*v.data[0]+P*v.data[2]),v.data[5]=-(B*v.data[1]+P*v.data[3]),v}multiply(e,s){if(e instanceof I){const n=s||new I(0,0),a=e,l=a.x*this.data[0]+a.y*this.data[2]+this.data[4],g=a.x*this.data[1]+a.y*this.data[3]+this.data[5];return n.x=l,n.y=g,n}else{const n=s||new st,a=e,l=this.data[0],g=this.data[1],p=this.data[2],v=this.data[3],B=this.data[4],P=this.data[5],z=a.data[0],$=a.data[1],J=a.data[2],at=a.data[3],ct=a.data[4],At=a.data[5];n.data[0]=l*z+p*$,n.data[1]=g*z+v*$,n.data[2]=l*J+p*at,n.data[3]=g*J+v*at,n.data[4]=l*ct+p*At+B,n.data[5]=g*ct+v*At+P;const lt=this._scaleSignX,gt=this._scaleSignY;return n._scaleSignX=lt*Q(n._scaleSignX),n._scaleSignY=gt*Q(n._scaleSignY),n}}multiplyQuadInPlace(e){const s=e[0]*this.data[0]+e[1]*this.data[2]+this.data[4],n=e[0]*this.data[1]+e[1]*this.data[3]+this.data[5];e[0]=s,e[1]=n;const a=e[2]*this.data[0]+e[3]*this.data[2]+this.data[4],l=e[2]*this.data[1]+e[3]*this.data[3]+this.data[5];e[2]=a,e[3]=l;const g=e[4]*this.data[0]+e[5]*this.data[2]+this.data[4],p=e[4]*this.data[1]+e[5]*this.data[3]+this.data[5];e[4]=g,e[5]=p;const v=e[6]*this.data[0]+e[7]*this.data[2]+this.data[4],B=e[6]*this.data[1]+e[7]*this.data[3]+this.data[5];e[6]=v,e[7]=B}to4x4(){const e=new x;return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=0,e.data[3]=0,e.data[4]=this.data[2],e.data[5]=this.data[3],e.data[6]=0,e.data[7]=0,e.data[8]=0,e.data[9]=0,e.data[10]=1,e.data[11]=0,e.data[12]=this.data[4],e.data[13]=this.data[5],e.data[14]=0,e.data[15]=1,e}setRotation(e){const s=this.getScale(),n=Math.sin(e),a=Math.cos(e);this.data[0]=a*s.x,this.data[1]=n*s.y,this.data[2]=-n*s.x,this.data[3]=a*s.y}getRotation(){const e=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return Y(e)}getScaleX(){const e=this.data[0]*this.data[0]+this.data[2]*this.data[2];return e===1?this._scaleSignX:this._scaleSignX*Math.sqrt(e)}getScaleY(){const e=this.data[1]*this.data[1]+this.data[3]*this.data[3];return e===1?this._scaleSignY:this._scaleSignY*Math.sqrt(e)}getScale(){return R(this.getScaleX(),this.getScaleY())}setScaleX(e){if(e===this._scale[0])return;this._scaleSignX=Q(e);const s=R(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=s.x*e,this.data[2]=s.y*e,this._scale[0]=e}setScaleY(e){if(e===this._scale[1])return;this._scaleSignY=Q(e);const s=R(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=s.x*e,this.data[3]=s.y*e,this._scale[1]=e}setScale(e){this.setScaleX(e.x),this.setScaleY(e.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const e=this;return e.data[0]=1,e.data[1]=0,e.data[2]=0,e.data[3]=1,e.data[4]=0,e.data[5]=0,e}clone(e){const s=e||new st;return s.data[0]=this.data[0],s.data[1]=this.data[1],s.data[2]=this.data[2],s.data[3]=this.data[3],s.data[4]=this.data[4],s.data[5]=this.data[5],s._scaleSignX=this._scaleSignX,s._scaleSignY=this._scaleSignY,s}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class _t{constructor(e,s,n=1){this.builder=e,this.cleaner=s,this._pool=[],this._size=0,this.grow(n)}grow(e){if(e>0){this._size+=e;for(let s=0;s<e;s++)this._pool.push(this.builder())}}rent(e=!1){return this._pool.length===0&&this.grow(this._size),e?this.cleaner(this._pool.pop()):this._pool.pop()}return(e){this._pool.push(e)}}class V{constructor(){this._pool=new _t(()=>st.identity(),e=>e.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(e,s){return this._currentTransform.translate(e,s)}rotate(e){return this._currentTransform.rotate(e)}scale(e,s){return this._currentTransform.scale(e,s)}reset(){this._currentTransform.reset()}set current(e){this._currentTransform=e}get current(){return this._currentTransform}}class Ft{constructor(){this.opacity=1,this.z=0,this.tint=q.White,this.material=null}}class Lt{constructor(){this._pool=new _t(()=>new Ft,e=>(e.opacity=1,e.z=0,e.tint=q.White,e.material=null,e),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(e){var s;return e.opacity=this.current.opacity,e.z=this.current.z,e.tint=(s=this.current.tint)===null||s===void 0?void 0:s.clone(),e.material=this.current.material,e}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const Et={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class pt{constructor(e,s,n=!1){this.path=e,this.responseType=s,this.bustCache=n,this.data=null,this.logger=j.getInstance(),this.events=new S}isLoaded(){return this.data!==null}_cacheBust(e){return/\?\w*=\w*/.test(e)?e+="&__="+Date.now():e+="?__="+Date.now(),e}load(){return new Promise((e,s)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),e(this.data);return}const n=new XMLHttpRequest;n.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),n.responseType=this.responseType,n.addEventListener("loadstart",a=>this.events.emit("loadstart",a)),n.addEventListener("progress",a=>this.events.emit("progress",a)),n.addEventListener("error",a=>this.events.emit("error",a)),n.addEventListener("load",a=>this.events.emit("load",a)),n.addEventListener("load",()=>{if(n.status!==0&&n.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",n.status),this.events.emit("error",n.response),s(new Error(n.statusText));return}if(n.response instanceof Blob&&n.response.type==="text/html"){const a=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",n.response),s(new Error(a));return}this.data=n.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),e(this.data)}),n.send()})}}function mt(d,e){return d&&(d.__isProxy===void 0?new Proxy(d,{set:(s,n,a)=>(s[n]!==a&&(s[n]=a,typeof n=="string"&&n[0]!=="_"&&e(s)),!0),get:(s,n)=>n!=="__isProxy"?s[n]:!0}):d)}const bt=(d=[],e,s)=>({get:(n,a)=>a==="__isProxy"?!0:typeof n[a]=="object"&&n[a]!=null?new Proxy(n[a],bt([...d,a],e,s)):n[a],set:(n,a,l)=>(typeof a=="string"&&a[0]!=="_"&&e(s),n[a]=l,!0)});function Bt(d,e){return d&&(d.__isProxy===void 0?new Proxy(d,bt([],e,d)):d)}class vt{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(e){this._flipHorizontal=e,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(e){this._flipVertical=e,this._transformStale=!0}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._transformStale=!0}get scale(){return this._scale}set scale(e){this._scale=mt(e,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(e){e&&(this._origin=mt(e,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(e){var s,n,a,l,g,p,v;this.id=vt._ID++,this.transform=st.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=I.One,this._width=0,this._height=0,e&&(this.origin=(s=e.origin)!==null&&s!==void 0?s:this.origin,this.flipHorizontal=(n=e.flipHorizontal)!==null&&n!==void 0?n:this.flipHorizontal,this.flipVertical=(a=e.flipVertical)!==null&&a!==void 0?a:this.flipVertical,this.rotation=(l=e.rotation)!==null&&l!==void 0?l:this.rotation,this.opacity=(g=e.opacity)!==null&&g!==void 0?g:this.opacity,this.scale=(p=e.scale)!==null&&p!==void 0?p:this.scale,this.tint=(v=e.tint)!==null&&v!==void 0?v:this.tint,e.width&&(this._width=e.width),e.height&&(this._height=e.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(e){this._width=e,this._transformStale=!0}set height(e){this._height=e,this._transformStale=!0}get localBounds(){return ht.fromDimension(this.width,this.height,I.Zero)}draw(e,s,n){this._preDraw(e,s,n),this._drawImage(e,0,0),this._postDraw(e)}_preDraw(e,s,n){e.save(),e.translate(s,n),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),e.multiply(this.transform),e.opacity=e.opacity*this.opacity,this.tint&&(e.tint=this.tint)}_rotate(e){var s;const n=this.scale.x>0?1:-1,a=this.scale.y>0?1:-1,l=(s=this.origin)!==null&&s!==void 0?s:R(this.width/2,this.height/2);e.translate(l.x,l.y),e.rotate(this.rotation),e.scale(n,a),e.translate(-l.x,-l.y)}_flip(e){this.flipHorizontal&&(e.translate(this.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,this.height/this.scale.y),e.scale(1,-1))}_postDraw(e){this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore()}}vt._ID=0;class Ut extends vt{static from(e,s){return new Ut({image:e,...s})}constructor(e){var s,n;super(e),this._logger=j.getInstance(),this._dirty=!0,this.image=e.image;const{width:a,height:l}=e;this.sourceView=(s=e.sourceView)!==null&&s!==void 0?s:{x:0,y:0,width:a??0,height:l??0},this.destSize=(n=e.destSize)!==null&&n!==void 0?n:{width:a??0,height:l??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(e){e/=Math.abs(this.scale.x),this.destSize.width=e,super.width=Math.ceil(this.destSize.width)}set height(e){e/=Math.abs(this.scale.y),this.destSize.height=e,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var e,s,n,a,l,g;const{width:p,height:v}=this.image;this.sourceView.width=((e=this.sourceView)===null||e===void 0?void 0:e.width)||p,this.sourceView.height=((s=this.sourceView)===null||s===void 0?void 0:s.height)||v,this.destSize.width=((n=this.destSize)===null||n===void 0?void 0:n.width)||((a=this.sourceView)===null||a===void 0?void 0:a.width)||p,this.destSize.height=((l=this.destSize)===null||l===void 0?void 0:l.height)||((g=this.sourceView)===null||g===void 0?void 0:g.height)||v,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(e,s,n){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(e,s,n)}_drawImage(e,s,n){this.image.isLoaded()?e.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,s,n,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Ut({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var Gt;(function(d){d.Pixel="Pixel",d.Blended="Blended"})(Gt||(Gt={}));function Nt(d){switch(d){case Gt.Pixel:return Gt.Pixel;case Gt.Blended:return Gt.Blended;default:return}}var Jt;(function(d){d.Clamp="Clamp",d.Repeat="Repeat",d.Mirror="Mirror"})(Jt||(Jt={}));function he(d){switch(d){case Jt.Clamp:return Jt.Clamp;case Jt.Repeat:return Jt.Repeat;case Jt.Mirror:return Jt.Mirror;default:return Jt.Clamp}}class se{constructor(e,s){var n;this._garbageCollector=s,this._textureMap=new Map,this._collect=a=>{var l;if(this._gl){const g=(l=a.dataset.originalSrc)!==null&&l!==void 0?l:a.constructor.name;return se._LOGGER.debug(`WebGL Texture for ${g} collected`),this.delete(a),!0}return!1},this._gl=e,se._MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),this._garbageCollector&&(se._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(n=this._garbageCollector.garbageCollector)===null||n===void 0||n.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[e]of this._textureMap)this.delete(e);this._textureMap.clear(),this._gl=null}get(e){return this._textureMap.get(e)}has(e){return this._textureMap.has(e)}load(e,s,n=!1){var a,l;const g=this._gl;if(!g)return null;const{filtering:p,wrapping:v}={...s};let B=null;if(this.has(e)&&(B=this.get(e)),B)return n&&(g.bindTexture(g.TEXTURE_2D,B),g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,e)),(a=this._garbageCollector)===null||a===void 0||a.garbageCollector.touch(e),B;B=g.createTexture(),se.checkImageSizeSupportedAndLog(e),g.bindTexture(g.TEXTURE_2D,B),g.pixelStorei(g.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let P;v&&(typeof v=="string"?P={x:v,y:v}:P={x:v.x,y:v.y});const{x:z,y:$}=P??se.wrapping;switch(z){case Jt.Clamp:g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE);break;case Jt.Repeat:g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.REPEAT);break;case Jt.Mirror:g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.MIRRORED_REPEAT);break;default:g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE)}switch($){case Jt.Clamp:g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE);break;case Jt.Repeat:g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.REPEAT);break;case Jt.Mirror:g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.MIRRORED_REPEAT);break;default:g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE)}const J=p??se.filtering;return g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,J===Gt.Pixel?g.NEAREST:g.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,J===Gt.Pixel?g.NEAREST:g.LINEAR),g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,e),this._textureMap.set(e,B),(l=this._garbageCollector)===null||l===void 0||l.garbageCollector.addCollectableResource("texture",e),B}delete(e){const s=this._gl;if(s&&this.has(e)){const n=this.get(e);n&&(this._textureMap.delete(e),s.deleteTexture(n))}}static checkImageSizeSupportedAndLog(e){var s;const n=(s=e.dataset.originalSrc)!==null&&s!==void 0?s:"internal canvas bitmap";return e.width>se._MAX_TEXTURE_SIZE||e.height>se._MAX_TEXTURE_SIZE?(se._LOGGER.error(`The image [${n}] provided to Excalibur is too large for the device's maximum texture size of (${se._MAX_TEXTURE_SIZE}x${se._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((e.width>4096||e.height>4096)&&se._LOGGER.warn(`The image [${n}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}se._LOGGER=j.getInstance(),se.filtering=Gt.Blended,se.wrapping={x:Jt.Clamp,y:Jt.Clamp},se._MAX_TEXTURE_SIZE=4096;const Xt={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class Se{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(e,s,n){this._logger=j.getInstance(),this.data=new Image,this._readyFuture=new C,this.ready=this._readyFuture.promise,this.path=e;let a=!1,l;typeof s=="boolean"?a=s:{filtering:n,wrapping:l,bustCache:a}={...s},this._resource=new pt(e,"blob",a),this.filtering=n??this.filtering,typeof l=="string"?this.wrapping={x:l,y:l}:this.wrapping=l??this.wrapping,e.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${e} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(e,s){const n=new Se("");if(n._src="image-element",n.data=e,n.data.setAttribute("data-original-src","image-element"),s!=null&&s.filtering?n.data.setAttribute(Xt.Filtering,s==null?void 0:s.filtering):n.data.setAttribute(Xt.Filtering,Gt.Blended),s!=null&&s.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},n.data.setAttribute(Xt.WrappingX,a.x),n.data.setAttribute(Xt.WrappingY,a.y)}else n.data.setAttribute(Xt.WrappingX,Jt.Clamp),n.data.setAttribute(Xt.WrappingY,Jt.Clamp);return se.checkImageSizeSupportedAndLog(e),n._readyFuture.resolve(e),n}static fromHtmlCanvasElement(e,s){const n=new Se("");if(n._src="canvas-element-blob",n.data.setAttribute("data-original-src","canvas-element-blob"),s!=null&&s.filtering?n.data.setAttribute(Xt.Filtering,s==null?void 0:s.filtering):n.data.setAttribute(Xt.Filtering,Gt.Blended),s!=null&&s.wrapping){let a;typeof s.wrapping=="string"?a={x:s.wrapping,y:s.wrapping}:a={x:s.wrapping.x,y:s.wrapping.y},n.data.setAttribute(Xt.WrappingX,a.x),n.data.setAttribute(Xt.WrappingY,a.y)}else n.data.setAttribute(Xt.WrappingX,Jt.Clamp),n.data.setAttribute(Xt.WrappingY,Jt.Clamp);return se.checkImageSizeSupportedAndLog(e),e.toBlob(a=>{const l=URL.createObjectURL(a);n.image.onload=()=>{URL.revokeObjectURL(l),n.data=n.image,n._readyFuture.resolve(n.image)},n.image.src=l}),n}static fromSvgString(e,s){const n=new Blob([e],{type:"image/svg+xml"}),a=URL.createObjectURL(n);return new Se(a,s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){var e,s,n,a;if(this.isLoaded())return this.data;try{let l;if(this.path.includes("data:image/"))l=this.path;else{const v=await this._resource.load();l=URL.createObjectURL(v)}const g=new Image,p=new C;g.onload=()=>p.resolve(),g.src=l,g.setAttribute("data-original-src",this.path),await p.promise,this.data=g,se.checkImageSizeSupportedAndLog(this.data)}catch(l){throw`Error loading ImageSource from path '${this.path}' with error [${l.message}]`}return this.data.setAttribute(Xt.Filtering,this.filtering),this.data.setAttribute(Xt.WrappingX,(s=(e=this.wrapping)===null||e===void 0?void 0:e.x)!==null&&s!==void 0?s:Jt.Clamp),this.data.setAttribute(Xt.WrappingY,(a=(n=this.wrapping)===null||n===void 0?void 0:n.y)!==null&&a!==void 0?a:Jt.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(e){return Ut.from(this,e)}unload(){this.data=new Image}}class Me extends vt{constructor(e){super(e),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=j.getInstance();const{alphabet:s,spriteSheet:n,caseInsensitive:a,spacing:l,shadow:g,lineHeight:p}=e;this.alphabet=s,this.spriteSheet=n,this.caseInsensitive=a??this.caseInsensitive,this.spacing=l??this.spacing,this.shadow=g??this.shadow,this.lineHeight=p??this.lineHeight}_getCharacterSprites(e){const s=[],n=this.caseInsensitive?e.toLocaleLowerCase():e,a=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let l=0;l<n.length;l++){const g=n[l];let p=a.indexOf(g);p===-1&&(p=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${g}' in configured alphabet '${a}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const v=this.spriteSheet.sprites[p];v?s.push(v):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${g}' at index '${p}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return s}measureText(e,s){const n=this._getLinesFromText(e,s),a=n.reduce((v,B)=>v.length>B.length?v:B),l=this._getCharacterSprites(a);let g=0,p=0;for(const v of l)g+=v.width+this.spacing,p=Math.max(p,v.height);return ht.fromDimension(g*this.scale.x,p*n.length*this.scale.y,I.Zero)}_drawImage(e,s,n,a){var l;let g=0,p=0,v=0;const B=this._getLinesFromText(this._text,a);for(const P of B){for(const z of this._getCharacterSprites(P))z.draw(e,s+g,n+p),g+=z.width+this.spacing,v=Math.max(v,z.height);g=0,p+=(l=this.lineHeight)!==null&&l!==void 0?l:v}}render(e,s,n,a,l,g){this._text=s;const p=this.measureText(s,g);this.width=p.width,this.height=p.height,this.shadow&&(e.save(),e.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(e,a,l),this._drawImage(e,0,0,g),this._postDraw(e),e.restore()),this._preDraw(e,a,l),this._drawImage(e,0,0,g),this._postDraw(e)}clone(){return new Me({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(e,s){var n;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let g=a[l],p="";if(this.measureText(g).width>s){for(;this.measureText(g).width>s;)p=g[g.length-1]+p,g=g.slice(0,-1);a[l]=g,a[l+1]=p}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class oi extends Ut{constructor(e){super({image:e.image,sourceView:e.sourceView,destSize:{width:e.width,height:e.height},flipHorizontal:e.flipHorizontal,flipVertical:e.flipVertical,rotation:e.rotation,scale:e.scale,opacity:e.opacity,tint:e.tint,origin:e.origin}),this._ready=new C,this.ready=this._ready.promise,this._options=e,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(e,s){return new oi({sourceView:{...e.sourceView},width:e.width,height:e.height,...s,image:e.image})}_applyTiling(){const{width:e,height:s,filtering:n,wrapping:a}={...this._options},l=document.createElement("canvas");l.width=this.sourceView.width,l.height=this.sourceView.height,l.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const p=Se.fromHtmlCanvasElement(l,{wrapping:a??Jt.Repeat,filtering:n});e&&(this.destSize.width=e,this.sourceView.width=e),s&&(this.destSize.height=s,this.sourceView.height=s),this.sourceView.x=0,this.sourceView.y=0,this.image=p,this.image.ready.then(()=>this._ready.resolve())}}class si{constructor(e){this.sprites=[];const{sprites:s,rows:n,columns:a}=e;this.sprites=s,this.rows=n??1,this.columns=a??this.sprites.length}getSprite(e,s,n){var a,l,g,p,v,B,P,z,$;if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const J=e+s*this.columns,at=this.sprites[J];if(at){if(n){const ct=at.clone();return ct.flipHorizontal=(a=n.flipHorizontal)!==null&&a!==void 0?a:ct.flipHorizontal,ct.flipVertical=(l=n.flipVertical)!==null&&l!==void 0?l:ct.flipVertical,ct.width=(g=n.width)!==null&&g!==void 0?g:ct.width,ct.height=(p=n.height)!==null&&p!==void 0?p:ct.height,ct.rotation=(v=n.rotation)!==null&&v!==void 0?v:ct.rotation,ct.scale=(B=n.scale)!==null&&B!==void 0?B:ct.scale,ct.opacity=(P=n.opacity)!==null&&P!==void 0?P:ct.opacity,ct.tint=(z=n.tint)!==null&&z!==void 0?z:ct.tint,ct.origin=($=n.origin)!==null&&$!==void 0?$:ct.origin,ct}return at}throw Error(`Invalid sprite coordinates (${e}, ${s})`)}getTiledSprite(e,s,n){if(e>=this.columns||e<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), x: ${e} should be between 0 and ${this.columns-1} columns`);if(s>=this.rows||s<0)throw Error(`No sprite exists in the SpriteSheet at (${e}, ${s}), y: ${s} should be between 0 and ${this.rows-1} rows`);const a=e+s*this.columns,l=this.sprites[a];if(l)return oi.fromSprite(l,n);throw Error(`Invalid sprite coordinates (${e}, ${s})`)}static fromImageSourceWithSourceViews(e){const s=e.sourceViews.map(n=>new Ut({image:e.image,sourceView:n}));return new si({sprites:s})}static fromImageSource(e){var s;const n=[];e.spacing=(s=e.spacing)!==null&&s!==void 0?s:{};const{image:a,grid:{rows:l,columns:g,spriteWidth:p,spriteHeight:v},spacing:{originOffset:B,margin:P}}=e,z={x:0,y:0,...B},$={x:0,y:0,...P};for(let J=0;J<g;J++)for(let at=0;at<l;at++)n[J+at*g]=new Ut({image:a,sourceView:{x:J*p+$.x*J+z.x,y:at*v+$.y*at+z.y,width:p,height:v},destSize:{height:v,width:p}});return new si({sprites:n,rows:l,columns:g})}clone(){return new si({sprites:this.sprites.map(e=>e.clone()),rows:this.rows,columns:this.columns})}}const Ri="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class ai{constructor(){this.fontSheet=Ri,this.size=16,this.load()}load(){return this._imageSource=new Se(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=si.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new Me({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(e,s,n){this._imageSource.isLoaded()&&this._spriteFont.render(e,s,null,n.x,n.y)}}class Rr{constructor(e,s){this._gl=e,this._texture=s}use(){const e=this._gl;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._texture)}disable(){const e=this._gl;e.bindTexture(e.TEXTURE_2D,null)}}class xi{constructor(e){var s,n;this.antialias=!1,this.samples=1,this._gl=e.gl,this.width=e.width,this.height=e.height,this.transparency=e.transparency,this.antialias=(s=e.antialias)!==null&&s!==void 0?s:this.antialias,this.samples=(n=e.samples)!==null&&n!==void 0?n:this._gl.getParameter(this._gl.MAX_SAMPLES);const a=this._gl;a.drawingBufferFormat?this.bufferFormat=a.drawingBufferFormat:this.transparency?this.bufferFormat=a.RGBA8:this.bufferFormat=a.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(e,s){const n=this._gl;this.width=e,this.height=s,n.bindTexture(n.TEXTURE_2D,this._frameTexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.UNSIGNED_BYTE,null),this._renderBuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,this._renderBuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,Math.min(this.samples,n.getParameter(n.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const e=this._gl;this._renderBuffer=e.createRenderbuffer(),this._renderFrameBuffer=e.createFramebuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._renderBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,Math.min(this.samples,e.getParameter(e.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const e=this._gl;this._frameTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._frameTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const s=e.COLOR_ATTACHMENT0;this._frameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,s,e.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new Rr(this._gl,this._frameTexture)}blitToScreen(){const e=this._gl;this._renderBuffer?(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)):(e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const e=this._gl;e.bindFramebuffer(e.READ_FRAMEBUFFER,this.renderFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.frameBuffer),e.clearBufferfv(e.COLOR,0,[0,0,1,1]),e.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,e.COLOR_BUFFER_BIT,e.LINEAR)}}copyToTexture(e){const s=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),s.bindTexture(s.TEXTURE_2D,e),s.copyTexImage2D(s.TEXTURE_2D,0,s.RGBA,0,0,this.width,this.height,0)}use(){const e=this._gl;this.antialias?e.bindFramebuffer(e.FRAMEBUFFER,this._renderFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.viewport(0,0,this.width,this.height)}disable(){const e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}}const ar=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,Pe=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function Es(d,e){switch(e){case d.INT:case d.UNSIGNED_INT:case d.FLOAT:return 4;case d.SHORT:return 2;case d.UNSIGNED_SHORT:return 2;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;default:return 1}}function cs(d,e){const s=`(?<type>[a-z0-9]+)\\s+${e};`,a=new RegExp(s,"g").exec(d);return(a==null?void 0:a.length)>0}function hr(d,e,s){var n;const a=`(?<type>[a-z0-9]+)\\s+${s};`,g=new RegExp(a,"g").exec(e);switch((n=g==null?void 0:g.groups)===null||n===void 0?void 0:n.type){case"float":case"vec2":case"vec3":case"vec4":return d.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return d.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return d.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return d.BOOL;case"short":return d.SHORT;case"ushort":return d.UNSIGNED_SHORT;case"ubyte":return d.UNSIGNED_BYTE;case"byte":return d.BYTE;default:return d.FLOAT}}function _n(d,e){switch(e){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:return 1;case d.FLOAT_VEC2:return 2;case d.FLOAT_VEC3:return 3;case d.FLOAT_VEC4:return 4;case d.BYTE:return 1;case d.UNSIGNED_BYTE:return 1;case d.UNSIGNED_SHORT:case d.SHORT:return 1;default:return 1}}function Os(d,e){switch(e){case d.LOW_FLOAT:case d.HIGH_FLOAT:case d.FLOAT:case d.FLOAT_VEC2:case d.FLOAT_VEC3:case d.FLOAT_VEC4:return d.FLOAT;case d.BYTE:return d.BYTE;case d.UNSIGNED_BYTE:return d.UNSIGNED_BYTE;case d.SHORT:return d.SHORT;case d.UNSIGNED_SHORT:return d.UNSIGNED_SHORT;default:return d.FLOAT}}function Gi(d,e){const s=a=>{const l=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let g="";for(let p=0;p<a;p++)p===0?g+=`if (index <= ${p}.5) {
`:g+=`   else if (index <= ${p}.5) {
`,g+=`      fragColor = vec4(1.0);
`,g+=`   }
`;return l.replace("%%complexity%%",g)};let n=!1;do{const a=s(e),l=d.createShader(d.FRAGMENT_SHADER);d.shaderSource(l,a),d.compileShader(l),n=d.getShaderParameter(l,d.COMPILE_STATUS),n||(e=e/2|0)}while(!n);return e}class Ze{get compiled(){return this._compiled}constructor(e){this._logger=j.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:s,vertexSource:n,fragmentSource:a,onPreLink:l,onPostCompile:g}=e;this._gl=s,this.vertexSource=n,this.fragmentSource=a,this._onPreLink=l,this._onPostCompile=g}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),Ze._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return Ze._ACTIVE_SHADER_INSTANCE===this}compile(){const e=this._gl,s=this._compileShader(e,this.vertexSource,e.VERTEX_SHADER),n=this._compileShader(e,this.fragmentSource,e.FRAGMENT_SHADER);this.program=this._createProgram(e,s,n);const a=this.getAttributes();for(const g of a)this.attributes[g.name]=g;const l=this.getUniforms();for(const g of l)this.uniforms[g.name]=g;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_UNIFORMS),n=[];for(let a=0;a<s;a++){const l=e.getActiveUniform(this.program,a),g=e.getUniformLocation(this.program,l.name);n.push({name:l.name,glType:l.type,location:g})}return n}getAttributes(){const e=this._gl,s=e.getProgramParameter(this.program,e.ACTIVE_ATTRIBUTES),n=[];for(let a=0;a<s;a++){const l=e.getActiveAttrib(this.program,a),g=e.getAttribLocation(this.program,l.name);n.push({name:l.name,glType:Os(e,l.type),size:_n(e,l.type),location:g,normalized:!1})}return n}setTexture(e,s){const n=this._gl;n.activeTexture(n.TEXTURE0+e),n.bindTexture(n.TEXTURE_2D,s)}setUniformInt(e,s){this.setUniform("uniform1i",e,~~s)}trySetUniformInt(e,s){return this.trySetUniform("uniform1i",e,~~s)}setUniformIntArray(e,s){this.setUniform("uniform1iv",e,s)}trySetUniformIntArray(e,s){return this.trySetUniform("uniform1iv",e,s)}setUniformBoolean(e,s){this.setUniform("uniform1i",e,s?1:0)}trySetUniformBoolean(e,s){return this.trySetUniform("uniform1i",e,s?1:0)}setUniformFloat(e,s){this.setUniform("uniform1f",e,s)}trySetUniformFloat(e,s){return this.trySetUniform("uniform1f",e,s)}setUniformFloatArray(e,s){this.setUniform("uniform1fv",e,s)}trySetUniformFloatArray(e,s){return this.trySetUniform("uniform1fv",e,s)}setUniformFloatVector(e,s){this.setUniform("uniform2f",e,s.x,s.y)}trySetUniformFloatVector(e,s){return this.trySetUniform("uniform2f",e,s.x,s.y)}setUniformFloatColor(e,s){this.setUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}trySetUniformFloatColor(e,s){return this.trySetUniform("uniform4f",e,s.r/255,s.g/255,s.b/255,s.a)}setUniformMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,s.data)}setUniformAffineMatrix(e,s){this.setUniform("uniformMatrix4fv",e,!1,[s.data[0],s.data[1],0,0,s.data[2],s.data[3],0,0,0,0,1,0,s.data[4],s.data[5],0,1])}trySetUniformMatrix(e,s){return this.trySetUniform("uniformMatrix4fv",e,!1,s.data)}setUniform(e,s,...n){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${e}:${s}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const l=this._gl.getUniformLocation(this.program,s);if(l){const g=[l,...n];this._gl[e].apply(this._gl,g)}else throw Error(`Uniform ${e}:${s} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(e,s,...n){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${e}:${s}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const l=this._gl.getUniformLocation(this.program,s);if(l){const g=[l,...n];this._gl[e].apply(this._gl,g)}else return!1;return!0}_createProgram(e,s,n){const a=e.createProgram();if(a===null)throw Error("Could not create graphics shader program");if(e.attachShader(a,s),e.attachShader(a,n),this._onPreLink&&this._onPreLink(a),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw Error(`Could not link the program: [${e.getProgramInfoLog(a)}]`);return a}_compileShader(e,s,n){const a=e.VERTEX_SHADER===n?"vertex":"fragment",l=e.createShader(n);if(l===null)throw Error(`Could not build shader: [${s}]`);if(e.shaderSource(l,s),e.compileShader(l),!e.getShaderParameter(l,e.COMPILE_STATUS)){const p=e.getShaderInfoLog(l);throw Error(`Could not compile ${a} shader:

${p}${this._processSourceForError(s,p)}`)}return l}_processSourceForError(e,s){if(!e)return s;const n=e.split(`
`),a=s.search(/\d:\d/),l=s.indexOf(" ",a),[g,p]=s.slice(a,l).split(":").map(v=>Number(v));for(let v=0;v<n.length;v++)n[v]=`${v+1}: ${n[v]}${p===v+1?" <----- ERROR!":""}`;return`

Source:
`+n.join(`
`)}}Ze._ACTIVE_SHADER_INSTANCE=null;class Fi{constructor(e){this.type="dynamic";const{gl:s,size:n,type:a,data:l}=e;if(this._gl=s,this.buffer=this._gl.createBuffer(),!l&&!n)throw Error("Must either provide data or a size to the VertexBuffer");l?this.bufferData=l:this.bufferData=new Float32Array(n),this.type=a??this.type,s.bindBuffer(s.ARRAY_BUFFER,this.buffer),s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,this.buffer)}unbind(){const e=this._gl;e.bindBuffer(e.ARRAY_BUFFER,null)}upload(e){const s=this._gl;s.bindBuffer(s.ARRAY_BUFFER,this.buffer),e?s.bufferSubData(s.ARRAY_BUFFER,0,this.bufferData,0,e):s.bufferData(s.ARRAY_BUFFER,this.bufferData,this.type==="static"?s.STATIC_DRAW:s.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class pi{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(e){this._logger=j.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:s,shader:n,vertexBuffer:a,attributes:l,suppressWarnings:g}=e;this._gl=s,this._vertexBuffer=a,this._attributes=l,this._shader=n,this._suppressWarnings=g,n&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(e){e&&this._shader!==e&&(this._shader=e,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const e=this._shader.attributes;for(const l of this._attributes){const g=e[l[0]];if(!g){if(!cs(this._shader.vertexSource,l[0]))throw Error(`The attribute named: ${l[0]} size ${l[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${l[0]} size ${l[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${l[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${l[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const p=hr(this._gl,this._shader.vertexSource,l[0]);this._layout.push({name:l[0],glType:p,size:l[1],location:-1,normalized:!1})}if(g){if(g.size!==l[1])throw Error(`VertexLayout size definition for attribute: [${l[0]}, ${l[1]}], doesn't match shader source size ${g.size}:
 ${this._shader.vertexSource}`);this._layout.push(g)}}let s=0;for(const l of this._layout){const g=Es(this._gl,l.glType);this._vertexTotalSizeBytes+=g*l.size,s+=l.size}this._vertexBuffer.bufferData.length%s!==0&&this._logger.warn(`The vertex component size (${s})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const n=this._gl;this._vao=n.createVertexArray(),n.bindVertexArray(this._vao),this._vertexBuffer.bind();let a=0;for(const l of this._layout)l.location!==-1&&(l.glType===n.INT?n.vertexAttribIPointer(l.location,l.size,l.glType,this.totalVertexSizeBytes,a):n.vertexAttribPointer(l.location,l.size,l.glType,l.normalized,this.totalVertexSizeBytes,a),n.enableVertexAttribArray(l.location)),a+=Es(n,l.glType)*l.size;n.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(e=!1,s){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const n=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),e&&this._vertexBuffer.upload(s),n.bindVertexArray(this._vao)}}class pe{static clear(){pe.DrawCallCount=0,pe.DrawnImagesCount=0}}pe.DrawCallCount=0,pe.DrawnImagesCount=0;class lr{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=R(0,0),this._endScratch=R(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ze({gl:e,vertexSource:ar,fragmentSource:Pe}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new Fi({gl:e,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new pi({gl:e,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,n){this._isFull()&&this.flush(),this._lineCount++;const a=this._context.getTransform(),l=a.multiply(e,this._startScratch),g=a.multiply(s,this._endScratch),p=this._vertexBuffer.bufferData;p[this._vertexIndex++]=l.x,p[this._vertexIndex++]=l.y,p[this._vertexIndex++]=n.r/255,p[this._vertexIndex++]=n.g/255,p[this._vertexIndex++]=n.b/255,p[this._vertexIndex++]=n.a,p[this._vertexIndex++]=g.x,p[this._vertexIndex++]=g.y,p[this._vertexIndex++]=n.r/255,p[this._vertexIndex++]=n.g/255,p[this._vertexIndex++]=n.b/255,p[this._vertexIndex++]=n.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.LINES,0,this._lineCount*2),pe.DrawnImagesCount+=this._lineCount,pe.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const cr=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,Wo=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class ds{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ze({gl:e,vertexSource:cr,fragmentSource:Wo}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new Fi({gl:e,size:7*this._maxPoints,type:"dynamic"}),this._layout=new pi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(e,s,n){this._isFull()&&this.flush(),this._pointCount++;const a=this._context.getTransform(),l=this._context.opacity,g=this._context.snapToPixel,p=a.multiply(e);g&&(p.x=~~(p.x+oe),p.y=~~(p.y+oe));const v=this._buffer.bufferData;v[this._vertexIndex++]=p.x,v[this._vertexIndex++]=p.y,v[this._vertexIndex++]=s.r/255,v[this._vertexIndex++]=s.g/255,v[this._vertexIndex++]=s.b/255,v[this._vertexIndex++]=s.a*l,v[this._vertexIndex++]=n*Math.max(a.getScaleX(),a.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),e.drawArrays(e.POINTS,0,this._pointCount),pe.DrawnImagesCount+=this._pointCount,pe.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const dr=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,Hs=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class Oi{constructor(e){this._gl=e,this._shader=new Ze({gl:e,vertexSource:dr,fragmentSource:Hs}),this._shader.compile(),this._buffer=new Fi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new pi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(e){const s=this._gl;e.getShader().use(),e.getLayout().use(),s.drawArrays(s.TRIANGLES,0,6)}renderToScreen(){const e=this._gl;this._shader.use(),this._layout.use(),e.drawArrays(e.TRIANGLES,0,6)}}class bi{constructor(e,s,n){this._logger=j.getInstance(),this._gl=e,this.buffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer);const a=s*6;if(!n)this.bufferData=new Uint32Array(a);else{const p=Math.floor(16383.5);this.bufferGlType=e.UNSIGNED_SHORT,this.bufferData=new Uint16Array(a),s>p&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${p}) requested quads(${s})`)}let l=0;for(let g=0;g<a;g+=6)this.bufferData[g+0]=l+0,this.bufferData[g+1]=l+1,this.bufferData[g+2]=l+2,this.bufferData[g+3]=l+2,this.bufferData[g+4]=l+1,this.bufferData[g+5]=l+3,l+=4;e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.bufferData,e.STATIC_DRAW)}bind(){const e=this._gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const us=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,ur=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class gr{constructor(e){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=q.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const n=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=Gi(e,n);this._maxTextures=Math.min(n,a);const l=this._transformFragmentSource(us,this._maxTextures);this._shader=new Ze({gl:e,fragmentSource:l,vertexSource:ur}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((g,p)=>p)),this._buffer=new Fi({gl:e,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new pi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new bi(e,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let n=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_textureIndex <= ${l}.5) {
`:a+=`   else if (v_textureIndex <= ${l}.5) {
`,a+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return n=n.replace("%%texture_picker%%",a),n}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Xt.Filtering),n=s?Nt(s):void 0,a=he(e.getAttribute(Xt.WrappingX)),l=he(e.getAttribute(Xt.WrappingY)),g=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:n,wrapping:{x:a,y:l}},g);e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&(this._textures.push(p),this._textureToIndex.set(p,this._textureIndex++),this._images.add(e))}_bindTextures(e){for(let s=0;s<this._maxTextures;s++)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,this._textures[s]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const n=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(n))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,n,a,l,g,p,v,B){var P,z,$,J;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const at=this._getImageWidth(e),ct=this._getImageHeight(e);let At=at||a||0,lt=ct||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(P=a??at)!==null&&P!==void 0?P:0,this._view[3]=(z=l??ct)!==null&&z!==void 0?z:0,this._dest[0]=s??1,this._dest[1]=n??1,g!==void 0&&p!==void 0&&v!==void 0&&B!==void 0&&(this._view[0]=s??1,this._view[1]=n??1,this._view[2]=($=a??at)!==null&&$!==void 0?$:0,this._view[3]=(J=l??ct)!==null&&J!==void 0?J:0,this._dest[0]=g,this._dest[1]=p,At=v,lt=B),s=this._view[0],n=this._view[1];const gt=this._view[2],Pt=this._view[3],wt=this._context.getTransform(),Qt=this._context.opacity,jt=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+At,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+lt,this._quad[6]=this._dest[0]+At,this._quad[7]=this._dest[1]+lt,wt.multiplyQuadInPlace(this._quad),jt&&(this._quad[0]=~~(this._quad[0]+Q(this._quad[0])*oe),this._quad[1]=~~(this._quad[1]+Q(this._quad[1])*oe),this._quad[2]=~~(this._quad[2]+Q(this._quad[2])*oe),this._quad[3]=~~(this._quad[3]+Q(this._quad[3])*oe),this._quad[4]=~~(this._quad[4]+Q(this._quad[4])*oe),this._quad[5]=~~(this._quad[5]+Q(this._quad[5])*oe),this._quad[6]=~~(this._quad[6]+Q(this._quad[6])*oe),this._quad[7]=~~(this._quad[7]+Q(this._quad[7])*oe));const It=this._context.tint||this._defaultTint,re=this._getTextureIdForImage(e),_e=at||At,ke=ct||lt,Qe=(s+this.uvPadding)/_e,Bi=(n+this.uvPadding)/ke,je=(s+gt-this.uvPadding)/_e,Fe=(n+Pt-this.uvPadding)/ke,Ti=at,mi=ct,Wt=this._layout.vertexBuffer.bufferData;Wt[this._vertexIndex++]=this._quad[0],Wt[this._vertexIndex++]=this._quad[1],Wt[this._vertexIndex++]=Qt,Wt[this._vertexIndex++]=Ti,Wt[this._vertexIndex++]=mi,Wt[this._vertexIndex++]=Qe,Wt[this._vertexIndex++]=Bi,Wt[this._vertexIndex++]=re,Wt[this._vertexIndex++]=It.r/255,Wt[this._vertexIndex++]=It.g/255,Wt[this._vertexIndex++]=It.b/255,Wt[this._vertexIndex++]=It.a,Wt[this._vertexIndex++]=this._quad[4],Wt[this._vertexIndex++]=this._quad[5],Wt[this._vertexIndex++]=Qt,Wt[this._vertexIndex++]=Ti,Wt[this._vertexIndex++]=mi,Wt[this._vertexIndex++]=Qe,Wt[this._vertexIndex++]=Fe,Wt[this._vertexIndex++]=re,Wt[this._vertexIndex++]=It.r/255,Wt[this._vertexIndex++]=It.g/255,Wt[this._vertexIndex++]=It.b/255,Wt[this._vertexIndex++]=It.a,Wt[this._vertexIndex++]=this._quad[2],Wt[this._vertexIndex++]=this._quad[3],Wt[this._vertexIndex++]=Qt,Wt[this._vertexIndex++]=Ti,Wt[this._vertexIndex++]=mi,Wt[this._vertexIndex++]=je,Wt[this._vertexIndex++]=Bi,Wt[this._vertexIndex++]=re,Wt[this._vertexIndex++]=It.r/255,Wt[this._vertexIndex++]=It.g/255,Wt[this._vertexIndex++]=It.b/255,Wt[this._vertexIndex++]=It.a,Wt[this._vertexIndex++]=this._quad[6],Wt[this._vertexIndex++]=this._quad[7],Wt[this._vertexIndex++]=Qt,Wt[this._vertexIndex++]=Ti,Wt[this._vertexIndex++]=mi,Wt[this._vertexIndex++]=je,Wt[this._vertexIndex++]=Fe,Wt[this._vertexIndex++]=re,Wt[this._vertexIndex++]=It.r/255,Wt[this._vertexIndex++]=It.g/255,Wt[this._vertexIndex++]=It.b/255,Wt[this._vertexIndex++]=It.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),this._quads.bind(),e.drawElements(e.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),pe.DrawnImagesCount+=this._imageCount,pe.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const Fr=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,qo=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class pn{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=q.Transparent,this._scratch1=R(0,0),this._scratch2=R(0,0),this._scratch3=R(0,0),this._scratch4=R(0,0)}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ze({gl:e,fragmentSource:Fr,vertexSource:qo}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Fi({gl:e,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new pi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new bi(e,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...e){e[0]instanceof I&&e[1]instanceof I?this.drawLine.apply(this,e):this.drawRectangle.apply(this,e)}drawLine(e,s,n,a=1){this._isFull()&&this.flush(),this._rectangleCount++;const l=this._context.getTransform(),g=this._context.opacity,p=this._context.snapToPixel,v=s.sub(e),B=v.magnitude,P=v.normalize().perpendicular(),z=a/2,$=l.multiply(P.scale(z,this._scratch1).add(e,this._scratch1),this._scratch1),J=l.multiply(P.scale(-z,this._scratch2).add(e,this._scratch2),this._scratch2),at=l.multiply(P.scale(z,this._scratch3).add(s,this._scratch3),this._scratch3),ct=l.multiply(P.scale(-z,this._scratch4).add(s,this._scratch4),this._scratch4);p&&($.x=~~($.x+oe),$.y=~~($.y+oe),at.x=~~(at.x+oe),at.y=~~(at.y+oe),J.x=~~(J.x+oe),J.y=~~(J.y+oe),ct.x=~~(ct.x+oe),ct.y=~~(ct.y+oe));const At=0,lt=0,gt=1,Pt=1,wt=this._transparent,Qt=0,jt=1,It=this._layout.vertexBuffer.bufferData;It[this._vertexIndex++]=$.x,It[this._vertexIndex++]=$.y,It[this._vertexIndex++]=At,It[this._vertexIndex++]=lt,It[this._vertexIndex++]=B,It[this._vertexIndex++]=a,It[this._vertexIndex++]=g,It[this._vertexIndex++]=n.r/255,It[this._vertexIndex++]=n.g/255,It[this._vertexIndex++]=n.b/255,It[this._vertexIndex++]=n.a,It[this._vertexIndex++]=wt.r/255,It[this._vertexIndex++]=wt.g/255,It[this._vertexIndex++]=wt.b/255,It[this._vertexIndex++]=wt.a,It[this._vertexIndex++]=Qt/jt,It[this._vertexIndex++]=J.x,It[this._vertexIndex++]=J.y,It[this._vertexIndex++]=At,It[this._vertexIndex++]=Pt,It[this._vertexIndex++]=B,It[this._vertexIndex++]=a,It[this._vertexIndex++]=g,It[this._vertexIndex++]=n.r/255,It[this._vertexIndex++]=n.g/255,It[this._vertexIndex++]=n.b/255,It[this._vertexIndex++]=n.a,It[this._vertexIndex++]=wt.r/255,It[this._vertexIndex++]=wt.g/255,It[this._vertexIndex++]=wt.b/255,It[this._vertexIndex++]=wt.a,It[this._vertexIndex++]=Qt/jt,It[this._vertexIndex++]=at.x,It[this._vertexIndex++]=at.y,It[this._vertexIndex++]=gt,It[this._vertexIndex++]=lt,It[this._vertexIndex++]=B,It[this._vertexIndex++]=a,It[this._vertexIndex++]=g,It[this._vertexIndex++]=n.r/255,It[this._vertexIndex++]=n.g/255,It[this._vertexIndex++]=n.b/255,It[this._vertexIndex++]=n.a,It[this._vertexIndex++]=wt.r/255,It[this._vertexIndex++]=wt.g/255,It[this._vertexIndex++]=wt.b/255,It[this._vertexIndex++]=wt.a,It[this._vertexIndex++]=Qt/jt,It[this._vertexIndex++]=ct.x,It[this._vertexIndex++]=ct.y,It[this._vertexIndex++]=gt,It[this._vertexIndex++]=Pt,It[this._vertexIndex++]=B,It[this._vertexIndex++]=a,It[this._vertexIndex++]=g,It[this._vertexIndex++]=n.r/255,It[this._vertexIndex++]=n.g/255,It[this._vertexIndex++]=n.b/255,It[this._vertexIndex++]=n.a,It[this._vertexIndex++]=wt.r/255,It[this._vertexIndex++]=wt.g/255,It[this._vertexIndex++]=wt.b/255,It[this._vertexIndex++]=wt.a,It[this._vertexIndex++]=Qt/jt}drawRectangle(e,s,n,a,l=q.Transparent,g=0){this._isFull()&&this.flush(),this._rectangleCount++;const p=this._context.getTransform(),v=this._context.opacity,B=this._context.snapToPixel,P=p.multiply(e.add(R(0,0))),z=p.multiply(e.add(R(s,0))),$=p.multiply(e.add(R(s,n))),J=p.multiply(e.add(R(0,n)));B&&(P.x=~~(P.x+oe),P.y=~~(P.y+oe),z.x=~~(z.x+oe),z.y=~~(z.y+oe),J.x=~~(J.x+oe),J.y=~~(J.y+oe),$.x=~~($.x+oe),$.y=~~($.y+oe));const at=0,ct=0,At=1,lt=1,gt=this._layout.vertexBuffer.bufferData;gt[this._vertexIndex++]=P.x,gt[this._vertexIndex++]=P.y,gt[this._vertexIndex++]=at,gt[this._vertexIndex++]=ct,gt[this._vertexIndex++]=s,gt[this._vertexIndex++]=n,gt[this._vertexIndex++]=v,gt[this._vertexIndex++]=a.r/255,gt[this._vertexIndex++]=a.g/255,gt[this._vertexIndex++]=a.b/255,gt[this._vertexIndex++]=a.a,gt[this._vertexIndex++]=l.r/255,gt[this._vertexIndex++]=l.g/255,gt[this._vertexIndex++]=l.b/255,gt[this._vertexIndex++]=l.a,gt[this._vertexIndex++]=g,gt[this._vertexIndex++]=J.x,gt[this._vertexIndex++]=J.y,gt[this._vertexIndex++]=at,gt[this._vertexIndex++]=lt,gt[this._vertexIndex++]=s,gt[this._vertexIndex++]=n,gt[this._vertexIndex++]=v,gt[this._vertexIndex++]=a.r/255,gt[this._vertexIndex++]=a.g/255,gt[this._vertexIndex++]=a.b/255,gt[this._vertexIndex++]=a.a,gt[this._vertexIndex++]=l.r/255,gt[this._vertexIndex++]=l.g/255,gt[this._vertexIndex++]=l.b/255,gt[this._vertexIndex++]=l.a,gt[this._vertexIndex++]=g,gt[this._vertexIndex++]=z.x,gt[this._vertexIndex++]=z.y,gt[this._vertexIndex++]=At,gt[this._vertexIndex++]=ct,gt[this._vertexIndex++]=s,gt[this._vertexIndex++]=n,gt[this._vertexIndex++]=v,gt[this._vertexIndex++]=a.r/255,gt[this._vertexIndex++]=a.g/255,gt[this._vertexIndex++]=a.b/255,gt[this._vertexIndex++]=a.a,gt[this._vertexIndex++]=l.r/255,gt[this._vertexIndex++]=l.g/255,gt[this._vertexIndex++]=l.b/255,gt[this._vertexIndex++]=l.a,gt[this._vertexIndex++]=g,gt[this._vertexIndex++]=$.x,gt[this._vertexIndex++]=$.y,gt[this._vertexIndex++]=At,gt[this._vertexIndex++]=lt,gt[this._vertexIndex++]=s,gt[this._vertexIndex++]=n,gt[this._vertexIndex++]=v,gt[this._vertexIndex++]=a.r/255,gt[this._vertexIndex++]=a.g/255,gt[this._vertexIndex++]=a.b/255,gt[this._vertexIndex++]=a.a,gt[this._vertexIndex++]=l.r/255,gt[this._vertexIndex++]=l.g/255,gt[this._vertexIndex++]=l.b/255,gt[this._vertexIndex++]=l.a,gt[this._vertexIndex++]=g}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),pe.DrawnImagesCount+=this._rectangleCount,pe.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const fr=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,_r=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class Zn{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ze({gl:e,fragmentSource:fr,vertexSource:_r}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._buffer=new Fi({gl:e,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new pi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new bi(e,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(e,s,n,a=q.Transparent,l=0){this._isFull()&&this.flush(),this._circleCount++;const g=this._context.getTransform(),p=this._context.opacity,v=this._context.snapToPixel,B=g.multiply(e.add(R(-s,-s))),P=g.multiply(e.add(R(s,-s))),z=g.multiply(e.add(R(s,s))),$=g.multiply(e.add(R(-s,s)));v&&(B.x=~~(B.x+oe),B.y=~~(B.y+oe),P.x=~~(P.x+oe),P.y=~~(P.y+oe),$.x=~~($.x+oe),$.y=~~($.y+oe),z.x=~~(z.x+oe),z.y=~~(z.y+oe));const J=0,at=0,ct=1,At=1,lt=this._layout.vertexBuffer.bufferData;lt[this._vertexIndex++]=B.x,lt[this._vertexIndex++]=B.y,lt[this._vertexIndex++]=J,lt[this._vertexIndex++]=at,lt[this._vertexIndex++]=p,lt[this._vertexIndex++]=n.r/255,lt[this._vertexIndex++]=n.g/255,lt[this._vertexIndex++]=n.b/255,lt[this._vertexIndex++]=n.a,lt[this._vertexIndex++]=a.r/255,lt[this._vertexIndex++]=a.g/255,lt[this._vertexIndex++]=a.b/255,lt[this._vertexIndex++]=a.a,lt[this._vertexIndex++]=l/s,lt[this._vertexIndex++]=$.x,lt[this._vertexIndex++]=$.y,lt[this._vertexIndex++]=J,lt[this._vertexIndex++]=At,lt[this._vertexIndex++]=p,lt[this._vertexIndex++]=n.r/255,lt[this._vertexIndex++]=n.g/255,lt[this._vertexIndex++]=n.b/255,lt[this._vertexIndex++]=n.a,lt[this._vertexIndex++]=a.r/255,lt[this._vertexIndex++]=a.g/255,lt[this._vertexIndex++]=a.b/255,lt[this._vertexIndex++]=a.a,lt[this._vertexIndex++]=l/s,lt[this._vertexIndex++]=P.x,lt[this._vertexIndex++]=P.y,lt[this._vertexIndex++]=ct,lt[this._vertexIndex++]=at,lt[this._vertexIndex++]=p,lt[this._vertexIndex++]=n.r/255,lt[this._vertexIndex++]=n.g/255,lt[this._vertexIndex++]=n.b/255,lt[this._vertexIndex++]=n.a,lt[this._vertexIndex++]=a.r/255,lt[this._vertexIndex++]=a.g/255,lt[this._vertexIndex++]=a.b/255,lt[this._vertexIndex++]=a.a,lt[this._vertexIndex++]=l/s,lt[this._vertexIndex++]=z.x,lt[this._vertexIndex++]=z.y,lt[this._vertexIndex++]=ct,lt[this._vertexIndex++]=At,lt[this._vertexIndex++]=p,lt[this._vertexIndex++]=n.r/255,lt[this._vertexIndex++]=n.g/255,lt[this._vertexIndex++]=n.b/255,lt[this._vertexIndex++]=n.a,lt[this._vertexIndex++]=a.r/255,lt[this._vertexIndex++]=a.g/255,lt[this._vertexIndex++]=a.b/255,lt[this._vertexIndex++]=a.a,lt[this._vertexIndex++]=l/s}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const e=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),e.drawElements(e.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),pe.DrawnImagesCount+=this._circleCount,pe.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class Mr{constructor(e,s,n=100){this.builder=e,this.recycler=s,this.maxObjects=n,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=j.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let e=0;e<this.maxObjects;e++)this.objects[e]=this.builder()}using(e){const s=e(this);return s?this.done(...s):this.done()}borrow(e){const s=this.get();e(s),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...e){this.index=0;for(const s of e){const n=this.objects.indexOf(s);this.objects[n]=this.builder(),this.totalAllocations++}return e}}class te{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=st.identity(),this.state={z:0,opacity:1,tint:q.White,material:null},this.args=new Array(10)}}const Vo=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class An{constructor(e){this._logger=j.getInstance(),this._color=q.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:s,name:n,vertexSource:a,fragmentSource:l,graphicsContext:g,images:p}=e;if(this._name=n??"anonymous material",this._vertexSource=a??Vo,this._fragmentSource=l,this._color=s??this._color,!g)throw Error(`Material ${n} must be provided an excalibur webgl graphics context`);if(g instanceof Vs?(this._graphicsContext=g,this._initialize(g)):this._logger.warn(`Material ${n} was created in 2D Canvas mode, currently only WebGL is supported`),p)for(const v in p)this.addImageSource(v,p[v])}_initialize(e){if(this._initialized)return;const s=e.__gl;this._maxTextureSlots=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=e.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(e){this._color=e}get name(){var e;return(e=this._name)!==null&&e!==void 0?e:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(e){this._shader&&(this._shader.use(),e(this._shader))}getShader(){return this._shader}addImageSource(e,s){this._images.size<this._maxTextureSlots?this._images.set(e,s):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(e){const s=this._images.get(e);this._graphicsContext.textureLoader.delete(s.image),this._images.delete(e)}_loadImageSource(e){const s=e.image,n=s.getAttribute(Xt.Filtering),a=n?Nt(n):void 0,l=he(s.getAttribute(Xt.WrappingX)),g=he(s.getAttribute(Xt.WrappingY)),p=s.getAttribute("forceUpload")==="true",v=this._graphicsContext.textureLoader.load(s,{filtering:a,wrapping:{x:l,y:g}},p);return s.removeAttribute("forceUpload"),this._textures.has(e)||this._textures.set(e,v),v}uploadAndBind(e,s=2){let n=s;for(const[a,l]of this._images.entries()){if(!l.isLoaded()){this._logger.warnOnce(`Image named ${a} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const g=this._loadImageSource(l);e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_2D,g),this._shader.trySetUniformInt(a,n),n++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class mn{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(e,s){this._gl=e,this._context=s,this._buffer=new Fi({gl:e,size:6*4,type:"dynamic"}),this._layout=new pi({gl:e,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new bi(e,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(e,s,n,a,l,g,p,v,B){var P,z,$,J;const at=this._gl,ct=this._context.material;if(!ct)return;const At=this._context.getTransform(),lt=this._context.opacity,gt=ct.getShader(),Pt=this._layout.vertexBuffer.bufferData;let wt=0,Qt=(e==null?void 0:e.width)||a||0,jt=(e==null?void 0:e.height)||l||0,It=[0,0,(P=a??(e==null?void 0:e.width))!==null&&P!==void 0?P:0,(z=l??(e==null?void 0:e.height))!==null&&z!==void 0?z:0],re=[s??1,n??1];g!==void 0&&p!==void 0&&v!==void 0&&B!==void 0&&(It=[s??1,n??1,($=a??(e==null?void 0:e.width))!==null&&$!==void 0?$:0,(J=l??(e==null?void 0:e.height))!==null&&J!==void 0?J:0],re=[g,p],Qt=v,jt=B),s=It[0],n=It[1];const _e=It[2],ke=It[3],Qe=R(re[0],re[1]),Bi=R(re[0]+Qt,re[1]),je=R(re[0],re[1]+jt),Fe=R(re[0]+Qt,re[1]+jt),Ti=e.width||Qt,mi=e.height||jt,Wt=s/Ti,Jr=n/mi,Kr=(s+_e-.01)/Ti,tn=(n+ke-.01)/mi,Fn=At.getPosition(),du=Fn.add(Fe),uu=Fn.x/this._context.width,gu=Fn.y/this._context.height,fu=du.x/this._context.width,_u=du.y/this._context.height;Pt[wt++]=Qe.x,Pt[wt++]=Qe.y,Pt[wt++]=Wt,Pt[wt++]=Jr,Pt[wt++]=uu,Pt[wt++]=gu,Pt[wt++]=je.x,Pt[wt++]=je.y,Pt[wt++]=Wt,Pt[wt++]=tn,Pt[wt++]=uu,Pt[wt++]=_u,Pt[wt++]=Bi.x,Pt[wt++]=Bi.y,Pt[wt++]=Kr,Pt[wt++]=Jr,Pt[wt++]=fu,Pt[wt++]=gu,Pt[wt++]=Fe.x,Pt[wt++]=Fe.y,Pt[wt++]=Kr,Pt[wt++]=tn,Pt[wt++]=fu,Pt[wt++]=_u;const D_=this._addImageAsTexture(e);ct.use(),this._layout.shader=gt,this._layout.use(!0),gt.trySetUniformFloat("u_time_ms",performance.now()),gt.trySetUniformFloat("u_opacity",lt),gt.trySetUniformFloatVector("u_resolution",R(this._context.width,this._context.height)),gt.trySetUniformFloatVector("u_graphic_resolution",R(Ti,mi)),gt.trySetUniformFloatVector("u_size",R(_e,ke)),gt.trySetUniformMatrix("u_matrix",this._context.ortho),gt.trySetUniformMatrix("u_transform",At.to4x4()),at.activeTexture(at.TEXTURE0+0),at.bindTexture(at.TEXTURE_2D,D_),gt.trySetUniformInt("u_graphic",0),at.activeTexture(at.TEXTURE0+1),at.bindTexture(at.TEXTURE_2D,this._context.materialScreenTexture),gt.trySetUniformInt("u_screen_texture",1),ct.uploadAndBind(at),this._quads.bind(),at.drawElements(at.TRIANGLES,6,this._quads.bufferGlType,0),pe.DrawnImagesCount++,pe.DrawCallCount++}_addImageAsTexture(e){const s=e.getAttribute(Xt.Filtering),n=s?Nt(s):void 0,a=he(e.getAttribute(Xt.WrappingX)),l=he(e.getAttribute(Xt.WrappingY)),g=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:n,wrapping:{x:a,y:l}},g);return e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&this._textures.push(p),p}hasPendingDraws(){return!1}flush(){}}const jo=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,Yo=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var We;(function(d){d.World="world",d.Screen="screen"})(We||(We={}));class vn extends I{constructor(e){super(0,0),this._getX=e.getX,this._getY=e.getY,this._setX=e.setX,this._setY=e.setY}get x(){return this._x=this._getX()}set x(e){this._setX(e),this._x=e}get y(){return this._y=this._getY()}set y(e){this._setY(e),this._y=e}}class gs extends I{constructor(e,s){super(e.x,e.y),this.original=e,this.change=s}get x(){return this._x=this.original.x}set x(e){e!==this._x&&(this.change(e,this._y),this._x=this.original.x=e)}get y(){return this._y=this.original.y}set y(e){e!==this._y&&(this.change(this._x,e),this._y=this.original.y=e)}setTo(e,s){this.x=e,this.y=s}}class as{constructor(){this._parent=null,this._children=[],this._pos=new gs(R(0,0),()=>{this.flagDirty()}),this._globalPos=new vn({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:e=>{if(this.parent){const{x:s}=this.parent.inverse.multiply(R(e,this.pos.y));this.pos.x=s}else this.pos.x=e;e!==this.matrix.data[4]&&this.flagDirty()},setY:e=>{if(this.parent){const{y:s}=this.parent.inverse.multiply(R(this.pos.x,e));this.pos.y=s}else this.pos.y=e;e!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new gs(R(1,1),()=>{this.flagDirty()}),this._globalScale=new vn({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:e=>{if(this.parent){const s=this.parent.globalScale.x;this.scale.x=e/s}else this.scale.x=e},setY:e=>{if(this.parent){const s=this.parent.globalScale.y;this.scale.y=e/s}else this.scale.y=e}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=st.identity(),this._inverse=st.identity(),this._scratch=st.identity()}get parent(){return this._parent}set parent(e){if(this._parent){const s=this._parent._children.indexOf(this);s>-1&&this._parent._children.splice(s,1)}this._parent=e,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(e){this._pos.x=e.x,this._pos.y=e.y}get pos(){return this._pos}set globalPos(e){let s=e.clone();this.parent&&(s=this.parent.inverse.multiply(e)),s.equals(this._pos)||(this._pos=s,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(e){const s=Y(e);s!==this._rotation&&this.flagDirty(),this._rotation=s}get rotation(){return this._rotation}set globalRotation(e){let s=0;this.parent&&(s=this.parent.globalRotation);const n=Y(e+s);n!==this._rotation&&this.flagDirty(),this._rotation=n}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(e){this._scale.x=e.x,this._scale.y=e.y}get scale(){return this._scale}set globalScale(e){let s=R(1,1);this.parent&&(s=this.parent.globalScale),this.scale=e.scale(R(1/s.x,1/s.y))}get globalScale(){return this._globalScale}set z(e){this._z=e,this.flagDirty()}get z(){return this._z}set globalZ(e){this.parent?this.z=e-this.parent.globalZ:this.z=e}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let e=0;e<this._children.length;e++)this._children[e].flagDirty()}apply(e){return this.matrix.multiply(e)}applyInverse(e){return this.inverse.multiply(e)}setTransform(e,s,n){this._pos.x=e.x,this._pos.y=e.y,this._rotation=Y(s),this._scale.x=n.x,this._scale.y=n.y,this.flagDirty()}isMirrored(){const e=Q(this.scale.x)>>>31,s=Q(this.scale.y)>>>31;return!!(e^s)}clone(e){const s=e??new as;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.flagDirty(),s}cloneWithParent(e){const s=e??new as;return this._pos.clone(s._pos),s._z=this._z,s._rotation=this._rotation,this._scale.clone(s._scale),s.parent=this.parent,s.flagDirty(),s}toString(){return this.matrix.toString()}}function $n(d){return!!d&&!!d.prototype&&!!d.prototype.constructor}function Xo(d){return!!(d!=null&&d.clone)}class Hi{constructor(){this.owner=void 0}clone(){const e=new this.constructor;for(const s in this)if(this.hasOwnProperty(s)){const n=this[s];Xo(n)&&s!=="owner"&&s!=="clone"?e[s]=n.clone():e[s]=n}return e}}class hi{constructor(){this.observers=[],this.subscriptions=[]}register(e){this.observers.push(e)}subscribe(e){this.subscriptions.push(e)}unregister(e){const s=this.observers.indexOf(e);s!==-1&&this.observers.splice(s,1)}unsubscribe(e){const s=this.subscriptions.indexOf(e);s!==-1&&this.subscriptions.splice(s,1)}notifyAll(e){const s=this.observers.length;for(let a=0;a<s;a++)this.observers[a].notify(e);const n=this.subscriptions.length;for(let a=0;a<n;a++)this.subscriptions[a](e)}clear(){this.observers.length=0,this.subscriptions.length=0}}class Ot extends Hi{constructor(){super(...arguments),this._logger=j.getInstance(),this._parentComponent=null,this._transform=new as,this._addChildTransform=e=>{const s=e.get(Ot);s&&(s._transform.parent=this._transform,s._parentComponent=this)},this.zIndexChanged$=new hi,this._coordPlane=We.World}get(){return this._transform}onAdd(e){for(const s of e.children)this._addChildTransform(s);e.childrenAdded$.subscribe(s=>this._addChildTransform(s)),e.childrenRemoved$.subscribe(s=>{const n=s.get(Ot);n&&(n._transform.parent=null,n._parentComponent=null)})}onRemove(e){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(e){const s=this._transform.z;this._transform.z=e,s!==e&&this.zIndexChanged$.notifyAll(e)}get globalZ(){return this._transform.globalZ}set globalZ(e){this._transform.globalZ=e}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(e){var s;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(s=this.owner)===null||s===void 0?void 0:s.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=e}get pos(){return this._transform.pos}set pos(e){this._transform.pos=e}get globalPos(){return this._transform.globalPos}set globalPos(e){this._transform.globalPos=e}get rotation(){return this._transform.rotation}set rotation(e){this._transform.rotation=e}get globalRotation(){return this._transform.globalRotation}set globalRotation(e){this._transform.globalRotation=e}get scale(){return this._transform.scale}set scale(e){this._transform.scale=e}get globalScale(){return this._transform.globalScale}set globalScale(e){this._transform.globalScale=e}applyInverse(e){return this._transform.applyInverse(e)}apply(e){return this._transform.apply(e)}clone(){const e=new Ot;return e._transform=this._transform.clone(),e}}var pr;(function(d){d.Forward="forward",d.Backward="backward"})(pr||(pr={}));var Xi;(function(d){d.End="end",d.Loop="loop",d.PingPong="pingpong",d.Freeze="freeze"})(Xi||(Xi={}));const Zo={Frame:"frame",Loop:"loop",End:"end"};class Zi extends vt{constructor(e){var s,n,a;super(e),this.events=new S,this.frames=[],this.strategy=Xi.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=e.frames,this.speed=(s=e.speed)!==null&&s!==void 0?s:this.speed,this.strategy=(n=e.strategy)!==null&&n!==void 0?n:this.strategy,this.frameDuration=e.totalDuration?e.totalDuration/this.frames.length:(a=e.frameDuration)!==null&&a!==void 0?a:this.frameDuration,e.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Zi({frames:this.frames.map(e=>({...e})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.width*this.scale.x):0}get height(){const e=this.currentFrame;return e&&e.graphic?Math.abs(e.graphic.height*this.scale.y):0}static fromSpriteSheet(e,s,n,a=Xi.Loop){const l=e.sprites.length-1,g=s.filter(p=>p<0||p>l);return g.length&&Zi._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${g.join(",")} no frame will be shown`),new Zi({frames:e.sprites.filter((p,v)=>s.indexOf(v)>-1).map(p=>({graphic:p,duration:n})),strategy:a})}static fromSpriteSheetCoordinates(e){var s;const{spriteSheet:n,frameCoordinates:a,durationPerFrame:l,durationPerFrameMs:g,speed:p,strategy:v,reverse:B}=e,P=(s=l??g)!==null&&s!==void 0?s:100,z=[];for(const $ of a){const{x:J,y:at,duration:ct,options:At}=$,lt=n.getSprite(J,at,At);lt?z.push({graphic:lt,duration:ct??P}):Zi._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${J}, ${at}), please check your SpriteSheet to confirm that sprite exists`)}return new Zi({frames:z,strategy:v,speed:p,reverse:B})}get speed(){return this._speed}set speed(e){this._speed=L(Math.abs(e),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?pr.Backward:pr.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const e=this.frames[this._currentFrame];e&&(this._timeLeftInFrame=(e==null?void 0:e.duration)||this.frameDuration)}get canFinish(){switch(this.strategy){case Xi.End:case Xi.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(e,s){this._currentFrame=e,this._timeLeftInFrame=s??this.frameDuration;const n=this.frames[this._currentFrame];n&&!this._done&&(this._timeLeftInFrame=s??((n==null?void 0:n.duration)||this.frameDuration),this.events.emit("frame",{...n,frameIndex:this.currentFrameIndex}))}_nextFrame(){const e=this._currentFrame;if(this._done)return e;let s=-1;switch(this.strategy){case Xi.Loop:{s=(e+1)%this.frames.length,s===0&&this.events.emit("loop",this);break}case Xi.End:{s=e+1,s>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case Xi.Freeze:{s=L(e+1,0,this.frames.length-1),s>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case Xi.PingPong:{e+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),e+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),s=e+this._pingPongDirection%this.frames.length;break}}return s}tick(e,s=0){this._idempotencyToken!==s&&(this._idempotencyToken=s,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=e*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(e,s,n){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(e,s,n)}}Zi._LOGGER=j.getInstance();class Ws extends vt{constructor(e){var s;super(e),this._logger=j.getInstance(),this.useAnchor=!0,this.members=[],this.members=e.members,this.useAnchor=(s=e.useAnchor)!==null&&s!==void 0?s:this.useAnchor,this._updateDimensions()}clone(){return new Ws({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const e=this.localBounds;return this.width=e.width,this.height=e.height,e}get localBounds(){const e=new ht;for(const s of this.members)if(s instanceof vt)s.localBounds.combine(e,e);else{const{graphic:n,offset:a,useBounds:l}=s;n?(l===void 0?!0:l)&&n.localBounds.translate(a).combine(e,e):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(s)}.`)}return e}_isAnimationOrGroup(e){return e instanceof Zi||e instanceof Ws}tick(e,s){for(const n of this.members){let a;n instanceof vt?a=n:a=n.graphic,this._isAnimationOrGroup(a)&&a.tick(e,s)}}reset(){for(const e of this.members){let s;e instanceof vt?s=e:s=e.graphic,this._isAnimationOrGroup(s)&&s.reset()}}_preDraw(e,s,n){this._updateDimensions(),super._preDraw(e,this.useAnchor?s:0,this.useAnchor?n:0)}_drawImage(e,s,n){const a=I.Zero;for(const l of this.members){let g;l instanceof vt?g=l:(g=l.graphic,l.offset.clone(a)),g&&(e.save(),e.translate(s,n),g.draw(e,a.x,a.y),this.showDebug&&e.debug.drawRect(0,0,this.width,this.height),e.restore())}}}class qs extends vt{constructor(e){var s,n,a,l,g,p,v,B,P,z;super(Kt({...e},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=mt(q.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,e&&(this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this.color=(n=e.color)!==null&&n!==void 0?n:q.Black,this.strokeColor=e==null?void 0:e.strokeColor,this.smoothing=(a=e.smoothing)!==null&&a!==void 0?a:this.smoothing,this.lineWidth=(l=e.lineWidth)!==null&&l!==void 0?l:this.lineWidth,this.lineDash=(g=e.lineDash)!==null&&g!==void 0?g:this.lineDash,this.lineCap=(p=e.lineCap)!==null&&p!==void 0?p:this.lineCap,this.padding=(v=e.padding)!==null&&v!==void 0?v:this.padding,this.filtering=(B=e.filtering)!==null&&B!==void 0?B:this.filtering),this._bitmap=document.createElement("canvas");const $=(P=e==null?void 0:e.width)!==null&&P!==void 0?P:this._bitmap.width,J=(z=e==null?void 0:e.height)!==null&&z!==void 0?z:this._bitmap.height;this.width=$,this.height=J;const at=this._bitmap.getContext("2d");if(at)this._ctx=at;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(e){e/=Math.abs(this.scale.x),this._bitmap.width=e,this._originalWidth=e,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(e){e/=Math.abs(this.scale.y),this._bitmap.height=e,this._originalHeight=e,this.flagDirty()}_getTotalWidth(){var e;return(((e=this._originalWidth)!==null&&e!==void 0?e:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var e;return(((e=this._originalHeight)!==null&&e!==void 0?e:this._bitmap.height)+this.padding*2)*1}get localBounds(){return ht.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,I.Zero)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,this.flagDirty()}get color(){return this._color}set color(e){this.flagDirty(),this._color=mt(e,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(e){this.flagDirty(),e&&(this._strokeColor=mt(e,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(e){this._lineDash=e,this.flagDirty()}get padding(){return this._padding}set padding(e){this._padding=e,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(e){var s,n,a,l;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),e.scale(this.quality,this.quality),e.translate(this.padding,this.padding),e.imageSmoothingEnabled=this.smoothing,e.lineWidth=this.lineWidth,e.setLineDash((s=this.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.lineCap=this.lineCap,e.strokeStyle=(a=(n=this.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&a!==void 0?a:"",e.fillStyle=(l=this.color)===null||l===void 0?void 0:l.toString()}_drawImage(e,s,n){this._dirty&&this.rasterize(),e.scale(1/this.quality,1/this.quality),e.drawImage(this._bitmap,s,n)}}var kr;(function(d){d.Em="em",d.Rem="rem",d.Px="px",d.Pt="pt",d.Percent="%"})(kr||(kr={}));var Qr;(function(d){d.Left="left",d.Right="right",d.Center="center",d.Start="start",d.End="end"})(Qr||(Qr={}));var Lr;(function(d){d.Top="top",d.Hanging="hanging",d.Middle="middle",d.Alphabetic="alphabetic",d.Ideographic="ideographic",d.Bottom="bottom"})(Lr||(Lr={}));var zr;(function(d){d.Normal="normal",d.Italic="italic",d.Oblique="oblique"})(zr||(zr={}));var Ur;(function(d){d.LeftToRight="ltr",d.RightToLeft="rtl"})(Ur||(Ur={}));function wn(d,e=q.Red,s,n,a,l,g=1,p="butt"){d.save(),d.beginPath(),d.lineWidth=g,d.lineCap=p,d.strokeStyle=e.toString(),d.moveTo(s,n),d.lineTo(a,l),d.closePath(),d.stroke(),d.restore()}function $o(d,e=q.Red,s){d.beginPath(),d.strokeStyle=e.toString(),d.arc(s.x,s.y,5,0,Math.PI*2),d.closePath(),d.stroke()}function Jo(d,e,s,n,a=1){const l=e?e.toString():"blue",g=n.scale(a);d.beginPath(),d.strokeStyle=l,d.moveTo(s.x,s.y),d.lineTo(s.x+g.x,s.y+g.y),d.closePath(),d.stroke()}function yn(d,e,s,n,a,l=5,g=q.White,p=null){let v;if(typeof l=="number")v={tl:l,tr:l,br:l,bl:l};else{const B={tl:0,tr:0,br:0,bl:0};for(const P in B)if(B.hasOwnProperty(P)){const z=P;v[z]=l[z]||B[z]}}d.beginPath(),d.moveTo(e+v.tl,s),d.lineTo(e+n-v.tr,s),d.quadraticCurveTo(e+n,s,e+n,s+v.tr),d.lineTo(e+n,s+a-v.br),d.quadraticCurveTo(e+n,s+a,e+n-v.br,s+a),d.lineTo(e+v.bl,s+a),d.quadraticCurveTo(e,s+a,e,s+a-v.bl),d.lineTo(e,s+v.tl),d.quadraticCurveTo(e,s,e+v.tl,s),d.closePath(),p&&(d.fillStyle=p.toString(),d.fill()),g&&(d.strokeStyle=g.toString(),d.stroke())}function Ko(d,e,s,n,a=q.White,l=null){d.beginPath(),d.arc(e,s,n,0,Math.PI*2),d.closePath(),l&&(d.fillStyle=l.toString(),d.fill()),a&&(d.strokeStyle=a.toString(),d.stroke())}class fs{constructor(e,s,n,a){this.font=e,this.text=s,this.color=n,this.maxWidth=a,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const l=this.canvas.getContext("2d");if(!l)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=l,this.dimensions=this.measureText(s),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(e,s){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let n=null;s!=null?n=this._getLinesFromText(e,s):n=e.split(`
`);const a=n.reduce(($,J)=>$.length>J.length?$:J);this._applyFont(this.ctx);const l=this.ctx.measureText(a);let g=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);const p=g*n.length;g=p;const v=p-Math.abs(l.actualBoundingBoxAscent),B=0,P=0;return new ht({left:B-Math.abs(l.actualBoundingBoxLeft)-this.font.padding,top:P-Math.abs(l.actualBoundingBoxAscent)-this.font.padding,bottom:P+v+this.font.padding,right:B+Math.abs(l.actualBoundingBoxRight)+this.font.padding})}_setDimension(e,s){let n=1;this.font.lineHeight&&(n=this.font.lineHeight/this.font.size),s.canvas.width=(e.width+this.font.padding*2)*2*this.font.quality,s.canvas.height=(e.height+this.font.padding*2)*2*this.font.quality*n}static getHashCode(e,s,n){var a;return s+"__hashcode__"+e.fontString+e.showDebug+e.textAlign+e.baseAlign+e.direction+e.lineHeight+JSON.stringify(e.shadow)+(e.padding.toString()+e.smoothing.toString()+e.lineWidth.toString()+e.lineDash.toString()+((a=e.strokeColor)===null||a===void 0?void 0:a.toString())+(n?n.toString():e.color.toString()))}getHashCode(e=!0){return fs.getHashCode(this.font,this.text,e?this.color:void 0)}_applyRasterProperties(e){var s,n,a;e.translate(this.font.padding,this.font.padding),e.imageSmoothingEnabled=this.font.smoothing,e.lineWidth=this.font.lineWidth,e.setLineDash((s=this.font.lineDash)!==null&&s!==void 0?s:e.getLineDash()),e.strokeStyle=(a=(n=this.font.strokeColor)===null||n===void 0?void 0:n.toString())!==null&&a!==void 0?a:"",e.fillStyle=this.color.toString()}_applyFont(e){e.resetTransform(),e.translate(this.font.padding+e.canvas.width/2,this.font.padding+e.canvas.height/2),e.scale(this.font.quality,this.font.quality),e.textAlign=this.font.textAlign,e.textBaseline=this.font.baseAlign,e.font=this.font.fontString,e.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(e.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(e.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(e.shadowOffsetX=this.font.shadow.offset.x,e.shadowOffsetY=this.font.shadow.offset.y))}_drawText(e,s,n){this._applyRasterProperties(e),this._applyFont(e);for(let a=0;a<s.length;a++){const l=s[a];this.color&&e.fillText(l,0,a*n),this.font.strokeColor&&e.strokeText(l,0,a*n)}this.font.showDebug&&(wn(e,q.Green,-e.canvas.width/2,0,e.canvas.width/2,0,2),wn(e,q.Red,0,-e.canvas.height/2,0,e.canvas.height/2,2))}_splitTextBitmap(e){const s=[];let n=0,a=0;const l=Math.min(4096,e.canvas.width),g=Math.min(4096,e.canvas.height);for(;n<e.canvas.width;){for(;a<e.canvas.height;){const p=document.createElement("canvas");p.width=l,p.height=g;const v=p.getContext("2d");if(!v)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");v.drawImage(e.canvas,n,a,l,g,0,0,l,g),s.push({x:n,y:a,canvas:p}),a+=g}n+=l,a=0}return s}flagDirty(){this._dirty=!0}render(e,s,n,a){var l;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=e;const g=this.getHashCode();if(this._lastHashCode!==g&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,a),this._setDimension(this.dimensions,this.ctx);const p=this._getLinesFromText(this.text,a),v=(l=this.font.lineHeight)!==null&&l!==void 0?l:this.dimensions.height/p.length;if(this._drawText(this.ctx,p,v),e instanceof Vs)for(const B of this._textFragments)e.textureLoader.delete(B.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),e instanceof Vs)for(const B of this._textFragments)e.textureLoader.load(B.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=g,this._dirty=!1}for(const p of this._textFragments)e.drawImage(p.canvas,0,0,p.canvas.width,p.canvas.height,p.x/this.font.quality+s-this.ctx.canvas.width/this.font.quality/2,p.y/this.font.quality+n-this.ctx.canvas.height/this.font.quality/2,p.canvas.width/this.font.quality,p.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof Vs)for(const e of this._textFragments)this._ex.textureLoader.delete(e.canvas);this._textFragments.length=0}_getLinesFromText(e,s){var n;if(this._cachedText===e&&this._cachedRenderWidth===s&&(!((n=this._cachedLines)===null||n===void 0)&&n.length))return this._cachedLines;const a=e.split(`
`);if(s==null)return a;for(let l=0;l<a.length;l++){let g=a[l],p="";if(this.measureText(g).width>s){for(;this.measureText(g).width>s;)p=g[g.length-1]+p,g=g.slice(0,-1);a[l]=g,a[l+1]=p}}return this._cachedText=e,this._cachedLines=a,this._cachedRenderWidth=s,a}}class Ae{static measureText(e,s,n){const a=fs.getHashCode(s,e);if(Ae._MEASURE_CACHE.has(a))return Ae._MEASURE_CACHE.get(a);Ae._LOGGER.debug("Font text measurement cache miss");const l=s.measureTextWithoutCache(e,n);return Ae._MEASURE_CACHE.set(a,l),l}static getTextInstance(e,s,n){const a=fs.getHashCode(s,e,n);let l=Ae._TEXT_CACHE.get(a);return l||(l=new fs(s,e,n),Ae._TEXT_CACHE.set(a,l),Ae._LOGGER.debug("Font text instance cache miss")),Ae._TEXT_USAGE.set(l,performance.now()),l}static checkAndClearCache(){const e=[],s=new Set;for(const[a,l]of Ae._TEXT_USAGE.entries())if(l+Ae.FONT_TIMEOUT<performance.now())Ae._LOGGER.debug(`Text cache entry timed out ${a.text}`),e.push(a),a.dispose();else{const g=a.getHashCode(!1);s.add(g)}e.forEach(a=>{Ae._TEXT_USAGE.delete(a)}),this._TEXT_CACHE.clear();for(const[a]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(a.getHashCode(),a);const n=new Map;for(const a of s)Ae._MEASURE_CACHE.has(a)&&n.set(a,Ae._MEASURE_CACHE.get(a));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=n}static get cacheSize(){return Ae._TEXT_USAGE.size}static clearCache(){for(const[e]of Ae._TEXT_USAGE.entries())e.dispose();Ae._TEXT_USAGE.clear(),Ae._TEXT_CACHE.clear(),Ae._MEASURE_CACHE.clear()}}Ae.FONT_TIMEOUT=500,Ae._LOGGER=j.getInstance(),Ae._TEXT_USAGE=new Map,Ae._TEXT_CACHE=new Map,Ae._MEASURE_CACHE=new Map;class Is extends vt{constructor(e={}){var s,n,a,l,g,p,v,B,P,z,$,J,at,ct,At,lt,gt,Pt,wt,Qt;super(e),this.filtering=Gt.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=q.Black,this.family="sans-serif",this.style=zr.Normal,this.bold=!1,this.unit=kr.Px,this.textAlign=Qr.Left,this.baseAlign=Lr.Top,this.direction=Ur.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new ht,this._textMeasurement=new fs(this,"",q.Black),this.smoothing=(s=e==null?void 0:e.smoothing)!==null&&s!==void 0?s:this.smoothing,this.padding=(n=e==null?void 0:e.padding)!==null&&n!==void 0?n:this.padding,this.color=(a=e==null?void 0:e.color)!==null&&a!==void 0?a:this.color,this.strokeColor=(l=e==null?void 0:e.strokeColor)!==null&&l!==void 0?l:this.strokeColor,this.lineDash=(g=e==null?void 0:e.lineDash)!==null&&g!==void 0?g:this.lineDash,this.lineWidth=(p=e==null?void 0:e.lineWidth)!==null&&p!==void 0?p:this.lineWidth,this.filtering=(v=e==null?void 0:e.filtering)!==null&&v!==void 0?v:this.filtering,this.family=(B=e==null?void 0:e.family)!==null&&B!==void 0?B:this.family,this.style=(P=e==null?void 0:e.style)!==null&&P!==void 0?P:this.style,this.bold=(z=e==null?void 0:e.bold)!==null&&z!==void 0?z:this.bold,this.size=($=e==null?void 0:e.size)!==null&&$!==void 0?$:this.size,this.unit=(J=e==null?void 0:e.unit)!==null&&J!==void 0?J:this.unit,this.textAlign=(at=e==null?void 0:e.textAlign)!==null&&at!==void 0?at:this.textAlign,this.baseAlign=(ct=e==null?void 0:e.baseAlign)!==null&&ct!==void 0?ct:this.baseAlign,this.direction=(At=e==null?void 0:e.direction)!==null&&At!==void 0?At:this.direction,this.lineHeight=(lt=e==null?void 0:e.lineHeight)!==null&&lt!==void 0?lt:this.lineHeight,this.quality=(gt=e==null?void 0:e.quality)!==null&&gt!==void 0?gt:this.quality,e!=null&&e.shadow&&(this.shadow={},this.shadow.blur=(Pt=e.shadow.blur)!==null&&Pt!==void 0?Pt:this.shadow.blur,this.shadow.offset=(wt=e.shadow.offset)!==null&&wt!==void 0?wt:this.shadow.offset,this.shadow.color=(Qt=e.shadow.color)!==null&&Qt!==void 0?Qt:this.shadow.color)}clone(){return new Is({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(e,s,n){}_rotate(e){var s;const n=(s=this.origin)!==null&&s!==void 0?s:this._textBounds.center;e.translate(n.x,n.y),e.rotate(this.rotation),e.translate(-n.x,-n.y)}_flip(e){this.flipHorizontal&&(e.translate(this._textBounds.width/this.scale.x,0),e.scale(-1,1)),this.flipVertical&&(e.translate(0,-this._textBounds.height/2/this.scale.y),e.scale(1,-1))}measureTextWithoutCache(e,s){return this._textMeasurement.measureText(e,s)}measureText(e,s){return Ae.measureText(e,this,s)}_postDraw(e){e.restore()}render(e,s,n,a,l,g){const p=Ae.getTextInstance(s,this,n);this._textBounds=p.dimensions,this._preDraw(e,a,l),p.render(e,a,l,g),this._postDraw(e)}}class Ar extends vt{constructor(e){var s,n;super(e),this._text="",this._textWidth=0,this._textHeight=0,this.font=(s=e.font)!==null&&s!==void 0?s:new Is,this.color=(n=e.color)!==null&&n!==void 0?n:this.color,this.text=e.text,this.maxWidth=e.maxWidth}clone(){var e,s;return new Ar({text:this.text.slice(),color:(s=(e=this.color)===null||e===void 0?void 0:e.clone())!==null&&s!==void 0?s:q.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(e){this._text=e,this._calculateDimension()}get font(){return this._font}set font(e){this._font=e}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:e,height:s}=this.font.measureText(this._text,this.maxWidth);this._textWidth=e,this._textHeight=s}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(e){}_flip(e){}_preDraw(e,s,n){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(e,s,n)}_drawImage(e,s,n){var a;let l=q.Black;this.font instanceof Is&&(l=(a=this.color)!==null&&a!==void 0?a:this.font.color);const{width:g,height:p}=this.font.measureText(this._text,this.maxWidth);this._textWidth=g,this._textHeight=p,this.font.render(e,this._text,l,s,n,this.maxWidth),this.font.showDebug&&(e.debug.drawRect(s-g,n-p,g*2,p*2),this.maxWidth!=null&&e.debug.drawRect(s,n,this.maxWidth,this.height,{color:q.Yellow}))}}function xn(d){return!!d.tick}class De extends Hi{get visible(){return this.isVisible}set visible(e){this.isVisible=e}get offset(){return this._offset}set offset(e){this._offset=new gs(e,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(e){this._anchor=new gs(e,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(e){if(e){this._color=e.clone();const s=this.graphics.current;(s instanceof qs||s instanceof Ar)&&(s.color=this._color)}}constructor(e){super(),this._logger=j.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new gs(I.Zero,()=>this.recalculateBounds()),this._anchor=new gs(I.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,e={visible:this.isVisible,graphics:{},...e};const{current:s,anchor:n,color:a,opacity:l,visible:g,graphics:p,offset:v,copyGraphics:B,onPreDraw:P,onPostDraw:z,onPreTransformDraw:$,onPostTransformDraw:J}=e;for(const[at,ct]of Object.entries(p))ct instanceof vt?this._graphics[at]=ct:(this._graphics[at]=ct.graphic,this._options[at]=ct.options);this.offset=v??this.offset,this.opacity=l??this.opacity,this.anchor=n??this.anchor,this.color=a??this.color,this.copyGraphics=B??this.copyGraphics,this.onPreDraw=P??this.onPreDraw,this.onPostDraw=z??this.onPostDraw,this.onPreDraw=$??this.onPreTransformDraw,this.onPostTransformDraw=J??this.onPostTransformDraw,this.isVisible=!!g,this._current=s??this._current,s&&this._graphics[s]&&this.use(s)}getGraphic(e){return this._graphics[e]}getOptions(e){return this._options[e]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(e,s,n){let a="default",l=null,g;if(typeof e=="string"&&s instanceof vt&&(a=e,l=s,g=n),e instanceof vt&&!(s instanceof vt)&&(l=e,g=s),!l)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[a]=this.copyGraphics?l.clone():l,this._options[a]=this.copyGraphics?{...g}:g,a==="default"&&this.use("default"),l}remove(e){delete this._graphics[e],delete this._options[e],this._current===e&&(this._current="default",this.recalculateBounds())}use(e,s){var n;if(e instanceof vt){let a=e;this.copyGraphics&&(a=e.clone()),this._current="default",this._graphics[this._current]=a,this._options[this._current]=s}else this._current=e,this._options[this._current]=s,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(n=this.owner)===null||n===void 0?void 0:n.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(e){this._localBounds=e}recalculateBounds(){let e=new ht;const s=this._graphics[this._current],n=this._options[this._current];if(!s){this._localBounds=e;return}let a=this.anchor,l=this.offset;n!=null&&n.anchor&&(a=n.anchor),n!=null&&n.offset&&(l=n.offset);const g=s.localBounds,p=-g.width*a.x+l.x,v=-g.height*a.y+l.y;s instanceof Ws&&!s.useAnchor?e=s==null?void 0:s.localBounds.combine(e):e=s==null?void 0:s.localBounds.translate(R(p,v)).combine(e),this._localBounds=e}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let e=this.localBounds;if(this.owner){const s=this.owner.get(Ot);s&&(e=e.transform(s.get().matrix))}return e}update(e,s=0){const n=this.current;n&&xn(n)&&n.tick(e,s)}clone(){const e=new De;return e._graphics={...this._graphics},e._options={...this._options},e.offset=this.offset.clone(),this.color&&(e.color=this.color.clone()),e.opacity=this.opacity,e.anchor=this.anchor.clone(),e.copyGraphics=this.copyGraphics,e.onPreDraw=this.onPreDraw,e.onPostDraw=this.onPostDraw,e.isVisible=this.isVisible,e}}var Nr;(function(d){d.Kill="kill",d.PreKill="prekill",d.PostKill="postkill",d.PreDraw="predraw",d.PostDraw="postdraw",d.PreDebugDraw="predebugdraw",d.PostDebugDraw="postdebugdraw",d.PreUpdate="preupdate",d.PostUpdate="postupdate",d.PreFrame="preframe",d.PostFrame="postframe",d.PreCollision="precollision",d.CollisionStart="collisionstart",d.CollisionEnd="collisionend",d.PostCollision="postcollision",d.Initialize="initialize",d.Activate="activate",d.Deactivate="deactivate",d.ExitViewport="exitviewport",d.EnterViewport="enterviewport",d.ExitTrigger="exit",d.EnterTrigger="enter",d.Connect="connect",d.Disconnect="disconnect",d.Button="button",d.Axis="axis",d.Visible="visible",d.Hidden="hidden",d.Start="start",d.Stop="stop",d.PointerUp="pointerup",d.PointerDown="pointerdown",d.PointerMove="pointermove",d.PointerEnter="pointerenter",d.PointerLeave="pointerleave",d.PointerCancel="pointercancel",d.PointerWheel="pointerwheel",d.Up="up",d.Down="down",d.Move="move",d.Enter="enter",d.Leave="leave",d.Cancel="cancel",d.Wheel="wheel",d.Press="press",d.Release="release",d.Hold="hold",d.PointerDragStart="pointerdragstart",d.PointerDragEnd="pointerdragend",d.PointerDragEnter="pointerdragenter",d.PointerDragLeave="pointerdragleave",d.PointerDragMove="pointerdragmove",d.ActionStart="actionstart",d.ActionComplete="actioncomplete",d.Add="add",d.Remove="remove"})(Nr||(Nr={}));class ne{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(e){this._bubbles=e}stopPropagation(){this.bubbles=!1}}class Gr extends ne{constructor(e){super(),this.self=e,this.target=e}}class bn extends ne{constructor(e){super(),this.self=e,this.target=e}}class Cn extends ne{constructor(e){super(),this.self=e,this.target=e}}class G extends ne{constructor(e){super(),this.self=e,this.target=e}}class m extends ne{constructor(e){super(),this.self=e,this.target=e}}class b extends ne{constructor(e,s,n){super(),this.ctx=e,this.elapsed=s,this.self=n,this.target=n}}class M extends ne{constructor(e,s,n){super(),this.ctx=e,this.elapsed=s,this.self=n,this.target=n}}class K extends ne{constructor(e,s,n){super(),this.ctx=e,this.elapsed=s,this.self=n,this.target=n}}class Rt extends ne{constructor(e,s,n){super(),this.ctx=e,this.elapsed=s,this.self=n,this.target=n}}class dt extends ne{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class Tt extends ne{constructor(e,s){super(),this.ctx=e,this.self=s,this.target=s}}class zt extends ne{constructor(e,s,n){super(),this.engine=e,this.elapsed=s,this.self=n,this.target=n}}class Vt extends ne{constructor(e,s,n){super(),this.engine=e,this.elapsed=s,this.self=n,this.target=n}}class Re extends ne{constructor(e,s){super(),this.engine=e,this.prevStats=s,this.target=e}}class hs extends ne{constructor(e,s){super(),this.engine=e,this.stats=s,this.target=e}}class Or extends ne{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class hh extends ne{constructor(e,s){super(),this.index=e,this.gamepad=s,this.target=s}}class lh extends ne{constructor(e,s,n){super(),this.button=e,this.value=s,this.self=n,this.target=n}}class ch extends ne{constructor(e,s,n){super(),this.axis=e,this.value=s,this.self=n,this.target=n}}class dh extends ne{constructor(e){super(),this.self=e,this.target=e}}class uh extends ne{constructor(e){super(),this.self=e,this.target=e}}class Hr extends ne{constructor(e,s,n,a,l){super(),this.self=e,this.other=s,this.side=n,this.intersection=a,this.contact=l,this.target=e}}class Wr extends ne{constructor(e,s,n,a,l){super(),this.self=e,this.other=s,this.side=n,this.intersection=a,this.contact=l,this.target=e}}class ta{constructor(e,s,n,a){this.self=e,this.other=s,this.side=n,this.contact=a}}class ea{constructor(e,s,n,a){this.self=e,this.other=s,this.side=n,this.lastContact=a}}class ia{constructor(e,s,n,a,l){this.self=e,this.other=s,this.side=n,this.intersection=a,this.contact=l}}class sa{constructor(e,s,n,a,l){this.self=e,this.other=s,this.side=n,this.intersection=a,this.contact=l}}class Jn extends ne{constructor(e,s,n,a){super(),this.self=e,this.other=s,this.side=n,this.contact=a,this.target=e}}class Kn extends ne{constructor(e,s,n,a){super(),this.self=e,this.other=s,this.side=n,this.lastContact=a,this.target=e}}class En extends ne{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class gh extends ne{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class fh extends ne{constructor(e,s){super(),this.context=e,this.self=s,this.target=s}}class _h extends ne{constructor(e){super(),this.self=e,this.target=e}}class ph extends ne{constructor(e){super(),this.self=e,this.target=e}}class Ah extends ne{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class mh extends ne{constructor(e,s){super(),this.self=e,this.entity=s,this.target=e}}class vh extends ne{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class wh extends ne{constructor(e,s){super(),this.action=e,this.self=s,this.target=s}}class yh extends ne{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class xh extends ne{constructor(e,s){super(),this.engine=e,this.self=s,this.target=s}}class Af{constructor(e){this.data=e,this.type="Component Added"}}function mf(d){return!!d&&d.type==="Component Added"}class vf{constructor(e){this.data=e,this.type="Component Removed"}}function wf(d){return!!d&&d.type==="Component Removed"}const yf={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Ci{constructor(e,s){this.id=Ci._ID++,this.name=`Entity#${this.id}`,this.events=new S,this._tags=new Set,this.componentAdded$=new hi,this.componentRemoved$=new hi,this.tagAdded$=new hi,this.tagRemoved$=new hi,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new hi,this.childrenRemoved$=new hi,this._children=[],this._isInitialized=!1,this._isAdded=!1;let n,a;if(Array.isArray(e))n=e,a=s;else if(e&&typeof e=="object"){const{components:l,name:g,silenceWarnings:p}=e;n=l??[],a=g}if(a&&(this.name=a),n)for(const l of n)this.addComponent(l)}get active(){return this.isActive}set active(e){this.isActive=e}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new Gr(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(e){return this._tags.has(e)}addTag(e){return this._tags.add(e),this.tagAdded$.notifyAll(e),this}removeTag(e){return this._tags.delete(e),this.tagRemoved$.notifyAll(e),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(e){for(let s=0;s<e.length;s++)if(!this.components.has(e[s]))return!1;return!0}hasAllTags(e){for(let s=0;s<e.length;s++)if(!this.tags.has(e[s]))return!1;return!0}get(e){return this.components.get(e)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(e){if(e.parent===null){if(this.getAncestors().includes(e))throw new Error("Cycle detected, cannot add entity");this._children.push(e),e._parent=this,this.childrenAdded$.notifyAll(e)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(e){return e.parent===this&&(Yt(e,this._children),e._parent=null,this.childrenRemoved$.notifyAll(e)),this}removeAllChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}getAncestors(){const e=[this];let s=this.parent;for(;s;)e.push(s),s=s.parent;return e.reverse()}getDescendants(){let e=[this],s=[this];for(;s.length>0;){const n=s.pop();n&&(s=s.concat(n.children),e=e.concat(n.children))}return e}clone(){const e=new Ci;for(const s of this.types){const n=this.get(s);n&&e.addComponent(n.clone())}for(const s of this.children)e.addChild(s.clone());return e}addTemplate(e,s=!1){for(const n of e.getComponents())this.addComponent(n.clone(),s);for(const n of e.children)this.addChild(n.clone().addTemplate(n));return this}_getClassHierarchyRoot(e){var s,n;let a=e,l=(s=Object.getPrototypeOf(a.prototype))===null||s===void 0?void 0:s.constructor;for(;l&&l!==Object&&l!==Hi;)a=l,l=(n=Object.getPrototypeOf(a.prototype))===null||n===void 0?void 0:n.constructor;return a}addComponent(e,s=!1){if(this.has(e.constructor))if(s)this.removeComponent(e.constructor,!0);else return this;if(e.dependencies&&e.dependencies.length)for(const a of e.dependencies)this.addComponent(new a);e.owner=this;const n=this._getClassHierarchyRoot(e.constructor);return this.components.set(n,e),this.components.set(e.constructor,e),this.componentValues.push(e),e.onAdd&&e.onAdd(this),this.componentAdded$.notifyAll(e),this}removeComponent(e,s=!1){let n;if($n(e)?n=e:n=e.constructor,s){const a=this.components.get(n);if(a){this.componentRemoved$.notifyAll(a),a.owner=void 0,a.onRemove&&a.onRemove(this);const g=this.componentValues.indexOf(a);g>-1&&this.componentValues.splice(g,1)}const l=this._getClassHierarchyRoot(n);this.components.delete(l),this.components.delete(n)}else this._componentsToRemove.push(n);return this}clearComponents(){const e=this.types;for(const s of e)this.removeComponent(s)}processComponentRemoval(){for(const e of this._componentsToRemove)this.removeComponent(e,!0);this._componentsToRemove.length=0}has(e){return this.components.has(e)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(e){this.isInitialized||(this.onInitialize(e),this.events.emit("initialize",new En(e,this)),this._isInitialized=!0)}_add(e){!this.isAdded&&this.isActive&&(this.onAdd(e),this.events.emit("add",new yh(e,this)),this._isAdded=!0)}_remove(e){this.isAdded&&!this.isActive&&(this.onRemove(e),this.events.emit("remove",new xh(e,this)),this._isAdded=!1)}_preupdate(e,s){this.events.emit("preupdate",new zt(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Vt(e,s,this)),this.onPostUpdate(e,s)}onInitialize(e){}onAdd(e){}onRemove(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s);for(const n of this.children)n.update(e,s);this._postupdate(e,s),this._remove(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}Ci._ID=0;class ve extends Hi{constructor(){super(...arguments),this.vel=I.Zero,this.acc=I.Zero,this.scaleFactor=I.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class Mi{static integrate(e,s,n,a){const l=a/1e3;s.vel.addEqual(n.scale(l,Mi._ACC)),e.pos.add(s.vel.scale(l,Mi._VEL),Mi._POS).addEqual(n.scale(.5*l*l,Mi._VEL_ACC)),s.angularVelocity+=s.torque*(1/s.inertia)*l;const g=e.rotation+s.angularVelocity*l;e.scale.add(s.scaleFactor.scale(l,this._SCALE_FACTOR),Mi._SCALE),e.get().setTransform(Mi._POS,g,Mi._SCALE)}}Mi._POS=new I(0,0),Mi._SCALE=new I(1,1),Mi._ACC=new I(0,0),Mi._VEL=new I(0,0),Mi._VEL_ACC=new I(0,0),Mi._SCALE_FACTOR=new I(0,0);class ra extends Ci{constructor(e){super({silenceWarnings:!0}),this.beginColor=q.White,this.endColor=q.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=q.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=_s.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new Ot),this.addComponent(this.motion=new ve),this.addComponent(this.graphics=new De),this.configure(e)}registerEmitter(e){if(this._emitter=e,this.particleTransform===_s.Global){const s=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(s),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(e){var s,n,a,l,g,p,v,B,P,z,$,J,at,ct;this.particleTransform=(s=e.transform)!==null&&s!==void 0?s:this.particleTransform,this.life=(n=e.life)!==null&&n!==void 0?n:this.life,this.fade=(a=e.fade)!==null&&a!==void 0?a:this.fade,this.size=(l=e.size)!==null&&l!==void 0?l:this.size,this.endColor=(g=e.endColor)!==null&&g!==void 0?g:this.endColor.clone(),this.beginColor=(p=e.beginColor)!==null&&p!==void 0?p:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=e.graphic,this.graphics.opacity=(v=e.opacity)!==null&&v!==void 0?v:this.graphics.opacity,this.transform.pos=(B=e.pos)!==null&&B!==void 0?B:this.transform.pos,this.transform.rotation=(P=e.rotation)!==null&&P!==void 0?P:0,this.transform.scale=R(1,1),this.motion.vel=(z=e.vel)!==null&&z!==void 0?z:this.motion.vel,this.motion.angularVelocity=($=e.angularVelocity)!==null&&$!==void 0?$:0,this.motion.acc=(J=e.acc)!==null&&J!==void 0?J:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(at=e.startSize)!==null&&at!==void 0?at:0,this.endSize=(ct=e.endSize)!==null&&ct!==void 0?ct:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=ht.fromDimension(this.size,this.size,I.Half),this.graphics.onPostDraw=At=>{At.save(),At.debug.drawPoint(R(0,0),{color:this._currentColor,size:this.size}),At.restore()})}kill(){var e;!((e=this._emitter)===null||e===void 0)&&e.isActive?this._emitter.removeParticle(this):super.kill()}update(e,s){this.life=this.life-s,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=L(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=L(this.sizeRate*s+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=L(this._currentColor.r+this._rRate*s,0,255),this._currentColor.g=L(this._currentColor.g+this._gRate*s,0,255),this._currentColor.b=L(this._currentColor.b+this._bRate*s,0,255),this._currentColor.a=this.graphics.opacity;let n=this.motion.acc;this.focus&&(n=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(s/1e3)),Mi.integrate(this.transform,this.motion,n,s)}}ra.DefaultConfig={beginColor:q.White,endColor:q.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var _s;(function(d){d.Global="global",d.Local="local"})(_s||(_s={}));class Mc{constructor(){this.type="ex.particle",this.priority=0}initialize(e,s){this._gl=e,this._context=s,this._shader=new Ze({gl:e,vertexSource:jo,fragmentSource:Yo,onPreLink:n=>{e.transformFeedbackVaryings(n,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],e.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(e){const s=e.getAttribute(Xt.Filtering),n=s?Nt(s):void 0,a=he(e.getAttribute(Xt.WrappingX)),l=he(e.getAttribute(Xt.WrappingY)),g=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:n,wrapping:{x:a,y:l}},g);return e.removeAttribute("forceUpload"),p}draw(e,s){var n,a,l,g,p,v,B,P,z;const $=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const J=e.particle.transform===_s.Local?this._context.getTransform():this._context.getTransform().multiply(e.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",J),this._shader.setUniformBoolean("fade",!!e.particle.fade),this._shader.setUniformBoolean("useTexture",!!e.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(n=e.particle.life)!==null&&n!==void 0?n:2e3),this._shader.setUniformFloat("deltaMs",s),this._shader.setUniformFloatVector("gravity",(a=e.particle.acc)!==null&&a!==void 0?a:R(0,0)),this._shader.setUniformFloatColor("beginColor",(l=e.particle.beginColor)!==null&&l!==void 0?l:q.Transparent),this._shader.setUniformFloatColor("endColor",(g=e.particle.endColor)!==null&&g!==void 0?g:q.Transparent);let at=(p=e.particle.startSize)!==null&&p!==void 0?p:0,ct=(v=e.particle.endSize)!==null&&v!==void 0?v:0;const At=(B=e.particle.size)!==null&&B!==void 0?B:0;if(At>0&&(at=At,ct=At),this._shader.setUniformFloat("startSize",at??10),this._shader.setUniformFloat("endSize",ct??10),this._shader.setUniformFloat("startOpacity",(P=e.particle.opacity)!==null&&P!==void 0?P:1),e.particle.focus&&(this._shader.setUniformFloatVector("focus",e.particle.focus),this._shader.setUniformFloat("focusAccel",(z=e.particle.focusAccel)!==null&&z!==void 0?z:0)),e.particle.graphic){const lt=e.particle.graphic,gt=this._getTexture(lt.image.image);$.activeTexture($.TEXTURE0),$.bindTexture($.TEXTURE_2D,gt),this._shader.setUniformInt("graphic",0)}e.draw($)}hasPendingDraws(){return!1}flush(){}dispose(){}}const xf=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;\r
  uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, uv.x);\r
  uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, uv.y);\r
\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,bf=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_siz)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class Cf{constructor(e){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=q.White,this.pixelArtSampler=e.pixelArtSampler,this.uvPadding=e.uvPadding}initialize(e,s){this._gl=e,this._context=s;const n=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),a=Gi(e,n);this._maxTextures=Math.min(n,a);const l=this._transformFragmentSource(xf,this._maxTextures);this._shader=new Ze({gl:e,fragmentSource:l,vertexSource:bf}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",s.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((z,$)=>$)),this._vao=e.createVertexArray(),e.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._meshBuffer),e.bufferData(e.ARRAY_BUFFER,this._quadMesh,e.STATIC_DRAW),e.vertexAttribPointer(0,2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,16,8),e.enableVertexAttribArray(1),e.bindBuffer(e.ARRAY_BUFFER,null);const g=this._components;this._transformData=new Fi({gl:e,size:g*this._maxImages,type:"dynamic"}),this._transformData.bind();let p=0,v=2;const B=4,P=g*4;e.vertexAttribPointer(v++,2,e.FLOAT,!1,P,p),e.enableVertexAttribArray(2),p+=2*B,e.vertexAttribPointer(v++,2,e.FLOAT,!1,P,p),e.enableVertexAttribArray(3),p+=2*B,e.vertexAttribPointer(v++,2,e.FLOAT,!1,P,p),e.enableVertexAttribArray(4),p+=2*B,e.vertexAttribPointer(v++,2,e.FLOAT,!1,P,p),e.enableVertexAttribArray(5),p+=2*B,e.vertexAttribPointer(v++,1,e.FLOAT,!1,P,p),e.enableVertexAttribArray(6),p+=1*B,e.vertexAttribPointer(v++,2,e.FLOAT,!1,P,p),e.enableVertexAttribArray(7),p+=2*B,e.vertexAttribPointer(v++,2,e.FLOAT,!1,P,p),e.enableVertexAttribArray(8),p+=2*B,e.vertexAttribPointer(v++,1,e.FLOAT,!1,P,p),e.enableVertexAttribArray(9),p+=1*B,e.vertexAttribPointer(v++,2,e.FLOAT,!1,P,p),e.enableVertexAttribArray(10),p+=2*B,e.vertexAttribPointer(v++,2,e.FLOAT,!1,P,p),e.enableVertexAttribArray(11),p+=2*B,e.vertexAttribPointer(v++,4,e.FLOAT,!1,P,p),e.enableVertexAttribArray(12),p+=4*B,e.vertexAttribDivisor(2,1),e.vertexAttribDivisor(3,1),e.vertexAttribDivisor(4,1),e.vertexAttribDivisor(5,1),e.vertexAttribDivisor(6,1),e.vertexAttribDivisor(7,1),e.vertexAttribDivisor(8,1),e.vertexAttribDivisor(9,1),e.vertexAttribDivisor(10,1),e.vertexAttribDivisor(11,1),e.vertexAttribDivisor(12,1),e.bindVertexArray(null)}_bindData(e){const s=this._components;this._transformData.bind(),this._transformData.upload(s*this._imageCount),e.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(e,s){let n=e.replace("%%count%%",s.toString()),a="";for(let l=0;l<s;l++)l===0?a+=`if (v_texture_index <= ${l}.5) {
`:a+=`   else if (v_texture_index <= ${l}.5) {
`,a+=`      color = texture(u_textures[${l}], uv);
`,a+=`   }
`;return n=n.replace("%%texture_picker%%",a),n}_addImageAsTexture(e){if(this._images.has(e))return;const s=e.getAttribute(Xt.Filtering),n=s?Nt(s):void 0,a=he(e.getAttribute(Xt.WrappingX)),l=he(e.getAttribute(Xt.WrappingY)),g=e.getAttribute("forceUpload")==="true",p=this._context.textureLoader.load(e,{filtering:n,wrapping:{x:a,y:l}},g);e.removeAttribute("forceUpload"),this._textures.indexOf(p)===-1&&(this._textures.push(p),this._textureToIndex.set(p,this._textureIndex++),this._images.add(e))}_bindTextures(e){const s=Math.min(this._textureIndex,this._maxTextures);for(let n=0;n<s;n++)e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_2D,this._textures[n]||this._textures[0])}_getTextureIdForImage(e){var s;if(e){const n=this._context.textureLoader.get(e);return(s=this._textureToIndex.get(n))!==null&&s!==void 0?s:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}draw(e,s,n,a,l,g,p,v,B){var P,z,$,J;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(e);const at=this._getImageWidth(e),ct=this._getImageHeight(e);let At=at||a||0,lt=ct||l||0;this._view[0]=0,this._view[1]=0,this._view[2]=(P=a??at)!==null&&P!==void 0?P:0,this._view[3]=(z=l??ct)!==null&&z!==void 0?z:0,this._dest[0]=s??1,this._dest[1]=n??1,g!==void 0&&p!==void 0&&v!==void 0&&B!==void 0&&(this._view[0]=s??1,this._view[1]=n??1,this._view[2]=($=a??at)!==null&&$!==void 0?$:0,this._view[3]=(J=l??ct)!==null&&J!==void 0?J:0,this._dest[0]=g,this._dest[1]=p,At=v,lt=B),s=this._view[0],n=this._view[1];const gt=this._view[2],Pt=this._view[3],wt=this._context.getTransform(),Qt=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+oe),this._dest[1]=~~(this._dest[1]+oe));const It=this._context.tint||this._defaultTint,re=this._getTextureIdForImage(e),_e=at||At,ke=ct||lt,Qe=(s+this.uvPadding)/_e,Bi=(n+this.uvPadding)/ke,je=(s+gt-this.uvPadding)/_e,Fe=(n+Pt-this.uvPadding)/ke,Ti=at,mi=ct,Wt=this._transformData.bufferData;Wt[this._vertexIndex++]=this._dest[0],Wt[this._vertexIndex++]=this._dest[1],Wt[this._vertexIndex++]=wt.data[0],Wt[this._vertexIndex++]=wt.data[1],Wt[this._vertexIndex++]=wt.data[2],Wt[this._vertexIndex++]=wt.data[3],Wt[this._vertexIndex++]=wt.data[4],Wt[this._vertexIndex++]=wt.data[5],Wt[this._vertexIndex++]=Qt,Wt[this._vertexIndex++]=At,Wt[this._vertexIndex++]=lt,Wt[this._vertexIndex++]=Ti,Wt[this._vertexIndex++]=mi,Wt[this._vertexIndex++]=re,Wt[this._vertexIndex++]=Qe,Wt[this._vertexIndex++]=Bi,Wt[this._vertexIndex++]=je,Wt[this._vertexIndex++]=Fe,Wt[this._vertexIndex++]=It.r/255,Wt[this._vertexIndex++]=It.g/255,Wt[this._vertexIndex++]=It.b/255,Wt[this._vertexIndex++]=It.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const e=this._gl;this._shader.use(),this._bindData(e),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(e),e.drawArraysInstanced(e.TRIANGLES,0,6,this._imageCount),pe.DrawnImagesCount+=this._imageCount,pe.DrawCallCount++,e.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const oe=1e-4;class Ef{constructor(e){this._webglCtx=e,this._debugText=new ai}drawRect(e,s,n,a,l={color:q.Black}){this.drawLine(R(e,s),R(e+n,s),{...l}),this.drawLine(R(e+n,s),R(e+n,s+a),{...l}),this.drawLine(R(e+n,s+a),R(e,s+a),{...l}),this.drawLine(R(e,s+a),R(e,s),{...l})}drawLine(e,s,n){var a;this._webglCtx.draw("ex.line",e,s,(a=n==null?void 0:n.color)!==null&&a!==void 0?a:q.Black)}drawPoint(e,s={color:q.Black,size:5}){this._webglCtx.draw("ex.point",e,s.color,s.size)}drawText(e,s){this._debugText.write(this._webglCtx,e,s)}}class Vs{get z(){return this._state.current.z}set z(e){this._state.current.z=e}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(e){let s=!0;return(e.width>4096||e.height>4096)&&(s=!1),s}constructor(e){this._logger=j.getInstance(),this._renderers=new Map,this.imageRenderer=f.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new Mr(()=>new te,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new V,this._state=new Lt,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=q.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new Ef(this),this._totalPostProcessorTime=0;const{canvasElement:s,context:n,enableTransparency:a,antialiasing:l,uvPadding:g,multiSampleAntialiasing:p,pixelArtSampler:v,powerPreference:B,snapToPixel:P,backgroundColor:z,useDrawSorting:$,garbageCollector:J,handleContextLost:at,handleContextRestored:ct}=e;if(this.__gl=n??s.getContext("webgl2",{antialias:l??this.smoothing,premultipliedAlpha:!1,alpha:a??this.transparency,depth:!1,powerPreference:B??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");at&&this.__gl.canvas.addEventListener("webglcontextlost",at,!1),ct&&this.__gl.canvas.addEventListener("webglcontextrestored",ct,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new se(this.__gl,J),this.snapToPixel=P??this.snapToPixel,this.smoothing=l??this.smoothing,this.transparency=a??this.transparency,this.pixelArtSampler=v??this.pixelArtSampler,this.uvPadding=g??this.uvPadding,this.multiSampleAntialiasing=typeof p=="boolean"?p:this.multiSampleAntialiasing,this.samples=typeof p=="object"?p.samples:void 0,this.backgroundColor=z??this.backgroundColor,this.useDrawSorting=$??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const e of this._renderers.values())e.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const e=this.__gl;if(this._ortho=x.ortho(0,e.canvas.width,e.canvas.height,0,400,-400),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.depthMask(!1),this.register(new gr({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new mn),this.register(new pn),this.register(new Zn),this.register(new ds),this.register(new lr),this.register(new Mc),this.register(new Cf({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=e.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");e.bindTexture(e.TEXTURE_2D,this.materialScreenTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),this._screenRenderer=new Oi(e),this._renderTarget=new xi({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),this._postProcessTargets=[new xi({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height}),new xi({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height})],this._msaaTarget=new xi({gl:e,transparency:this.transparency,width:e.canvas.width,height:e.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(e){this._renderers.set(e.type,e),e.initialize(this.__gl,this)}get(e){return this._renderers.get(e)}_isCurrentRenderer(e){return!this._currentRenderer||this._currentRenderer===e}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(e,...s){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${e}, the webgl context is lost`);return}const n=this._renderers.get(e);if(n)if(this.useDrawSorting){const a=this._drawCallPool.get();a.z=this._state.current.z,a.priority=n.priority,a.renderer=e,this.getTransform().clone(a.transform),a.state.z=this._state.current.z,a.state.opacity=this._state.current.opacity,a.state.tint=this._state.current.tint,a.state.material=this._state.current.material,a.args[0]=s[0],a.args[1]=s[1],a.args[2]=s[2],a.args[3]=s[3],a.args[4]=s[4],a.args[5]=s[5],a.args[6]=s[6],a.args[7]=s[7],a.args[8]=s[8],a.args[9]=s[9],this._drawCalls[this._drawCallIndex++]=a}else this._currentRenderer||(this._currentRenderer=n),this._isCurrentRenderer(n)||this._currentRenderer.flush(),n.draw(s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9]),this._currentRenderer=n;else throw Error(`No renderer with name ${e} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(e){const s=this.__gl;this._ortho=this._ortho=x.ortho(0,e.width,e.height,0,400,-400),this._renderTarget.setResolution(s.canvas.width,s.canvas.height),this._msaaTarget.setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[0].setResolution(s.canvas.width,s.canvas.height),this._postProcessTargets[1].setResolution(s.canvas.width,s.canvas.height)}_getImageWidth(e){let s=this._imageToWidth.get(e);return s===void 0&&(s=e.width,this._imageToWidth.set(e,s)),s}_getImageHeight(e){let s=this._imageToHeight.get(e);return s===void 0&&(s=e.height,this._imageToHeight.set(e,s)),s}drawImage(e,s,n,a,l,g,p,v,B){if(!(a===0||l===0)){{if(v===0||B===0)return;if(this._getImageWidth(e)===0||this._getImageHeight(e)===0)return}if(!e){j.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",e,s,n,a,l,g,p,v,B):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,e,s,n,a,l,g,p,v,B):this.draw(this.imageRenderer,e,s,n,a,l,g,p,v,B)}}drawLine(e,s,n,a=1){this.draw("ex.rectangle",e,s,n,a)}drawRectangle(e,s,n,a,l,g){this.draw("ex.rectangle",e,s,n,a,l,g)}drawCircle(e,s,n,a,l){this.draw("ex.circle",e,s,n,a,l)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(e,s){this._transform.translate(this.snapToPixel?~~(e+oe):e,this.snapToPixel?~~(s+oe):s)}rotate(e){this._transform.rotate(e)}scale(e,s){this._transform.scale(e,s)}transform(e){this._transform.current=e}getTransform(){return this._transform.current}multiply(e){this._transform.current.multiply(e,this._transform.current)}addPostProcessor(e){this._postprocessors.push(e),e.initialize(this.__gl)}removePostProcessor(e){const s=this._postprocessors.indexOf(e);s!==-1&&this._postprocessors.splice(s,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(e){for(const s of this._postprocessors){const n=s.getShader();n.use();const a=n.getUniforms();this._totalPostProcessorTime+=e,a.find(l=>l.name==="u_time_ms")&&n.setUniformFloat("u_time_ms",this._totalPostProcessorTime),a.find(l=>l.name==="u_elapsed_ms")&&n.setUniformFloat("u_elapsed_ms",e),a.find(l=>l.name==="u_resolution")&&n.setUniformFloatVector("u_resolution",R(this.width,this.height)),s.onUpdate&&s.onUpdate(e)}}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return new An({...e,graphicsContext:this})}createShader(e){const s=this.__gl,{vertexSource:n,fragmentSource:a}=e,l=new Ze({gl:s,vertexSource:n,fragmentSource:a});return l.compile(),l}clear(){const e=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),e.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),e.clear(e.COLOR_BUFFER_BIT)}flush(){var e;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let s=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(s.use(),this.useDrawSorting){for(let g=this._drawCallIndex;g<this._drawCalls.length;g++)this._drawCalls[g]=null;const n=new Map;for(const[g]of this._renderers){let p=0;for(p=0;p<this._drawCallIndex&&this._drawCalls[p].renderer!==g;p++);n.set(g,p)}this._drawCalls.sort((g,p)=>{if(g===null||p===null)return 0;const v=g.z-p.z,B=n.get(g.renderer)-n.get(p.renderer),P=g.priority-p.priority;return v===0?P===0?B:P:v});const a=this._transform.current,l=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let g=this._drawCalls[0].renderer,p=this._renderers.get(g);for(let v=0;v<this._drawCallIndex;v++)this._transform.current=this._drawCalls[v].transform,this._state.current=this._drawCalls[v].state,this._drawCalls[v].renderer!==g&&(p.flush(),g=this._drawCalls[v].renderer,p=this._renderers.get(g)),p instanceof mn&&(!((e=this.material)===null||e===void 0)&&e.isUsingScreenTexture)&&(s.copyToTexture(this.materialScreenTexture),s.use()),p.draw(...this._drawCalls[v].args);p.hasPendingDraws()&&p.flush()}this._transform.current=a,this._state.current=l,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const n of this._renderers.values())n.hasPendingDraws()&&n.flush();s.disable(),this._postprocessors.length>0&&s.toRenderSource().use();for(let n=0;n<this._postprocessors.length;n++)s=this._postProcessTargets[n%2],this._postProcessTargets[n%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[n]),this._postProcessTargets[n%2].toRenderSource().use();s.blitToScreen()}}const qe=1e-4;class If{constructor(e){this._ex=e,this._debugText=new ai}drawRect(e,s,n,a){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(e+qe):e,this._ex.snapToPixel?~~(s+qe):s,this._ex.snapToPixel?~~(n+qe):n,this._ex.snapToPixel?~~(a+qe):a),this._ex.__ctx.restore()}drawLine(e,s,n={color:q.Black}){var a,l;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(l=(a=n.color)===null||a===void 0?void 0:a.toString())!==null&&l!==void 0?l:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(e.x+qe):e.x,this._ex.snapToPixel?~~(e.y+qe):e.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(s.x+qe):s.x,this._ex.snapToPixel?~~(s.y+qe):s.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(e,s={color:q.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=s.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(e.x+qe):e.x,this._ex.snapToPixel?~~(e.y+qe):e.y,s.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(e,s){this._debugText.write(this._ex,e,s)}}class na{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(e){this._state.current.opacity=e}get tint(){return this._state.current.tint}set tint(e){this._state.current.tint=e}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(e){this.__ctx.imageSmoothingEnabled=e}constructor(e){this.useDrawSorting=!1,this.z=0,this.backgroundColor=q.ExcaliburBlue,this._state=new Lt,this.snapToPixel=!1,this.debug=new If(this);const{canvasElement:s,context:n,enableTransparency:a,snapToPixel:l,antialiasing:g,backgroundColor:p}=e;if(this.__ctx=n??s.getContext("2d",{alpha:a??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=p??this.backgroundColor,this.snapToPixel=l??this.snapToPixel,this.smoothing=g??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(e){}drawImage(e,s,n,a,l,g,p,v,B){if(a===0||l===0)return;if(v===0||B===0)return;if(e.width===0||e.height===0)return;this.__ctx.globalAlpha=this.opacity;const P=[e,s,n,a,l,g,p,v,B].filter(z=>z!==void 0).map(z=>typeof z=="number"&&this.snapToPixel?~~z:z);this.__ctx.drawImage.apply(this.__ctx,P),pe.DrawCallCount++,pe.DrawnImagesCount=1}drawLine(e,s,n,a=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=n.toString(),this.__ctx.moveTo(this.snapToPixel?~~(e.x+qe):e.x,this.snapToPixel?~~(e.y+qe):e.y),this.__ctx.lineTo(this.snapToPixel?~~(s.x+qe):s.x,this.snapToPixel?~~(s.y+qe):s.y),this.__ctx.lineWidth=a,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(e,s,n,a){this.__ctx.save(),this.__ctx.fillStyle=a.toString(),this.__ctx.fillRect(this.snapToPixel?~~(e.x+qe):e.x,this.snapToPixel?~~(e.y+qe):e.y,this.snapToPixel?~~(s+qe):s,this.snapToPixel?~~(n+qe):n),this.__ctx.restore()}drawCircle(e,s,n,a,l){this.__ctx.save(),this.__ctx.beginPath(),a&&(this.__ctx.strokeStyle=a.toString()),l&&(this.__ctx.lineWidth=l),this.__ctx.fillStyle=n.toString(),this.__ctx.arc(this.snapToPixel?~~(e.x+qe):e.x,this.snapToPixel?~~(e.y+qe):e.y,s,0,Math.PI*2),this.__ctx.fill(),a&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(e,s){this.__ctx.translate(this.snapToPixel?~~(e+qe):e,this.snapToPixel?~~(s+qe):s)}rotate(e){this.__ctx.rotate(e)}scale(e,s){this.__ctx.scale(e,s)}getTransform(){throw new Error("Not implemented")}multiply(e){this.__ctx.setTransform(this.__ctx.getTransform().multiply(e.toDOMMatrix()))}addPostProcessor(e){}removePostProcessor(e){}clearPostProcessors(){}updatePostProcessors(e){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(e){this._state.current.material=e}get material(){return this._state.current.material}createMaterial(e){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),pe.clear()}flush(){}dispose(){this.__ctx=void 0}}var li;(function(d){d.Fixed="Fixed",d.FitContainerAndFill="FitContainerAndFill",d.FitScreenAndFill="FitScreenAndFill",d.FitContainerAndZoom="FitContainerAndZoom",d.FitScreenAndZoom="FitScreenAndZoom",d.FitScreen="FitScreen",d.FillScreen="FillScreen",d.FitContainer="FitContainer",d.FillContainer="FillContainer"})(li||(li={}));class bh{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const Bf={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class Ch{constructor(e){var s,n,a,l;this.events=new S,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=j.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullScreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const g=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(g),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new ht,this._unsafeArea=new ht,this.viewport=e.viewport,this.resolution=(s=e.resolution)!==null&&s!==void 0?s:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(n=e.displayMode)!==null&&n!==void 0?n:li.Fixed,this._canvas=e.canvas,this.graphicsContext=e.context,this._antialiasing=(a=e.antialiasing)!==null&&a!==void 0?a:this._antialiasing,this._canvasImageRendering=(l=e.canvasImageRendering)!==null&&l!==void 0?l:this._canvasImageRendering,this._browser=e.browser,this._pixelRatioOverride=e.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const e=this.worldToPageCoordinates(I.Zero);return this.worldToPageCoordinates(R(1,0)).sub(e).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(e){this._pixelRatioOverride=e}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case li.FillContainer:case li.FitContainer:case li.FitContainerAndFill:case li.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(e){this._viewport=e}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(e){this._camera=e}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof Vs&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let a=Math.max(1,this.pixelRatio-.5),l=!1;for(;a>1&&!l;){a=Math.max(1,a-.5);const g=this._resolution.width*a,p=this._resolution.height*a;l=this.graphicsContext.checkIfResolutionSupported({width:g,height:p})}this.pixelRatioOverride=a,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const e=this.viewport.widthUnit==="percent"?"%":"px",s=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+e,this._canvas.style.height=this.viewport.height+s,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof na&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(e){this._antialiasing=e,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(e){return this.enterFullscreen(e)}enterFullscreen(e){if(e){const s=document.getElementById(e);if(s)return s.getAttribute("ex-fullscreen-listener")||(s.setAttribute("ex-fullscreen-listener","true"),s.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),s.requestFullscreen()}return this._canvas.requestFullscreen()}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(e){return{width:e.widthUnit==="percent"?this.canvas.offsetWidth:e.width,height:e.heightUnit==="percent"?this.canvas.offsetHeight:e.height}}pageToScreenCoordinates(e){let s=e.x,n=e.y;this._isFullscreen||(s-=Mt(this._canvas).x,n-=Mt(this._canvas).y);const a=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,g=(window.innerHeight-l)/2;n=(n-g)/l*a.height,s=s/window.innerWidth*a.width}else{const l=window.innerHeight*this.aspectRatio,g=(window.innerWidth-l)/2;s=(s-g)/l*a.width,n=n/window.innerHeight*a.height}return s=s/a.width*this.resolution.width,n=n/a.height*this.resolution.height,s=s-this.contentArea.left,n=n-this.contentArea.top,new I(s,n)}screenToPageCoordinates(e){let s=e.x,n=e.y;const a=this._viewportToPixels(this.viewport);if(s=s/this.resolution.width*a.width,n=n/this.resolution.height*a.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const l=window.innerWidth/this.aspectRatio,g=(window.innerHeight-l)/2;n=n/a.height*l+g,s=s/a.width*window.innerWidth}else{const l=window.innerHeight*this.aspectRatio,g=(window.innerWidth-l)/2;s=s/a.width*l+g,n=n/a.height*window.innerHeight}return this._isFullscreen||(s+=Mt(this._canvas).x,n+=Mt(this._canvas).y),new I(s,n)}screenToWorldCoordinates(e){return e=e.add(R(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(e):e.sub(R(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(e){return this._camera?this._camera.transform.multiply(e):e.add(R(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(e){const s=this.pageToScreenCoordinates(e);return this.screenToWorldCoordinates(s)}worldToPageCoordinates(e){const s=this.worldToScreenCoordinates(e);return this.screenToPageCoordinates(s)}getWorldBounds(){return ht.fromDimension(this.resolution.width,this.resolution.height,I.Half).scale(R(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return ht.fromDimension(this.resolution.width,this.resolution.height,I.Zero,I.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return R(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=this.aspectRatio;let s=0,n=0;window.innerWidth/e<window.innerHeight?(s=window.innerWidth,n=window.innerWidth/e):(s=window.innerHeight*e,n=window.innerHeight),this.viewport={width:s,height:n},this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,I.Zero),this._unsafeArea=ht.fromDimension(this.resolution.width,this.resolution.height,I.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndFill(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(e,s,n){if(this.viewport=n??{width:e,height:s},e/s<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:e*this._contentResolution.width/e,height:e*this._contentResolution.width/e*s/e};const a=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new ht({top:a,left:0,right:this._contentResolution.width,bottom:this.resolution.height-a}),this._unsafeArea=new ht({top:-a,left:0,right:this._contentResolution.width,bottom:this.resolution.height+a})}else{this.resolution={width:s*this._contentResolution.height/s*e/s,height:s*this._contentResolution.height/s};const a=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new ht({top:0,left:a,right:this.resolution.width-a,bottom:this._contentResolution.height}),this._unsafeArea=new ht({top:0,left:-a,right:this.resolution.width+a,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const e=window.innerWidth,s=window.innerHeight;this._computeFitAndZoom(e,s),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const e=this.canvas.parentElement;e.style.overflow="hidden";const{offsetWidth:s,offsetHeight:n}=this.canvas;this._computeFitAndZoom(s,n),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(e,s){const n=this.aspectRatio;let a=0,l=0;e/n<s?(a=e,l=e/n):(a=s*n,l=s);const g=e/a,p=s/l,v=Math.max(g,p),B=a*v,P=l*v;B>e?this.canvas.style.left=-(B-e)/2+"px":this.canvas.style.left="",P>s?this.canvas.style.top=-(P-s)/2+"px":this.canvas.style.top="",this.viewport={width:B,height:P};const z=ht.fromDimension(this.viewport.width,this.viewport.height,I.Zero);if(this.viewport.width>e){const $=(this.viewport.width-e)/this.viewport.width*this.resolution.width;z.top=0,z.left=$/2,z.right=this.resolution.width-$/2,z.bottom=this.resolution.height}if(this.viewport.height>s){const $=(this.viewport.height-s)/this.viewport.height*this.resolution.height;z.top=$/2,z.left=0,z.bottom=this.resolution.height-$/2,z.right=this.resolution.width}this._contentArea=z}_computeFitContainer(){const e=this.aspectRatio;let s=0,n=0,a="pixel",l="pixel";const g=this.canvas.parentElement;g.clientWidth/e<g.clientHeight?(this.canvas.style.width="100%",s=100,a="percent",n=this.canvas.offsetWidth/e):(this.canvas.style.height="100%",n=100,l="percent",s=this.canvas.offsetHeight*e),this.viewport={width:s,widthUnit:a,height:n,heightUnit:l},this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,I.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(e){this.displayMode===li.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===li.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:e.innerWidth,height:e.innerHeight},this.viewport=this.resolution),this._contentArea=ht.fromDimension(this.resolution.width,this.resolution.height,I.Zero),this.displayMode===li.FitScreen&&this._computeFit(),this.displayMode===li.FitContainer&&this._computeFitContainer(),this.displayMode===li.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===li.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===li.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===li.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class to{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function Tf(d){return!!d.playbackState}class qr{static unlock(){return new Promise((s,n)=>{if(qr._UNLOCKED||!to.create())return s(!0);const a=setTimeout(()=>{j.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),s(!1)},200),l=to.create();l.resume().then(()=>{const g=l.createBuffer(1,1,22050),p=l.createBufferSource();let v=!1;p.buffer=g,p.connect(l.destination),p.onended=()=>v=!0,p.start(0),setTimeout(()=>{Tf(p)?(p.playbackState===p.PLAYING_STATE||p.playbackState===p.FINISHED_STATE)&&(qr._UNLOCKED=!0):(l.currentTime>0||v)&&(qr._UNLOCKED=!0)},0),clearTimeout(a),s(!0)},()=>{n()})})}static isUnlocked(){return this._UNLOCKED}}qr._UNLOCKED=!1;class oa extends qs{get ctx(){return this._ctx}constructor(e={}){super(e),this._options=e}clone(){return new oa({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){var s,n;!((s=this._options)===null||s===void 0)&&s.draw&&((n=this._options)===null||n===void 0||n.draw(e)),this._options.cache||this.flagDirty()}}class Eh{}Eh.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class aa{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(e){this._currentState=e}static create(e,s){const n=new aa;n.data=s;for(const a in e.states)n.states.set(a,{name:a,...e.states[a]});for(const a of n.states.values())for(const l of a.transitions)if(l!=="*"&&!n.states.has(l))throw Error(`Invalid state machine, state [${a.name}] has a transition to another state that doesn't exist [${l}]`);return n.currentState=n.startState=n.states.get(e.start),n}in(e){return this.currentState.name===e}go(e,s){var n,a;if(this.currentState.transitions.includes(e)||this.currentState.transitions.includes("*")){const l=this.states.get(e);return this.currentState.onExit&&((n=this.currentState)===null||n===void 0?void 0:n.onExit({to:l.name,data:this.data}))===!1||l!=null&&l.onEnter&&(l==null?void 0:l.onEnter({from:this.currentState.name,eventData:s,data:this.data}))===!1?!1:(this.currentState=l,!((a=this.currentState)===null||a===void 0)&&a.onState&&this.currentState.onState(),!0)}return!1}update(e){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,e)}save(e){localStorage.setItem(e,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(e){const s=JSON.parse(localStorage.getItem(e));this.currentState=this.states.get(s.currentState),this.data=s.data}}class kc{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(e){this._loop=e,this._instance&&(this._instance.loop=e,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(e){e=L(e,0,1),this._volume=e,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(e,this._audioContext.currentTime,.1):this._volumeNode.gain.value=e}get volume(){return this._volume}get duration(){var e;return(e=this._duration)!==null&&e!==void 0?e:this.getTotalPlaybackDuration()}set duration(e){this._duration=e}constructor(e){this._src=e,this._audioContext=to.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new C,this._stateMachine=aa.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:s})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,s.pausedAt*this._playbackRate):this._instance.start(0,s.pausedAt*this._playbackRate,this.duration),s.startedAt=this._audioContext.currentTime-s.pausedAt,s.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:s})=>{s==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:s,data:n})=>{n.pausedAt=(s??0)/this._playbackRate,n.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:s})=>{s.pausedAt=0,s.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:s})=>{s.pausedAt=this._audioContext.currentTime-s.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(e=()=>{}){return this._playStarted=e,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(e){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",e)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:e,startedAt:s}=this._stateMachine.data;return e?e*this._playbackRate:s?(this._audioContext.currentTime-s)*this._playbackRate:0}set playbackRate(e){this._instance.playbackRate.value=this._playbackRate=e}get playbackRate(){return this._instance.playbackRate.value}}class Ih extends ne{set bubbles(e){}get bubbles(){return!1}get _path(){return null}set _path(e){}constructor(e,s="MediaEvent"){super(),this.target=e,this._name=s}stopPropagation(){}action(){}propagate(){}layPath(e){}}class Vr extends Ih{constructor(e,s){super(e,"NativeSoundEvent"),this.track=s}}class Qc extends Ih{constructor(e,s){super(e,"NativeSoundProcessedEvent"),this._processedData=s,this.data=this._processedData}}function Sf(d){try{const e=new Audio,s=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,n=d.match(s)[1];return!!e.canPlayType("audio/"+n)}catch(e){return j.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",e),!1}}const Pf={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Lc{set loop(e){this._loop=e;for(const s of this._tracks)s.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(e){this._volume=e;for(const s of this._tracks)s.volume=this._volume;this.events.emit("volumechange",new Vr(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(e){this._duration=e}get instances(){return this._tracks}get path(){return this._resource.path}set path(e){this._resource.path=e}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}constructor(...e){this.events=new S,this.logger=j.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=to.create(),this._resource=new pt("",Eh.type.arraybuffer);for(const s of e)if(Sf(s)){this.path=s;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",e.join(", ")),this.logger.warn("Attempting to use",e[0]),this.path=e[0])}isLoaded(){return!!this.data}async load(){var e,s;if(this.data)return this.data;const n=await this._resource.load(),a=await this.decodeAudio(n.slice(0));return this._duration=(s=(e=this._duration)!==null&&e!==void 0?e:a==null?void 0:a.duration)!==null&&s!==void 0?s:void 0,this.events.emit("processed",new Qc(this,a)),this.data=a}async decodeAudio(e){try{return await this._audioContext.decodeAudioData(e.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(e){e&&(this._engine=e,this._engine.on("hidden",()=>{e.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{e.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(e=>e.isPlaying())}isPaused(){return this._tracks.some(e=>e.isPaused())}isStopped(){return this._tracks.some(e=>e.isStopped())}play(e){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=e||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const e of this._tracks)e.pause();this.events.emit("pause",new Vr(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const e of this._tracks)e.stop();this.events.emit("stop",new Vr(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._tracks.forEach(s=>{s.playbackRate=this._playbackRate})}seek(e,s=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[s].seek(e)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(e=0){return this._tracks.length?this._tracks[e].getPlaybackPosition():0}getTrackId(e){return this._tracks.indexOf(e)}async _resumePlayback(){if(this.isPaused()){const e=[];for(const s of this._tracks)e.push(s.play().then(()=>(this._tracks.splice(this.getTrackId(s),1),!0)));this.events.emit("resume",new Vr(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(e)}return!0}async _startPlayback(){const e=this._getTrackInstance(this.data),s=await e.play(()=>{this.events.emit("playbackstart",new Vr(this,e)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new Vr(this,e));const n=this.getTrackId(e);return n!==-1&&this._tracks.splice(n,1),s}_getTrackInstance(e){var s;const n=new kc(e);return n.loop=this.loop,n.volume=this.volume,n.duration=(s=this.duration)!==null&&s!==void 0?s:0,n.playbackRate=this._playbackRate,this._tracks.push(n),n}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const Df={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function Bh(d){var e,s;return!!(d!=null&&d.prototype)&&!!(!((s=(e=d==null?void 0:d.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class eo{get resources(){return this._resources}constructor(e){var s;this.events=new S,this.canvas=new oa({filtering:Gt.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new C,e&&(!((s=e.loadables)===null||s===void 0)&&s.length)&&this.addResources(e.loadables)}onInitialize(e){this.engine=e,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await de(500,this.engine.clock)}addResource(e){this._resources.push(e)}addResources(e){let s=0;const n=e.length;for(s;s<n;s++)this.addResource(e[s])}markResourceComplete(){this._numLoaded++}get progress(){const e=this._resources.length;return e>0?L(this._numLoaded,0,e)/e:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(e,s){this._totalTimeMs+=s}onDraw(e){const s=this._totalTimeMs/1e3;e.fillStyle=q.Black.toRGBA(),e.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),e.save(),e.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const n=s*10;e.strokeStyle="white",e.lineWidth=10,e.lineCap="round",e.arc(0,0,40,n,n+Math.PI*3/2),e.stroke(),e.fillStyle="white",e.font="16px sans-serif";const a=(this.progress*100).toFixed(0)+"%",l=e.measureText(a),g=Math.abs(l.actualBoundingBoxLeft)+Math.abs(l.actualBoundingBoxRight),p=Math.abs(l.actualBoundingBoxAscent)+Math.abs(l.actualBoundingBoxDescent);e.fillText(a,-g/2,p/2),e.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async e=>{this.events.emit("loadresourcestart",e),await e.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",e)})}));for(const e of this._resources)e instanceof Lc&&e.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await qr.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}const Rf="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Ff=o(851);class jr extends eo{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const e=document.getElementById("excalibur-play-root");return e&&(this._playButtonRootElement=e),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(e){const s=Array.isArray(e)?{loadables:e}:e;super(s),this._logger=j.getInstance(),this._originalOptions={loadables:[]},this.events=new S,this._playButtonShown=!1,this.logo=Rf,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=q.White,this.backgroundColor="#176BAA",this._imageLoaded=new C,this.suppressPlayButton=!1,this._playButtonStyles=Ff.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let n=document.getElementById("excalibur-play");return n||(n=document.createElement("button")),n.id="excalibur-play",n.textContent=this.playButtonText,n.style.display="none",n},this._originalOptions={...jr._DEFAULT_LOADER_OPTIONS,...s}}onInitialize(e){this.engine=e,this.screen=e.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var e,s;if(this.suppressPlayButton)this.hidePlayButton(),await de(500,(e=this.engine)===null||e===void 0?void 0:e.clock);else{const n=()=>{try{this._positionPlayButton()}catch{}};return!((s=this.engine)===null||s===void 0)&&s.browser&&this.engine.browser.window.on("resize",n),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",l=>{l.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(l=>{const g=p=>{var v;if(p.stopPropagation(),this.hidePlayButton(),!((v=this.engine)===null||v===void 0)&&v.browser&&this.engine.browser.window.off("resize",n),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.goFullScreen(this._originalOptions.fullscreenContainer)}catch(B){this._logger.error("could not go fullscreen",B)}l()};this._playButton.addEventListener("click",g),this._playButton.addEventListener("touchend",g),this._playButton.addEventListener("pointerup",g)})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var e;await de(200,(e=this.engine)===null||e===void 0?void 0:e.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const e=this._image;await this._imageLoaded.promise,await(e==null?void 0:e.decode())}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:e,y:s,width:n,height:a}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const l=this._playButton.clientWidth,g=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${e+n/2-l/2}px`,this._playButtonRootElement.style.top=`${s+a/2-g/2+100}px`)}}}onDraw(e){const s=this.engine.canvasHeight/this.engine.pixelRatio,n=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),e.fillStyle=this.backgroundColor,e.fillRect(0,0,n,s);let a=s/2;const l=Math.min(this.logoWidth,n*.75);let g=n/2-l/2;this.logoPosition&&(g=this.logoPosition.x,a=this.logoPosition.y);const p=Math.floor(l*(this.logoHeight/this.logoWidth)),v=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,g,a,l,p):e.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,g,a-p-20,l,p),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=v;return}let B=g,P=a;this.loadingBarPosition&&(B=this.loadingBarPosition.x,P=this.loadingBarPosition.y),e.lineWidth=2,yn(e,B,P,l,20,10,this.loadingBarColor);const z=l*this.progress,$=5,J=z-$*2,at=20-$*2;yn(e,B+$,P+$,J>10?J:10,at,5,null,this.loadingBarColor),this.engine.screen.antialiasing=v}}jr._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const zc={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Uc{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("2d"))},arrayBufferSupport:function(){const e=new XMLHttpRequest;e.open("GET","/");try{e.responseType="arraybuffer"}catch{return!1}return e.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const e=document.createElement("a").style;return e.cssText="background-color:rgba(150,255,150,.5)",(""+e.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const e=document.createElement("canvas");return!!(e.getContext&&e.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let e=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const s=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],n=this.getBrowserFeatures();for(const a of Object.keys(zc))n[a]?(e+="(%c✓%c)",s.push("font-weight: bold; color: green"),s.push("font-weight: normal; color: inherit")):(e+="(%c✗%c)",s.push("font-weight: bold; color: red"),s.push("font-weight: normal; color: inherit")),e+=" "+zc[a]+`
`;s.unshift(e),console.log.apply(console,s)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let e=!1;for(const s in this._criticalTests)this._criticalTests[s].call(this)||(this.failedTests.push(s),j.getInstance().error("Critical browser feature missing, Excalibur requires:",s),e=!0);if(e)return!1;for(const s in this._warningTest)this._warningTest[s]()||j.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",s);return!0}}var ee;(function(d){d.PreventCollision="PreventCollision",d.Passive="Passive",d.Active="Active",d.Fixed="Fixed"})(ee||(ee={}));class Bs{static create(e,s){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(e)){const a=this._GROUPS.get(e);if(a.mask===s)return a;throw new Error(`Collision group ${e} already exists with a different mask!`)}const n=new js(e,this._CURRENT_BIT,s!==void 0?s:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(e,n),n}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(e){return this._GROUPS.get(e)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}Bs._STARTING_BIT=1,Bs._MAX_GROUPS=32,Bs._CURRENT_GROUP=1,Bs._CURRENT_BIT=Bs._STARTING_BIT,Bs._GROUPS=new Map;class js{constructor(e,s,n){this._name=e,this._category=s,this._mask=n}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(e){const s=this.category&e.mask,n=this.mask&e.category;return s!==0&&n!==0}invert(){const e=Bs.create("~("+this.name+")",~this.mask|0);return e._category=~this.category,e}static combine(e){const s=e.map(l=>l.name).join("+"),a=~e.reduce((l,g)=>g.category|l,0);return Bs.create(s,a)}static collidesWith(e){const s=`collidesWith(${e.map(a=>a.name).join("+")})`,n=e.reduce((a,l)=>l.category|a,0);return Bs.create(s,n)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}js.All=new js("Collide with all groups",-1,-1);class ki{constructor(e,s){this.colliderA=e,this.colliderB=s,this.id=null,this.id=ki.calculatePairHash(e.id,s.id)}static canCollide(e,s){var n,a;if(e.id===s.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.localBounds.hasZeroDimensions()||s.localBounds.hasZeroDimensions())return!1;const l=(n=e==null?void 0:e.owner)===null||n===void 0?void 0:n.get(ge),g=(a=s==null?void 0:s.owner)===null||a===void 0?void 0:a.get(ge);return!(!l||!g||!l.group.canCollide(g.group)||l.collisionType===ee.Fixed&&g.collisionType===ee.Fixed||g.collisionType===ee.PreventCollision||l.collisionType===ee.PreventCollision||!l.isActive||!g.isActive)}get canCollide(){const e=this.colliderA,s=this.colliderB;return ki.canCollide(e,s)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(e){return e===this.colliderA||e===this.colliderB}static calculatePairHash(e,s){return e.value<s.value?`#${e.value}+${s.value}`:`#${s.value}+${e.value}`}}class io{constructor(e,s){this.min=e,this.max=s}overlaps(e){return this.max>e.min&&e.max>this.min}getOverlap(e){return this.overlaps(e)?this.max>e.max?e.max-this.min:this.max-e.min:0}}class Th{constructor(e){this.parent=e,this.parent=e||null,this.data=null,this.bounds=new ht,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class Sh{constructor(e,s=new ht(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=e,this.worldBounds=s,this.root=null,this.nodes={}}_insert(e){if(this.root===null){this.root=e,this.root.parent=null;return}const s=e.bounds;let n=this.root;for(;!n.isLeaf();){const p=n.left,v=n.right,B=n.bounds.getPerimeter(),z=n.bounds.combine(s).getPerimeter(),$=2*z,J=2*(z-B);let at=0;const ct=s.combine(p.bounds);let At,lt;p.isLeaf()?at=ct.getPerimeter()+J:(lt=p.bounds.getPerimeter(),At=ct.getPerimeter(),at=At-lt+J);let gt=0;const Pt=s.combine(v.bounds);if(v.isLeaf()?gt=Pt.getPerimeter()+J:(lt=v.bounds.getPerimeter(),At=Pt.getPerimeter(),gt=At-lt+J),$<at&&$<gt)break;at<gt?n=p:n=v}const a=n.parent,l=new Th(a);l.bounds=s.combine(n.bounds),l.height=n.height+1,a!==null?(a.left===n?a.left=l:a.right=l,l.left=n,l.right=e,n.parent=l,e.parent=l):(l.left=n,l.right=e,n.parent=l,e.parent=l,this.root=l);let g=e.parent;for(;g;){if(g=this._balance(g),!g.left)throw new Error("Parent of current leaf cannot have a null left child"+g);if(!g.right)throw new Error("Parent of current leaf cannot have a null right child"+g);g.height=1+Math.max(g.left.height,g.right.height),g.bounds=g.left.bounds.combine(g.right.bounds),g=g.parent}}_remove(e){if(e===this.root){this.root=null;return}const s=e.parent,n=s.parent;let a;if(s.left===e?a=s.right:a=s.left,n){n.left===s?n.left=a:n.right=a,a.parent=n;let l=n;for(;l;)l=this._balance(l),l.bounds=l.left.bounds.combine(l.right.bounds),l.height=1+Math.max(l.left.height,l.right.height),l=l.parent}else this.root=a,a.parent=null}trackCollider(e){const s=new Th;s.data=e,s.bounds=e.bounds,s.bounds.left-=2,s.bounds.top-=2,s.bounds.right+=2,s.bounds.bottom+=2,this.nodes[e.id.value]=s,this._insert(s)}updateCollider(e){var s;const n=this.nodes[e.id.value];if(!n)return!1;const a=e.bounds;if(!this.worldBounds.contains(a))return j.getInstance().warn("Collider with id "+e.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(e),!1;if(n.bounds.contains(a))return!1;if(this._remove(n),a.left-=this._config.boundsPadding,a.top-=this._config.boundsPadding,a.right+=this._config.boundsPadding,a.bottom+=this._config.boundsPadding,e.owner){const l=(s=e.owner)===null||s===void 0?void 0:s.get(ge);if(l){const g=l.vel.x*32/1e3*this._config.velocityMultiplier,p=l.vel.y*32/1e3*this._config.velocityMultiplier;g<0?a.left+=g:a.right+=g,p<0?a.top+=p:a.bottom+=p}}return n.bounds=a,this._insert(n),!0}untrackCollider(e){const s=this.nodes[e.id.value];s&&(this._remove(s),this.nodes[e.id.value]=null,delete this.nodes[e.id.value])}_balance(e){if(e===null)throw new Error("Cannot balance at null node");if(e.isLeaf()||e.height<2)return e;const s=e.left,n=e.right,a=e,l=s,g=n,p=s.left,v=s.right,B=n.left,P=n.right,z=g.height-l.height;if(z>1)return g.left=a,g.parent=a.parent,a.parent=g,g.parent?g.parent.left===a?g.parent.left=g:g.parent.right=g:this.root=g,B.height>P.height?(g.right=B,a.right=P,P.parent=a,a.bounds=l.bounds.combine(P.bounds),g.bounds=a.bounds.combine(B.bounds),a.height=1+Math.max(l.height,P.height),g.height=1+Math.max(a.height,B.height)):(g.right=P,a.right=B,B.parent=a,a.bounds=l.bounds.combine(B.bounds),g.bounds=a.bounds.combine(P.bounds),a.height=1+Math.max(l.height,B.height),g.height=1+Math.max(a.height,P.height)),g;if(z<-1){if(l.left=a,l.parent=a.parent,a.parent=l,l.parent)if(l.parent.left===a)l.parent.left=l;else{if(l.parent.right!==a)throw"Error rotating Dynamic Tree";l.parent.right=l}else this.root=l;return p.height>v.height?(l.right=p,a.left=v,v.parent=a,a.bounds=g.bounds.combine(v.bounds),l.bounds=a.bounds.combine(p.bounds),a.height=1+Math.max(g.height,v.height),l.height=1+Math.max(a.height,p.height)):(l.right=v,a.left=p,p.parent=a,a.bounds=g.bounds.combine(p.bounds),l.bounds=a.bounds.combine(v.bounds),a.height=1+Math.max(g.height,p.height),l.height=1+Math.max(a.height,v.height)),l}return e}getHeight(){return this.root===null?0:this.root.height}query(e,s){const n=e.bounds,a=l=>{if(l&&l.bounds.overlaps(n))if(l.isLeaf()&&l.data!==e){if(s.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}rayCastQuery(e,s=1/0,n){const a=l=>{if(l&&l.bounds.rayCast(e,s))if(l.isLeaf()){if(n.call(e,l.data))return!0}else return a(l.left)||a(l.right);return!1};a(this.root)}getNodes(){const e=s=>s?[s].concat(e(s.left),e(s.right)):[];return e(this.root)}debug(e){const s=n=>{n&&(n.isLeaf()?n.bounds.draw(e,q.Green):n.bounds.draw(e,q.White),n.left&&s(n.left),n.right&&s(n.right))};s(this.root)}}class Yr{constructor(e,s){this.pos=e,this.dir=s.normalize()}intersect(e){const s=e.begin.sub(this.pos);if(this.dir.cross(e.getSlope())===0&&s.cross(this.dir)!==0)return-1;const n=this.dir.cross(e.getSlope());if(n===0)return-1;const a=s.cross(e.getSlope())/n;if(a>=0){const l=s.cross(this.dir)/n/e.getLength();if(l>=0&&l<=1)return a}return-1}intersectPoint(e){const s=this.intersect(e);return s<0?null:this.getPoint(s)}getPoint(e){return this.pos.add(this.dir.scale(e))}}class ha{constructor(e){this._config=e,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new Sh(e.dynamicTree)}getColliders(){return this._colliders}query(e){const s=[];return e instanceof ht?this._dynamicCollisionTree.query({id:T("collider",-1),owner:null,bounds:e},n=>(s.push(n),!1)):this._dynamicCollisionTree.query({id:T("collider",-1),owner:null,bounds:new ht(e.x,e.y,e.x,e.y)},n=>(s.push(n),!1)),s}rayCast(e,s){var n,a,l;const g=[],p=(n=s==null?void 0:s.maxDistance)!==null&&n!==void 0?n:1/0,v=s==null?void 0:s.collisionGroup,B=v?v.category:(a=s==null?void 0:s.collisionMask)!==null&&a!==void 0?a:js.All.category,P=(l=s==null?void 0:s.searchAllColliders)!==null&&l!==void 0?l:!1;return this._dynamicCollisionTree.rayCastQuery(e,p,z=>{const J=z.owner.get(ge);if(s!=null&&s.ignoreCollisionGroupAll&&J.group===js.All)return!1;const at=(B&J.group.category)!==0;if(J!=null&&J.group&&!at)return!1;const ct=z.rayCast(e,p);if(ct){if(s!=null&&s.filter){if(s.filter(ct)&&(g.push(ct),!P))return!0}else if(g.push(ct),!P)return!0}return!1}),g}track(e){if(!e){j.getInstance().warn("Cannot track null collider");return}if(e instanceof ci){const s=e.getColliders();for(const n of s)n.owner=e.owner,this._colliders.push(n),this._dynamicCollisionTree.trackCollider(n)}else this._colliders.push(e),this._dynamicCollisionTree.trackCollider(e)}untrack(e){if(!e){j.getInstance().warn("Cannot untrack a null collider");return}if(e instanceof ci){const s=e.getColliders();for(const n of s){const a=this._colliders.indexOf(n);a!==-1&&this._colliders.splice(a,1),this._dynamicCollisionTree.untrackCollider(n)}}else{const s=this._colliders.indexOf(e);s!==-1&&this._colliders.splice(s,1),this._dynamicCollisionTree.untrackCollider(e)}}_pairExists(e,s){const n=ki.calculatePairHash(e.id,s.id);return this._pairs.has(n)}broadphase(e,s,n){const a=s/1e3,l=e.filter(p=>{var v,B;const P=(v=p.owner)===null||v===void 0?void 0:v.get(ge);return((B=p.owner)===null||B===void 0?void 0:B.isActive)&&P.collisionType!==ee.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let g;for(let p=0,v=l.length;p<v;p++)g=l[p],this._dynamicCollisionTree.query(g,B=>{if(!this._pairExists(g,B)&&ki.canCollide(g,B)){const P=new ki(g,B);this._pairs.add(P.id),this._collisionPairCache.push(P)}return!1});if(n&&(n.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const p of l){const v=p.owner.get(ge);if(v.collisionType!==ee.Active)continue;const B=v.vel.magnitude*a+v.acc.magnitude*.5*a*a,P=Math.min(p.bounds.height,p.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||B>P/2){n&&n.physics.fastBodies++;const z=v.globalPos.sub(v.oldPos),$=p.center,J=p.getFurthestPoint(v.vel),at=J.sub(z),ct=new Yr(at,v.vel);ct.pos=ct.pos.add(ct.dir.scale(-2*this._config.continuous.surfaceEpsilon));let At,lt=new I(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(ct,B+this._config.continuous.surfaceEpsilon*2,gt=>{if(!this._pairExists(p,gt)&&ki.canCollide(p,gt)){const Pt=gt.rayCast(ct,B+this._config.continuous.surfaceEpsilon*10);if(Pt){const wt=Pt.point.sub(at);wt.magnitude<lt.magnitude&&(lt=wt,At=gt)}}return!1}),At&&I.isValid(lt)){const gt=new ki(p,At);this._pairs.has(gt.id)||(this._pairs.add(gt.id),this._collisionPairCache.push(gt));const Pt=$.sub(J);v.globalPos=at.add(Pt).add(lt).add(ct.dir.scale(10*this._config.continuous.surfaceEpsilon)),p.update(v.transform.get()),n&&n.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(e,s){let n=[];for(let a=0;a<e.length;a++){const l=e[a].collide();if(n=n.concat(l),s&&l.length>0)for(const g of l)s.physics.contacts.set(g.id,g)}return s&&(s.physics.collisions+=n.length),n}update(e){let s=0;const n=e.length;for(let a=0;a<n;a++)this._dynamicCollisionTree.updateCollider(e[a])&&s++;return s}debug(e){this._dynamicCollisionTree.debug(e)}}class mr{constructor(){this.id=T("collider",mr._ID++),this.composite=null,this.events=new S,this.offset=I.Zero}touching(e){return!!this.collide(e)}}mr._ID=0;var so;(function(d){d.Arcade="arcade",d.Realistic="realistic"})(so||(so={}));var In;(function(d){d.None="none",d.VerticalFirst="vertical-first",d.HorizontalFirst="horizontal-first"})(In||(In={}));const Nc={vertical:1,horizontal:2},Gc={horizontal:1,vertical:2},Oc={horizontal:0,vertical:0};var Bn;(function(d){d.DynamicTree="dynamic-tree",d.SparseHashGrid="sparse-hash-grid"})(Bn||(Bn={}));const Ys=()=>({enabled:!0,gravity:R(0,0).clone(),solver:so.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:Bn.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:In.None},realistic:{positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class ci extends mr{set compositeStrategy(e){this._compositeStrategy=e}get compositeStrategy(){return this._compositeStrategy}constructor(e){super(),this._collisionProcessor=new ha({...Ys()}),this._dynamicAABBTree=new Sh({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const s of e)this.addCollider(s)}clearColliders(){this._colliders=[]}addCollider(e){let s;e instanceof ci?(s=e.getColliders(),s.forEach(n=>n.offset.addEqual(e.offset))):s=[e];for(const n of s)n.events.pipe(this.events),n.composite=this,this._colliders.push(n),this._collisionProcessor.track(n),this._dynamicAABBTree.trackCollider(n)}removeCollider(e){e.events.pipe(this.events),e.composite=null,Yt(e,this._colliders),this._collisionProcessor.untrack(e),this._dynamicAABBTree.untrackCollider(e)}getColliders(){return this._colliders}get worldPos(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:I.Zero).add(this.offset)}get center(){var e,s;return((s=(e=this._transform)===null||e===void 0?void 0:e.pos)!==null&&s!==void 0?s:I.Zero).add(this.offset)}get bounds(){var e,s;const n=this.getColliders();return n.reduce((l,g)=>l.combine(g.bounds),(s=(e=n[0])===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new ht().translate(this.worldPos)).translate(this.offset)}get localBounds(){var e,s;const n=this.getColliders();return n.reduce((l,g)=>l.combine(g.localBounds),(s=(e=n[0])===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new ht)}get axes(){const e=this.getColliders();let s=[];for(const n of e)s=s.concat(n.axes);return s}getFurthestPoint(e){const s=this.getColliders(),n=[];for(const g of s)n.push(g.getFurthestPoint(e));let a=n[0],l=-Number.MAX_VALUE;for(const g of n){const p=g.dot(e);p>l&&(a=g,l=p)}return a}getInertia(e){const s=this.getColliders();let n=0;for(const a of s)n+=a.getInertia(e);return n}collide(e){let s=[e];e instanceof ci&&(s=e.getColliders());const n=[];for(const l of s)this._dynamicAABBTree.query(l,g=>(n.push(new ki(l,g)),!1));let a=[];for(const l of n)a=a.concat(l.collide());return a}getClosestLineBetween(e){const s=this.getColliders(),n=[];if(e instanceof ci){const a=e.getColliders();for(const l of s)for(const g of a){const p=l.getClosestLineBetween(g);p&&n.push(p)}}else for(const a of s){const l=e.getClosestLineBetween(a);l&&n.push(l)}if(n.length){let a=n[0].getLength(),l=n[0];for(const g of n){const p=g.getLength();p<a&&(a=p,l=g)}return l}return null}contains(e){const s=this.getColliders();for(const n of s)if(n.contains(e))return!0;return!1}rayCast(e,s){const n=this.getColliders(),a=[];for(const l of n){const g=l.rayCast(e,s);g&&a.push(g)}if(a.length){let l=a[0],g=l.point.dot(e.dir);for(const p of a){const v=e.dir.dot(p.point);v<g&&(l=p,g=v)}return l}return null}project(e){const s=this.getColliders(),n=[];for(const a of s){const l=a.project(e);l&&n.push(l)}if(n.length){const a=new io(n[0].min,n[0].max);for(const l of n)a.min=Math.min(l.min,a.min),a.max=Math.max(l.max,a.max);return a}return null}update(e){if(e){const s=this.getColliders();for(const n of s)n.owner=this.owner,n.update(e)}}debug(e,s,n){const a=this.getColliders();e.save(),e.translate(this.offset.x,this.offset.y);for(const l of a)l.debug(e,s,n);e.restore()}clone(){const e=new ci(this._colliders.map(s=>s.clone()));return e.offset=this.offset.clone(),e}}class Ve{constructor(e,s){this.begin=e,this.end=s}clone(e){const s=e||new Ve(this.begin.clone(),this.end.clone());return s.begin=this.begin.clone(s.begin),s.end=this.end.clone(s.end),s}transform(e,s){const n=s||new Ve(I.Zero,I.Zero);return n.begin=e.multiply(this.begin,n.begin),n.end=e.multiply(this.end,n.end),n}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const e=this.begin,s=this.end,n=e.distance(s);return this._slope=s.sub(e).scale(1/n)}getEdge(){const e=this.begin;return this.end.sub(e)}getLength(){const e=this.begin,s=this.end;return e.distance(s)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new Ve(this.end,this.begin)}below(e){return(this.end.x-this.begin.x)*(e.y-this.begin.y)-(this.end.y-this.begin.y)*(e.x-this.begin.x)>=0}clip(e,s,n=!0){let a=e;n&&(a=a.normalize());const l=a.dot(this.begin)-s,g=a.dot(this.end)-s,p=[];if(l<=0&&p.push(this.begin),g<=0&&p.push(this.end),l*g<0){const v=l/(l-g);p.push(this.begin.add(this.end.sub(this.begin).scale(v)))}return p.length!==2?null:new Ve(p[0],p[1])}distanceToPoint(e,s=!1){const n=e.x,a=e.y,l=this.getLength(),g=this.end.y-this.begin.y,p=this.end.x-this.begin.x,v=(g*n-p*a+this.end.x*this.begin.y-this.end.y*this.begin.x)/l;return s?v:Math.abs(v)}findVectorToPoint(e){const s=this.begin.sub(e),n=this.getSlope();return s.sub(n.scale(s.dot(n)))}findPoint(e=null,s=null){const n=this.slope,a=this.intercept;if(e!==null)return new I(e,n*e+a);if(s!==null)return new I((s-a)/n,s);throw new Error("You must provide an X or a Y value")}hasPoint(){let e,s=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")e=new I(arguments[0],arguments[1]),s=arguments[2]||0;else if(arguments[0]instanceof I)e=arguments[0],s=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const n=e.x-this.begin.x,a=e.y-this.begin.y,l=this.end.x-this.begin.x,g=this.end.y-this.begin.y,p=n*g-a*l;return Math.abs(p)>s?!1:Math.abs(l)>=Math.abs(g)?l>0?this.begin.x<=e.x&&e.x<=this.end.x:this.end.x<=e.x&&e.x<=this.begin.x:g>0?this.begin.y<=e.y&&e.y<=this.end.y:this.end.y<=e.y&&e.y<=this.begin.y}}function Ph(d,e){const n=d.dir(),a=e.dir(),l=n.dot(n),g=a.dot(a);if(l<1e-9&&g<1e-9)return new Ve(d.begin,e.begin);if(l<1e-9){const At=L(a.dot(d.begin.sub(e.begin))/g,0,1),lt=e.begin.add(a.scale(At));return new Ve(d.begin,lt)}if(g<1e-9){const At=L(n.dot(e.begin.sub(d.begin))/l,0,1),lt=d.begin.add(n.scale(At));return new Ve(lt,e.begin)}const p=d.begin.sub(e.begin),v=l,B=g,P=a.dot(p),z=v*B-Math.pow(n.dot(a),2);let $=0,J=0;Math.abs(z)>1e-9?$=L((n.dot(a)*P-B*n.dot(p))/z,0,1):$=L(n.dot(p)/v,0,1),Math.abs(B)>1e-9?J=L((n.dot(a)*$+P)/B,0,1):J=0;const at=d.begin.add(n.scale($)),ct=e.begin.add(a.scale(J));return new Ve(at,ct)}const Ts={PolygonPolygonClosestLine(d,e){const s=d.getSides(),n=e.getSides();let a=Number.MAX_VALUE,l=null;for(let g=0;g<s.length;g++)for(let p=0;p<n.length;p++){const v=Ph(s[g],n[p]),B=v.getLength();B<a&&(a=B,l=v)}return l},PolygonEdgeClosestLine(d,e){const n=e.worldPos.sub(d.worldPos),a=new Yr(d.worldPos,n),l=d.rayCast(a).point.add(a.dir.scale(.1)),g=d.getClosestFace(l),p=e.asLine();return Ph(g.face,p)},PolygonCircleClosestLine(d,e){const s=e.worldPos,n=s.sub(d.worldPos),a=new Yr(d.worldPos,n.normalize()),l=d.rayCast(a).point.add(a.dir.scale(.1)),g=d.getClosestFace(l),p=g.face.begin,v=g.face.getEdge();let B=(v.x*(s.x-p.x)+v.y*(s.y-p.y))/(v.x*v.x+v.y*v.y);B>1?B=1:B<0&&(B=0);const P=Math.sqrt(Math.pow(p.x+v.x*B-s.x,2)+Math.pow(p.y+v.y*B-s.y,2))-e.radius,z=(p.x+v.x*B-s.x)*e.radius/(e.radius+P),$=(p.y+v.y*B-s.y)*e.radius/(e.radius+P);return new Ve(v.scale(B).add(p),new I(s.x+z,s.y+$))},CircleCircleClosestLine(d,e){const n=e.worldPos.sub(d.worldPos),l=d.worldPos.sub(e.worldPos),g=new Yr(d.worldPos,n),p=new Yr(e.worldPos,l),v=d.rayCast(g),B=e.rayCast(p);return new Ve(v.point,B.point)},CircleEdgeClosestLine(d,e){const s=d.worldPos,n=e.asLine(),a=n.begin,l=n.getEdge(),g=a,p=l;let v=(p.x*(s.x-g.x)+p.y*(s.y-g.y))/(p.x*p.x+p.y*p.y);v>1?v=1:v<0&&(v=0);const B=Math.sqrt(Math.pow(g.x+p.x*v-s.x,2)+Math.pow(g.y+p.y*v-s.y,2))-d.radius,P=(g.x+p.x*v-s.x)*d.radius/(d.radius+B),z=(g.y+p.y*v-s.y)*d.radius/(d.radius+B);return new Ve(p.scale(v).add(g),new I(s.x+P,s.y+z))},EdgeEdgeClosestLine(d,e){const s=d.asLine(),n=e.asLine();return Ph(s,n)}};class Ei extends mr{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var e;if(this._radius)return this._radius;const s=this._transform,n=(e=s==null?void 0:s.globalScale)!==null&&e!==void 0?e:I.One;return this._radius=this._naturalRadius*Math.min(n.x,n.y)}set radius(e){var s;const n=this._transform,a=(s=n==null?void 0:n.globalScale)!==null&&s!==void 0?s:I.One;this._naturalRadius=e/Math.min(a.x,a.y),this._localBoundsDirty=!0,this._radius=e}constructor(e){super(),this.offset=I.Zero,this._globalMatrix=st.identity(),this._localBoundsDirty=!0,this.offset=e.offset||I.Zero,this.radius=e.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new Ei({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(e){var s,n;return((n=(s=this._transform)===null||s===void 0?void 0:s.pos)!==null&&n!==void 0?n:this.offset).distance(e)<=this.radius}rayCast(e,s=1/0){var n,a;const l=this.center,g=e.dir,p=e.pos,v=l.sub(p),B=g.scale(v.dot(g)),z=v.sub(B).magnitude;if(z>this.radius)return null;{let $=0;if(O(z,this.radius,1e-4)){if($=-g.dot(p.sub(l)),$>0&&$<s){const J=e.getPoint($);return{point:J,normal:J.sub(l).normalize(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(ge),distance:$}}return null}else{const J=Math.sqrt(Math.pow(g.dot(p.sub(l)),2)-Math.pow(p.sub(l).distance(),2)+Math.pow(this.radius,2)),at=-g.dot(p.sub(l))+J,ct=-g.dot(p.sub(l))-J,At=[];at>=0&&At.push(at),ct>=0&&At.push(ct);const lt=Math.min(...At);if(lt<=s){const gt=e.getPoint(lt);return{point:gt,normal:gt.sub(l).normalize(),collider:this,body:(a=this.owner)===null||a===void 0?void 0:a.get(ge),distance:lt}}return null}}}getClosestLineBetween(e){if(e instanceof Ei)return Ts.CircleCircleClosestLine(this,e);if(e instanceof Ai)return Ts.PolygonCircleClosestLine(e,this).flip();if(e instanceof $i)return Ts.CircleEdgeClosestLine(this,e).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Ei)return ps.CollideCircleCircle(this,e);if(e instanceof Ai)return ps.CollideCirclePolygon(this,e);if(e instanceof $i)return ps.CollideCircleEdge(this,e);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){return this.center.add(e.normalize().scale(this.radius))}getFurthestLocalPoint(e){return e.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new ht(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(e){return e*this.radius*this.radius/2}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(e){const s=[],a=this.center.dot(e);return s.push(a),s.push(a+this.radius),s.push(a-this.radius),new io(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s,n){var a,l,g,p;const{lineWidth:v}={lineWidth:1,...n},B=this._transform,P=(a=B==null?void 0:B.globalScale)!==null&&a!==void 0?a:I.One,z=(l=B==null?void 0:B.globalRotation)!==null&&l!==void 0?l:0,$=(g=B==null?void 0:B.globalPos)!==null&&g!==void 0?g:I.Zero;e.save(),e.translate($.x,$.y),e.rotate(z),e.scale(P.x,P.y),e.drawCircle((p=this.offset)!==null&&p!==void 0?p:I.Zero,this._naturalRadius,q.Transparent,s,v),e.restore()}}class Xr{constructor(e,s,n,a,l,g,p,v){var B,P,z,$,J,at;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=e,this.colliderB=s,this.mtv=n,this.normal=a,this.tangent=l,this.points=g,this.localPoints=p,this.info=v,this.id=ki.calculatePairHash(e.id,s.id),e.composite||s.composite){const ct=((B=e.composite)===null||B===void 0?void 0:B.compositeStrategy)==="separate"?e.id:(z=(P=e.composite)===null||P===void 0?void 0:P.id)!==null&&z!==void 0?z:e.id,At=(($=s.composite)===null||$===void 0?void 0:$.compositeStrategy)==="separate"?s.id:(at=(J=s.composite)===null||J===void 0?void 0:J.id)!==null&&at!==void 0?at:s.id;this.id+="|"+ki.calculatePairHash(ct,At)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(ge)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(ge))}matchAwake(){const e=this.bodyA,s=this.bodyB;e&&s&&e.isSleeping!==s.isSleeping&&(e.isSleeping&&e.collisionType!==ee.Fixed&&s.sleepMotion>=e.wakeThreshold&&(e.isSleeping=!1),s.isSleeping&&s.collisionType!==ee.Fixed&&e.sleepMotion>=s.wakeThreshold&&(s.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(e){if(e!==this.colliderA&&e!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(e===this.colliderA)return this;const s=this.colliderA,n=this.colliderB;return this.colliderB=s,this.colliderA=n,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class Hc{constructor(){this.axis=R(0,0),this.localAxis=R(0,0),this.side=new Ve(R(0,0),R(0,0)),this.localSide=new Ve(R(0,0),R(0,0)),this.point=R(0,0),this.localPoint=R(0,0)}}class $e{static findPolygonPolygonSeparation(e,s){if(s.transform.matrix.determinant()===0)return $e.findPolygonPolygonSeparationDegenerate(e,s);let n=-Number.MAX_VALUE,a=-1,l;const g=s.transform.inverse.multiply(e.transform.matrix,$e._SCRATCH_MATRIX),p=g.getRotation(),v=e.normals,B=e.points,P=s.points;for(let J=0;J<B.length;J++){const at=v[J].rotate(p,$e._ZERO,$e._SCRATCH_NORMAL),ct=g.multiply(B[J],$e._SCRATCH_POINT);let At=Number.MAX_VALUE,lt;for(let gt=0;gt<P.length;gt++){const Pt=at.dot(P[gt].sub(ct,$e._SCRATCH_SUB_POINT));Pt<At&&(At=Pt,lt=P[gt])}At>n&&(n=At,a=J,l=lt)}const z=(a+1)%B.length,$=$e.SeparationPool.get();return $.collider=e,$.separation=n,n>0||(v[a].clone($.localAxis),v[a].rotate(e.transform.rotation,$e._ZERO,$.axis),e.transform.matrix.multiply(B[a],$.side.begin),e.transform.matrix.multiply(B[z],$.side.end),s.transform.matrix.multiply(l,$.point),$.sideId=a,l.clone($.localPoint),B[a].clone($.localSide.begin),B[z].clone($.localSide.end)),$}static findCirclePolygonSeparation(e,s){const n=s.axes,l=s.center.sub(e.worldPos),g=s.getFurthestPoint(l.negate());n.push(g.sub(e.worldPos).normalize());let p=Number.MAX_VALUE,v=null,B=-1;for(let P=0;P<n.length;P++){const z=s.project(n[P]),$=e.project(n[P]),J=z.getOverlap($);if(J<=0)return null;J<p&&(p=J,v=n[P],B=P)}return B<0?null:v.normalize().scale(p)}static findPolygonPolygonSeparationDegenerate(e,s){let n=-Number.MAX_VALUE,a=null,l=null,g=-1,p=null;const v=e.getSides(),B=e.getLocalSides();for(let P=0;P<v.length;P++){const z=v[P],$=z.normal(),J=s.getFurthestPoint($.negate()),at=z.distanceToPoint(J,!0);at>n&&(n=at,a=z,l=$,g=P,p=J)}return{collider:e,separation:l?n:99,axis:l,side:a,localSide:B[g],sideId:g,point:p,localPoint:l?s.getFurthestLocalPoint(l.negate()):null}}}$e.SeparationPool=new Mr(()=>new Hc,d=>d,500),$e._ZERO=R(0,0),$e._SCRATCH_POINT=R(0,0),$e._SCRATCH_SUB_POINT=R(0,0),$e._SCRATCH_NORMAL=R(0,0),$e._SCRATCH_MATRIX=st.identity(),$e.SeparationPool.disableWarnings=!0;const Mf=I.Zero,kf=I.Zero,Qf=st.identity(),ps={CollideCircleCircle(d,e){const s=d.worldPos,n=e.worldPos,a=d.radius+e.radius,l=s.distance(n);if(l>a)return[];const g=a-l,p=n.sub(s).normalize(),v=p.perpendicular(),B=p.scale(g),P=d.getFurthestPoint(p),z=d.getFurthestLocalPoint(p),$={collider:d,separation:g,axis:p,point:P};return[new Xr(d,e,B,p,v,[P],[z],$)]},CollideCirclePolygon(d,e){var s,n;let a=$e.findCirclePolygonSeparation(d,e);if(!a)return[];a=a.dot(e.center.sub(d.center))<0?a.negate():a;const g=d.getFurthestPoint(a),v=((n=(s=d.owner)===null||s===void 0?void 0:s.get(Ot))!==null&&n!==void 0?n:new Ot).applyInverse(g),B=a.normalize(),P={collider:d,separation:-a.magnitude,axis:B,point:g,localPoint:v,side:e.findSide(B.negate()),localSide:e.findLocalSide(B.negate())};return[new Xr(d,e,a,B,B.perpendicular(),[g],[v],P)]},CollideCircleEdge(d,e){const s=d.center,n=e.asLine(),a=n.end.sub(n.begin),l=a.dot(n.end.sub(s)),g=a.dot(s.sub(n.begin)),p=e.asLine(),v=e.asLocalLine();if(g<=0){const lt=n.begin.sub(s),gt=lt.dot(lt);if(gt>d.radius*d.radius)return[];const Pt=lt.normalize(),wt=d.radius-Math.sqrt(gt),Qt={collider:d,separation:wt,axis:Pt,point:p.begin,side:p,localSide:v};return[new Xr(d,e,Pt.scale(wt),Pt,Pt.perpendicular(),[p.begin],[v.begin],Qt)]}if(l<=0){const lt=n.end.sub(s),gt=lt.dot(lt);if(gt>d.radius*d.radius)return[];const Pt=lt.normalize(),wt=d.radius-Math.sqrt(gt),Qt={collider:d,separation:wt,axis:Pt,point:p.end,side:p,localSide:v};return[new Xr(d,e,Pt.scale(wt),Pt,Pt.perpendicular(),[p.end],[v.end],Qt)]}const B=a.dot(a),P=n.begin.scale(l).add(n.end.scale(g)).scale(1/B),z=s.sub(P),$=z.dot(z);if($>d.radius*d.radius)return[];let J=a.perpendicular();J.dot(s.sub(n.begin))<0&&(J.x=-J.x,J.y=-J.y),J=J.normalize();const at=d.radius-Math.sqrt($),ct=J.scale(at),At={collider:d,separation:at,axis:J,point:P,side:p,localSide:v};return[new Xr(d,e,ct,J.negate(),J.negate().perpendicular(),[P],[P.sub(e.worldPos)],At)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(d,e){var s;const n=d.center,l=e.center.sub(n).normalize(),g=new Ai({points:[e.begin,e.end,e.end.add(l.scale(100)),e.begin.add(l.scale(100))],offset:e.offset});g.owner=e.owner,((s=e.owner)===null||s===void 0?void 0:s.get(Ot))&&g.update(e.owner.get(Ot).get());const v=this.CollidePolygonPolygon(d,g);return v.length&&(v[0].colliderB=e,v[0].id=ki.calculatePairHash(d.id,e.id)),v},CollidePolygonPolygon(d,e){const s=$e.findPolygonPolygonSeparation(d,e);if(s.separation>0)return[];const n=$e.findPolygonPolygonSeparation(e,d);if(n.separation>0)return[];const a=s.separation>n.separation?s:n,l=a.collider===d?e:d,g=a.collider===d?d:e,p=l.transform.inverse.multiply(g.transform.matrix,Qf),v=p.getRotation(),B=g.normals[a.sideId].rotate(v,Mf,kf);let P=Number.MAX_VALUE,z=0;for(let lt=0;lt<l.normals.length;lt++){const gt=B.dot(l.normals[lt]);gt<P&&(P=gt,z=lt)}const $=a.localSide.transform(p),J=a.localAxis.perpendicular().negate().rotate(v),ct=new Ve(l.points[z],l.points[(z+1)%l.points.length]).clip(J.negate(),-J.dot($.begin),!1);let At=null;if(ct&&(At=ct.clip(J,J.dot($.end),!1)),At){const lt=[],gt=[],Pt=At.getPoints();for(let jt=0;jt<Pt.length;jt++){const It=Pt[jt];$.below(It)&&(lt.push(It),gt.push(l.transform.apply(It)))}let wt=a.axis,Qt=wt.perpendicular();return e.center.sub(d.center).dot(wt)<0&&(wt=wt.negate(),Qt=wt.perpendicular()),[new Xr(d,e,wt.scale(-a.separation),wt,Qt,gt,lt,a)]}return[]},FindContactSeparation(d,e){var s,n,a,l;const g=d.colliderA,p=(n=(s=d.bodyA)===null||s===void 0?void 0:s.transform)!==null&&n!==void 0?n:new Ot,v=d.colliderB,B=(l=(a=d.bodyB)===null||a===void 0?void 0:a.transform)!==null&&l!==void 0?l:new Ot;if(g instanceof Ei&&v instanceof Ei){const P=g.radius+v.radius,z=p.pos.distance(B.pos);return-(P-z)}if(g instanceof Ai&&v instanceof Ai&&d.info.localSide){let P,z;return d.info.collider===g?(P=new Ve(p.apply(d.info.localSide.begin),p.apply(d.info.localSide.end)),z=B.apply(e)):(P=new Ve(B.apply(d.info.localSide.begin),B.apply(d.info.localSide.end)),z=p.apply(e)),P.distanceToPoint(z,!0)}if(g instanceof Ai&&v instanceof Ei||v instanceof Ai&&g instanceof Ei){const P=p.apply(e);if(d.info.side)return d.info.side.distanceToPoint(P,!0)}if(g instanceof $i&&v instanceof Ai||v instanceof $i&&g instanceof Ai){let P;if(d.info.collider===g?P=B.apply(e):P=p.apply(e),d.info.side)return d.info.side.distanceToPoint(P,!0)}if(g instanceof Ei&&v instanceof $i||v instanceof Ei&&g instanceof $i){const P=B.apply(e);let z;g instanceof Ei&&(z=g.getFurthestPoint(d.normal));const $=P.distance(z);if(d.info.side)return $>0?-$:0}return 0}};class $i extends mr{constructor(e){var s;super(),this._globalMatrix=st.identity(),this.begin=e.begin||I.Zero,this.end=e.end||I.Zero,this.offset=(s=e.offset)!==null&&s!==void 0?s:I.Zero}clone(){return new $i({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var e;const s=this._transform;return(e=s==null?void 0:s.globalPos.add(this.offset))!==null&&e!==void 0?e:this.offset}get center(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.average(s)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const e=this._getTransformedBegin(),s=this._getTransformedEnd(),n=e.distance(s);return s.sub(e).scale(1/n)}getLength(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return e.distance(s)}contains(){return!1}rayCast(e,s=1/0){var n;const a=this._getTransformedBegin().sub(e.pos);if(e.dir.cross(this.getSlope())===0&&a.cross(e.dir)!==0)return null;const l=e.dir.cross(this.getSlope());if(l===0)return null;const g=a.cross(this.getSlope())/l;if(g>=0&&g<=s){const p=a.cross(e.dir)/l/this.getLength();if(p>=0&&p<=1)return{distance:g,normal:this.asLine().normal(),collider:this,body:(n=this.owner)===null||n===void 0?void 0:n.get(ge),point:e.getPoint(g)}}return null}getClosestLineBetween(e){if(e instanceof Ei)return Ts.CircleEdgeClosestLine(e,this);if(e instanceof Ai)return Ts.PolygonEdgeClosestLine(e,this).flip();if(e instanceof $i)return Ts.EdgeEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Ei)return ps.CollideCircleEdge(e,this);if(e instanceof Ai)return ps.CollidePolygonEdge(e,this);if(e instanceof $i)return ps.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this._getTransformedBegin(),n=this._getTransformedEnd();return e.dot(s)>0?s:n}_boundsFromBeginEnd(e,s,n=10){return new ht(Math.min(e.x,s.x)-n,Math.min(e.y,s.y)-n,Math.max(e.x,s.x)+n,Math.max(e.y,s.y)+n)}get bounds(){const e=this._getTransformedBegin(),s=this._getTransformedEnd();return this._boundsFromBeginEnd(e,s)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new Ve(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new Ve(this.begin,this.end)}get axes(){const s=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),n=[];return n.push(s),n.push(s.negate()),n.push(s.normal()),n.push(s.normal().negate()),n}getInertia(e){const s=this.end.sub(this.begin).distance()/2;return e*s*s}update(e){var s;this._transform=e,((s=e.matrix)!==null&&s!==void 0?s:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(e){const s=[],n=[this._getTransformedBegin(),this._getTransformedEnd()],a=n.length;for(let l=0;l<a;l++)s.push(n[l].dot(e));return new io(Math.min.apply(Math,s),Math.max.apply(Math,s))}debug(e,s){const n=this._getTransformedBegin(),a=this._getTransformedEnd();e.drawLine(n,a,s,2),e.drawCircle(n,2,s),e.drawCircle(a,2,s)}}class di{static registerGraphicsContext(e){di._ctx=e}static draw(e){this._drawCalls.push(e)}static drawPoint(e,s){di.draw(n=>{n.debug.drawPoint(e,s)})}static drawLine(e,s,n){di.draw(a=>{a.debug.drawLine(e,s,n)})}static drawLines(e,s){e.length>1&&di.draw(n=>{for(let a=0;a<e.length-1;a++)n.debug.drawLine(e[a],e[a+1],s)})}static drawText(e,s){di.draw(n=>{n.debug.drawText(e,s)})}static drawPolygon(e,s){e.length>1&&di.draw(n=>{const a=e[0],l=[...e,a];for(let g=0;g<l.length-1;g++)n.debug.drawLine(l[g],l[g+1],s)})}static drawCircle(e,s,n){const{color:a,strokeColor:l,width:g}={color:q.Black,strokeColor:void 0,width:void 0,...n};di.draw(p=>{p.drawCircle(e,s,a,l,g)})}static drawBounds(e,s){di.draw(n=>{n.debug.drawRect(e.left,e.top,e.width,e.height,s)})}static drawRay(e,s){const{distance:n,color:a}={color:q.Blue,distance:10,...s};di.draw(l=>{const g=e.pos,p=e.pos.add(e.dir.scale(n));l.debug.drawLine(g,p,{color:a})})}static flush(e){e.save(),e.z=di.z;for(const s of di._drawCalls)s(e);e.restore(),di.clear()}static clear(){di._drawCalls.length=0}}di._drawCalls=[],di.z=1/0;class Ai extends mr{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(e){if(e.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=e,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const e=[];for(let s=0;s<this._points.length;s++)e.push(this._points[(s+1)%this._points.length].sub(this._points[s]).normal());this._normals=e}get points(){return this._points}get transform(){return this._transform}constructor(e){var s;super(),this._logger=j.getInstance(),this._transform=new as,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(s=e.offset)!==null&&s!==void 0?s:I.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=e.points,this.isConvex()||e.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(e){this._isCounterClockwiseWinding(e)||e.reverse()}_isCounterClockwiseWinding(e){let s=0;for(let n=0;n<e.length;n++)s+=(e[(n+1)%e.length].x-e[n].x)*(e[(n+1)%e.length].y+e[n].y);return s<0}isConvex(){if(this.points.length<3)return!1;let e=this.points[this.points.length-2],s=this.points[this.points.length-1],n=Math.atan2(s.y-e.y,s.x-e.x),a=0,l=0,g=0;for(const[p,v]of this.points.entries()){if(e=s,a=n,s=v,n=Math.atan2(s.y-e.y,s.x-e.x),e.equals(s))return!1;let B=n-a;if(B<=-Math.PI?B+=Math.PI*2:B>Math.PI&&(B-=Math.PI*2),p===0){if(B===0)return!1;l=B>0?1:-1}else if(l*B<=0)return!1;g+=B}return Math.abs(Math.round(g/(Math.PI*2)))===1}tessellate(){const e=[];for(let s=1;s<this.points.length-2;s++)e.push([this.points[0],this.points[s+1],this.points[s+2]]);return e.push([this.points[0],this.points[1],this.points[2]]),new ci(e.map(s=>Ii.Polygon(s)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const e=[],s=[...this.points].reverse();let n=s.length;function a(z){return z===0?n-1:z-1}function l(z){return z===n-1?0:z+1}function g(z){const $=a(z),J=l(z),at=s[$],ct=s[z],At=s[J],lt=at.sub(ct),gt=At.sub(ct);return!(lt.cross(gt)<0)}const p=s.map((z,$)=>g($));function v(z,$,J,at){const ct=J.sub($),At=at.sub(J),lt=$.sub(at),gt=z.sub($),Pt=z.sub(J),wt=z.sub(at),Qt=ct.cross(gt),jt=At.cross(Pt),It=lt.cross(wt);return!(Qt>0||jt>0||It>0)}function B(){for(let z=0;z<n;z++)if(p[z]){const $=a(z),J=l(z),at=s[$],ct=s[z],At=s[J];let lt=!0;for(let gt=0;gt<n;gt++){if(gt===z||gt===$||gt===J)continue;const Pt=s[gt];if(v(Pt,at,ct,At)){lt=!1;break}}if(lt)return z}for(let z=0;z<n;z++)if(p[z])return z;return 0}function P(z){const $=a(z),J=l(z),at=s[$],ct=s[z],At=s[J];e.push([at,ct,At]),s.splice(z,1),p.splice(z,1),n--}for(;n>3;){const z=B();P(z);for(let $=0;$<n;$++)p[$]=g($)}return e.push([s[0],s[1],s[2]]),new ci(e.map(z=>Ii.Polygon(z,I.Zero,!0)))}clone(){return new Ai({offset:this.offset.clone(),points:this.points.map(e=>e.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const e=this.points,s=e.length;this._transformedPoints.length=0;for(let n=0;n<s;n++)this._transformedPoints[n]=this._transform.apply(e[n].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const e=[],s=this.getTransformedPoints(),n=s.length;for(let a=0;a<n;a++)e.push(new Ve(s[a],s[(a+1)%n]));this._sides=e,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const e=[],s=this.points,n=s.length;for(let a=0;a<n;a++)e.push(new Ve(s[a],s[(a+1)%n]));this._localSides=e,this._localSidesDirty=!1}return this._localSides}findSide(e){const s=this.getSides();let n=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const g=s[l],v=g.normal().dot(e);v>a&&(n=g,a=v)}return n}findLocalSide(e){const s=this.getLocalSides();let n=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const g=s[l],v=g.normal().dot(e);v>a&&(n=g,a=v)}return n}get axes(){const e=[],s=this.getSides();for(let n=0;n<s.length;n++)e.push(s[n].normal());return e}update(e){e&&(e.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(s=>R(s.x*Q(this._transform.scale.x),s.y*Q(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(e){const s=this._transform.applyInverse(e),n=new Yr(s,new I(1,0));let a=0;const l=this.getLocalSides();for(let g=0;g<l.length;g++){const p=l[g];n.intersect(p)>=0&&a++}return a%2!==0}getClosestLineBetween(e){if(e instanceof Ei)return Ts.PolygonCircleClosestLine(this,e);if(e instanceof Ai)return Ts.PolygonPolygonClosestLine(this,e);if(e instanceof $i)return Ts.PolygonEdgeClosestLine(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}collide(e){if(e instanceof Ei)return ps.CollideCirclePolygon(e,this);if(e instanceof Ai)return ps.CollidePolygonPolygon(this,e);if(e instanceof $i)return ps.CollidePolygonEdge(this,e);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof e}`)}getFurthestPoint(e){const s=this.getTransformedPoints();let n=null,a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const g=e.dot(s[l]);g>a&&(a=g,n=s[l])}return n}getFurthestLocalPoint(e){const s=this.points;let n=s[0],a=-Number.MAX_VALUE;for(let l=0;l<s.length;l++){const g=e.dot(s[l]);g>a&&(a=g,n=s[l])}return n}getClosestFace(e){const s=this.getSides();let n=Number.POSITIVE_INFINITY,a=-1,l=-1;for(let g=0;g<s.length;g++){const p=s[g].distanceToPoint(e);p<n&&(n=p,a=g,l=p)}return a!==-1?{distance:s[a].normal().scale(l),face:s[a]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=ht.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(e){if(this._cachedMass===e&&this._cachedInertia)return this._cachedInertia;let s=0,n=0;const a=this.points;for(let l=0;l<a.length;l++){const g=(l+1)%a.length,p=a[g].cross(a[l]);s+=p*(a[l].dot(a[l])+a[l].dot(a[g])+a[g].dot(a[g])),n+=p}return this._cachedMass=e,this._cachedInertia=e/6*(s/n)}rayCast(e,s=1/0){var n;const a=this.getSides(),l=a.length;let g=Number.MAX_VALUE,p,v=-1;for(let B=0;B<l;B++){const P=e.intersect(a[B]);P>=0&&P<g&&P<=s&&(g=P,p=a[B],v=B)}return v>=0?{collider:this,distance:g,body:(n=this.owner)===null||n===void 0?void 0:n.get(ge),point:e.getPoint(g),normal:p.normal()}:null}project(e){const s=this.getTransformedPoints(),n=s.length;let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;for(let g=0;g<n;g++){const p=s[g].dot(e);a=Math.min(a,p),l=Math.max(l,p)}return new io(a,l)}debug(e,s,n){const a=this.getTransformedPoints();di.drawPolygon(a,{color:s})}}class Ii{static Box(e,s,n=I.Half,a=I.Zero){return new Ai({points:new ht(-e*n.x,-s*n.y,e-e*n.x,s-s*n.y).getPoints(),offset:a})}static Polygon(e,s=I.Zero,n=!1){return new Ai({points:e,offset:s,suppressConvexWarning:n})}static Circle(e,s=I.Zero){return new Ei({radius:e,offset:s})}static Edge(e,s){return new $i({begin:e,end:s})}static Capsule(e,s,n=I.Zero){const a=j.getInstance();return e===s&&a.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),s>=e?new ci([Ii.Circle(e/2,R(0,-s/2+e/2).add(n)),Ii.Box(e,s-e,I.Half,n),Ii.Circle(e/2,R(0,s/2-e/2).add(n))]):new ci([Ii.Circle(s/2,R(-e/2+s/2,0).add(n)),Ii.Box(e-s,s,I.Half,n),Ii.Circle(s/2,R(e/2-s/2,0).add(n))])}}class Je extends Hi{constructor(e){super(),this.events=new S,this.$colliderAdded=new hi,this.$colliderRemoved=new hi,this._collidersToRemove=[],this.set(e)}get(){return this._collider}set(e){return this.clear(),e&&(this._collider=e,this._collider.owner=this.owner,e.events.pipe(this.events),this.$colliderAdded.notifyAll(e),this.update()),e}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const e of this._collidersToRemove)e.events.unpipe(this.events),this.$colliderRemoved.notifyAll(e),e.owner=null}clone(){return new Je(this._collider.clone())}get bounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.bounds)!==null&&s!==void 0?s:new ht}get localBounds(){var e,s;return(s=(e=this._collider)===null||e===void 0?void 0:e.localBounds)!==null&&s!==void 0?s:new ht}update(){var e;const s=(e=this.owner)===null||e===void 0?void 0:e.get(Ot);this._collider&&(this._collider.owner=this.owner,s&&this._collider.update(s.get()))}collide(e){let s=this._collider,n=e._collider;if(!s||!n)return[];let a=!1;if(n instanceof ci&&(s=n,n=this._collider,a=!0),this._collider){const l=s.collide(n);return l?(a&&l.forEach(g=>{g.mtv=g.mtv.negate(),g.normal=g.normal.negate(),g.tangent=g.normal.perpendicular(),g.colliderA=this._collider,g.colliderB=e._collider}),l):[]}return[]}onAdd(e){this._collider&&this.update(),this.events.on("precollision",s=>{const n=s;e.events.emit("precollision",new Hr(n.self,n.other,n.side,n.intersection,n.contact)),e instanceof Qi&&e.onPreCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("postcollision",s=>{const n=s;e.events.emit("postcollision",new Wr(n.self,n.other,n.side,n.intersection,n.contact)),e instanceof Qi&&e.onPostCollisionResolve(n.self,n.other,n.side,n.contact)}),this.events.on("collisionstart",s=>{const n=s;e.events.emit("collisionstart",new Jn(n.self,n.other,n.side,n.contact)),e instanceof Qi&&e.onCollisionStart(n.self,n.other,n.side,n.contact)}),this.events.on("collisionend",s=>{const n=s;e.events.emit("collisionend",new Kn(n.self,n.other,n.side,n.lastContact)),e instanceof Qi&&e.onCollisionEnd(n.self,n.other,n.side,n.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(e,s,n=I.Half,a=I.Zero){const l=Ii.Box(e,s,n,a);return this.set(l)}usePolygonCollider(e,s=I.Zero){const n=Ii.Polygon(e,s);return this.set(n)}useCircleCollider(e,s=I.Zero){const n=Ii.Circle(e,s);return this.set(n)}useEdgeCollider(e,s){const n=Ii.Edge(e,s);return this.set(n)}useCompositeCollider(e){return this.set(new ci(e))}}var Wi;(function(d){d.Rotation="rotation",d.X="x",d.Y="y"})(Wi||(Wi={}));class ge extends Hi{constructor(e){var s,n,a;super(),this.dependencies=[Ot,ve],this.id=T("body",ge._ID++),this.events=new S,this.oldTransform=new as,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=ee.PreventCollision,this.group=js.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=I.Zero,this.oldVel=new I(0,0),this.oldAcc=I.Zero,this._impulseScratch=R(0,0),this._distanceFromCenterScratch=R(0,0),e?(this.collisionType=(s=e.type)!==null&&s!==void 0?s:this.collisionType,this.group=(n=e.group)!==null&&n!==void 0?n:this.group,this.useGravity=(a=e.useGravity)!==null&&a!==void 0?a:this.useGravity,this._bodyConfig={...Ys().bodies,...e.config}):this._bodyConfig={...Ys().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=ge._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(e){this._bodyConfig={...Ys().bodies,...e},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(e){ge._DEFAULT_CONFIG=e}get mass(){return this._mass}set mass(e){this._mass=e,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===ee.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(e){this.isSleeping=e}set isSleeping(e){this._sleeping=e,e?(this.vel=I.Zero,this.acc=I.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const e=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),s=this._bodyConfig.sleepBias;this.sleepMotion=s*this.sleepMotion+(1-s)*e,this.sleepMotion=L(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const e=this.owner.get(Je);if(e){e.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),e.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const s=e.get();if(s)return this._cachedInertia=s.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===ee.Fixed?0:1/this.inertia}get active(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get isActive(){var e;return!!(!((e=this.owner)===null||e===void 0)&&e.isActive)}get center(){return this.globalPos}onAdd(e){var s,n;this.transform=(s=this.owner)===null||s===void 0?void 0:s.get(Ot),this.motion=(n=this.owner)===null||n===void 0?void 0:n.get(ve)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get globalPos(){return this.transform.globalPos}set globalPos(e){this.transform.globalPos=e}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e}get torque(){return this.motion.torque}set torque(e){this.motion.torque=e}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(e){this.transform.globalRotation=e}get scale(){return this.transform.globalScale}set scale(e){this.transform.globalScale=e}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(e){this.motion.scaleFactor=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}applyImpulse(e,s){if(this.collisionType!==ee.Active)return;const n=s.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(Wi.X)>-1&&(n.x=0),this.limitDegreeOfFreedom.indexOf(Wi.Y)>-1&&(n.y=0),this.vel.addEqual(n),!this.limitDegreeOfFreedom.includes(Wi.Rotation)){const a=e.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*a.cross(s)}}applyLinearImpulse(e){if(this.collisionType!==ee.Active)return;const s=e.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(Wi.X)&&(s.x=0),this.limitDegreeOfFreedom.includes(Wi.Y)&&(s.y=0),this.vel=this.vel.add(s)}applyAngularImpulse(e,s){if(this.collisionType===ee.Active&&!this.limitDegreeOfFreedom.includes(Wi.Rotation)){const n=e.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*n.cross(s)}}captureOldTransform(){this.__oldTransformCaptured=!0;const e=this.transform.get();e.clone(this.oldTransform),this.oldTransform.parent=e.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}ge._ID=0,ge._DEFAULT_CONFIG={...Ys().bodies};class ro extends qs{constructor(e){super(e),this.width=e.width,this.height=e.height,this.rasterize()}clone(){return new ro({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.color&&e.fillRect(0,0,this.width,this.height),this.strokeColor&&e.strokeRect(0,0,this.width,this.height)}}class la extends qs{get radius(){return this._radius}set radius(e){this._radius=e,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(e){var s,n,a;super(e),this._radius=0;const l=(s=e.lineWidth)!==null&&s!==void 0?s:e.strokeColor?1:0;this.padding=(n=e.padding)!==null&&n!==void 0?n:2+l/2,this.radius=e.radius,this.filtering=(a=e.filtering)!==null&&a!==void 0?a:Gt.Blended,this.rasterize()}clone(){return new la({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){this.radius>0&&(e.beginPath(),e.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&e.fill(),this.strokeColor&&e.stroke())}}class vr extends Hi{constructor(e){var s,n;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(s=e==null?void 0:e.useColliderShape)!==null&&s!==void 0?s:this.useColliderShape,this.useGraphicsBounds=(n=e==null?void 0:e.useGraphicsBounds)!==null&&n!==void 0?n:this.useGraphicsBounds,this.localBounds=e==null?void 0:e.localBounds}}class Ce{static CreateReversibleEasingFunction(e){return(s,n,a,l)=>a<n?n-(e(s,a,n,l)-a):e(s,n,a,l)}static CreateVectorEasingFunction(e){return(s,n,a,l)=>new I(e(s,n.x,a.x,l),e(s,n.y,a.y,l))}}Ce.Linear=Ce.CreateReversibleEasingFunction((d,e,s,n)=>(s=s-e,s*d/n+e)),Ce.EaseInQuad=Ce.CreateReversibleEasingFunction((d,e,s,n)=>(s=s-e,d/=n,s*d*d+e)),Ce.EaseOutQuad=Ce.CreateReversibleEasingFunction((d,e,s,n)=>(s=s-e,d/=n,-s*d*(d-2)+e)),Ce.EaseInOutQuad=Ce.CreateReversibleEasingFunction((d,e,s,n)=>(s=s-e,d/=n/2,d<1?s/2*d*d+e:(d--,-s/2*(d*(d-2)-1)+e))),Ce.EaseInCubic=Ce.CreateReversibleEasingFunction((d,e,s,n)=>(s=s-e,d/=n,s*d*d*d+e)),Ce.EaseOutCubic=Ce.CreateReversibleEasingFunction((d,e,s,n)=>(s=s-e,d/=n,d--,s*(d*d*d+1)+e)),Ce.EaseInOutCubic=Ce.CreateReversibleEasingFunction((d,e,s,n)=>(s=s-e,d/=n/2,d<1?s/2*d*d*d+e:(d-=2,s/2*(d*d*d+2)+e)));class Wc{constructor(e){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=e}add(e){this._actions.push(e)}remove(e){const s=this._actions.indexOf(e);this._actions.splice(s,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const e=this._actions.length;for(let s=0;s<e;s++)this._actions[s].reset();this._completedActions=[]}update(e){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new vh(this._currentAction,this._entity))),this._currentAction.update(e),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new wh(this._currentAction,this._entity));const s=this._actions.shift();s&&this._completedActions.push(s)}}}let Lf=0;function ye(){return Lf++}class qc{constructor(e,s,n){this.id=ye(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new ao(e),this._actionQueue=this._repeatContext.getQueue(),this._repeat=n,this._originalRepeat=n,this._repeatBuilder(this._repeatContext),this._repeat--}update(e){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(e)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class Vc{constructor(e,s){this.id=ye(),this._stopped=!1,this._repeatBuilder=s,this._repeatContext=new ao(e),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(e){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(e))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function jc(d,e,s){return(1-s)*d+e*s}function Dh(d,e,s,n){const a=(d-e+k)%k>=Math.PI,l=Math.abs(e-d),g=k-l;let p=0,v=0;l>g?(p=g,v=l):(p=l,v=g);let B=0,P=1;switch(s){case W.ShortestPath:B=p,P=a?1:-1;break;case W.LongestPath:B=v,P=a?-1:1;break;case W.Clockwise:P=1,B=a?p:v;break;case W.CounterClockwise:P=-1,B=a?v:p;break}return d+P*(B*n)}function no(d,e,s){return d.scale(1-s).add(e.scale(s))}function Yc(d,e,s){return(s-d)/(e-d)}function Xc(d,e,s){const n=s.sub(d),a=e.sub(d),l=n.x/a.x,g=n.y/a.y;return Math.min(l,g)}function Ss(d,e,s,n,a){const l=Yc(d,e,a);return jc(s,n,l)}function zf(d,e,s,n,a){const l=Xc(d,e,a);return no(s,n,l)}function Zc(d){return d.offset instanceof I&&typeof d.duration=="number"}class $c{constructor(e,s){var n;if(this.entity=e,this.id=ye(),this._started=!1,this._stopped=!1,this._easing=Ce.Linear,this._offset=s.offset,this._easing=(n=s.easing)!==null&&n!==void 0?n:this._easing,this._tx=e.get(Ot),this._motion=e.get(ve),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=e;const s=L(Ss(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),g=(a-n.x)/(e/1e3),p=(l-n.y)/(e/1e3);this._motion.vel.x=g,this._motion.vel.y=p,this.isComplete(this.entity)&&(this._tx.pos=R(this._end.x,this._end.y),this._motion.vel=R(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=R(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Rh{constructor(e,s,n,a){if(this.id=ye(),this._started=!1,this._stopped=!1,this._entity=e,this._tx=e.get(Ot),this._motion=e.get(ve),this._speed=a,this._offset=new I(s,n),a<=0)throw j.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+a),new Error("Speed must be greater than 0 pixels per second")}update(e){this._started||(this._started=!0,this._start=new I(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=R(this._end.x,this._end.y),this._motion.vel=R(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(e){const s=e.get(Ot);return this._stopped||s.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=R(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Jc(d){return d.pos instanceof I&&typeof d.duration=="number"}class Kc{constructor(e,s){var n;if(this.entity=e,this.id=ye(),this._started=!1,this._stopped=!1,this._easing=Ce.Linear,this._end=s.pos,this._easing=(n=s.easing)!==null&&n!==void 0?n:this._easing,this._tx=e.get(Ot),this._motion=e.get(ve),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=e;const s=L(Ss(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=this._tx.pos,a=this._easing(s,this._start.x,this._end.x,1),l=this._easing(s,this._start.y,this._end.y,1),g=(a-n.x)/(e/1e3),p=(l-n.y)/(e/1e3);this._motion.vel.x=g,this._motion.vel.y=p,this.isComplete(this.entity)&&(this._tx.pos=R(this._end.x,this._end.y),this._motion.vel=R(0,0))}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.vel=R(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class Fh{constructor(e,s,n,a){this.entity=e,this.id=ye(),this._started=!1,this._stopped=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._end=new I(s,n),this._speed=a}update(e){this._started||(this._started=!0,this._start=new I(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const s=this._dir.scale(this._speed);this._motion.vel=R(s.x,s.y),this.isComplete(this.entity)&&(this._tx.pos=R(this._end.x,this._end.y),this._motion.vel=R(0,0))}isComplete(e){const s=e.get(Ot);return this._stopped||new I(s.pos.x,s.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=R(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Uf(d){return typeof d.angle=="number"&&typeof d.duration=="number"}class td{constructor(e,s){var n;if(this.entity=e,this.id=ye(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=s.angle,this._tx=e.get(Ot),this._motion=e.get(ve),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(n=s.rotationType)!==null&&n!==void 0?n:W.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=e;const s=L(Ss(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Dh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(n-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(e){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ed{constructor(e,s,n,a){this.id=ye(),this._started=!1,this._stopped=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._end=s,this._speed=n,this._rotationType=a||W.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const s=Math.abs(this._end-this._start),n=k-s;switch(s>n?(this._shortDistance=n,this._longDistance=s):(this._shortDistance=s,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+k)%k>=Math.PI,this._rotationType){case W.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case W.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case W.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case W.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function Nf(d){return typeof d.angleRadiansOffset=="number"&&typeof d.duration=="number"}class id{constructor(e,s){var n;if(this.entity=e,this.id=ye(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=s.angleRadiansOffset,this._tx=e.get(Ot),this._motion=e.get(ve),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._rotationType=(n=s.rotationType)!==null&&n!==void 0?n:W.ShortestPath,this._currentMs=this._durationMs}update(e){this._started||(this._startAngle=this._tx.rotation,this._endAngle=Y(this._startAngle+this._offset),this._started=!0),this._currentMs-=e;const s=L(Ss(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=Dh(this._startAngle,this._endAngle,this._rotationType,s),a=this._tx.rotation,l=(n-a)/(e/1e3);this._motion.angularVelocity=l,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class sd{constructor(e,s,n,a){this.id=ye(),this._started=!1,this._stopped=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._speed=n,this._offset=s,this._rotationType=a||W.ShortestPath}update(e){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const s=Math.abs(this._end-this._start),n=k-s;switch(s>n?(this._shortDistance=n,this._longDistance=s):(this._shortDistance=s,this._longDistance=n),this._shortestPathIsPositive=(this._start-this._end+k)%k>=Math.PI,this._rotationType){case W.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case W.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case W.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case W.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(e/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const e=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||e>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function rd(d){return typeof d.scale=="object"&&typeof d.duration=="number"}class nd{constructor(e,s){if(this.entity=e,this.id=ye(),this._started=!1,this._stopped=!1,this._endScale=R(1,1),this._startScale=R(1,1),this._endScale=s.scale,this._tx=e.get(Ot),this._motion=e.get(ve),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=e;const s=L(Ss(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=no(this._startScale,this._endScale,s),a=this._tx.scale,l=n.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=I.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class od{constructor(e,s,n,a,l){this.id=ye(),this._started=!1,this._stopped=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._endX=s,this._endY=n,this._speedX=a,this._speedY=l}update(e){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*s}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const s=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*s}this.isComplete()&&(this._tx.scale=R(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function ad(d){return typeof d.scaleOffset=="object"&&typeof d.duration=="number"}class hd{constructor(e,s){if(this.entity=e,this.id=ye(),this._started=!1,this._stopped=!1,this._endScale=R(1,1),this._scaleOffset=R(0,0),this._startScale=R(1,1),this._scaleOffset=s.scaleOffset,this._tx=e.get(Ot),this._motion=e.get(ve),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=s.duration,this._currentMs=this._durationMs}update(e){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=e;const s=L(Ss(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),n=no(this._startScale,this._endScale,s),a=this._tx.scale,l=n.sub(a).scale(1/(e/1e3));this._motion.scaleFactor=l,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=I.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ld{constructor(e,s,n,a){this.id=ye(),this._started=!1,this._stopped=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._offset=new I(s,n),this._speedX=this._speedY=a}update(e){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class cd{constructor(e){this.id=ye(),this._hasBeenCalled=!1,this._method=e}update(e){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class dd{constructor(e,s,n,a,l){this.easingFcn=l,this.id=ye(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new I(0,0),this._lerpEnd=new I(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._lerpDuration=a,this._lerpEnd=new I(s,n)}_initialize(){this._lerpStart=new I(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=R((s-this._tx.pos.x)/(e/1e3),(n-this._tx.pos.y)/(e/1e3))):(this._tx.pos=R(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=I.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=R(0,0),this._stopped=!0}}class ud{constructor(e,s,n,a,l){this.easingFcn=l,this.id=ye(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new I(0,0),this._lerpEnd=new I(0,0),this._initialized=!1,this._stopped=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._lerpDuration=a,this._offset=new I(s,n)}_initialize(){this._lerpStart=new I(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(e){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=e;let s=this._tx.pos.x,n=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?s=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):s=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?n=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):n=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=R((s-this._tx.pos.x)/(e/1e3),(n-this._tx.pos.y)/(e/1e3))):(this._tx.pos=R(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=I.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=R(0,0),this._stopped=!0}}class gd{constructor(e,s,n,a=1){this.id=ye(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=e.get(De),this._timeVisible=s,this._timeNotVisible=n,this._duration=(s+n)*a}update(e){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=e,this._totalTime+=e,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class fd{constructor(e,s,n){this.id=ye(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=e.get(De),this._endOpacity=s,this._remainingTime=this._originalTime=n}update(e){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*e)/this._remainingTime),this._remainingTime-=e,this.isComplete()&&(this._graphics.opacity=this._endOpacity),j.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class _d{constructor(e){this.id=ye(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=e}update(e){this._started||(this._started=!0),this._elapsedTime+=e}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class pd{constructor(e){this.id=ye(),this._stopped=!1,this._entity=e}update(e){this._entity.get(Tn).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class Mh{constructor(e,s,n){this.id=ye(),this._started=!1,this._stopped=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._followTx=s.get(Ot),this._followMotion=s.get(ve),this._current=new I(this._tx.pos.x,this._tx.pos.y),this._end=new I(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=n!==void 0?n:this._current.distance(this._end),this._speed=0}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(s!==0&&(this._speed=s),this._current=R(this._tx.pos.x,this._tx.pos.y),this._end=R(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const n=this._dir.scale(this._speed);this._motion.vel=R(n.x,n.y)}else this._motion.vel=R(0,0);this.isComplete()&&(this._tx.pos=R(this._end.x,this._end.y),this._motion.vel=R(0,0))}stop(){this._motion.vel=R(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class kh{constructor(e,s,n){this.id=ye(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=e.get(Ot),this._motion=e.get(ve),this._meetTx=s.get(Ot),this._meetMotion=s.get(ve),this._current=new I(this._tx.pos.x,this._tx.pos.y),this._end=new I(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=n||0,n!==void 0&&(this._speedWasSpecified=!0)}update(e){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const s=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));s!==0&&!this._speedWasSpecified&&(this._speed=s),this._current=R(this._tx.pos.x,this._tx.pos.y),this._end=R(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const n=this._dir.scale(this._speed);this._motion.vel=R(n.x,n.y),this.isComplete()&&(this._tx.pos=R(this._end.x,this._end.y),this._motion.vel=R(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=R(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class Ad{constructor(e,s,n=1e3){var a;this.id=ye(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=e.get(De),this._duration=n,this._entity=e,this._material=(a=e.scene)===null||a===void 0?void 0:a.engine.graphicsContext.createMaterial({name:"flash-material",color:s,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=n}update(e){var s;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=e,this._graphics&&((s=this._material)===null||s===void 0||s.update(n=>{n.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class oo{constructor(e){var s;if(this._distLookup=[],this.quality=4,e.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...e.controlPoints],this.quality=(s=e.quality)!==null&&s!==void 0?s:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(e){this._controlPoints=[...e],this._calculateLookup()}setControlPoint(e,s){this._controlPoints[e]=s,this._calculateLookup()}_calculateLookup(){let e=0;this._distLookup.length=0;let s=this.controlPoints[0];const n=this.controlPoints.length*this.quality;for(let a=0;a<n;a++){const l=a/(n-1),g=this.getPoint(l),p=s.distance(g);e+=p,this._distLookup.push(e),s=g}this._arcLength=e}_getTimeGivenDistance(e){const s=this._distLookup.length,n=this.arcLength;if(e>=0&&e<n){for(let a=0;a<s-1;a++)if(this._distLookup[a]<=e&&e<this._distLookup[a+1])return Ss(this._distLookup[a],this._distLookup[a+1],a/(s-1),(a+1)/(s-1),e)}return e/n}getPoint(e){const s=[...this.controlPoints];for(let n=1;n<s.length;n++)for(let a=0;a<s.length-n;a++)s[a]=no(s[a],s[a+1],e);return s[0]}getTangent(e){const s=e*e,n=this.controlPoints[0],a=this.controlPoints[1],l=this.controlPoints[2],g=this.controlPoints[3];return n.scale(-3*s+6*e-3).add(a.scale(9*s-12*e+3).add(l.scale(-9*s+6*e).add(g.scale(3*s)))).normalize()}getUniformTangent(e){const s=e*this.arcLength,n=this._getTimeGivenDistance(s);return this.getTangent(n)}getNormal(e){return this.getTangent(e).normal()}getUniformNormal(e){return this.getUniformTangent(e).normal()}getUniformPoint(e){const s=e*this.arcLength,n=this._getTimeGivenDistance(s);return this.getPoint(n)}clone(){return new oo({controlPoints:[...this.controlPoints],quality:this.quality})}}class md{constructor(e,s){var n;if(this.id=ye(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(Ot),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new oo({controlPoints:[R(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(n=s.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=e;const s=L(Ss(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class vd{constructor(e,s){var n;if(this.id=ye(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=e,this._tx=this._entity.get(Ot),!this._tx)throw new Error(`Entity ${e.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new oo({controlPoints:[R(0,0),...s.controlPoints],quality:s.quality}),this._durationMs=s.duration,this._mode=(n=s.mode)!==null&&n!==void 0?n:this._mode,this._currentMs=this._durationMs}update(e){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=e;const s=L(Ss(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(s):this._tx.pos=this._curve.getUniformPoint(s),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(e){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class ao{constructor(e){this._entity=e,this._queue=new Wc(e)}getQueue(){return this._queue}update(e){this._queue.update(e)}clearActions(){this._queue.clearActions()}runAction(e){return e.reset(),this._queue.add(e),this}curveBy(e){return this._queue.add(new vd(this._entity,e)),this}curveTo(e){return this._queue.add(new md(this._entity,e)),this}easeTo(...e){var s,n;let a=0,l=0,g=0,p=Ce.Linear;return e[0]instanceof I?(a=e[0].x,l=e[0].y,g=e[1],p=(s=e[2])!==null&&s!==void 0?s:p):(a=e[0],l=e[1],g=e[2],p=(n=e[3])!==null&&n!==void 0?n:p),this._queue.add(new dd(this._entity,a,l,g,p)),this}easeBy(...e){var s,n;let a=0,l=0,g=0,p=Ce.Linear;return e[0]instanceof I?(a=e[0].x,l=e[0].y,g=e[1],p=(s=e[2])!==null&&s!==void 0?s:p):(a=e[0],l=e[1],g=e[2],p=(n=e[3])!==null&&n!==void 0?n:p),this._queue.add(new ud(this._entity,a,l,g,p)),this}moveTo(e,s,n){let a=0,l=0,g=0;return e instanceof I?(a=e.x,l=e.y,g=+(s??0),this._queue.add(new Fh(this._entity,a,l,g))):typeof e=="number"&&typeof s=="number"&&typeof n=="number"?(a=e,l=s,g=n,this._queue.add(new Fh(this._entity,a,l,g))):Jc(e)&&this._queue.add(new Kc(this._entity,e)),this}moveBy(e,s,n){let a=0,l=0,g=0;return e instanceof I&&typeof s=="number"?(a=e.x,l=e.y,g=s,this._queue.add(new Rh(this._entity,a,l,g))):typeof e=="number"&&typeof s=="number"&&typeof n=="number"?(a=e,l=s,g=n,this._queue.add(new Rh(this._entity,a,l,g))):Zc(e)&&this._queue.add(new $c(this._entity,e)),this}rotateTo(e,s,n){return typeof e=="number"&&typeof s=="number"?this._queue.add(new ed(this._entity,e,s,n)):typeof e=="object"&&this._queue.add(new td(this._entity,e)),this}rotateBy(e,s,n){return typeof e=="object"?this._queue.add(new id(this._entity,e)):this._queue.add(new sd(this._entity,e,s,n)),this}scaleTo(e,s,n,a){let l=1,g=1,p=0,v=0;return rd(e)?(this._queue.add(new nd(this._entity,e)),this):(e instanceof I&&s instanceof I&&(l=e.x,g=e.y,p=s.x,v=s.y),typeof e=="number"&&typeof s=="number"&&(l=e,g=s,p=n,v=a),this._queue.add(new od(this._entity,l,g,p,v)),this)}scaleBy(e,s,n){if(ad(e))return this._queue.add(new hd(this._entity,e)),this;let a=1,l=1;return e instanceof I&&(a=e.x,l=e.y,n=s),typeof e=="number"&&typeof s=="number"&&(a=e,l=s),this._queue.add(new ld(this._entity,a,l,n)),this}blink(e,s,n=1){return this._queue.add(new gd(this._entity,e,s,n)),this}fade(e,s){return this._queue.add(new fd(this._entity,e,s)),this}flash(e,s=1e3){return this._queue.add(new Ad(this._entity,e,s)),this}delay(e){return this._queue.add(new _d(e)),this}die(){return this._queue.add(new pd(this._entity)),this}callMethod(e){return this._queue.add(new cd(e)),this}repeat(e,s){return s?(this._queue.add(new qc(this._entity,e,s)),this):(this.repeatForever(e),this)}repeatForever(e){return this._queue.add(new Vc(this._entity,e)),this}follow(e,s){return s===void 0?this._queue.add(new Mh(this._entity,e)):this._queue.add(new Mh(this._entity,e,s)),this}meet(e,s){return s===void 0?this._queue.add(new kh(this._entity,e)):this._queue.add(new kh(this._entity,e,s)),this}toPromise(){return new Promise(s=>{this._queue.add(new cd(()=>{s()}))})}}class Tn extends Hi{constructor(){super(...arguments),this.dependencies=[Ot,ve],this._ctx=null}onAdd(e){this._ctx=new ao(e)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(e){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(e)}update(e){var s;return(s=this._ctx)===null||s===void 0?void 0:s.update(e)}clearActions(){var e;(e=this._ctx)===null||e===void 0||e.clearActions()}curveBy(e){return this._getCtx().curveBy.apply(this._ctx,[e])}curveTo(e){return this._getCtx().curveTo.apply(this._ctx,[e])}easeTo(...e){return this._getCtx().easeTo.apply(this._ctx,e)}easeBy(...e){return this._getCtx().easeBy.apply(this._ctx,e)}moveTo(e,s,n){return this._getCtx().moveTo.apply(this._ctx,[e,s,n])}moveBy(e,s,n){return this._getCtx().moveBy.apply(this._ctx,[e,s,n])}rotateTo(e,s,n){return this._getCtx().rotateTo.apply(this._ctx,[e,s,n])}rotateBy(e,s,n){return this._getCtx().rotateBy.apply(this._ctx,[e,s,n])}scaleTo(e,s,n,a){return this._getCtx().scaleTo.apply(this._ctx,[e,s,n,a])}scaleBy(e,s,n){return this._getCtx().scaleBy.apply(this._ctx,[e,s,n])}blink(e,s,n){return this._getCtx().blink(e,s,n)}fade(e,s){return this._getCtx().fade(e,s)}flash(e,s=1e3){return this._getCtx().flash(e,s)}delay(e){return this._getCtx().delay(e)}die(){return this._getCtx().die()}callMethod(e){return this._getCtx().callMethod(e)}repeat(e,s){return this._getCtx().repeat(e,s)}repeatForever(e){return this._getCtx().repeatForever(e)}follow(e,s){return this._getCtx().follow(e,s)}meet(e,s){return this._getCtx().meet(e,s)}toPromise(){return this._getCtx().toPromise()}}function Gf(d){return d instanceof Qi}const Of={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class Qi extends Ci{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(e){this.body.oldPos.setTo(e.x,e.y)}get vel(){return this.motion.vel}set vel(e){this.motion.vel=e.clone()}get oldVel(){return this.body.oldVel}set oldVel(e){this.body.oldVel.setTo(e.x,e.y)}get acc(){return this.motion.acc}set acc(e){this.motion.acc=e.clone()}set oldAcc(e){this.body.oldAcc.setTo(e.x,e.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(e){this.transform.rotation=e}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(e){this.motion.angularVelocity=e}get scale(){return this.get(Ot).scale}set scale(e){this.get(Ot).scale=e}get anchor(){return this._anchor}set anchor(e){this._anchor=mt(e,s=>this._handleAnchorChange(s)),this._handleAnchorChange(e)}_handleAnchorChange(e){this.graphics&&(this.graphics.anchor=e)}get offset(){return this._offset}set offset(e){this._offset=mt(e,s=>this._handleOffsetChange(s)),this._handleOffsetChange(e)}_handleOffsetChange(e){this.graphics&&(this.graphics.offset=e)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(e){e&&(e&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!e&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=e)}get color(){return this.graphics.color}set color(e){this.graphics.color=e}constructor(e){super(),this.events=new S,this._anchor=mt(I.Half,_e=>this._handleAnchorChange(_e)),this._offset=mt(I.Zero,_e=>this._handleOffsetChange(_e)),this.logger=j.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=_e=>{this._dragging&&(this.pos=_e.worldPos)},this._pointerDragLeaveHandler=_e=>{this._dragging&&(this.pos=_e.worldPos)};const{name:s,x:n,y:a,pos:l,coordPlane:g,scale:p,width:v,height:B,radius:P,collider:z,vel:$,acc:J,rotation:at,angularVelocity:ct,z:At,color:lt,visible:gt,opacity:Pt,anchor:wt,offset:Qt,collisionType:jt,collisionGroup:It,silenceWarnings:re}={...e};this.name=s??this.name,this.anchor=wt??Qi.defaults.anchor.clone(),this.offset=Qt??I.Zero,this.transform=new Ot,this.addComponent(this.transform),this.pos=l??R(n??0,a??0),this.rotation=at??0,this.scale=p??R(1,1),this.z=At??0,this.transform.coordPlane=g??We.World,this._silenceWarnings=re??!1,this.pointer=new vr,this.addComponent(this.pointer),this.graphics=new De({anchor:this.anchor,offset:this.offset,opacity:Pt}),this.addComponent(this.graphics),this.motion=new ve,this.addComponent(this.motion),this.vel=$??I.Zero,this.acc=J??I.Zero,this.angularVelocity=ct??0,this.actions=new Tn,this.addComponent(this.actions),this.body=new ge,this.addComponent(this.body),this.body.collisionType=jt??ee.Passive,It&&(this.body.group=It),lt&&(this.color=lt),z?(this.collider=new Je(z),this.addComponent(this.collider)):P?(this.collider=new Je(Ii.Circle(P)),this.addComponent(this.collider),lt&&this.graphics.add(new la({color:lt,radius:P}))):v>0&&B>0?(this.collider=new Je(Ii.Box(v,B,this.anchor)),this.addComponent(this.collider),lt&&v&&B&&this.graphics.add(new ro({color:lt,width:v,height:B}))):(this.collider=new Je,this.addComponent(this.collider)),this.graphics.isVisible=gt??!0}clone(){const e=new Qi({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});e.clearComponents(),e.processComponentRemoval(),e.addComponent(e.transform=this.transform.clone(),!0),e.addComponent(e.pointer=this.pointer.clone(),!0),e.addComponent(e.graphics=this.graphics.clone(),!0),e.addComponent(e.motion=this.motion.clone(),!0),e.addComponent(e.actions=this.actions.clone(),!0),e.addComponent(e.body=this.body.clone(),!0),e.addComponent(e.collider=this.collider.clone(),!0);const s=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],n=this.getComponents();for(const a of n)s.includes(a)||e.addComponent(a.clone(),!0);return e}onInitialize(e){}_initialize(e){super._initialize(e);for(const s of this.children)s._initialize(e)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_prekill(e){this.events.emit("prekill",new bn(this)),this.onPreKill(e)}onPreKill(e){}_postkill(e){this.events.emit("postkill",new Cn(this)),this.onPostKill(e)}onPostKill(e){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new Gr(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(Ot).z}set z(e){this.get(Ot).z=e}get center(){const e=this.getGlobalPos();return new I(e.x+this.width/2-this.anchor.x*this.width,e.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new I(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(Ot).globalRotation}get globalRotation(){return this.get(Ot).globalRotation}getGlobalPos(){return this.get(Ot).globalPos}get globalPos(){return this.get(Ot).globalPos}getGlobalScale(){return this.get(Ot).globalScale}get globalScale(){return this.get(Ot).globalScale}get globalZ(){return this.get(Ot).globalZ}contains(e,s,n=!1){const a=R(e,s),l=this.get(Je);l.update();const g=l.get();if(!g)return!1;const p=g.contains(a);return n?p||this.children.some(v=>v.contains(e,s,!0)):p}within(e,s){const n=this.get(Je),a=e.get(Je),l=n.get(),g=a.get();return l&&g?l.getClosestLineBetween(g).getLength()<=s:!1}update(e,s){this._initialize(e),this._add(e),this._preupdate(e,s),this._postupdate(e,s),this._remove(e)}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreCollisionResolve(e,s,n,a){}onPostCollisionResolve(e,s,n,a){}onCollisionStart(e,s,n,a){}onCollisionEnd(e,s,n,a){}_preupdate(e,s){this.events.emit("preupdate",new zt(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.events.emit("postupdate",new Vt(e,s,this)),this.onPostUpdate(e,s)}}Qi.defaults={anchor:I.Half};function wd(d){return d instanceof Qh}class Qh extends Qi{constructor(e){var s,n;super({...e}),this.get(Ot).coordPlane=We.Screen,this.anchor=(s=e==null?void 0:e.anchor)!==null&&s!==void 0?s:R(0,0),this.body.collisionType=(n=e==null?void 0:e.collisionType)!==null&&n!==void 0?n:ee.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!(e!=null&&e.collider)&&(e==null?void 0:e.width)>0&&(e==null?void 0:e.height)>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(e){this._engine=e,super._initialize(e)}contains(e,s,n=!0){if(n)return super.contains(e,s);const a=this._engine.worldToScreenCoordinates(new I(e,s));return super.contains(a.x,a.y)}}class Zr{get complete(){return this._complete}constructor(e){var s;this._logger=j.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const n=(s=e.action)!==null&&s!==void 0?s:e.fcn,a=e.interval,l=e.repeats,g=e.numberOfRepeats,p=e.randomRange,v=e.random;if(g&&g>=0&&(this.maxNumberOfRepeats=g,!l))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=Zr._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=a,p){if(p[0]>p[1])throw new Error("min value must be lower than max value for range");this.random=v??new H,this.randomRange=p,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=l||this.repeats,n&&this.on(n)}on(e){this._callbacks.push(e)}off(e){const s=this._callbacks.indexOf(e);this._callbacks.splice(s,1)}update(e){this._running&&(this._totalTimeAlive+=e,this._elapsedTime+=e,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(s=>{s.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(e,s){if(e&&e>=0&&(this._baseInterval=this.interval=e),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=s,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}Zr._MAX_ID=0;class ca extends Hi{constructor(e){super(),this.parallaxFactor=R(1,1),this.parallaxFactor=e??this.parallaxFactor}}class da extends Hi{constructor(e,s=!0){super(),this.draw=e,this.useTransform=s}}function yd(d){return d&&d._dispatchPointerEvents&&d._processPointerToObject}class Hf{get events(){return this.object.events}init(e,s,n){this.object=e,this.contains=s,this.active=n}}class Lh{constructor(){this._proxyPool=new _t(()=>new Hf,e=>e,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(e,s,n){const a=this._proxyPool.rent(!1);a.init(e,s,n),this._proxies.push(a),this._objectToProxy.set(e,a)}_getProxy(e){const s=this._objectToProxy.get(e);if(s)return s;throw new Error("No PointerTargetProxy for object")}removeObject(e){const s=this._objectToProxy.get(e);if(s){const n=this._proxies.indexOf(s);n>-1&&this._proxies.splice(n,1),this._proxyPool.return(s)}}_objectCurrentlyUnderPointer(e,s){return!!(this._currentFrameObjectToPointers.has(e)&&this._currentFrameObjectToPointers.get(e).includes(s))}_objectWasUnderPointer(e,s){return!!(this._lastFrameObjectToPointers.has(e)&&this._lastFrameObjectToPointers.get(e).includes(s))}_entered(e,s){return this._objectCurrentlyUnderPointer(e,s)&&!this._lastFrameObjectToPointers.has(e)}_left(e,s){return!this._currentFrameObjectToPointers.has(e)&&this._objectWasUnderPointer(e,s)}addPointerToObject(e,s){const n=this._objectToProxy.get(e);n&&this._addPointerToProxy(n,s)}_addPointerToProxy(e,s){if(!this._currentFrameObjectToPointers.has(e)){this._currentFrameObjectToPointers.set(e,[s]);return}const n=this._currentFrameObjectToPointers.get(e);this._currentFrameObjectToPointers.set(e,n.concat(s))}dispatchEvents(e,s){const n=new Set(this._lastFrameObjectToPointers.keys()),a=new Set(this._currentFrameObjectToPointers.keys());let l,g,p;for(let v=0;v<s.length;v++){const B=s[v],P=this._getProxy(B);if(yd(B)&&B._dispatchPointerEvents(e),n.has(P)||a.has(P)){p=this._processDownAndEmit(e,P),g=this._processUpAndEmit(e,P),l=this._processMoveAndEmit(e,P);const z=[...l.values(),...p.values(),...g.values()];this._processEnterLeaveAndEmit(e,P,z),this._processCancelAndEmit(e,P),this._processWheelAndEmit(e,P)}}}processPointerToObject(e,s){for(let n=0;n<s.length;n++){const a=s[n],l=this._getProxy(a);yd(a)&&a._processPointerToObject(e);for(const[g,p]of e.currentFramePointerCoords.entries())l.contains(p)&&this._addPointerToProxy(l,g)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(e,s){const n=new Map;for(const a of e.currentFrameDown)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerdown",a),e.isDragStart(a.pointerId)&&s.events.emit("pointerdragstart",a)),n.set(a.pointerId,a);return n}_processUpAndEmit(e,s){const n=new Map;for(const a of e.currentFrameUp)a.active&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointerup",a),e.isDragEnd(a.pointerId)&&s.events.emit("pointerdragend",a)),n.set(a.pointerId,a);return n}_processMoveAndEmit(e,s){const n=new Map;for(const a of e.currentFrameMove)a.active&&s.active()&&this._objectCurrentlyUnderPointer(s,a.pointerId)&&(s.events.emit("pointermove",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragmove",a)),n.set(a.pointerId,a);return n}_processEnterLeaveAndEmit(e,s,n){for(const a of n){if(a.active&&s.active()&&this._entered(s,a.pointerId)){s.events.emit("pointerenter",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragenter",a);break}if(a.active&&s.active()&&(this._left(s,a.pointerId)||this._objectCurrentlyUnderPointer(s,a.pointerId)&&a.type==="up")){s.events.emit("pointerleave",a),e.isDragging(a.pointerId)&&s.events.emit("pointerdragleave",a);break}}}_processCancelAndEmit(e,s){for(const n of e.currentFrameCancel)n.active&&s.active()&&this._objectCurrentlyUnderPointer(s,n.pointerId)&&s.events.emit("pointercancel",n)}_processWheelAndEmit(e,s){for(const n of e.currentFrameWheel)n.active&&s.active()&&this._objectCurrentlyUnderPointer(s,0)&&s.events.emit("pointerwheel",n)}}const Wf={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class xd extends Ci{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let e=0;e<this.tiles.length;e++)this.tiles[e]&&this.tiles[e].flagDirty()}get x(){var e;return(e=this.transform.pos.x)!==null&&e!==void 0?e:0}set x(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.get(Ot).pos=R(e,this.y))}get y(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.pos.y)!==null&&s!==void 0?s:0}set y(e){var s;!((s=this.transform)===null||s===void 0)&&s.pos&&(this.transform.pos=R(this.x,e))}get z(){var e;return(e=this.transform.z)!==null&&e!==void 0?e:0}set z(e){this.transform&&(this.transform.z=e)}get rotation(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.rotation)!==null&&s!==void 0?s:0}set rotation(e){this.transform&&(this.transform.rotation=e)}get scale(){var e,s;return(s=(e=this.transform)===null||e===void 0?void 0:e.scale)!==null&&s!==void 0?s:I.One}set scale(e){var s;!((s=this.transform)===null||s===void 0)&&s.scale&&(this.transform.scale=e)}get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get vel(){return this._motion.vel}set vel(e){this._motion.vel=e}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,n,a;super([],e.name),this.events=new S,this._token=0,this.logger=j.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(s=e.meshingLookBehind)!==null&&s!==void 0?s:this.meshingLookBehind,this.addComponent(new Ot),this.addComponent(new ve),this.addComponent(new ge({type:ee.Fixed})),this.addComponent(new De({onPostDraw:(g,p)=>this.draw(g,p)})),this.addComponent(new da((g,p)=>this.debug(g,p),!1)),this.addComponent(new Je),this.addComponent(new vr),this.pointer=this.get(vr),this._graphics=this.get(De),this.transform=this.get(Ot),this._motion=this.get(ve),this.collider=this.get(Je),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(n=e.pos)!==null&&n!==void 0?n:I.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(a=e.renderFromTopOfGraphic)!==null&&a!==void 0?a:this.renderFromTopOfGraphic,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.rows=e.rows,this.columns=e.columns,this._pointerEventDispatcher=new Lh,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let l=[];for(let g=0;g<this.columns;g++){for(let p=0;p<this.rows;p++){const v=new bd({x:g,y:p,map:this});v.map=this,this.tiles[g+p*this.columns]=v,this._pointerEventDispatcher.addObject(v,B=>v.bounds.contains(B.worldPos),()=>!0),l.push(v),this._rows[p]||(this._rows[p]=[]),this._rows[p].push(v)}this._cols[g]=l,l=[]}this._graphics.localBounds=new ht({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(e){super._initialize(e),this._engine=e}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:I.Zero;{const n=e.offset;return this._originalOffsets.set(e,n),n}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const e=[];this._composite=this.collider.useCompositeCollider([]);let s=null;const n=(l,g)=>l&&g?l.top===g.top&&l.bottom===g.bottom&&l.right===g.left:!1,a=(l,g,p=this.meshingLookBehind)=>{if(!l)return!1;for(let v=g.length-1;v>=0;v--){if(p--<0)return!1;const B=g[v];if(n(B,l))return g[v]=B.combine(l),!0}return!1};for(let l=0;l<this.columns;l++){for(let g=0;g<this.rows;g++){const p=this.tiles[l+g*this.columns];if(p.solid)if(p.getColliders().length>0){for(const v of p.getColliders()){const B=this._getOrSetColliderOriginalOffset(v);v.offset=R(p.x*this.tileWidth*this.scale.x,p.y*this.tileHeight*this.scale.y).add(B),v.owner=this,this._composite.addCollider(v)}s&&!a(s,e)&&e.push(s),s=null}else s?s=s.combine(p.defaultGeometry):s=p.defaultGeometry;else s&&!a(s,e)&&e.push(s),s=null}s&&!a(s,e)&&e.push(s),s=null}for(const l of e){const g=Ii.Box(l.width,l.height,I.Zero,R(l.left-this.pos.x,l.top-this.pos.y));g.owner=this,this._composite.addCollider(g)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(e){var s;return(s=this.tiles[e])!==null&&s!==void 0?s:null}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const{x:s,y:n}=this._getTileCoordinates(e),a=this.getTile(s,n);return s>=0&&n>=0&&s<this.columns&&n<this.rows&&a?a:null}_getTileCoordinates(e){e=this.transform.applyInverse(e);const s=Math.floor(e.x/this.tileWidth),n=Math.floor(e.y/this.tileHeight);return{x:s,y:n}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let e=this._engine.screen.getWorldBounds();const s=this.get(ca);if(s&&this.isInitialized){let J=this.pos;const at=I.One.sub(s.parallaxFactor),ct=this._engine.currentScene.camera.pos.scale(at);J=J.sub(ct),e=e.translate(J)}const n=this.transform.coordPlane===We.Screen?this._engine.screen.getScreenBounds():e,a=this._getTileCoordinates(n.topLeft),l=this._getTileCoordinates(n.topRight),g=this._getTileCoordinates(n.bottomRight),p=this._getTileCoordinates(n.bottomLeft),v=Math.min(L(a.x,0,this.columns-1),L(l.x,0,this.columns-1)),B=Math.min(L(a.y,0,this.rows-1),L(l.y,0,this.rows-1)),P=Math.max(L(g.x,0,this.columns-1),L(p.x,0,this.columns-1)),z=Math.max(L(g.y,0,this.rows-1),L(p.y,0,this.rows-1)),$=[];for(let J=v;J<=P;J++)for(let at=B;at<=z;at++)$.push(this.getTile(J,at));return $}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(e,s){this._initialize(e),this.onPreUpdate(e,s),this.emit("preupdate",new zt(e,s,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(e,s),this.emit("postupdate",new Vt(e,s,this))}draw(e,s){if(!this.isInitialized)return;this.emit("predraw",new b(e,s,this));let n,a,l;const g=this.getOnScreenTiles();for(let p=0;p<g.length;p++){const v=g[p],B=v.getGraphicsOffsets();for(n=v.getGraphics(),a=0,l=n.length;a<l;a++){const P=n[a],z=B[a];if(P){xn(P)&&(P==null||P.tick(s,this._token));const $=this.renderFromTopOfGraphic?0:P.height-this.tileHeight;P.draw(e,v.x*this.tileWidth+z.x,v.y*this.tileHeight-$+z.y)}}}this.emit("postdraw",new M(e,s,this))}debug(e,s){const{showAll:n,showGrid:a,gridColor:l,gridWidth:g,showSolidBounds:p,solidBoundsColor:v,showColliderGeometry:B}=s.tilemap,{geometryColor:P,geometryLineWidth:z,geometryPointSize:$}=s.collider,J=this.tileWidth*this.columns*this.scale.x,at=this.tileHeight*this.rows*this.scale.y,ct=this.pos;if(a||n){for(let At=0;At<this.rows+1;At++){const lt=R(0,At*this.tileHeight*this.scale.y);e.drawLine(ct.add(lt),ct.add(R(J,lt.y)),l,g)}for(let At=0;At<this.columns+1;At++){const lt=R(At*this.tileWidth*this.scale.x,0);e.drawLine(ct.add(lt),ct.add(R(lt.x,at)),l,g)}}if(n||p||B){const At=this._composite.getColliders();e.save(),e.translate(this.pos.x,this.pos.y),e.scale(this.scale.x,this.scale.y);for(const lt of At){const gt=lt.localBounds,Pt=lt.worldPos.sub(this.pos);p&&e.drawRectangle(Pt,gt.width,gt.height,v)}if(e.restore(),B)for(const lt of At)lt.debug(e,P,{lineWidth:z,pointSize:$})}if(n||p){if(e.save(),e.z=999,p)for(let At=0;At<this.tiles.length;At++)this.tiles[At].bounds.draw(e);e.restore()}}}class bd{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(e){var s;(s=this.map)===null||s===void 0||s.flagCollidersDirty(),this._solid=e}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(e,s){this._graphics.push(e),s!=null&&s.offset?this._offsets.push(s.offset):this._offsets.push(I.Zero)}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&(this._graphics.splice(s,1),this._offsets.splice(s,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(e){var s,n;this._posDirty=!1,this.events=new S,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=e.x,this.y=e.y,this.map=e.map,this._width=e.map.tileWidth*this.map.scale.x,this._height=e.map.tileHeight*this.map.scale.y,this.solid=(s=e.solid)!==null&&s!==void 0?s:this.solid,this._graphics=(n=e.graphics)!==null&&n!==void 0?n:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const e=this.map.pos.add(R(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new ht(e.x,e.y,e.x+this.map.tileWidth,e.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(R(this.x*this._width,this.y*this._height)),this._bounds=new ht(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new I(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){s?this.events.off(e,s):this.events.off(e)}}class Cd{constructor(e){this.camera=e}lockToActor(e){this.camera.addStrategy(new Ed(e))}lockToActorAxis(e,s){this.camera.addStrategy(new Id(e,s))}elasticToActor(e,s,n){this.camera.addStrategy(new Bd(e,s,n))}radiusAroundActor(e,s){this.camera.addStrategy(new Td(e,s))}limitCameraBounds(e){this.camera.addStrategy(new Sd(e))}}var ua;(function(d){d[d.X=0]="X",d[d.Y=1]="Y"})(ua||(ua={}));class Ed{constructor(e){this.target=e,this.action=(s,n,a,l)=>s.center}}class Id{constructor(e,s){this.target=e,this.axis=s,this.action=(n,a,l,g)=>{const p=n.center,v=a.getFocus();return this.axis===ua.X?new I(p.x,v.y):new I(v.x,p.y)}}}class Bd{constructor(e,s,n){this.target=e,this.cameraElasticity=s,this.cameraFriction=n,this.action=(a,l,g,p)=>{const v=a.center;let B=l.getFocus(),P=l.vel.clone();const z=v.sub(B).scale(this.cameraElasticity);P=P.add(z);const $=P.scale(-1).scale(this.cameraFriction);return P=P.add($),B=B.add(P),B}}}class Td{constructor(e,s){this.target=e,this.radius=s,this.action=(n,a,l,g)=>{const p=n.center,v=a.getFocus(),B=p.sub(v),P=B.magnitude;if(P>=this.radius){const z=P-this.radius;return v.add(B.normalize().scale(z))}return v}}}class Sd{constructor(e){this.target=e,this.boundSizeChecked=!1,this.action=(s,n,a,l)=>{const g=n.getFocus();this.boundSizeChecked||((s.bottom-s.top<a.drawHeight||s.right-s.left<a.drawWidth)&&j.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let p=g.x,v=g.y;return g.x<s.left+a.halfDrawWidth?p=s.left+a.halfDrawWidth:g.x>s.right-a.halfDrawWidth&&(p=s.right-a.halfDrawWidth),g.y<s.top+a.halfDrawHeight?v=s.top+a.halfDrawHeight:g.y>s.bottom-a.halfDrawHeight&&(v=s.bottom-a.halfDrawHeight),R(p,v)}}}const qf={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class Pd{constructor(){this.events=new S,this.transform=st.identity(),this.inverse=st.identity(),this._cameraStrategies=[],this.strategy=new Cd(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new gs(I.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=I.Zero,this.acc=I.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=Ce.EaseInOutCubic,this._easing=Ce.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=R(0,0)}get zoom(){return this._z}set zoom(e){this._z=e,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(e){this._angularVelocity=e}get pos(){return this._pos}set pos(e){this._posChanged=!0,this._pos=new gs(e,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(e){!this._follow&&!this._cameraMoving&&(this.pos=R(e,this.pos.y))}get y(){return this.pos.y}set y(e){!this._follow&&!this._cameraMoving&&(this.pos=R(this.pos.x,e))}get dx(){return this.vel.x}set dx(e){this.vel=R(e,this.vel.y)}get dy(){return this.vel.y}set dy(e){this.vel=R(this.vel.x,e)}get ax(){return this.acc.x}set ax(e){this.acc=R(e,this.acc.y)}get ay(){return this.acc.y}set ay(e){this.acc=R(this.acc.x,e)}getFocus(){return this.pos}move(e,s,n=Ce.EaseInOutCubic){if(typeof n!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(e):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(e),this._lerpPromise=new Promise(a=>{this._lerpResolve=a}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=s,this._lerpEnd=e,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=n,this._lerpPromise)}shake(e,s,n){this._isShaking=!0,this._shakeMagnitudeX=e,this._shakeMagnitudeY=s,this._shakeDuration=n}zoomOverTime(e,s=0,n=Ce.EaseInOutCubic){if(this._zoomPromise=new Promise(a=>{this._zoomResolve=a}),s)this._isZooming=!0,this._zoomEasing=n,this._currentZoomTime=0,this._zoomDuration=s,this._zoomStart=this.zoom,this._zoomEnd=e;else return this._isZooming=!1,this.zoom=e,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new ht(0,0,0,0)}addStrategy(e){this._cameraStrategies.push(e)}removeStrategy(e){Yt(e,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(e,s){this.events.emit("preupdate",new zt(e,s,this)),this.onPreUpdate(e,s)}onPreUpdate(e,s){}_postupdate(e,s){this.events.emit("postupdate",new Vt(e,s,this)),this.onPostUpdate(e,s)}onPostUpdate(e,s){}get isInitialized(){return this._isInitialized}_initialize(e){if(!this.isInitialized){this._engine=e,this._screen=e.screen;const s=this._screen.contentArea;let n=R(s.width/2,s.height/2);if(!this._engine.loadingComplete){const a=this._screen.peekResolution();a&&(n=R(a.width/2,a.height/2))}this._halfWidth=n.x,this._halfHeight=n.y,this._posChanged||(this.pos=n),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(e,e.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(e),this.events.emit("initialize",new En(e,this)),this._isInitialized=!0}}onInitialize(e){}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}runStrategies(e,s){for(const n of this._cameraStrategies)this.pos=n.action.call(n,n.target,this,e,s)}updateViewport(){this._viewport=new ht(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(e,s){if(this._initialize(e),this._preupdate(e,s),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(s/1e3)),this.zoom+=this.dz*s/1e3,this.vel=this.vel.add(this.acc.scale(s/1e3)),this.dz+=this.az*s/1e3,this.rotation+=this.angularVelocity*s/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const n=this._zoomEasing,a=n(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=a,this._currentZoomTime+=s}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const a=Ce.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=a,this._currentLerpTime+=s}else{this.pos=this._lerpEnd;const n=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(n)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=s,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(e,s),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(e,s),this._posChanged=!1}draw(e){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const s=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,n=this.pos.scale(s).add(this._oldPos.scale(1-s));n.clone(this.drawPos),this.updateTransform(n)}if(e.snapToPixel){const s=this.drawPos.clone(this._snapPos);s.x=~~(s.x+oe*Q(s.x)),s.y=~~(s.y+oe*Q(s.y)),s.clone(this.drawPos),this.updateTransform(s)}e.multiply(this.transform)}updateTransform(e){const s=this._screen.resolution.width/this.zoom,n=this._screen.resolution.height/this.zoom,a=R(-e.x+s/2+this._xShake,-e.y+n/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(s/2,n/2),this.transform.rotate(this.rotation),this.transform.translate(-s/2,-n/2),this.transform.translate(a.x,a.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const Vf={ExitTrigger:"exit",EnterTrigger:"enter"};class Dd extends Qi{constructor(e){var s,n,a,l;super({...e}),this.events=new S,this.filter=(s=e.filter)!==null&&s!==void 0?s:()=>!0,this.repeat=(n=e.repeat)!==null&&n!==void 0?n:-1,this.action=(a=e.action)!==null&&a!==void 0?a:()=>{},this.target=e.target,this.graphics.isVisible=(l=e.visible)!==null&&l!==void 0?l:!1,this.body.collisionType=ee.Passive,this.events.on("collisionstart",({other:g})=>{this._matchesTarget(g.owner)&&(this.events.emit("enter",new Ah(this,g.owner)),this._dispatchAction(g.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:g})=>{this._matchesTarget(g.owner)&&this.events.emit("exit",new mh(this,g.owner))})}_matchesTarget(e){return this.filter(e)&&(this.target===void 0||this.target===e)}_dispatchAction(e){this.repeat!==0&&(this.action.call(this,e),this.repeat--)}}const Ps={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var Ji;(function(d){d.Update="update",d.Draw="draw"})(Ji||(Ji={}));class is{}is.priority=Ps.Average;class Rd{constructor(e){this._world=e,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>s=>{this.addEntity(s)},this._createChildRemovedHandler=()=>s=>{this.removeEntity(s,!1)},this._entitiesToRemove=[]}updateEntities(e,s){for(let n=0;n<this.entities.length;n++){const a=this.entities[n];a.update(e.engine,s),a.isActive||this.removeEntity(a)}}findEntitiesForRemoval(){for(let e=0;e<this.entities.length;e++){const s=this.entities[e];s.isActive||this.removeEntity(s)}}addEntity(e){if(e.isActive=!0,e.scene=this._world.scene,e&&!this._entityIndex[e.id]){this._entityIndex[e.id]=e,this.entities.push(e),this._world.queryManager.addEntity(e),e.children.forEach(a=>{a.scene=e.scene,this.addEntity(a)});const s=this._createChildAddedHandler();this._childAddedHandlerMap.set(e,s);const n=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(e,n),e.childrenAdded$.subscribe(s),e.childrenRemoved$.subscribe(n)}}removeEntity(e,s=!0){var n,a;let l=0;e instanceof Ci?l=e.id:l=e;const g=this._entityIndex[l];if(g&&g.isActive&&(g.isActive=!1),g&&s){this._entitiesToRemove.push(g);return}if(delete this._entityIndex[l],g){g.scene=null,Yt(g,this.entities),this._world.queryManager.removeEntity(g),g.children.forEach(B=>{B.scene=null,this.removeEntity(B,s)});const p=this._childAddedHandlerMap.get(g);p&&g.childrenAdded$.unsubscribe(p);const v=this._childRemovedHandlerMap.get(g);v&&g.childrenRemoved$.unsubscribe(v),!((a=(n=this._world)===null||n===void 0?void 0:n.scene)===null||a===void 0)&&a.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let e=0;e<this._entitiesToRemove.length;e++){const s=this._entitiesToRemove[e];s.isActive||this.removeEntity(s,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let e=0;e<this.entities.length;e++)this.entities[e].processComponentRemoval()}getById(e){return this._entityIndex[e]}getByName(e){return this.entities.filter(s=>s.name===e)}clear(){for(let e=this.entities.length-1;e>=0;e--)this.removeEntity(this.entities[e])}}class ho{constructor(e){if(this.requiredComponents=e,this.components=new Set,this.entities=[],this.entityAdded$=new hi,this.entityRemoved$=new hi,e.length===0)throw new Error("Cannot create query without components");for(const s of e)this.components.add(s);this.id=ho.createId(e)}static createId(e){return e.slice().map(s=>s.name).sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAll(Array.from(this.components))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class lo{constructor(e){if(this.requiredTags=e,this.tags=new Set,this.entities=[],this.entityAdded$=new hi,this.entityRemoved$=new hi,e.length===0)throw new Error("Cannot create tag query without tags");for(const s of e)this.tags.add(s);this.id=lo.createId(e)}static createId(e){return e.slice().sort().join("-")}checkAndAdd(e){return!this.entities.includes(e)&&e.hasAllTags(Array.from(this.tags))?(this.entities.push(e),this.entityAdded$.notifyAll(e),!0):!1}removeEntity(e){const s=this.entities.indexOf(e);s>-1&&(this.entities.splice(s,1),this.entityRemoved$.notifyAll(e))}getEntities(e){return e&&this.entities.sort(e),this.entities}}class Fd{constructor(e){this._world=e,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=s=>n=>{this.addComponent(s,n)},this._createRemoveComponentHandler=s=>n=>{this.removeComponent(s,n)},this._createAddTagHandler=s=>n=>{this.addTag(s,n)},this._createRemoveTagHandler=s=>n=>{this.removeTag(s,n)}}createQuery(e){const s=ho.createId(e);if(this._queries.has(s))return this._queries.get(s);const n=new ho(e);this._queries.set(n.id,n);for(const a of e){const l=this._componentToQueriesIndex.get(a);l?l.push(n):this._componentToQueriesIndex.set(a,[n])}for(const a of this._world.entities)this.addEntity(a);return n}createTagQuery(e){const s=lo.createId(e);if(this._tagQueries.has(s))return this._tagQueries.get(s);const n=new lo(e);this._tagQueries.set(n.id,n);for(const a of e){const l=this._tagToQueriesIndex.get(a);l?l.push(n):this._tagToQueriesIndex.set(a,[n])}for(const a of this._world.entities)this.addEntity(a);return n}addEntity(e){const s=this._addComponentHandlers.get(e),n=this._removeComponentHandlers.get(e),a=s??this._createAddComponentHandler(e),l=n??this._createRemoveComponentHandler(e);this._addComponentHandlers.set(e,a),this._removeComponentHandlers.set(e,l);const g=this._addTagHandlers.get(e),p=this._removeTagHandlers.get(e),v=g??this._createAddTagHandler(e),B=p??this._createRemoveTagHandler(e);this._addTagHandlers.set(e,v),this._removeTagHandlers.set(e,B);for(const P of this._queries.values())P.checkAndAdd(e);for(const P of this._tagQueries.values())P.checkAndAdd(e);e.componentAdded$.subscribe(a),e.componentRemoved$.subscribe(l),e.tagAdded$.subscribe(v),e.tagRemoved$.subscribe(B)}removeEntity(e){const s=this._addComponentHandlers.get(e),n=this._removeComponentHandlers.get(e);for(const g of this._queries.values())g.removeEntity(e);s&&e.componentAdded$.unsubscribe(s),n&&e.componentRemoved$.unsubscribe(n);const a=this._addTagHandlers.get(e),l=this._removeTagHandlers.get(e);for(const g of this._tagQueries.values())g.removeEntity(e);a&&e.tagAdded$.unsubscribe(a),l&&e.tagRemoved$.unsubscribe(l)}addComponent(e,s){var n;const a=(n=this._componentToQueriesIndex.get(s.constructor))!==null&&n!==void 0?n:[];for(const l of a)l.checkAndAdd(e)}removeComponent(e,s){var n;const a=(n=this._componentToQueriesIndex.get(s.constructor))!==null&&n!==void 0?n:[];for(const l of a)l.removeEntity(e)}addTag(e,s){var n;const a=(n=this._tagToQueriesIndex.get(s))!==null&&n!==void 0?n:[];for(const l of a)l.checkAndAdd(e)}removeTag(e,s){var n;const a=(n=this._tagToQueriesIndex.get(s))!==null&&n!==void 0?n:[];for(const l of a)l.removeEntity(e)}}function Md(d){var e,s;return!!(d!=null&&d.prototype)&&!!(!((s=(e=d==null?void 0:d.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class kd{constructor(e){this._world=e,this.systems=[],this.initialized=!1}get(e){return this.systems.find(s=>s instanceof e)}addSystem(e){let s;e instanceof is?s=e:s=new e(this._world),this.systems.push(s),this.systems.sort((n,a)=>n.constructor.priority-a.constructor.priority),this.initialized&&s.initialize&&s.initialize(this._world,this._world.scene)}removeSystem(e){Yt(e,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const e of this.systems)e.initialize&&e.initialize(this._world,this._world.scene)}}updateSystems(e,s,n){const a=this.systems.filter(l=>l.systemType===e);for(const l of a)l.preupdate&&l.preupdate(s,n);for(const l of a)l.update(n);for(const l of a)l.postupdate&&l.postupdate(s,n)}clear(){for(let e=this.systems.length-1;e>=0;e--)this.removeSystem(this.systems[e])}}class Qd{constructor(e){this.scene=e,this.queryManager=new Fd(this),this.entityManager=new Rd(this),this.systemManager=new kd(this)}query(e){return this.queryManager.createQuery(e)}queryTags(e){return this.queryManager.createTagQuery(e)}update(e,s){e===Ji.Update&&this.entityManager.updateEntities(this.scene,s),this.systemManager.updateSystems(e,this.scene,s),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(e){e instanceof Ci&&this.entityManager.addEntity(e),(e instanceof is||Md(e))&&this.systemManager.addSystem(e)}get(e){return this.systemManager.get(e)}remove(e,s=!0){e instanceof Ci&&this.entityManager.removeEntity(e,s),e instanceof is&&this.systemManager.removeSystem(e)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class ga extends is{constructor(e,s){super(),this.world=e,this.physics=s,this.systemType=Ji.Update,this._physicsConfigDirty=!1,s.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([Ot,ve])}update(e){let s,n;const a=this.query.entities,l=this.physics.config.substep;for(let g=0;g<a.length;g++){s=a[g].get(Ot),n=a[g].get(ve);const p=a[g].get(ge);if(this._physicsConfigDirty&&p&&p.updatePhysicsConfig(this.physics.config.bodies),p!=null&&p.isSleeping)continue;const v=n.acc.clone();(p==null?void 0:p.collisionType)===ee.Active&&(p!=null&&p.useGravity)&&v.addEqual(this.physics.config.gravity),a[g].parent||this.captureOldTransformWithChildren(a[g]),Mi.integrate(s,n,v,e/l)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(e){var s;(s=e.get(ge))===null||s===void 0||s.captureOldTransform();for(let n=0;n<e.children.length;n++)this.captureOldTransformWithChildren(e.children[n])}}ga.priority=Ps.Higher;class zh{constructor(e){this.config=e,this.directionMap=new Map,this.distanceMap=new Map}solve(e){this.preSolve(e),e=e.filter(n=>!n.isCanceled());let s;switch(this.config.contactSolveBias){case In.HorizontalFirst:{s=Gc;break}case In.VerticalFirst:{s=Nc;break}default:s=Oc}e.sort((n,a)=>{const l=this.directionMap.get(n.id),g=this.directionMap.get(a.id),p=this.distanceMap.get(n.id),v=this.distanceMap.get(a.id);return s[l]-s[g]||p-v});for(const n of e)this.solvePosition(n),this.solveVelocity(n);return this.postSolve(e),e}preSolve(e){for(let n=0;n<e.length;n++){const a=e[n];if(Math.abs(a.mtv.x)<1e-4&&Math.abs(a.mtv.y)<1e-4){a.cancel();continue}const l=Dt.fromDirection(a.mtv),g=a.mtv.negate(),p=Math.abs(a.info.separation);this.distanceMap.set(a.id,p),this.directionMap.set(a.id,l===Dt.Left||l===Dt.Right?"horizontal":"vertical"),a.colliderA.events.emit("precollision",new Hr(a.colliderA,a.colliderB,l,g,a)),a.colliderB.events.emit("precollision",new Hr(a.colliderB,a.colliderA,Dt.getOpposite(l),g.negate(),a))}}postSolve(e){var s,n;for(let a=0;a<e.length;a++){const l=e[a];if(l.isCanceled())continue;const g=l.colliderA,p=l.colliderB,v=(s=g.owner)===null||s===void 0?void 0:s.get(ge),B=(n=p.owner)===null||n===void 0?void 0:n.get(ge);if(v&&B&&(v.collisionType===ee.Passive||B.collisionType===ee.Passive))continue;const P=Dt.fromDirection(l.mtv),z=l.mtv.negate();l.colliderA.events.emit("postcollision",new Wr(l.colliderA,l.colliderB,P,z,l)),l.colliderB.events.emit("postcollision",new Wr(l.colliderB,l.colliderA,Dt.getOpposite(P),z.negate(),l))}}solvePosition(e){var s,n;if(!e.colliderA.bounds.overlaps(e.colliderB.bounds,1e-4)){e.cancel();return}if(Math.abs(e.mtv.x)<1e-4&&Math.abs(e.mtv.y)<1e-4){e.cancel();return}let l=e.mtv;const g=e.colliderA,p=e.colliderB,v=(s=g.owner)===null||s===void 0?void 0:s.get(ge),B=(n=p.owner)===null||n===void 0?void 0:n.get(ge);if(v&&B){if(v.collisionType===ee.Passive||B.collisionType===ee.Passive)return;v.collisionType===ee.Active&&B.collisionType===ee.Active&&(l=l.scale(.5)),v.collisionType===ee.Active&&(v.globalPos.x-=l.x,v.globalPos.y-=l.y,g.update(v.transform.get())),B.collisionType===ee.Active&&(B.globalPos.x+=l.x,B.globalPos.y+=l.y,p.update(B.transform.get()))}}solveVelocity(e){var s,n;if(e.isCanceled())return;const a=e.colliderA,l=e.colliderB,g=(s=a.owner)===null||s===void 0?void 0:s.get(ge),p=(n=l.owner)===null||n===void 0?void 0:n.get(ge);if(g&&p){if(g.collisionType===ee.Passive||p.collisionType===ee.Passive)return;const v=e.normal,B=v.negate();if(g.collisionType===ee.Active&&g.vel.normalize().dot(B)<0){const P=v.scale(v.dot(g.vel.negate()));g.vel=g.vel.add(P)}if(p.collisionType===ee.Active&&p.vel.normalize().dot(v)<0){const P=B.scale(B.dot(p.vel.negate()));p.vel=p.vel.add(P)}}}}class Ld{constructor(e,s,n){this.point=e,this.local=s,this.contact=n,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new I(0,0),this.bToContact=new I(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const e=this.contact.bodyA,s=this.contact.bodyB;if(e&&s){const n=this.contact.normal,a=this.contact.tangent;this.aToContact=this.point.sub(e.globalPos),this.bToContact=this.point.sub(s.globalPos);const l=this.aToContact.cross(n),g=this.bToContact.cross(n);this.normalMass=e.inverseMass+s.inverseMass+e.inverseInertia*l*l+s.inverseInertia*g*g;const p=this.aToContact.cross(a),v=this.bToContact.cross(a);this.tangentMass=e.inverseMass+s.inverseMass+e.inverseInertia*p*p+s.inverseInertia*v*v}return this}getRelativeVelocity(){const e=this.contact.bodyA,s=this.contact.bodyB;if(e&&s){const n=e.vel.add(I.cross(e.angularVelocity,this.aToContact));return s.vel.add(I.cross(s.angularVelocity,this.bToContact)).sub(n)}return I.Zero}}class Uh{constructor(e){this.config=e,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(e){var s;return(s=this.idToContactConstraint.get(e))!==null&&s!==void 0?s:[]}solve(e){return this.preSolve(e),e=e.filter(s=>!s.isCanceled()),this.solveVelocity(e),this.solvePosition(e),this.postSolve(e),e}preSolve(e){var s,n,a;for(let p=0;p<e.length;p++){const v=e[p];if(Math.abs(v.mtv.x)<1e-4&&Math.abs(v.mtv.y)<1e-4){v.cancel();continue}const B=Dt.fromDirection(v.mtv);v.colliderA.events.emit("precollision",new Hr(v.colliderA,v.colliderB,B,v.mtv,v)),v.colliderA.events.emit("beforecollisionresolve",new ia(v.colliderA,v.colliderB,B,v.mtv,v)),v.colliderB.events.emit("precollision",new Hr(v.colliderB,v.colliderA,Dt.getOpposite(B),v.mtv.negate(),v)),v.colliderB.events.emit("beforecollisionresolve",new ia(v.colliderB,v.colliderA,Dt.getOpposite(B),v.mtv.negate(),v)),v.matchAwake()}const g=Array.from(this.idToContactConstraint.keys());for(let p=0;p<e.length;p++){const v=e[p],B=g.indexOf(v.id);B>-1&&g.splice(B,1);const P=(s=this.idToContactConstraint.get(v.id))!==null&&s!==void 0?s:[];let z=0;const $=v.bodyA,J=v.bodyB;if($&&J)for(let at=0;at<v.points.length;at++){const ct=v.points[at],At=v.normal,lt=v.tangent,gt=ct.sub($.globalPos),Pt=ct.sub(J.globalPos),wt=gt.cross(At),Qt=Pt.cross(At),jt=$.inverseMass+J.inverseMass+$.inverseInertia*wt*wt+J.inverseInertia*Qt*Qt,It=gt.cross(lt),re=Pt.cross(lt),_e=$.inverseMass+J.inverseMass+$.inverseInertia*It*It+J.inverseInertia*re*re;P[z]&&((a=(n=P[z])===null||n===void 0?void 0:n.point)===null||a===void 0?void 0:a.squareDistance(ct))<4?(P[z].point=ct,P[z].local=v.localPoints[z]):P[z]=new Ld(ct,v.localPoints[z],v),P[z].aToContact=gt,P[z].bToContact=Pt,P[z].normalMass=1/jt,P[z].tangentMass=1/_e;const ke=$.bounciness>J.bounciness?$.bounciness:J.bounciness,Qe=v.normal.dot(P[z].getRelativeVelocity());P[z].originalVelocityAndRestitution=0,Qe<-.1&&(P[z].originalVelocityAndRestitution=-ke*Qe),z++}this.idToContactConstraint.set(v.id,P)}for(const p of g)this.idToContactConstraint.delete(p);if(this.config.warmStart)this.warmStart(e);else for(let p=0;p<e.length;p++){const v=e[p],B=this.getContactConstraints(v.id);for(const P of B)P.normalImpulse=0,P.tangentImpulse=0}}postSolve(e){for(let s=0;s<e.length;s++){const n=e[s],a=n.bodyA,l=n.bodyB;if(a&&l){if(a.collisionType===ee.Passive||l.collisionType===ee.Passive)continue;a.updateMotion(),l.updateMotion()}const g=Dt.fromDirection(n.mtv);n.colliderA.events.emit("postcollision",new Wr(n.colliderA,n.colliderB,g,n.mtv,n)),n.colliderA.events.emit("aftercollisionresolve",new sa(n.colliderA,n.colliderB,g,n.mtv,n)),n.colliderB.events.emit("postcollision",new Wr(n.colliderB,n.colliderA,Dt.getOpposite(g),n.mtv.negate(),n)),n.colliderB.events.emit("aftercollisionresolve",new sa(n.colliderB,n.colliderA,Dt.getOpposite(g),n.mtv.negate(),n))}this.lastFrameContacts.clear();for(let s=0;s<e.length;s++){const n=e[s];this.lastFrameContacts.set(n.id,n)}}warmStart(e){var s;for(let n=0;n<e.length;n++){const a=e[n],l=a.bodyA,g=a.bodyB;if(l&&g){const p=(s=this.idToContactConstraint.get(a.id))!==null&&s!==void 0?s:[];for(const v of p)if(this.config.warmStart){const B=a.normal.scale(v.normalImpulse),P=a.tangent.scale(v.tangentImpulse),z=B.add(P);l.applyImpulse(v.point,z.negate()),g.applyImpulse(v.point,z)}else v.normalImpulse=0,v.tangentImpulse=0}}}solvePosition(e){var s;for(let n=0;n<this.config.positionIterations;n++)for(let a=0;a<e.length;a++){const l=e[a],g=l.bodyA,p=l.bodyB;if(g&&p){if(g.collisionType===ee.Passive||p.collisionType===ee.Passive)continue;const v=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const B of v){const P=l.normal,z=ps.FindContactSeparation(l,B.local),$=this.config.steeringFactor,J=-5,at=this.config.slop,ct=L($*(z+at),J,0),At=P.scale(-ct*B.normalMass);if(g.collisionType===ee.Active){const lt=At.negate().scale(g.inverseMass);g.limitDegreeOfFreedom.includes(Wi.X)&&(lt.x=0),g.limitDegreeOfFreedom.includes(Wi.Y)&&(lt.y=0),g.globalPos=g.globalPos.add(lt),g.limitDegreeOfFreedom.includes(Wi.Rotation)||(g.rotation-=B.aToContact.cross(At)*g.inverseInertia)}if(p.collisionType===ee.Active){const lt=At.scale(p.inverseMass);p.limitDegreeOfFreedom.includes(Wi.X)&&(lt.x=0),p.limitDegreeOfFreedom.includes(Wi.Y)&&(lt.y=0),p.globalPos=p.globalPos.add(lt),p.limitDegreeOfFreedom.includes(Wi.Rotation)||(p.rotation+=B.bToContact.cross(At)*p.inverseInertia)}}}}}solveVelocity(e){var s;for(let n=0;n<this.config.velocityIterations;n++)for(let a=0;a<e.length;a++){const l=e[a],g=l.bodyA,p=l.bodyB;if(g&&p){if(g.collisionType===ee.Passive||p.collisionType===ee.Passive)continue;const v=Math.min(g.friction,p.friction),B=(s=this.idToContactConstraint.get(l.id))!==null&&s!==void 0?s:[];for(const P of B){let J=-P.getRelativeVelocity().dot(l.tangent)*P.tangentMass;const at=v*P.normalImpulse,ct=L(P.tangentImpulse+J,-at,at);J=ct-P.tangentImpulse,P.tangentImpulse=ct;const At=l.tangent.scale(J);g.applyImpulse(P.point,At.negate()),p.applyImpulse(P.point,At)}for(const P of B){const $=P.getRelativeVelocity().dot(l.normal);let J=-P.normalMass*($-P.originalVelocityAndRestitution);const at=Math.max(P.normalImpulse+J,0);J=at-P.normalImpulse,P.normalImpulse=at;const ct=l.normal.scale(J);g.applyImpulse(P.point,ct.negate()),p.applyImpulse(P.point,ct)}}}}}class fa extends is{get _processor(){return this._physics.collisionProcessor}constructor(e,s){super(),this._physics=s,this.systemType=Ji.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new zh(s.config.arcade),this._realisticSolver=new Uh(s.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=n=>this._processor.track(n),this._untrackCollider=n=>this._processor.untrack(n),this.query=e.query([Ot,ve,Je]),this.query.entityAdded$.subscribe(n=>{const a=n.get(Je);a.$colliderAdded.subscribe(this._trackCollider),a.$colliderRemoved.subscribe(this._untrackCollider);const l=a.get();l&&this._processor.track(l)}),this.query.entityRemoved$.subscribe(n=>{const a=n.get(Je),l=a.get();a&&l&&this._processor.untrack(l)}),this._motionSystem=e.get(ga)}initialize(e,s){this._engine=s.engine}update(e){var s,n,a,l;if(!this._physics.config.enabled)return;let g=[];for(let z=0;z<this.query.entities.length;z++){const J=this.query.entities[z].get(Je),at=J==null?void 0:J.get();if(J&&(!((s=J.owner)===null||s===void 0)&&s.isActive)&&at)if(J.update(),at instanceof ci){const ct=at.getColliders();at.compositeStrategy||(at.compositeStrategy=this._physics.config.colliders.compositeStrategy),g=g.concat(ct)}else g.push(at)}this._processor.update(g,e);let p=this._processor.broadphase(g,e);this._currentFrameContacts.clear();let v=[];const B=this.getSolver(),P=this._physics.config.substep;for(let z=0;z<P;z++)if(z>0&&this._motionSystem.update(e),v.length&&(p=v.map($=>new ki($.colliderA,$.colliderB))),p.length){v=this._processor.narrowphase(p,(l=(a=(n=this._engine)===null||n===void 0?void 0:n.debug)===null||a===void 0?void 0:a.stats)===null||l===void 0?void 0:l.currFrame),v=B.solve(v);for(const $ of v){if($.isCanceled())continue;const J=$.id.indexOf("|");if(J>0){const at=$.id.substring(J+1);this._currentFrameContacts.set(at,$)}else this._currentFrameContacts.set($.id,$)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const z of this.query.entities){const $=z.get(Je);$&&$.processColliderRemoval()}}postupdate(){$e.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new zh(this._physics.config.arcade),this._realisticSolver=new Uh(this._physics.config.realistic)),this._physics.config.solver===so.Realistic?this._realisticSolver:this._arcadeSolver}debug(e){this._processor.debug(e,0)}runContactStartEnd(){for(const[e,s]of this._currentFrameContacts)if(!this._lastFrameContacts.has(e)){const n=s.colliderA,a=s.colliderB,l=Dt.fromDirection(s.mtv),g=Dt.getOpposite(l);n.events.emit("collisionstart",new Jn(n,a,l,s)),n.events.emit("contactstart",new ta(n,a,l,s)),a.events.emit("collisionstart",new Jn(a,n,g,s)),a.events.emit("contactstart",new ta(a,n,g,s))}for(const[e,s]of this._lastFrameContacts)if(!this._currentFrameContacts.has(e)){const n=s.colliderA,a=s.colliderB,l=Dt.fromDirection(s.mtv),g=Dt.getOpposite(l);n.events.emit("collisionend",new Kn(n,a,l,s)),n.events.emit("contactend",new ea(n,a,l,s)),a.events.emit("collisionend",new Kn(a,n,g,s)),a.events.emit("contactend",new ea(a,n,g,s))}}}fa.priority=Ps.Higher;function jf(d,e,s,n){if(d.parent!==e.parent){const P=d.clone(),z=d.globalPos.clone(),$=d.globalScale.clone(),J=d.globalRotation;P.parent=e.parent,P.globalPos=z,P.globalScale=$,P.globalRotation=J,d=P}let a=e.pos,l=e.scale,g=e.rotation;a=e.pos.scale(s).add(d.pos.scale(1-s)),l=e.scale.scale(s).add(d.scale.scale(1-s));const p=(1-s)*Math.cos(d.rotation)+s*Math.cos(e.rotation),v=(1-s)*Math.sin(d.rotation)+s*Math.sin(e.rotation);g=Math.atan2(v,p);const B=n??new as;return B.setTransform(a,g,l),B}class Nh extends is{get sortedTransforms(){return this._sortedTransforms}constructor(e){super(),this.world=e,this.systemType=Ji.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new as,this.query=this.world.query([Ot,De]),this.query.entityAdded$.subscribe(s=>{const n=s.get(Ot);this._sortedTransforms.push(n),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{const n=s.get(Ot);n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const a=this._sortedTransforms.indexOf(n);a>-1&&this._sortedTransforms.splice(a,1)})}initialize(e,s){this._camera=s.camera,this._engine=s.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>e.globalZ-s.globalZ),this._zHasChanged=!1)}update(e){this._token++;let s;Ae.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let n=0;n<this._sortedTransforms.length;n++){const a=this._sortedTransforms[n],l=a.owner;if(l.hasTag("ex.offscreen")||(s=l.get(De),!s.isVisible))continue;s.onPreTransformDraw&&s.onPreTransformDraw(this._graphicsContext,e),l.events.emit("pretransformdraw",new K(this._graphicsContext,e,l)),a.coordPlane===We.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),a.coordPlane===We.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),s.update(e,this._token);const g=l.get(ca);if(g){const p=I.One.sub(g.parallaxFactor),v=this._camera.drawPos.scale(p);this._graphicsContext.translate(v.x,v.y)}this._applyTransform(l),s.material&&(this._graphicsContext.material=s.material),s.onPreDraw&&s.onPreDraw(this._graphicsContext,e),l.events.emit("predraw",new b(this._graphicsContext,e,l)),this._applyOpacity(l),this._drawGraphicsComponent(s,a),s.onPostDraw&&s.onPostDraw(this._graphicsContext,e),l.events.emit("postdraw",new M(this._graphicsContext,e,l)),this._graphicsContext.restore(),a.coordPlane===We.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),s.onPostTransformDraw&&s.onPostTransformDraw(this._graphicsContext,e),l.events.emit("posttransformdraw",new Rt(this._graphicsContext,e,l))}this._graphicsContext.restore()}_drawGraphicsComponent(e,s){var n,a;if(e.isVisible){const l=e.flipHorizontal,g=e.flipVertical,p=e.current,v=(n=e.currentOptions)!==null&&n!==void 0?n:{};if(p){let B=e.anchor,P=e.offset,z=1,$=1;v!=null&&v.anchor&&(B=v.anchor),v!=null&&v.offset&&(P=v.offset);const J=s.globalScale;z*=p.scale.x*J.x,$*=p.scale.y*J.y;const at=-p.width*B.x+P.x*z,ct=-p.height*B.y+P.y*$,At=p.flipHorizontal,lt=p.flipVertical;if((l||g)&&(p.flipHorizontal=l?!At:At,p.flipVertical=g?!lt:lt),p==null||p.draw(this._graphicsContext,at,ct),(l||g)&&(p.flipHorizontal=At,p.flipVertical=lt),!((a=this._engine)===null||a===void 0)&&a.isDebug&&this._engine.debug.graphics.showBounds){const gt=R(at,ct);if(p instanceof Ws)for(const Pt of p.members){let wt,Qt=I.Zero;Pt instanceof vt?wt=Pt:(wt=Pt.graphic,Qt=Pt.offset),p.useAnchor?wt==null||wt.localBounds.translate(gt.add(Qt)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):wt==null||wt.localBounds.translate(Qt).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else p==null||p.localBounds.translate(gt).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(e){const s=e.getAncestors();for(let n=0;n<s.length;n++){const a=s[n],l=a==null?void 0:a.get(Ot),g=a==null?void 0:a.get(ge);if(l){let p=l.get();if(g&&this._engine.fixedUpdateTimestep&&g.__oldTransformCaptured&&g.enableFixedUpdateInterpolate){const v=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;p=jf(g.oldTransform,l.get(),v,this._targetInterpolationTransform)}this._graphicsContext.z=l.globalZ,this._graphicsContext.translate(p.pos.x,p.pos.y),this._graphicsContext.scale(p.scale.x,p.scale.y),this._graphicsContext.rotate(p.rotation)}}}_applyOpacity(e){var s;const n=e.getAncestors();for(let a=0;a<n.length;a++){const l=n[a],g=l==null?void 0:l.get(De);this._graphicsContext.opacity*=(s=g==null?void 0:g.opacity)!==null&&s!==void 0?s:1}}}Nh.priority=Ps.Average;class Gh extends is{constructor(e){super(),this.world=e,this.systemType=Ji.Draw,this.query=this.world.query([Ot])}initialize(e,s){this._graphicsContext=s.engine.graphicsContext,this._camera=s.camera,this._engine=s.engine,this._collisionSystem=e.systemManager.get(fa)}update(){var e;if(!this._engine.isDebug)return;const s=this._engine.debug.filter;let n,a;const l=this._engine.debug.entity;let g;const p=this._engine.debug.transform;let v;const B=this._engine.debug.motion;let P;const z=this._engine.debug.collider,$=this._engine.debug.physics;let J;const at=this._engine.debug.graphics;let ct,At;const lt=this._engine.debug.body,gt=this._engine.debug.camera;for(let Pt=0;Pt<this.query.entities.length;Pt++){const wt=this.query.entities[Pt];if(wt.hasTag("offscreen")||wt instanceof ra||s.useFilter&&(!(s.ids.length===0||s.ids.includes(wt.id))||!(s.nameQuery===""||wt.name.includes(s.nameQuery))))continue;let Qt=I.Zero;const jt=R(0,16);if(n=wt.id,a=wt.name,g=wt.get(Ot),this._pushCameraTransform(g),this._graphicsContext.save(),g.coordPlane===We.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=p.debugZIndex,this._applyTransform(wt),g&&((p.showAll||p.showPosition)&&this._graphicsContext.debug.drawPoint(I.Zero,{size:4,color:p.positionColor}),(p.showAll||p.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${g.pos.toString(2)}`,Qt),Qt=Qt.add(jt)),(p.showAll||p.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${g.z.toFixed(1)})`,Qt),Qt=Qt.add(jt)),(l.showAll||l.showId)&&(this._graphicsContext.debug.drawText(`id(${n}) ${wt.parent?"child of id("+((e=wt.parent)===null||e===void 0?void 0:e.id)+")":""}`,Qt),Qt=Qt.add(jt)),(l.showAll||l.showName)&&(this._graphicsContext.debug.drawText(`name(${a})`,Qt),Qt=Qt.add(jt)),(p.showAll||p.showRotation)&&(this._graphicsContext.drawLine(I.Zero,I.fromAngle(g.rotation).scale(50).add(I.Zero),p.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${ot(g.rotation).toFixed(2)})`,Qt),Qt=Qt.add(jt)),(p.showAll||p.showScale)&&this._graphicsContext.drawLine(I.Zero,g.scale.add(I.Zero),p.scaleColor,2)),J=wt.get(De),J&&(at.showAll||at.showBounds)&&J.localBounds.draw(this._graphicsContext,at.boundsColor),ct=wt.get(da),ct&&(ct.useTransform||this._graphicsContext.restore(),ct.draw(this._graphicsContext,this._engine.debug),ct.useTransform||(this._graphicsContext.save(),this._applyTransform(wt))),At=wt.get(ge),At&&((lt.showAll||lt.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${At.group.name})`,Qt),Qt=Qt.add(jt)),(lt.showAll||lt.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${At.collisionType})`,Qt),Qt=Qt.add(jt)),(lt.showAll||lt.showMass)&&(this._graphicsContext.debug.drawText(`mass(${At.mass})`,Qt),Qt=Qt.add(jt)),(lt.showAll||lt.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${At.sleepMotion})`,Qt),Qt=Qt.add(jt)),(lt.showAll||lt.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${At.canSleep?At.isSleeping:"cant sleep"})`,Qt),Qt=Qt.add(jt))),this._graphicsContext.restore(),this._graphicsContext.save(),g.coordPlane===We.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=p.debugZIndex,v=wt.get(ve),v&&((B.showAll||B.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${v.vel.toString(2)}`,Qt.add(g.globalPos)),this._graphicsContext.drawLine(g.globalPos,g.globalPos.add(v.vel),B.velocityColor,2),Qt=Qt.add(jt)),(B.showAll||B.showAcceleration)&&this._graphicsContext.drawLine(g.globalPos,g.globalPos.add(v.acc),B.accelerationColor,2)),P=wt.get(Je),P){const It=P.get();if((z.showAll||z.showGeometry)&&It&&It.debug(this._graphicsContext,z.geometryColor,{lineWidth:z.geometryLineWidth,pointSize:z.geometryPointSize}),z.showAll||z.showBounds){if(It instanceof ci){const re=It.getColliders();for(const _e of re){const ke=_e.bounds,Qe=R(ke.left,ke.top);this._graphicsContext.debug.drawRect(Qe.x,Qe.y,ke.width,ke.height,{color:z.boundsColor}),(z.showAll||z.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${_e.owner.id})`,Qe)}P.bounds.draw(this._graphicsContext,z.boundsColor)}else if(It){const re=P.bounds,_e=R(re.left,re.top);this._graphicsContext.debug.drawRect(_e.x,_e.y,re.width,re.height,{color:z.boundsColor}),(z.showAll||z.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${P.owner.id})`,_e)}}}this._graphicsContext.restore(),this._popCameraTransform(g)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),($.showAll||$.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),$.showAll||$.showCollisionContacts||$.showCollisionNormals)for(const[Pt,wt]of this._engine.debug.stats.currFrame.physics.contacts){if($.showAll||$.showCollisionContacts)for(const Qt of wt.points)this._graphicsContext.debug.drawPoint(Qt,{size:$.contactSize,color:$.collisionContactColor});if($.showAll||$.showCollisionNormals)for(const Qt of wt.points)this._graphicsContext.debug.drawLine(Qt,wt.normal.scale(30).add(Qt),{color:$.collisionNormalColor})}this._graphicsContext.restore(),gt&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(gt.showAll||gt.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,gt.focusColor),(gt.showAll||gt.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(e,s){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),di.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(e){const s=e.getAncestors();for(const n of s){const a=n==null?void 0:n.get(Ot);a&&(this._graphicsContext.translate(a.pos.x,a.pos.y),this._graphicsContext.scale(a.scale.x,a.scale.y),this._graphicsContext.rotate(a.rotation))}}_pushCameraTransform(e){e.coordPlane===We.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(e){e.coordPlane===We.World&&this._graphicsContext.restore()}}Gh.priority=Ps.Lowest;class Oh{constructor(e,s){this.object=e,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=s,this.bounds=e.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const e=this.object.bounds,s=Math.floor(e.left/this.gridSize),n=Math.floor(e.right/this.gridSize),a=Math.floor(e.bottom/this.gridSize),l=Math.floor(e.top/this.gridSize);return this.leftX!==s||this.rightX!==n||this.bottomY!==a||this.topY!==l}clear(){for(const e of this.cells){const s=e.proxies.indexOf(this);s>-1&&e.proxies.splice(s,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class Ds{constructor(){this.proxies=[]}configure(e,s){this.x=e,this.y=s,this.key=Ds.calculateHashKey(e,s)}static calculateHashKey(e,s){return`${e}+${s}`}}class Hh{constructor(e){this.bounds=new ht,this._hashGridCellPool=new _t(()=>new Ds,s=>(s.configure(0,0),s.proxies.length=0,s),1e3),this.gridSize=e.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,e.proxyFactory?this._buildProxy=s=>e.proxyFactory(s,this.gridSize):this._buildProxy=s=>new Oh(s,this.gridSize)}query(e){const s=new Set;if(e instanceof ht){const n=e,a=Math.floor(n.left/this.gridSize),l=Math.floor(n.right/this.gridSize),g=Math.floor(n.bottom/this.gridSize),p=Math.floor(n.top/this.gridSize);for(let v=a;v<=l;v++)for(let B=p;B<=g;B++){const P=Ds.calculateHashKey(v,B),z=this.sparseHashGrid.get(P);if(z)for(let $=0;$<z.proxies.length;$++)z.proxies[$].updateBounds(),z.proxies[$].bounds.intersect(n)&&s.add(z.proxies[$].object)}}else{const n=e,a=Ds.calculateHashKey(Math.floor(n.x/this.gridSize),Math.floor(n.y/this.gridSize)),l=this.sparseHashGrid.get(a);if(l)for(let g=0;g<l.proxies.length;g++)l.proxies[g].updateBounds(),l.proxies[g].bounds.contains(n)&&s.add(l.proxies[g].object)}return Array.from(s)}get(e,s){const n=Ds.calculateHashKey(e,s);return this.sparseHashGrid.get(n)}_insert(e,s,n){const a=Ds.calculateHashKey(e,s);let l=this.sparseHashGrid.get(a);l||(l=this._hashGridCellPool.rent(),l.configure(e,s),this.sparseHashGrid.set(l.key,l)),l.proxies.push(n),n.cells.push(l),this.bounds.combine(n.bounds,this.bounds)}_remove(e,s,n){const a=Ds.calculateHashKey(e,s),l=this.sparseHashGrid.get(a);if(l){const g=l.proxies.indexOf(n);g>-1&&l.proxies.splice(g,1);const p=n.cells.indexOf(l);p>-1&&n.cells.splice(p,1),l.proxies.length===0&&(this._hashGridCellPool.return(l),this.sparseHashGrid.delete(a))}}track(e){const s=this._buildProxy(e);this.objectToProxy.set(e,s);for(let n=s.leftX;n<=s.rightX;n++)for(let a=s.topY;a<=s.bottomY;a++)this._insert(n,a,s)}untrack(e){const s=this.objectToProxy.get(e);s&&(s.clear(),this.objectToProxy.delete(e))}update(e){let s=0;for(const n of e){const a=this.objectToProxy.get(n);if(a&&a.hasChanged()){for(let l=a.leftX;l<=a.rightX;l++)for(let g=a.topY;g<=a.bottomY;g++)this._remove(l,g,a);a.update();for(let l=a.leftX;l<=a.rightX;l++)for(let g=a.topY;g<=a.bottomY;g++)this._insert(l,g,a);s++}}return s}debug(e,s){const n=q.Transparent,a=q.White;for(const l of this.sparseHashGrid.values())e.drawRectangle(R(l.x*this.gridSize,l.y*this.gridSize),this.gridSize,this.gridSize,n,a,2)}}class _a extends is{constructor(e){super(),this.world=e,this.systemType=Ji.Update,this._graphicsHashGrid=new Hh({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new Lh,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([Ot,vr]),this.query.entityAdded$.subscribe(s=>{const n=s.get(Ot),a=s.get(vr);this._pointerEventDispatcher.addObject(s,g=>a&&a.localBounds?a.localBounds.transform(n.get().matrix).contains(n.coordPlane===We.World?g.worldPos:g.screenPos):!1,()=>s.isActive),this._entityToPointer.set(s,a);const l=s.get(De);l&&(this._graphics.push(l),this._graphicsHashGrid.track(l)),this._sortedTransforms.push(n),this._sortedEntities.push(n.owner),n.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(s=>{this._pointerEventDispatcher.removeObject(s);const n=s.get(Ot);this._entityToPointer.delete(s);const a=s.get(De);if(a){const g=this._graphics.indexOf(a);g>-1&&this._graphics.splice(g,1),this._graphicsHashGrid.untrack(a)}n.zIndexChanged$.unsubscribe(this._zIndexUpdate);const l=this._sortedTransforms.indexOf(n);l>-1&&(this._sortedTransforms.splice(l,1),this._sortedEntities.splice(l,1))})}initialize(e,s){this._engine=s.engine,this._scene=s}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((e,s)=>s.z-e.z),this._sortedEntities=this._sortedTransforms.map(e=>e.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[e,s]of this._engineReceiver.currentFramePointerCoords.entries()){const n=this._scene.physics.query(s.worldPos);for(let l=0;l<n.length;l++){const g=n[l],p=this._entityToPointer.get(g.owner);p&&(p.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(g.owner,e)}const a=this._graphicsHashGrid.query(s.worldPos);for(let l=0;l<a.length;l++){const g=a[l],p=this._entityToPointer.get(g.owner);p&&(p.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(g.owner,e)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(e=>e.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(e=>e.clear())}}_a.priority=Ps.Higher;class Wh extends is{constructor(e){super(),this.world=e,this.systemType=Ji.Update,this._actions=[],this.query=this.world.query([Tn]),this.query.entityAdded$.subscribe(s=>this._actions.push(s.get(Tn))),this.query.entityRemoved$.subscribe(s=>{const n=s.get(Tn),a=this._actions.indexOf(n);a>-1&&this._actions.splice(a,1)})}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}}Wh.priority=Ps.Higher;class co extends Hi{constructor(e){super(),this.elevation=0,this.columns=e.columns,this.rows=e.rows,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight}}class qh extends is{constructor(e){super(),this.world=e,this.systemType=Ji.Update,this.query=this.world.query([Ot,co])}update(){let e,s;for(let n=0;n<this.query.entities.length;n++){const a=this.query.entities[n];e=a.get(Ot),s=a.get(co);const g=Math.max(s.columns*s.tileWidth,s.rows*s.tileHeight)*s.elevation+e.pos.y;e.z=g}}}qh.priority=Ps.Lower;class Vh extends is{constructor(e){super(),this.world=e,this.systemType=Ji.Draw,this.query=this.world.query([Ot,De])}initialize(e,s){this._camera=s.camera,this._screen=s.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let e,s,n;for(let a=0;a<this.query.entities.length;a++){const l=this.query.entities[a];s=l.get(De),e=l.get(Ot),n=l.get(ca);let g;if(n){const v=I.One.sub(n.parallaxFactor);g=this._camera.pos.scale(v)}const p=this._isOffscreen(e,s,g);p&&!l.hasTag("ex.offscreen")&&(l.events.emit("exitviewport",new _h(l)),l.addTag("ex.offscreen")),!p&&l.hasTag("ex.offscreen")&&(l.events.emit("enterviewport",new ph(l)),l.removeTag("ex.offscreen"))}}_isOffscreen(e,s,n){if(s.forceOnScreen)return!1;if(e.coordPlane===We.World){let a=s.localBounds;n&&(a=a.translate(n));const l=a.transform(e.get().matrix);return!this._worldBounds.overlaps(l)}else return!1}}Vh.priority=Ps.Higher;class zd extends Oh{constructor(e,s){var n,a;super(e,s),this.collider=e,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=s;const l=e.bounds;this.hasZeroBounds=l.hasZeroDimensions(),this.leftX=Math.floor(l.left/this.gridSize),this.rightX=Math.floor(l.right/this.gridSize),this.bottomY=Math.floor(l.bottom/this.gridSize),this.topY=Math.floor(l.top/this.gridSize),this.owner=e.owner,this.body=(n=this.owner)===null||n===void 0?void 0:n.get(ge),this.collisionType=(a=this.body.collisionType)!==null&&a!==void 0?a:ee.PreventCollision}update(){var e,s;super.update(),this.body=(e=this.owner)===null||e===void 0?void 0:e.get(ge),this.collisionType=(s=this.body.collisionType)!==null&&s!==void 0?s:ee.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class jh{constructor(e){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new Mr(()=>new ki({id:T("collider",0)},{id:T("collider",0)}),s=>(s.colliderA=null,s.colliderB=null,s),200),this.gridSize=e.size,this.hashGrid=new Hh({size:this.gridSize,proxyFactory:(s,n)=>new zd(s,n)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(e){return this.hashGrid.query(e)}rayCast(e,s){var n,a,l;const g=[],p=(n=s==null?void 0:s.maxDistance)!==null&&n!==void 0?n:1/0,v=s==null?void 0:s.collisionGroup,B=v?v.category:(a=s==null?void 0:s.collisionMask)!==null&&a!==void 0?a:js.All.category,P=(l=s==null?void 0:s.searchAllColliders)!==null&&l!==void 0?l:!1,z=e.dir.normalize(),$=z.y/z.x,J=z.x/z.y,at=Math.sqrt(1+$*$)*this.gridSize,ct=Math.sqrt(1+J*J)*this.gridSize,At=e.pos.x/this.gridSize,lt=e.pos.y/this.gridSize,gt=R(1,1);let Pt=~~At,wt=~~lt,Qt=0,jt=0;z.x<0?(gt.x=-1,Qt=(At-Pt)*at):(gt.x=1,Qt=(Pt+1-At)*at),z.y<0?(gt.y=-1,jt=(lt-wt)*ct):(gt.y=1,jt=(wt+1-lt)*ct);const It=new Set;let re=!1,_e=9999;for(;!re&&_e>0&&(_e--,!!this.hashGrid.bounds.contains(R(Pt*this.gridSize,wt*this.gridSize)));){const ke=Ds.calculateHashKey(Pt,wt),Qe=this.hashGrid.sparseHashGrid.get(ke);if(Qe){const Bi=[];for(let je=0;je<Qe.proxies.length;je++){const Fe=Qe.proxies[je];if(!It.has(Fe.collider.id.value)){if(It.add(Fe.collider.id.value),s!=null&&s.ignoreCollisionGroupAll&&Fe.body.group===js.All)continue;const Ti=(B&Fe.body.group.category)!==0;if(Fe.body.group&&!Ti)continue;const mi=Fe.collider.rayCast(e,p);mi&&Bi.push(mi)}}Bi.sort((je,Fe)=>je.distance-Fe.distance);for(let je=0;je<Bi.length;je++){const Fe=Bi[je];if(s!=null&&s.filter){if(s.filter(Fe)&&(g.push(Fe),!P)){re=!0;break}}else if(g.push(Fe),!P){re=!0;break}}}Qt<jt?(Pt+=gt.x,Qt+=at):(wt+=gt.y,jt+=ct)}return g.sort((ke,Qe)=>ke.distance-Qe.distance),!P&&g.length?[g[0]]:g}track(e){let s=[e];if(e instanceof ci){const n=e.getColliders();for(const a of n)a.owner=e.owner;s=n}for(const n of s)this.hashGrid.track(n)}untrack(e){let s=[e];e instanceof ci&&(s=e.getColliders());for(const n of s)this.hashGrid.untrack(n)}_canCollide(e,s){return!(e.collider.id===s.collider.id||e.owner&&s.owner&&e.owner.id===s.owner.id||e.hasZeroBounds||s.hasZeroBounds||!e.body.group.canCollide(s.body.group)||e.collisionType===ee.Fixed&&s.collisionType===ee.Fixed||e.collisionType===ee.PreventCollision||s.collisionType===ee.PreventCollision||!e.owner.isActive||!s.owner.isActive)}broadphase(e,s){const n=[];this._pairs.clear(),this._nonPairs.clear();let a=0;for(const l of this.hashGrid.objectToProxy.values())if(l.id=a++,!(!l.owner.isActive||l.collisionType===ee.PreventCollision))for(let g=0;g<l.cells.length;g++){const p=l.cells[g];for(let v=0;v<p.proxies.length;v++){const B=p.proxies[v];if(B.id===l.id)continue;const P=ki.calculatePairHash(l.collider.id,B.collider.id);if(!this._nonPairs.has(P))if(!this._pairs.has(P)&&this._canCollide(l,B)&&l.object.bounds.overlaps(B.object.bounds)){const z=this._pairPool.get();z.colliderA=l.collider,z.colliderB=B.collider,z.id=P,this._pairs.add(P),n.push(z)}else this._nonPairs.add(P)}}return n}narrowphase(e,s){const n=[];for(let a=0;a<e.length;a++){const l=e[a].collide();for(let g=0;g<l.length;g++){const p=l[g];n.push(p),s&&s.physics.contacts.set(p.id,p)}}return this._pairPool.done(),s&&(s.physics.collisions+=n.length),n}update(e,s){return this.hashGrid.update(e)}debug(e,s){this.hashGrid.debug(e,s)}}class Ud{get config(){return Bt(this._config,e=>{this.$configUpdate.notifyAll(e)})}set config(e){this._config=e,this.$configUpdate.notifyAll(e)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const e=this._collisionProcessor.getColliders();this._config.spatialPartition===Bn.SparseHashGrid?this._collisionProcessor=new jh(this._config.sparseHashGrid):this._collisionProcessor=new ha(this._config);for(const s of e)this._collisionProcessor.track(s)}return this._collisionProcessor}constructor(e){this.$configUpdate=new hi,this._configDirty=!1,this.config=e,this.$configUpdate.subscribe(s=>{this._configDirty=!0,ge.updateDefaultPhysicsConfig(s.bodies)}),this._config.spatialPartition===Bn.SparseHashGrid?this._collisionProcessor=new jh(this._config.sparseHashGrid):this._collisionProcessor=new ha(this._config)}rayCast(e,s){return this.collisionProcessor.rayCast(e,s)}query(e){return this._collisionProcessor.query(e)}}class pa{constructor(){this.events=new S,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(e){this._enabled=e}setMinimumGamepadConfiguration(e){this._enableAndUpdate(),this._minimumConfiguration=e}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(e){if(!this._minimumConfiguration)return!0;if(!e)return!1;const s=e.axes.filter(a=>typeof a!==void 0).length,n=e.buttons.filter(a=>typeof a!==void 0).length;return s>=this._minimumConfiguration.axis&&n>=this._minimumConfiguration.buttons&&e.connected}emit(e,s){this.events.emit(e,s)}on(e,s){return this._enableAndUpdate(),this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this._enableAndUpdate(),this.events.off(e,s)}update(){if(!this.enabled||!this.supported||!this._enabled)return;this.init();const e=this._navigator.getGamepads();for(let s=0;s<e.length;s++){if(e[s])!this.at(s).connected&&this._isGamepadValid(e[s])&&this.events.emit("connect",new Or(s,this.at(s))),this.at(s).connected=!0;else{const v=this.at(s);v.connected&&this.events.emit("disconnect",new hh(s,v)),v.connected=!1;continue}if(this.at(s).update(),e[s].timestamp&&e[s].timestamp===this._gamePadTimeStamps[s])continue;this._gamePadTimeStamps[s]=e[s].timestamp,this.at(s).navigatorGamepad=e[s];let n,a,l,g,p;for(n in uo)a=uo[n],typeof a=="number"&&e[s].buttons[a]&&(p=e[s].buttons[a].value,p!==this._oldPads[s].getButton(a)&&(e[s].buttons[a].pressed?(this.at(s).updateButton(a,p),this.at(s).events.emit("button",new lh(a,p,this.at(s)))):this.at(s).updateButton(a,0)));for(l in go)g=go[l],typeof g=="number"&&(p=e[s].axes[g],p!==this._oldPads[s].getAxes(g)&&(this.at(s).updateAxes(g,p),this.at(s).events.emit("axis",new ch(g,p,this.at(s)))));this._oldPads[s]=this._clonePad(e[s])}}at(e){if(this._enableAndUpdate(),e>=this._pads.length)for(let s=this._pads.length-1,n=e;s<n;s++)this._pads.push(new Aa),this._oldPads.push(new Aa);return this._pads[e]}getValidGamepads(){this._enableAndUpdate();const e=[];for(let s=0;s<this._pads.length;s++)this._isGamepadValid(this.at(s).navigatorGamepad)&&this.at(s).connected&&e.push(this.at(s));return e}count(){return this._pads.filter(e=>e.connected).length}_clonePads(e){const s=[];for(let n=0,a=e.length;n<a;n++)s.push(this._clonePad(e[n]));return s}_clonePad(e){let s,n;const a=new Aa;if(!e)return a;for(s=0,n=e.buttons.length;s<n;s++)e.buttons[s]&&a.updateButton(s,e.buttons[s].value);for(s=0,n=e.axes.length;s<n;s++)a.updateAxes(s,e.axes[s]);return a}}pa.MinAxisMoveThreshold=.05;class Aa{constructor(){this.events=new S,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let e=0;e<this._buttons.length;e++)this._buttons[e]=0;for(let e=0;e<this._axes.length;e++)this._axes[e]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(e,s=1){return this._buttons[e]>=s}isButtonHeld(e,s=1){return this._buttons[e]>=s}wasButtonPressed(e,s=1){return this._buttonsDown[e]>=s}wasButtonReleased(e){return!!this._buttonsUp[e]}getButton(e){return this._buttons[e]}getAxes(e){const s=this._axes[e];return Math.abs(s)<pa.MinAxisMoveThreshold?0:s}updateButton(e,s){s===0&&this._buttons[e]?this._buttonsUp[e]=1:this._buttonsDown[e]=s,this._buttons[e]=s}updateAxes(e,s){this._axes[e]=s}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}}var uo;(function(d){d[d.Face1=0]="Face1",d[d.Face2=1]="Face2",d[d.Face3=2]="Face3",d[d.Face4=3]="Face4",d[d.LeftBumper=4]="LeftBumper",d[d.RightBumper=5]="RightBumper",d[d.LeftTrigger=6]="LeftTrigger",d[d.RightTrigger=7]="RightTrigger",d[d.Select=8]="Select",d[d.Start=9]="Start",d[d.LeftStick=10]="LeftStick",d[d.RightStick=11]="RightStick",d[d.DpadUp=12]="DpadUp",d[d.DpadDown=13]="DpadDown",d[d.DpadLeft=14]="DpadLeft",d[d.DpadRight=15]="DpadRight"})(uo||(uo={}));var go;(function(d){d[d.LeftStickX=0]="LeftStickX",d[d.LeftStickY=1]="LeftStickY",d[d.RightStickX=2]="RightStickX",d[d.RightStickY=3]="RightStickY"})(go||(go={}));class Nd{constructor(e){this.inputs=e,this._handlers=new Map}execute(){for(const[e,s]of this._handlers.entries()){const n=e(this.inputs);n&&s(n)}}on(e,s){this._handlers.set(e,s)}}function Gd(){try{const d=()=>{};window.top.addEventListener("blur",d),window.top.removeEventListener("blur",d)}catch{return!0}return!1}var fo;(function(d){d.Backquote="Backquote",d.Backslash="Backslash",d.BracketLeft="BracketLeft",d.BracketRight="BracketRight",d.Comma="Comma",d.Key0="Digit0",d.Key1="Digit1",d.Key2="Digit2",d.Key3="Digit3",d.Key4="Digit4",d.Key5="Digit5",d.Key6="Digit6",d.Key7="Digit7",d.Key8="Digit8",d.Key9="Digit9",d.Digit0="Digit0",d.Digit1="Digit1",d.Digit2="Digit2",d.Digit3="Digit3",d.Digit4="Digit4",d.Digit5="Digit5",d.Digit6="Digit6",d.Digit7="Digit7",d.Digit8="Digit8",d.Digit9="Digit9",d.Equal="Equal",d.IntlBackslash="IntlBackslash",d.IntlRo="IntlRo",d.IntlYen="IntlYen",d.A="KeyA",d.B="KeyB",d.C="KeyC",d.D="KeyD",d.E="KeyE",d.F="KeyF",d.G="KeyG",d.H="KeyH",d.I="KeyI",d.J="KeyJ",d.K="KeyK",d.L="KeyL",d.M="KeyM",d.N="KeyN",d.O="KeyO",d.P="KeyP",d.Q="KeyQ",d.R="KeyR",d.S="KeyS",d.T="KeyT",d.U="KeyU",d.V="KeyV",d.W="KeyW",d.X="KeyX",d.Y="KeyY",d.Z="KeyZ",d.KeyA="KeyA",d.KeyB="KeyB",d.KeyC="KeyC",d.KeyD="KeyD",d.KeyE="KeyE",d.KeyF="KeyF",d.KeyG="KeyG",d.KeyH="KeyH",d.KeyI="KeyI",d.KeyJ="KeyJ",d.KeyK="KeyK",d.KeyL="KeyL",d.KeyM="KeyM",d.KeyN="KeyN",d.KeyO="KeyO",d.KeyP="KeyP",d.KeyQ="KeyQ",d.KeyR="KeyR",d.KeyS="KeyS",d.KeyT="KeyT",d.KeyU="KeyU",d.KeyV="KeyV",d.KeyW="KeyW",d.KeyX="KeyX",d.KeyY="KeyY",d.KeyZ="KeyZ",d.Minus="Minus",d.Period="Period",d.Quote="Quote",d.Semicolon="Semicolon",d.Slash="Slash",d.AltLeft="AltLeft",d.AltRight="AltRight",d.Alt="Alt",d.AltGraph="AltGraph",d.Backspace="Backspace",d.CapsLock="CapsLock",d.ContextMenu="ContextMenu",d.ControlLeft="ControlLeft",d.ControlRight="ControlRight",d.Enter="Enter",d.MetaLeft="MetaLeft",d.MetaRight="MetaRight",d.ShiftLeft="ShiftLeft",d.ShiftRight="ShiftRight",d.Space="Space",d.Tab="Tab",d.Convert="Convert",d.KanaMode="KanaMode",d.NonConvert="NonConvert",d.Delete="Delete",d.End="End",d.Help="Help",d.Home="Home",d.Insert="Insert",d.PageDown="PageDown",d.PageUp="PageUp",d.Up="ArrowUp",d.Down="ArrowDown",d.Left="ArrowLeft",d.Right="ArrowRight",d.ArrowUp="ArrowUp",d.ArrowDown="ArrowDown",d.ArrowLeft="ArrowLeft",d.ArrowRight="ArrowRight",d.NumLock="NumLock",d.Numpad0="Numpad0",d.Numpad1="Numpad1",d.Numpad2="Numpad2",d.Numpad3="Numpad3",d.Numpad4="Numpad4",d.Numpad5="Numpad5",d.Numpad6="Numpad6",d.Numpad7="Numpad7",d.Numpad8="Numpad8",d.Numpad9="Numpad9",d.Num0="Numpad0",d.Num1="Numpad1",d.Num2="Numpad2",d.Num3="Numpad3",d.Num4="Numpad4",d.Num5="Numpad5",d.Num6="Numpad6",d.Num7="Numpad7",d.Num8="Numpad8",d.Num9="Numpad9",d.NumAdd="NumpadAdd",d.NumpadAdd="NumpadAdd",d.NumDecimal="NumpadDecimal",d.NumpadDecimal="NumpadDecimal",d.NumDivide="NumpadDivide",d.NumpadDivide="NumpadDivide",d.NumEnter="NumpadEnter",d.NumpadEnter="NumpadEnter",d.NumMultiply="NumpadMultiply",d.NumpadMultiply="NumpadMultiply",d.NumSubtract="NumpadSubtract",d.NumpadSubtract="NumpadSubtract",d.Esc="Escape",d.Escape="Escape",d.F1="F1",d.F2="F2",d.F3="F3",d.F4="F4",d.F5="F5",d.F6="F6",d.F7="F7",d.F8="F8",d.F9="F9",d.F10="F10",d.F11="F11",d.F12="F12",d.F13="F13",d.F14="F14",d.F15="F15",d.F16="F16",d.F17="F17",d.F18="F18",d.F19="F19",d.F20="F20",d.PrintScreen="PrintScreen",d.ScrollLock="ScrollLock",d.Pause="Pause",d.Unidentified="Unidentified"})(fo||(fo={}));class _o extends ne{constructor(e,s,n){super(),this.key=e,this.value=s,this.originalEvent=n}}class Od{constructor(){this.events=new S,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=e=>{for(const s of this._keys){const n=new _o(s,e.key,e);this.events.emit("up",n),this.events.emit("release",n)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=e=>{if(!this._enabled)return;!e.metaKey&&(this._keys.includes(fo.MetaLeft)||this._keys.includes(fo.MetaRight))&&this._releaseAllKeys(e);const s=e.code;if(this._keys.indexOf(s)===-1){this._keys.push(s),this._keysDown.push(s);const n=new _o(s,e.key,e);this.events.emit("down",n),this.events.emit("press",n)}},this._handleKeyUp=e=>{if(!this._enabled)return;const s=e.code,n=this._keys.indexOf(s);this._keys.splice(n,1),this._keysUp.push(s);const a=new _o(s,e.key,e);this.events.emit("up",a),this.events.emit("release",a),e.key==="Meta"&&this._releaseAllKeys(e)}}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}init(e){let{global:s}=e;const{grabWindowFocus:n}=e;s||(Gd()?(s=window,n&&window.focus(),j.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):s=window.top),s.addEventListener("blur",()=>{this._keys.length=0}),s.addEventListener("keyup",this._handleKeyUp),s.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(e){this._enabled=e}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let e=0;e<this._keys.length;e++)this.events.emit("hold",new _o(this._keys[e]))}getKeys(){return this._keys}wasPressed(e){return this._enabled?this._keysDown.indexOf(e)>-1:!1}isHeld(e){return this._enabled?this._keys.indexOf(e)>-1:!1}wasReleased(e){return this._enabled?this._keysUp.indexOf(e)>-1:!1}triggerEvent(e,s,n){e==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:s,key:n??null})),e==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:s,key:n??null}))}}class Sn{static fromPagePosition(e,s,n){let a,l,g,p;arguments.length===3?(a=e,l=s,g=new I(a,l),p=n):(g=e,a=g.x,l=g.y,p=s);const v=p.screen.pageToScreenCoordinates(g),B=p.screen.screenToWorldCoordinates(v);return new Sn(B,g,v)}constructor(e,s,n){this.worldPos=e,this.pagePos=s,this.screenPos=n}}class po{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(e,s,n,a,l,g){this.type=e,this.pointerId=s,this.button=n,this.pointerType=a,this.coordinates=l,this.nativeEvent=g,this.active=!0}}class Hd{cancel(){this.active=!1}constructor(e,s,n,a,l,g,p,v,B,P,z,$){this.x=e,this.y=s,this.pageX=n,this.pageY=a,this.screenX=l,this.screenY=g,this.index=p,this.deltaX=v,this.deltaY=B,this.deltaZ=P,this.deltaMode=z,this.ev=$,this.active=!0}}class Yh{constructor(){this.events=new S,this.lastPagePos=I.Zero,this.lastScreenPos=I.Zero,this.lastWorldPos=I.Zero,this._onPointerMove=e=>{this.lastPagePos=new I(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new I(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new I(e.worldPos.x,e.worldPos.y)},this._onPointerDown=e=>{this.lastPagePos=new I(e.pagePos.x,e.pagePos.y),this.lastScreenPos=new I(e.screenPos.x,e.screenPos.y),this.lastWorldPos=new I(e.worldPos.x,e.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}_updateWorldPosition(e){const s=Sn.fromPagePosition(this.lastPagePos,e);this.lastScreenPos=s.screenPos,this.lastWorldPos=s.worldPos}}var Pn;(function(d){d.Pixel="Pixel",d.Line="Line",d.Page="Page"})(Pn||(Pn={}));var wr;(function(d){d[d.NoButton=-1]="NoButton",d[d.Left=0]="Left",d[d.Middle=1]="Middle",d[d.Right=2]="Right",d[d.Unknown=3]="Unknown"})(wr||(wr={}));var Xs;(function(d){d.Left="Left",d.Middle="Middle",d.Right="Right",d.Unknown="Unknown",d.NoButton="NoButton"})(Xs||(Xs={}));var Zs;(function(d){d.Touch="Touch",d.Mouse="Mouse",d.Pen="Pen",d.Unknown="Unknown"})(Zs||(Zs={}));function Yf(d){return globalThis.TouchEvent&&d instanceof globalThis.TouchEvent}function Xf(d){return globalThis.PointerEvent&&d instanceof globalThis.PointerEvent}class ma{constructor(e,s){this.target=e,this.engine=s,this.events=new S,this.primary=new Yh,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(e){this._enabled=e}recreate(e,s){const n=new ma(e,s);return n.primary=this.primary,n._pointers=this._pointers,n}at(e){if(e>=this._pointers.length)for(let s=this._pointers.length-1,n=e;s<n;s++)this._pointers.push(new Yh);return this._pointers[e]}count(){return this._pointers.length}isDown(e){var s;return this._enabled&&(s=this.currentFramePointerDown.get(e))!==null&&s!==void 0?s:!1}wasDown(e){var s;return this._enabled&&(s=this.lastFramePointerDown.get(e))!==null&&s!==void 0?s:!1}isDragging(e){return this._enabled?this.isDown(e):!1}isDragStart(e){return this._enabled?this.isDown(e)&&!this.wasDown(e):!1}isDragEnd(e){return this._enabled?!this.isDown(e)&&this.wasDown(e):!1}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const e of this.currentFrameDown){if(!e.active)continue;this.emit("down",e),this.at(e.pointerId).emit("down",e),this.primary.emit("pointerdown",e)}for(const e of this.currentFrameUp){if(!e.active)continue;this.emit("up",e),this.at(e.pointerId).emit("up",e)}for(const e of this.currentFrameMove){if(!e.active)continue;this.emit("move",e),this.at(e.pointerId).emit("move",e)}for(const e of this.currentFrameCancel){if(!e.active)continue;this.emit("cancel",e),this.at(e.pointerId).emit("cancel",e)}for(const e of this.currentFrameWheel)e.active&&(this.emit("pointerwheel",e),this.emit("wheel",e),this.primary.emit("pointerwheel",e),this.primary.emit("wheel",e));if(this.engine.currentScene.camera.hasChanged())for(const e of this._pointers)e._updateWorldPosition(this.engine)}clear(){for(const e of this.currentFrameUp){this.currentFramePointerCoords.delete(e.pointerId);const s=this._activeNativePointerIdsToNormalized.entries();for(const[n,a]of s)a===e.pointerId&&this._activeNativePointerIdsToNormalized.delete(n)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(e){var s;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const n={passive:!(this.engine.pageScrollPreventionMode===yr.All||this.engine.pageScrollPreventionMode===yr.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,n):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,n):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,n),((s=e==null?void 0:e.grabWindowFocus)!==null&&s!==void 0?s:!0)&&Gd()){const l=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",l):(this.target.addEventListener("touchstart",l),this.target.addEventListener("mousedown",l))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(e){this._activeNativePointerIdsToNormalized.set(e,-1);const n=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a,l)=>a-l).findIndex(a=>a===e);return this._activeNativePointerIdsToNormalized.set(e,n),n}_handle(e){if(!this._enabled)return;e.preventDefault();const s=new Map;let n,a;if(Yf(e)){n=Xs.Unknown,a=Zs.Touch;for(let l=0;l<e.changedTouches.length;l++){const g=e.changedTouches[l],p=Sn.fromPagePosition(g.pageX,g.pageY,this.engine),v=l+1,B=this._normalizePointerId(v);this.currentFramePointerCoords.set(B,p),s.set(B,p)}}else{n=this._nativeButtonToPointerButton(e.button),a=Zs.Mouse;const l=Sn.fromPagePosition(e.pageX,e.pageY,this.engine);let g=1;Xf(e)&&(g=e.pointerId,a=this._stringToPointerType(e.pointerType));const p=this._normalizePointerId(g);this.currentFramePointerCoords.set(p,l),s.set(p,l)}for(const[l,g]of s.entries())switch(e.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new po("down",l,n,a,g,e)),this.currentFramePointerDown.set(l,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new po("up",l,n,a,g,e)),this.currentFramePointerDown.set(l,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new po("move",l,n,a,g,e));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new po("cancel",l,n,a,g,e));break}}_handleWheel(e){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===yr.All||this.engine.pageScrollPreventionMode===yr.Canvas&&e.target===this.engine.canvas)&&e.preventDefault();const s=this.engine.screen.pageToScreenCoordinates(R(e.pageX,e.pageY)),n=this.engine.screen.screenToWorldCoordinates(s),a=-1/40,l=e.deltaX||e.wheelDeltaX*a||0,g=e.deltaY||e.wheelDeltaY*a||e.wheelDelta*a||e.detail||0,p=e.deltaZ||0;let v=Pn.Pixel;e.deltaMode&&(e.deltaMode===1?v=Pn.Line:e.deltaMode===2&&(v=Pn.Page));const B=new Hd(n.x,n.y,e.pageX,e.pageY,s.x,s.y,0,l,g,p,v,e);this.currentFrameWheel.push(B)}triggerEvent(e,s){const n=this.engine.screen.worldToPageCoordinates(s);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+e,{pointerId:0,clientX:n.x,clientY:n.y})):this._handle(new window.MouseEvent("mouse"+e,{clientX:n.x,clientY:n.y}));const a=this.engine.currentScene.world.get(_a);a.preupdate(this.engine.currentScene,1),a.update(1)}_nativeButtonToPointerButton(e){switch(e){case wr.NoButton:return Xs.NoButton;case wr.Left:return Xs.Left;case wr.Middle:return Xs.Middle;case wr.Right:return Xs.Right;case wr.Unknown:return Xs.Unknown;default:return yt(e)}}_stringToPointerType(e){switch(e){case"touch":return Zs.Touch;case"mouse":return Zs.Mouse;case"pen":return Zs.Pen;default:return Zs.Unknown}}}class Xh{constructor(e){this._enabled=!0;const{pointerTarget:s,grabWindowFocus:n,engine:a}=e;this.keyboard=new Od,this.pointers=new ma(s,a),this.gamepads=new pa,this.keyboard.init({grabWindowFocus:n}),this.pointers.init({grabWindowFocus:n}),this.gamepads.init(),this.inputMapper=new Nd({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(e){this._enabled=e,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class Zf{}const $f={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function Rs(d){var e,s;return!!(d!=null&&d.prototype)&&!!(!((s=(e=d==null?void 0:d.prototype)===null||e===void 0?void 0:e.constructor)===null||s===void 0)&&s.name)}class ss{get actors(){return this.world.entityManager.entities.filter(e=>e instanceof Qi)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(e=>e instanceof Dd)}get tileMaps(){return this.world.entityManager.entities.filter(e=>e instanceof xd)}get timers(){return this._timers}constructor(){this._logger=j.getInstance(),this.events=new S,this.camera=new Pd,this.world=new Qd(this),this.physics=new Ud(Ys()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(Wh),this.world.add(new ga(this.world,this.physics)),this.world.add(new fa(this.world,this.physics)),this.world.add(_a),this.world.add(qh),this.world.add(Vh),this.world.add(Nh),this.world.add(Gh)}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}onPreLoad(e){}onTransition(e){}onInitialize(e){}onActivate(e){}onDeactivate(e){}onPreUpdate(e,s){}onPostUpdate(e,s){}onPreDraw(e,s){}onPostDraw(e,s){}_initializeChildren(){for(const e of this.entities)e._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(e){var s;if(!this.isInitialized){try{this.engine=e,this.physics.config=this.engine.physics,this.input=new Xh({pointerTarget:e.pointerScope===E.Canvas?e.canvas:document,grabWindowFocus:e.grabWindowFocus,engine:e}),this.camera._initialize(e),this.world.systemManager.initialize(),await this.onInitialize(e),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,e),this.events.emit("initialize",new En(e,this))}catch(n){throw this._logger.error(`Error during scene initialization for scene ${(s=e.director)===null||s===void 0?void 0:s.getSceneName(this)}!`),n}this._isInitialized=!0}}async _activate(e){var s,n;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(e)}catch(a){throw this._logger.error(`Error during scene activation for scene ${(n=(s=this.engine)===null||s===void 0?void 0:s.director)===null||n===void 0?void 0:n.getSceneName(this)}!`),a}}async _deactivate(e){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(e)}_preupdate(e,s){this.emit("preupdate",new zt(e,s,this)),this.onPreUpdate(e,s)}_postupdate(e,s){this.emit("postupdate",new Vt(e,s,this)),this.onPostUpdate(e,s)}_predraw(e,s){this.emit("predraw",new b(e,s,this)),this.onPreDraw(e,s)}_postdraw(e,s){this.emit("postdraw",new M(e,s,this)),this.onPostDraw(e,s)}update(e,s){var n;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(n=e.director)===null||n===void 0?void 0:n.getSceneName(this)}!`);return}this._preupdate(e,s);let a,l;for(a=0,l=this._cancelQueue.length;a<l;a++)this.removeTimer(this._cancelQueue[a]);this._cancelQueue.length=0;for(const g of this._timers)g.update(s);this.world.update(Ji.Update,s),this.camera&&this.camera.update(e,s),this._collectActorStats(e),this._postupdate(e,s),this.input.update()}draw(e,s){var n;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(e,s),this.world.update(Ji.Draw,s),!((n=this.engine)===null||n===void 0)&&n.isDebug&&this.debugDraw(e),this._postdraw(e,s)}debugDraw(e){this.emit("predebugdraw",new dt(e,this)),this.emit("postdebugdraw",new Tt(e,this))}contains(e){return this.actors.indexOf(e)>-1}add(e){if(this.emit("entityadded",{target:e}),this.world.add(e),e.scene=this,e instanceof Zr){xt(this._timers,e)||this.addTimer(e);return}}transfer(e){let s;e instanceof Ci&&e.scene&&e.scene!==this&&(s=e.scene,e.scene.world.remove(e,!1)),e instanceof Zr&&e.scene&&(s=e.scene,e.scene.removeTimer(e)),s==null||s.emit("entityremoved",{target:e}),this.add(e)}remove(e){e instanceof Ci&&(this.emit("entityremoved",{target:e}),e.isActive&&e.kill(),this.world.remove(e)),e instanceof Zr&&this.removeTimer(e)}clear(e=!0){for(let s=this.entities.length-1;s>=0;s--)this.world.remove(this.entities[s],e);for(let s=this.timers.length-1;s>=0;s--)this.removeTimer(this.timers[s])}addTimer(e){return this._timers.push(e),e.scene=this,e}removeTimer(e){const s=this._timers.indexOf(e);return s!==-1&&this._timers.splice(s,1),e}cancelTimer(e){return this._cancelQueue.push(e),e}isTimerActive(e){return this._timers.indexOf(e)>-1&&!e.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(e){const s=this.actors;for(let n=0;n<s.length;n++){const a=s[n];a instanceof Qh&&e.stats.currFrame.actors.ui++,e.stats.currFrame.actors.alive++;for(let l=0;l<a.children.length;l++){const g=a.children[l];wd(g)?e.stats.currFrame.actors.ui++:e.stats.currFrame.actors.alive++}}}}var $r;(function(d){d.Protanope="Protanope",d.Deuteranope="Deuteranope",d.Tritanope="Tritanope"})($r||($r={}));const Jf=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class Wd{constructor(e,s){this._shader=new Ze({gl:e,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:s}),this._shader.compile(),this._buffer=new Fi({gl:e,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new pi({gl:e,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class qd{constructor(e,s=!1){this._colorBlindnessMode=e,this._simulate=!1,this._simulate=s}initialize(e){this._shader=new Wd(e,Jf),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(e){if(this._colorBlindnessMode=e,this._shader){const s=this._shader.getShader();s.use(),this._colorBlindnessMode===$r.Protanope?s.setUniformInt("u_type",0):this._colorBlindnessMode===$r.Deuteranope?s.setUniformInt("u_type",1):this._colorBlindnessMode===$r.Tritanope&&s.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(e){if(this._simulate=e,this._shader){const s=this._shader.getShader();s.use(),s.setUniformBoolean("u_simulate",e)}}get simulate(){return this._simulate}}class Vd{constructor(e){this._engine=e,this._colorBlindPostProcessor=new qd($r.Protanope)}correct(e){this._engine.graphicsContext instanceof Vs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(e){this._engine.graphicsContext instanceof Vs&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=e,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class jd{constructor(e){this.stats={currFrame:new Ao,prevFrame:new Ao},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:q.Yellow,showZIndex:!1,showScale:!1,scaleColor:q.Green,showRotation:!1,rotationColor:q.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:q.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:q.Blue,showOwner:!1,showGeometry:!0,geometryColor:q.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:q.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:q.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:q.Yellow,showAcceleration:!1,accelerationColor:q.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:q.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:q.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:q.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:q.Yellow,positionSize:1,showGrid:!1,gridColor:q.Red,gridWidth:1,showColliderGeometry:!0},this._engine=e,this.colorBlindMode=new Vd(this._engine)}useTestClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const n=e.toTestClock();return s&&n.start(),this._engine.clock=n,n}useStandardClock(){const e=this._engine.clock,s=e.isRunning();e.stop();const n=e.toStandardClock();return s&&n.start(),this._engine.clock=n,n}}class Ao{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new va,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(e){e?(this.id=e.id,this.elapsedMs=e.elapsedMs,this.fps=e.fps,this.actors.alive=e.actors.alive,this.actors.killed=e.actors.killed,this.actors.ui=e.actors.ui,this.duration.update=e.duration.update,this.duration.draw=e.duration.draw,this._physicsStats.reset(e.physics),this.graphics.drawCalls=e.graphics.drawCalls,this.graphics.drawnImages=e.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const e=new Ao;return e.reset(this),e}get id(){return this._id}set id(e){this._id=e}get elapsedMs(){return this._elapsedMs}set elapsedMs(e){this._elapsedMs=e}get fps(){return this._fps}set fps(e){this._fps=e}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class va{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(e){e?(this.pairs=e.pairs,this.collisions=e.collisions,this.contacts=e.contacts,this.fastBodies=e.fastBodies,this.fastBodyCollisions=e.fastBodyCollisions,this.broadphase=e.broadphase,this.narrowphase=e.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const e=new va;return e.reset(this),e}get pairs(){return this._pairs}set pairs(e){this._pairs=e}get collisions(){return this._collisions}set collisions(e){this._collisions=e}get contacts(){return this._contacts}set contacts(e){this._contacts=e}get fastBodies(){return this._fastBodies}set fastBodies(e){this._fastBodies=e}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(e){this._fastBodyCollisions=e}get broadphase(){return this._broadphase}set broadphase(e){this._broadphase=e}get narrowphase(){return this._narrowphase}set narrowphase(e){this._narrowphase=e}}class Zh{on(e,s){this._nativeHandlers[e]&&this.off(e,this._nativeHandlers[e]),this._nativeHandlers[e]=this._decorate(s),this.nativeComponent.addEventListener(e,this._nativeHandlers[e])}off(e,s){s||(s=this._nativeHandlers[e]),this.nativeComponent.removeEventListener(e,s),this._nativeHandlers[e]=null}_decorate(e){return s=>{this._paused||e(s)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const e in this._nativeHandlers)this.off(e)}constructor(e){this.nativeComponent=e,this._paused=!1,this._nativeHandlers={}}}class Yd{constructor(e,s){this._windowGlobal=e,this._documentGlobal=s,this._windowComponent=new Zh(this._windowGlobal),this._documentComponent=new Zh(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const Xd={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:Gt.Blended,canvasImageRendering:"auto"},Zd={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:Gt.Blended,canvasImageRendering:"auto"};class $d{constructor(e){var s;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=e.initialFps,this._samplePeriod=(s=e.samplePeriod)!==null&&s!==void 0?s:this._samplePeriod,this._currentFrameTime=1e3/e.initialFps,this._nowFn=e.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const e=this._nowFn();this._currentFrameTime=e-this._beginFrameTime,e>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(e-this._previousSampleTime),this._previousSampleTime=e,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class $h{constructor(e){var s,n,a;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=e,this.tick=e.tick,this._lastTime=(s=this.now())!==null&&s!==void 0?s:0,this._maxFps=(n=e.maxFps)!==null&&n!==void 0?n:this._maxFps,this._onFatalException=(a=e.onFatalException)!==null&&a!==void 0?a:this._onFatalException,this.fpsSampler=new $d({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new Jd({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new Jh({...this._options})}setFatalExceptionHandler(e){this._onFatalException=e}schedule(e,s=0,n="preframe"){const a=this._totalElapsed+s;this._scheduledCbs.push([e,a,n])}__runScheduledCbs(e="preframe"){for(let s=this._scheduledCbs.length-1;s>-1;s--)e===this._scheduledCbs[s][2]&&this._scheduledCbs[s][1]<=this._totalElapsed&&(this._scheduledCbs[s][0](this._elapsed),this._scheduledCbs.splice(s,1))}update(e){try{this.fpsSampler.start();const s=this.now();let n=s-this._lastTime||1;const a=1e3/this._maxFps;if(n>=a){let l=0;a!==0&&(l=n%a,n=n-l),n>200&&(n=1),this._elapsed=e||n,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(e||n),this.__runScheduledCbs("postframe"),a!==0?this._lastTime=s-l:this._lastTime=s,this.fpsSampler.end()}}catch(s){this._onFatalException(s),this.stop()}}}class Jh extends $h{constructor(e){super(e),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const e=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(e),this.update()}catch(s){throw window.cancelAnimationFrame(this._requestId),s}};e()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class Jd extends $h{constructor(e){super({...e}),this._logger=j.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=e.defaultUpdateMs}now(){var e;return(e=this._currentTime)!==null&&e!==void 0?e:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(e){const s=e??this._updateMs;this._running?(this.update(s),this._currentTime+=s):this._logger.warn("The clock is not running, no step will be performed")}run(e,s){for(let n=0;n<e;n++)this.step(s??this._updateMs)}}var Kf=o(296);class Kd{constructor(){this._toasterCss=Kf.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(e){const s=document.createElement("span");return s.innerText=e,s}toast(e,s,n){this._initialize();const a=document.createElement("div");a.className="ex-toast-message";const l=e.split("[LINK]").map(P=>this._createFragment(P));if(s){const P=document.createElement("a");P.href=s,n?P.innerText=n:P.innerText=s,l.splice(1,0,P)}const g=document.createElement("div");l.forEach(P=>{g.appendChild(P)}),a.appendChild(g);const p=document.createElement("button");p.innerText="x",p.addEventListener("click",()=>{this._container.removeChild(a)}),a.appendChild(p);const v=P=>{if(P.key==="Escape")try{this._container.removeChild(a)}catch{}document.removeEventListener("keydown",v)};document.addEventListener("keydown",v);const B=this._container.firstChild;this._container.insertBefore(a,B)}}const t_={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class tu{get isTransitioning(){return this._isTransitioning}constructor(e,s){this._engine=e,this.events=new S,this._logger=j.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new ss,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const n in s){const a=s[n];this.add(n,a),n==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const e=this._deferredGoto;this._deferredGoto=void 0;const s=this._deferredTransition;this._deferredTransition=void 0;const n=this.getSceneInstance(e);n&&s&&s._addToTargetScene(this._engine,n),await this.swapScene(e),n&&s&&await this.playTransition(s,n)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(e,s){const n=s==null?void 0:s.loader;n instanceof eo?this.mainLoader=n:Bh(n)?this.mainLoader=new n:this.mainLoader=new jr;let a;if(s!=null&&s.inTransition){const{inTransition:l}=s;a=l}if(this.startScene=e,a){const l=this.getSceneInstance(this.startScene);l&&(a._addToTargetScene(this._engine,l),this.swapScene(this.startScene).then(()=>this.playTransition(a,l)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(e){return this._sceneToLoader.get(e)}_getInTransition(e){var s;const n=this.scenes[e];if(!(n instanceof ss||Rs(n)))return(s=n==null?void 0:n.transitions)===null||s===void 0?void 0:s.in}_getOutTransition(e){var s;const n=this.scenes[e];if(!(n instanceof ss||Rs(n)))return(s=n==null?void 0:n.transitions)===null||s===void 0?void 0:s.out}getDeferredScene(){const e=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&e?e:null}getSceneDefinition(e){const s=this.scenes[e];if(s instanceof ss||Rs(s))return s;if(s)return s.scene}getSceneName(e){for(const[s,n]of Object.entries(this.scenes))if(n instanceof ss){if(e===n)return s}else if(!Rs(n)&&e===n.scene)return s;for(const[s,n]of Object.entries(this.scenes))if(Rs(n)){if(e.constructor===n)return s}else if(!(n instanceof ss)&&e.constructor===n.scene)return s;return null}assertAdded(e){return this}assertRemoved(e){return this}add(e,s){if(!(s instanceof ss)&&!Rs(s)){const{loader:n,transitions:a}=s,{in:l,out:g}=a??{};this._sceneToTransition.set(e,{in:l,out:g}),Bh(n)?this._sceneToLoader.set(e,new n):n&&this._sceneToLoader.set(e,n)}return this.scenes[e]&&this._logger.warn("Scene",e,"already exists overwriting"),this.scenes[e]=s,this.assertAdded(e)}remove(e){if(e instanceof ss||Rs(e)){const s=e;for(const n in this.scenes)if(this.scenes.hasOwnProperty(n)){const a=this.scenes[n];let l;if(a instanceof ss||Rs(a)?l=a:l=a.scene,l===s){if(n===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${n}`);this._sceneToInstance.delete(n),this._sceneToTransition.delete(n),this._sceneToLoader.delete(n),delete this.scenes[n]}}}if(typeof e=="string"){if(e===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${e}`);this._sceneToInstance.delete(e),this._sceneToTransition.delete(e),this._sceneToLoader.delete(e),delete this.scenes[e]}}async goToScene(e,s){var n,a,l,g,p,v;const B=this.getSceneInstance(e);if(!B){this._logger.warn(`Scene ${e} does not exist! Check the name, are you sure you added it?`);return}const P=this.currentScene,z=this.currentSceneName,$=(a=(n=this._engine.input)===null||n===void 0?void 0:n.enabled)!==null&&a!==void 0?a:!0;this._isTransitioning=!0;const J=(l=this.getSceneInstance(z))===null||l===void 0?void 0:l.onTransition("out"),at=B==null?void 0:B.onTransition("in");s={sourceOut:(g=this._getOutTransition(this.currentSceneName))!==null&&g!==void 0?g:J,destinationIn:(p=this._getInTransition(e))!==null&&p!==void 0?p:at,...s};const{sourceOut:ct,destinationIn:At,sceneActivationData:lt}=s,gt=ct??this._getOutTransition(this.currentSceneName),Pt=At??this._getInTransition(e),wt=(gt==null?void 0:gt.hideLoader)||(Pt==null?void 0:Pt.hideLoader);wt&&this.maybeLoadScene(e,wt),this._emitEvent("navigationstart",z,e),gt&&await this.playTransition(gt,P),await this.maybeLoadScene(e,wt),Pt&&await Pt.onPreviousSceneDeactivate(this.currentScene),Pt&&Pt._addToTargetScene(this._engine,B),await this.swapScene(e,lt),this._emitEvent("navigation",z,e),Pt&&await this.playTransition(Pt,B),this._emitEvent("navigationend",z,e),(v=this._engine.input)===null||v===void 0||v.toggleEnabled($),this._isTransitioning=!1}getSceneInstance(e){const s=this.getSceneDefinition(e);if(!s)return;if(this._sceneToInstance.has(e))return this._sceneToInstance.get(e);if(s instanceof ss)return this._sceneToInstance.set(e,s),s;const n=new s;return this._sceneToInstance.set(e,n),n}async maybeLoadScene(e,s=!1){var n;const a=(n=this._getLoader(e))!==null&&n!==void 0?n:new eo,l=this.getSceneDefinition(e),g=this.getSceneInstance(e);l&&g&&!this._loadedScenes.has(g)&&(g.onPreLoad(a),g.events.emit("preload",{loader:a}),s?this._engine.load(a,s):await this._engine.load(a),this._loadedScenes.add(g))}async playTransition(e,s){var n,a,l,g,p,v,B;if(!this.isInitialized){this._deferredTransition=e;return}if(e){this.currentTransition=e;const P=(a=(n=s.input)===null||n===void 0?void 0:n.enabled)!==null&&a!==void 0?a:!0;(l=s.input)===null||l===void 0||l.toggleEnabled(!e.blockInput),(g=this._engine.input)===null||g===void 0||g.toggleEnabled(!e.blockInput),this.currentTransition._addToTargetScene(this._engine,s),await this.currentTransition._play(),(p=s.input)===null||p===void 0||p.toggleEnabled(P)}(v=this.currentTransition)===null||v===void 0||v.kill(),(B=this.currentTransition)===null||B===void 0||B.reset(),this.currentTransition=void 0}async swapScene(e,s){const n=this._engine;if(!this.isInitialized){this._deferredGoto=e;return}const a=this.getSceneInstance(e);if(a){const l=this.currentScene,g=a;if(this._logger.debug("Going to scene:",e),this.currentScene.isInitialized){const B={engine:n,previousScene:l,nextScene:g};await this.currentScene._deactivate(B),this.currentScene.events.emit("deactivate",new fh(B,this.currentScene)),this.currentScene.input.clear()}const p=this._sceneToLoader.get(e);await(p==null?void 0:p.areResourcesLoaded()),this.currentScene=g,this.currentSceneName=e,n.screen.setCurrentCamera(g.camera),await this.currentScene._initialize(n);const v={engine:n,previousScene:l,nextScene:g,data:s};await this.currentScene._activate(v),this.currentScene.events.emit("activate",new gh(v,this.currentScene))}else this._logger.error("Scene",e,"does not exist!")}_emitEvent(e,s,n){const a=this.getSceneDefinition(s),l=this.getSceneDefinition(n);this.events.emit(e,{sourceScene:a,sourceName:s,destinationScene:l,destinationName:n})}}function eu(){const d={scope:(e,s)=>{const n=d.value;d.value=e;try{return s()}catch(a){throw a}finally{d.value=n}},value:void 0};return d}function iu(d){return d.value}const Kh={textureCollectInterval:6e4};class su{constructor(e){this.options=e,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=s=>{if(this._running){for(const[n,[a,l]]of this._collectors.entries()){const g=this.options.getTimestamp();for(const[p,[v,B]]of this._collectionMap.entries()){if(n!==v||B+l>=g)continue;a(p)&&this._collectionMap.delete(p)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(e,s,n){this._collectors.set(e,[n,s])}addCollectableResource(e,s){this._collectionMap.set(s,[e,this.options.getTimestamp()])}touch(e){const s=this._collectionMap.get(e);s&&this._collectionMap.set(e,[s[0],this.options.getTimestamp()])}forceCollectAll(){for(const[e,[s]]of this._collectors.entries())for(const[n]of this._collectionMap.entries())s(n)&&this._collectionMap.delete(n)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}w();const e_={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var yr;(function(d){d[d.None=0]="None",d[d.Canvas=1]="Canvas",d[d.All=2]="All"})(yr||(yr={}));class qi{static useEngine(){const e=iu(qi.Context);if(!e)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return e}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(e){this.graphicsContext.snapToPixel=e}emit(e,s){this.events.emit(e,s)}on(e,s){return this.events.on(e,s)}once(e,s){return this.events.once(e,s)}off(e,s){this.events.off(e,s)}constructor(e){var s,n,a,l,g,p,v,B,P;this.scope=wt=>qi.Context.scope(this,wt),this.version=ol,this.events=new S,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=wt=>{j.getInstance().fatal(wt,wt.stack)},this._toaster=new Kd,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=wt=>{var Qt;wt.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",wt);const jt=document.createElement("div");jt.id="ex-webgl-graphics-context-lost",jt.style.position="absolute",jt.style.zIndex="99",jt.style.left="50%",jt.style.top="50%",jt.style.display="flex",jt.style.flexDirection="column",jt.style.transform="translate(-50%, -50%)",jt.style.backgroundColor="white",jt.style.padding="10px",jt.style.borderStyle="solid 1px";const It=document.createElement("div");if(It.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,jt.appendChild(It),!((Qt=this.canvas)===null||Qt===void 0)&&Qt.parentElement){this.canvas.parentElement.appendChild(jt);const re=It.querySelector("#ex-webgl-graphics-reload");re==null||re.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new C,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],e={...qi._DEFAULT_ENGINE_OPTIONS,...e},this._originalOptions=e,f.freeze(),this.browser=new Yd(window,document);const z=new Uc;if(!e.suppressMinimumBrowserFeatureDetection&&!(this._compatible=z.test())){const wt=document.createElement("div");if(wt.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(wt),z.failedTests.forEach(function(Qt){const jt=document.createElement("div");jt.innerText="Browser feature missing "+Qt,document.body.appendChild(jt)}),e.canvasElementId){const Qt=document.getElementById(e.canvasElementId);Qt&&Qt.parentElement.removeChild(Qt)}return}else this._compatible=!0;if(console.log&&!e.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${ol})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),e.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=j.getInstance(),this._logger.defaultLevel===X.Debug&&z.logBrowserFeatures(),this._logger.debug("Building engine..."),e.garbageCollection===!0?this.garbageCollectorConfig={...Kh}:e.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...Kh,...e.garbageCollection},this._garbageCollector=new su({getTimestamp:Date.now}),this.canvasElementId=e.canvasElementId,e.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+e.canvasElementId),document.getElementById(e.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(e.canvasElementId)}else e.canvasElement?(this._logger.debug("Using Canvas element specified:",e.canvasElement),this.canvas=e.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!e.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",wt=>{wt.preventDefault()});let $=(s=e.displayMode)!==null&&s!==void 0?s:li.Fixed;e.width&&e.height||e.viewport?(e.displayMode===void 0&&($=li.Fixed),this._logger.debug("Engine viewport is size "+e.width+" x "+e.height)):e.displayMode||(this._logger.debug("Engine viewport is fit"),$=li.FitScreen),this.grabWindowFocus=e.grabWindowFocus,this.pointerScope=e.pointerScope,this._originalDisplayMode=$;let J,at,ct,At,lt,gt;typeof e.antialiasing=="object"?{pixelArtSampler:J,nativeContextAntialiasing:ct,multiSampleAntialiasing:gt,filtering:lt,canvasImageRendering:At}={...e.pixelArt?Zd:Xd,...e.antialiasing}:(J=!!e.pixelArt,ct=!1,gt=e.antialiasing,At=e.antialiasing?"auto":"pixelated",lt=e.antialiasing?Gt.Blended:Gt.Pixel),ct&&gt&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),e.pixelArt&&(at=.25),(!e.antialiasing||lt===Gt.Pixel)&&(at=0),at=(a=(n=e.uvPadding)!==null&&n!==void 0?n:at)!==null&&a!==void 0?a:.01;let Pt=f.isEnabled("use-canvas-context");if(!Pt)try{this.graphicsContext=new Vs({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:J,antialiasing:ct,multiSampleAntialiasing:gt,uvPadding:at,powerPreference:e.powerPreference,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(l=e.handleContextLost)!==null&&l!==void 0?l:this._handleWebGLContextLost,handleContextRestored:e.handleContextRestored})}catch(wt){this._logger.warn(`Excalibur could not load webgl for some reason (${wt.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),Pt=!0}Pt&&(this.graphicsContext=new na({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:ct,backgroundColor:e.backgroundColor,snapToPixel:e.snapToPixel,useDrawSorting:e.useDrawSorting})),this.screen=new Ch({canvas:this.canvas,context:this.graphicsContext,antialiasing:ct,canvasImageRendering:At,browser:this.browser,viewport:(g=e.viewport)!==null&&g!==void 0?g:e.width&&e.height?{width:e.width,height:e.height}:bh.SVGA,resolution:e.resolution,displayMode:$,pixelRatio:e.suppressHiDPIScaling?1:(p=e.pixelRatio)!==null&&p!==void 0?p:null}),se.filtering=lt,e.backgroundColor&&(this.backgroundColor=e.backgroundColor.clone()),this.maxFps=(v=e.maxFps)!==null&&v!==void 0?v:this.maxFps,this.fixedUpdateTimestep=(B=e.fixedUpdateTimestep)!==null&&B!==void 0?B:this.fixedUpdateTimestep,this.fixedUpdateFps=(P=e.fixedUpdateFps)!==null&&P!==void 0?P:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new Jh({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:wt=>this.onFatalException(wt)}),this.enableCanvasTransparency=e.enableCanvasTransparency,typeof e.physics=="boolean"?this.physics={...Ys(),enabled:e.physics}:(this.physics={...Ys()},Ie(this.physics,e.physics)),this.debug=new jd(this),this.director=new tu(this,e.scenes),this._initialize(e),window.___EXCALIBUR_DEVTOOL=this,qi.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:e}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:s,showPlayerMessage:n}=this._originalOptions.configurePerformanceCanvas2DFallback;if(s===void 0&&(s=qi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),n===void 0&&(n=qi._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!f.isEnabled("use-canvas-context")&&e&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===s.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let a=0;for(let g=0;g<this._fpsSamples.length;g++)a+=this._fpsSamples[g];const l=a/this._fpsSamples.length;this._fpsSamples.length===s.numberOfFrames&&l<=s.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),n&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var e,s,n;const a=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(a,this.canvas),this.canvas=a;const l={...this._originalOptions,antialiasing:this.screen.antialiasing},g=this._originalDisplayMode;this.graphicsContext=new na({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:l.antialiasing,backgroundColor:l.backgroundColor,snapToPixel:l.snapToPixel,useDrawSorting:l.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new Ch({canvas:this.canvas,context:this.graphicsContext,antialiasing:(e=l.antialiasing)!==null&&e!==void 0?e:!0,browser:this.browser,viewport:(s=l.viewport)!==null&&s!==void 0?s:l.width&&l.height?{width:l.width,height:l.height}:bh.SVGA,resolution:l.resolution,displayMode:g,pixelRatio:l.suppressHiDPIScaling?1:(n=l.pixelRatio)!==null&&n!==void 0?n:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const p=l&&l.pointerScope===E.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(p,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,qi.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(e){if(e<0){j.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=e}addTimer(e){return this.currentScene.addTimer(e)}removeTimer(e){return this.currentScene.removeTimer(e)}addScene(e,s){return this.director.add(e,s),this}removeScene(e){this.director.remove(e)}add(e){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const s=this.director.getDeferredScene();s instanceof ss?s.add(e):this.currentScene.add(e)}remove(e){e instanceof Ci&&this.currentScene.remove(e),(e instanceof ss||Rs(e))&&this.removeScene(e),typeof e=="string"&&this.removeScene(e)}async goToScene(e,s){await this.scope(async()=>{await this.director.goToScene(e,s)})}screenToWorldCoordinates(e){return this.screen.screenToWorldCoordinates(e)}worldToScreenCoordinates(e){return this.screen.worldToScreenCoordinates(e)}_initialize(e){var s,n;this.pageScrollPreventionMode=e.scrollPreventionMode;const a=e&&e.pointerScope===E.Document?document:this.canvas,l=(n=(s=this._originalOptions)===null||s===void 0?void 0:s.grabWindowFocus)!==null&&n!==void 0?n:!0;this.input=new Xh({pointerTarget:a,grabWindowFocus:l,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new uh(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new dh(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!e.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(e){this._inputEnabled=e,this.input.toggleEnabled(this._inputEnabled)}onInitialize(e){}get isInitialized(){return this._isInitialized}async _overrideInitialize(e){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(e),this.events.emit("initialize",new En(e,this)),this._isInitialized=!0)}_update(e){var s;if(this._isLoading){(s=this._loader)===null||s===void 0||s.onUpdate(this,e),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(e),this.currentScene.update(this,e),this.graphicsContext.updatePostProcessors(e),this.clock.__runScheduledCbs("postupdate"),this._postupdate(e),this.input.update()}_preupdate(e){this.emit("preupdate",new zt(this,e,this)),this.onPreUpdate(this,e)}onPreUpdate(e,s){}_postupdate(e){this.emit("postupdate",new Vt(this,e,this)),this.onPostUpdate(this,e)}onPostUpdate(e,s){}_draw(e){var s,n;if(this.graphicsContext.backgroundColor=(s=this.currentScene.backgroundColor)!==null&&s!==void 0?s:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,e),this._isLoading){this._hideLoader||((n=this._loader)===null||n===void 0||n.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,e),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,e),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(e,s){this.emit("predraw",new b(e,s,this)),this.onPreDraw(e,s)}onPreDraw(e,s){}_postdraw(e,s){this.emit("postdraw",new M(e,s,this)),this.onPostDraw(e,s)}onPostDraw(e,s){}showDebug(e){this._isDebug=e}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(e,s){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let n;return e instanceof eo?n=e:typeof e=="string"&&(this.director.configureStart(e,s),n=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(n??new jr),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new G(this)),this._isReadyFuture.promise})}_mainloop(e){this.scope(()=>{this.emit("preframe",new Re(this,this.stats.prevFrame));const s=e*this.timescale;this.currentFrameElapsedMs=s;const n=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=n,this.stats.currFrame.elapsedMs=s,this.stats.currFrame.fps=this.clock.fpsSampler.fps,pe.clear();const a=this.clock.now(),l=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=s;this._lagMs>=l;)this._update(l),this._lagMs-=l;else this._update(s);const g=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(s);const p=this.clock.now();this.stats.currFrame.duration.update=g-a,this.stats.currFrame.duration.draw=p-g,this.stats.currFrame.graphics.drawnImages=pe.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=pe.DrawCallCount,this.emit("postframe",new hs(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new m(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(e=!1){return new Promise(n=>{this._screenShotRequests.push({preserveHiDPIResolution:e,resolve:n})})}_checkForScreenShots(){for(const e of this._screenShotRequests){const s=e.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,n=e.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,a=document.createElement("canvas");a.width=s,a.height=n;const l=a.getContext("2d");l.imageSmoothingEnabled=this.screen.antialiasing,l.drawImage(this.canvas,0,0,s,n);const g=new Image,p=a.toDataURL("image/png");g.onload=()=>{e.resolve(g)},g.src=p}this._screenShotRequests.length=0}async load(e,s=!1){await this.scope(async()=>{try{if(e.isLoaded())return;this._loader=e,this._isLoading=!0,this._hideLoader=s,e instanceof jr&&(e.suppressPlayButton=e.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await e.load()}catch(n){this._logger.error("Error loading resources, things may not behave properly",n),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}qi.Context=eu(),qi.InstanceCount=0,qi._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:E.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:yr.Canvas,backgroundColor:q.fromHex("#2185d0")};class i_ extends Qi{set maxWidth(e){this._text.maxWidth=e}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(e){this._font=e,this._text.font=e}get text(){return this._text.text}set text(e){this._text.text=e}get color(){return this._text.color}set color(e){this._text&&(this._text.color=e)}get opacity(){return this.graphics.opacity}set opacity(e){this.graphics.opacity=e}get spriteFont(){return this._spriteFont}set spriteFont(e){e&&(this._spriteFont=e,this._text.font=this._spriteFont)}constructor(e){super(e),this._font=new Is,this._text=new Ar({text:"",font:this._font});const{text:s,pos:n,x:a,y:l,spriteFont:g,font:p,color:v,maxWidth:B}={text:"",...e};this.pos=n??(a&&l?R(a,l):this.pos),this.text=s??this.text,this.font=p??this.font,this.maxWidth=B??this.maxWidth,this.spriteFont=g??this.spriteFont,this._text.color=v??this.color;const P=this.get(De);P.anchor=I.Zero,P.use(this._text)}_initialize(e){super._initialize(e)}getTextWidth(){return this._text.width}}var xr;(function(d){d.Circle="circle",d.Rectangle="rectangle"})(xr||(xr={}));class s_ extends Qi{constructor(e){var s,n;super({width:(s=e.width)!==null&&s!==void 0?s:0,height:(n=e.height)!==null&&n!==void 0?n:0}),this._particlesToEmit=0,this._particlePool=new _t(()=>new ra({}),at=>at,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=xr.Rectangle,this.radius=0,this.particle={life:2e3,transform:_s.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:a,x:l,y:g,z:p,pos:v,isEmitting:B,emitRate:P,emitterType:z,radius:$,random:J}={...e};this.particle={...this.particle,...a},this.pos=v??R(l??0,g??0),this.z=p??0,this.isEmitting=B??this.isEmitting,this.emitRate=P??this.emitRate,this.emitterType=z??this.emitterType,this.radius=$??this.radius,this.body.collisionType=ee.PreventCollision,this.random=J??new H}removeParticle(e){this.deadParticles.push(e)}emitParticles(e){var s;if(!(e<=0)){e=e|0;for(let n=0;n<e;n++){const a=this._createParticle();!((s=this===null||this===void 0?void 0:this.scene)===null||s===void 0)&&s.world&&(this.particle.transform===_s.Global?this.scene.world.add(a):this.addChild(a)),this._activeParticles.push(a)}}}clearParticles(){for(let e=0;e<this._activeParticles.length;e++)this.removeParticle(this._activeParticles[e])}_createParticle(){let e=0,s=0;const n=ut(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),a=ut(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),l=this.particle.startSize||ut(this.particle.minSize||5,this.particle.maxSize||5,this.random),g=a*Math.cos(n),p=a*Math.sin(n);if(this.emitterType===xr.Rectangle)e=ut(0,this.width,this.random),s=ut(0,this.height,this.random);else if(this.emitterType===xr.Circle){const B=ut(0,this.radius,this.random);e=B*Math.cos(n),s=B*Math.sin(n)}const v=this._particlePool.rent();return v.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:R(e,s),vel:R(g,p),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:l,graphic:this.particle.graphic,fade:this.particle.fade}),v.registerEmitter(this),this.particle.randomRotation&&(v.transform.rotation=ut(0,Math.PI*2,this.random)),this.particle.focus&&(v.focus=this.particle.focus.add(R(this.pos.x,this.pos.y)),v.focusAccel=this.particle.focusAccel),v}update(e,s){var n;super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let a=0;a<this.deadParticles.length;a++){!((n=this===null||this===void 0?void 0:this.scene)===null||n===void 0)&&n.world&&(this.scene.world.remove(this.deadParticles[a],!1),this._particlePool.return(this.deadParticles[a]));const l=this._activeParticles.indexOf(this.deadParticles[a]);l>-1&&this._activeParticles.splice(l,1)}this.deadParticles.length=0}}function r_(d,e){}class wa{constructor(e,s,n){var a;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=e,this.particle=n,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=s,this._particleLife=(a=this.particle.life)!==null&&a!==void 0?a:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(e,s){if(this._initialized)return;const n=this.emitter.maxParticles,a=this._numInputFloats,l=this._particleData,g=4,p=e.createBuffer(),v=e.createVertexArray();e.bindVertexArray(v),e.bindBuffer(e.ARRAY_BUFFER,p),e.bufferData(e.ARRAY_BUFFER,n*a*g,e.DYNAMIC_DRAW),e.bufferSubData(e.ARRAY_BUFFER,0,l);let B=0;e.vertexAttribPointer(0,2,e.FLOAT,!1,a*g,0),B+=g*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*g,B),B+=g*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*g,B),B+=g*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*g,B),B+=g*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*g,B),B+=g*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(v),this._buffers.push(p),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null);const P=e.createBuffer(),z=e.createVertexArray();e.bindVertexArray(z),e.bindBuffer(e.ARRAY_BUFFER,P),e.bufferData(e.ARRAY_BUFFER,n*a*g,e.DYNAMIC_DRAW),B=0,e.vertexAttribPointer(0,2,e.FLOAT,!1,a*g,0),B+=g*2,e.vertexAttribPointer(1,2,e.FLOAT,!1,a*g,B),B+=g*2,e.vertexAttribPointer(2,1,e.FLOAT,!1,a*g,B),B+=g*1,e.vertexAttribPointer(3,1,e.FLOAT,!1,a*g,B),B+=g*1,e.vertexAttribPointer(4,1,e.FLOAT,!1,a*g,B),B+=g*1,e.enableVertexAttribArray(0),e.enableVertexAttribArray(1),e.enableVertexAttribArray(2),e.enableVertexAttribArray(3),e.enableVertexAttribArray(4),this._vaos.push(z),this._buffers.push(P),e.bindVertexArray(null),e.bindBuffer(e.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(e){const s=this._particleIndex,n=this.maxParticles*this._numInputFloats,a=e*this._numInputFloats+s;for(let l=s;l<a;l+=this._numInputFloats){const g=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||k),p=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),v=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),B=p*Math.cos(g),P=v*Math.sin(g);let z=0,$=0;if(this.emitter.emitterType===xr.Rectangle)z=this._random.floating(-.5,.5)*this.emitter.width,$=this._random.floating(-.5,.5)*this.emitter.height;else{const ct=this._random.floating(0,this.emitter.radius);z=ct*Math.cos(g),$=ct*Math.sin(g)}const J=this.emitter.transform.apply(R(z,$)),at=[this.particle.transform===_s.Local?z:J.x,this.particle.transform===_s.Local?$:J.y,B,P,this.particle.randomRotation?ut(0,k,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(at,l%this._particleData.length)}a>=n?(this._wrappedParticles+=(a-n)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=e),this._particleIndex=a%n,this._emitted.push([this._particleLife,s])}_uploadEmitted(e){this._particleIndex!==this._uploadIndex&&(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(e.bufferSubData(e.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),e.bindBuffer(e.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(e){var s;if(this._particleLife=(s=this.particle.life)!==null&&s!==void 0?s:this._particleLife,this._wrappedLife>0?this._wrappedLife-=e:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let n=this._emitted.length-1;n>=0;n--){const a=this._emitted[n];a[0]-=e,a[0]<=0&&this._emitted.splice(n,1)}this._emitted.sort((n,a)=>n[0]-a[0])}}draw(e){if(this._initialized){if(this._clearRequested?(e.bindBuffer(e.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),e.bufferSubData(e.ARRAY_BUFFER,0,this._particleData),e.bindBuffer(e.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(e),e.bindVertexArray(this._currentVao),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const s=this._emitted[0][1]/this._numInputFloats;e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-s)*this._numInputFloats*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,s,this.maxParticles-s),e.endTransformFeedback(),e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,s),e.endTransformFeedback()}else e.bindBufferRange(e.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),e.beginTransformFeedback(e.POINTS),e.drawArrays(e.POINTS,0,this.maxParticles),e.endTransformFeedback();e.bindVertexArray(null),e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}wa.GPU_MAX_PARTICLES=1e5;class n_ extends Qi{get pos(){return this.transform.pos}set pos(e){this.transform.pos=e}get z(){return this.transform.z}set z(e){this.transform.z=e}constructor(e){super({name:"GpuParticleEmitter",width:e.width,height:e.height}),this.particle={life:2e3,transform:_s.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new De,this.isEmitting=!1,this.emitRate=1,this.emitterType=xr.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:s,maxParticles:n,x:a,y:l,z:g,pos:p,isEmitting:v,emitRate:B,emitterType:P,radius:z,random:$}={...e};this.maxParticles=L(n??this.maxParticles,0,wa.GPU_MAX_PARTICLES),this.pos=p??R(a??0,l??0),this.z=g??0,this.isEmitting=v??this.isEmitting,this.emitRate=B??this.emitRate,this.emitterType=P??this.emitterType,this.radius=z??this.radius,this.particle={...this.particle,...s},this.random=$??new H,this.renderer=new wa(this,this.random,this.particle)}_initialize(e){super._initialize(e);const s=e.graphicsContext;this.renderer.initialize(s.__gl,s)}update(e,s){super.update(e,s),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(s/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(s)}emitParticles(e){e<=0||this.renderer.emitParticles(e|0)}clearParticles(){this.renderer.clearParticles()}draw(e,s){e.draw("ex.particle",this.renderer,s)}}class ru extends Ci{getGraphics(){return this._graphics}addGraphic(e,s){this._graphics.push(e),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,s!=null&&s.offset&&(this._gfx.offset=s.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let e=this._tileBounds.clone();for(const s of this._graphics){const n=R(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:s.height-this.map.tileHeight));e=e.combine(s.localBounds.translate(n))}return e}removeGraphic(e){const s=this._graphics.indexOf(e);s>-1&&this._graphics.splice(s,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(e){this._colliders.push(e),this.map.flagCollidersDirty()}removeCollider(e){const s=this._colliders.indexOf(e);s>-1&&this._colliders.splice(s,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(R(this.x,this.y))}get center(){return this.pos.add(R(0,this.map.tileHeight/2))}constructor(e,s,n,a){super([new Ot,new De({offset:n??I.Zero,onPostDraw:($,J)=>this.draw($,J)}),new co(a)]),this.solid=!1,this.events=new S,this._tileBounds=new ht,this._graphics=[],this._colliders=[],this.data=new Map,this.x=e,this.y=s,this.map=a,this._transform=this.get(Ot),this._isometricEntityComponent=this.get(co);const l=this.map.tileWidth/2,g=this.map.tileHeight/2,p=(this.x-this.y)*l,v=(this.x+this.y)*g;this._transform.pos=R(p,v),this._isometricEntityComponent.elevation=a.elevation,this._gfx=this.get(De),this._gfx.isVisible=!1;const B=this.map.tileWidth,P=this.map.tileHeight,z=R(0,this.map.renderFromTopOfGraphic?P:0);this._gfx.localBounds=this._tileBounds=new ht({left:-B/2,top:-P,right:B/2,bottom:P}).translate(z)}draw(e,s){const n=this.map.tileWidth/2;e.save(),e.translate(-n,0);for(const a of this._graphics)a.draw(e,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:a.height-this.map.tileHeight));e.restore()}}class o_ extends Ci{get visible(){return this.isVisible}set visible(e){this.isVisible=e}constructor(e){super([new Ot,new ge({type:ee.Fixed}),new Je,new vr,new da((P,z)=>this.debug(P,z),!1)],e.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=R(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:s,tileWidth:n,tileHeight:a,columns:l,rows:g,renderFromTopOfGraphic:p,graphicsOffset:v,elevation:B}=e;this.transform=this.get(Ot),s&&(this.transform.pos=s),this.collider=this.get(Je),this.collider&&this.collider.set(this._composite=new ci([])),this.pointer=this.get(vr),this.renderFromTopOfGraphic=p??this.renderFromTopOfGraphic,this.graphicsOffset=v??this.graphicsOffset,this.elevation=B??this.elevation,this.tileWidth=n,this.tileHeight=a,this.columns=l,this.rows=g,this._pointerEventDispatcher=new Lh,this.tiles=new Array(l*g);for(let P=0;P<g;P++)for(let z=0;z<l;z++){const $=new ru(z,P,this.graphicsOffset,this);this.tiles[z+P*l]=$,this.addChild($),this._pointerEventDispatcher.addObject($,J=>this.getTileByPoint(J.worldPos)===$,()=>!0)}this.pointer.localBounds=ht.fromDimension(n*l*this.transform.scale.x,a*g*this.transform.scale.y,R(.5,0))}_processPointerToObject(e){this._pointerEventDispatcher.processPointerToObject(e,this.tiles)}_dispatchPointerEvents(e){this._pointerEventDispatcher.dispatchEvents(e,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(e){var s;if(this._originalOffsets.has(e))return(s=this._originalOffsets.get(e))!==null&&s!==void 0?s:I.Zero;{const n=e.offset;return this._originalOffsets.set(e,n),n}}updateColliders(){this._composite.clearColliders();const e=this.get(Ot).pos;for(const s of this.tiles)if(s.solid)for(const n of s.getColliders()){const a=this._getOrSetColliderOriginalOffset(n);n.offset=this.tileToWorld(R(s.x,s.y)).sub(e).add(a).sub(R(this.tileWidth/2,this.tileHeight)),n.owner=this,this._composite.addCollider(n)}this.collider.update()}worldToTile(e){e=e.sub(this.transform.globalPos);const s=this.tileWidth/2,n=this.tileHeight/2;return R(~~((e.x/s+e.y/n)/2),~~((e.y/n-e.x/s)/2))}tileToWorld(e){const s=this.tileWidth/2,n=this.tileHeight/2,a=(e.x-e.y)*s,l=(e.x+e.y)*n;return R(a,l).add(this.transform.pos)}getTile(e,s){return e<0||s<0||e>=this.columns||s>=this.rows?null:this.tiles[e+s*this.columns]}getTileByPoint(e){const s=this.worldToTile(e);return this.getTile(s.x,s.y)}_getMaxZIndex(){let e=Number.NEGATIVE_INFINITY;for(const s of this.tiles){const n=s.get(Ot).z;n>e&&(e=n)}return e}debug(e,s){const{showAll:n,showPosition:a,positionColor:l,positionSize:g,showGrid:p,gridColor:v,gridWidth:B,showColliderGeometry:P}=s.isometric,{geometryColor:z,geometryLineWidth:$,geometryPointSize:J}=s.collider;if(e.save(),e.z=this._getMaxZIndex()+.5,n||p){for(let at=0;at<this.rows+1;at++){const ct=this.tileToWorld(R(0,at)),At=this.tileToWorld(R(this.columns,at));e.drawLine(ct,At,v,B)}for(let at=0;at<this.columns+1;at++){const ct=this.tileToWorld(R(at,0)),At=this.tileToWorld(R(at,this.rows));e.drawLine(ct,At,v,B)}}if(n||a)for(const at of this.tiles)e.drawCircle(this.tileToWorld(R(at.x,at.y)),g,l);if(n||P){for(const at of this.tiles)if(at.solid)for(const ct of at.getColliders())ct.debug(e,z,{lineWidth:$,pointSize:J})}e.restore()}}class tl{constructor(e,s){this.id=ye(),this._stopped=!1,this._sequenceBuilder=s,this._sequenceContext=new ao(e),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(e){this._actionQueue.update(e)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(e){return new tl(e,this._sequenceBuilder)}}class a_{constructor(e){this.id=ye(),this._actions=e}update(e){for(let s=0;s<this._actions.length;s++)this._actions[s].update(e)}isComplete(e){return this._actions.every(s=>s.isComplete(e))}reset(){this._actions.forEach(e=>e.reset())}stop(){this._actions.forEach(e=>e.stop())}}class Dn{constructor(e,s){this.bounds=e,this.options=s,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...s},this.halfWidth=e.width/2,this.halfHeight=e.height/2}_split(){this._isDivided=!0;const e={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new Dn(new ht({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),e),this.topRight=new Dn(new ht({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),e),this.bottomLeft=new Dn(new ht({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),e),this.bottomRight=new Dn(new ht({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),e)}_insertIntoSubNodes(e){var s,n,a,l;!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.insert(e),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(e.bounds)&&this.topRight.insert(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.insert(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.insert(e)}insert(e){if(this._isDivided){this._insertIntoSubNodes(e);return}if(this.items.push(e),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const s of this.items)this._insertIntoSubNodes(s);this.items.length=0}}remove(e){var s,n,a,l;if(this.bounds.overlaps(e.bounds)){if(!this._isDivided){const g=this.items.indexOf(e);g>-1&&this.items.splice(g,1);return}!((s=this.topLeft)===null||s===void 0)&&s.bounds.overlaps(e.bounds)&&this.topLeft.remove(e),!((n=this.topRight)===null||n===void 0)&&n.bounds.overlaps(e.bounds)&&this.topRight.remove(e),!((a=this.bottomLeft)===null||a===void 0)&&a.bounds.overlaps(e.bounds)&&this.bottomLeft.remove(e),!((l=this.bottomRight)===null||l===void 0)&&l.bounds.overlaps(e.bounds)&&this.bottomRight.remove(e)}}query(e){let s=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(e)&&(s=s.concat(this.topLeft.query(e))),this.topRight.bounds.overlaps(e)&&(s=s.concat(this.topRight.query(e))),this.bottomLeft.bounds.overlaps(e)&&(s=s.concat(this.bottomLeft.query(e))),this.bottomRight.bounds.overlaps(e)&&(s=s.concat(this.bottomRight.query(e)))),s=s.filter((n,a)=>s.indexOf(n)>=a),s}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let e=this.items;return this._isDivided&&(e=e.concat(this.topLeft.getAllItems()),e=e.concat(this.topRight.getAllItems()),e=e.concat(this.bottomLeft.getAllItems()),e=e.concat(this.bottomRight.getAllItems())),e=e.filter((s,n)=>e.indexOf(s)>=n),e}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(e){this.bounds.draw(e,q.Yellow),this._isDivided&&(this.topLeft.bounds.draw(e,q.Yellow),this.topRight.bounds.draw(e,q.Yellow),this.bottomLeft.bounds.draw(e,q.Yellow),this.bottomRight.bounds.draw(e,q.Yellow))}}function h_(d){return!!d._initialize}function l_(d){return!!d.onAdd}function c_(d){return!!d.onRemove}function d_(d){return!!d.onInitialize}function u_(d){return!!d._preupdate}function g_(d){return!!d.onPreUpdate}function f_(d){return!!d.onPostUpdate}function __(d){return!!d.onPostUpdate}function p_(d){return!!d.onAdd}function A_(d){return!!d.onRemove}function m_(d){return!!d.onPreDraw}function v_(d){return!!d.onPostDraw}class w_{constructor(e,s=!1){this.path=e,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new pt(e,"arraybuffer",s)}get bustCache(){return this._resource.bustCache}set bustCache(e){this._resource.bustCache=e}async load(){const e=await this._resource.load();this._stream=new nu(e),this._gif=new ou(this._stream);const s=this._gif.images.map(n=>new Se(n.src,!1));return await Promise.all(s.map(n=>n.load())),this.data=this._images=s,this._sprites=this._images.map(n=>n.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(e=0){var s;return(s=this._sprites[e])!==null&&s!==void 0?s:null}toSpriteSheet(){const e=this._sprites;return e.length?new si({sprites:e}):null}toAnimation(e){var s;const n=(s=this._gif)===null||s===void 0?void 0:s.images;if(n!=null&&n.length){const a=n.map((l,g)=>{var p;return{graphic:this._sprites[g],duration:((p=this._gif)===null||p===void 0?void 0:p.frames[g].delayMs)||void 0}});return this._animation=new Zi({frames:a,frameDuration:e}),this._animation}return null}get readCheckBytes(){var e,s;return(s=(e=this._gif)===null||e===void 0?void 0:e.checkBytes)!==null&&s!==void 0?s:[]}}const ya=d=>d.reduce(function(e,s){return e*2+s},0),el=d=>{const e=[];for(let s=7;s>=0;s--)e.push(!!(d&1<<s));return e};class nu{constructor(e){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=s=>{const n=[];for(let a=0;a<s;a++)n.push(this.readByte());return n},this.read=s=>{let n="";for(let a=0;a<s;a++)n+=String.fromCharCode(this.readByte());return n},this.readUnsigned=()=>{const s=this.readBytes(2);return(s[1]<<8)+s[0]},this.data=new Uint8Array(e),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}}const y_=function(d,e){let s=0;const n=function($){let J=0;for(let at=0;at<$;at++)e.charCodeAt(s>>3)&1<<(s&7)&&(J|=1<<at),s++;return J},a=[],l=1<<d,g=l+1;let p=d+1,v=[];const B=function(){v=[],p=d+1;for(let $=0;$<l;$++)v[$]=[$];v[l]=[],v[g]=null};let P=0,z=0;for(;;){if(z=P,P=n(p),P===l){B();continue}if(P===g)break;if(P<v.length)z!==l&&v.push(v[z].concat(v[P][0]));else{if(P!==v.length)throw new Error("Invalid LZW code.");v.push(v[z].concat(v[z][0]))}a.push.apply(a,v[P]),v.length===1<<p&&p<12&&p++}return a};class ou{constructor(e){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=s=>{const n=[];for(let a=0;a<s;a++){const l=this._st.readBytes(3);n.push(l)}return n},this.readSubBlocks=()=>{let s,n;n="";do s=this._st.readByte(),n+=this._st.read(s);while(s!==0);return n},this.parseHeader=()=>{const s={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(s.sig=this._st.read(3),s.ver=this._st.read(3),s.sig!=="GIF")throw new Error("Not a GIF file.");s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned(),this._currentFrameCanvas.width=s.width,this._currentFrameCanvas.height=s.height;const n=el(this._st.readByte());s.gctFlag=n.shift(),s.colorResolution=ya(n.splice(0,3)),s.sortedFlag=n.shift(),s.globalColorTableSize=ya(n.splice(0,3)),s.backgroundColorIndex=this._st.readByte(),s.pixelAspectRatio=this._st.readByte(),s.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<s.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(s)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=s=>{const n=v=>{this.checkBytes.push(this._st.readByte());const B=el(this._st.readByte());return v.reserved=B.splice(0,3),v.disposalMethod=ya(B.splice(0,3)),v.userInputFlag=B.shift(),v.transparentColorFlag=B.shift(),v.delayTime=this._st.readUnsigned(),v.transparentColorIndex=this._st.readByte(),v.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(v)&&this.checkBytes.push(this._handler.gce),v},a=v=>{v.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(v)&&this.checkBytes.push(this._handler.com)},l=v=>{this.checkBytes.push(this._st.readByte()),v.ptHeader=this._st.readBytes(12),v.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(v)&&this.checkBytes.push(this._handler.pte)},g=v=>{const B=z=>{this.checkBytes.push(this._st.readByte()),z.unknown=this._st.readByte(),z.iterations=this._st.readUnsigned(),z.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(z)&&this.checkBytes.push(this._handler.app)},P=z=>{z.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[z.identifier]&&this._handler.app[z.identifier](z)&&this.checkBytes.push(this._handler.app[z.identifier])};switch(this.checkBytes.push(this._st.readByte()),v.identifier=this._st.read(8),v.authCode=this._st.read(3),v.identifier){case"NETSCAPE":B(v);break;default:P(v);break}},p=v=>{v.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(v)&&this.checkBytes.push(this._handler.unknown)};switch(s.label=this._st.readByte(),s.label){case 249:s.extType="gce",this._gce=n(s);break;case 254:s.extType="com",a(s);break;case 1:s.extType="pte",l(s);break;case 255:s.extType="app",g(s);break;default:s.extType="unknown",p(s);break}},this.parseImg=s=>{var n;const a=(p,v)=>{const B=new Array(p.length),P=p.length/v,z=(ct,At)=>{const lt=p.slice(At*v,(At+1)*v);B.splice.apply(B,[ct*v,v].concat(lt))},$=[0,4,2,1],J=[8,8,4,2];let at=0;for(let ct=0;ct<4;ct++)for(let At=$[ct];At<P;At+=J[ct])z(At,at),at++;return B};s.leftPos=this._st.readUnsigned(),s.topPos=this._st.readUnsigned(),s.width=this._st.readUnsigned(),s.height=this._st.readUnsigned();const l=el(this._st.readByte());s.lctFlag=l.shift(),s.interlaced=l.shift(),s.sorted=l.shift(),s.reserved=l.splice(0,2),s.lctSize=ya(l.splice(0,3)),s.lctFlag&&(s.lctBytes=this.parseColorTableBytes(1<<s.lctSize+1)),s.lzwMinCodeSize=this._st.readByte();const g=this.readSubBlocks();s.pixels=y_(s.lzwMinCodeSize,g),s.interlaced&&(s.pixels=a(s.pixels,s.width)),!((n=this._gce)===null||n===void 0)&&n.delayTime&&(s.delayMs=this._gce.delayTime*10),this.frames.push(s),this.arrayToImage(s,s.lctFlag?s.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(s)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const s={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(s.sentinel)){case"!":s.type="ext",this.parseExt(s);break;case",":s.type="img",this.parseImg(s);break;case";":s.type="eof",this._handler.eof&&this._handler.eof(s)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+s.sentinel.toString(16))}s.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(s,n)=>{var a,l,g,p;const v=document.createElement("canvas");v.width=s.width,v.height=s.height;const B=v.getContext("2d"),P=B.getImageData(0,0,v.width,v.height);let z=-1;!((a=this._gce)===null||a===void 0)&&a.transparentColorFlag&&(z=this._gce.transparentColorIndex);for(let J=0;J<s.pixels.length;J++){const at=s.pixels[J],ct=n[at];at===z?P.data.set([0,0,0,0],J*4):P.data.set([...ct,255],J*4)}if(B.putImageData(P,0,0),((l=this._gce)===null||l===void 0?void 0:l.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((g=this._gce)===null||g===void 0?void 0:g.disposalMethod)===2&&(!((p=this._hdr)===null||p===void 0)&&p.gctFlag)){const J=n[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${J[0]}, ${J[1]}, ${J[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(v,s.leftPos,s.topPos,s.width,s.height);const $=new Image;$.src=this._currentFrameCanvas.toDataURL(),this.images.push($)},this._st=e,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class x_{constructor(e,s,{bustCache:n,...a}={}){this.path=e,this.family=s,this._isLoaded=!1,this._resource=new pt(e,"blob",n),this._options=a}async load(){if(this.isLoaded())return this.data;try{const e=await this._resource.load(),s=URL.createObjectURL(e);this.data||(this.data=new FontFace(this.family,`url(${s})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(e){throw`Error loading FontSource from path '${this.path}' with error [${e.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(e){return new Is({family:this.family,...this._options,...e})}}const au=eu(),b_=/^\s*(?:function)?\*/;function hu(d){return typeof d!="function"?!1:b_.test(Function.prototype.toString.call(d))?!0:Object.getPrototypeOf?Object.getPrototypeOf(d)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function lu(...d){var e;const s=j.getInstance();let n,a,l,g;hu(d[0])&&(a=globalThis,n=d[0],l=d[1]),hu(d[1])&&(a=d[0],n=d[1],l=d[2]),d[1]instanceof qi&&(a=d[0],g=d[1],n=d[2],l=d[3]),d[0]instanceof qi&&(a=globalThis,g=d[0],n=d[1],l=d[2]);const p=iu(au),v=l==null?void 0:l.timing,B=p?!1:(e=l==null?void 0:l.autostart)!==null&&e!==void 0?e:!0;let P;try{P=g??qi.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let z=!1,$=!1,J=!1;const at=n.bind(a),ct=at();let At;const lt=new Promise((Pt,wt)=>{At=Qt=>{try{if(J){$=!0,Pt();return}const{done:jt,value:It}=au.scope(!0,()=>ct.next(Qt));if(jt||J){$=!0,Pt();return}It instanceof Promise?It.then(()=>{P.clock.schedule(At,0,v)}):It===void 0||It===void 0?P.clock.schedule(At,0,v):P.clock.schedule(At,It||0,v)}catch(jt){wt(jt);return}},B&&(z=!0,At(P.clock.elapsed()))}),gt={isRunning:()=>z&&!J&&!$,isComplete:()=>$,cancel:()=>{J=!0},start:()=>(z?s.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(at)):(z=!0,At(P.clock.elapsed())),gt),generator:ct,done:lt,then:lt.then.bind(lt),[Symbol.iterator]:()=>ct};return gt}class xa extends Ci{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(e){var s,n,a,l;super(),this._logger=j.getInstance(),this.transform=new Ot,this.graphics=new De,this._completeFuture=new C,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=e.duration,this.easing=(s=e.easing)!==null&&s!==void 0?s:Ce.Linear,this.direction=(n=e.direction)!==null&&n!==void 0?n:"out",this.hideLoader=(a=e.hideLoader)!==null&&a!==void 0?a:!1,this.blockInput=(l=e.blockInput)!==null&&l!==void 0?l:!1,this.transform.coordPlane=We.Screen,this.transform.pos=I.Zero,this.transform.z=1/0,this.graphics.anchor=I.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(e,s){this.complete||(this._currentDistance+=L(s/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=L(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=L(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(e){}onStart(e){}onUpdate(e){}onEnd(e){}onReset(){}reset(){this.started=!1,this._completeFuture=new C,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(e,s){const n=s;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),n.world.entityManager.getById(this.id))return this._co;this._engine=e,n.add(this);const a=this;return this._co=lu(e,function*(){for(;!a.complete;){const l=yield;a.updateTransition(a._engine,l),a._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class C_ extends xa{constructor(e){var s,n;super({...e,duration:(s=e.duration)!==null&&s!==void 0?s:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(n=e.color)!==null&&n!==void 0?n:q.Black}onInitialize(e){this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=new ro({width:e.screen.resolution.width,height:e.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=e}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class E_ extends xa{constructor(e){super({direction:"in",...e}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(e){this.image=await e.engine.screenshot(!0),await this.image.decode()}onInitialize(e){this.engine=e,this.transform.pos=e.screen.unsafeArea.topLeft,this.screenCover=Se.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=R(1/e.screen.pixelRatio,1/e.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(e){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(e){this.graphics.opacity=e}onUpdate(e){this.graphics.opacity=e}}class I_ extends xa{constructor(e){var s;super({direction:"in",...e}),this._easing=Ce.Linear,this.name=`Slide#${this.id}`,this.slideDirection=e.slideDirection,this.transform.coordPlane=We.World,this.graphics.forceOnScreen=!0,this._easing=(s=e.easingFunction)!==null&&s!==void 0?s:this._easing,this._vectorEasing=Ce.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(e){this._image=await e.engine.screenshot(!0),await this._image.decode(),this._screenCover=Se.fromHtmlImageElement(this._image).toSprite()}onInitialize(e){switch(this._engine=e,this.slideDirection){case"up":{this._directionOffset=R(0,-e.screen.resolution.height);break}case"down":{this._directionOffset=R(0,e.screen.resolution.height);break}case"left":{this._directionOffset=R(-e.screen.resolution.width,0);break}case"right":{this._directionOffset=R(e.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=R(1/e.screen.pixelRatio,1/e.screen.pixelRatio)}onUpdate(e){this._camera.pos=this._vectorEasing(e,this._destinationCameraPosition,this._startCameraPosition,1)}}class il extends vt{constructor(e){super(),this.color=q.Black,this.thickness=1;const{start:s,end:n,color:a,thickness:l}=e;this.start=s,this.end=n,this.color=a??this.color,this.thickness=l??this.thickness,this._localBounds=this._calculateBounds();const{width:g,height:p}=this._localBounds;this.width=g,this.height=p}get localBounds(){return this._localBounds}_calculateBounds(){const e=this.end.sub(this.start).normal(),s=this.thickness/2,n=[this.start.add(e.scale(s)),this.end.add(e.scale(s)),this.end.add(e.scale(-s)),this.start.add(e.scale(-s))];return ht.fromPoints(n)}_drawImage(e,s,n){e.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new il({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class sl extends qs{get points(){return this._points}set points(e){this._points=e;const s=this.minPoint;this.width=this._points.reduce((n,a)=>Math.max(a.x,n),0)-s.x,this.height=this._points.reduce((n,a)=>Math.max(a.y,n),0)-s.y,this.flagDirty()}get minPoint(){const e=this._points.reduce((n,a)=>Math.min(a.x,n),1/0),s=this._points.reduce((n,a)=>Math.min(a.y,n),1/0);return R(e,s)}constructor(e){super(e),this._points=[],this.points=e.points,this.filtering=Gt.Blended,this.rasterize()}clone(){return new sl({points:this.points.map(e=>e.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(e){if(this.points&&this.points.length){e.beginPath();const s=this.minPoint.negate(),n=this.points[0].add(s);e.moveTo(n.x,n.y),this.points.forEach(a=>{e.lineTo(a.x+s.x,a.y+s.y)}),e.lineTo(n.x,n.y),e.closePath(),this.color&&e.fill(),this.strokeColor&&e.stroke()}}}var $s;(function(d){d.Stretch="stretch",d.Tile="tile",d.TileFit="tile-fit"})($s||($s={}));class rl extends vt{constructor(e){super(e),this._logger=j.getInstance(),this._config=e,this._imgSource=e.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(e,s=!1){this._config.width=e,s&&this._initialize()}setTargetHeight(e,s=!1){this._config.height=e,s&&this._initialize()}setMargins(e,s,n,a,l=!1){this._config.sourceConfig.leftMargin=e,this._config.sourceConfig.topMargin=s,this._config.sourceConfig.rightMargin=n,this._config.sourceConfig.bottomMargin=a,l&&this._initialize()}setStretch(e,s,n=!1){e==="horizontal"?this._config.destinationConfig.horizontalStretch=s:e==="vertical"?this._config.destinationConfig.verticalStretch=s:(this._config.destinationConfig.horizontalStretch=s,this._config.destinationConfig.verticalStretch=s),n&&this._initialize()}getConfig(){return this._config}_drawTile(e,s,n,a,l,g,p){const v=g||0,B=p||0;let P,z,$,J;const at=this._getNumberOfTiles(s.width,n.x,a),ct=this._getNumberOfTiles(s.height,n.y,l);for(let At=0;At<at;At++)for(let lt=0;lt<ct;lt++){let{tempSize:gt,tempPosition:Pt}=this._calculateParams(At,at,s.width,n.x,this._config.destinationConfig.horizontalStretch);P=gt,z=Pt,{tempSize:gt,tempPosition:Pt}=this._calculateParams(lt,ct,s.height,n.y,this._config.destinationConfig.verticalStretch),$=gt,J=Pt,e.drawImage(s,0,0,s.width,s.height,v+z,B+J,P,$)}}_drawImage(e,s,n){this._imgSource.isLoaded()?(this._drawTile(e,this._canvasA,new I(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(e,this._canvasB,new I(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(e,this._canvasC,new I(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(e,this._canvasD,new I(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(e,this._canvasE,new I(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasF,new I(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(e,this._canvasG,new I(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasH,new I(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(e,this._canvasI,new I(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const e=this._canvasA.getContext("2d");e==null||e.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const s=this._canvasB.getContext("2d");s==null||s.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const n=this._canvasC.getContext("2d");n==null||n.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const a=this._canvasD.getContext("2d");a==null||a.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const l=this._canvasE.getContext("2d");l==null||l.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const g=this._canvasF.getContext("2d");g==null||g.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const p=this._canvasG.getContext("2d");p==null||p.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const v=this._canvasH.getContext("2d");v==null||v.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const B=this._canvasI.getContext("2d");B==null||B.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new rl(this._config)}_getNumberOfTiles(e,s,n){switch(n){case $s.Stretch:return 1;case $s.Tile:return Math.ceil(s/e);case $s.TileFit:return Math.ceil(s/e)}}_calculateParams(e,s,n,a,l){switch(l){case $s.Stretch:return{tempPosition:0,tempSize:a};case $s.Tile:return e===s-1?{tempPosition:e*n,tempSize:n-(s*n-a)}:{tempPosition:e*n,tempSize:n};case $s.TileFit:const g=a/s;return{tempPosition:e*g,tempSize:g}}}}class nl extends Zi{constructor(e){super({...e,frames:e.animation.frames.slice(),strategy:e.animation.strategy,frameDuration:e.animation.frameDuration,speed:e.animation.speed,reverse:e.animation.isReversed}),this._ready=new C,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...e.sourceView},this._tiledWidth=e.width,this._tiledHeight=e.height;const s=[];for(let n=0;n<this.frames.length;n++){const a=this.frames[n].graphic;if(a&&a instanceof Ut){const l=new oi({image:a.image,width:e.width,height:e.height,sourceView:{...a.sourceView},wrapping:e.wrapping,filtering:e.filtering});this.frames[n].graphic=l,l.ready.then(()=>{l.sourceView={...l.sourceView,...this._sourceView}}),s.push(l.ready)}}Promise.all(s).then(()=>this._ready.resolve())}static fromAnimation(e,s){return new nl({width:e.width,height:e.height,...s,animation:e})}_updateSourceView(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof Ut&&(s.sourceView={...s.sourceView,...this._sourceView})}}get sourceView(){return mt(this._sourceView,()=>this._updateSourceView())}set sourceView(e){this._sourceView=mt(e,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let e=0;e<this.frames.length;e++){const s=this.frames[e].graphic;s&&s instanceof Ut&&(s.sourceView.height=this._tiledHeight||s.height,s.destSize.height=this._tiledHeight||s.height,s.sourceView.width=this._tiledWidth||s.width,s.destSize.width=this._tiledWidth||s.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(e){this._tiledWidth=e,this._updateWidthHeight()}set height(e){this._tiledHeight=e,this._updateWidthHeight()}}const cu=5,Rn={},B_=()=>{for(const d in Rn)Rn[d]=0},ba=(d,e)=>{const s=f.isEnabled("suppress-obsolete-message");Rn[d]<cu&&!s&&(j.getInstance().warn(d),console.trace&&e.showStackTrace&&console.trace()),Rn[d]++};function T_(d){return d={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...d},function(e,s,n){if(n&&!(typeof n.value=="function"||typeof n.get=="function"||typeof n.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const l=`${`${e.name||""}${e.name&&s?".":""}${s||""}`} is marked obsolete: ${d.message}`+(d.alternateMethod?` Use ${d.alternateMethod} instead`:"");Rn[l]||(Rn[l]=0);const g=n?{...n}:e;if(!n){class p extends g{constructor(...B){ba(l,d),super(...B)}}return p}return n&&n.value?(g.value=function(){return ba(l,d),n.value.apply(this,arguments)},g):(n&&n.get&&(g.get=function(){return ba(l,d),n.get.apply(this,arguments)}),n&&n.set&&(g.set=function(){return ba(l,d),n.set.apply(this,arguments)}),g)}}class S_{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const e=new C;return this._queue.push(e),e.promise}dequeue(e){this._queue.shift().resolve(e)}}class P_{constructor(e){this._count=e,this._waitQueue=new S_}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(e=1){if(e!==0){for(;e!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),e--;this._count+=e}}}const ol="0.30.1";return w(),h})())}(dl)),dl.exports}/*! For license information please see excalibur-tiled.min.js.LICENSE.txt */var Cu;function qA(){return Cu||(Cu=1,function(c,t){(function(i,r){c.exports=r(function(){try{return HA}catch{}}(),WA())})(self,(i,r)=>(()=>{var o={"./node_modules/compare-versions/lib/esm/compare.js":(A,y,w)=>{w.r(y),w.d(y,{compare:()=>T});var f=w("./node_modules/compare-versions/lib/esm/compareVersions.js");const T=(W,D,H)=>{E(H);const k=(0,f.compareVersions)(W,D);return C[H].includes(k)},C={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},S=Object.keys(C),E=W=>{if(typeof W!="string")throw new TypeError("Invalid operator type, expected string but got "+typeof W);if(S.indexOf(W)===-1)throw new Error(`Invalid operator, expected one of ${S.join("|")}`)}},"./node_modules/compare-versions/lib/esm/compareVersions.js":(A,y,w)=>{w.r(y),w.d(y,{compareVersions:()=>T});var f=w("./node_modules/compare-versions/lib/esm/utils.js");const T=(C,S)=>{const E=(0,f.validateAndParse)(C),W=(0,f.validateAndParse)(S),D=E.pop(),H=W.pop(),k=(0,f.compareSegments)(E,W);return k!==0?k:D&&H?(0,f.compareSegments)(D.split("."),H.split(".")):D||H?D?-1:1:0}},"./node_modules/compare-versions/lib/esm/utils.js":(A,y,w)=>{w.r(y),w.d(y,{compareSegments:()=>W,semver:()=>f,validateAndParse:()=>T});const f=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,T=D=>{if(typeof D!="string")throw new TypeError("Invalid argument expected string");const H=D.match(f);if(!H)throw new Error(`Invalid argument not valid semver ('${D}' received)`);return H.shift(),H},C=D=>D==="*"||D==="x"||D==="X",S=D=>{const H=parseInt(D,10);return isNaN(H)?D:H},E=(D,H)=>{if(C(D)||C(H))return 0;const[k,N]=((Q,L)=>typeof Q!=typeof L?[String(Q),String(L)]:[Q,L])(S(D),S(H));return k>N?1:k<N?-1:0},W=(D,H)=>{for(let k=0;k<Math.max(D.length,H.length);k++){const N=E(D[k]||"0",H[k]||"0");if(N!==0)return N}return 0}},"./node_modules/pako/index.js":(A,y,w)=>{var f={};(0,w("./node_modules/pako/lib/utils/common.js").assign)(f,w("./node_modules/pako/lib/deflate.js"),w("./node_modules/pako/lib/inflate.js"),w("./node_modules/pako/lib/zlib/constants.js")),A.exports=f},"./node_modules/pako/lib/deflate.js":(A,y,w)=>{var f=w("./node_modules/pako/lib/zlib/deflate.js"),T=w("./node_modules/pako/lib/utils/common.js"),C=w("./node_modules/pako/lib/utils/strings.js"),S=w("./node_modules/pako/lib/zlib/messages.js"),E=w("./node_modules/pako/lib/zlib/zstream.js"),W=Object.prototype.toString,D=0,H=-1,k=0,N=8;function Q(O){if(!(this instanceof Q))return new Q(O);this.options=T.assign({level:H,method:N,chunkSize:16384,windowBits:15,memLevel:8,strategy:k,to:""},O||{});var Y=this.options;Y.raw&&Y.windowBits>0?Y.windowBits=-Y.windowBits:Y.gzip&&Y.windowBits>0&&Y.windowBits<16&&(Y.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new E,this.strm.avail_out=0;var ot=f.deflateInit2(this.strm,Y.level,Y.method,Y.windowBits,Y.memLevel,Y.strategy);if(ot!==D)throw new Error(S[ot]);if(Y.header&&f.deflateSetHeader(this.strm,Y.header),Y.dictionary){var nt;if(nt=typeof Y.dictionary=="string"?C.string2buf(Y.dictionary):W.call(Y.dictionary)==="[object ArrayBuffer]"?new Uint8Array(Y.dictionary):Y.dictionary,(ot=f.deflateSetDictionary(this.strm,nt))!==D)throw new Error(S[ot]);this._dict_set=!0}}function L(O,Y){var ot=new Q(Y);if(ot.push(O,!0),ot.err)throw ot.msg||S[ot.err];return ot.result}Q.prototype.push=function(O,Y){var ot,nt,et=this.strm,ut=this.options.chunkSize;if(this.ended)return!1;nt=Y===~~Y?Y:Y===!0?4:0,typeof O=="string"?et.input=C.string2buf(O):W.call(O)==="[object ArrayBuffer]"?et.input=new Uint8Array(O):et.input=O,et.next_in=0,et.avail_in=et.input.length;do{if(et.avail_out===0&&(et.output=new T.Buf8(ut),et.next_out=0,et.avail_out=ut),(ot=f.deflate(et,nt))!==1&&ot!==D)return this.onEnd(ot),this.ended=!0,!1;et.avail_out!==0&&(et.avail_in!==0||nt!==4&&nt!==2)||(this.options.to==="string"?this.onData(C.buf2binstring(T.shrinkBuf(et.output,et.next_out))):this.onData(T.shrinkBuf(et.output,et.next_out)))}while((et.avail_in>0||et.avail_out===0)&&ot!==1);return nt===4?(ot=f.deflateEnd(this.strm),this.onEnd(ot),this.ended=!0,ot===D):nt!==2||(this.onEnd(D),et.avail_out=0,!0)},Q.prototype.onData=function(O){this.chunks.push(O)},Q.prototype.onEnd=function(O){O===D&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=T.flattenChunks(this.chunks)),this.chunks=[],this.err=O,this.msg=this.strm.msg},y.Deflate=Q,y.deflate=L,y.deflateRaw=function(O,Y){return(Y=Y||{}).raw=!0,L(O,Y)},y.gzip=function(O,Y){return(Y=Y||{}).gzip=!0,L(O,Y)}},"./node_modules/pako/lib/inflate.js":(A,y,w)=>{var f=w("./node_modules/pako/lib/zlib/inflate.js"),T=w("./node_modules/pako/lib/utils/common.js"),C=w("./node_modules/pako/lib/utils/strings.js"),S=w("./node_modules/pako/lib/zlib/constants.js"),E=w("./node_modules/pako/lib/zlib/messages.js"),W=w("./node_modules/pako/lib/zlib/zstream.js"),D=w("./node_modules/pako/lib/zlib/gzheader.js"),H=Object.prototype.toString;function k(Q){if(!(this instanceof k))return new k(Q);this.options=T.assign({chunkSize:16384,windowBits:0,to:""},Q||{});var L=this.options;L.raw&&L.windowBits>=0&&L.windowBits<16&&(L.windowBits=-L.windowBits,L.windowBits===0&&(L.windowBits=-15)),!(L.windowBits>=0&&L.windowBits<16)||Q&&Q.windowBits||(L.windowBits+=32),L.windowBits>15&&L.windowBits<48&&!(15&L.windowBits)&&(L.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new W,this.strm.avail_out=0;var O=f.inflateInit2(this.strm,L.windowBits);if(O!==S.Z_OK)throw new Error(E[O]);if(this.header=new D,f.inflateGetHeader(this.strm,this.header),L.dictionary&&(typeof L.dictionary=="string"?L.dictionary=C.string2buf(L.dictionary):H.call(L.dictionary)==="[object ArrayBuffer]"&&(L.dictionary=new Uint8Array(L.dictionary)),L.raw&&(O=f.inflateSetDictionary(this.strm,L.dictionary))!==S.Z_OK))throw new Error(E[O])}function N(Q,L){var O=new k(L);if(O.push(Q,!0),O.err)throw O.msg||E[O.err];return O.result}k.prototype.push=function(Q,L){var O,Y,ot,nt,et,ut=this.strm,Z=this.options.chunkSize,I=this.options.dictionary,R=!1;if(this.ended)return!1;Y=L===~~L?L:L===!0?S.Z_FINISH:S.Z_NO_FLUSH,typeof Q=="string"?ut.input=C.binstring2buf(Q):H.call(Q)==="[object ArrayBuffer]"?ut.input=new Uint8Array(Q):ut.input=Q,ut.next_in=0,ut.avail_in=ut.input.length;do{if(ut.avail_out===0&&(ut.output=new T.Buf8(Z),ut.next_out=0,ut.avail_out=Z),(O=f.inflate(ut,S.Z_NO_FLUSH))===S.Z_NEED_DICT&&I&&(O=f.inflateSetDictionary(this.strm,I)),O===S.Z_BUF_ERROR&&R===!0&&(O=S.Z_OK,R=!1),O!==S.Z_STREAM_END&&O!==S.Z_OK)return this.onEnd(O),this.ended=!0,!1;ut.next_out&&(ut.avail_out!==0&&O!==S.Z_STREAM_END&&(ut.avail_in!==0||Y!==S.Z_FINISH&&Y!==S.Z_SYNC_FLUSH)||(this.options.to==="string"?(ot=C.utf8border(ut.output,ut.next_out),nt=ut.next_out-ot,et=C.buf2string(ut.output,ot),ut.next_out=nt,ut.avail_out=Z-nt,nt&&T.arraySet(ut.output,ut.output,ot,nt,0),this.onData(et)):this.onData(T.shrinkBuf(ut.output,ut.next_out)))),ut.avail_in===0&&ut.avail_out===0&&(R=!0)}while((ut.avail_in>0||ut.avail_out===0)&&O!==S.Z_STREAM_END);return O===S.Z_STREAM_END&&(Y=S.Z_FINISH),Y===S.Z_FINISH?(O=f.inflateEnd(this.strm),this.onEnd(O),this.ended=!0,O===S.Z_OK):Y!==S.Z_SYNC_FLUSH||(this.onEnd(S.Z_OK),ut.avail_out=0,!0)},k.prototype.onData=function(Q){this.chunks.push(Q)},k.prototype.onEnd=function(Q){Q===S.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=T.flattenChunks(this.chunks)),this.chunks=[],this.err=Q,this.msg=this.strm.msg},y.Inflate=k,y.inflate=N,y.inflateRaw=function(Q,L){return(L=L||{}).raw=!0,N(Q,L)},y.ungzip=N},"./node_modules/pako/lib/utils/common.js":(A,y)=>{var w=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";function f(S,E){return Object.prototype.hasOwnProperty.call(S,E)}y.assign=function(S){for(var E=Array.prototype.slice.call(arguments,1);E.length;){var W=E.shift();if(W){if(typeof W!="object")throw new TypeError(W+"must be non-object");for(var D in W)f(W,D)&&(S[D]=W[D])}}return S},y.shrinkBuf=function(S,E){return S.length===E?S:S.subarray?S.subarray(0,E):(S.length=E,S)};var T={arraySet:function(S,E,W,D,H){if(E.subarray&&S.subarray)S.set(E.subarray(W,W+D),H);else for(var k=0;k<D;k++)S[H+k]=E[W+k]},flattenChunks:function(S){var E,W,D,H,k,N;for(D=0,E=0,W=S.length;E<W;E++)D+=S[E].length;for(N=new Uint8Array(D),H=0,E=0,W=S.length;E<W;E++)k=S[E],N.set(k,H),H+=k.length;return N}},C={arraySet:function(S,E,W,D,H){for(var k=0;k<D;k++)S[H+k]=E[W+k]},flattenChunks:function(S){return[].concat.apply([],S)}};y.setTyped=function(S){S?(y.Buf8=Uint8Array,y.Buf16=Uint16Array,y.Buf32=Int32Array,y.assign(y,T)):(y.Buf8=Array,y.Buf16=Array,y.Buf32=Array,y.assign(y,C))},y.setTyped(w)},"./node_modules/pako/lib/utils/strings.js":(A,y,w)=>{var f=w("./node_modules/pako/lib/utils/common.js"),T=!0,C=!0;try{String.fromCharCode.apply(null,[0])}catch{T=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{C=!1}for(var S=new f.Buf8(256),E=0;E<256;E++)S[E]=E>=252?6:E>=248?5:E>=240?4:E>=224?3:E>=192?2:1;function W(D,H){if(H<65534&&(D.subarray&&C||!D.subarray&&T))return String.fromCharCode.apply(null,f.shrinkBuf(D,H));for(var k="",N=0;N<H;N++)k+=String.fromCharCode(D[N]);return k}S[254]=S[254]=1,y.string2buf=function(D){var H,k,N,Q,L,O=D.length,Y=0;for(Q=0;Q<O;Q++)(64512&(k=D.charCodeAt(Q)))==55296&&Q+1<O&&(64512&(N=D.charCodeAt(Q+1)))==56320&&(k=65536+(k-55296<<10)+(N-56320),Q++),Y+=k<128?1:k<2048?2:k<65536?3:4;for(H=new f.Buf8(Y),L=0,Q=0;L<Y;Q++)(64512&(k=D.charCodeAt(Q)))==55296&&Q+1<O&&(64512&(N=D.charCodeAt(Q+1)))==56320&&(k=65536+(k-55296<<10)+(N-56320),Q++),k<128?H[L++]=k:k<2048?(H[L++]=192|k>>>6,H[L++]=128|63&k):k<65536?(H[L++]=224|k>>>12,H[L++]=128|k>>>6&63,H[L++]=128|63&k):(H[L++]=240|k>>>18,H[L++]=128|k>>>12&63,H[L++]=128|k>>>6&63,H[L++]=128|63&k);return H},y.buf2binstring=function(D){return W(D,D.length)},y.binstring2buf=function(D){for(var H=new f.Buf8(D.length),k=0,N=H.length;k<N;k++)H[k]=D.charCodeAt(k);return H},y.buf2string=function(D,H){var k,N,Q,L,O=H||D.length,Y=new Array(2*O);for(N=0,k=0;k<O;)if((Q=D[k++])<128)Y[N++]=Q;else if((L=S[Q])>4)Y[N++]=65533,k+=L-1;else{for(Q&=L===2?31:L===3?15:7;L>1&&k<O;)Q=Q<<6|63&D[k++],L--;L>1?Y[N++]=65533:Q<65536?Y[N++]=Q:(Q-=65536,Y[N++]=55296|Q>>10&1023,Y[N++]=56320|1023&Q)}return W(Y,N)},y.utf8border=function(D,H){var k;for((H=H||D.length)>D.length&&(H=D.length),k=H-1;k>=0&&(192&D[k])==128;)k--;return k<0||k===0?H:k+S[D[k]]>H?k:H}},"./node_modules/pako/lib/zlib/adler32.js":A=>{A.exports=function(y,w,f,T){for(var C=65535&y|0,S=y>>>16&65535|0,E=0;f!==0;){f-=E=f>2e3?2e3:f;do S=S+(C=C+w[T++]|0)|0;while(--E);C%=65521,S%=65521}return C|S<<16|0}},"./node_modules/pako/lib/zlib/constants.js":A=>{A.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},"./node_modules/pako/lib/zlib/crc32.js":A=>{var y=function(){for(var w,f=[],T=0;T<256;T++){w=T;for(var C=0;C<8;C++)w=1&w?3988292384^w>>>1:w>>>1;f[T]=w}return f}();A.exports=function(w,f,T,C){var S=y,E=C+T;w^=-1;for(var W=C;W<E;W++)w=w>>>8^S[255&(w^f[W])];return-1^w}},"./node_modules/pako/lib/zlib/deflate.js":(A,y,w)=>{var f,T=w("./node_modules/pako/lib/utils/common.js"),C=w("./node_modules/pako/lib/zlib/trees.js"),S=w("./node_modules/pako/lib/zlib/adler32.js"),E=w("./node_modules/pako/lib/zlib/crc32.js"),W=w("./node_modules/pako/lib/zlib/messages.js"),D=0,H=0,k=-2,N=2,Q=8,L=286,O=30,Y=19,ot=2*L+1,nt=15,et=3,ut=258,Z=ut+et+1,I=42,R=103,q=113,tt=666;function X(x,st){return x.msg=W[st],st}function j(x){return(x<<1)-(x>4?9:0)}function F(x){for(var st=x.length;--st>=0;)x[st]=0}function St(x){var st=x.state,_t=st.pending;_t>x.avail_out&&(_t=x.avail_out),_t!==0&&(T.arraySet(x.output,st.pending_buf,st.pending_out,_t,x.next_out),x.next_out+=_t,st.pending_out+=_t,x.total_out+=_t,x.avail_out-=_t,st.pending-=_t,st.pending===0&&(st.pending_out=0))}function Dt(x,st){C._tr_flush_block(x,x.block_start>=0?x.block_start:-1,x.strstart-x.block_start,st),x.block_start=x.strstart,St(x.strm)}function ht(x,st){x.pending_buf[x.pending++]=st}function Mt(x,st){x.pending_buf[x.pending++]=st>>>8&255,x.pending_buf[x.pending++]=255&st}function Ct(x,st){var _t,V,Ft=x.max_chain_length,Lt=x.strstart,Et=x.prev_length,pt=x.nice_match,mt=x.strstart>x.w_size-Z?x.strstart-(x.w_size-Z):0,bt=x.window,Bt=x.w_mask,vt=x.prev,Ut=x.strstart+ut,Gt=bt[Lt+Et-1],Nt=bt[Lt+Et];x.prev_length>=x.good_match&&(Ft>>=2),pt>x.lookahead&&(pt=x.lookahead);do if(bt[(_t=st)+Et]===Nt&&bt[_t+Et-1]===Gt&&bt[_t]===bt[Lt]&&bt[++_t]===bt[Lt+1]){Lt+=2,_t++;do;while(bt[++Lt]===bt[++_t]&&bt[++Lt]===bt[++_t]&&bt[++Lt]===bt[++_t]&&bt[++Lt]===bt[++_t]&&bt[++Lt]===bt[++_t]&&bt[++Lt]===bt[++_t]&&bt[++Lt]===bt[++_t]&&bt[++Lt]===bt[++_t]&&Lt<Ut);if(V=ut-(Ut-Lt),Lt=Ut-ut,V>Et){if(x.match_start=st,Et=V,V>=pt)break;Gt=bt[Lt+Et-1],Nt=bt[Lt+Et]}}while((st=vt[st&Bt])>mt&&--Ft!=0);return Et<=x.lookahead?Et:x.lookahead}function Yt(x){var st,_t,V,Ft,Lt,Et,pt,mt,bt,Bt,vt=x.w_size;do{if(Ft=x.window_size-x.lookahead-x.strstart,x.strstart>=vt+(vt-Z)){T.arraySet(x.window,x.window,vt,vt,0),x.match_start-=vt,x.strstart-=vt,x.block_start-=vt,st=_t=x.hash_size;do V=x.head[--st],x.head[st]=V>=vt?V-vt:0;while(--_t);st=_t=vt;do V=x.prev[--st],x.prev[st]=V>=vt?V-vt:0;while(--_t);Ft+=vt}if(x.strm.avail_in===0)break;if(Et=x.strm,pt=x.window,mt=x.strstart+x.lookahead,bt=Ft,Bt=void 0,(Bt=Et.avail_in)>bt&&(Bt=bt),_t=Bt===0?0:(Et.avail_in-=Bt,T.arraySet(pt,Et.input,Et.next_in,Bt,mt),Et.state.wrap===1?Et.adler=S(Et.adler,pt,Bt,mt):Et.state.wrap===2&&(Et.adler=E(Et.adler,pt,Bt,mt)),Et.next_in+=Bt,Et.total_in+=Bt,Bt),x.lookahead+=_t,x.lookahead+x.insert>=et)for(Lt=x.strstart-x.insert,x.ins_h=x.window[Lt],x.ins_h=(x.ins_h<<x.hash_shift^x.window[Lt+1])&x.hash_mask;x.insert&&(x.ins_h=(x.ins_h<<x.hash_shift^x.window[Lt+et-1])&x.hash_mask,x.prev[Lt&x.w_mask]=x.head[x.ins_h],x.head[x.ins_h]=Lt,Lt++,x.insert--,!(x.lookahead+x.insert<et)););}while(x.lookahead<Z&&x.strm.avail_in!==0)}function xt(x,st){for(var _t,V;;){if(x.lookahead<Z){if(Yt(x),x.lookahead<Z&&st===D)return 1;if(x.lookahead===0)break}if(_t=0,x.lookahead>=et&&(x.ins_h=(x.ins_h<<x.hash_shift^x.window[x.strstart+et-1])&x.hash_mask,_t=x.prev[x.strstart&x.w_mask]=x.head[x.ins_h],x.head[x.ins_h]=x.strstart),_t!==0&&x.strstart-_t<=x.w_size-Z&&(x.match_length=Ct(x,_t)),x.match_length>=et)if(V=C._tr_tally(x,x.strstart-x.match_start,x.match_length-et),x.lookahead-=x.match_length,x.match_length<=x.max_lazy_match&&x.lookahead>=et){x.match_length--;do x.strstart++,x.ins_h=(x.ins_h<<x.hash_shift^x.window[x.strstart+et-1])&x.hash_mask,_t=x.prev[x.strstart&x.w_mask]=x.head[x.ins_h],x.head[x.ins_h]=x.strstart;while(--x.match_length!=0);x.strstart++}else x.strstart+=x.match_length,x.match_length=0,x.ins_h=x.window[x.strstart],x.ins_h=(x.ins_h<<x.hash_shift^x.window[x.strstart+1])&x.hash_mask;else V=C._tr_tally(x,0,x.window[x.strstart]),x.lookahead--,x.strstart++;if(V&&(Dt(x,!1),x.strm.avail_out===0))return 1}return x.insert=x.strstart<et-1?x.strstart:et-1,st===4?(Dt(x,!0),x.strm.avail_out===0?3:4):x.last_lit&&(Dt(x,!1),x.strm.avail_out===0)?1:2}function yt(x,st){for(var _t,V,Ft;;){if(x.lookahead<Z){if(Yt(x),x.lookahead<Z&&st===D)return 1;if(x.lookahead===0)break}if(_t=0,x.lookahead>=et&&(x.ins_h=(x.ins_h<<x.hash_shift^x.window[x.strstart+et-1])&x.hash_mask,_t=x.prev[x.strstart&x.w_mask]=x.head[x.ins_h],x.head[x.ins_h]=x.strstart),x.prev_length=x.match_length,x.prev_match=x.match_start,x.match_length=et-1,_t!==0&&x.prev_length<x.max_lazy_match&&x.strstart-_t<=x.w_size-Z&&(x.match_length=Ct(x,_t),x.match_length<=5&&(x.strategy===1||x.match_length===et&&x.strstart-x.match_start>4096)&&(x.match_length=et-1)),x.prev_length>=et&&x.match_length<=x.prev_length){Ft=x.strstart+x.lookahead-et,V=C._tr_tally(x,x.strstart-1-x.prev_match,x.prev_length-et),x.lookahead-=x.prev_length-1,x.prev_length-=2;do++x.strstart<=Ft&&(x.ins_h=(x.ins_h<<x.hash_shift^x.window[x.strstart+et-1])&x.hash_mask,_t=x.prev[x.strstart&x.w_mask]=x.head[x.ins_h],x.head[x.ins_h]=x.strstart);while(--x.prev_length!=0);if(x.match_available=0,x.match_length=et-1,x.strstart++,V&&(Dt(x,!1),x.strm.avail_out===0))return 1}else if(x.match_available){if((V=C._tr_tally(x,0,x.window[x.strstart-1]))&&Dt(x,!1),x.strstart++,x.lookahead--,x.strm.avail_out===0)return 1}else x.match_available=1,x.strstart++,x.lookahead--}return x.match_available&&(V=C._tr_tally(x,0,x.window[x.strstart-1]),x.match_available=0),x.insert=x.strstart<et-1?x.strstart:et-1,st===4?(Dt(x,!0),x.strm.avail_out===0?3:4):x.last_lit&&(Dt(x,!1),x.strm.avail_out===0)?1:2}function de(x,st,_t,V,Ft){this.good_length=x,this.max_lazy=st,this.nice_length=_t,this.max_chain=V,this.func=Ft}function Kt(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Q,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new T.Buf16(2*ot),this.dyn_dtree=new T.Buf16(2*(2*O+1)),this.bl_tree=new T.Buf16(2*(2*Y+1)),F(this.dyn_ltree),F(this.dyn_dtree),F(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new T.Buf16(nt+1),this.heap=new T.Buf16(2*L+1),F(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new T.Buf16(2*L+1),F(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function Ht(x){var st;return x&&x.state?(x.total_in=x.total_out=0,x.data_type=N,(st=x.state).pending=0,st.pending_out=0,st.wrap<0&&(st.wrap=-st.wrap),st.status=st.wrap?I:q,x.adler=st.wrap===2?0:1,st.last_flush=D,C._tr_init(st),H):X(x,k)}function Ie(x){var st,_t=Ht(x);return _t===H&&((st=x.state).window_size=2*st.w_size,F(st.head),st.max_lazy_match=f[st.level].max_lazy,st.good_match=f[st.level].good_length,st.nice_match=f[st.level].nice_length,st.max_chain_length=f[st.level].max_chain,st.strstart=0,st.block_start=0,st.lookahead=0,st.insert=0,st.match_length=st.prev_length=et-1,st.match_available=0,st.ins_h=0),_t}function it(x,st,_t,V,Ft,Lt){if(!x)return k;var Et=1;if(st===-1&&(st=6),V<0?(Et=0,V=-V):V>15&&(Et=2,V-=16),Ft<1||Ft>9||_t!==Q||V<8||V>15||st<0||st>9||Lt<0||Lt>4)return X(x,k);V===8&&(V=9);var pt=new Kt;return x.state=pt,pt.strm=x,pt.wrap=Et,pt.gzhead=null,pt.w_bits=V,pt.w_size=1<<pt.w_bits,pt.w_mask=pt.w_size-1,pt.hash_bits=Ft+7,pt.hash_size=1<<pt.hash_bits,pt.hash_mask=pt.hash_size-1,pt.hash_shift=~~((pt.hash_bits+et-1)/et),pt.window=new T.Buf8(2*pt.w_size),pt.head=new T.Buf16(pt.hash_size),pt.prev=new T.Buf16(pt.w_size),pt.lit_bufsize=1<<Ft+6,pt.pending_buf_size=4*pt.lit_bufsize,pt.pending_buf=new T.Buf8(pt.pending_buf_size),pt.d_buf=1*pt.lit_bufsize,pt.l_buf=3*pt.lit_bufsize,pt.level=st,pt.strategy=Lt,pt.method=_t,Ie(x)}f=[new de(0,0,0,0,function(x,st){var _t=65535;for(_t>x.pending_buf_size-5&&(_t=x.pending_buf_size-5);;){if(x.lookahead<=1){if(Yt(x),x.lookahead===0&&st===D)return 1;if(x.lookahead===0)break}x.strstart+=x.lookahead,x.lookahead=0;var V=x.block_start+_t;if((x.strstart===0||x.strstart>=V)&&(x.lookahead=x.strstart-V,x.strstart=V,Dt(x,!1),x.strm.avail_out===0)||x.strstart-x.block_start>=x.w_size-Z&&(Dt(x,!1),x.strm.avail_out===0))return 1}return x.insert=0,st===4?(Dt(x,!0),x.strm.avail_out===0?3:4):(x.strstart>x.block_start&&(Dt(x,!1),x.strm.avail_out),1)}),new de(4,4,8,4,xt),new de(4,5,16,8,xt),new de(4,6,32,32,xt),new de(4,4,16,16,yt),new de(8,16,32,32,yt),new de(8,16,128,128,yt),new de(8,32,128,256,yt),new de(32,128,258,1024,yt),new de(32,258,258,4096,yt)],y.deflateInit=function(x,st){return it(x,st,Q,15,8,0)},y.deflateInit2=it,y.deflateReset=Ie,y.deflateResetKeep=Ht,y.deflateSetHeader=function(x,st){return x&&x.state?x.state.wrap!==2?k:(x.state.gzhead=st,H):k},y.deflate=function(x,st){var _t,V,Ft,Lt;if(!x||!x.state||st>5||st<0)return x?X(x,k):k;if(V=x.state,!x.output||!x.input&&x.avail_in!==0||V.status===tt&&st!==4)return X(x,x.avail_out===0?-5:k);if(V.strm=x,_t=V.last_flush,V.last_flush=st,V.status===I)if(V.wrap===2)x.adler=0,ht(V,31),ht(V,139),ht(V,8),V.gzhead?(ht(V,(V.gzhead.text?1:0)+(V.gzhead.hcrc?2:0)+(V.gzhead.extra?4:0)+(V.gzhead.name?8:0)+(V.gzhead.comment?16:0)),ht(V,255&V.gzhead.time),ht(V,V.gzhead.time>>8&255),ht(V,V.gzhead.time>>16&255),ht(V,V.gzhead.time>>24&255),ht(V,V.level===9?2:V.strategy>=2||V.level<2?4:0),ht(V,255&V.gzhead.os),V.gzhead.extra&&V.gzhead.extra.length&&(ht(V,255&V.gzhead.extra.length),ht(V,V.gzhead.extra.length>>8&255)),V.gzhead.hcrc&&(x.adler=E(x.adler,V.pending_buf,V.pending,0)),V.gzindex=0,V.status=69):(ht(V,0),ht(V,0),ht(V,0),ht(V,0),ht(V,0),ht(V,V.level===9?2:V.strategy>=2||V.level<2?4:0),ht(V,3),V.status=q);else{var Et=Q+(V.w_bits-8<<4)<<8;Et|=(V.strategy>=2||V.level<2?0:V.level<6?1:V.level===6?2:3)<<6,V.strstart!==0&&(Et|=32),Et+=31-Et%31,V.status=q,Mt(V,Et),V.strstart!==0&&(Mt(V,x.adler>>>16),Mt(V,65535&x.adler)),x.adler=1}if(V.status===69)if(V.gzhead.extra){for(Ft=V.pending;V.gzindex<(65535&V.gzhead.extra.length)&&(V.pending!==V.pending_buf_size||(V.gzhead.hcrc&&V.pending>Ft&&(x.adler=E(x.adler,V.pending_buf,V.pending-Ft,Ft)),St(x),Ft=V.pending,V.pending!==V.pending_buf_size));)ht(V,255&V.gzhead.extra[V.gzindex]),V.gzindex++;V.gzhead.hcrc&&V.pending>Ft&&(x.adler=E(x.adler,V.pending_buf,V.pending-Ft,Ft)),V.gzindex===V.gzhead.extra.length&&(V.gzindex=0,V.status=73)}else V.status=73;if(V.status===73)if(V.gzhead.name){Ft=V.pending;do{if(V.pending===V.pending_buf_size&&(V.gzhead.hcrc&&V.pending>Ft&&(x.adler=E(x.adler,V.pending_buf,V.pending-Ft,Ft)),St(x),Ft=V.pending,V.pending===V.pending_buf_size)){Lt=1;break}Lt=V.gzindex<V.gzhead.name.length?255&V.gzhead.name.charCodeAt(V.gzindex++):0,ht(V,Lt)}while(Lt!==0);V.gzhead.hcrc&&V.pending>Ft&&(x.adler=E(x.adler,V.pending_buf,V.pending-Ft,Ft)),Lt===0&&(V.gzindex=0,V.status=91)}else V.status=91;if(V.status===91)if(V.gzhead.comment){Ft=V.pending;do{if(V.pending===V.pending_buf_size&&(V.gzhead.hcrc&&V.pending>Ft&&(x.adler=E(x.adler,V.pending_buf,V.pending-Ft,Ft)),St(x),Ft=V.pending,V.pending===V.pending_buf_size)){Lt=1;break}Lt=V.gzindex<V.gzhead.comment.length?255&V.gzhead.comment.charCodeAt(V.gzindex++):0,ht(V,Lt)}while(Lt!==0);V.gzhead.hcrc&&V.pending>Ft&&(x.adler=E(x.adler,V.pending_buf,V.pending-Ft,Ft)),Lt===0&&(V.status=R)}else V.status=R;if(V.status===R&&(V.gzhead.hcrc?(V.pending+2>V.pending_buf_size&&St(x),V.pending+2<=V.pending_buf_size&&(ht(V,255&x.adler),ht(V,x.adler>>8&255),x.adler=0,V.status=q)):V.status=q),V.pending!==0){if(St(x),x.avail_out===0)return V.last_flush=-1,H}else if(x.avail_in===0&&j(st)<=j(_t)&&st!==4)return X(x,-5);if(V.status===tt&&x.avail_in!==0)return X(x,-5);if(x.avail_in!==0||V.lookahead!==0||st!==D&&V.status!==tt){var pt=V.strategy===2?function(mt,bt){for(var Bt;;){if(mt.lookahead===0&&(Yt(mt),mt.lookahead===0)){if(bt===D)return 1;break}if(mt.match_length=0,Bt=C._tr_tally(mt,0,mt.window[mt.strstart]),mt.lookahead--,mt.strstart++,Bt&&(Dt(mt,!1),mt.strm.avail_out===0))return 1}return mt.insert=0,bt===4?(Dt(mt,!0),mt.strm.avail_out===0?3:4):mt.last_lit&&(Dt(mt,!1),mt.strm.avail_out===0)?1:2}(V,st):V.strategy===3?function(mt,bt){for(var Bt,vt,Ut,Gt,Nt=mt.window;;){if(mt.lookahead<=ut){if(Yt(mt),mt.lookahead<=ut&&bt===D)return 1;if(mt.lookahead===0)break}if(mt.match_length=0,mt.lookahead>=et&&mt.strstart>0&&(vt=Nt[Ut=mt.strstart-1])===Nt[++Ut]&&vt===Nt[++Ut]&&vt===Nt[++Ut]){Gt=mt.strstart+ut;do;while(vt===Nt[++Ut]&&vt===Nt[++Ut]&&vt===Nt[++Ut]&&vt===Nt[++Ut]&&vt===Nt[++Ut]&&vt===Nt[++Ut]&&vt===Nt[++Ut]&&vt===Nt[++Ut]&&Ut<Gt);mt.match_length=ut-(Gt-Ut),mt.match_length>mt.lookahead&&(mt.match_length=mt.lookahead)}if(mt.match_length>=et?(Bt=C._tr_tally(mt,1,mt.match_length-et),mt.lookahead-=mt.match_length,mt.strstart+=mt.match_length,mt.match_length=0):(Bt=C._tr_tally(mt,0,mt.window[mt.strstart]),mt.lookahead--,mt.strstart++),Bt&&(Dt(mt,!1),mt.strm.avail_out===0))return 1}return mt.insert=0,bt===4?(Dt(mt,!0),mt.strm.avail_out===0?3:4):mt.last_lit&&(Dt(mt,!1),mt.strm.avail_out===0)?1:2}(V,st):f[V.level].func(V,st);if(pt!==3&&pt!==4||(V.status=tt),pt===1||pt===3)return x.avail_out===0&&(V.last_flush=-1),H;if(pt===2&&(st===1?C._tr_align(V):st!==5&&(C._tr_stored_block(V,0,0,!1),st===3&&(F(V.head),V.lookahead===0&&(V.strstart=0,V.block_start=0,V.insert=0))),St(x),x.avail_out===0))return V.last_flush=-1,H}return st!==4?H:V.wrap<=0?1:(V.wrap===2?(ht(V,255&x.adler),ht(V,x.adler>>8&255),ht(V,x.adler>>16&255),ht(V,x.adler>>24&255),ht(V,255&x.total_in),ht(V,x.total_in>>8&255),ht(V,x.total_in>>16&255),ht(V,x.total_in>>24&255)):(Mt(V,x.adler>>>16),Mt(V,65535&x.adler)),St(x),V.wrap>0&&(V.wrap=-V.wrap),V.pending!==0?H:1)},y.deflateEnd=function(x){var st;return x&&x.state?(st=x.state.status)!==I&&st!==69&&st!==73&&st!==91&&st!==R&&st!==q&&st!==tt?X(x,k):(x.state=null,st===q?X(x,-3):H):k},y.deflateSetDictionary=function(x,st){var _t,V,Ft,Lt,Et,pt,mt,bt,Bt=st.length;if(!x||!x.state||(Lt=(_t=x.state).wrap)===2||Lt===1&&_t.status!==I||_t.lookahead)return k;for(Lt===1&&(x.adler=S(x.adler,st,Bt,0)),_t.wrap=0,Bt>=_t.w_size&&(Lt===0&&(F(_t.head),_t.strstart=0,_t.block_start=0,_t.insert=0),bt=new T.Buf8(_t.w_size),T.arraySet(bt,st,Bt-_t.w_size,_t.w_size,0),st=bt,Bt=_t.w_size),Et=x.avail_in,pt=x.next_in,mt=x.input,x.avail_in=Bt,x.next_in=0,x.input=st,Yt(_t);_t.lookahead>=et;){V=_t.strstart,Ft=_t.lookahead-(et-1);do _t.ins_h=(_t.ins_h<<_t.hash_shift^_t.window[V+et-1])&_t.hash_mask,_t.prev[V&_t.w_mask]=_t.head[_t.ins_h],_t.head[_t.ins_h]=V,V++;while(--Ft);_t.strstart=V,_t.lookahead=et-1,Yt(_t)}return _t.strstart+=_t.lookahead,_t.block_start=_t.strstart,_t.insert=_t.lookahead,_t.lookahead=0,_t.match_length=_t.prev_length=et-1,_t.match_available=0,x.next_in=pt,x.input=mt,x.avail_in=Et,_t.wrap=Lt,H},y.deflateInfo="pako deflate (from Nodeca project)"},"./node_modules/pako/lib/zlib/gzheader.js":A=>{A.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},"./node_modules/pako/lib/zlib/inffast.js":A=>{A.exports=function(y,w){var f,T,C,S,E,W,D,H,k,N,Q,L,O,Y,ot,nt,et,ut,Z,I,R,q,tt,X,j;f=y.state,T=y.next_in,X=y.input,C=T+(y.avail_in-5),S=y.next_out,j=y.output,E=S-(w-y.avail_out),W=S+(y.avail_out-257),D=f.dmax,H=f.wsize,k=f.whave,N=f.wnext,Q=f.window,L=f.hold,O=f.bits,Y=f.lencode,ot=f.distcode,nt=(1<<f.lenbits)-1,et=(1<<f.distbits)-1;t:do{O<15&&(L+=X[T++]<<O,O+=8,L+=X[T++]<<O,O+=8),ut=Y[L&nt];e:for(;;){if(L>>>=Z=ut>>>24,O-=Z,(Z=ut>>>16&255)==0)j[S++]=65535&ut;else{if(!(16&Z)){if(!(64&Z)){ut=Y[(65535&ut)+(L&(1<<Z)-1)];continue e}if(32&Z){f.mode=12;break t}y.msg="invalid literal/length code",f.mode=30;break t}I=65535&ut,(Z&=15)&&(O<Z&&(L+=X[T++]<<O,O+=8),I+=L&(1<<Z)-1,L>>>=Z,O-=Z),O<15&&(L+=X[T++]<<O,O+=8,L+=X[T++]<<O,O+=8),ut=ot[L&et];i:for(;;){if(L>>>=Z=ut>>>24,O-=Z,!(16&(Z=ut>>>16&255))){if(!(64&Z)){ut=ot[(65535&ut)+(L&(1<<Z)-1)];continue i}y.msg="invalid distance code",f.mode=30;break t}if(R=65535&ut,O<(Z&=15)&&(L+=X[T++]<<O,(O+=8)<Z&&(L+=X[T++]<<O,O+=8)),(R+=L&(1<<Z)-1)>D){y.msg="invalid distance too far back",f.mode=30;break t}if(L>>>=Z,O-=Z,R>(Z=S-E)){if((Z=R-Z)>k&&f.sane){y.msg="invalid distance too far back",f.mode=30;break t}if(q=0,tt=Q,N===0){if(q+=H-Z,Z<I){I-=Z;do j[S++]=Q[q++];while(--Z);q=S-R,tt=j}}else if(N<Z){if(q+=H+N-Z,(Z-=N)<I){I-=Z;do j[S++]=Q[q++];while(--Z);if(q=0,N<I){I-=Z=N;do j[S++]=Q[q++];while(--Z);q=S-R,tt=j}}}else if(q+=N-Z,Z<I){I-=Z;do j[S++]=Q[q++];while(--Z);q=S-R,tt=j}for(;I>2;)j[S++]=tt[q++],j[S++]=tt[q++],j[S++]=tt[q++],I-=3;I&&(j[S++]=tt[q++],I>1&&(j[S++]=tt[q++]))}else{q=S-R;do j[S++]=j[q++],j[S++]=j[q++],j[S++]=j[q++],I-=3;while(I>2);I&&(j[S++]=j[q++],I>1&&(j[S++]=j[q++]))}break}}break}}while(T<C&&S<W);T-=I=O>>3,L&=(1<<(O-=I<<3))-1,y.next_in=T,y.next_out=S,y.avail_in=T<C?C-T+5:5-(T-C),y.avail_out=S<W?W-S+257:257-(S-W),f.hold=L,f.bits=O}},"./node_modules/pako/lib/zlib/inflate.js":(A,y,w)=>{var f=w("./node_modules/pako/lib/utils/common.js"),T=w("./node_modules/pako/lib/zlib/adler32.js"),C=w("./node_modules/pako/lib/zlib/crc32.js"),S=w("./node_modules/pako/lib/zlib/inffast.js"),E=w("./node_modules/pako/lib/zlib/inftrees.js"),W=0,D=-2,H=1,k=12,N=30,Q=852,L=592;function O(X){return(X>>>24&255)+(X>>>8&65280)+((65280&X)<<8)+((255&X)<<24)}function Y(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new f.Buf16(320),this.work=new f.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function ot(X){var j;return X&&X.state?(j=X.state,X.total_in=X.total_out=j.total=0,X.msg="",j.wrap&&(X.adler=1&j.wrap),j.mode=H,j.last=0,j.havedict=0,j.dmax=32768,j.head=null,j.hold=0,j.bits=0,j.lencode=j.lendyn=new f.Buf32(Q),j.distcode=j.distdyn=new f.Buf32(L),j.sane=1,j.back=-1,W):D}function nt(X){var j;return X&&X.state?((j=X.state).wsize=0,j.whave=0,j.wnext=0,ot(X)):D}function et(X,j){var F,St;return X&&X.state?(St=X.state,j<0?(F=0,j=-j):(F=1+(j>>4),j<48&&(j&=15)),j&&(j<8||j>15)?D:(St.window!==null&&St.wbits!==j&&(St.window=null),St.wrap=F,St.wbits=j,nt(X))):D}function ut(X,j){var F,St;return X?(St=new Y,X.state=St,St.window=null,(F=et(X,j))!==W&&(X.state=null),F):D}var Z,I,R=!0;function q(X){if(R){var j;for(Z=new f.Buf32(512),I=new f.Buf32(32),j=0;j<144;)X.lens[j++]=8;for(;j<256;)X.lens[j++]=9;for(;j<280;)X.lens[j++]=7;for(;j<288;)X.lens[j++]=8;for(E(1,X.lens,0,288,Z,0,X.work,{bits:9}),j=0;j<32;)X.lens[j++]=5;E(2,X.lens,0,32,I,0,X.work,{bits:5}),R=!1}X.lencode=Z,X.lenbits=9,X.distcode=I,X.distbits=5}function tt(X,j,F,St){var Dt,ht=X.state;return ht.window===null&&(ht.wsize=1<<ht.wbits,ht.wnext=0,ht.whave=0,ht.window=new f.Buf8(ht.wsize)),St>=ht.wsize?(f.arraySet(ht.window,j,F-ht.wsize,ht.wsize,0),ht.wnext=0,ht.whave=ht.wsize):((Dt=ht.wsize-ht.wnext)>St&&(Dt=St),f.arraySet(ht.window,j,F-St,Dt,ht.wnext),(St-=Dt)?(f.arraySet(ht.window,j,F-St,St,0),ht.wnext=St,ht.whave=ht.wsize):(ht.wnext+=Dt,ht.wnext===ht.wsize&&(ht.wnext=0),ht.whave<ht.wsize&&(ht.whave+=Dt))),0}y.inflateReset=nt,y.inflateReset2=et,y.inflateResetKeep=ot,y.inflateInit=function(X){return ut(X,15)},y.inflateInit2=ut,y.inflate=function(X,j){var F,St,Dt,ht,Mt,Ct,Yt,xt,yt,de,Kt,Ht,Ie,it,x,st,_t,V,Ft,Lt,Et,pt,mt,bt,Bt=0,vt=new f.Buf8(4),Ut=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!X||!X.state||!X.output||!X.input&&X.avail_in!==0)return D;(F=X.state).mode===k&&(F.mode=13),Mt=X.next_out,Dt=X.output,Yt=X.avail_out,ht=X.next_in,St=X.input,Ct=X.avail_in,xt=F.hold,yt=F.bits,de=Ct,Kt=Yt,pt=W;t:for(;;)switch(F.mode){case H:if(F.wrap===0){F.mode=13;break}for(;yt<16;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(2&F.wrap&&xt===35615){F.check=0,vt[0]=255&xt,vt[1]=xt>>>8&255,F.check=C(F.check,vt,2,0),xt=0,yt=0,F.mode=2;break}if(F.flags=0,F.head&&(F.head.done=!1),!(1&F.wrap)||(((255&xt)<<8)+(xt>>8))%31){X.msg="incorrect header check",F.mode=N;break}if((15&xt)!=8){X.msg="unknown compression method",F.mode=N;break}if(yt-=4,Et=8+(15&(xt>>>=4)),F.wbits===0)F.wbits=Et;else if(Et>F.wbits){X.msg="invalid window size",F.mode=N;break}F.dmax=1<<Et,X.adler=F.check=1,F.mode=512&xt?10:k,xt=0,yt=0;break;case 2:for(;yt<16;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(F.flags=xt,(255&F.flags)!=8){X.msg="unknown compression method",F.mode=N;break}if(57344&F.flags){X.msg="unknown header flags set",F.mode=N;break}F.head&&(F.head.text=xt>>8&1),512&F.flags&&(vt[0]=255&xt,vt[1]=xt>>>8&255,F.check=C(F.check,vt,2,0)),xt=0,yt=0,F.mode=3;case 3:for(;yt<32;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}F.head&&(F.head.time=xt),512&F.flags&&(vt[0]=255&xt,vt[1]=xt>>>8&255,vt[2]=xt>>>16&255,vt[3]=xt>>>24&255,F.check=C(F.check,vt,4,0)),xt=0,yt=0,F.mode=4;case 4:for(;yt<16;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}F.head&&(F.head.xflags=255&xt,F.head.os=xt>>8),512&F.flags&&(vt[0]=255&xt,vt[1]=xt>>>8&255,F.check=C(F.check,vt,2,0)),xt=0,yt=0,F.mode=5;case 5:if(1024&F.flags){for(;yt<16;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}F.length=xt,F.head&&(F.head.extra_len=xt),512&F.flags&&(vt[0]=255&xt,vt[1]=xt>>>8&255,F.check=C(F.check,vt,2,0)),xt=0,yt=0}else F.head&&(F.head.extra=null);F.mode=6;case 6:if(1024&F.flags&&((Ht=F.length)>Ct&&(Ht=Ct),Ht&&(F.head&&(Et=F.head.extra_len-F.length,F.head.extra||(F.head.extra=new Array(F.head.extra_len)),f.arraySet(F.head.extra,St,ht,Ht,Et)),512&F.flags&&(F.check=C(F.check,St,Ht,ht)),Ct-=Ht,ht+=Ht,F.length-=Ht),F.length))break t;F.length=0,F.mode=7;case 7:if(2048&F.flags){if(Ct===0)break t;Ht=0;do Et=St[ht+Ht++],F.head&&Et&&F.length<65536&&(F.head.name+=String.fromCharCode(Et));while(Et&&Ht<Ct);if(512&F.flags&&(F.check=C(F.check,St,Ht,ht)),Ct-=Ht,ht+=Ht,Et)break t}else F.head&&(F.head.name=null);F.length=0,F.mode=8;case 8:if(4096&F.flags){if(Ct===0)break t;Ht=0;do Et=St[ht+Ht++],F.head&&Et&&F.length<65536&&(F.head.comment+=String.fromCharCode(Et));while(Et&&Ht<Ct);if(512&F.flags&&(F.check=C(F.check,St,Ht,ht)),Ct-=Ht,ht+=Ht,Et)break t}else F.head&&(F.head.comment=null);F.mode=9;case 9:if(512&F.flags){for(;yt<16;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(xt!==(65535&F.check)){X.msg="header crc mismatch",F.mode=N;break}xt=0,yt=0}F.head&&(F.head.hcrc=F.flags>>9&1,F.head.done=!0),X.adler=F.check=0,F.mode=k;break;case 10:for(;yt<32;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}X.adler=F.check=O(xt),xt=0,yt=0,F.mode=11;case 11:if(F.havedict===0)return X.next_out=Mt,X.avail_out=Yt,X.next_in=ht,X.avail_in=Ct,F.hold=xt,F.bits=yt,2;X.adler=F.check=1,F.mode=k;case k:if(j===5||j===6)break t;case 13:if(F.last){xt>>>=7&yt,yt-=7&yt,F.mode=27;break}for(;yt<3;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}switch(F.last=1&xt,yt-=1,3&(xt>>>=1)){case 0:F.mode=14;break;case 1:if(q(F),F.mode=20,j===6){xt>>>=2,yt-=2;break t}break;case 2:F.mode=17;break;case 3:X.msg="invalid block type",F.mode=N}xt>>>=2,yt-=2;break;case 14:for(xt>>>=7&yt,yt-=7&yt;yt<32;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if((65535&xt)!=(xt>>>16^65535)){X.msg="invalid stored block lengths",F.mode=N;break}if(F.length=65535&xt,xt=0,yt=0,F.mode=15,j===6)break t;case 15:F.mode=16;case 16:if(Ht=F.length){if(Ht>Ct&&(Ht=Ct),Ht>Yt&&(Ht=Yt),Ht===0)break t;f.arraySet(Dt,St,ht,Ht,Mt),Ct-=Ht,ht+=Ht,Yt-=Ht,Mt+=Ht,F.length-=Ht;break}F.mode=k;break;case 17:for(;yt<14;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(F.nlen=257+(31&xt),xt>>>=5,yt-=5,F.ndist=1+(31&xt),xt>>>=5,yt-=5,F.ncode=4+(15&xt),xt>>>=4,yt-=4,F.nlen>286||F.ndist>30){X.msg="too many length or distance symbols",F.mode=N;break}F.have=0,F.mode=18;case 18:for(;F.have<F.ncode;){for(;yt<3;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}F.lens[Ut[F.have++]]=7&xt,xt>>>=3,yt-=3}for(;F.have<19;)F.lens[Ut[F.have++]]=0;if(F.lencode=F.lendyn,F.lenbits=7,mt={bits:F.lenbits},pt=E(0,F.lens,0,19,F.lencode,0,F.work,mt),F.lenbits=mt.bits,pt){X.msg="invalid code lengths set",F.mode=N;break}F.have=0,F.mode=19;case 19:for(;F.have<F.nlen+F.ndist;){for(;st=(Bt=F.lencode[xt&(1<<F.lenbits)-1])>>>16&255,_t=65535&Bt,!((x=Bt>>>24)<=yt);){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(_t<16)xt>>>=x,yt-=x,F.lens[F.have++]=_t;else{if(_t===16){for(bt=x+2;yt<bt;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(xt>>>=x,yt-=x,F.have===0){X.msg="invalid bit length repeat",F.mode=N;break}Et=F.lens[F.have-1],Ht=3+(3&xt),xt>>>=2,yt-=2}else if(_t===17){for(bt=x+3;yt<bt;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}yt-=x,Et=0,Ht=3+(7&(xt>>>=x)),xt>>>=3,yt-=3}else{for(bt=x+7;yt<bt;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}yt-=x,Et=0,Ht=11+(127&(xt>>>=x)),xt>>>=7,yt-=7}if(F.have+Ht>F.nlen+F.ndist){X.msg="invalid bit length repeat",F.mode=N;break}for(;Ht--;)F.lens[F.have++]=Et}}if(F.mode===N)break;if(F.lens[256]===0){X.msg="invalid code -- missing end-of-block",F.mode=N;break}if(F.lenbits=9,mt={bits:F.lenbits},pt=E(1,F.lens,0,F.nlen,F.lencode,0,F.work,mt),F.lenbits=mt.bits,pt){X.msg="invalid literal/lengths set",F.mode=N;break}if(F.distbits=6,F.distcode=F.distdyn,mt={bits:F.distbits},pt=E(2,F.lens,F.nlen,F.ndist,F.distcode,0,F.work,mt),F.distbits=mt.bits,pt){X.msg="invalid distances set",F.mode=N;break}if(F.mode=20,j===6)break t;case 20:F.mode=21;case 21:if(Ct>=6&&Yt>=258){X.next_out=Mt,X.avail_out=Yt,X.next_in=ht,X.avail_in=Ct,F.hold=xt,F.bits=yt,S(X,Kt),Mt=X.next_out,Dt=X.output,Yt=X.avail_out,ht=X.next_in,St=X.input,Ct=X.avail_in,xt=F.hold,yt=F.bits,F.mode===k&&(F.back=-1);break}for(F.back=0;st=(Bt=F.lencode[xt&(1<<F.lenbits)-1])>>>16&255,_t=65535&Bt,!((x=Bt>>>24)<=yt);){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(st&&!(240&st)){for(V=x,Ft=st,Lt=_t;st=(Bt=F.lencode[Lt+((xt&(1<<V+Ft)-1)>>V)])>>>16&255,_t=65535&Bt,!(V+(x=Bt>>>24)<=yt);){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}xt>>>=V,yt-=V,F.back+=V}if(xt>>>=x,yt-=x,F.back+=x,F.length=_t,st===0){F.mode=26;break}if(32&st){F.back=-1,F.mode=k;break}if(64&st){X.msg="invalid literal/length code",F.mode=N;break}F.extra=15&st,F.mode=22;case 22:if(F.extra){for(bt=F.extra;yt<bt;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}F.length+=xt&(1<<F.extra)-1,xt>>>=F.extra,yt-=F.extra,F.back+=F.extra}F.was=F.length,F.mode=23;case 23:for(;st=(Bt=F.distcode[xt&(1<<F.distbits)-1])>>>16&255,_t=65535&Bt,!((x=Bt>>>24)<=yt);){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(!(240&st)){for(V=x,Ft=st,Lt=_t;st=(Bt=F.distcode[Lt+((xt&(1<<V+Ft)-1)>>V)])>>>16&255,_t=65535&Bt,!(V+(x=Bt>>>24)<=yt);){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}xt>>>=V,yt-=V,F.back+=V}if(xt>>>=x,yt-=x,F.back+=x,64&st){X.msg="invalid distance code",F.mode=N;break}F.offset=_t,F.extra=15&st,F.mode=24;case 24:if(F.extra){for(bt=F.extra;yt<bt;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}F.offset+=xt&(1<<F.extra)-1,xt>>>=F.extra,yt-=F.extra,F.back+=F.extra}if(F.offset>F.dmax){X.msg="invalid distance too far back",F.mode=N;break}F.mode=25;case 25:if(Yt===0)break t;if(Ht=Kt-Yt,F.offset>Ht){if((Ht=F.offset-Ht)>F.whave&&F.sane){X.msg="invalid distance too far back",F.mode=N;break}Ht>F.wnext?(Ht-=F.wnext,Ie=F.wsize-Ht):Ie=F.wnext-Ht,Ht>F.length&&(Ht=F.length),it=F.window}else it=Dt,Ie=Mt-F.offset,Ht=F.length;Ht>Yt&&(Ht=Yt),Yt-=Ht,F.length-=Ht;do Dt[Mt++]=it[Ie++];while(--Ht);F.length===0&&(F.mode=21);break;case 26:if(Yt===0)break t;Dt[Mt++]=F.length,Yt--,F.mode=21;break;case 27:if(F.wrap){for(;yt<32;){if(Ct===0)break t;Ct--,xt|=St[ht++]<<yt,yt+=8}if(Kt-=Yt,X.total_out+=Kt,F.total+=Kt,Kt&&(X.adler=F.check=F.flags?C(F.check,Dt,Kt,Mt-Kt):T(F.check,Dt,Kt,Mt-Kt)),Kt=Yt,(F.flags?xt:O(xt))!==F.check){X.msg="incorrect data check",F.mode=N;break}xt=0,yt=0}F.mode=28;case 28:if(F.wrap&&F.flags){for(;yt<32;){if(Ct===0)break t;Ct--,xt+=St[ht++]<<yt,yt+=8}if(xt!==(4294967295&F.total)){X.msg="incorrect length check",F.mode=N;break}xt=0,yt=0}F.mode=29;case 29:pt=1;break t;case N:pt=-3;break t;case 31:return-4;default:return D}return X.next_out=Mt,X.avail_out=Yt,X.next_in=ht,X.avail_in=Ct,F.hold=xt,F.bits=yt,(F.wsize||Kt!==X.avail_out&&F.mode<N&&(F.mode<27||j!==4))&&tt(X,X.output,X.next_out,Kt-X.avail_out)?(F.mode=31,-4):(de-=X.avail_in,Kt-=X.avail_out,X.total_in+=de,X.total_out+=Kt,F.total+=Kt,F.wrap&&Kt&&(X.adler=F.check=F.flags?C(F.check,Dt,Kt,X.next_out-Kt):T(F.check,Dt,Kt,X.next_out-Kt)),X.data_type=F.bits+(F.last?64:0)+(F.mode===k?128:0)+(F.mode===20||F.mode===15?256:0),(de===0&&Kt===0||j===4)&&pt===W&&(pt=-5),pt)},y.inflateEnd=function(X){if(!X||!X.state)return D;var j=X.state;return j.window&&(j.window=null),X.state=null,W},y.inflateGetHeader=function(X,j){var F;return X&&X.state&&2&(F=X.state).wrap?(F.head=j,j.done=!1,W):D},y.inflateSetDictionary=function(X,j){var F,St=j.length;return X&&X.state?(F=X.state).wrap!==0&&F.mode!==11?D:F.mode===11&&T(1,j,St,0)!==F.check?-3:tt(X,j,St,St)?(F.mode=31,-4):(F.havedict=1,W):D},y.inflateInfo="pako inflate (from Nodeca project)"},"./node_modules/pako/lib/zlib/inftrees.js":(A,y,w)=>{var f=w("./node_modules/pako/lib/utils/common.js"),T=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],C=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],S=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],E=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];A.exports=function(W,D,H,k,N,Q,L,O){var Y,ot,nt,et,ut,Z,I,R,q,tt=O.bits,X=0,j=0,F=0,St=0,Dt=0,ht=0,Mt=0,Ct=0,Yt=0,xt=0,yt=null,de=0,Kt=new f.Buf16(16),Ht=new f.Buf16(16),Ie=null,it=0;for(X=0;X<=15;X++)Kt[X]=0;for(j=0;j<k;j++)Kt[D[H+j]]++;for(Dt=tt,St=15;St>=1&&Kt[St]===0;St--);if(Dt>St&&(Dt=St),St===0)return N[Q++]=20971520,N[Q++]=20971520,O.bits=1,0;for(F=1;F<St&&Kt[F]===0;F++);for(Dt<F&&(Dt=F),Ct=1,X=1;X<=15;X++)if(Ct<<=1,(Ct-=Kt[X])<0)return-1;if(Ct>0&&(W===0||St!==1))return-1;for(Ht[1]=0,X=1;X<15;X++)Ht[X+1]=Ht[X]+Kt[X];for(j=0;j<k;j++)D[H+j]!==0&&(L[Ht[D[H+j]]++]=j);if(W===0?(yt=Ie=L,Z=19):W===1?(yt=T,de-=257,Ie=C,it-=257,Z=256):(yt=S,Ie=E,Z=-1),xt=0,j=0,X=F,ut=Q,ht=Dt,Mt=0,nt=-1,et=(Yt=1<<Dt)-1,W===1&&Yt>852||W===2&&Yt>592)return 1;for(;;){I=X-Mt,L[j]<Z?(R=0,q=L[j]):L[j]>Z?(R=Ie[it+L[j]],q=yt[de+L[j]]):(R=96,q=0),Y=1<<X-Mt,F=ot=1<<ht;do N[ut+(xt>>Mt)+(ot-=Y)]=I<<24|R<<16|q|0;while(ot!==0);for(Y=1<<X-1;xt&Y;)Y>>=1;if(Y!==0?(xt&=Y-1,xt+=Y):xt=0,j++,--Kt[X]==0){if(X===St)break;X=D[H+L[j]]}if(X>Dt&&(xt&et)!==nt){for(Mt===0&&(Mt=Dt),ut+=F,Ct=1<<(ht=X-Mt);ht+Mt<St&&!((Ct-=Kt[ht+Mt])<=0);)ht++,Ct<<=1;if(Yt+=1<<ht,W===1&&Yt>852||W===2&&Yt>592)return 1;N[nt=xt&et]=Dt<<24|ht<<16|ut-Q|0}}return xt!==0&&(N[ut+xt]=X-Mt<<24|4194304|0),O.bits=Dt,0}},"./node_modules/pako/lib/zlib/messages.js":A=>{A.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},"./node_modules/pako/lib/zlib/trees.js":(A,y,w)=>{var f=w("./node_modules/pako/lib/utils/common.js");function T(it){for(var x=it.length;--x>=0;)it[x]=0}var C=256,S=286,E=30,W=15,D=16,H=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],k=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],N=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Q=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],L=new Array(576);T(L);var O=new Array(60);T(O);var Y=new Array(512);T(Y);var ot=new Array(256);T(ot);var nt=new Array(29);T(nt);var et,ut,Z,I=new Array(E);function R(it,x,st,_t,V){this.static_tree=it,this.extra_bits=x,this.extra_base=st,this.elems=_t,this.max_length=V,this.has_stree=it&&it.length}function q(it,x){this.dyn_tree=it,this.max_code=0,this.stat_desc=x}function tt(it){return it<256?Y[it]:Y[256+(it>>>7)]}function X(it,x){it.pending_buf[it.pending++]=255&x,it.pending_buf[it.pending++]=x>>>8&255}function j(it,x,st){it.bi_valid>D-st?(it.bi_buf|=x<<it.bi_valid&65535,X(it,it.bi_buf),it.bi_buf=x>>D-it.bi_valid,it.bi_valid+=st-D):(it.bi_buf|=x<<it.bi_valid&65535,it.bi_valid+=st)}function F(it,x,st){j(it,st[2*x],st[2*x+1])}function St(it,x){var st=0;do st|=1&it,it>>>=1,st<<=1;while(--x>0);return st>>>1}function Dt(it,x,st){var _t,V,Ft=new Array(W+1),Lt=0;for(_t=1;_t<=W;_t++)Ft[_t]=Lt=Lt+st[_t-1]<<1;for(V=0;V<=x;V++){var Et=it[2*V+1];Et!==0&&(it[2*V]=St(Ft[Et]++,Et))}}function ht(it){var x;for(x=0;x<S;x++)it.dyn_ltree[2*x]=0;for(x=0;x<E;x++)it.dyn_dtree[2*x]=0;for(x=0;x<19;x++)it.bl_tree[2*x]=0;it.dyn_ltree[512]=1,it.opt_len=it.static_len=0,it.last_lit=it.matches=0}function Mt(it){it.bi_valid>8?X(it,it.bi_buf):it.bi_valid>0&&(it.pending_buf[it.pending++]=it.bi_buf),it.bi_buf=0,it.bi_valid=0}function Ct(it,x,st,_t){var V=2*x,Ft=2*st;return it[V]<it[Ft]||it[V]===it[Ft]&&_t[x]<=_t[st]}function Yt(it,x,st){for(var _t=it.heap[st],V=st<<1;V<=it.heap_len&&(V<it.heap_len&&Ct(x,it.heap[V+1],it.heap[V],it.depth)&&V++,!Ct(x,_t,it.heap[V],it.depth));)it.heap[st]=it.heap[V],st=V,V<<=1;it.heap[st]=_t}function xt(it,x,st){var _t,V,Ft,Lt,Et=0;if(it.last_lit!==0)do _t=it.pending_buf[it.d_buf+2*Et]<<8|it.pending_buf[it.d_buf+2*Et+1],V=it.pending_buf[it.l_buf+Et],Et++,_t===0?F(it,V,x):(F(it,(Ft=ot[V])+C+1,x),(Lt=H[Ft])!==0&&j(it,V-=nt[Ft],Lt),F(it,Ft=tt(--_t),st),(Lt=k[Ft])!==0&&j(it,_t-=I[Ft],Lt));while(Et<it.last_lit);F(it,256,x)}function yt(it,x){var st,_t,V,Ft=x.dyn_tree,Lt=x.stat_desc.static_tree,Et=x.stat_desc.has_stree,pt=x.stat_desc.elems,mt=-1;for(it.heap_len=0,it.heap_max=573,st=0;st<pt;st++)Ft[2*st]!==0?(it.heap[++it.heap_len]=mt=st,it.depth[st]=0):Ft[2*st+1]=0;for(;it.heap_len<2;)Ft[2*(V=it.heap[++it.heap_len]=mt<2?++mt:0)]=1,it.depth[V]=0,it.opt_len--,Et&&(it.static_len-=Lt[2*V+1]);for(x.max_code=mt,st=it.heap_len>>1;st>=1;st--)Yt(it,Ft,st);V=pt;do st=it.heap[1],it.heap[1]=it.heap[it.heap_len--],Yt(it,Ft,1),_t=it.heap[1],it.heap[--it.heap_max]=st,it.heap[--it.heap_max]=_t,Ft[2*V]=Ft[2*st]+Ft[2*_t],it.depth[V]=(it.depth[st]>=it.depth[_t]?it.depth[st]:it.depth[_t])+1,Ft[2*st+1]=Ft[2*_t+1]=V,it.heap[1]=V++,Yt(it,Ft,1);while(it.heap_len>=2);it.heap[--it.heap_max]=it.heap[1],function(bt,Bt){var vt,Ut,Gt,Nt,Jt,he,se=Bt.dyn_tree,Xt=Bt.max_code,Se=Bt.stat_desc.static_tree,Me=Bt.stat_desc.has_stree,oi=Bt.stat_desc.extra_bits,si=Bt.stat_desc.extra_base,Ri=Bt.stat_desc.max_length,ai=0;for(Nt=0;Nt<=W;Nt++)bt.bl_count[Nt]=0;for(se[2*bt.heap[bt.heap_max]+1]=0,vt=bt.heap_max+1;vt<573;vt++)(Nt=se[2*se[2*(Ut=bt.heap[vt])+1]+1]+1)>Ri&&(Nt=Ri,ai++),se[2*Ut+1]=Nt,Ut>Xt||(bt.bl_count[Nt]++,Jt=0,Ut>=si&&(Jt=oi[Ut-si]),he=se[2*Ut],bt.opt_len+=he*(Nt+Jt),Me&&(bt.static_len+=he*(Se[2*Ut+1]+Jt)));if(ai!==0){do{for(Nt=Ri-1;bt.bl_count[Nt]===0;)Nt--;bt.bl_count[Nt]--,bt.bl_count[Nt+1]+=2,bt.bl_count[Ri]--,ai-=2}while(ai>0);for(Nt=Ri;Nt!==0;Nt--)for(Ut=bt.bl_count[Nt];Ut!==0;)(Gt=bt.heap[--vt])>Xt||(se[2*Gt+1]!==Nt&&(bt.opt_len+=(Nt-se[2*Gt+1])*se[2*Gt],se[2*Gt+1]=Nt),Ut--)}}(it,x),Dt(Ft,mt,it.bl_count)}function de(it,x,st){var _t,V,Ft=-1,Lt=x[1],Et=0,pt=7,mt=4;for(Lt===0&&(pt=138,mt=3),x[2*(st+1)+1]=65535,_t=0;_t<=st;_t++)V=Lt,Lt=x[2*(_t+1)+1],++Et<pt&&V===Lt||(Et<mt?it.bl_tree[2*V]+=Et:V!==0?(V!==Ft&&it.bl_tree[2*V]++,it.bl_tree[32]++):Et<=10?it.bl_tree[34]++:it.bl_tree[36]++,Et=0,Ft=V,Lt===0?(pt=138,mt=3):V===Lt?(pt=6,mt=3):(pt=7,mt=4))}function Kt(it,x,st){var _t,V,Ft=-1,Lt=x[1],Et=0,pt=7,mt=4;for(Lt===0&&(pt=138,mt=3),_t=0;_t<=st;_t++)if(V=Lt,Lt=x[2*(_t+1)+1],!(++Et<pt&&V===Lt)){if(Et<mt)do F(it,V,it.bl_tree);while(--Et!=0);else V!==0?(V!==Ft&&(F(it,V,it.bl_tree),Et--),F(it,16,it.bl_tree),j(it,Et-3,2)):Et<=10?(F(it,17,it.bl_tree),j(it,Et-3,3)):(F(it,18,it.bl_tree),j(it,Et-11,7));Et=0,Ft=V,Lt===0?(pt=138,mt=3):V===Lt?(pt=6,mt=3):(pt=7,mt=4)}}T(I);var Ht=!1;function Ie(it,x,st,_t){j(it,0+(_t?1:0),3),function(V,Ft,Lt,Et){Mt(V),X(V,Lt),X(V,~Lt),f.arraySet(V.pending_buf,V.window,Ft,Lt,V.pending),V.pending+=Lt}(it,x,st)}y._tr_init=function(it){Ht||(function(){var x,st,_t,V,Ft,Lt=new Array(W+1);for(_t=0,V=0;V<28;V++)for(nt[V]=_t,x=0;x<1<<H[V];x++)ot[_t++]=V;for(ot[_t-1]=V,Ft=0,V=0;V<16;V++)for(I[V]=Ft,x=0;x<1<<k[V];x++)Y[Ft++]=V;for(Ft>>=7;V<E;V++)for(I[V]=Ft<<7,x=0;x<1<<k[V]-7;x++)Y[256+Ft++]=V;for(st=0;st<=W;st++)Lt[st]=0;for(x=0;x<=143;)L[2*x+1]=8,x++,Lt[8]++;for(;x<=255;)L[2*x+1]=9,x++,Lt[9]++;for(;x<=279;)L[2*x+1]=7,x++,Lt[7]++;for(;x<=287;)L[2*x+1]=8,x++,Lt[8]++;for(Dt(L,287,Lt),x=0;x<E;x++)O[2*x+1]=5,O[2*x]=St(x,5);et=new R(L,H,257,S,W),ut=new R(O,k,0,E,W),Z=new R(new Array(0),N,0,19,7)}(),Ht=!0),it.l_desc=new q(it.dyn_ltree,et),it.d_desc=new q(it.dyn_dtree,ut),it.bl_desc=new q(it.bl_tree,Z),it.bi_buf=0,it.bi_valid=0,ht(it)},y._tr_stored_block=Ie,y._tr_flush_block=function(it,x,st,_t){var V,Ft,Lt=0;it.level>0?(it.strm.data_type===2&&(it.strm.data_type=function(Et){var pt,mt=4093624447;for(pt=0;pt<=31;pt++,mt>>>=1)if(1&mt&&Et.dyn_ltree[2*pt]!==0)return 0;if(Et.dyn_ltree[18]!==0||Et.dyn_ltree[20]!==0||Et.dyn_ltree[26]!==0)return 1;for(pt=32;pt<C;pt++)if(Et.dyn_ltree[2*pt]!==0)return 1;return 0}(it)),yt(it,it.l_desc),yt(it,it.d_desc),Lt=function(Et){var pt;for(de(Et,Et.dyn_ltree,Et.l_desc.max_code),de(Et,Et.dyn_dtree,Et.d_desc.max_code),yt(Et,Et.bl_desc),pt=18;pt>=3&&Et.bl_tree[2*Q[pt]+1]===0;pt--);return Et.opt_len+=3*(pt+1)+5+5+4,pt}(it),V=it.opt_len+3+7>>>3,(Ft=it.static_len+3+7>>>3)<=V&&(V=Ft)):V=Ft=st+5,st+4<=V&&x!==-1?Ie(it,x,st,_t):it.strategy===4||Ft===V?(j(it,2+(_t?1:0),3),xt(it,L,O)):(j(it,4+(_t?1:0),3),function(Et,pt,mt,bt){var Bt;for(j(Et,pt-257,5),j(Et,mt-1,5),j(Et,bt-4,4),Bt=0;Bt<bt;Bt++)j(Et,Et.bl_tree[2*Q[Bt]+1],3);Kt(Et,Et.dyn_ltree,pt-1),Kt(Et,Et.dyn_dtree,mt-1)}(it,it.l_desc.max_code+1,it.d_desc.max_code+1,Lt+1),xt(it,it.dyn_ltree,it.dyn_dtree)),ht(it),_t&&Mt(it)},y._tr_tally=function(it,x,st){return it.pending_buf[it.d_buf+2*it.last_lit]=x>>>8&255,it.pending_buf[it.d_buf+2*it.last_lit+1]=255&x,it.pending_buf[it.l_buf+it.last_lit]=255&st,it.last_lit++,x===0?it.dyn_ltree[2*st]++:(it.matches++,x--,it.dyn_ltree[2*(ot[st]+C+1)]++,it.dyn_dtree[2*tt(x)]++),it.last_lit===it.lit_bufsize-1},y._tr_align=function(it){j(it,2,3),F(it,256,L),function(x){x.bi_valid===16?(X(x,x.bi_buf),x.bi_buf=0,x.bi_valid=0):x.bi_valid>=8&&(x.pending_buf[x.pending++]=255&x.bi_buf,x.bi_buf>>=8,x.bi_valid-=8)}(it)}},"./node_modules/pako/lib/zlib/zstream.js":A=>{A.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},"./src/parser/tiled-parser.ts":(A,y,w)=>{w.r(y),w.d(y,{TiledMap:()=>x,TiledParser:()=>Lt,TiledTemplate:()=>it,TiledText:()=>j,TiledTile:()=>Yt,TiledTileLayer:()=>I,TiledTileLayerInfinite:()=>Z,TiledTileset:()=>Ie,TiledTilesetFile:()=>Kt,isCSV:()=>q,isInfiniteLayer:()=>st,isTiledTilesetCollectionOfImages:()=>de,isTiledTilesetEmbedded:()=>_t,isTiledTilesetExternal:()=>V,isTiledTilesetSingleImage:()=>yt,needsDecoding:()=>R});var f=w("./node_modules/zod/lib/index.mjs");const T=f.z.object({name:f.z.string(),type:f.z.literal("int"),value:f.z.number().int()}),C=f.z.object({name:f.z.string(),type:f.z.literal("bool"),value:f.z.boolean()}),S=f.z.object({name:f.z.string(),type:f.z.literal("float"),value:f.z.number()}),E=f.z.object({name:f.z.string(),type:f.z.literal("string"),value:f.z.string()}),W=f.z.object({name:f.z.string(),type:f.z.literal("file"),value:f.z.string()}),D=f.z.object({name:f.z.string(),type:f.z.literal("color"),value:f.z.string()}),H=f.z.object({name:f.z.string(),type:f.z.literal("object"),value:f.z.number()}),k=f.z.discriminatedUnion("type",[T,C,S,E,W,D,H]),N=f.z.object({name:f.z.string(),type:f.z.literal("tilelayer"),class:f.z.string().optional(),height:f.z.number(),width:f.z.number(),x:f.z.number(),y:f.z.number(),id:f.z.number(),opacity:f.z.number(),properties:f.z.array(k).optional(),visible:f.z.boolean(),tintcolor:f.z.string().optional(),parallaxx:f.z.number().optional(),parallaxy:f.z.number().optional(),offsetx:f.z.number().optional(),offsety:f.z.number().optional()}),Q=N.extend({data:f.z.array(f.z.number()),encoding:f.z.literal("csv")}),L=N.extend({data:f.z.array(f.z.number()),encoding:f.z.literal("base64"),compression:f.z.literal("gzip")}),O=N.extend({data:f.z.array(f.z.number()),encoding:f.z.literal("base64"),compression:f.z.literal("zlib")}),Y=N.extend({data:f.z.array(f.z.number()),encoding:f.z.literal("base64"),compression:f.z.literal("zstandard")}),ot=N.extend({data:f.z.string(),encoding:f.z.literal("base64"),compression:f.z.string().optional()}),nt=f.z.object({x:f.z.number(),y:f.z.number(),width:f.z.number(),height:f.z.number(),data:f.z.string()}),et=f.z.object({x:f.z.number(),y:f.z.number(),width:f.z.number(),height:f.z.number(),data:f.z.array(f.z.number())}),ut=f.z.union([nt,et]),Z=N.extend({startx:f.z.number(),starty:f.z.number(),chunks:f.z.array(ut),encoding:f.z.string().optional(),compression:f.z.string().optional(),data:f.z.undefined()}),I=f.z.union([ot,Q,L,O,Y,Z]);function R(Et){return Et.encoding==="base64"}function q(Et){return Et.encoding==="csv"||Array.isArray(Et.data)}const tt=f.z.object({x:f.z.number(),y:f.z.number()}),X=f.z.array(tt),j=f.z.object({text:f.z.string(),color:f.z.string().optional(),fontfamily:f.z.string().optional(),pixelsize:f.z.number().optional(),wrap:f.z.boolean().optional(),halign:f.z.union([f.z.literal("left"),f.z.literal("center"),f.z.literal("right"),f.z.literal("justify")]).optional(),valign:f.z.union([f.z.literal("top"),f.z.literal("center"),f.z.literal("bottom")]).optional()}),F=f.z.object({id:f.z.number().optional(),name:f.z.string().optional(),type:f.z.string().optional(),x:f.z.number().optional(),y:f.z.number().optional(),rotation:f.z.number().optional(),height:f.z.number().optional(),width:f.z.number().optional(),visible:f.z.boolean().optional(),gid:f.z.number().optional(),text:j.optional(),point:f.z.boolean().optional(),ellipse:f.z.boolean().optional(),polyline:f.z.array(tt).optional(),polygon:X.optional(),template:f.z.string().optional(),properties:f.z.array(k).optional()}),St=f.z.object({duration:f.z.number(),tileid:f.z.number()}),Dt=f.z.object({name:f.z.string(),draworder:f.z.string(),type:f.z.literal("objectgroup"),class:f.z.string().optional(),x:f.z.number(),y:f.z.number(),id:f.z.number(),color:f.z.string().optional(),tintcolor:f.z.string().optional(),parallaxx:f.z.number().optional(),parallaxy:f.z.number().optional(),offsetx:f.z.number().optional(),offsety:f.z.number().optional(),opacity:f.z.number(),properties:f.z.array(k).optional(),visible:f.z.boolean(),objects:f.z.array(F)}),ht=f.z.object({name:f.z.string(),x:f.z.number(),y:f.z.number(),id:f.z.number(),type:f.z.literal("imagelayer"),class:f.z.string().optional(),image:f.z.string().optional(),opacity:f.z.number(),properties:f.z.array(k).optional(),visible:f.z.boolean(),tintcolor:f.z.string().optional(),repeatx:f.z.boolean().optional(),repeaty:f.z.boolean().optional(),parallaxx:f.z.number().optional(),parallaxy:f.z.number().optional(),offsetx:f.z.number().optional(),offsety:f.z.number().optional(),transparentcolor:f.z.string().optional()}),Mt=f.z.union([I,ht,Dt]),Ct=f.z.object({draworder:f.z.string(),id:f.z.number().optional(),name:f.z.string(),x:f.z.number(),y:f.z.number(),opacity:f.z.number(),tintcolor:f.z.string().optional(),type:f.z.literal("objectgroup"),visible:f.z.boolean(),objects:f.z.array(F),properties:f.z.array(k).optional()}),Yt=f.z.object({id:f.z.number(),type:f.z.string().optional(),animation:f.z.array(St).optional(),objectgroup:Ct.optional(),probability:f.z.number().optional(),properties:f.z.array(k).optional(),image:f.z.string().optional(),imageheight:f.z.number().optional(),imagewidth:f.z.number().optional()}),xt=f.z.object({name:f.z.string(),firstgid:f.z.number().optional(),class:f.z.string().optional(),objectalignment:f.z.union([f.z.literal("topleft"),f.z.literal("top"),f.z.literal("topright"),f.z.literal("left"),f.z.literal("center"),f.z.literal("right"),f.z.literal("bottomleft"),f.z.literal("bottom"),f.z.literal("bottomright")]).optional(),image:f.z.string().optional(),imagewidth:f.z.number().optional(),imageheight:f.z.number().optional(),columns:f.z.number(),tileheight:f.z.number(),tilewidth:f.z.number(),tilecount:f.z.number(),grid:f.z.object({height:f.z.number(),width:f.z.number(),orientation:f.z.union([f.z.literal("isometric"),f.z.literal("orthogonal")])}).optional(),tileoffset:tt.optional(),spacing:f.z.number(),margin:f.z.number(),tiles:f.z.array(Yt).optional(),properties:f.z.array(k).optional()});function yt(Et){return!!Et.image}function de(Et){return!Et.image}const Kt=xt.extend({tiledversion:f.z.string().optional(),type:f.z.literal("tileset"),version:f.z.string().optional()}),Ht=f.z.object({firstgid:f.z.number(),source:f.z.string()}),Ie=f.z.union([xt,Ht]),it=f.z.object({object:F.extend({id:f.z.number().optional()}),tileset:Ht.optional(),type:f.z.literal("template")}),x=f.z.object({type:f.z.string(),class:f.z.string().optional(),tiledversion:f.z.string(),version:f.z.string(),width:f.z.number(),height:f.z.number(),tilewidth:f.z.number(),tileheight:f.z.number(),compressionlevel:f.z.number().optional(),infinite:f.z.boolean(),nextlayerid:f.z.number(),nextobjectid:f.z.number(),parallaxoriginx:f.z.number().optional(),parallaxoriginy:f.z.number().optional(),hexsidelength:f.z.number().optional(),staggeraxis:f.z.literal("y").or(f.z.literal("x")).optional(),staggerindex:f.z.literal("odd").or(f.z.literal("even")).optional(),orientation:f.z.union([f.z.literal("isometric"),f.z.literal("orthogonal"),f.z.literal("staggered"),f.z.literal("hexagonal")]),renderorder:f.z.union([f.z.literal("right-down"),f.z.literal("right-up"),f.z.literal("left-down"),f.z.literal("left-up")]),backgroundcolor:f.z.string().optional(),layers:f.z.array(Mt),tilesets:f.z.array(Ie),properties:f.z.array(k).optional()});function st(Et){return!!Et.chunks}function _t(Et){return!Et.source}function V(Et){return!!Et.source}class Ft{constructor(pt,mt,bt,Bt){this.x=pt,this.y=mt,this.width=bt,this.height=Bt}combine(pt){const mt=this.x+this.width,bt=this.y+this.height,Bt=pt.x+pt.width,vt=pt.y+pt.height,Ut=Math.max(mt,Bt),Gt=Math.max(bt,vt);return new Ft(Math.min(this.x,pt.x),Math.min(this.y,pt.y),Ut-Math.min(this.x,pt.x),Gt-Math.min(this.y,pt.y))}}class Lt{constructor(){this._largestBounds=new Ft(0,0,0,0)}_coerceNumber(pt){return+pt}_coerceBoolean(pt){switch(pt){case"0":case"false":return!1;case"true":return!0;default:return!!pt}}_coerceType(pt,mt){return pt==="bool"?this._coerceBoolean(mt):pt==="int"||pt==="float"||pt==="object"?this._coerceNumber(mt):mt}_parsePropertiesNode(pt,mt){var bt;const Bt=[];if(pt)for(let vt of pt.children){const Ut=(bt=vt.getAttribute("type"))!==null&&bt!==void 0?bt:"string";let Gt=vt.getAttribute("value");Gt||(Gt=vt.innerHTML),Bt.push({name:vt.getAttribute("name"),type:Ut,value:this._coerceType(Ut,Gt)})}mt.properties=Bt}_parseAttributes(pt,mt){const bt=["width","height","columns","firstgid","spacing","margin","tilecount","tilewidth","tileheight","opacity","compressionlevel","nextlayerid","nextobjectid","parallaxoriginx","parallaxoriginy","parallaxx","parallaxy","hexsidelength","offsetx","offsety","id","gid","x","y","rotation","probability"],Bt=["infinite","visible","repeatx","repeaty"];for(let vt of pt.attributes)bt.indexOf(vt.name)>-1?mt[vt.name]=this._coerceNumber(vt.value):Bt.indexOf(vt.name)>-1?mt[vt.name]=this._coerceBoolean(vt.value):mt[vt.name]=vt.value}_parseToDocument(pt){if(typeof DOMParser<"u")return new DOMParser().parseFromString(pt,"application/xml");try{const{JSDOM:bt}=w("jsdom");return new bt(pt,{contentType:"application/xml",encoding:"utf-8"}).window.document}catch{}const mt=new Error("Could not find DOM parser");throw console.error(mt.message,mt),mt}parseObject(pt,mt=!0){var bt,Bt;const vt={type:"",x:0,y:0};pt.getAttribute("template")||(vt.visible=!0,vt.name="",vt.rotation=0,vt.height=0,vt.width=0),this._parseAttributes(pt,vt);const Ut=pt.querySelector("properties");Ut&&this._parsePropertiesNode(Ut,vt);const Gt=pt.querySelector("text");if(Gt){vt.text={text:Gt.textContent};const he=Gt.getAttribute("fontfamily");he&&(vt.text.fontfamily=he);const se=Gt.getAttribute("color");se&&(vt.text.color=se);const Xt=Gt.getAttribute("pixelsize");Xt&&(vt.text.pixelsize=this._coerceNumber(Xt));const Se=Gt.getAttribute("wrap");Se&&(vt.text.wrap=this._coerceBoolean(Se));const Me=Gt.getAttribute("valign");Me&&(vt.text.valign=Me);const oi=Gt.getAttribute("halign");oi&&(vt.text.halign=oi)}pt.querySelector("point")&&(vt.point=!0),pt.querySelector("ellipse")&&(vt.ellipse=!0);const Nt=pt.querySelector("polygon");if(Nt){const he=(bt=Nt.getAttribute("points"))===null||bt===void 0?void 0:bt.split(" ");vt.polygon=[],he&&he.forEach(se=>{const Xt=se.split(",");vt.polygon.push({x:+Xt[0],y:+Xt[1]})})}const Jt=pt.querySelector("polyline");if(Jt){const he=(Bt=Jt.getAttribute("points"))===null||Bt===void 0?void 0:Bt.split(" ");vt.polyline=[],he&&he.forEach(se=>{const Xt=se.split(",");vt.polyline.push({x:+Xt[0],y:+Xt[1]})})}if(mt)try{return F.parse(vt)}catch(he){throw console.error("Could not parse object",vt,he),he}return vt}parseTileset(pt,mt=!0){const bt={spacing:0,margin:0};if(this._parseAttributes(pt,bt),bt.source)try{return Ie.parse(bt)}catch(Bt){console.error("Could not parse external tileset",bt,Bt)}for(let Bt of pt.children)switch(Bt.tagName){case"properties":this._parsePropertiesNode(Bt,bt);break;case"tileoffset":{const vt={};this._parseAttributes(Bt,vt),bt.tileoffset=vt;break}case"grid":{const vt={};this._parseAttributes(Bt,vt),bt.grid=vt;break}case"image":bt.image=Bt.getAttribute("source"),bt.imagewidth=this._coerceNumber(Bt.getAttribute("width")),bt.imageheight=this._coerceNumber(Bt.getAttribute("height"));break;case"tile":{bt.tiles||(bt.tiles=[]);const vt={};this._parseAttributes(Bt,vt);for(let Ut of Bt.children)switch(Ut.tagName){case"image":vt.image=Ut.getAttribute("source"),vt.imagewidth=this._coerceNumber(Ut.getAttribute("width")),vt.imageheight=this._coerceNumber(Ut.getAttribute("height"));break;case"objectgroup":{const Gt={type:"objectgroup",name:"",visible:!0,x:0,y:0,opacity:1,objects:[]};this._parseAttributes(Ut,Gt),vt.objectgroup=Gt;for(let Nt of Ut.children){const Jt=this.parseObject(Nt,mt);Gt.objects.push(Jt)}break}case"animation":{const Gt=[];for(let Nt of Ut.children)Gt.push({duration:this._coerceNumber(Nt.getAttribute("duration")),tileid:this._coerceNumber(Nt.getAttribute("tileid"))});vt.animation=Gt;break}case"properties":this._parsePropertiesNode(Ut,vt)}if(mt)try{bt.tiles.push(Yt.parse(vt))}catch(Ut){throw console.error("Could not parse Tile",vt,Ut),Ut}else bt.tiles.push(vt);break}}if(mt)try{return Ie.parse(bt)}catch(Bt){throw console.error("Could not parse Tileset",bt,Bt),Bt}return bt}parseTileLayer(pt,mt,bt=!0){var Bt,vt,Ut,Gt;const Nt={type:"tilelayer",x:0,y:0,opacity:1,visible:!0};this._parseAttributes(pt,Nt);for(let Jt of pt.children)switch(Jt.tagName){case"properties":this._parsePropertiesNode(Jt,Nt);break;case"data":{const he=Jt.getAttribute("encoding");he&&(Nt.encoding=he);const se=Jt.getAttribute("compression");if(se&&(Nt.compression=se),mt){Nt.width=0,Nt.height=0,Nt.chunks=[];let Xt=new Ft(0,0,0,0);for(let Se of Jt.children)if(Se.tagName==="chunk"){const Me={};switch(this._parseAttributes(Se,Me),Nt.encoding){case"base64":Me.data=(Bt=Se.textContent)===null||Bt===void 0?void 0:Bt.trim();break;case"csv":Me.data=(vt=Se.textContent)===null||vt===void 0?void 0:vt.split(",").map(si=>+si)}const oi=new Ft(Me.x,Me.y,Me.width,Me.height);Xt=Xt.combine(oi),Nt.chunks.push(Me)}Nt.width=Xt.width,Nt.height=Xt.height,Nt.startx=Xt.x,Nt.starty=Xt.y,this._largestBounds=this._largestBounds.combine(new Ft(Nt.startx,Nt.starty,Nt.width,Nt.height))}else switch(Nt.encoding){case"base64":Nt.data=(Ut=Jt.textContent)===null||Ut===void 0?void 0:Ut.trim();break;case"csv":Nt.data=(Gt=Jt.textContent)===null||Gt===void 0?void 0:Gt.split(",").map(Xt=>+Xt)}}}if(bt)try{return Mt.parse(Nt)}catch(Jt){throw console.error("Could not parse tiled tile layer",Nt,Jt),Jt}return Nt}parseObjectGroup(pt,mt=!0){const bt={type:"objectgroup",draworder:"topdown",visible:!0,x:0,y:0,opacity:1,objects:[]};this._parseAttributes(pt,bt);for(let Bt of pt.children)switch(Bt.tagName){case"properties":this._parsePropertiesNode(Bt,bt);break;case"object":{const vt=this.parseObject(Bt,mt);bt.objects.push(vt);break}}if(mt)try{return Mt.parse(bt)}catch(Bt){throw console.error("Could not parse object group",bt,Bt),Bt}return bt}parseImageLayer(pt,mt=!0){const bt={type:"imagelayer",visible:!0,x:0,y:0,opacity:1},Bt=pt.querySelector("image");bt.image=Bt==null?void 0:Bt.getAttribute("source");const vt=pt.querySelector("properties");vt&&this._parsePropertiesNode(vt,bt);const Ut=Bt==null?void 0:Bt.getAttribute("trans");if(Ut&&(bt.transparentcolor="#"+Ut),this._parseAttributes(pt,bt),mt)try{return Mt.parse(bt)}catch(Gt){throw console.error("Could not parse layer",bt,Gt),Gt}return bt}parseExternalTemplate(pt,mt=!0){const bt=this._parseToDocument(pt).querySelector("template"),Bt={type:"template"},vt=bt.querySelector("object");vt&&(Bt.object=this.parseObject(vt,mt));const Ut=bt.querySelector("tileset");if(Ut&&(Bt.tileset=this.parseTileset(Ut,mt)),mt)try{return it.parse(Bt)}catch(Gt){throw console.error("Could not parse template",Bt,Gt),Gt}return Bt}parseExternalTileset(pt,mt=!0){const bt=this._parseToDocument(pt).querySelector("tileset"),Bt=this.parseTileset(bt,mt);if(Bt.type="tileset",this._parseAttributes(bt,Bt),mt)try{return Kt.parse(Bt)}catch(vt){throw console.error("Could not parse tileset file",Bt,vt),vt}return Bt}parse(pt,mt=!0){const bt=this._parseToDocument(pt).querySelector("map"),Bt={type:"map",compressionlevel:-1,layers:[],tilesets:[]};this._parseAttributes(bt,Bt);const vt=(Ut,Gt=!0)=>{switch(Ut.tagName){case"group":for(let Nt of Ut.children)vt(Nt,Gt);break;case"layer":{const Nt=this.parseTileLayer(Ut,Bt.infinite,Gt);Bt.layers.push(Nt);break}case"properties":this._parsePropertiesNode(Ut,Bt);break;case"tileset":{const Nt=this.parseTileset(Ut,Gt);Bt.tilesets.push(Nt);break}case"objectgroup":{const Nt=this.parseObjectGroup(Ut,Gt);Bt.layers.push(Nt);break}case"imagelayer":{const Nt=this.parseImageLayer(Ut,Gt);Bt.layers.push(Nt);break}}};for(let Ut of bt.children)vt(Ut,mt);if(mt)try{return x.parse(Bt)}catch(Ut){throw console.error("Could not parse Tiled map",Ut),Ut}return Bt}}},"./src/resource/decoder.ts":(A,y,w)=>{w.r(y),w.d(y,{Decoder:()=>C});var f=w("./node_modules/pako/index.js"),T=w("./node_modules/zstddec/dist/zstddec.modern.js");class C{static decode(E,W){var D,H,k,N,Q,L;if(E.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var O=43,Y=47,ot=48,nt=97,et=65,ut=45,Z=95;function I(X){var j=X.charCodeAt(0);if(j===O||j===ut)return 62;if(j===Y||j===Z)return 63;if(j<ot)return-1;if(j<ot+10)return j-ot+26+26;if(j<et+26)return j-et;if(j<nt+26)return j-nt+26;throw Error("Could not decode elt")}var R=E.length;Q=E.charAt(R-2)==="="?2:E.charAt(R-1)==="="?1:0,L=new Uint8Array(3*E.length/4-Q),k=Q>0?E.length-4:E.length;var q=0;function tt(X){L[q++]=X}for(D=0,H=0;D<k;D+=4,H+=3)tt((16711680&(N=I(E.charAt(D))<<18|I(E.charAt(D+1))<<12|I(E.charAt(D+2))<<6|I(E.charAt(D+3))))>>16),tt((65280&N)>>8),tt(255&N);return Q===2?tt(255&(N=I(E.charAt(D))<<2|I(E.charAt(D+1))>>4)):Q===1&&(tt((N=I(E.charAt(D))<<10|I(E.charAt(D+1))<<4|I(E.charAt(D+2))>>2)>>8&255),tt(255&N)),new Promise(X=>{const j=function(Dt){for(var ht=0,Mt=Dt.length-1;Mt>=0;Mt--)ht=256*ht+1*Dt[Mt];return ht};if(W==="zlib"||W==="gzip"){var F=(L=(0,f.inflate)(L)).length/4,St=new Array(F);for(D=0;D<F;D++)St[D]=j(L.slice(4*D,4*D+4));X(St)}if(W==="zstd"){const Dt=new T.ZSTDDecoder;Dt.init().then(()=>{var ht=(L=Dt.decode(L)).length/4,Mt=new Array(ht);for(D=0;D<ht;D++)Mt[D]=j(L.slice(4*D,4*D+4));X(Mt)})}if(!W){for(F=L.length/4,St=new Array(F),D=0;D<F;D++)St[D]=j(L.slice(4*D,4*D+4));X(St)}})}}},"./src/resource/excalibur-properties.ts":(A,y,w)=>{w.r(y),w.d(y,{ExcaliburTiledProperties:()=>f});const f={TileData:{Tiled:"ex-tiled"},ZIndex:{ZIndex:"zindex"},Camera:{Camera:"camera",Zoom:"zoom"},Animation:{Strategy:"animationstrategy"},Layer:{Solid:"solid"},Collision:{Type:"collisiontype"}}},"./src/resource/file-loader.ts":(A,y,w)=>{w.r(y),w.d(y,{FetchLoader:()=>f});const f=async(T,C)=>{const S=await fetch(T);switch(C.toLowerCase()){case"xml":default:return await S.text();case"json":return await S.json()}}},"./src/resource/filter-util.ts":(A,y,w)=>{w.r(y),w.d(y,{byClassCaseInsensitive:()=>T,byNameCaseInsensitive:()=>f,byPropertyCaseInsensitive:()=>C});const f=S=>E=>E!=null&&E.name&&S?E.name.toLocaleLowerCase().localeCompare(S.toLocaleLowerCase())===0:(E==null?void 0:E.name)===S,T=S=>E=>E!=null&&E.class&&S?E.class.toLocaleLowerCase().localeCompare(S.toLocaleLowerCase())===0:(E==null?void 0:E.class)===S,C=(S,E)=>W=>{const D=(H=>{const k=new Map;for(let[N,Q]of H){let L=Q;typeof Q=="string"&&(L=Q.toLocaleLowerCase()),k.set(N.toLocaleLowerCase(),L)}return k})(W.properties);if(E!==void 0){let H=E;return typeof E=="string"&&(H=E.toLocaleLowerCase()),D.get(S.toLocaleLowerCase())===H}return D.has(S.toLocaleLowerCase())}},"./src/resource/gid-util.ts":(A,y,w)=>{w.r(y),w.d(y,{FLIPPED_DIAGONALLY_FLAG:()=>C,FLIPPED_HORIZONTALLY_FLAG:()=>f,FLIPPED_VERTICALLY_FLAG:()=>T,getCanonicalGid:()=>D,isFlippedDiagonally:()=>W,isFlippedHorizontally:()=>S,isFlippedVertically:()=>E});const f=2147483648,T=1073741824,C=536870912,S=H=>!!(H&f),E=H=>!!(H&T),W=H=>!!(H&C),D=H=>H&~(f|T|C)},"./src/resource/image-layer.ts":(A,y,w)=>{w.r(y),w.d(y,{ImageLayer:()=>S});var f=w("excalibur"),T=w("./src/resource/properties.ts"),C=w("./src/resource/path-util.ts");class S{constructor(W,D,H){this.tiledImageLayer=W,this.resource=D,this.order=H,this.properties=new Map,this.image=null,this.imageActor=null,this.name=W.name,this.class=W.class,(0,T.mapProps)(this,W.properties),W.image&&(this.image=new f.ImageSource((0,C.pathRelativeToBase)(this.resource.path,W.image,this.resource.pathMap)))}async load(){var W,D,H,k;const N=this.tiledImageLayer.opacity,Q=!!this.tiledImageLayer.tintcolor,L=this.tiledImageLayer.tintcolor?f.Color.fromHex(this.tiledImageLayer.tintcolor):f.Color.White,O=(0,f.vec)((W=this.tiledImageLayer.offsetx)!==null&&W!==void 0?W:0,(D=this.tiledImageLayer.offsety)!==null&&D!==void 0?D:0),Y=(H=this.tiledImageLayer.parallaxx)!==null&&H!==void 0?H:1,ot=(k=this.tiledImageLayer.parallaxy)!==null&&k!==void 0?k:1;if(this.image){this.resource.headless||await this.image.load(),this.imageActor=new f.Actor({name:this.tiledImageLayer.name,pos:O,anchor:f.Vector.Zero,z:this.order}),this.imageActor.addComponent(new f.ParallaxComponent((0,f.vec)(Y,ot)));const nt=this.image.toSprite();this.imageActor.graphics.use(nt),this.imageActor.graphics.visible=this.tiledImageLayer.visible,this.imageActor.graphics.opacity=N,Q&&(nt.tint=L)}}}},"./src/resource/iso-tile-layer.ts":(A,y,w)=>{w.r(y),w.d(y,{IsoTileLayer:()=>k});var f=w("excalibur"),T=w("./src/resource/properties.ts"),C=w("./src/parser/tiled-parser.ts"),S=w("./src/resource/decoder.ts"),E=w("./src/resource/gid-util.ts"),W=w("./src/resource/excalibur-properties.ts"),D=w("./src/resource/tiled-layer-component.ts"),H=w("./src/resource/filter-util.ts");class k{constructor(Q,L,O){this.tiledTileLayer=Q,this.resource=L,this.order=O,this.logger=f.Logger.getInstance(),this.width=0,this.height=0,this.properties=new Map,this.data=[],this._gidToTileInfo=new Map,this.name=Q.name,this.class=Q.class,this.width=Q.width,this.height=Q.height,(0,T.mapProps)(this,Q.properties)}getTilesByGid(Q){var L;return(L=this._gidToTileInfo.get(Q))!==null&&L!==void 0?L:[]}getTilesByClassName(Q){return this.isometricMap.tiles.filter(L=>{const O=L.data.get(W.ExcaliburTiledProperties.TileData.Tiled);return!!O&&(0,H.byClassCaseInsensitive)(Q)(O)}).map(L=>({exTile:L,tiledTile:L.data.get(W.ExcaliburTiledProperties.TileData.Tiled)}))}getTilesByProperty(Q,L){return this.isometricMap.tiles.filter(O=>{const Y=O.data.get(W.ExcaliburTiledProperties.TileData.Tiled);return!!Y&&(0,H.byPropertyCaseInsensitive)(Q,L)(Y)}).map(O=>({exTile:O,tiledTile:O.data.get(W.ExcaliburTiledProperties.TileData.Tiled)}))}getTileByPoint(Q){if(!this.isometricMap)return this.logger.warn("IsometricMap has not yet been loaded! getTileByPoint() will only return null"),null;if(this.isometricMap){const L=this.isometricMap.getTileByPoint(Q);if(!L)return null;const O=this.isometricMap.tiles.indexOf(L),Y=(0,E.getCanonicalGid)(this.data[O]);return Y<=0?null:{tiledTile:this.resource.getTilesetForTileGid(Y).getTileByGid(Y),exTile:L}}return null}_recordTileData(Q,L){let O=this._gidToTileInfo.get(Q),Y=this.resource.getTilesetForTileGid(Q).getTileByGid(Q);O?O.push({exTile:L,tiledTile:Y}):O=[{exTile:L,tiledTile:Y}],this._gidToTileInfo.set(Q,O),L.data.set(W.ExcaliburTiledProperties.TileData.Tiled,Y)}updateTile(Q,L,O,Y,ot){this._recordTileData(L,Q),this.resource.useExcaliburWiring&&ot&&(Q.solid=!0);const nt=Q.get(f.IsometricEntityComponent);nt&&(nt.elevation=this.order);const et=this.resource.getTilesetForTileGid(L);let ut=et.getSpriteForGid(L);O&&(ut=ut.clone(),ut.tint=Y),Q.addGraphic(ut,{offset:et.tileOffset});let Z=Q.pos;if(et.orientation==="orthogonal")Z=(0,f.vec)(0,0);else{const q=this.resource.map.tilewidth/2,tt=this.resource.map.tileheight;Z=(0,f.vec)(q,tt)}const I=et.getCollidersForGid(L,{offset:Z});for(let q of I)Q.addCollider(q);let R=et.getAnimationForGid(L);if(R&&(O&&(R=R.clone(),R.tint=Y),Q.clearGraphics(),Q.addGraphic(R,{offset:et.tileOffset}),this.resource.useExcaliburWiring)){const q=et.getTileByGid(L),tt=q==null?void 0:q.properties.get(W.ExcaliburTiledProperties.Animation.Strategy);if(tt&&typeof tt=="string")switch(tt.toLowerCase()){case f.AnimationStrategy.End.toLowerCase():R.strategy=f.AnimationStrategy.End;break;case f.AnimationStrategy.Freeze.toLowerCase():R.strategy=f.AnimationStrategy.Freeze;break;case f.AnimationStrategy.Loop.toLowerCase():R.strategy=f.AnimationStrategy.Loop;break;case f.AnimationStrategy.PingPong.toLowerCase():R.strategy=f.AnimationStrategy.PingPong;break;default:this.logger.warn(`Unknown animation strategy in tileset ${et.name} on tile gid ${L}: ${tt}`)}}}async load(){var Q,L,O,Y;const ot=this.tiledTileLayer,nt=!!this.properties.get(W.ExcaliburTiledProperties.Layer.Solid),et=(this.tiledTileLayer.opacity,!!this.tiledTileLayer.tintcolor),ut=this.tiledTileLayer.tintcolor?f.Color.fromHex(this.tiledTileLayer.tintcolor):f.Color.Transparent,Z=(0,f.vec)((Q=ot.offsetx)!==null&&Q!==void 0?Q:0,(L=ot.offsety)!==null&&L!==void 0?L:0);this.tiledTileLayer.data&&(0,C.needsDecoding)(this.tiledTileLayer)?this.data=await S.Decoder.decode(this.tiledTileLayer.data,this.tiledTileLayer.compression):this.tiledTileLayer.data&&(0,C.isCSV)(this.tiledTileLayer)&&(this.data=this.tiledTileLayer.data);let I=this.order,R=this.properties.get(W.ExcaliburTiledProperties.ZIndex.ZIndex);if(typeof R=="number"&&(I=R),this.resource.map.infinite&&(0,C.isInfiniteLayer)(this.tiledTileLayer)){const q=this.resource.isometricTiledCoordToWorld(this.tiledTileLayer.startx,this.tiledTileLayer.starty),tt=(0,f.vec)(q.x*this.resource.map.tilewidth,q.y*this.resource.map.tileheight);this.isometricMap=new f.IsometricMap({name:this.name,pos:Z.add(tt),tileHeight:this.resource.map.tileheight,tileWidth:this.resource.map.tilewidth,columns:ot.width,rows:ot.height,elevation:I})}else this.isometricMap=new f.IsometricMap({name:this.name,pos:Z,tileWidth:this.resource.map.tilewidth,tileHeight:this.resource.map.tileheight,columns:ot.width,rows:ot.height,elevation:I});if(this.isometricMap.visible=this.tiledTileLayer.visible,this.isometricMap.opacity=this.tiledTileLayer.opacity,this.isometricMap.addComponent(new D.TiledLayerDataComponent({tiledTileLayer:ot})),ot.parallaxx||ot.parallaxy){const q=(0,f.vec)((O=ot.parallaxx)!==null&&O!==void 0?O:1,(Y=ot.parallaxy)!==null&&Y!==void 0?Y:1);this.isometricMap.addComponent(new f.ParallaxComponent(q))}if(this.resource.map.infinite&&(0,C.isInfiniteLayer)(this.tiledTileLayer)){const q=this.tiledTileLayer;for(let tt of this.tiledTileLayer.chunks){let X=[];(0,C.needsDecoding)(this.tiledTileLayer)?X=await S.Decoder.decode(tt.data,q.compression):(0,C.isCSV)(this.tiledTileLayer)&&(X=tt.data);for(let j=0;j<X.length;j++){const F=X[j];if(F!=0){const St=j%tt.width+(tt.x-this.tiledTileLayer.startx),Dt=Math.floor(j/tt.width)+(tt.y-this.tiledTileLayer.starty),ht=this.isometricMap.tiles[St+Dt*ot.width];this.updateTile(ht,F,et,ut,nt)}}}}else for(let q=0;q<this.data.length;q++){let tt=this.data[q];if(tt!==0){const X=this.isometricMap.tiles[q];this.updateTile(X,tt,et,ut,nt)}}}}},"./src/resource/layer.ts":(A,y,w)=>{w.r(y)},"./src/resource/loader-cache.ts":(A,y,w)=>{w.r(y),w.d(y,{LoaderCache:()=>f});class f{constructor(C){this.type=C,this._loaded=!1,this.cache=new Map}getOrAdd(...C){let S=this.cache.get(C.join("+"));return S||(S=new this.type(...C),this.cache.set(C.join("+"),S),S)}values(){if(this._loaded)return Array.from(this.cache.values());throw new Error("Read through cache not yet loaded! No values to return!")}async load(){const C=Array.from(this.cache.entries()),S=await Promise.allSettled(C.map(W=>W[1].load()));let E=0;for(let W=0;W<S.length;W++){const D=S[W];D.status==="rejected"&&(console.error(`Error loading resource at ${C[W][0]}, is your pathMap correct? or your Tiled map corrupted?`,D.reason),E++)}if(E)throw new Error(`Error loading ${E} resources`);this._loaded=!0}}},"./src/resource/object-layer.ts":(A,y,w)=>{w.r(y),w.d(y,{ObjectLayer:()=>D});var f=w("excalibur"),T=w("./src/resource/objects.ts"),C=w("./src/resource/properties.ts"),S=w("./src/resource/filter-util.ts"),E=w("./src/resource/excalibur-properties.ts"),W=w("./src/resource/tiled-data-component.ts");class D{constructor(k,N,Q){this.tiledObjectLayer=k,this.resource=N,this.order=Q,this.logger=f.Logger.getInstance(),this.properties=new Map,this.objects=[],this.entities=[],this._objectToEntity=new Map,this._entityToObject=new Map,this._loaded=!1,this.name=k.name,this.class=k.class,(0,C.mapProps)(this,k.properties)}_logLoadedWarning(k){this.logger.warn(`ObjectLayer ${this.name} is not yet loaded, ${k}() will always be empty!`)}getObjectsByName(k){return this._loaded||this._logLoadedWarning("getObjectsByName"),this.objects.filter((0,S.byNameCaseInsensitive)(k))}getEntitiesByName(k){return this._loaded||this._logLoadedWarning("getEntitiesByName"),this.entities.filter((0,S.byNameCaseInsensitive)(k))}getEntityByObject(k){return this._loaded||this._logLoadedWarning("getEntityByObject"),this._objectToEntity.get(k)}getObjectByEntity(k){return this._loaded||this._logLoadedWarning("getObjectByEntity"),this._entityToObject.get(k)}getObjectsByProperty(k,N){return this._loaded||this._logLoadedWarning("getObjectsByProperty"),this.objects.filter((0,S.byPropertyCaseInsensitive)(k,N))}getEntitiesByProperty(k,N){return this._loaded||this._logLoadedWarning("getEntitiesByProperty"),this.getObjectsByProperty(k,N).map(Q=>this._objectToEntity.get(Q)).filter(Q=>!!Q)}getObjectsByClassName(k){return this._loaded||this._logLoadedWarning("getObjectsByClassName"),this.objects.filter((0,S.byClassCaseInsensitive)(k))}getEntitiesByClassName(k){return this._loaded||this._logLoadedWarning("getEntitiesByClassName"),this.getObjectsByClassName(k).map(N=>this._objectToEntity.get(N)).filter(N=>!!N)}getTemplates(){return this._loaded||this._logLoadedWarning("getTemplates"),this.objects.filter(k=>k instanceof T.TemplateObject)}runFactory(k){var N,Q,L,O;const Y=(0,f.vec)((N=this.tiledObjectLayer.offsetx)!==null&&N!==void 0?N:0,(Q=this.tiledObjectLayer.offsety)!==null&&Q!==void 0?Q:0),ot=this.objects.slice();for(let nt of ot){let et=nt.class;if(nt instanceof T.TemplateObject&&(et=et||nt.template.object.class),k!==et)continue;let ut=(0,f.vec)(((L=nt.x)!==null&&L!==void 0?L:0)+Y.x,((O=nt.y)!==null&&O!==void 0?O:0)+Y.y);this.resource.map.orientation==="isometric"&&(ut=this.resource.isometricTiledCoordToWorld(ut.x,ut.y));const Z=this.resource.factories.get(k);if(Z){const I=Z({worldPos:ut,name:nt.name,class:et,layer:this,object:nt,properties:nt.properties});I&&this._recordObjectEntityMapping(nt,I)}}}_actorFromObject(k,N,Q){var L,O,Y,ot,nt,et;const ut=this.resource.headless,Z=!!this.tiledObjectLayer.tintcolor,I=this.tiledObjectLayer.tintcolor?f.Color.fromHex(this.tiledObjectLayer.tintcolor):f.Color.White;if(k instanceof T.InsertedTile&&Q){const R=this.resource.map.orientation==="isometric"&&Q.orientation==="orthogonal"?"bottom":void 0,q=Q.getTilesetAlignmentAnchor(R);N.anchor=q;const tt=((L=k.tiledObject.width)!==null&&L!==void 0?L:this.resource.map.tilewidth)/this.resource.map.tilewidth,X=((O=k.tiledObject.width)!==null&&O!==void 0?O:this.resource.map.tilewidth)/this.resource.map.tilewidth,j=(0,f.vec)(tt,X);if(!ut){const yt=Q.getSpriteForGid(k.gid).clone();yt.destSize.width=(Y=k.tiledObject.width)!==null&&Y!==void 0?Y:yt.width,yt.destSize.height=(ot=k.tiledObject.height)!==null&&ot!==void 0?ot:yt.height,Z&&(yt.tint=I),N.graphics.use(yt),N.graphics.offset=Q.tileOffset;const de=Q.getAnimationForGid(k.gid);if(de){const Kt=de.clone();Kt.scale=j,Z&&(Kt.tint=I),N.graphics.use(Kt),N.graphics.offset=Q.tileOffset}}const F=(nt=k.tiledObject.width)!==null&&nt!==void 0?nt:0,St=(et=k.tiledObject.height)!==null&&et!==void 0?et:0,Dt=-F*q.x,ht=-St*q.y,Mt=this.resource.map.tilewidth/2,Ct=this.resource.map.tileheight;let Yt=(0,f.vec)(Dt,ht);this.resource.map.orientation==="isometric"&&(Yt=(0,f.vec)(Dt+Mt,ht+Ct),Q.orientation==="orthogonal"&&(Yt=Yt.sub((0,f.vec)(Mt,Ct))));const xt=Q.getCollidersForGid(k.gid,{anchor:f.Vector.Zero,scale:j,offset:Yt});if(xt.length)N.collider.useCompositeCollider(xt);else{let yt=k.width,de=k.height;if(this.resource.map.orientation==="isometric"){const Ht=k.height/2;yt=Ht,de=Ht}let Kt=f.Shape.Box(yt,de,this.resource.map.orientation==="isometric"?(0,f.vec)(1,1):(0,f.vec)(0,1));this.resource.map.orientation==="isometric"&&(Kt.points=Kt.points.map(Ht=>this.resource.isometricTiledCoordToWorld(Ht.x,Ht.y))),N.collider.set(Kt)}}if(k instanceof T.Text&&N.graphics.use(k.text),k instanceof T.Polygon){let R=(0,f.vec)(k.x,k.y),q=k.localPoints;this.resource.map.orientation==="isometric"&&(R=this.resource.isometricTiledCoordToWorld(R.x,R.y),q=q.map(X=>this.resource.isometricTiledCoordToWorld(X.x,X.y))),N.anchor=(0,f.vec)(0,1),N.pos=R;const tt=f.Shape.Polygon(q,f.Vector.Zero,!0);tt.isConvex()?N.collider.set(tt):N.collider.set(tt.triangulate())}if(k instanceof T.Rectangle){N.anchor=k.anchor;let R=f.Shape.Box(k.width,k.height,k.anchor);this.resource.map.orientation==="isometric"&&(R.points=R.points.map(q=>this.resource.isometricTiledCoordToWorld(q.x,q.y))),N.collider.set(R)}k instanceof T.Ellipse&&N.collider.useCircleCollider(Math.min(k.width,k.height)/2)}async load(){var k,N,Q,L,O;const Y=this.tiledObjectLayer.opacity,ot=(0,f.vec)((k=this.tiledObjectLayer.offsetx)!==null&&k!==void 0?k:0,(N=this.tiledObjectLayer.offsety)!==null&&N!==void 0?N:0),nt=(0,T.parseObjects)(this.tiledObjectLayer,this.resource);for(let et of nt){let ut=(0,f.vec)(((Q=et.x)!==null&&Q!==void 0?Q:0)+ot.x,((L=et.y)!==null&&L!==void 0?L:0)+ot.y);this.resource.map.orientation==="isometric"&&(ut=this.resource.isometricTiledCoordToWorld(ut.x,ut.y));let Z,I=et.class;if(et instanceof T.TemplateObject&&(I=I||et.template.object.class),I){const X=this.resource.factories.get(I);if(X){const j=X({worldPos:ut,name:et.name,class:I,layer:this,object:et,properties:et.properties});j&&this._recordObjectEntityMapping(et,j);continue}}let R=this.properties.get(E.ExcaliburTiledProperties.ZIndex.ZIndex);typeof R=="number"&&(Z=R);const q=new f.Actor({name:et.tiledObject.name,pos:ut,anchor:f.Vector.Zero,rotation:(0,f.toRadians)((O=et.tiledObject.rotation)!==null&&O!==void 0?O:0),z:Z}),tt=q.get(f.GraphicsComponent);if(tt&&(tt.visible=this.tiledObjectLayer.visible&&(et.tiledObject.visible===void 0||!!et.tiledObject.visible),tt.opacity=Y),this.resource.map.orientation==="isometric"){const X=new f.IsometricEntityComponent({rows:this.resource.map.height,columns:this.resource.map.width,tileWidth:this.resource.map.tilewidth,tileHeight:this.resource.map.tileheight});X.elevation=Z??this.order,q.addComponent(X)}if(this.resource.useExcaliburWiring){const X=et.properties.get(E.ExcaliburTiledProperties.Collision.Type);if(X&&typeof X=="string")switch(X.toLowerCase()){case f.CollisionType.Active.toLowerCase():q.body.collisionType=f.CollisionType.Active;break;case f.CollisionType.Fixed.toLowerCase():q.body.collisionType=f.CollisionType.Fixed;break;case f.CollisionType.Passive.toLowerCase():q.body.collisionType=f.CollisionType.Passive;break;case f.CollisionType.PreventCollision.toLowerCase():q.body.collisionType=f.CollisionType.PreventCollision;break;default:this.logger.warn(`Unknown collision type in layer ${this.name}, for object id ${et.id} and name ${et.name}: ${X}`)}}if(et instanceof T.TemplateObject){const X=et.template.tileset;et.template.object&&this._actorFromObject(et.template.object,q,X)}else{let X;et instanceof T.InsertedTile&&(X=this.resource.getTilesetForTileGid(et.gid)),this._actorFromObject(et,q,X)}this._recordObjectEntityMapping(et,q)}this._loaded=!0}_recordObjectEntityMapping(k,N){N.addComponent(new W.TiledDataComponent({tiledObject:k})),this.objects.push(k),this.entities.push(N),this._objectToEntity.set(k,N),this._entityToObject.set(N,k)}}},"./src/resource/objects.ts":(A,y,w)=>{w.r(y),w.d(y,{Ellipse:()=>k,InsertedTile:()=>W,PluginObject:()=>S,Point:()=>D,Polygon:()=>Q,Polyline:()=>L,Rectangle:()=>N,TemplateObject:()=>E,Text:()=>H,parseObject:()=>O,parseObjects:()=>Y});var f=w("excalibur"),T=w("./src/resource/properties.ts"),C=w("./src/resource/path-util.ts");class S{constructor(nt){var et,ut,Z;this.properties=new Map,this.tiledObject=nt.tiledObject,this.name=this.tiledObject.name,this.class=this.tiledObject.type,this.id=(et=this.tiledObject.id)!==null&&et!==void 0?et:-1,this.x=(ut=this.tiledObject.x)!==null&&ut!==void 0?ut:0,this.y=(Z=this.tiledObject.y)!==null&&Z!==void 0?Z:0}}class E extends S{constructor(nt,et){if(super({tiledObject:nt}),!nt.template)throw new Error("Invalid template");if(this.source=nt.template,this.tiledTemplate=nt,this.template=et,et.object){this.name=this.name||et.object.name,this.class=this.class||et.object.class;for(const[ut,Z]of et.object.properties.entries())this.properties.has(ut)||this.properties.set(ut,Z)}if(et.tileset&&et.object.tiledObject.gid){const ut=et.tileset.getTileByGid(et.object.tiledObject.gid);if(ut){this.class=this.class||ut.class;for(const[Z,I]of ut.properties.entries())this.properties.has(Z)||this.properties.set(Z,I)}}}}class W extends S{constructor(nt,et,ut,Z){super({tiledObject:nt}),this.gid=et,this.width=ut,this.height=Z}}class D extends S{}class H extends S{constructor(nt,et,ut,Z){var I,R,q;super({tiledObject:nt}),this.font=new f.Font({family:(I=et.fontfamily)!==null&&I!==void 0?I:"sans-serif",color:et.color?f.Color.fromHex(et.color):f.Color.Black,size:(R=et.pixelsize)!==null&&R!==void 0?R:16,unit:f.FontUnit.Px,textAlign:this._textAlignFromTiled(et.halign),baseAlign:this._textBaselineFromTiled(et.valign),quality:Z});const tt=(q=et.wrap)!==null&&q!==void 0&&q;this.text=new f.Text({text:et.text,font:this.font,...tt?{maxWidth:ut+10}:{}})}_textBaselineFromTiled(nt){switch(nt){case"bottom":return f.BaseAlign.Bottom;case"center":return f.BaseAlign.Middle;default:return f.BaseAlign.Top}}_textAlignFromTiled(nt){switch(nt){case"left":default:return f.TextAlign.Left;case"center":return f.TextAlign.Center;case"right":return f.TextAlign.Right;case"justify":return f.TextAlign.Start}}}class k extends S{constructor(nt,et,ut){super({tiledObject:nt}),this.width=et,this.height=ut}}class N extends S{constructor(nt,et,ut,Z){super({tiledObject:nt}),this.width=et,this.height=ut,this.anchor=Z}}class Q extends S{constructor(nt,et){super({tiledObject:nt}),this.points=[],this.localPoints=[],this.localPoints=et.map(ut=>(0,f.vec)(ut.x,ut.y)),this.points=et.map(ut=>(0,f.vec)(ut.x,ut.y).add((0,f.vec)(this.x,this.y)))}}class L extends S{constructor(nt,et){super({tiledObject:nt}),this.points=[],this.points=et.map(ut=>(0,f.vec)(ut.x,ut.y))}}function O(ot,nt){var et,ut,Z,I;let R;if(ot.point)R=new D({tiledObject:ot});else if(ot.ellipse)ot.width&&ot.height?(R=new k(ot,ot.width,ot.height),R.x+=ot.width/2,R.y+=ot.height/2):R=new k(ot,20,20);else if(ot.polygon)R=new Q(ot,ot.polygon);else if(ot.polyline)R=new L(ot,ot.polyline);else if(ot.text)R=new H(ot,ot.text,(et=ot.width)!==null&&et!==void 0?et:0,(ut=nt==null?void 0:nt.textQuality)!==null&&ut!==void 0?ut:4);else if(ot.gid){R=new W(ot,ot.gid,(Z=ot.width)!==null&&Z!==void 0?Z:0,(I=ot.height)!==null&&I!==void 0?I:0);const q=nt==null?void 0:nt.getTilesetForTileGid(ot.gid);let tt=ot.type;if(q){const X=q==null?void 0:q.getTileByGid(ot.gid);if(tt=tt||(X==null?void 0:X.class),X==null?void 0:X.properties)for(const[j,F]of X.properties.entries())R.properties.has(j)||R.properties.set(j,F)}R.class=tt}else if(ot.template&&nt){const q=nt.templates.find(tt=>(0,C.filenameFromPath)(tt.templatePath)===(0,C.filenameFromPath)(ot.template));if(!q)throw new Error(`Template object id ${ot.id} with name ${ot.name} is missing a loaded template file, there should be one loaded from ${ot.template}! Is your tiled map or template corrupted?`);R=new E(ot,q)}else R=ot.width&&ot.height?new N(ot,ot.width,ot.height,f.Vector.Zero):new N(ot,20,20,f.Vector.Half);return(0,T.mapProps)(R,ot.properties),R}function Y(ot,nt){const et=[];for(const ut of ot.objects){let Z=O(ut,nt);et.push(Z)}return et}},"./src/resource/path-util.ts":(A,y,w)=>{function f(E){const W=E.match(/[^/\\&\?]+\.\w{2,4}(?=([\#\?&].*$|$))/gi);if(W)return W[0];throw new Error(`Could not locate filename from path: ${E}`)}function T(E,W){for(const{path:D,output:H}of W)if(typeof D=="string"){if(E.includes(D))return H}else{const k=E.match(D);if(k)return H.replace("[match]",k[0])}return E}function C(E,W){if(!W)return!1;for(const{path:D,output:H}of W)if(typeof D=="string"){if(E.includes(D))return!0}else if(E.match(D))return!0;return!1}function S(E,W,D){if(C(W,D)&&D)return T(W,D);if(W.indexOf("/")===0)return W;const H=E.split("/"),k=W.split("/");return H[H.length-1].includes(".")&&H.pop(),H.concat(k).join("/")}w.r(y),w.d(y,{filenameFromPath:()=>f,mapPath:()=>T,pathInMap:()=>C,pathRelativeToBase:()=>S})},"./src/resource/properties.ts":(A,y,w)=>{function f(T,C){try{if(C)for(const S of C){let E=S.value;typeof S.value=="string"&&(E=S.value.toLocaleLowerCase()),T.properties.set(S.name.toLocaleLowerCase(),E)}}catch(S){console.error(`Unable to map properties onto ${T}`,S)}}w.r(y),w.d(y,{mapProps:()=>f})},"./src/resource/template-resource.ts":(A,y,w)=>{w.r(y),w.d(y,{TemplateResource:()=>k});var f=w("excalibur"),T=w("./src/parser/tiled-parser.ts"),C=w("./src/resource/file-loader.ts"),S=w("./src/resource/loader-cache.ts"),E=w("./src/resource/objects.ts"),W=w("./src/resource/path-util.ts"),D=w("./src/resource/template.ts"),H=w("./src/resource/tileset-resource.ts");class k{constructor(Q,L){this.templatePath=Q,this.headless=!1,this.strict=!0,this.fileLoader=C.FetchLoader;const{fileLoader:O,parser:Y,pathMap:ot,imageLoader:nt,strict:et,headless:ut}={...L};this.headless=ut??this.headless,this.strict=et??this.strict,this.fileLoader=O??this.fileLoader,this.imageLoader=nt??new S.LoaderCache(f.ImageSource),this.parser=Y??new T.TiledParser,this.pathMap=ot}isLoaded(){return!!this.data}async load(){const Q=this.templatePath.includes(".tx")?"xml":"json";try{const L=await this.fileLoader(this.templatePath,Q);let O;O=Q==="xml"?this.parser.parseExternalTemplate(L,this.strict):this.strict?T.TiledTemplate.parse(L):L;const Y=O,ot=(0,E.parseObject)(O.object);let nt;if(O.tileset){const et=(0,W.pathRelativeToBase)(this.templatePath,O.tileset.source,this.pathMap);nt=await new H.TilesetResource(et,O.tileset.firstgid,{headless:this.headless,strict:this.strict,fileLoader:this.fileLoader,imageLoader:this.imageLoader,parser:this.parser,pathMap:this.pathMap}).load()}return this.data=new D.Template({templatePath:this.templatePath,tiledTemplate:Y,object:ot,tileset:nt})}catch(L){throw console.error(`Could not load template at ${this.templatePath}, check to see if your pathMap is correct or if you're Tiled map is corrupted`),L}}}},"./src/resource/template.ts":(A,y,w)=>{w.r(y),w.d(y,{Template:()=>f});class f{constructor(C){const{templatePath:S,object:E,tiledTemplate:W,tileset:D}=C;this.templatePath=S,this.object=E,this.tiledTemplate=W,this.tileset=D}}},"./src/resource/tile-layer.ts":(A,y,w)=>{w.r(y),w.d(y,{TileLayer:()=>k});var f=w("excalibur"),T=w("./src/resource/properties.ts"),C=w("./src/parser/tiled-parser.ts"),S=w("./src/resource/decoder.ts"),E=w("./src/resource/gid-util.ts"),W=w("./src/resource/excalibur-properties.ts"),D=w("./src/resource/tiled-layer-component.ts"),H=w("./src/resource/filter-util.ts");class k{getTilesByGid(Q){var L;return(L=this._gidToTileInfo.get(Q))!==null&&L!==void 0?L:[]}getTilesByClassName(Q){return this.tilemap.tiles.filter(L=>{const O=L.data.get(W.ExcaliburTiledProperties.TileData.Tiled);return!!O&&(0,H.byClassCaseInsensitive)(Q)(O)}).map(L=>({exTile:L,tiledTile:L.data.get(W.ExcaliburTiledProperties.TileData.Tiled)}))}getTilesByProperty(Q,L){return this.tilemap.tiles.filter(O=>{const Y=O.data.get(W.ExcaliburTiledProperties.TileData.Tiled);return!!Y&&(0,H.byPropertyCaseInsensitive)(Q,L)(Y)}).map(O=>({exTile:O,tiledTile:O.data.get(W.ExcaliburTiledProperties.TileData.Tiled)}))}getTileByPoint(Q){if(!this.tilemap)return this.logger.warn("Tilemap has not yet been loaded! getTileByPoint() will only return null"),null;if(this.tilemap){const L=this.tilemap.getTileByPoint(Q);if(!L)return null;const O=this.tilemap.tiles.indexOf(L),Y=(0,E.getCanonicalGid)(this.data[O]);return Y<=0?null:{tiledTile:this.resource.getTilesetForTileGid(Y).getTileByGid(Y),exTile:L}}return null}getTileByCoordinate(Q,L){if(!this.tilemap)return this.logger.warn("Tilemap has not yet been loaded! getTileByCoordinate() will only return null"),null;if(this.tilemap){const O=this.tilemap.getTile(Q,L),Y=this.tilemap.tiles.indexOf(O),ot=(0,E.getCanonicalGid)(this.data[Y]);return ot<=0?null:{tiledTile:this.resource.getTilesetForTileGid(ot).getTileByGid(ot),exTile:O}}return null}constructor(Q,L,O){this.tiledTileLayer=Q,this.resource=L,this.order=O,this.logger=f.Logger.getInstance(),this.width=0,this.height=0,this.properties=new Map,this.data=[],this._gidToTileInfo=new Map,this.name=Q.name,this.class=Q.class,this.width=Q.width,this.height=Q.height,(0,T.mapProps)(this,Q.properties)}_recordTileData(Q,L){let O=this._gidToTileInfo.get(Q),Y=this.resource.getTilesetForTileGid(Q).getTileByGid(Q);O?O.push({exTile:L,tiledTile:Y}):O=[{exTile:L,tiledTile:Y}],this._gidToTileInfo.set(Q,O),L.data.set(W.ExcaliburTiledProperties.TileData.Tiled,Y)}updateTile(Q,L,O,Y,ot){this._recordTileData(L,Q),this.resource.useExcaliburWiring&&ot&&(Q.solid=!0);const nt=this.resource.getTilesetForTileGid(L),et=this.resource.headless;if(!et){let I=nt.getSpriteForGid(L);O&&(I=I.clone(),I.tint=Y),Q.addGraphic(I,{offset:nt.tileOffset})}const ut=nt.getCollidersForGid(L);for(let I of ut)Q.addCollider(I);let Z=et?null:nt.getAnimationForGid(L);if(Z&&(O&&(Z=Z.clone(),Z.tint=Y),Q.clearGraphics(),Q.addGraphic(Z,{offset:nt.tileOffset}),this.resource.useExcaliburWiring)){const I=nt.getTileByGid(L),R=I==null?void 0:I.properties.get(W.ExcaliburTiledProperties.Animation.Strategy);if(R&&typeof R=="string")switch(R.toLowerCase()){case f.AnimationStrategy.End.toLowerCase():Z.strategy=f.AnimationStrategy.End;break;case f.AnimationStrategy.Freeze.toLowerCase():Z.strategy=f.AnimationStrategy.Freeze;break;case f.AnimationStrategy.Loop.toLowerCase():Z.strategy=f.AnimationStrategy.Loop;break;case f.AnimationStrategy.PingPong.toLowerCase():Z.strategy=f.AnimationStrategy.PingPong;break;default:this.logger.warn(`Unknown animation strategy in tileset ${nt.name} on tile gid ${L}: ${R}`)}}}async load(){var Q,L,O,Y;const ot=this.tiledTileLayer.opacity,nt=!!this.tiledTileLayer.tintcolor,et=this.tiledTileLayer.tintcolor?f.Color.fromHex(this.tiledTileLayer.tintcolor):f.Color.Transparent,ut=!!this.properties.get(W.ExcaliburTiledProperties.Layer.Solid),Z=this.tiledTileLayer,I=(0,f.vec)((Q=Z.offsetx)!==null&&Q!==void 0?Q:0,(L=Z.offsety)!==null&&L!==void 0?L:0);if(this.tiledTileLayer.data&&(0,C.needsDecoding)(this.tiledTileLayer)?this.data=await S.Decoder.decode(this.tiledTileLayer.data,this.tiledTileLayer.compression):this.tiledTileLayer.data&&(0,C.isCSV)(this.tiledTileLayer)&&(this.data=this.tiledTileLayer.data),this.resource.map.infinite&&(0,C.isInfiniteLayer)(this.tiledTileLayer)){const tt=(0,f.vec)(this.tiledTileLayer.startx*this.resource.map.tilewidth,this.tiledTileLayer.starty*this.resource.map.tileheight);this.tilemap=new f.TileMap({name:this.name,pos:I.add(tt),tileHeight:this.resource.map.tileheight,tileWidth:this.resource.map.tilewidth,columns:Z.width,rows:Z.height})}else this.tilemap=new f.TileMap({name:this.name,pos:I,tileWidth:this.resource.map.tilewidth,tileHeight:this.resource.map.tileheight,columns:Z.width,rows:Z.height});this.tilemap.addComponent(new D.TiledLayerDataComponent({tiledTileLayer:Z}));const R=this.tilemap.get(f.TransformComponent);if(R){R.z=this.order;let tt=this.properties.get(W.ExcaliburTiledProperties.ZIndex.ZIndex);typeof tt=="number"&&(R.z=tt)}const q=this.tilemap.get(f.GraphicsComponent);if(q&&(q.visible=this.tiledTileLayer.visible,q.opacity=ot),Z.parallaxx||Z.parallaxy){const tt=(0,f.vec)((O=Z.parallaxx)!==null&&O!==void 0?O:1,(Y=Z.parallaxy)!==null&&Y!==void 0?Y:1);this.tilemap.addComponent(new f.ParallaxComponent(tt))}if(this.resource.map.infinite&&(0,C.isInfiniteLayer)(this.tiledTileLayer)){const tt=this.tiledTileLayer;for(let X of this.tiledTileLayer.chunks){let j=[];(0,C.needsDecoding)(this.tiledTileLayer)?j=await S.Decoder.decode(X.data,tt.compression):(0,C.isCSV)(this.tiledTileLayer)&&(j=X.data);for(let F=0;F<j.length;F++){const St=j[F];if(St!=0){const Dt=F%X.width+(X.x-this.tiledTileLayer.startx),ht=Math.floor(F/X.width)+(X.y-this.tiledTileLayer.starty),Mt=this.tilemap.tiles[Dt+ht*Z.width];this.updateTile(Mt,St,nt,et,ut)}}}}else for(let tt=0;tt<this.data.length;tt++){let X=this.data[tt];if(X!==0){const j=this.tilemap.tiles[tt];this.updateTile(j,X,nt,et,ut)}}}}},"./src/resource/tiled-data-component.ts":(A,y,w)=>{w.r(y),w.d(y,{TiledDataComponent:()=>T});var f=w("excalibur");class T extends f.Component{constructor(S){super();const{tiledObject:E}=S;this.tiledObject=E}}},"./src/resource/tiled-layer-component.ts":(A,y,w)=>{w.r(y),w.d(y,{TiledLayerDataComponent:()=>T});var f=w("excalibur");class T extends f.Component{constructor(S){super();const{tiledTileLayer:E}=S;this.tiledTileLayer=E}}},"./src/resource/tiled-resource.ts":(A,y,w)=>{w.r(y),w.d(y,{TiledResource:()=>et});var f=w("excalibur"),T=w("./src/parser/tiled-parser.ts"),C=w("./src/resource/tileset.ts"),S=w("./src/resource/iso-tile-layer.ts"),E=w("./src/resource/tile-layer.ts"),W=w("./src/resource/object-layer.ts"),D=w("./node_modules/compare-versions/lib/esm/compare.js"),H=w("./src/resource/gid-util.ts"),k=w("./src/resource/path-util.ts"),N=w("./src/resource/filter-util.ts"),Q=w("./src/resource/excalibur-properties.ts"),L=w("./src/resource/file-loader.ts"),O=w("./src/resource/tileset-resource.ts"),Y=w("./src/resource/loader-cache.ts"),ot=w("./src/resource/template-resource.ts"),nt=w("./src/resource/image-layer.ts");class et{constructor(Z,I){this.path=Z,this.logger=f.Logger.getInstance(),this.tilesets=[],this.templates=[],this.layers=[],this.mapFormat="TMX",this.strict=!0,this.factories=new Map,this.parser=new T.TiledParser,this.fileLoader=L.FetchLoader,this.startZIndex=0,this.textQuality=4,this.useExcaliburWiring=!0,this.useMapBackgroundColor=!1,this.useTilemapCameraStrategy=!1,this.headless=!1,this._imageLoader=new Y.LoaderCache(f.ImageSource),this._tilesetLoader=new Y.LoaderCache(O.TilesetResource),this._templateLoader=new Y.LoaderCache(ot.TemplateResource);const{mapFormatOverride:R,textQuality:q,entityClassNameFactories:tt,useExcaliburWiring:X,useTilemapCameraStrategy:j,useMapBackgroundColor:F,pathMap:St,fileLoader:Dt,strict:ht,headless:Mt,startZIndex:Ct}={...I};this.strict=ht??this.strict,this.headless=Mt??this.headless,this.useExcaliburWiring=X??this.useExcaliburWiring,this.useTilemapCameraStrategy=j??this.useTilemapCameraStrategy,this.useMapBackgroundColor=F??this.useMapBackgroundColor,this.textQuality=q??this.textQuality,this.startZIndex=Ct??this.startZIndex,this.fileLoader=Dt??this.fileLoader,this.pathMap=St;for(const Yt in tt)this.registerEntityFactory(Yt,tt[Yt]);this.mapFormat=R??(Z.includes(".tmx")?"TMX":"TMJ")}registerEntityFactory(Z,I){if(this.factories.has(Z)&&console.warn(`Another factory has already been registered for tiled class/type "${Z}", this is probably a bug.`),this.factories.set(Z,I),this.isLoaded())for(let R of this.getObjectLayers())R.runFactory(Z)}unregisterEntityFactory(Z){this.factories.has(Z)||console.warn(`No factory has been registered for tiled class/type "${Z}", cannot unregister!`),this.factories.delete(Z)}getTilesetForTileGid(Z){const I=(0,H.getCanonicalGid)(Z);if(this.tilesets){for(let R of this.tilesets)if(I>=R.firstGid&&I<=R.firstGid+R.tileCount-1)return R}throw Error(`No tileset exists for tiled gid [${Z}] normalized [${I}]!`)}getTilesetByName(Z){return this.tilesets.filter((0,N.byNameCaseInsensitive)(Z))}getTilesetByClassName(Z){return this.tilesets.filter((0,N.byClassCaseInsensitive)(Z))}getTilesetByProperty(Z,I){return this.tilesets.filter((0,N.byPropertyCaseInsensitive)(Z,I))}getTileMetadataByClassName(Z){let I=[];for(let R of this.tilesets)I=I.concat(R.tiles.filter((0,N.byClassCaseInsensitive)(Z)));return I}getTileMetadataByProperty(Z,I){let R=[];for(let q of this.tilesets)R=R.concat(q.tiles.filter((0,N.byPropertyCaseInsensitive)(Z,I)));return R}getTilesByGid(Z){if(this.map.orientation==="orthogonal"){let I=[];for(let R of this.getTileLayers())I=I.concat(R.getTilesByGid(Z));return I}{let I=[];for(let R of this.getIsoTileLayers())I=I.concat(R.getTilesByGid(Z));return I}}getTilesByClassName(Z){if(this.map.orientation==="orthogonal"){let I=[];for(let R of this.getTileLayers())I=I.concat(R.getTilesByClassName(Z));return I}{let I=[];for(let R of this.getIsoTileLayers())I=I.concat(R.getTilesByClassName(Z));return I}}getTilesByProperty(Z,I){if(this.map.orientation==="orthogonal"){let R=[];for(let q of this.getTileLayers())R=R.concat(q.getTilesByProperty(Z,I));return R}{let R=[];for(let q of this.getIsoTileLayers())R=R.concat(q.getTilesByProperty(Z,I));return R}}getTileByPoint(Z,I){if(this.map.orientation==="isometric"){const R=this.getIsoTileLayers().find((0,N.byNameCaseInsensitive)(Z));if(R)return R.getTileByPoint(I)}else{const R=this.getTileLayers().find((0,N.byNameCaseInsensitive)(Z));if(R)return R.getTileByPoint(I)}return null}getTilesByPoint(Z){if(this.map.orientation==="orthogonal"){let I=[];for(let R of this.getTileLayers()){const q=R.getTileByPoint(Z);q&&I.push(q)}return I}{let I=[];for(let R of this.getIsoTileLayers()){const q=R.getTileByPoint(Z);q&&I.push(q)}return I}}getObjectsByName(Z){let I=[];for(let R of this.getObjectLayers())I=I.concat(R.getObjectsByName(Z));return I}getEntitiesByName(Z){let I=[];for(let R of this.getObjectLayers())I=I.concat(R.getEntitiesByName(Z));return I}getEntityByObject(Z){for(let I of this.getObjectLayers()){const R=I.getEntityByObject(Z);if(R)return R}}getObjectByEntity(Z){for(let I of this.getObjectLayers()){const R=I.getObjectByEntity(Z);if(R)return R}}getObjectsByProperty(Z,I){let R=[];for(let q of this.getObjectLayers())R=R.concat(q.getObjectsByProperty(Z,I));return R}getEntitiesByProperty(Z,I){let R=[];for(let q of this.getObjectLayers())R=R.concat(q.getEntitiesByProperty(Z,I));return R}getObjectsByClassName(Z){let I=[];for(let R of this.getObjectLayers())I=I.concat(R.getObjectsByClassName(Z));return I}getEntitiesByClassName(Z){let I=[];for(let R of this.getObjectLayers())I=I.concat(R.getEntitiesByClassName(Z));return I}getTileByCoordinate(Z,I,R){const q=this.getTileLayers().find((0,N.byNameCaseInsensitive)(Z));return q?q.getTileByCoordinate(I,R):null}getImageLayers(Z){const I=this.layers.filter(R=>R instanceof nt.ImageLayer);return Z?I.filter((0,N.byNameCaseInsensitive)(Z)):I}getTileLayers(Z){const I=this.layers.filter(R=>R instanceof E.TileLayer);return Z?I.filter((0,N.byNameCaseInsensitive)(Z)):I}getIsoTileLayers(Z){const I=this.layers.filter(R=>R instanceof S.IsoTileLayer);return Z?I.filter((0,N.byNameCaseInsensitive)(Z)):I}getObjectLayers(Z){const I=this.layers.filter(R=>R instanceof W.ObjectLayer);return Z?I.filter((0,N.byNameCaseInsensitive)(Z)):I}getLayersByName(Z){return this.layers.filter((0,N.byNameCaseInsensitive)(Z))}getLayersByClassName(Z){return this.layers.filter((0,N.byClassCaseInsensitive)(Z))}getLayersByProperty(Z,I){return this.layers.filter((0,N.byPropertyCaseInsensitive)(Z,I))}_parseMap(Z){return this.mapFormat==="TMX"?this.parser.parse(Z,this.strict):Z}async load(){var Z;const I=await this.fileLoader(this.path,this.mapFormat==="TMX"?"xml":"json");let R;if(this.strict)try{R=this._parseMap(I)}catch(X){throw console.error(`Could not parse tiled map from location ${this.path}, attempted to interpret as ${this.mapFormat}.
Excalibur only supports the latest version of Tiled formats as of the plugin's release.`),console.error("Is your map file corrupted or being interpreted as the wrong type?"),X}else R=this._parseMap(I);(0,D.compare)(et.supportedTiledVersion,(Z=R.tiledversion)!==null&&Z!==void 0?Z:"0.0.0",">")&&console.warn(`The excalibur tiled plugin officially supports ${et.supportedTiledVersion}+, the current map has tiled version ${R.tiledversion}`),this.map=R,this._collectTilesets(),this._collectTemplates(),await Promise.all([this._tilesetLoader.load(),this.headless?Promise.resolve():this._imageLoader.load(),this._templateLoader.load()]),this.tilesets=[...this.tilesets,...this._tilesetLoader.values().map(X=>X.data)],this.templates=this._templateLoader.values().map(X=>X.data);let q=[],tt=this.startZIndex;for(const X of this.map.layers){if(X.type==="tilelayer"){if(this.map.orientation==="isometric"){const j=new S.IsoTileLayer(X,this,tt);q.push(j)}if(this.map.orientation==="orthogonal"){const j=new E.TileLayer(X,this,tt);q.push(j)}}if(X.type==="objectgroup"){const j=new W.ObjectLayer(X,this,tt);q.push(j)}if(X.type==="imagelayer"){const j=new nt.ImageLayer(X,this,tt);q.push(j)}tt++}await Promise.all(q.map(X=>X.load())),this.layers=q}_collectTilesets(){for(const Z of this.map.tilesets){if((0,T.isTiledTilesetEmbedded)(Z)){if((0,T.isTiledTilesetSingleImage)(Z)){const I=(0,k.pathRelativeToBase)(this.path,Z.image,this.pathMap),R=this._imageLoader.getOrAdd(I),q=new C.Tileset({name:Z.name,tiledTileset:Z,image:R,firstGid:Z.firstgid});this.tilesets.push(q)}if((0,T.isTiledTilesetCollectionOfImages)(Z)){const I=new Map;if(Z.tiles){for(let q of Z.tiles)if(q.image){const tt=(0,k.pathRelativeToBase)(this.path,q.image,this.pathMap),X=this._imageLoader.getOrAdd(tt);I.set(q,X)}}const R=new C.Tileset({name:Z.name,tiledTileset:Z,tileToImage:I,firstGid:Z.firstgid});this.tilesets.push(R)}}if((0,T.isTiledTilesetExternal)(Z)){const I=(0,k.pathRelativeToBase)(this.path,Z.source,this.pathMap);this._tilesetLoader.getOrAdd(I,Z.firstgid,{strict:this.strict,headless:this.headless,parser:this.parser,fileLoader:this.fileLoader,imageLoader:this._imageLoader,pathMap:this.pathMap})}}}_collectTemplates(){let Z=[];for(const R of this.map.layers)if(R.type==="objectgroup"){let q=R.objects.filter(tt=>tt.template).map(tt=>tt.template);Z=Z.concat(q)}const I=Z.filter((R,q,tt)=>tt.findIndex(X=>X===R)===q);for(const R of I){const q=(0,k.pathRelativeToBase)(this.path,R,this.pathMap);this._templateLoader.getOrAdd(q,{strict:this.strict,headless:this.headless,parser:this.parser,fileLoader:this.fileLoader,imageLoader:this._imageLoader,pathMap:this.pathMap})}}addToScene(Z,I){if(!this.isLoaded())return void this.logger.warn(`TiledResource ${this.path} is not loaded! Nothing will be wired into excalibur!`);const R={pos:(0,f.vec)(0,0)},{pos:q}={...R,...I};for(const tt of this.layers){if(tt instanceof E.TileLayer&&(tt.tilemap.pos=tt.tilemap.pos.add(q),Z.add(tt.tilemap)),tt instanceof S.IsoTileLayer&&Z.add(tt.isometricMap),tt instanceof W.ObjectLayer)for(const X of tt.entities){const j=X.get(f.TransformComponent);j&&(j.pos=j.pos.add(q)),Z.add(X)}tt instanceof nt.ImageLayer&&tt.imageActor&&(tt.imageActor.pos=tt.imageActor.pos.add(q),Z.add(tt.imageActor))}if(this.useExcaliburWiring){const tt=this.getObjectsByProperty(Q.ExcaliburTiledProperties.Camera.Camera,!0);if(tt&&tt.length){const X=tt[0];let j=1;const F=X.properties.get(Q.ExcaliburTiledProperties.Camera.Zoom);F&&typeof F=="number"&&(j=F),this.map.orientation==="isometric"?Z.camera.pos=this.isometricTiledCoordToWorld(X.x,X.y):Z.camera.pos=(0,f.vec)(X.x,X.y),Z.camera.zoom=j}}if(this.useTilemapCameraStrategy){const tt=this.getTileLayers()[0];if(tt){const X=f.BoundingBox.fromDimension(this.map.width*this.map.tilewidth,this.map.height*this.map.tileheight,f.Vector.Zero,q.add(tt.tilemap.pos));Z.camera.strategy.limitCameraBounds(X)}}this.useMapBackgroundColor&&this.map.backgroundcolor&&(Z.backgroundColor=f.Color.fromHex(this.map.backgroundcolor))}isometricTiledCoordToWorld(Z,I){const R=this.map.tilewidth,q=this.map.tileheight,tt=I/q,X=Z/q;return(0,f.vec)((X-tt)*R/2+0,(X+tt)*q/2)}isLoaded(){return!!this.map}}et.supportedTiledVersion="1.10.1"},"./src/resource/tileset-resource.ts":(A,y,w)=>{w.r(y),w.d(y,{TilesetResource:()=>D});var f=w("excalibur"),T=w("./src/resource/tileset.ts"),C=w("./src/parser/tiled-parser.ts"),S=w("./src/resource/file-loader.ts"),E=w("./src/resource/path-util.ts"),W=w("./src/resource/loader-cache.ts");class D{constructor(k,N,Q){this.path=k,this.strict=!0,this.headless=!1,this.orientation="orthogonal",this.fileLoader=S.FetchLoader;const{fileLoader:L,parser:O,pathMap:Y,imageLoader:ot,strict:nt,headless:et,orientation:ut}={...Q};this.headless=et??this.headless,this.orientation=ut??this.orientation,this.strict=nt??this.strict,this.fileLoader=L??this.fileLoader,this.imageLoader=ot??new W.LoaderCache(f.ImageSource),this.parser=O??new C.TiledParser,this.firstGid=N,this.pathMap=Y}async load(){const k=this.path.includes(".tsx")?"xml":"json";try{const N=await this.fileLoader(this.path,k);let Q;if(Q=k==="json"?this.strict?C.TiledTilesetFile.parse(N):N:this.parser.parseExternalTileset(N,this.strict),(0,C.isTiledTilesetSingleImage)(Q)){const L=(0,E.pathRelativeToBase)(this.path,Q.image,this.pathMap),O=this.headless?void 0:this.imageLoader.getOrAdd(L);this.data=new T.Tileset({name:Q.name,tiledTileset:Q,firstGid:this.firstGid,image:O})}if((0,C.isTiledTilesetCollectionOfImages)(Q)){const L=this.headless?void 0:new Map;if(L){const O=[];if(Q.tiles){for(let Y of Q.tiles)if(Y.image){const ot=(0,E.pathRelativeToBase)(this.path,Y.image,this.pathMap),nt=this.imageLoader.getOrAdd(ot);L.set(Y,nt),O.push(nt)}}}Q.firstgid=this.firstGid,this.data=new T.Tileset({name:Q.name,tiledTileset:Q,firstGid:this.firstGid,tileToImage:L})}if(this.headless||await this.imageLoader.load(),this.data)return this.data}catch(N){throw console.error(`Could not load tileset at path ${this.path}`),N}throw new Error(`No tileset at path ${this.path}`)}isLoaded(){return!!this.data}}},"./src/resource/tileset.ts":(A,y,w)=>{w.r(y),w.d(y,{Tile:()=>D,Tileset:()=>H});var f=w("excalibur"),T=w("./src/resource/gid-util.ts"),C=w("./src/parser/tiled-parser.ts"),S=w("./src/resource/objects.ts"),E=w("./src/resource/properties.ts"),W=w("./src/resource/filter-util.ts");class D{constructor(N){this.objects=[],this.colliders=[],this.animation=[],this.properties=new Map;const{id:Q,tileset:L,tiledTile:O}=N;this.id=Q,this.tileset=L,this.tiledTile=O,this.class=O.type,(0,E.mapProps)(this,O.properties),O.objectgroup&&O.objectgroup.objects&&(this.objects=(0,S.parseObjects)(O.objectgroup)),O.animation&&(this.animation=O.animation)}}class H{constructor(N){var Q,L,O,Y,ot,nt,et,ut,Z,I;this.firstGid=-1,this.tileCount=0,this.tileWidth=0,this.tileHeight=0,this.tileOffset=(0,f.vec)(0,0),this.tiles=[],this.objectalignment="bottomleft",this.orientation="orthogonal",this.properties=new Map;const{name:R,tiledTileset:q,image:tt,tileToImage:X,firstGid:j}=N;if(this.name=R,this.tiledTileset=q,this.firstGid=j,(0,C.isTiledTilesetSingleImage)(q)){(0,E.mapProps)(this,q.properties);const F=q.spacing,St=Math.floor((q.imagewidth+F)/(q.tilewidth+F)),Dt=Math.floor((q.imageheight+F)/(q.tileheight+F));if(this.class=q.class,this.orientation=(L=(Q=q.grid)===null||Q===void 0?void 0:Q.orientation)!==null&&L!==void 0?L:"orthogonal",this.horizontalFlipTransform=f.AffineMatrix.identity().translate(q.tilewidth,0).scale(-1,1),this.verticalFlipTransform=f.AffineMatrix.identity().translate(0,q.tileheight).scale(1,-1),this.diagonalFlipTransform=f.AffineMatrix.identity().translate(0,0).rotate(-Math.PI/2).scale(-1,1),this.objectalignment=(O=q.objectalignment)!==null&&O!==void 0?O:this.orientation==="orthogonal"?"bottomleft":"bottom",tt&&(this.spritesheet=f.SpriteSheet.fromImageSource({image:tt,grid:{rows:Dt,columns:St,spriteWidth:q.tilewidth,spriteHeight:q.tileheight},spacing:{originOffset:{x:(Y=q.margin)!==null&&Y!==void 0?Y:0,y:(ot=q.margin)!==null&&ot!==void 0?ot:0},margin:{x:(nt=q.spacing)!==null&&nt!==void 0?nt:0,y:(et=q.spacing)!==null&&et!==void 0?et:0}}})),this.tileCount=q.tilecount,this.tileWidth=q.tilewidth,this.tileHeight=q.tileheight,q.tileoffset&&(this.tileOffset=(0,f.vec)(q.tileoffset.x,q.tileoffset.y)),q.tiles)for(const ht of q.tiles)this.tiles.push(new D({id:ht.id,tileset:this,tiledTile:ht,image:tt}))}if((0,C.isTiledTilesetCollectionOfImages)(q)&&q.firstgid!==void 0){this.horizontalFlipTransform=f.AffineMatrix.identity().translate(q.tilewidth,0).scale(-1,1),this.verticalFlipTransform=f.AffineMatrix.identity().translate(0,q.tileheight).scale(1,-1),this.diagonalFlipTransform=f.AffineMatrix.identity().translate(0,0).rotate(-Math.PI/2).scale(-1,1),this.objectalignment=(ut=q.objectalignment)!==null&&ut!==void 0?ut:this.orientation==="orthogonal"?"bottomleft":"bottom",this.orientation=(I=(Z=q.grid)===null||Z===void 0?void 0:Z.orientation)!==null&&I!==void 0?I:"orthogonal",this.tileCount=q.tilecount,this.tileWidth=q.tilewidth,this.tileHeight=q.tileheight,q.tileoffset&&(this.tileOffset=(0,f.vec)(q.tileoffset.x,q.tileoffset.y));let F=[];if(q.tiles)for(const St of q.tiles){const Dt=X==null?void 0:X.get(St);Dt&&F.push(Dt.toSprite()),this.tiles.push(new D({id:St.id,tileset:this,tiledTile:St,image:Dt}))}X&&(this.spritesheet=new f.SpriteSheet({sprites:F}))}}getTilesetAlignmentAnchor(N){switch(N??this.objectalignment){case"topleft":return(0,f.vec)(0,0);case"top":return(0,f.vec)(.5,0);case"topright":return(0,f.vec)(1,0);case"left":return(0,f.vec)(0,.5);case"center":return(0,f.vec)(.5,.5);case"right":return(0,f.vec)(1,.5);case"bottomleft":default:return(0,f.vec)(0,1);case"bottom":return(0,f.vec)(.5,1);case"bottomright":return(0,f.vec)(1,1)}}getTileByGid(N){const Q=(0,T.getCanonicalGid)(N)-this.firstGid;return this.tiles.find(L=>L.id===Q)}getTilesByClassName(N){return this.tiles.filter((0,W.byClassCaseInsensitive)(N))}getTilesByProperty(N,Q){return this.tiles.filter((0,W.byPropertyCaseInsensitive)(N,Q))}getSpriteForGid(N){const Q=(0,T.isFlippedHorizontally)(N),L=(0,T.isFlippedVertically)(N),O=(0,T.isFlippedDiagonally)(N),Y=(0,T.getCanonicalGid)(N),ot=Y-this.firstGid;if(this.spritesheet){let nt=this.spritesheet.sprites[ot];return(O||Q||L)&&(nt=nt.clone()),O&&(nt.rotation=-Math.PI/2,nt.scale=(0,f.vec)(-1,1)),Q&&(nt.scale=(0,f.vec)((O?1:-1)*nt.scale.x,(O?-1:1)*nt.scale.y)),L&&(nt.scale=(0,f.vec)((O?-1:1)*nt.scale.x,(O?1:-1)*nt.scale.y)),nt}throw new Error(`Tileset: [${this.name}] Could not find sprite for gid: [${N}] normalized gid: [${Y}]`)}_isometricTiledCoordToWorld(N){const Q=this.tileWidth,L=this.tileHeight/2,O=N.y/L,Y=N.x/L;return(0,f.vec)((Y-O)*Q/2+0,(Y+O)*L/2)}getCollidersForGid(N,Q){let{anchor:L,scale:O,orientationOverride:Y,offset:ot}={anchor:f.Vector.Zero,scale:f.Vector.One,offset:f.Vector.Zero,orientationOverride:void 0,...Q};const nt=Y??this.orientation,et=this.getTileByGid(N),ut=[];if(et&&et.objects)for(let Z of et.objects){if(Z instanceof S.Polygon){let I=Z.points.map(q=>q.scale(O));I=this._applyFlipsToPoints(I,N),nt==="isometric"&&(I=I.map(q=>this._isometricTiledCoordToWorld(q))),I=I.map(q=>q.add(ot));let R=f.Shape.Polygon(I,f.Vector.Zero,!0);R.isConvex()?ut.push(R):ut.push(R.triangulate())}if(Z instanceof S.Rectangle){let I=f.BoundingBox.fromDimension(Z.width*O.x,Z.height*O.y,L).getPoints().map(q=>q.add((0,f.vec)(Z.x,Z.y)));nt==="isometric"&&(I=I.map(q=>this._isometricTiledCoordToWorld(q))),I=this._applyFlipsToPoints(I,N),I=I.map(q=>q.add(ot));const R=f.Shape.Polygon(I);ut.push(R)}if(Z instanceof S.Ellipse){let I=(0,f.vec)(Z.x,Z.y);nt==="isometric"&&(I=this._isometricTiledCoordToWorld(I)),I=I.add(ot);const R=Math.min(Z.width/2,Z.height/2),q=f.Shape.Circle(R,I.scale(O));ut.push(q)}}return ut}_applyFlipsToPoints(N,Q){const L=(0,T.isFlippedHorizontally)(Q),O=(0,T.isFlippedVertically)(Q);return(0,T.isFlippedDiagonally)(Q)&&(N=N.map(Y=>this.diagonalFlipTransform.multiply(Y))),L&&(N=N.map(Y=>this.horizontalFlipTransform.multiply(Y))),O&&(N=N.map(Y=>this.verticalFlipTransform.multiply(Y))),N}getAnimationForGid(N){var Q;const L=this.getTileByGid(N);if(L&&(!((Q=L.animation)===null||Q===void 0)&&Q.length)){let O=[];for(let Y of L.animation)O.push({graphic:this.getSpriteForGid(Y.tileid+this.firstGid),duration:Y.duration});return new f.Animation({frames:O,strategy:f.AnimationStrategy.Loop})}return null}}},excalibur:A=>{A.exports=r},jsdom:A=>{if(i===void 0){var y=new Error("Cannot find module 'jsdom'");throw y.code="MODULE_NOT_FOUND",y}A.exports=i},"./node_modules/zod/lib/index.mjs":(A,y,w)=>{var f,T;w.r(y),w.d(y,{BRAND:()=>qo,DIRTY:()=>et,EMPTY_PATH:()=>O,INVALID:()=>nt,NEVER:()=>bn,OK:()=>ut,ParseStatus:()=>ot,Schema:()=>Ct,ZodAny:()=>si,ZodArray:()=>xi,ZodBigInt:()=>he,ZodBoolean:()=>se,ZodBranded:()=>pn,ZodCatch:()=>gr,ZodDate:()=>Xt,ZodDefault:()=>ur,ZodDiscriminatedUnion:()=>hr,ZodEffects:()=>Oi,ZodEnum:()=>ds,ZodError:()=>D,ZodFirstPartyTypeKind:()=>te,ZodFunction:()=>pe,ZodIntersection:()=>Os,ZodIssueCode:()=>E,ZodLazy:()=>lr,ZodLiteral:()=>cr,ZodMap:()=>Fi,ZodNaN:()=>Fr,ZodNativeEnum:()=>dr,ZodNever:()=>ai,ZodNull:()=>oi,ZodNullable:()=>us,ZodNumber:()=>Jt,ZodObject:()=>Pe,ZodOptional:()=>bi,ZodParsedType:()=>C,ZodPipeline:()=>fr,ZodPromise:()=>Hs,ZodReadonly:()=>_r,ZodRecord:()=>Ze,ZodSchema:()=>Ct,ZodSet:()=>pi,ZodString:()=>Gt,ZodSymbol:()=>Se,ZodTransformer:()=>Oi,ZodTuple:()=>Gi,ZodType:()=>Ct,ZodUndefined:()=>Me,ZodUnion:()=>Es,ZodUnknown:()=>Ri,ZodVoid:()=>Rr,addIssueToContext:()=>Y,any:()=>Xo,array:()=>pr,bigint:()=>Yo,boolean:()=>We,coerce:()=>Gr,custom:()=>Zn,date:()=>vn,datetimeRegex:()=>Bt,default:()=>Cn,defaultErrorMap:()=>H,discriminatedUnion:()=>Ws,effect:()=>fs,enum:()=>Jo,function:()=>Ur,getErrorMap:()=>Q,getParsedType:()=>S,instanceof:()=>Vo,intersection:()=>qs,isAborted:()=>Z,isAsync:()=>q,isDirty:()=>I,isValid:()=>R,late:()=>Mr,lazy:()=>wn,literal:()=>$o,makeIssue:()=>L,map:()=>Lr,nan:()=>jo,nativeEnum:()=>yn,never:()=>hi,null:()=>$n,nullable:()=>Is,number:()=>mn,object:()=>Xi,objectUtil:()=>T,oboolean:()=>ne,onumber:()=>Nr,optional:()=>Ae,ostring:()=>De,pipeline:()=>xn,preprocess:()=>Ar,promise:()=>Ko,quotelessJson:()=>W,record:()=>Qr,set:()=>zr,setErrorMap:()=>N,strictObject:()=>Zo,string:()=>An,symbol:()=>gs,transformer:()=>fs,tuple:()=>kr,undefined:()=>as,union:()=>Zi,unknown:()=>Hi,util:()=>f,void:()=>Ot,z:()=>Cn}),function(G){G.assertEqual=m=>m,G.assertIs=function(m){},G.assertNever=function(m){throw new Error},G.arrayToEnum=m=>{const b={};for(const M of m)b[M]=M;return b},G.getValidEnumValues=m=>{const b=G.objectKeys(m).filter(K=>typeof m[m[K]]!="number"),M={};for(const K of b)M[K]=m[K];return G.objectValues(M)},G.objectValues=m=>G.objectKeys(m).map(function(b){return m[b]}),G.objectKeys=typeof Object.keys=="function"?m=>Object.keys(m):m=>{const b=[];for(const M in m)Object.prototype.hasOwnProperty.call(m,M)&&b.push(M);return b},G.find=(m,b)=>{for(const M of m)if(b(M))return M},G.isInteger=typeof Number.isInteger=="function"?m=>Number.isInteger(m):m=>typeof m=="number"&&isFinite(m)&&Math.floor(m)===m,G.joinValues=function(m,b=" | "){return m.map(M=>typeof M=="string"?`'${M}'`:M).join(b)},G.jsonStringifyReplacer=(m,b)=>typeof b=="bigint"?b.toString():b}(f||(f={})),function(G){G.mergeShapes=(m,b)=>({...m,...b})}(T||(T={}));const C=f.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),S=G=>{switch(typeof G){case"undefined":return C.undefined;case"string":return C.string;case"number":return isNaN(G)?C.nan:C.number;case"boolean":return C.boolean;case"function":return C.function;case"bigint":return C.bigint;case"symbol":return C.symbol;case"object":return Array.isArray(G)?C.array:G===null?C.null:G.then&&typeof G.then=="function"&&G.catch&&typeof G.catch=="function"?C.promise:typeof Map<"u"&&G instanceof Map?C.map:typeof Set<"u"&&G instanceof Set?C.set:typeof Date<"u"&&G instanceof Date?C.date:C.object;default:return C.unknown}},E=f.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),W=G=>JSON.stringify(G,null,2).replace(/"([^"]+)":/g,"$1:");class D extends Error{get errors(){return this.issues}constructor(m){super(),this.issues=[],this.addIssue=M=>{this.issues=[...this.issues,M]},this.addIssues=(M=[])=>{this.issues=[...this.issues,...M]};const b=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,b):this.__proto__=b,this.name="ZodError",this.issues=m}format(m){const b=m||function(Rt){return Rt.message},M={_errors:[]},K=Rt=>{for(const dt of Rt.issues)if(dt.code==="invalid_union")dt.unionErrors.map(K);else if(dt.code==="invalid_return_type")K(dt.returnTypeError);else if(dt.code==="invalid_arguments")K(dt.argumentsError);else if(dt.path.length===0)M._errors.push(b(dt));else{let Tt=M,zt=0;for(;zt<dt.path.length;){const Vt=dt.path[zt];zt===dt.path.length-1?(Tt[Vt]=Tt[Vt]||{_errors:[]},Tt[Vt]._errors.push(b(dt))):Tt[Vt]=Tt[Vt]||{_errors:[]},Tt=Tt[Vt],zt++}}};return K(this),M}static assert(m){if(!(m instanceof D))throw new Error(`Not a ZodError: ${m}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,f.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(m=b=>b.message){const b={},M=[];for(const K of this.issues)K.path.length>0?(b[K.path[0]]=b[K.path[0]]||[],b[K.path[0]].push(m(K))):M.push(m(K));return{formErrors:M,fieldErrors:b}}get formErrors(){return this.flatten()}}D.create=G=>new D(G);const H=(G,m)=>{let b;switch(G.code){case E.invalid_type:b=G.received===C.undefined?"Required":`Expected ${G.expected}, received ${G.received}`;break;case E.invalid_literal:b=`Invalid literal value, expected ${JSON.stringify(G.expected,f.jsonStringifyReplacer)}`;break;case E.unrecognized_keys:b=`Unrecognized key(s) in object: ${f.joinValues(G.keys,", ")}`;break;case E.invalid_union:b="Invalid input";break;case E.invalid_union_discriminator:b=`Invalid discriminator value. Expected ${f.joinValues(G.options)}`;break;case E.invalid_enum_value:b=`Invalid enum value. Expected ${f.joinValues(G.options)}, received '${G.received}'`;break;case E.invalid_arguments:b="Invalid function arguments";break;case E.invalid_return_type:b="Invalid function return type";break;case E.invalid_date:b="Invalid date";break;case E.invalid_string:typeof G.validation=="object"?"includes"in G.validation?(b=`Invalid input: must include "${G.validation.includes}"`,typeof G.validation.position=="number"&&(b=`${b} at one or more positions greater than or equal to ${G.validation.position}`)):"startsWith"in G.validation?b=`Invalid input: must start with "${G.validation.startsWith}"`:"endsWith"in G.validation?b=`Invalid input: must end with "${G.validation.endsWith}"`:f.assertNever(G.validation):b=G.validation!=="regex"?`Invalid ${G.validation}`:"Invalid";break;case E.too_small:b=G.type==="array"?`Array must contain ${G.exact?"exactly":G.inclusive?"at least":"more than"} ${G.minimum} element(s)`:G.type==="string"?`String must contain ${G.exact?"exactly":G.inclusive?"at least":"over"} ${G.minimum} character(s)`:G.type==="number"?`Number must be ${G.exact?"exactly equal to ":G.inclusive?"greater than or equal to ":"greater than "}${G.minimum}`:G.type==="date"?`Date must be ${G.exact?"exactly equal to ":G.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(G.minimum))}`:"Invalid input";break;case E.too_big:b=G.type==="array"?`Array must contain ${G.exact?"exactly":G.inclusive?"at most":"less than"} ${G.maximum} element(s)`:G.type==="string"?`String must contain ${G.exact?"exactly":G.inclusive?"at most":"under"} ${G.maximum} character(s)`:G.type==="number"?`Number must be ${G.exact?"exactly":G.inclusive?"less than or equal to":"less than"} ${G.maximum}`:G.type==="bigint"?`BigInt must be ${G.exact?"exactly":G.inclusive?"less than or equal to":"less than"} ${G.maximum}`:G.type==="date"?`Date must be ${G.exact?"exactly":G.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(G.maximum))}`:"Invalid input";break;case E.custom:b="Invalid input";break;case E.invalid_intersection_types:b="Intersection results could not be merged";break;case E.not_multiple_of:b=`Number must be a multiple of ${G.multipleOf}`;break;case E.not_finite:b="Number must be finite";break;default:b=m.defaultError,f.assertNever(G)}return{message:b}};let k=H;function N(G){k=G}function Q(){return k}const L=G=>{const{data:m,path:b,errorMaps:M,issueData:K}=G,Rt=[...b,...K.path||[]],dt={...K,path:Rt};if(K.message!==void 0)return{...K,path:Rt,message:K.message};let Tt="";const zt=M.filter(Vt=>!!Vt).slice().reverse();for(const Vt of zt)Tt=Vt(dt,{data:m,defaultError:Tt}).message;return{...K,path:Rt,message:Tt}},O=[];function Y(G,m){const b=Q(),M=L({issueData:m,data:G.data,path:G.path,errorMaps:[G.common.contextualErrorMap,G.schemaErrorMap,b,b===H?void 0:H].filter(K=>!!K)});G.common.issues.push(M)}class ot{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(m,b){const M=[];for(const K of b){if(K.status==="aborted")return nt;K.status==="dirty"&&m.dirty(),M.push(K.value)}return{status:m.value,value:M}}static async mergeObjectAsync(m,b){const M=[];for(const K of b){const Rt=await K.key,dt=await K.value;M.push({key:Rt,value:dt})}return ot.mergeObjectSync(m,M)}static mergeObjectSync(m,b){const M={};for(const K of b){const{key:Rt,value:dt}=K;if(Rt.status==="aborted"||dt.status==="aborted")return nt;Rt.status==="dirty"&&m.dirty(),dt.status==="dirty"&&m.dirty(),Rt.value==="__proto__"||dt.value===void 0&&!K.alwaysSet||(M[Rt.value]=dt.value)}return{status:m.value,value:M}}}const nt=Object.freeze({status:"aborted"}),et=G=>({status:"dirty",value:G}),ut=G=>({status:"valid",value:G}),Z=G=>G.status==="aborted",I=G=>G.status==="dirty",R=G=>G.status==="valid",q=G=>typeof Promise<"u"&&G instanceof Promise;function tt(G,m,b,M){if(typeof m=="function"?G!==m||!M:!m.has(G))throw new TypeError("Cannot read private member from an object whose class did not declare it");return m.get(G)}function X(G,m,b,M,K){if(typeof m=="function"?G!==m||!K:!m.has(G))throw new TypeError("Cannot write private member to an object whose class did not declare it");return m.set(G,b),b}var j,F,St;typeof SuppressedError=="function"&&SuppressedError,function(G){G.errToObj=m=>typeof m=="string"?{message:m}:m||{},G.toString=m=>typeof m=="string"?m:m==null?void 0:m.message}(j||(j={}));class Dt{constructor(m,b,M,K){this._cachedPath=[],this.parent=m,this.data=b,this._path=M,this._key=K}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const ht=(G,m)=>{if(R(m))return{success:!0,data:m.value};if(!G.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const b=new D(G.common.issues);return this._error=b,this._error}}};function Mt(G){if(!G)return{};const{errorMap:m,invalid_type_error:b,required_error:M,description:K}=G;if(m&&(b||M))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return m?{errorMap:m,description:K}:{errorMap:(Rt,dt)=>{var Tt,zt;const{message:Vt}=G;return Rt.code==="invalid_enum_value"?{message:Vt??dt.defaultError}:dt.data===void 0?{message:(Tt=Vt??M)!==null&&Tt!==void 0?Tt:dt.defaultError}:Rt.code!=="invalid_type"?{message:dt.defaultError}:{message:(zt=Vt??b)!==null&&zt!==void 0?zt:dt.defaultError}},description:K}}class Ct{get description(){return this._def.description}_getType(m){return S(m.data)}_getOrReturnCtx(m,b){return b||{common:m.parent.common,data:m.data,parsedType:S(m.data),schemaErrorMap:this._def.errorMap,path:m.path,parent:m.parent}}_processInputParams(m){return{status:new ot,ctx:{common:m.parent.common,data:m.data,parsedType:S(m.data),schemaErrorMap:this._def.errorMap,path:m.path,parent:m.parent}}}_parseSync(m){const b=this._parse(m);if(q(b))throw new Error("Synchronous parse encountered promise.");return b}_parseAsync(m){const b=this._parse(m);return Promise.resolve(b)}parse(m,b){const M=this.safeParse(m,b);if(M.success)return M.data;throw M.error}safeParse(m,b){var M;const K={common:{issues:[],async:(M=b==null?void 0:b.async)!==null&&M!==void 0&&M,contextualErrorMap:b==null?void 0:b.errorMap},path:(b==null?void 0:b.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:m,parsedType:S(m)},Rt=this._parseSync({data:m,path:K.path,parent:K});return ht(K,Rt)}"~validate"(m){var b,M;const K={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:m,parsedType:S(m)};if(!this["~standard"].async)try{const Rt=this._parseSync({data:m,path:[],parent:K});return R(Rt)?{value:Rt.value}:{issues:K.common.issues}}catch(Rt){!((M=(b=Rt==null?void 0:Rt.message)===null||b===void 0?void 0:b.toLowerCase())===null||M===void 0)&&M.includes("encountered")&&(this["~standard"].async=!0),K.common={issues:[],async:!0}}return this._parseAsync({data:m,path:[],parent:K}).then(Rt=>R(Rt)?{value:Rt.value}:{issues:K.common.issues})}async parseAsync(m,b){const M=await this.safeParseAsync(m,b);if(M.success)return M.data;throw M.error}async safeParseAsync(m,b){const M={common:{issues:[],contextualErrorMap:b==null?void 0:b.errorMap,async:!0},path:(b==null?void 0:b.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:m,parsedType:S(m)},K=this._parse({data:m,path:M.path,parent:M}),Rt=await(q(K)?K:Promise.resolve(K));return ht(M,Rt)}refine(m,b){const M=K=>typeof b=="string"||b===void 0?{message:b}:typeof b=="function"?b(K):b;return this._refinement((K,Rt)=>{const dt=m(K),Tt=()=>Rt.addIssue({code:E.custom,...M(K)});return typeof Promise<"u"&&dt instanceof Promise?dt.then(zt=>!!zt||(Tt(),!1)):!!dt||(Tt(),!1)})}refinement(m,b){return this._refinement((M,K)=>!!m(M)||(K.addIssue(typeof b=="function"?b(M,K):b),!1))}_refinement(m){return new Oi({schema:this,typeName:te.ZodEffects,effect:{type:"refinement",refinement:m}})}superRefine(m){return this._refinement(m)}constructor(m){this.spa=this.safeParseAsync,this._def=m,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:b=>this["~validate"](b)}}optional(){return bi.create(this,this._def)}nullable(){return us.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return xi.create(this)}promise(){return Hs.create(this,this._def)}or(m){return Es.create([this,m],this._def)}and(m){return Os.create(this,m,this._def)}transform(m){return new Oi({...Mt(this._def),schema:this,typeName:te.ZodEffects,effect:{type:"transform",transform:m}})}default(m){const b=typeof m=="function"?m:()=>m;return new ur({...Mt(this._def),innerType:this,defaultValue:b,typeName:te.ZodDefault})}brand(){return new pn({typeName:te.ZodBranded,type:this,...Mt(this._def)})}catch(m){const b=typeof m=="function"?m:()=>m;return new gr({...Mt(this._def),innerType:this,catchValue:b,typeName:te.ZodCatch})}describe(m){return new this.constructor({...this._def,description:m})}pipe(m){return fr.create(this,m)}readonly(){return _r.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const Yt=/^c[^\s-]{8,}$/i,xt=/^[0-9a-z]+$/,yt=/^[0-9A-HJKMNP-TV-Z]{26}$/i,de=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Kt=/^[a-z0-9_-]{21}$/i,Ht=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Ie=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,it=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let x;const st=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,_t=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,V=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ft=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Lt=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Et=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,pt="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",mt=new RegExp(`^${pt}$`);function bt(G){let m="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return G.precision?m=`${m}\\.\\d{${G.precision}}`:G.precision==null&&(m=`${m}(\\.\\d+)?`),m}function Bt(G){let m=`${pt}T${bt(G)}`;const b=[];return b.push(G.local?"Z?":"Z"),G.offset&&b.push("([+-]\\d{2}:?\\d{2})"),m=`${m}(${b.join("|")})`,new RegExp(`^${m}$`)}function vt(G,m){if(!Ht.test(G))return!1;try{const[b]=G.split("."),M=b.replace(/-/g,"+").replace(/_/g,"/").padEnd(b.length+(4-b.length%4)%4,"="),K=JSON.parse(atob(M));return!(typeof K!="object"||K===null||!K.typ||!K.alg||m&&K.alg!==m)}catch{return!1}}function Ut(G,m){return!(m!=="v4"&&m||!_t.test(G))||!(m!=="v6"&&m||!Ft.test(G))}class Gt extends Ct{_parse(m){if(this._def.coerce&&(m.data=String(m.data)),this._getType(m)!==C.string){const dt=this._getOrReturnCtx(m);return Y(dt,{code:E.invalid_type,expected:C.string,received:dt.parsedType}),nt}const b=new ot;let M;for(const dt of this._def.checks)if(dt.kind==="min")m.data.length<dt.value&&(M=this._getOrReturnCtx(m,M),Y(M,{code:E.too_small,minimum:dt.value,type:"string",inclusive:!0,exact:!1,message:dt.message}),b.dirty());else if(dt.kind==="max")m.data.length>dt.value&&(M=this._getOrReturnCtx(m,M),Y(M,{code:E.too_big,maximum:dt.value,type:"string",inclusive:!0,exact:!1,message:dt.message}),b.dirty());else if(dt.kind==="length"){const Tt=m.data.length>dt.value,zt=m.data.length<dt.value;(Tt||zt)&&(M=this._getOrReturnCtx(m,M),Tt?Y(M,{code:E.too_big,maximum:dt.value,type:"string",inclusive:!0,exact:!0,message:dt.message}):zt&&Y(M,{code:E.too_small,minimum:dt.value,type:"string",inclusive:!0,exact:!0,message:dt.message}),b.dirty())}else if(dt.kind==="email")it.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"email",code:E.invalid_string,message:dt.message}),b.dirty());else if(dt.kind==="emoji")x||(x=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),x.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"emoji",code:E.invalid_string,message:dt.message}),b.dirty());else if(dt.kind==="uuid")de.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"uuid",code:E.invalid_string,message:dt.message}),b.dirty());else if(dt.kind==="nanoid")Kt.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"nanoid",code:E.invalid_string,message:dt.message}),b.dirty());else if(dt.kind==="cuid")Yt.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"cuid",code:E.invalid_string,message:dt.message}),b.dirty());else if(dt.kind==="cuid2")xt.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"cuid2",code:E.invalid_string,message:dt.message}),b.dirty());else if(dt.kind==="ulid")yt.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"ulid",code:E.invalid_string,message:dt.message}),b.dirty());else if(dt.kind==="url")try{new URL(m.data)}catch{M=this._getOrReturnCtx(m,M),Y(M,{validation:"url",code:E.invalid_string,message:dt.message}),b.dirty()}else dt.kind==="regex"?(dt.regex.lastIndex=0,dt.regex.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"regex",code:E.invalid_string,message:dt.message}),b.dirty())):dt.kind==="trim"?m.data=m.data.trim():dt.kind==="includes"?m.data.includes(dt.value,dt.position)||(M=this._getOrReturnCtx(m,M),Y(M,{code:E.invalid_string,validation:{includes:dt.value,position:dt.position},message:dt.message}),b.dirty()):dt.kind==="toLowerCase"?m.data=m.data.toLowerCase():dt.kind==="toUpperCase"?m.data=m.data.toUpperCase():dt.kind==="startsWith"?m.data.startsWith(dt.value)||(M=this._getOrReturnCtx(m,M),Y(M,{code:E.invalid_string,validation:{startsWith:dt.value},message:dt.message}),b.dirty()):dt.kind==="endsWith"?m.data.endsWith(dt.value)||(M=this._getOrReturnCtx(m,M),Y(M,{code:E.invalid_string,validation:{endsWith:dt.value},message:dt.message}),b.dirty()):dt.kind==="datetime"?Bt(dt).test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{code:E.invalid_string,validation:"datetime",message:dt.message}),b.dirty()):dt.kind==="date"?mt.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{code:E.invalid_string,validation:"date",message:dt.message}),b.dirty()):dt.kind==="time"?new RegExp(`^${bt(dt)}$`).test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{code:E.invalid_string,validation:"time",message:dt.message}),b.dirty()):dt.kind==="duration"?Ie.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"duration",code:E.invalid_string,message:dt.message}),b.dirty()):dt.kind==="ip"?(K=m.data,((Rt=dt.version)!=="v4"&&Rt||!st.test(K))&&(Rt!=="v6"&&Rt||!V.test(K))&&(M=this._getOrReturnCtx(m,M),Y(M,{validation:"ip",code:E.invalid_string,message:dt.message}),b.dirty())):dt.kind==="jwt"?vt(m.data,dt.alg)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"jwt",code:E.invalid_string,message:dt.message}),b.dirty()):dt.kind==="cidr"?Ut(m.data,dt.version)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"cidr",code:E.invalid_string,message:dt.message}),b.dirty()):dt.kind==="base64"?Lt.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"base64",code:E.invalid_string,message:dt.message}),b.dirty()):dt.kind==="base64url"?Et.test(m.data)||(M=this._getOrReturnCtx(m,M),Y(M,{validation:"base64url",code:E.invalid_string,message:dt.message}),b.dirty()):f.assertNever(dt);var K,Rt;return{status:b.value,value:m.data}}_regex(m,b,M){return this.refinement(K=>m.test(K),{validation:b,code:E.invalid_string,...j.errToObj(M)})}_addCheck(m){return new Gt({...this._def,checks:[...this._def.checks,m]})}email(m){return this._addCheck({kind:"email",...j.errToObj(m)})}url(m){return this._addCheck({kind:"url",...j.errToObj(m)})}emoji(m){return this._addCheck({kind:"emoji",...j.errToObj(m)})}uuid(m){return this._addCheck({kind:"uuid",...j.errToObj(m)})}nanoid(m){return this._addCheck({kind:"nanoid",...j.errToObj(m)})}cuid(m){return this._addCheck({kind:"cuid",...j.errToObj(m)})}cuid2(m){return this._addCheck({kind:"cuid2",...j.errToObj(m)})}ulid(m){return this._addCheck({kind:"ulid",...j.errToObj(m)})}base64(m){return this._addCheck({kind:"base64",...j.errToObj(m)})}base64url(m){return this._addCheck({kind:"base64url",...j.errToObj(m)})}jwt(m){return this._addCheck({kind:"jwt",...j.errToObj(m)})}ip(m){return this._addCheck({kind:"ip",...j.errToObj(m)})}cidr(m){return this._addCheck({kind:"cidr",...j.errToObj(m)})}datetime(m){var b,M;return typeof m=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:m}):this._addCheck({kind:"datetime",precision:(m==null?void 0:m.precision)===void 0?null:m==null?void 0:m.precision,offset:(b=m==null?void 0:m.offset)!==null&&b!==void 0&&b,local:(M=m==null?void 0:m.local)!==null&&M!==void 0&&M,...j.errToObj(m==null?void 0:m.message)})}date(m){return this._addCheck({kind:"date",message:m})}time(m){return typeof m=="string"?this._addCheck({kind:"time",precision:null,message:m}):this._addCheck({kind:"time",precision:(m==null?void 0:m.precision)===void 0?null:m==null?void 0:m.precision,...j.errToObj(m==null?void 0:m.message)})}duration(m){return this._addCheck({kind:"duration",...j.errToObj(m)})}regex(m,b){return this._addCheck({kind:"regex",regex:m,...j.errToObj(b)})}includes(m,b){return this._addCheck({kind:"includes",value:m,position:b==null?void 0:b.position,...j.errToObj(b==null?void 0:b.message)})}startsWith(m,b){return this._addCheck({kind:"startsWith",value:m,...j.errToObj(b)})}endsWith(m,b){return this._addCheck({kind:"endsWith",value:m,...j.errToObj(b)})}min(m,b){return this._addCheck({kind:"min",value:m,...j.errToObj(b)})}max(m,b){return this._addCheck({kind:"max",value:m,...j.errToObj(b)})}length(m,b){return this._addCheck({kind:"length",value:m,...j.errToObj(b)})}nonempty(m){return this.min(1,j.errToObj(m))}trim(){return new Gt({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Gt({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Gt({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(m=>m.kind==="datetime")}get isDate(){return!!this._def.checks.find(m=>m.kind==="date")}get isTime(){return!!this._def.checks.find(m=>m.kind==="time")}get isDuration(){return!!this._def.checks.find(m=>m.kind==="duration")}get isEmail(){return!!this._def.checks.find(m=>m.kind==="email")}get isURL(){return!!this._def.checks.find(m=>m.kind==="url")}get isEmoji(){return!!this._def.checks.find(m=>m.kind==="emoji")}get isUUID(){return!!this._def.checks.find(m=>m.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(m=>m.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(m=>m.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(m=>m.kind==="cuid2")}get isULID(){return!!this._def.checks.find(m=>m.kind==="ulid")}get isIP(){return!!this._def.checks.find(m=>m.kind==="ip")}get isCIDR(){return!!this._def.checks.find(m=>m.kind==="cidr")}get isBase64(){return!!this._def.checks.find(m=>m.kind==="base64")}get isBase64url(){return!!this._def.checks.find(m=>m.kind==="base64url")}get minLength(){let m=null;for(const b of this._def.checks)b.kind==="min"&&(m===null||b.value>m)&&(m=b.value);return m}get maxLength(){let m=null;for(const b of this._def.checks)b.kind==="max"&&(m===null||b.value<m)&&(m=b.value);return m}}function Nt(G,m){const b=(G.toString().split(".")[1]||"").length,M=(m.toString().split(".")[1]||"").length,K=b>M?b:M;return parseInt(G.toFixed(K).replace(".",""))%parseInt(m.toFixed(K).replace(".",""))/Math.pow(10,K)}Gt.create=G=>{var m;return new Gt({checks:[],typeName:te.ZodString,coerce:(m=G==null?void 0:G.coerce)!==null&&m!==void 0&&m,...Mt(G)})};class Jt extends Ct{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(m){if(this._def.coerce&&(m.data=Number(m.data)),this._getType(m)!==C.number){const K=this._getOrReturnCtx(m);return Y(K,{code:E.invalid_type,expected:C.number,received:K.parsedType}),nt}let b;const M=new ot;for(const K of this._def.checks)K.kind==="int"?f.isInteger(m.data)||(b=this._getOrReturnCtx(m,b),Y(b,{code:E.invalid_type,expected:"integer",received:"float",message:K.message}),M.dirty()):K.kind==="min"?(K.inclusive?m.data<K.value:m.data<=K.value)&&(b=this._getOrReturnCtx(m,b),Y(b,{code:E.too_small,minimum:K.value,type:"number",inclusive:K.inclusive,exact:!1,message:K.message}),M.dirty()):K.kind==="max"?(K.inclusive?m.data>K.value:m.data>=K.value)&&(b=this._getOrReturnCtx(m,b),Y(b,{code:E.too_big,maximum:K.value,type:"number",inclusive:K.inclusive,exact:!1,message:K.message}),M.dirty()):K.kind==="multipleOf"?Nt(m.data,K.value)!==0&&(b=this._getOrReturnCtx(m,b),Y(b,{code:E.not_multiple_of,multipleOf:K.value,message:K.message}),M.dirty()):K.kind==="finite"?Number.isFinite(m.data)||(b=this._getOrReturnCtx(m,b),Y(b,{code:E.not_finite,message:K.message}),M.dirty()):f.assertNever(K);return{status:M.value,value:m.data}}gte(m,b){return this.setLimit("min",m,!0,j.toString(b))}gt(m,b){return this.setLimit("min",m,!1,j.toString(b))}lte(m,b){return this.setLimit("max",m,!0,j.toString(b))}lt(m,b){return this.setLimit("max",m,!1,j.toString(b))}setLimit(m,b,M,K){return new Jt({...this._def,checks:[...this._def.checks,{kind:m,value:b,inclusive:M,message:j.toString(K)}]})}_addCheck(m){return new Jt({...this._def,checks:[...this._def.checks,m]})}int(m){return this._addCheck({kind:"int",message:j.toString(m)})}positive(m){return this._addCheck({kind:"min",value:0,inclusive:!1,message:j.toString(m)})}negative(m){return this._addCheck({kind:"max",value:0,inclusive:!1,message:j.toString(m)})}nonpositive(m){return this._addCheck({kind:"max",value:0,inclusive:!0,message:j.toString(m)})}nonnegative(m){return this._addCheck({kind:"min",value:0,inclusive:!0,message:j.toString(m)})}multipleOf(m,b){return this._addCheck({kind:"multipleOf",value:m,message:j.toString(b)})}finite(m){return this._addCheck({kind:"finite",message:j.toString(m)})}safe(m){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:j.toString(m)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:j.toString(m)})}get minValue(){let m=null;for(const b of this._def.checks)b.kind==="min"&&(m===null||b.value>m)&&(m=b.value);return m}get maxValue(){let m=null;for(const b of this._def.checks)b.kind==="max"&&(m===null||b.value<m)&&(m=b.value);return m}get isInt(){return!!this._def.checks.find(m=>m.kind==="int"||m.kind==="multipleOf"&&f.isInteger(m.value))}get isFinite(){let m=null,b=null;for(const M of this._def.checks){if(M.kind==="finite"||M.kind==="int"||M.kind==="multipleOf")return!0;M.kind==="min"?(b===null||M.value>b)&&(b=M.value):M.kind==="max"&&(m===null||M.value<m)&&(m=M.value)}return Number.isFinite(b)&&Number.isFinite(m)}}Jt.create=G=>new Jt({checks:[],typeName:te.ZodNumber,coerce:(G==null?void 0:G.coerce)||!1,...Mt(G)});class he extends Ct{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(m){if(this._def.coerce)try{m.data=BigInt(m.data)}catch{return this._getInvalidInput(m)}if(this._getType(m)!==C.bigint)return this._getInvalidInput(m);let b;const M=new ot;for(const K of this._def.checks)K.kind==="min"?(K.inclusive?m.data<K.value:m.data<=K.value)&&(b=this._getOrReturnCtx(m,b),Y(b,{code:E.too_small,type:"bigint",minimum:K.value,inclusive:K.inclusive,message:K.message}),M.dirty()):K.kind==="max"?(K.inclusive?m.data>K.value:m.data>=K.value)&&(b=this._getOrReturnCtx(m,b),Y(b,{code:E.too_big,type:"bigint",maximum:K.value,inclusive:K.inclusive,message:K.message}),M.dirty()):K.kind==="multipleOf"?m.data%K.value!==BigInt(0)&&(b=this._getOrReturnCtx(m,b),Y(b,{code:E.not_multiple_of,multipleOf:K.value,message:K.message}),M.dirty()):f.assertNever(K);return{status:M.value,value:m.data}}_getInvalidInput(m){const b=this._getOrReturnCtx(m);return Y(b,{code:E.invalid_type,expected:C.bigint,received:b.parsedType}),nt}gte(m,b){return this.setLimit("min",m,!0,j.toString(b))}gt(m,b){return this.setLimit("min",m,!1,j.toString(b))}lte(m,b){return this.setLimit("max",m,!0,j.toString(b))}lt(m,b){return this.setLimit("max",m,!1,j.toString(b))}setLimit(m,b,M,K){return new he({...this._def,checks:[...this._def.checks,{kind:m,value:b,inclusive:M,message:j.toString(K)}]})}_addCheck(m){return new he({...this._def,checks:[...this._def.checks,m]})}positive(m){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:j.toString(m)})}negative(m){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:j.toString(m)})}nonpositive(m){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:j.toString(m)})}nonnegative(m){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:j.toString(m)})}multipleOf(m,b){return this._addCheck({kind:"multipleOf",value:m,message:j.toString(b)})}get minValue(){let m=null;for(const b of this._def.checks)b.kind==="min"&&(m===null||b.value>m)&&(m=b.value);return m}get maxValue(){let m=null;for(const b of this._def.checks)b.kind==="max"&&(m===null||b.value<m)&&(m=b.value);return m}}he.create=G=>{var m;return new he({checks:[],typeName:te.ZodBigInt,coerce:(m=G==null?void 0:G.coerce)!==null&&m!==void 0&&m,...Mt(G)})};class se extends Ct{_parse(m){if(this._def.coerce&&(m.data=!!m.data),this._getType(m)!==C.boolean){const b=this._getOrReturnCtx(m);return Y(b,{code:E.invalid_type,expected:C.boolean,received:b.parsedType}),nt}return ut(m.data)}}se.create=G=>new se({typeName:te.ZodBoolean,coerce:(G==null?void 0:G.coerce)||!1,...Mt(G)});class Xt extends Ct{_parse(m){if(this._def.coerce&&(m.data=new Date(m.data)),this._getType(m)!==C.date){const K=this._getOrReturnCtx(m);return Y(K,{code:E.invalid_type,expected:C.date,received:K.parsedType}),nt}if(isNaN(m.data.getTime()))return Y(this._getOrReturnCtx(m),{code:E.invalid_date}),nt;const b=new ot;let M;for(const K of this._def.checks)K.kind==="min"?m.data.getTime()<K.value&&(M=this._getOrReturnCtx(m,M),Y(M,{code:E.too_small,message:K.message,inclusive:!0,exact:!1,minimum:K.value,type:"date"}),b.dirty()):K.kind==="max"?m.data.getTime()>K.value&&(M=this._getOrReturnCtx(m,M),Y(M,{code:E.too_big,message:K.message,inclusive:!0,exact:!1,maximum:K.value,type:"date"}),b.dirty()):f.assertNever(K);return{status:b.value,value:new Date(m.data.getTime())}}_addCheck(m){return new Xt({...this._def,checks:[...this._def.checks,m]})}min(m,b){return this._addCheck({kind:"min",value:m.getTime(),message:j.toString(b)})}max(m,b){return this._addCheck({kind:"max",value:m.getTime(),message:j.toString(b)})}get minDate(){let m=null;for(const b of this._def.checks)b.kind==="min"&&(m===null||b.value>m)&&(m=b.value);return m!=null?new Date(m):null}get maxDate(){let m=null;for(const b of this._def.checks)b.kind==="max"&&(m===null||b.value<m)&&(m=b.value);return m!=null?new Date(m):null}}Xt.create=G=>new Xt({checks:[],coerce:(G==null?void 0:G.coerce)||!1,typeName:te.ZodDate,...Mt(G)});class Se extends Ct{_parse(m){if(this._getType(m)!==C.symbol){const b=this._getOrReturnCtx(m);return Y(b,{code:E.invalid_type,expected:C.symbol,received:b.parsedType}),nt}return ut(m.data)}}Se.create=G=>new Se({typeName:te.ZodSymbol,...Mt(G)});class Me extends Ct{_parse(m){if(this._getType(m)!==C.undefined){const b=this._getOrReturnCtx(m);return Y(b,{code:E.invalid_type,expected:C.undefined,received:b.parsedType}),nt}return ut(m.data)}}Me.create=G=>new Me({typeName:te.ZodUndefined,...Mt(G)});class oi extends Ct{_parse(m){if(this._getType(m)!==C.null){const b=this._getOrReturnCtx(m);return Y(b,{code:E.invalid_type,expected:C.null,received:b.parsedType}),nt}return ut(m.data)}}oi.create=G=>new oi({typeName:te.ZodNull,...Mt(G)});class si extends Ct{constructor(){super(...arguments),this._any=!0}_parse(m){return ut(m.data)}}si.create=G=>new si({typeName:te.ZodAny,...Mt(G)});class Ri extends Ct{constructor(){super(...arguments),this._unknown=!0}_parse(m){return ut(m.data)}}Ri.create=G=>new Ri({typeName:te.ZodUnknown,...Mt(G)});class ai extends Ct{_parse(m){const b=this._getOrReturnCtx(m);return Y(b,{code:E.invalid_type,expected:C.never,received:b.parsedType}),nt}}ai.create=G=>new ai({typeName:te.ZodNever,...Mt(G)});class Rr extends Ct{_parse(m){if(this._getType(m)!==C.undefined){const b=this._getOrReturnCtx(m);return Y(b,{code:E.invalid_type,expected:C.void,received:b.parsedType}),nt}return ut(m.data)}}Rr.create=G=>new Rr({typeName:te.ZodVoid,...Mt(G)});class xi extends Ct{_parse(m){const{ctx:b,status:M}=this._processInputParams(m),K=this._def;if(b.parsedType!==C.array)return Y(b,{code:E.invalid_type,expected:C.array,received:b.parsedType}),nt;if(K.exactLength!==null){const dt=b.data.length>K.exactLength.value,Tt=b.data.length<K.exactLength.value;(dt||Tt)&&(Y(b,{code:dt?E.too_big:E.too_small,minimum:Tt?K.exactLength.value:void 0,maximum:dt?K.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:K.exactLength.message}),M.dirty())}if(K.minLength!==null&&b.data.length<K.minLength.value&&(Y(b,{code:E.too_small,minimum:K.minLength.value,type:"array",inclusive:!0,exact:!1,message:K.minLength.message}),M.dirty()),K.maxLength!==null&&b.data.length>K.maxLength.value&&(Y(b,{code:E.too_big,maximum:K.maxLength.value,type:"array",inclusive:!0,exact:!1,message:K.maxLength.message}),M.dirty()),b.common.async)return Promise.all([...b.data].map((dt,Tt)=>K.type._parseAsync(new Dt(b,dt,b.path,Tt)))).then(dt=>ot.mergeArray(M,dt));const Rt=[...b.data].map((dt,Tt)=>K.type._parseSync(new Dt(b,dt,b.path,Tt)));return ot.mergeArray(M,Rt)}get element(){return this._def.type}min(m,b){return new xi({...this._def,minLength:{value:m,message:j.toString(b)}})}max(m,b){return new xi({...this._def,maxLength:{value:m,message:j.toString(b)}})}length(m,b){return new xi({...this._def,exactLength:{value:m,message:j.toString(b)}})}nonempty(m){return this.min(1,m)}}function ar(G){if(G instanceof Pe){const m={};for(const b in G.shape){const M=G.shape[b];m[b]=bi.create(ar(M))}return new Pe({...G._def,shape:()=>m})}return G instanceof xi?new xi({...G._def,type:ar(G.element)}):G instanceof bi?bi.create(ar(G.unwrap())):G instanceof us?us.create(ar(G.unwrap())):G instanceof Gi?Gi.create(G.items.map(m=>ar(m))):G}xi.create=(G,m)=>new xi({type:G,minLength:null,maxLength:null,exactLength:null,typeName:te.ZodArray,...Mt(m)});class Pe extends Ct{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const m=this._def.shape(),b=f.objectKeys(m);return this._cached={shape:m,keys:b}}_parse(m){if(this._getType(m)!==C.object){const zt=this._getOrReturnCtx(m);return Y(zt,{code:E.invalid_type,expected:C.object,received:zt.parsedType}),nt}const{status:b,ctx:M}=this._processInputParams(m),{shape:K,keys:Rt}=this._getCached(),dt=[];if(!(this._def.catchall instanceof ai&&this._def.unknownKeys==="strip"))for(const zt in M.data)Rt.includes(zt)||dt.push(zt);const Tt=[];for(const zt of Rt){const Vt=K[zt],Re=M.data[zt];Tt.push({key:{status:"valid",value:zt},value:Vt._parse(new Dt(M,Re,M.path,zt)),alwaysSet:zt in M.data})}if(this._def.catchall instanceof ai){const zt=this._def.unknownKeys;if(zt==="passthrough")for(const Vt of dt)Tt.push({key:{status:"valid",value:Vt},value:{status:"valid",value:M.data[Vt]}});else if(zt==="strict")dt.length>0&&(Y(M,{code:E.unrecognized_keys,keys:dt}),b.dirty());else if(zt!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const zt=this._def.catchall;for(const Vt of dt){const Re=M.data[Vt];Tt.push({key:{status:"valid",value:Vt},value:zt._parse(new Dt(M,Re,M.path,Vt)),alwaysSet:Vt in M.data})}}return M.common.async?Promise.resolve().then(async()=>{const zt=[];for(const Vt of Tt){const Re=await Vt.key,hs=await Vt.value;zt.push({key:Re,value:hs,alwaysSet:Vt.alwaysSet})}return zt}).then(zt=>ot.mergeObjectSync(b,zt)):ot.mergeObjectSync(b,Tt)}get shape(){return this._def.shape()}strict(m){return j.errToObj,new Pe({...this._def,unknownKeys:"strict",...m!==void 0?{errorMap:(b,M)=>{var K,Rt,dt,Tt;const zt=(dt=(Rt=(K=this._def).errorMap)===null||Rt===void 0?void 0:Rt.call(K,b,M).message)!==null&&dt!==void 0?dt:M.defaultError;return b.code==="unrecognized_keys"?{message:(Tt=j.errToObj(m).message)!==null&&Tt!==void 0?Tt:zt}:{message:zt}}}:{}})}strip(){return new Pe({...this._def,unknownKeys:"strip"})}passthrough(){return new Pe({...this._def,unknownKeys:"passthrough"})}extend(m){return new Pe({...this._def,shape:()=>({...this._def.shape(),...m})})}merge(m){return new Pe({unknownKeys:m._def.unknownKeys,catchall:m._def.catchall,shape:()=>({...this._def.shape(),...m._def.shape()}),typeName:te.ZodObject})}setKey(m,b){return this.augment({[m]:b})}catchall(m){return new Pe({...this._def,catchall:m})}pick(m){const b={};return f.objectKeys(m).forEach(M=>{m[M]&&this.shape[M]&&(b[M]=this.shape[M])}),new Pe({...this._def,shape:()=>b})}omit(m){const b={};return f.objectKeys(this.shape).forEach(M=>{m[M]||(b[M]=this.shape[M])}),new Pe({...this._def,shape:()=>b})}deepPartial(){return ar(this)}partial(m){const b={};return f.objectKeys(this.shape).forEach(M=>{const K=this.shape[M];m&&!m[M]?b[M]=K:b[M]=K.optional()}),new Pe({...this._def,shape:()=>b})}required(m){const b={};return f.objectKeys(this.shape).forEach(M=>{if(m&&!m[M])b[M]=this.shape[M];else{let K=this.shape[M];for(;K instanceof bi;)K=K._def.innerType;b[M]=K}}),new Pe({...this._def,shape:()=>b})}keyof(){return Wo(f.objectKeys(this.shape))}}Pe.create=(G,m)=>new Pe({shape:()=>G,unknownKeys:"strip",catchall:ai.create(),typeName:te.ZodObject,...Mt(m)}),Pe.strictCreate=(G,m)=>new Pe({shape:()=>G,unknownKeys:"strict",catchall:ai.create(),typeName:te.ZodObject,...Mt(m)}),Pe.lazycreate=(G,m)=>new Pe({shape:G,unknownKeys:"strip",catchall:ai.create(),typeName:te.ZodObject,...Mt(m)});class Es extends Ct{_parse(m){const{ctx:b}=this._processInputParams(m),M=this._def.options;if(b.common.async)return Promise.all(M.map(async K=>{const Rt={...b,common:{...b.common,issues:[]},parent:null};return{result:await K._parseAsync({data:b.data,path:b.path,parent:Rt}),ctx:Rt}})).then(function(K){for(const dt of K)if(dt.result.status==="valid")return dt.result;for(const dt of K)if(dt.result.status==="dirty")return b.common.issues.push(...dt.ctx.common.issues),dt.result;const Rt=K.map(dt=>new D(dt.ctx.common.issues));return Y(b,{code:E.invalid_union,unionErrors:Rt}),nt});{let K;const Rt=[];for(const Tt of M){const zt={...b,common:{...b.common,issues:[]},parent:null},Vt=Tt._parseSync({data:b.data,path:b.path,parent:zt});if(Vt.status==="valid")return Vt;Vt.status!=="dirty"||K||(K={result:Vt,ctx:zt}),zt.common.issues.length&&Rt.push(zt.common.issues)}if(K)return b.common.issues.push(...K.ctx.common.issues),K.result;const dt=Rt.map(Tt=>new D(Tt));return Y(b,{code:E.invalid_union,unionErrors:dt}),nt}}get options(){return this._def.options}}Es.create=(G,m)=>new Es({options:G,typeName:te.ZodUnion,...Mt(m)});const cs=G=>G instanceof lr?cs(G.schema):G instanceof Oi?cs(G.innerType()):G instanceof cr?[G.value]:G instanceof ds?G.options:G instanceof dr?f.objectValues(G.enum):G instanceof ur?cs(G._def.innerType):G instanceof Me?[void 0]:G instanceof oi?[null]:G instanceof bi?[void 0,...cs(G.unwrap())]:G instanceof us?[null,...cs(G.unwrap())]:G instanceof pn||G instanceof _r?cs(G.unwrap()):G instanceof gr?cs(G._def.innerType):[];class hr extends Ct{_parse(m){const{ctx:b}=this._processInputParams(m);if(b.parsedType!==C.object)return Y(b,{code:E.invalid_type,expected:C.object,received:b.parsedType}),nt;const M=this.discriminator,K=b.data[M],Rt=this.optionsMap.get(K);return Rt?b.common.async?Rt._parseAsync({data:b.data,path:b.path,parent:b}):Rt._parseSync({data:b.data,path:b.path,parent:b}):(Y(b,{code:E.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[M]}),nt)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(m,b,M){const K=new Map;for(const Rt of b){const dt=cs(Rt.shape[m]);if(!dt.length)throw new Error(`A discriminator value for key \`${m}\` could not be extracted from all schema options`);for(const Tt of dt){if(K.has(Tt))throw new Error(`Discriminator property ${String(m)} has duplicate value ${String(Tt)}`);K.set(Tt,Rt)}}return new hr({typeName:te.ZodDiscriminatedUnion,discriminator:m,options:b,optionsMap:K,...Mt(M)})}}function _n(G,m){const b=S(G),M=S(m);if(G===m)return{valid:!0,data:G};if(b===C.object&&M===C.object){const K=f.objectKeys(m),Rt=f.objectKeys(G).filter(Tt=>K.indexOf(Tt)!==-1),dt={...G,...m};for(const Tt of Rt){const zt=_n(G[Tt],m[Tt]);if(!zt.valid)return{valid:!1};dt[Tt]=zt.data}return{valid:!0,data:dt}}if(b===C.array&&M===C.array){if(G.length!==m.length)return{valid:!1};const K=[];for(let Rt=0;Rt<G.length;Rt++){const dt=_n(G[Rt],m[Rt]);if(!dt.valid)return{valid:!1};K.push(dt.data)}return{valid:!0,data:K}}return b===C.date&&M===C.date&&+G==+m?{valid:!0,data:G}:{valid:!1}}class Os extends Ct{_parse(m){const{status:b,ctx:M}=this._processInputParams(m),K=(Rt,dt)=>{if(Z(Rt)||Z(dt))return nt;const Tt=_n(Rt.value,dt.value);return Tt.valid?((I(Rt)||I(dt))&&b.dirty(),{status:b.value,value:Tt.data}):(Y(M,{code:E.invalid_intersection_types}),nt)};return M.common.async?Promise.all([this._def.left._parseAsync({data:M.data,path:M.path,parent:M}),this._def.right._parseAsync({data:M.data,path:M.path,parent:M})]).then(([Rt,dt])=>K(Rt,dt)):K(this._def.left._parseSync({data:M.data,path:M.path,parent:M}),this._def.right._parseSync({data:M.data,path:M.path,parent:M}))}}Os.create=(G,m,b)=>new Os({left:G,right:m,typeName:te.ZodIntersection,...Mt(b)});class Gi extends Ct{_parse(m){const{status:b,ctx:M}=this._processInputParams(m);if(M.parsedType!==C.array)return Y(M,{code:E.invalid_type,expected:C.array,received:M.parsedType}),nt;if(M.data.length<this._def.items.length)return Y(M,{code:E.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),nt;!this._def.rest&&M.data.length>this._def.items.length&&(Y(M,{code:E.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),b.dirty());const K=[...M.data].map((Rt,dt)=>{const Tt=this._def.items[dt]||this._def.rest;return Tt?Tt._parse(new Dt(M,Rt,M.path,dt)):null}).filter(Rt=>!!Rt);return M.common.async?Promise.all(K).then(Rt=>ot.mergeArray(b,Rt)):ot.mergeArray(b,K)}get items(){return this._def.items}rest(m){return new Gi({...this._def,rest:m})}}Gi.create=(G,m)=>{if(!Array.isArray(G))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Gi({items:G,typeName:te.ZodTuple,rest:null,...Mt(m)})};class Ze extends Ct{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(m){const{status:b,ctx:M}=this._processInputParams(m);if(M.parsedType!==C.object)return Y(M,{code:E.invalid_type,expected:C.object,received:M.parsedType}),nt;const K=[],Rt=this._def.keyType,dt=this._def.valueType;for(const Tt in M.data)K.push({key:Rt._parse(new Dt(M,Tt,M.path,Tt)),value:dt._parse(new Dt(M,M.data[Tt],M.path,Tt)),alwaysSet:Tt in M.data});return M.common.async?ot.mergeObjectAsync(b,K):ot.mergeObjectSync(b,K)}get element(){return this._def.valueType}static create(m,b,M){return new Ze(b instanceof Ct?{keyType:m,valueType:b,typeName:te.ZodRecord,...Mt(M)}:{keyType:Gt.create(),valueType:m,typeName:te.ZodRecord,...Mt(b)})}}class Fi extends Ct{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(m){const{status:b,ctx:M}=this._processInputParams(m);if(M.parsedType!==C.map)return Y(M,{code:E.invalid_type,expected:C.map,received:M.parsedType}),nt;const K=this._def.keyType,Rt=this._def.valueType,dt=[...M.data.entries()].map(([Tt,zt],Vt)=>({key:K._parse(new Dt(M,Tt,M.path,[Vt,"key"])),value:Rt._parse(new Dt(M,zt,M.path,[Vt,"value"]))}));if(M.common.async){const Tt=new Map;return Promise.resolve().then(async()=>{for(const zt of dt){const Vt=await zt.key,Re=await zt.value;if(Vt.status==="aborted"||Re.status==="aborted")return nt;Vt.status!=="dirty"&&Re.status!=="dirty"||b.dirty(),Tt.set(Vt.value,Re.value)}return{status:b.value,value:Tt}})}{const Tt=new Map;for(const zt of dt){const Vt=zt.key,Re=zt.value;if(Vt.status==="aborted"||Re.status==="aborted")return nt;Vt.status!=="dirty"&&Re.status!=="dirty"||b.dirty(),Tt.set(Vt.value,Re.value)}return{status:b.value,value:Tt}}}}Fi.create=(G,m,b)=>new Fi({valueType:m,keyType:G,typeName:te.ZodMap,...Mt(b)});class pi extends Ct{_parse(m){const{status:b,ctx:M}=this._processInputParams(m);if(M.parsedType!==C.set)return Y(M,{code:E.invalid_type,expected:C.set,received:M.parsedType}),nt;const K=this._def;K.minSize!==null&&M.data.size<K.minSize.value&&(Y(M,{code:E.too_small,minimum:K.minSize.value,type:"set",inclusive:!0,exact:!1,message:K.minSize.message}),b.dirty()),K.maxSize!==null&&M.data.size>K.maxSize.value&&(Y(M,{code:E.too_big,maximum:K.maxSize.value,type:"set",inclusive:!0,exact:!1,message:K.maxSize.message}),b.dirty());const Rt=this._def.valueType;function dt(zt){const Vt=new Set;for(const Re of zt){if(Re.status==="aborted")return nt;Re.status==="dirty"&&b.dirty(),Vt.add(Re.value)}return{status:b.value,value:Vt}}const Tt=[...M.data.values()].map((zt,Vt)=>Rt._parse(new Dt(M,zt,M.path,Vt)));return M.common.async?Promise.all(Tt).then(zt=>dt(zt)):dt(Tt)}min(m,b){return new pi({...this._def,minSize:{value:m,message:j.toString(b)}})}max(m,b){return new pi({...this._def,maxSize:{value:m,message:j.toString(b)}})}size(m,b){return this.min(m,b).max(m,b)}nonempty(m){return this.min(1,m)}}pi.create=(G,m)=>new pi({valueType:G,minSize:null,maxSize:null,typeName:te.ZodSet,...Mt(m)});class pe extends Ct{constructor(){super(...arguments),this.validate=this.implement}_parse(m){const{ctx:b}=this._processInputParams(m);if(b.parsedType!==C.function)return Y(b,{code:E.invalid_type,expected:C.function,received:b.parsedType}),nt;function M(Tt,zt){return L({data:Tt,path:b.path,errorMaps:[b.common.contextualErrorMap,b.schemaErrorMap,Q(),H].filter(Vt=>!!Vt),issueData:{code:E.invalid_arguments,argumentsError:zt}})}function K(Tt,zt){return L({data:Tt,path:b.path,errorMaps:[b.common.contextualErrorMap,b.schemaErrorMap,Q(),H].filter(Vt=>!!Vt),issueData:{code:E.invalid_return_type,returnTypeError:zt}})}const Rt={errorMap:b.common.contextualErrorMap},dt=b.data;if(this._def.returns instanceof Hs){const Tt=this;return ut(async function(...zt){const Vt=new D([]),Re=await Tt._def.args.parseAsync(zt,Rt).catch(Or=>{throw Vt.addIssue(M(zt,Or)),Vt}),hs=await Reflect.apply(dt,this,Re);return await Tt._def.returns._def.type.parseAsync(hs,Rt).catch(Or=>{throw Vt.addIssue(K(hs,Or)),Vt})})}{const Tt=this;return ut(function(...zt){const Vt=Tt._def.args.safeParse(zt,Rt);if(!Vt.success)throw new D([M(zt,Vt.error)]);const Re=Reflect.apply(dt,this,Vt.data),hs=Tt._def.returns.safeParse(Re,Rt);if(!hs.success)throw new D([K(Re,hs.error)]);return hs.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...m){return new pe({...this._def,args:Gi.create(m).rest(Ri.create())})}returns(m){return new pe({...this._def,returns:m})}implement(m){return this.parse(m)}strictImplement(m){return this.parse(m)}static create(m,b,M){return new pe({args:m||Gi.create([]).rest(Ri.create()),returns:b||Ri.create(),typeName:te.ZodFunction,...Mt(M)})}}class lr extends Ct{get schema(){return this._def.getter()}_parse(m){const{ctx:b}=this._processInputParams(m);return this._def.getter()._parse({data:b.data,path:b.path,parent:b})}}lr.create=(G,m)=>new lr({getter:G,typeName:te.ZodLazy,...Mt(m)});class cr extends Ct{_parse(m){if(m.data!==this._def.value){const b=this._getOrReturnCtx(m);return Y(b,{received:b.data,code:E.invalid_literal,expected:this._def.value}),nt}return{status:"valid",value:m.data}}get value(){return this._def.value}}function Wo(G,m){return new ds({values:G,typeName:te.ZodEnum,...Mt(m)})}cr.create=(G,m)=>new cr({value:G,typeName:te.ZodLiteral,...Mt(m)});class ds extends Ct{constructor(){super(...arguments),F.set(this,void 0)}_parse(m){if(typeof m.data!="string"){const b=this._getOrReturnCtx(m),M=this._def.values;return Y(b,{expected:f.joinValues(M),received:b.parsedType,code:E.invalid_type}),nt}if(tt(this,F)||X(this,F,new Set(this._def.values)),!tt(this,F).has(m.data)){const b=this._getOrReturnCtx(m),M=this._def.values;return Y(b,{received:b.data,code:E.invalid_enum_value,options:M}),nt}return ut(m.data)}get options(){return this._def.values}get enum(){const m={};for(const b of this._def.values)m[b]=b;return m}get Values(){const m={};for(const b of this._def.values)m[b]=b;return m}get Enum(){const m={};for(const b of this._def.values)m[b]=b;return m}extract(m,b=this._def){return ds.create(m,{...this._def,...b})}exclude(m,b=this._def){return ds.create(this.options.filter(M=>!m.includes(M)),{...this._def,...b})}}F=new WeakMap,ds.create=Wo;class dr extends Ct{constructor(){super(...arguments),St.set(this,void 0)}_parse(m){const b=f.getValidEnumValues(this._def.values),M=this._getOrReturnCtx(m);if(M.parsedType!==C.string&&M.parsedType!==C.number){const K=f.objectValues(b);return Y(M,{expected:f.joinValues(K),received:M.parsedType,code:E.invalid_type}),nt}if(tt(this,St)||X(this,St,new Set(f.getValidEnumValues(this._def.values))),!tt(this,St).has(m.data)){const K=f.objectValues(b);return Y(M,{received:M.data,code:E.invalid_enum_value,options:K}),nt}return ut(m.data)}get enum(){return this._def.values}}St=new WeakMap,dr.create=(G,m)=>new dr({values:G,typeName:te.ZodNativeEnum,...Mt(m)});class Hs extends Ct{unwrap(){return this._def.type}_parse(m){const{ctx:b}=this._processInputParams(m);if(b.parsedType!==C.promise&&b.common.async===!1)return Y(b,{code:E.invalid_type,expected:C.promise,received:b.parsedType}),nt;const M=b.parsedType===C.promise?b.data:Promise.resolve(b.data);return ut(M.then(K=>this._def.type.parseAsync(K,{path:b.path,errorMap:b.common.contextualErrorMap})))}}Hs.create=(G,m)=>new Hs({type:G,typeName:te.ZodPromise,...Mt(m)});class Oi extends Ct{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===te.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(m){const{status:b,ctx:M}=this._processInputParams(m),K=this._def.effect||null,Rt={addIssue:dt=>{Y(M,dt),dt.fatal?b.abort():b.dirty()},get path(){return M.path}};if(Rt.addIssue=Rt.addIssue.bind(Rt),K.type==="preprocess"){const dt=K.transform(M.data,Rt);if(M.common.async)return Promise.resolve(dt).then(async Tt=>{if(b.value==="aborted")return nt;const zt=await this._def.schema._parseAsync({data:Tt,path:M.path,parent:M});return zt.status==="aborted"?nt:zt.status==="dirty"||b.value==="dirty"?et(zt.value):zt});{if(b.value==="aborted")return nt;const Tt=this._def.schema._parseSync({data:dt,path:M.path,parent:M});return Tt.status==="aborted"?nt:Tt.status==="dirty"||b.value==="dirty"?et(Tt.value):Tt}}if(K.type==="refinement"){const dt=Tt=>{const zt=K.refinement(Tt,Rt);if(M.common.async)return Promise.resolve(zt);if(zt instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return Tt};if(M.common.async===!1){const Tt=this._def.schema._parseSync({data:M.data,path:M.path,parent:M});return Tt.status==="aborted"?nt:(Tt.status==="dirty"&&b.dirty(),dt(Tt.value),{status:b.value,value:Tt.value})}return this._def.schema._parseAsync({data:M.data,path:M.path,parent:M}).then(Tt=>Tt.status==="aborted"?nt:(Tt.status==="dirty"&&b.dirty(),dt(Tt.value).then(()=>({status:b.value,value:Tt.value}))))}if(K.type==="transform"){if(M.common.async===!1){const dt=this._def.schema._parseSync({data:M.data,path:M.path,parent:M});if(!R(dt))return dt;const Tt=K.transform(dt.value,Rt);if(Tt instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:b.value,value:Tt}}return this._def.schema._parseAsync({data:M.data,path:M.path,parent:M}).then(dt=>R(dt)?Promise.resolve(K.transform(dt.value,Rt)).then(Tt=>({status:b.value,value:Tt})):dt)}f.assertNever(K)}}Oi.create=(G,m,b)=>new Oi({schema:G,typeName:te.ZodEffects,effect:m,...Mt(b)}),Oi.createWithPreprocess=(G,m,b)=>new Oi({schema:m,effect:{type:"preprocess",transform:G},typeName:te.ZodEffects,...Mt(b)});class bi extends Ct{_parse(m){return this._getType(m)===C.undefined?ut(void 0):this._def.innerType._parse(m)}unwrap(){return this._def.innerType}}bi.create=(G,m)=>new bi({innerType:G,typeName:te.ZodOptional,...Mt(m)});class us extends Ct{_parse(m){return this._getType(m)===C.null?ut(null):this._def.innerType._parse(m)}unwrap(){return this._def.innerType}}us.create=(G,m)=>new us({innerType:G,typeName:te.ZodNullable,...Mt(m)});class ur extends Ct{_parse(m){const{ctx:b}=this._processInputParams(m);let M=b.data;return b.parsedType===C.undefined&&(M=this._def.defaultValue()),this._def.innerType._parse({data:M,path:b.path,parent:b})}removeDefault(){return this._def.innerType}}ur.create=(G,m)=>new ur({innerType:G,typeName:te.ZodDefault,defaultValue:typeof m.default=="function"?m.default:()=>m.default,...Mt(m)});class gr extends Ct{_parse(m){const{ctx:b}=this._processInputParams(m),M={...b,common:{...b.common,issues:[]}},K=this._def.innerType._parse({data:M.data,path:M.path,parent:{...M}});return q(K)?K.then(Rt=>({status:"valid",value:Rt.status==="valid"?Rt.value:this._def.catchValue({get error(){return new D(M.common.issues)},input:M.data})})):{status:"valid",value:K.status==="valid"?K.value:this._def.catchValue({get error(){return new D(M.common.issues)},input:M.data})}}removeCatch(){return this._def.innerType}}gr.create=(G,m)=>new gr({innerType:G,typeName:te.ZodCatch,catchValue:typeof m.catch=="function"?m.catch:()=>m.catch,...Mt(m)});class Fr extends Ct{_parse(m){if(this._getType(m)!==C.nan){const b=this._getOrReturnCtx(m);return Y(b,{code:E.invalid_type,expected:C.nan,received:b.parsedType}),nt}return{status:"valid",value:m.data}}}Fr.create=G=>new Fr({typeName:te.ZodNaN,...Mt(G)});const qo=Symbol("zod_brand");class pn extends Ct{_parse(m){const{ctx:b}=this._processInputParams(m),M=b.data;return this._def.type._parse({data:M,path:b.path,parent:b})}unwrap(){return this._def.type}}class fr extends Ct{_parse(m){const{status:b,ctx:M}=this._processInputParams(m);if(M.common.async)return(async()=>{const K=await this._def.in._parseAsync({data:M.data,path:M.path,parent:M});return K.status==="aborted"?nt:K.status==="dirty"?(b.dirty(),et(K.value)):this._def.out._parseAsync({data:K.value,path:M.path,parent:M})})();{const K=this._def.in._parseSync({data:M.data,path:M.path,parent:M});return K.status==="aborted"?nt:K.status==="dirty"?(b.dirty(),{status:"dirty",value:K.value}):this._def.out._parseSync({data:K.value,path:M.path,parent:M})}}static create(m,b){return new fr({in:m,out:b,typeName:te.ZodPipeline})}}class _r extends Ct{_parse(m){const b=this._def.innerType._parse(m),M=K=>(R(K)&&(K.value=Object.freeze(K.value)),K);return q(b)?b.then(K=>M(K)):M(b)}unwrap(){return this._def.innerType}}function Zn(G,m={},b){return G?si.create().superRefine((M,K)=>{var Rt,dt;if(!G(M)){const Tt=typeof m=="function"?m(M):typeof m=="string"?{message:m}:m,zt=(dt=(Rt=Tt.fatal)!==null&&Rt!==void 0?Rt:b)===null||dt===void 0||dt,Vt=typeof Tt=="string"?{message:Tt}:Tt;K.addIssue({code:"custom",...Vt,fatal:zt})}}):si.create()}_r.create=(G,m)=>new _r({innerType:G,typeName:te.ZodReadonly,...Mt(m)});const Mr={object:Pe.lazycreate};var te;(function(G){G.ZodString="ZodString",G.ZodNumber="ZodNumber",G.ZodNaN="ZodNaN",G.ZodBigInt="ZodBigInt",G.ZodBoolean="ZodBoolean",G.ZodDate="ZodDate",G.ZodSymbol="ZodSymbol",G.ZodUndefined="ZodUndefined",G.ZodNull="ZodNull",G.ZodAny="ZodAny",G.ZodUnknown="ZodUnknown",G.ZodNever="ZodNever",G.ZodVoid="ZodVoid",G.ZodArray="ZodArray",G.ZodObject="ZodObject",G.ZodUnion="ZodUnion",G.ZodDiscriminatedUnion="ZodDiscriminatedUnion",G.ZodIntersection="ZodIntersection",G.ZodTuple="ZodTuple",G.ZodRecord="ZodRecord",G.ZodMap="ZodMap",G.ZodSet="ZodSet",G.ZodFunction="ZodFunction",G.ZodLazy="ZodLazy",G.ZodLiteral="ZodLiteral",G.ZodEnum="ZodEnum",G.ZodEffects="ZodEffects",G.ZodNativeEnum="ZodNativeEnum",G.ZodOptional="ZodOptional",G.ZodNullable="ZodNullable",G.ZodDefault="ZodDefault",G.ZodCatch="ZodCatch",G.ZodPromise="ZodPromise",G.ZodBranded="ZodBranded",G.ZodPipeline="ZodPipeline",G.ZodReadonly="ZodReadonly"})(te||(te={}));const Vo=(G,m={message:`Input not instance of ${G.name}`})=>Zn(b=>b instanceof G,m),An=Gt.create,mn=Jt.create,jo=Fr.create,Yo=he.create,We=se.create,vn=Xt.create,gs=Se.create,as=Me.create,$n=oi.create,Xo=si.create,Hi=Ri.create,hi=ai.create,Ot=Rr.create,pr=xi.create,Xi=Pe.create,Zo=Pe.strictCreate,Zi=Es.create,Ws=hr.create,qs=Os.create,kr=Gi.create,Qr=Ze.create,Lr=Fi.create,zr=pi.create,Ur=pe.create,wn=lr.create,$o=cr.create,Jo=ds.create,yn=dr.create,Ko=Hs.create,fs=Oi.create,Ae=bi.create,Is=us.create,Ar=Oi.createWithPreprocess,xn=fr.create,De=()=>An().optional(),Nr=()=>mn().optional(),ne=()=>We().optional(),Gr={string:G=>Gt.create({...G,coerce:!0}),number:G=>Jt.create({...G,coerce:!0}),boolean:G=>se.create({...G,coerce:!0}),bigint:G=>he.create({...G,coerce:!0}),date:G=>Xt.create({...G,coerce:!0})},bn=nt;var Cn=Object.freeze({__proto__:null,defaultErrorMap:H,setErrorMap:N,getErrorMap:Q,makeIssue:L,EMPTY_PATH:O,addIssueToContext:Y,ParseStatus:ot,INVALID:nt,DIRTY:et,OK:ut,isAborted:Z,isDirty:I,isValid:R,isAsync:q,get util(){return f},get objectUtil(){return T},ZodParsedType:C,getParsedType:S,ZodType:Ct,datetimeRegex:Bt,ZodString:Gt,ZodNumber:Jt,ZodBigInt:he,ZodBoolean:se,ZodDate:Xt,ZodSymbol:Se,ZodUndefined:Me,ZodNull:oi,ZodAny:si,ZodUnknown:Ri,ZodNever:ai,ZodVoid:Rr,ZodArray:xi,ZodObject:Pe,ZodUnion:Es,ZodDiscriminatedUnion:hr,ZodIntersection:Os,ZodTuple:Gi,ZodRecord:Ze,ZodMap:Fi,ZodSet:pi,ZodFunction:pe,ZodLazy:lr,ZodLiteral:cr,ZodEnum:ds,ZodNativeEnum:dr,ZodPromise:Hs,ZodEffects:Oi,ZodTransformer:Oi,ZodOptional:bi,ZodNullable:us,ZodDefault:ur,ZodCatch:gr,ZodNaN:Fr,BRAND:qo,ZodBranded:pn,ZodPipeline:fr,ZodReadonly:_r,custom:Zn,Schema:Ct,ZodSchema:Ct,late:Mr,get ZodFirstPartyTypeKind(){return te},coerce:Gr,any:Xo,array:pr,bigint:Yo,boolean:We,date:vn,discriminatedUnion:Ws,effect:fs,enum:Jo,function:Ur,instanceof:Vo,intersection:qs,lazy:wn,literal:$o,map:Lr,nan:jo,nativeEnum:yn,never:hi,null:$n,nullable:Is,number:mn,object:Xi,oboolean:ne,onumber:Nr,optional:Ae,ostring:De,pipeline:xn,preprocess:Ar,promise:Ko,record:Qr,set:zr,strictObject:Zo,string:An,symbol:gs,transformer:fs,tuple:kr,undefined:as,union:Zi,unknown:Hi,void:Ot,NEVER:bn,ZodIssueCode:E,quotelessJson:W,ZodError:D})},"./node_modules/zstddec/dist/zstddec.modern.js":(A,y,w)=>{let f,T,C;w.r(y),w.d(y,{ZSTDDecoder:()=>E});const S={env:{emscripten_notify_memory_growth:function(D){C=new Uint8Array(T.exports.memory.buffer)}}};class E{init(){return f||(f=typeof fetch<"u"?fetch("data:application/wasm;base64,"+W).then(H=>H.arrayBuffer()).then(H=>WebAssembly.instantiate(H,S)).then(this._init):WebAssembly.instantiate(Buffer.from(W,"base64"),S).then(this._init),f)}_init(H){T=H.instance,S.env.emscripten_notify_memory_growth(0)}decode(H,k=0){if(!T)throw new Error("ZSTDDecoder: Await .init() before decoding.");const N=H.byteLength,Q=T.exports.malloc(N);C.set(H,Q),k=k||Number(T.exports.ZSTD_findDecompressedSize(Q,N));const L=T.exports.malloc(k),O=T.exports.ZSTD_decompress(L,k,Q,N),Y=C.slice(L,L+O);return T.exports.free(Q),T.exports.free(L),Y}}const W="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ"}},h={};function u(A){var y=h[A];if(y!==void 0)return y.exports;var w=h[A]={exports:{}};return o[A](w,w.exports,u),w.exports}u.n=A=>{var y=A&&A.__esModule?()=>A.default:()=>A;return u.d(y,{a:y}),y},u.d=(A,y)=>{for(var w in y)u.o(y,w)&&!u.o(A,w)&&Object.defineProperty(A,w,{enumerable:!0,get:y[w]})},u.o=(A,y)=>Object.prototype.hasOwnProperty.call(A,y),u.r=A=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(A,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(A,"__esModule",{value:!0})};var _={};return(()=>{u.r(_),u.d(_,{Decoder:()=>y.Decoder,Ellipse:()=>E.Ellipse,ExcaliburTiledProperties:()=>w.ExcaliburTiledProperties,FLIPPED_DIAGONALLY_FLAG:()=>C.FLIPPED_DIAGONALLY_FLAG,FLIPPED_HORIZONTALLY_FLAG:()=>C.FLIPPED_HORIZONTALLY_FLAG,FLIPPED_VERTICALLY_FLAG:()=>C.FLIPPED_VERTICALLY_FLAG,FetchLoader:()=>f.FetchLoader,InsertedTile:()=>E.InsertedTile,LoaderCache:()=>S.LoaderCache,PluginObject:()=>E.PluginObject,Point:()=>E.Point,Polygon:()=>E.Polygon,Polyline:()=>E.Polyline,Rectangle:()=>E.Rectangle,Template:()=>k.Template,TemplateObject:()=>E.TemplateObject,TemplateResource:()=>H.TemplateResource,Text:()=>E.Text,Tile:()=>Y.Tile,TiledDataComponent:()=>N.TiledDataComponent,TiledLayerDataComponent:()=>Q.TiledLayerDataComponent,TiledMap:()=>A.TiledMap,TiledParser:()=>A.TiledParser,TiledResource:()=>L.TiledResource,TiledTemplate:()=>A.TiledTemplate,TiledText:()=>A.TiledText,TiledTile:()=>A.TiledTile,TiledTileLayer:()=>A.TiledTileLayer,TiledTileLayerInfinite:()=>A.TiledTileLayerInfinite,TiledTileset:()=>A.TiledTileset,TiledTilesetFile:()=>A.TiledTilesetFile,Tileset:()=>Y.Tileset,TilesetResource:()=>O.TilesetResource,byClassCaseInsensitive:()=>T.byClassCaseInsensitive,byNameCaseInsensitive:()=>T.byNameCaseInsensitive,byPropertyCaseInsensitive:()=>T.byPropertyCaseInsensitive,filenameFromPath:()=>W.filenameFromPath,getCanonicalGid:()=>C.getCanonicalGid,isCSV:()=>A.isCSV,isFlippedDiagonally:()=>C.isFlippedDiagonally,isFlippedHorizontally:()=>C.isFlippedHorizontally,isFlippedVertically:()=>C.isFlippedVertically,isInfiniteLayer:()=>A.isInfiniteLayer,isTiledTilesetCollectionOfImages:()=>A.isTiledTilesetCollectionOfImages,isTiledTilesetEmbedded:()=>A.isTiledTilesetEmbedded,isTiledTilesetExternal:()=>A.isTiledTilesetExternal,isTiledTilesetSingleImage:()=>A.isTiledTilesetSingleImage,mapPath:()=>W.mapPath,mapProps:()=>D.mapProps,needsDecoding:()=>A.needsDecoding,parseObject:()=>E.parseObject,parseObjects:()=>E.parseObjects,pathInMap:()=>W.pathInMap,pathRelativeToBase:()=>W.pathRelativeToBase});var A=u("./src/parser/tiled-parser.ts"),y=u("./src/resource/decoder.ts"),w=u("./src/resource/excalibur-properties.ts"),f=u("./src/resource/file-loader.ts"),T=u("./src/resource/filter-util.ts"),C=u("./src/resource/gid-util.ts"),S=(u("./src/resource/layer.ts"),u("./src/resource/loader-cache.ts")),E=u("./src/resource/objects.ts"),W=u("./src/resource/path-util.ts"),D=u("./src/resource/properties.ts"),H=u("./src/resource/template-resource.ts"),k=u("./src/resource/template.ts"),N=u("./src/resource/tiled-data-component.ts"),Q=u("./src/resource/tiled-layer-component.ts"),L=u("./src/resource/tiled-resource.ts"),O=u("./src/resource/tileset-resource.ts"),Y=u("./src/resource/tileset.ts")})(),_})())}(cl)),cl.exports}var VA=qA();const jA="/sample-tiled-vite/assets/Hero%2001-igU2R4wm.png",YA="/sample-tiled-vite/assets/Solaria%20Demo%20Update%2001-Cah-Vp7r.png",Eu="/sample-tiled-vite/assets/first-level-B4AG_S97.tmx",Iu="/sample-tiled-vite/assets/tileset-CmLC2aCJ.tsx",ue={PlayerSpeed:16*2,PlayerFrameSpeed:200};class XA extends DA{constructor(t){super({pos:t,width:16,height:16,collisionType:RA.Active})}onInitialize(t){const i=zA.fromImageSource({image:Fc.HeroSpriteSheetPng,grid:{spriteWidth:16,spriteHeight:16,rows:8,columns:8}}),r=new br({frames:[{graphic:i.getSprite(0,1),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(1,1),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(2,1),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(3,1),duration:ue.PlayerFrameSpeed}]});this.graphics.add("left-idle",r);const o=new br({frames:[{graphic:i.getSprite(0,2),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(1,2),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(2,2),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(3,2),duration:ue.PlayerFrameSpeed}]});this.graphics.add("right-idle",o);const h=new br({frames:[{graphic:i.getSprite(0,3),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(1,3),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(2,3),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(3,3),duration:ue.PlayerFrameSpeed}]});this.graphics.add("up-idle",h);const u=new br({frames:[{graphic:i.getSprite(0,0),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(1,0),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(2,0),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(3,0),duration:ue.PlayerFrameSpeed}]});this.graphics.add("down-idle",u);const _=new br({frames:[{graphic:i.getSprite(0,5),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(1,5),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(2,5),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(3,5),duration:ue.PlayerFrameSpeed}]});this.graphics.add("left-walk",_);const A=new br({frames:[{graphic:i.getSprite(0,6),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(1,6),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(2,6),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(3,6),duration:ue.PlayerFrameSpeed}]});this.graphics.add("right-walk",A);const y=new br({frames:[{graphic:i.getSprite(0,7),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(1,7),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(2,7),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(3,7),duration:ue.PlayerFrameSpeed}]});this.graphics.add("up-walk",y);const w=new br({frames:[{graphic:i.getSprite(0,4),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(1,4),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(2,4),duration:ue.PlayerFrameSpeed},{graphic:i.getSprite(3,4),duration:ue.PlayerFrameSpeed}]});this.graphics.add("down-walk",w)}onPreUpdate(t,i){this.vel=UA.Zero,this.graphics.use("down-idle"),t.input.keyboard.isHeld((void 0).Keys.ArrowRight)&&(this.vel=Ba(ue.PlayerSpeed,0),this.graphics.use("right-walk")),t.input.keyboard.isHeld((void 0).Keys.ArrowLeft)&&(this.vel=Ba(-ue.PlayerSpeed,0),this.graphics.use("left-walk")),t.input.keyboard.isHeld((void 0).Keys.ArrowUp)&&(this.vel=Ba(0,-ue.PlayerSpeed),this.graphics.use("up-walk")),t.input.keyboard.isHeld((void 0).Keys.ArrowDown)&&(this.vel=Ba(0,ue.PlayerSpeed),this.graphics.use("down-walk"))}}const Fc={HeroSpriteSheetPng:new kA(jA,!1,MA.Pixel),TiledMap:new VA.TiledResource(Eu,{entityClassNameFactories:{player:c=>{const t=new XA(c.worldPos);return t.z=100,t}},pathMap:[{path:"first-level.tmx",output:Eu},{path:"Solaria Demo Update 01.png",output:YA},{path:"tileset.tsx",output:Iu}]}),TsxResource:new LA(Iu,"text")},pf=new QA;for(let c of Object.values(Fc))pf.addResource(c);const Bu=new FA({width:800,height:600,canvasElementId:"game",pixelArt:!0,pixelRatio:2});Bu.start(pf).then(()=>{Fc.TiledMap.addToScene(Bu.currentScene)});
//# sourceMappingURL=index-C4NtOWMe.js.map
